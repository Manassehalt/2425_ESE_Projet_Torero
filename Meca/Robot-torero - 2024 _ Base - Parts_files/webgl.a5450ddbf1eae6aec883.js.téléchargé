"use strict";(self.webpackChunkNewton=self.webpackChunkNewton||[]).push([[327],{78975:function(e,t,i){i.d(t,{$R:function(){return me},$d:function(){return ue},CO:function(){return b},IG:function(){return Ie},JO:function(){return Me},Jq:function(){return _},Mm:function(){return Se},Ro:function(){return re},SM:function(){return he},U8:function(){return Te},Xk:function(){return ce},_p:function(){return $},io:function(){return N},j$:function(){return Ce},mI:function(){return oe},nl:function(){return pe},t_:function(){return Q},uU:function(){return fe},wN:function(){return ae},z$:function(){return Ee}});var s=i(41622),n=i(93249),r=i(15843),a=i(57692),o=i(82695),h=i(41810),c=i(28817),l=i(15563),u=i(10867),d=i(37754),g=i(40119),p=i(78591),m=i(80675),f=i(63903),I=i(96265),E=i(92230),S=i(33804),T=i(94128),M=i(54861),C=i(40620),D=i(79275);const v="value",P="expression",y="icon",A="line";let O=!1,R=!1,w=!1;function _(e){O=e}function N(e){R=e}function b(e){w=e}const L={isVisible:!0,isTwoSided:!0,priority:p.RenderOrderPriority.HIGHER,primitiveType:p.PrimitiveType.TRIANGLES},F=[Object.assign({isShowThrough:!0,isDepthTested:!1,isPickable:!0},L),Object.assign({isShowThrough:!0,isDepthTested:!1,isPickable:!1},L)],x="value",B="expression",U="icon",V="arc_length",G={isVisible:!0,isTwoSided:!0,priority:p.RenderOrderPriority.LOWER,primitiveType:p.PrimitiveType.LINES},H=[new p.NodeProperties(Object.assign({isShowThrough:!0,isDepthTested:!1,isPickable:!0},G)),new p.NodeProperties(Object.assign({isShowThrough:!0,isDepthTested:!1,isPickable:!1},G))],k="arrows",W={isVisible:!0,isPickable:!1,isTwoSided:!0,priority:p.RenderOrderPriority.LOWER,material:p.UNLIT_COLOR_FROM_ATTRIBUTE,primitiveType:p.PrimitiveType.TRIANGLES},z=[new p.NodeProperties(Object.assign({isShowThrough:!0,isDepthTested:!1},W)),new p.NodeProperties(Object.assign({isShowThrough:!0,isDepthTested:!1},W))],X="witness0",q="witness1",Z="dimensionLine0",Y=1.25*d.W.MAX_MODEL_SIZE,K="#",j=/^\s*-?[0-9]*[.,]?[0-9]*([eE]-?[0-9]+)?[fFdD]?\s*\*?\s*[a-z]*\s*$/;var Q;function $(e){return e.includes(K)?Q.WITH_VARIABLES:j.test(e)?Q.VALUE_ONLY:Q.WITHOUT_VARIABLES}!function(e){e[e.VALUE_ONLY=0]="VALUE_ONLY",e[e.WITH_VARIABLES=1]="WITH_VARIABLES",e[e.WITHOUT_VARIABLES=2]="WITHOUT_VARIABLES"}(Q||(Q={}));const J=n.default.getManager();function ee(e,t){return e===Q.VALUE_ONLY?"":"expression-"+(e===Q.WITH_VARIABLES?"external":"internal")+(t?":bad":":normal")}function te(e){const t=(e,t)=>{const i=new p.ImageData;return i.id=ee(e,t),i.svgToStyle=function(e,t){if(e===Q.VALUE_ONLY)return"";let i=e===Q.WITH_VARIABLES?"dimension-expression":"function";return t&&(i+="-error"),i+=".svg",i}(e,t),i},i=[t(Q.WITH_VARIABLES,!1),t(Q.WITHOUT_VARIABLES,!1),t(Q.WITH_VARIABLES,!0),t(Q.WITHOUT_VARIABLES,!0)];return(0,p.createAtlasFromResources)(e,J.getNumber("DIMENSION_ICON_SIZE_PIXELS"),i,{sourcesHaveTransparency:!0})}const ie=[];let se=0;function ne(e,t){if(null==e.getResources().dimensionAtlas&&ie.push(t),e.getResources().dimensionAtlasCreationInitiated)return;e.getResources().dimensionAtlasCreationInitiated=!0;const i=se++;e.getResources().dimensionAtlasCreationId=i;e.getTextureAtlasFactory().getAtlas(p.DIMENSION_ATLAS,te.bind(void 0,e)).then((t=>{i===e.getResources().dimensionAtlasCreationId&&(t?(e.getResources().dimensionAtlas=t,e.getResources().dimensionMaterial.ambientTexture=t.texture,ie.forEach((e=>e())),ie.length=0):D.log.warn("Could not load texture atlas"))}),(e=>D.log.error(e)))}class re extends p.UIElement{constructor(e,t,i){super(e),this.displayData=null,this.updateOnNextDraw=!0,this.lastPixelSizeWorld=0,this.lastFlips=[],this.isBad=!1,this.isDriven=!1,this.value=0,this.expression="",this.expressionType=Q.VALUE_ONLY,this.hovered=!1,this.isConfigured=!1,this.lastValueProperties=null,this.lastExpressionProperties=null,this.valueTexture=null,this.expressionTexture=null,this.textDragging=!1,this.textDragOffset=m.create(),this.preferences=null,this.selected=!1,this.pushedMoveCursor=!1,this.forPreview=null!=t&&t,this.listenTo(this,p.UiEvents.MOUSE_ENTER+A,this.onMouseEnterLines),this.listenTo(this,p.UiEvents.MOUSE_LEAVE+A,this.onMouseLeaveLines),this.listenTo(this,p.UiEvents.CLICK+A,this.onClick),this.listenTo(this,p.UiEvents.SELECT+A,this.onSelect),this.listenTo(this,p.UiEvents.DESELECT+A,this.onDeselect),this.listenTo(this,p.UiEvents.MOUSE_ENTER+v,this.onMouseEnterText),this.listenTo(this,p.UiEvents.MOUSE_ENTER+P,this.onMouseEnterText),this.listenTo(this,p.UiEvents.MOUSE_ENTER+y,this.onMouseEnterText),this.listenTo(this,p.UiEvents.MOUSE_LEAVE+v,this.onMouseLeaveText),this.listenTo(this,p.UiEvents.MOUSE_LEAVE+P,this.onMouseLeaveText),this.listenTo(this,p.UiEvents.MOUSE_LEAVE+y,this.onMouseLeaveText),this.listenTo(this,p.UiEvents.CLICK+v,this.onClick),this.listenTo(this,p.UiEvents.CLICK+P,this.onClick),this.listenTo(this,p.UiEvents.CLICK+y,this.onClick),this.listenTo(this,p.UiEvents.SELECT+v,this.onSelect),this.listenTo(this,p.UiEvents.SELECT+P,this.onSelect),this.listenTo(this,p.UiEvents.SELECT+y,this.onSelect),this.listenTo(this,p.UiEvents.DESELECT+v,this.onDeselect),this.listenTo(this,p.UiEvents.DESELECT+P,this.onDeselect),this.listenTo(this,p.UiEvents.DESELECT+y,this.onDeselect),this.listenTo(this,p.UiEvents.DOUBLE_CLICK+A,this.onDoubleClick),this.listenTo(this,p.UiEvents.DOUBLE_CLICK+v,this.onDoubleClick),this.listenTo(this,p.UiEvents.DOUBLE_CLICK+P,this.onDoubleClick),this.listenTo(this,p.UiEvents.DOUBLE_CLICK+y,this.onDoubleClick),this.listenTo(this,p.UiEvents.DRAG_START+v,this.onDragStartText),this.listenTo(this,p.UiEvents.DRAG_START+P,this.onDragStartText),this.listenTo(this,p.UiEvents.DRAG_START+y,this.onDragStartText),this.listenTo(this,p.UiEvents.DRAG+v,this.onDragText),this.listenTo(this,p.UiEvents.DRAG+P,this.onDragText),this.listenTo(this,p.UiEvents.DRAG+y,this.onDragText),this.listenTo(this,p.UiEvents.DRAG_STOP+v,this.onDragStopText),this.listenTo(this,p.UiEvents.DRAG_STOP+P,this.onDragStopText),this.listenTo(this,p.UiEvents.DRAG_STOP+y,this.onDragStopText),this.listenTo(this.viewer.getEventDispatcher(),p.DIMENSION_EDIT_CLOSED,this.onDimensionEditClosed),this.listenTo(this.viewer.getEventDispatcher(),p.SHOW_DIMENSION_EXPRESSIONS_CHANGED,this.onShowExpressionsChanged),this.elementId=null!=i?i:"",this.valueMaterial=(0,p.createTextureMaterial)(),this.expressionMaterial=(0,p.createTextureMaterial)(),this.dimensionMatrix=f.create(),this.planeMatrix=f.create(),this.computedInverse=f.create(),this.appliedTransform=f.create();const n=(0,s.Z)(F[0]),r=(0,s.Z)(F[1]);t&&(n.priority=p.RenderOrderPriority.HIGHEST,r.priority=p.RenderOrderPriority.HIGHEST),this.valueNodeProperties=[new p.NodeProperties(Object.assign({material:this.valueMaterial},n)),new p.NodeProperties(Object.assign({material:this.valueMaterial},r))],this.expressionNodeProperties=[new p.NodeProperties(Object.assign({material:this.expressionMaterial},n)),new p.NodeProperties(Object.assign({material:this.expressionMaterial},r))],ne(this.viewer,this.onTextureAtlasChanged.bind(this))}isDimension(){return!0}hide(){super.hide(),this.hovered=!1,this.selected=!1,this.textDragging=!1}setAppliedTransform(e){this.appliedTransform=e,M.w$.inverse(this.getPlaneMatrix(),this.computedInverse)}getPlaneMatrix(){return M.w$.multiply(this.appliedTransform,this.planeMatrix,f.create())}getPlaneMatrixInverse(){return this.computedInverse}onDevicePixelRatioChanged(e){this.lastValueProperties&&(this.valueTexture=null,this.updateRawValueTexture(this.lastValueProperties.textRendered)),this.lastExpressionProperties&&(this.expressionTexture=null,this.updateRawExpressionTexture(this.lastExpressionProperties.textRendered)),ne(this.viewer,this.onTextureAtlasChanged.bind(this))}remove(){this.hovered&&!w&&this.viewer.popCursor(),this.pushedMoveCursor&&this.removeMoveCursor(),this.destroyValueTexture(),this.valueMaterial&&(this.valueMaterial.destroy(),this.valueMaterial=null),this.destroyExpressionTexture(),this.expressionMaterial&&(this.expressionMaterial.destroy(),this.expressionMaterial=null),super.remove()}hasValueChanged(e){return null==this.valueTexture||null==this.lastValueProperties||this.lastValueProperties.textRendered!==e||this.lastValueProperties.isBad!==this.isBad||this.lastValueProperties.hoveredOrTextDragging!==(this.hovered||this.textDragging)||this.lastValueProperties.isDriven!==this.isDriven||this.lastValueProperties.isConfigured!==this.isConfigured}hasExpressionChanged(e){return null==this.expressionTexture||null==this.lastExpressionProperties||this.lastExpressionProperties.textRendered!==e||this.lastExpressionProperties.isBad!==this.isBad||this.lastExpressionProperties.hoveredOrTextDragging!==(this.hovered||this.textDragging)||this.lastExpressionProperties.selected!==this.selected}getPickPriority(e){return R?p.PickPriority.REDUCED_DIMENSION_PRIORITY:p.PickPriority.DIMENSION}updateDimensionMatrices(){this.displayData&&(this.updateOnNextDraw=!0,this.dimensionMatrix=this.displayData.coordinateSystem.getGlMatrix(),this.planeMatrix=this.displayData.planeMatrix.getGlMatrix(),M.w$.inverse(this.getPlaneMatrix(),this.computedInverse),this.value=this.displayData.value)}getFeatureId(){return this.displayData?this.displayData.featureId:""}getElementId(){return this.elementId}getDimensionId(){return this.displayData?this.displayData.id:""}getParameterId(){return this.displayData?this.displayData.parameterId:""}canPickThrough(){return!this.isInteractionEnabled()||R}isInteractionEnabled(){return!this.forPreview&&O}isForPreview(){return this.forPreview}isSelected(){return this.selected}destroyAllTextures(){this.destroyValueTexture(),this.destroyExpressionTexture()}destroyValueTexture(){this.valueTexture&&(this.valueTexture.destroy(),this.valueTexture=null,this.updateOnNextDraw=!0)}destroyExpressionTexture(){this.expressionTexture&&(this.expressionTexture.destroy(),this.expressionTexture=null,this.updateOnNextDraw=!0)}onDefaultUnitsChanged(){this.destroyAllTextures(),this.viewer.requestDraw()}onTextureAtlasChanged(){this.expressionType!==Q.VALUE_ONLY&&(this.updateOnNextDraw=!0,this.viewer.requestDraw())}onViewWillDraw(e,t){if(this.isHidden||!this.displayData)return;const i=this.getPosition(),s=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(i[0],i[1]))),n=(0,p.orientText)(e,this.getVisualRightVector(),this.getVisualUpVector(),this.transform),r=this.preferences&&this.preferences.displayLimitRangeTicks;(this.updateOnNextDraw||Math.abs(this.lastPixelSizeWorld-s)>d.W.ZERO_LENGTH||!(0,c.arraysEqual)(this.lastFlips,n)||r)&&(this.update(e,t),this.updateOnNextDraw=!1,this.lastPixelSizeWorld=s,this.lastFlips=n)}textIsReadOnly(){var e,t;return null!==(t=null===(e=this.preferences)||void 0===e?void 0:e.textReadOnly)&&void 0!==t&&t}onMouseEnterText(e,t){this.textIsReadOnly()||(this.hovered=!0,this.destroyAllTextures(),this.pushMoveCursor(),(0,p.requestDraw)())}onMouseLeaveText(e,t){this.textIsReadOnly()||(this.hovered=!1,this.destroyAllTextures(),this.removeMoveCursor(),(0,p.requestDraw)())}pushMoveCursor(){w||this.pushedMoveCursor||(this.viewer.pushCursor(p.Cursor.MOVE),this.pushedMoveCursor=!0)}removeMoveCursor(){this.pushedMoveCursor&&(this.viewer.removeTopOccurrenceOfCursor(p.Cursor.MOVE),this.pushedMoveCursor=!1)}onDoubleClick(e,t){var i;if(a.Jq.FeatureConfigurationService.getIsInConfigureFeatureMode())return;if(this.isConfigured)return void a.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Configured dimensions can be edited in the configuration table"));if(this.textIsReadOnly())return;const s=this.getLabelCanvasCoordinates();null===(i=this.viewer.getEventDispatcher())||void 0===i||i.trigger(p.DIMENSION_TEXT_DOUBLE_CLICKED,{featureId:this.getFeatureId(),dimensionId:this.getDimensionId(),parameterId:this.getParameterId(),positionX:s[0],positionY:s[1],dimension:this}),(0,p.requestDraw)()}onDragStartText(e,t,i){if(w)return;const s=this.mouseToDimensionCoordinates(t.mouseX,t.mouseY,t.camera);s?m.subtract(this.textDragOffset,s,this.getPosition()):m.zero(this.textDragOffset),this.textDragging=!0,this.destroyAllTextures(),i.requestDrag=!0}onDragText(e,t){if(w)return;const i=this.mouseToDimensionCoordinates(t.mouseX,t.mouseY,t.camera);i&&(m.subtract(i,i,this.textDragOffset),this.setPosition(i),this.updateOnNextDraw=!0,(0,p.requestDraw)())}onMouseEnterLines(e,t){this.textIsReadOnly()||(this.hovered=!0,this.destroyAllTextures(),w||this.viewer.pushCursor(p.Cursor.DEFAULT),(0,p.requestDraw)())}onMouseLeaveLines(e,t){this.textIsReadOnly()||(this.hovered=!1,this.destroyAllTextures(),w||this.viewer.removeTopOccurrenceOfCursor(p.Cursor.DEFAULT),(0,p.requestDraw)())}onClick(e,t,i){var s;w||(i.requestSelectedStatus=!0);const n=this.getLabelCanvasCoordinates();null===(s=this.viewer.getEventDispatcher())||void 0===s||s.trigger(p.DIMENSION_TEXT_SINGLE_CLICKED,{featureId:this.getFeatureId(),dimensionId:this.getDimensionId(),parameterId:this.getParameterId(),positionX:n[0],positionY:n[1],dimension:this})}onSelect(e,t){a.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled()&&(0,p.getActiveViewerEventDispatcher)().trigger(p.PICK_CONSTRAINT_SELECTED,e.sourcePick),this.selected=!0,this.destroyAllTextures(),(0,p.requestDraw)()}onDeselect(e,t){this.selected=!1,this.destroyAllTextures(),(0,p.requestDraw)()}onDragStopText(e,t){const i=r.Op.getConnection(r.tl);if(!i)return;if(w)return;if(""===this.getElementId())return;const s=this.getLabelPositionInPlane(),n=new h.aO_;n.entityId=this.getDimensionId(),n.elementId=this.getElementId(),n.labelX=s[0],n.labelY=s[1],n.parameterName=this.getParameterId(),n.editDescription=n.constructEditMessage("Drag","dimension"),i.send(n),this.textDragging=!1,m.zero(this.textDragOffset),this.destroyAllTextures()}onDimensionEditClosed(e){!this.textIsReadOnly()&&this.hovered&&!w&&this.pushedMoveCursor&&(this.viewer.removeTopOccurrenceOfCursor(p.Cursor.MOVE),this.viewer.pushCursor(p.Cursor.MOVE),(0,p.requestDraw)())}addPointToBounds(e,t){for(let t=0;t<3;++t)if(e[t]>Y||e[t]<-Y)return;t.addPoint(e)}isDrivenDimension(){return this.isDriven}setIsDriven(e){this.isDriven=e,this.viewer.requestDraw()}canBeDrivenDimension(){return!0}isConfiguredDimension(){return this.isConfigured}setIsConfigured(e){this.isConfigured!==e&&(this.isConfigured=e,this.updateOnNextDraw=!0,this.viewer.requestDraw())}setExpression(e){this.expression!==e&&(this.expression=e,this.expressionType=$(e),this.updateOnNextDraw=!0,this.viewer.requestDraw())}onShowExpressionsChanged(e){this.updateOnNextDraw=!0,this.viewer.requestDraw()}isOverDefined(){return this.isBad}getLabelPositionInPlane(){return[0,0]}getPlaneOrigin(){return M.w$.multiplyVec3(this.getPlaneMatrix(),[0,0,0],I.create())}getVisualUpVector(){const e=this.getPlaneOrigin();return M.S4.normalize(M.S4.subtract(M.w$.multiplyVec3(this.getPlaneMatrix(),[0,1,0],I.create()),e,I.create()))}getVisualRightVector(){const e=this.getPlaneOrigin();return M.S4.normalize(M.S4.subtract(M.w$.multiplyVec3(this.getPlaneMatrix(),[1,0,0],I.create()),e,I.create()))}getModelPoint(e,t){const i=M.xB.multiplyVec2(this.dimensionMatrix,[e,t],E.create());return M.w$.multiplyVec3(this.getPlaneMatrix(),[i[0],i[1],0],I.create())}getUiSelectionForText(){return new p.UISelection(this,v,"")}planeToDimensionCoordinates(e,t){const i=S.fromValues(this.dimensionMatrix[0],this.dimensionMatrix[3],this.dimensionMatrix[1],this.dimensionMatrix[4]),s=m.fromValues(this.dimensionMatrix[6],this.dimensionMatrix[7]);return m.subtract(s,m.fromValues(e,t),s),m.transformMat2(s,s,i)}mouseToDimensionCoordinates(e,t,i){const s=i.getRay(e,t),n=(0,p.intersectRayPlaneMatrix)(s,this.getPlaneMatrix()),r=M.w$.multiplyVec3(this.getPlaneMatrixInverse(),n,I.create());return r?this.planeToDimensionCoordinates(r[0],r[1]):null}getLabelCanvasCoordinates(){const e=this.getLabelPositionInPlane(),t=M.w$.multiplyVec3(this.getPlaneMatrix(),[e[0],e[1],0]),i=this.viewer.getPrimaryViewController().camera.projectWorldPointToCanvas(t),s=(0,u.x_)();return i[0]/=s,i[1]/=s,i}onAppearanceConstantsUpdated(){this.destroyAllTextures(),ne(this.viewer,this.onTextureAtlasChanged.bind(this)),this.updateOnNextDraw=!0}updateExpressionDimensionComponent(e,t,i,s,n){var r;if(this.expressionType===Q.VALUE_ONLY||!this.hovered&&!(null===(r=this.viewer.getSketch())||void 0===r?void 0:r.showDimensionExpressions))return void this.removeDimensionComponent(B);const a=this.updateExpressionTexture(),o=e*a.filledWidthPx,h=e*a.filledHeightPx,c=I.scale(I.create(),i,.5*o),l=I.scale(I.create(),s,n[1]?-h:h),u=I.subtract(I.create(),t,c),d=I.add(I.create(),t,c),g=I.add(I.create(),u,l);this.updateDimensionComponent(B,P,(0,p.createQuad)(u,d,g,void 0,[n[0]?a.rightCoordinate:a.leftCoordinate,a.bottomCoordinate],[n[0]?a.leftCoordinate:a.rightCoordinate,a.topCoordinate]),this.expressionNodeProperties)}updateIconDimensionComponent(e,t,i,s,n){var r;if(null==this.viewer.getResources().dimensionAtlas)return 0;if(this.expressionType===Q.VALUE_ONLY)return this.removeDimensionComponent(U),0;const a=null===(r=this.viewer.getResources().dimensionAtlas)||void 0===r?void 0:r.getTextureCoords(ee(this.expressionType,this.isBad));if(!a)return 0;const o=e*J.getNumber("DIMENSION_ICON_SIZE_PIXELS"),h=I.scale(I.create(),i,n[0]?-o:o),c=I.scale(I.create(),s,.5*o),l=I.scale(I.create(),s,o),u=I.subtract(I.create(),t,c),d=I.subtract(I.create(),u,h),g=I.add(I.create(),d,l),m=(0,p.createQuad)(d,u,g,void 0,[a.lowS,n[1]?a.lowT:a.highT],[a.highS,n[1]?a.highT:a.lowT]);return this.updateDimensionComponent(U,y,m,this.viewer.getResources().dimensionNodeProperties),o}updateValueTexture(e,t,i,s){var n,r;const a=null!=i?i:"";let h=null!=s?s:"";if(!this.preferences||this.preferences&&this.preferences.displayLimitRangeText){if(null===(n=this.displayData)||void 0===n?void 0:n.hasMinimumLimit){const e=(0,o.KZ)(this.displayData.minimumLimit,this.getDimensionUnits(t));h+=", "+i18n("Min")+": "+this.getRoundedDimensionValueForTextDisplay(e,t),s&&(h+=s)}if(null===(r=this.displayData)||void 0===r?void 0:r.hasMaximumLimit){const e=(0,o.KZ)(this.displayData.maximumLimit,this.getDimensionUnits(t));h+=", "+i18n("Max")+": "+this.getRoundedDimensionValueForTextDisplay(e,t),s&&(h+=s)}}const c=this.getRoundedDimensionValueForTextDisplay(e,t),l=a+g.c.convertToCommaFormatIfNeeded(c+"")+h;return this.updateRawValueTexture(l)}updateRawValueTexture(e){if(!this.hasValueChanged(e))return this.valueTexture;this.destroyValueTexture(),this.lastValueProperties={textRendered:e,isBad:this.isBad,hoveredOrTextDragging:this.hovered||this.textDragging,selected:this.selected,isDriven:this.isDriven,isConfigured:this.isConfigured};const{borderColor:t,borderThickness:i}=this.getValueBorderProperties();return this.valueTexture=(0,p.createTextureFromText)(this.viewer,e,{color:this.getValueTextColor(),font:J.getString("DIMENSION_VALUE_FONT"),size:J.getNumber("DIMENSION_VALUE_HEIGHT_PIXELS"),paddingWithinBorder:J.getNumber("DIMENSION_VALUE_BACKGROUND_PADDING"),backgroundColor:this.getValueBackgroundColor(),backgroundOpacity:J.getNumber("DIMENSION_VALUE_BACKGROUND_OPACITY"),backgroundRadius:J.getNumber("DIMENSION_VALUE_BACKGROUND_BORDER_RADIUS"),borderColor:t,borderThickness:i,dashLength:J.getNumber("DIMENSION_CONFIGURED_DASH_LENGTH"),dashGapLength:J.getNumber("DIMENSION_CONFIGURED_DASH_GAP_LENGTH")}),this.valueMaterial.ambientTexture=this.valueTexture,this.valueTexture}updateExpressionTexture(){const e=(0,C.truncate)(this.expression,70);return this.updateRawExpressionTexture(e)}updateRawExpressionTexture(e){if(!this.hasExpressionChanged(e))return this.expressionTexture;this.destroyExpressionTexture(),this.lastExpressionProperties={textRendered:e,isBad:this.isBad,hoveredOrTextDragging:this.hovered||this.textDragging,selected:this.selected};const{borderColor:t,borderThickness:i}=this.getExpressionBorderProperties();let s=J.getNumber("DIMENSION_EXPRESSION_BACKGROUND_PADDING");return i&&(s-=i),this.expressionTexture=(0,p.createTextureFromText)(this.viewer,e,{color:this.getExpressionTextColor(),font:J.getString("DIMENSION_EXPRESSION_FONT"),size:J.getNumber("DIMENSION_EXPRESSION_HEIGHT_PIXELS"),paddingWithinBorder:s,backgroundColor:this.getExpressionBackgroundColor(),backgroundOpacity:J.getNumber("DIMENSION_EXPRESSION_BACKGROUND_OPACITY"),backgroundRadius:J.getNumber("DIMENSION_EXPRESSION_BACKGROUND_BORDER_RADIUS"),borderColor:t,borderThickness:i}),this.expressionMaterial.ambientTexture=this.expressionTexture,this.expressionTexture}getValueTextColor(){var e;let t;return t=(null===(e=this.preferences)||void 0===e?void 0:e.colorName)?this.preferences.colorName:this.isBad?"OVERCONSTRAINED_LINE_POINT_COLOR":this.isDriven?"DIMENSION_DRIVEN_LINE_POINT_COLOR":"DIMENSION_VALUE_TEXT_COLOR",J.getColor(t)}getValueBackgroundColor(){return this.selected?J.getColor("DIMENSION_VALUE_SELECTED_BACKGROUND_COLOR"):this.hovered||this.textDragging?J.getColor("DIMENSION_VALUE_HOVERED_BACKGROUND_COLOR"):null}getValueBorderProperties(){return this.isConfigured?{borderColor:J.getColor("DIMENSION_CONFIGURED_COLOR"),borderThickness:J.getNumber("DIMENSION_CONFIGURED_BORDER_THICKNESS")}:{}}getExpressionTextColor(){let e;return e=this.isBad?this.selected?"DIMENSION_EXPRESSION_BAD_SELECTED_TEXT_COLOR":this.hovered||this.textDragging?"DIMENSION_EXPRESSION_BAD_HOVERED_TEXT_COLOR":"DIMENSION_EXPRESSION_BAD_TEXT_COLOR":"DIMENSION_EXPRESSION_TEXT_COLOR",J.getColor(e)}getExpressionBackgroundColor(){let e;return e=this.isBad?this.selected?"DIMENSION_EXPRESSION_BAD_SELECTED_BACKGROUND_COLOR":this.hovered||this.textDragging?"DIMENSION_EXPRESSION_BAD_HOVERED_BACKGROUND_COLOR":"DIMENSION_EXPRESSION_BAD_BACKGROUND_COLOR":this.expressionType===Q.WITH_VARIABLES?this.selected?"DIMENSION_EXPRESSION_WITH_VARIABLES_SELECTED_BACKGROUND_COLOR":this.hovered||this.textDragging?"DIMENSION_EXPRESSION_WITH_VARIABLES_HOVERED_BACKGROUND_COLOR":"DIMENSION_EXPRESSION_WITH_VARIABLES_BACKGROUND_COLOR":this.selected?"DIMENSION_EXPRESSION_WITHOUT_VARIABLES_SELECTED_BACKGROUND_COLOR":this.hovered||this.textDragging?"DIMENSION_EXPRESSION_WITHOUT_VARIABLES_HOVERED_BACKGROUND_COLOR":"DIMENSION_EXPRESSION_WITHOUT_VARIABLES_BACKGROUND_COLOR",J.getColor(e)}getExpressionBorderProperties(){return this.expressionType!==Q.WITHOUT_VARIABLES||this.isBad||this.selected||this.hovered||this.textDragging?{}:{borderColor:J.getColor("DIMENSION_EXPRESSION_WITHOUT_VARIABLES_BACKGROUND_BORDER_COLOR"),borderThickness:J.getNumber("DIMENSION_EXPRESSION_BACKGROUND_BORDER_THICKNESS")}}getScreenSpaceParameters(e,t){const i={gap:J.getNumber("DIMENSION_WITNESS_MODEL_GAP"),extension:J.getNumber("DIMENSION_WITNESS_EXTENSION")};return this.preferences&&this.preferences.ignoreSpaceParameters?(i.gap=0,i.extension=0):t&&(i.gap*=t,i.extension*=t),i}getArrowColor(){return this.preferences&&this.preferences.colorName?J.getColor(this.preferences.colorName):this.selected?J.getColor("DIMENSION_SELECTED_LINE_ARROW_COLOR"):this.hovered?J.getColor("DIMENSION_HOVERED_LINE_ARROW_COLOR"):this.isBad?J.getColor("OVERCONSTRAINED_LINE_POINT_COLOR"):this.isDriven?J.getColor("DIMENSION_DRIVEN_LINE_POINT_COLOR"):J.getColor("DIMENSION_LINE_ARROW_COLOR")}getLineColor(){return this.getArrowColor()}getLineWidth(){return this.selected||this.hovered?J.getNumber("DIMENSION_SELECTED_LINE_WIDTH"):J.getNumber("DIMENSION_LINE_WIDTH")}getLineStyle(){return this.preferences?this.preferences.lineStyle:null}getTextGap(e,t,i,s){let n=i,r=(0,l.acos)(I.dot(e,t),d.W.ZERO_LENGTH);r>Math.PI/2&&(r=(0,l.acos)(I.dot(M.S4.scale(e,-1,I.create()),t),d.W.ZERO_LENGTH));const a=s/2/(i/2);return n=Math.tan(r)>a?s/Math.sin(r):i/Math.cos(r),n}getValueGapWithIcon(e,t,i,s,n,r){const a=i+2*(n+r);return this.getTextGap(e,t,a,s)}getIconPadding(e){return J.getNumber("DIMENSION_VALUE_BACKGROUND_PADDING")*e}createComponentLine(e,t){return(0,p.createLine)(e,t,void 0,this.getLineColor(),this.getLineWidth(),this.getLineStyle())}updateDimensionComponent(e,t,i,s){const n=this.forPreview?1:0;this.updateMeshIncrement("st."+e,t,i.clone(),s[n])}removeDimensionComponent(e){this.removeMeshIncrement("st."+e)}updateDimensionLineComponent(e,t,i){this.updateDimensionComponent(e,A,this.createComponentLine(t,i),H)}makeThreePointArc(e,t,i,s){const n=(0,p.createArcPolyline)(e.slice(),t.slice(),i.slice(),[],!0);if(n){const e=n.linePoints,t=new Array(3*e.length),i=new Array(2*(e.length-1)),r=s.getIndexOffset();i[0]=r;for(let t=1;t<e.length-1;t++)i[2*t-1]=t+r,i[2*t]=t+r;for(let i=0;i<e.length;i++){const s=e[i],n=this.getModelPoint(s[0],s[1]);for(let e=0;e<3;++e)t[3*i+e]=n[e]}i[i.length-1]=i.length-1+r,s.concat(t,i)}}getValuePrefix(e){var t,i;return null!==(i=null===(t=this.preferences)||void 0===t?void 0:t.textPrefix)&&void 0!==i?i:""}isOfType(e){return this.constructor===e}setPreferences(e){this.preferences=e}getDisplayData(){return this.displayData}}class ae{constructor(){this.points=[],this.indices=[]}concat(e,t){this.points=this.points.concat(e),this.indices=this.indices.concat(t)}getIndexOffset(){return this.points.length/3}}class oe extends re{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="LinearDimension"}updateFromDisplayData(e){this.displayData=e,this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}getPosition(){return m.fromValues(this.displayData.positionX,this.displayData.positionY)}getRoundedDimensionValueForTextDisplay(e,t){return(0,l.roundTo)(e,t.getLengthUnitsDisplayPrecision())}getDimensionUnits(e){return e.getLengthUnits()}update(e,t){if(!this.displayData)return;let i;const s=[this.displayData.witnessEndPoint0X,this.displayData.witnessEndPoint0Y],n=[this.displayData.witnessEndPoint1X,this.displayData.witnessEndPoint1Y],r=this.getPosition(),a=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(r[0],r[1]))),h=this.getModelPoint(s[0],s[1]),c=this.getModelPoint(n[0],s[1]),l=this.getModelPoint(s[0],s[1]+n[0]-s[0]);let u=M.S4.normalize(M.S4.subtract(c,h)),g=M.S4.normalize(M.S4.subtract(l,h));(I.dot(u,u)<d.W.ZERO_LENGTH_SQUARED||I.dot(g,g)<d.W.ZERO_LENGTH_SQUARED)&&(u=M.S4.normalize(M.S4.subtract(this.getModelPoint(1,0),h)),g=M.S4.normalize(M.S4.subtract(this.getModelPoint(0,1),h)));const f=this.getVisualRightVector(),E=this.getVisualUpVector(),S=Math.abs(this.displayData.value);let T=J.getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*a,C=J.getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*a;const D=C;C>S*J.getNumber("DIMENSION_ARROW_MAX_PROPORTION")&&(i=S*J.getNumber("DIMENSION_ARROW_MAX_PROPORTION")/C,T*=i,C*=i);const P=[],y=this;function O(e,t,i,s){const n=y.getModelPoint(i,s);return M.S4.add(n,M.S4.add(M.S4.scale(u,e,I.create()),M.S4.scale(g,t,I.create())))}function R(e,t,i,s){const n=O(e,t,i,s);for(let e=0;e<3;++e)P.push(n[e])}R(0,0,s[0],r[1]),R(C,.5*-T,s[0],r[1]),R(C,.5*T,s[0],r[1]),R(0,0,n[0],r[1]),R(-C,.5*-T,n[0],r[1]),R(-C,.5*T,n[0],r[1]),this.updateDimensionComponent(k,"",(0,p.createTriangles)(P,[0,1,2,3,4,5],void 0,this.getArrowColor()),z);const w=(0,o.KZ)(this.displayData.value,t.getLengthUnits()),_=this.updateValueTexture(w,t,this.getValuePrefix(t)),N=a*_.filledWidthPx,b=a*_.filledHeightPx,L=I.scale(I.create(),E,.5*b),F=this.getModelPoint(r[0],r[1]);I.subtract(F,F,L);const B=I.scale(I.create(),E,b),U=I.scale(I.create(),f,.5*N),V=I.subtract(I.create(),F,U),G=I.add(I.create(),F,U),W=I.add(I.create(),V,B),Y=(0,p.orientText)(e,f,E,this.transform),K=I.add(I.create(),Y[0]?G:V,L),j=this.updateIconDimensionComponent(a,K,f,E,Y),Q=this.getTextGap(u,f,N,b),$=j>0?this.getValueGapWithIcon(u,f,N,b,j,this.getIconPadding(a)):Q,ee=this.getScreenSpaceParameters(t,a);let te=ee.extension;Q>S&&(te=0);const ie=s[1]+(r[1]>s[1]?ee.gap:-ee.gap),se=n[1]+(r[1]>n[1]?ee.gap:-ee.gap),ne=r[1]+(r[1]>0?te:-te);this.updateDimensionLineComponent(X,this.getModelPoint(s[0],ie),this.getModelPoint(s[0],ne)),this.updateDimensionLineComponent(q,this.getModelPoint(n[0],se),this.getModelPoint(n[0],ne));let re=s[0],ae=n[0];s[0]>n[0]&&(re=n[0],ae=s[0]);const{leftGapLength:oe,rightGapLength:he}=this.getLeftAndRightGapLengthInDimensionCoordinates(Q,$,m.fromValues(re,r[1]),m.fromValues(ae,r[1]),Y[0]);let ce=r[0]+he/2>ae+C/2,le=r[0]-oe/2<re-C/2,ue=[];const de=[];function ge(e,t,i,s,n){const r=O(e,t,i,s);n.push(r)}if(ce||le?(this.updateDimensionLineComponent(Z,this.getModelPoint(s[0],r[1]),this.getModelPoint(n[0],r[1])),ce?this.updateDimensionLineComponent(Z,this.getModelPoint(re,r[1]),this.getModelPoint(r[0]-oe/2,r[1])):le&&this.updateDimensionLineComponent(Z,this.getModelPoint(ae,r[1]),this.getModelPoint(r[0]+he/2,r[1]))):(ce=r[0]+he/2>ae-C/2,le=r[0]-oe/2<re+C/2,ce?(ue.push(this.getModelPoint(re,r[1])),ue.push(this.getModelPoint(r[0]-oe/2,r[1]))):le?(ue.push(this.getModelPoint(r[0]+he/2,r[1])),ue.push(this.getModelPoint(ae,r[1]))):ue=[this.getModelPoint(re,r[1]),this.getModelPoint(r[0]-oe/2,r[1]),this.getModelPoint(r[0]+he/2,r[1]),this.getModelPoint(ae,r[1])]),this.preferences&&this.preferences.displayLimitRangeTicks){const e=this.displayData.value<0?-1:1;if(this.displayData.hasMinimumLimit){if(this.displayData.minimumLimit<0){const t=e<0?n:s;ge(0,0,t[0],t[1],ue),ge(e*this.displayData.minimumLimit,0,s[0],s[1],ue)}ge(e*this.displayData.minimumLimit,-D,s[0],s[1],de),ge(e*this.displayData.minimumLimit,D,s[0],s[1],de)}if(this.displayData.hasMaximumLimit){if(this.displayData.maximumLimit>0){const t=e<0?s:n;ge(0,0,t[0],t[1],ue),ge(e*this.displayData.maximumLimit,0,s[0],r[1],ue)}ge(e*this.displayData.maximumLimit,-D,s[0],s[1],de),ge(e*this.displayData.maximumLimit,D,s[0],s[1],de)}}ue.length>0&&this.updateDimensionComponent(Z,A,(0,p.createLines)(ue,void 0,this.getLineColor(),this.getLineWidth(),this.getLineStyle()),H);const pe=Z+"_TICK";de.length>0?this.updateDimensionComponent(pe,A,(0,p.createLines)(de,void 0,this.getLineColor(),this.getLineWidth()),H):this.removeDimensionComponent(pe),this.updateDimensionComponent(x,v,(0,p.createQuad)(V,G,W,void 0,[Y[0]?_.rightCoordinate:_.leftCoordinate,Y[1]?_.topCoordinate:_.bottomCoordinate],[Y[0]?_.leftCoordinate:_.rightCoordinate,Y[1]?_.bottomCoordinate:_.topCoordinate]),this.valueNodeProperties);const me=Y[1]?F:I.add(I.create(),F,B);this.updateExpressionDimensionComponent(a,me,f,E,Y)}getLeftAndRightGapLengthInDimensionCoordinates(e,t,i,s,n){if(e===t)return{leftGapLength:e,rightGapLength:e};let r=t,a=e;n&&(r=e,a=t);const o=m.transformMat3(m.create(),i,this.dimensionMatrix),h=m.transformMat3(m.create(),s,this.dimensionMatrix);return o[0]>h[0]?{leftGapLength:a,rightGapLength:r}:{leftGapLength:r,rightGapLength:a}}getLabelPositionInPlane(){return M.xB.multiplyVec2(this.dimensionMatrix,[this.displayData.positionX,this.displayData.positionY],E.create())}getFitBounds(){const e=new p.BoundingBox;return this.addPointToBounds(this.getModelPoint(this.displayData.positionX,this.displayData.positionY),e),this.addPointToBounds(this.getModelPoint(this.displayData.witnessEndPoint0X,this.displayData.witnessEndPoint0Y),e),this.addPointToBounds(this.getModelPoint(this.displayData.witnessEndPoint1X,this.displayData.witnessEndPoint1X),e),e}}class he extends oe{constructor(e,t,i){super(e,t,i),this.id="CenterlineDimension"}getValuePrefix(e){return"Ø"}}class ce extends oe{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="EllipseDiameterDimension"}}const le=function(e,t){return m.fromValues(Math.cos(e)*t,Math.sin(e)*t)};class ue extends re{constructor(e,t,i){super(e,t,i),this.displayData=null}setPosition(e){this.displayData.positionR=Math.sqrt(e[0]*e[0]+e[1]*e[1]),this.displayData.positionT=Math.atan2(e[1],e[0])}getLabelPositionInPlane(){const e=le(this.displayData.positionT,this.displayData.positionR);return M.xB.multiplyVec2(this.dimensionMatrix,[e[0],e[1]],E.create())}getModelPointFromPolar(e,t){return this.getModelPoint(t*Math.cos(e),t*Math.sin(e))}}const de=function(e){return e-2*(0,p.floorTowardsZero)(e/(2*Math.PI))*Math.PI},ge=function(e,t,i){const s=(e+t)/2,n=(0,p.closestAngle)(i,s),r=Math.abs(t-e);let a=0,o=0,h=0;if(2*Math.abs(n-s)>r){h=i;const s=(0,p.closestAngle)(e,h),n=(0,p.closestAngle)(t,h);a=Math.abs(s-h)<Math.abs(n-h)?s:n,o=Math.floor(1+(J.getNumber("DIMENSION_ARC_WITNESS_SEGMENTS")-1)*Math.abs(h-a)/(2*Math.PI))}return{firstAngle:a,secondAngle:h,segments:o}};class pe extends ue{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="RadialDimension"}updateFromDisplayData(e){this.displayData=e,this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}getPosition(){return m.clone(le(this.displayData.positionT,this.displayData.positionR))}getRoundedDimensionValueForTextDisplay(e,t){return(0,l.roundTo)(e,t.getLengthUnitsDisplayPrecision())}getDimensionUnits(e){return e.getLengthUnits()}update(e,t){if(!this.displayData)return;const i=this.displayData.value,s=this.getPosition(),n=le(this.displayData.positionT,1),r=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(s[0],s[1]))),a=this.getModelPoint(0,0),c=le(this.displayData.positionT+Math.PI/2,1),l=M.S4.normalize(M.S4.subtract(this.getModelPoint(n[0],n[1]),a)),u=M.S4.normalize(M.S4.subtract(this.getModelPoint(c[0],c[1]),a)),d=this.getVisualRightVector(),g=this.getVisualUpVector();let m=J.getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*r,f=J.getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*r;if(f>i*J.getNumber("DIMENSION_ARROW_MAX_PROPORTION")){const e=i*J.getNumber("DIMENSION_ARROW_MAX_PROPORTION")/f;m*=e,f*=e}const E=[],S=this,C=function(e,t,i,s){const n=S.getModelPoint(i,s),r=M.S4.add(n,M.S4.add(M.S4.scale(l,e,I.create()),M.S4.scale(u,t,I.create())));for(let e=0;e<3;++e)E.push(r[e])};let D=(0,o.KZ)(i,t.getLengthUnits()),P=i;const y=this.displayData.radiusDisplay===h.MEf.DIAMETRAL,O=y&&!this.displayData.realDiameter;let R="R";y&&(R="Ø",O?D*=2:P/=2);const w=this.updateValueTexture(D,t,R),_=r*w.filledWidthPx,N=r*w.filledHeightPx,b=I.scale(I.create(),g,.5*N),L=this.getModelPoint(s[0],s[1]);I.subtract(L,L,b);const F=I.scale(I.create(),d,.5*_),B=I.scale(I.create(),g,N),U=I.subtract(I.create(),L,F),V=I.add(I.create(),L,F),G=I.add(I.create(),U,B),W=(0,p.orientText)(e,d,g,this.transform),Z=I.add(I.create(),W[0]?V:U,b),Y=this.updateIconDimensionComponent(r,Z,d,g,W);let K,j;const Q=this.getTextGap(l,d,_,N),$=Y>0?this.getValueGapWithIcon(l,d,_,N,Y,this.getIconPadding(r)):Q,ee=W[0]?Q:$,te=W[0]?$:Q,ie=n[0]>0?ee:te,se=n[0]>0?te:ee;if(this.displayData.positionR-ie/2>P)K=le(this.displayData.positionT,P),j=le(this.displayData.positionT,this.displayData.positionR-ie/2),C(0,0,K[0],K[1]),C(f,.5*-m,K[0],K[1]),C(f,.5*m,K[0],K[1]),this.updateDimensionComponent(k,"",(0,p.createTriangles)(E,[0,1,2],void 0,this.getArrowColor()),z),this.updateDimensionLineComponent(X,this.getModelPoint(K[0],K[1]),this.getModelPoint(j[0],j[1]));else{K=[0,0],y&&(K=le(Math.PI+this.displayData.positionT,P)),j=le(this.displayData.positionT,P),C(0,0,K[0],K[1]),C(f,.5*-m,K[0],K[1]),C(f,.5*m,K[0],K[1]),C(0,0,j[0],j[1]),C(-f,.5*-m,j[0],j[1]),C(-f,.5*m,j[0],j[1]),this.updateDimensionComponent(k,"",(0,p.createTriangles)(E,[0,1,2,3,4,5],void 0,this.getArrowColor()),z);const e=le(this.displayData.positionT,this.displayData.positionR-ie/2),t=le(this.displayData.positionT,this.displayData.positionR+se/2),i=[],s=this.getModelPoint(K[0],K[1]),n=this.getModelPoint(j[0],j[1]),r=this.getModelPoint(e[0],e[1]),a=this.getModelPoint(t[0],t[1]);(!y&&this.displayData.positionR-ie/2>0||y)&&(i.push(s),i.push(r)),this.displayData.positionR+se/2<P&&(i.push(a),i.push(n)),this.updateDimensionComponent(X,A,(0,p.createLines)(i,void 0,this.getLineColor(),this.getLineWidth(),this.getLineStyle()),H)}if(!y){const e=ge(this.displayData.witnessEndPoint0t,this.displayData.witnessEndPoint1t,this.displayData.positionT),t=(0,p.createArc)(a,this.displayData.witnessEndPoint1r,M.w$.multiplyVec4(this.getPlaneMatrix(),[0,0,1,0],T.create()),d,e.firstAngle,e.secondAngle,e.segments);(0,p.addColorToIncrement)(this.getLineColor(),t),this.getLineStyle()&&(0,p.addStyleToIncrement)(this.getLineStyle(),t),this.updateDimensionComponent(q,A,t,H)}this.updateDimensionComponent(x,v,(0,p.createQuad)(U,V,G,void 0,[W[0]?w.rightCoordinate:w.leftCoordinate,W[1]?w.topCoordinate:w.bottomCoordinate],[W[0]?w.leftCoordinate:w.rightCoordinate,W[1]?w.bottomCoordinate:w.topCoordinate]),this.valueNodeProperties);const ne=W[1]?L:I.add(I.create(),L,B);this.updateExpressionDimensionComponent(r,ne,d,g,W)}getFitBounds(){const e=new p.BoundingBox;return this.addPointToBounds(this.getModelPointFromPolar(this.displayData.positionT,this.displayData.positionR),e),e}}class me extends ue{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="AngularDimension"}updateFromDisplayData(e){this.displayData=e,this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}getDisplayValue(e,t){return(0,o.KZ)(e,t.getAngleUnits())}getValueSuffix(e){var t;let i=e.getAngleUnits();const s=null!==(t=null==i?void 0:i.toLowerCase())&&void 0!==t?t:"";return"degree"===s?i="°":"radian"===s&&(i=" radian"),i}addArcLengthAnnotation(e,t,i,s,n,r,a,o){return 0}isArcLengthDimension(){return!1}getPosition(){return le(this.displayData.positionT,this.displayData.positionR)}getRoundedDimensionValueForTextDisplay(e,t){return this.isArcLengthDimension()?(0,l.roundTo)(e,t.getLengthUnitsDisplayPrecision()):(0,l.roundTo)(e,t.getAngleUnitsDisplayPrecision())}getDimensionUnits(e){return e.getAngleUnits()}update(e,t){if(!this.displayData)return;const i=this.displayData.value,s=this.getPosition(),n=de(this.displayData.witnessEndPoint0t),r=de(this.displayData.witnessEndPoint1t),a=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(s[0],s[1]))),o=this.getValuePrefix(t),h=this.getValueSuffix(t),c=this.getDisplayValue(i,t),l=this.updateValueTexture(c,t,o,h),u=a*l.filledWidthPx,d=a*l.filledHeightPx;let g=J.getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*a,f=J.getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*a;const E=r-n,S=Math.abs(E*this.displayData.positionR)*J.getNumber("DIMENSION_ARROW_MAX_PROPORTION");if(f>S){const e=S/f;g*=e,f*=e}let T=1;n>r&&(T=-1);const C=[],D=this,P=function(e,t,i,s){let n=le(i,s);const r=[Math.cos(i),Math.sin(i)],a=[-r[1]*T,r[0]*T];n=M.gv.add(n,M.gv.add(M.gv.scale(r,t,m.create()),M.gv.scale(a,e,m.create())));const o=D.getModelPoint(n[0],n[1]);for(let e=0;e<3;++e)C.push(o[e])},y=f/this.displayData.positionR;P(0,0,n,this.displayData.positionR),P(0,.5*-g,n+y*T,this.displayData.positionR),P(0,.5*g,n+y*T,this.displayData.positionR),P(0,0,r,this.displayData.positionR),P(0,.5*-g,r-y*T,this.displayData.positionR),P(0,.5*g,r-y*T,this.displayData.positionR),this.updateDimensionComponent(k,"",(0,p.createTriangles)(C,[0,1,2,3,4,5],void 0,this.getArrowColor()),z);const O=this.getScreenSpaceParameters(t,a),R=this.displayData.positionR+(this.displayData.witnessEndPoint0r<this.displayData.positionR?O.extension:-O.extension),w=this.displayData.positionR+(this.displayData.witnessEndPoint1r<this.displayData.positionR?O.extension:-O.extension);let _,N;if(this.isArcLengthDimension())_=this.displayData.witnessEndPoint0r+(this.displayData.witnessEndPoint0r>this.displayData.positionR?-O.gap:O.gap),N=this.displayData.witnessEndPoint1r+(this.displayData.witnessEndPoint1r>this.displayData.positionR?-O.gap:O.gap);else{const e=this.displayData.witnessMaxPoint0r+O.gap,t=this.displayData.witnessMinPoint0r-O.gap,i=this.displayData.witnessMaxPoint1r+O.gap,s=this.displayData.witnessMinPoint1r-O.gap;_=this.displayData.positionR>e?e:this.displayData.positionR<t?t:R,N=this.displayData.positionR>i?i:this.displayData.positionR<s?s:w}const b=(e,t,i,s)=>{this.updateDimensionLineComponent(e,this.getModelPointFromPolar(t,i),this.getModelPointFromPolar(t,s))};b(X,n,_,R),b(q,r,N,w);const L=this.getModelPointFromPolar(this.displayData.positionT,this.displayData.positionR),F=-Math.sin(this.displayData.positionT),B=Math.cos(this.displayData.positionT),U=M.S4.normalize(M.S4.subtract(this.getModelPoint(s[0]+F,s[1]+B),L)),V=this.getVisualRightVector(),G=this.getVisualUpVector(),W=new ae,Z=this.displayData.positionR,Y=(0,p.orientText)(e,V,G,this.transform),K=this.addArcLengthAnnotation(Y[1],-this.displayData.coordinateSystem.m00,-this.displayData.coordinateSystem.m01,u,d,this.displayData.positionT,Z,this.displayData.clockwise),j=I.scale(I.create(),G,.5*d),Q=I.subtract(I.create(),L,j),$=I.scale(I.create(),V,.5*u),ee=I.subtract(I.create(),Q,$),te=I.add(I.create(),Q,$),ie=I.scale(I.create(),G,d),se=I.add(I.create(),ee,ie),ne=I.add(I.create(),Y[0]?te:ee,j),re=this.updateIconDimensionComponent(a,ne,V,G,Y),oe=(this.getValueGapWithIcon(U,V,u,d,.5*re,0)+K)/2/this.displayData.positionR;let he=Math.abs(2*Math.asin(oe));isNaN(he)&&(he=0);let ce=this.displayData.positionT;if(T>0)for(;ce+he/2<0;)ce+=2*Math.PI;else for(;ce-he/2>0;)ce-=2*Math.PI;const ue=ce+he/2,pe=ce-he/2;if(Math.abs(oe)>1||T>0&&ue<n||T>0&&pe>r||T<0&&pe>n||T<0&&ue<r){const e=ge(de(this.displayData.witnessEndPoint0t),de(this.displayData.witnessEndPoint1t),ce);0!==e.secondAngle&&(e.secondAngle+=e.firstAngle>e.secondAngle?he/2:-he/2),this.makeArc(e.firstAngle,e.secondAngle,W),this.makeArc(n,r,W)}else(T>0&&ce-he/2>n||T<0&&ce+he/2<n)&&this.makeArc(n,ce-T*he/2,W),(T>0&&ce+he/2<r||T<0&&ce-he/2>r)&&this.makeArc(ce+T*he/2,r,W);const me=new p.MeshIncrement(p.PrimitiveType.LINES,W.points,W.indices);(0,p.addColorToIncrement)(this.getLineColor(),me),(0,p.addSizeToIncrement)(this.getLineWidth(),me),this.getLineStyle()&&(0,p.addStyleToIncrement)(this.getLineStyle(),me),this.updateDimensionComponent("arc",A,me,H),this.updateDimensionComponent(x,v,(0,p.createQuad)(ee,te,se,void 0,[Y[0]?l.rightCoordinate:l.leftCoordinate,Y[1]?l.topCoordinate:l.bottomCoordinate],[Y[0]?l.leftCoordinate:l.rightCoordinate,Y[1]?l.bottomCoordinate:l.topCoordinate]),this.valueNodeProperties);const fe=Y[1]?Q:I.add(I.create(),Q,ie);this.updateExpressionDimensionComponent(a,fe,V,G,Y)}getFitBounds(){const e=new p.BoundingBox;return this.addPointToBounds(this.getModelPointFromPolar(this.displayData.witnessEndPoint0t,this.displayData.witnessEndPoint0r),e),this.addPointToBounds(this.getModelPointFromPolar(this.displayData.witnessEndPoint1t,this.displayData.witnessEndPoint1r),e),this.addPointToBounds(this.getModelPointFromPolar(this.displayData.witnessEndPoint0t,this.displayData.positionR),e),this.addPointToBounds(this.getModelPointFromPolar(this.displayData.witnessEndPoint1t,this.displayData.positionR),e),this.addPointToBounds(this.getModelPointFromPolar(this.displayData.positionT,this.displayData.positionR),e),e}makeArc(e,t,i){const s=i.getIndexOffset();let n=e,r=Math.max(Math.floor(d.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE*Math.abs(t-e)/(2*Math.PI)+1),0);isNaN(r)&&(r=0);const a=new Array(3*(r+1)),o=(t-e)/r;for(let e=0;e<r+1;++e){const t=this.getModelPointFromPolar(n,this.displayData.positionR);for(let i=0;i<3;++i)a[3*e+i]=t[i];n+=o}const h=new Array(2*r);let c;for(h[0]=s,c=1;c<r;c++)h[2*c-1]=c+s,h[2*c]=c+s;h[h.length-1]=c+s,i.concat(a,h)}}class fe extends me{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="ArcLengthDimension"}getDisplayValue(e,t){return(0,o.KZ)(e,t.getLengthUnits())}getValueSuffix(e){return""}isArcLengthDimension(){return!0}getDimensionUnits(e){return e.getLengthUnits()}addArcLengthAnnotation(e,t,i,s,n,r,a,o){const h=new ae,c=m.fromValues(t,i),l=m.fromValues(i,-t),u=J.getNumber("DIMENSION_ARC_LENGTH_SCALE"),d=le(this.displayData.positionT,a);o&&(M.gv.scale(c,-1),M.gv.scale(l,-1)),e&&(M.gv.scale(c,-1),M.gv.scale(l,-1));const g=m.create();M.gv.add(d,M.gv.scale(c,u*s/2,m.create()),g),M.gv.add(g,M.gv.scale(l,n/2,m.create()),g);const f=m.create();M.gv.add(d,M.gv.scale(c,-u*s/2,m.create()),f),M.gv.add(f,M.gv.scale(l,n/2,m.create()),f),M.gv.add(d,M.gv.scale(l,n*u,m.create()),d),this.makeThreePointArc(g,d,f,h);const I=new p.MeshIncrement(p.PrimitiveType.LINES,h.points,h.indices);return(0,p.addColorToIncrement)(this.getLineColor(),I),(0,p.addSizeToIncrement)(this.getLineWidth(),I),this.updateDimensionComponent(V,v,I,H),n*(u-.5+J.getNumber("DIMENSION_TEXT_GAP"))}}class Ie extends re{constructor(e,t,i){super(e,t,i),this.id="PointDimension"}updateFromDisplayData(e){this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}isLengthDimension(){return!0}update(e,t){const i=this.getDisplayData();if(!i)return;let s;const n=this.getPosition(),r=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(n[0],n[1]))),a=i.value;let o=J.getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*r,h=J.getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*r;h>a*J.getNumber("DIMENSION_ARROW_MAX_PROPORTION")&&this.isLengthDimension()&&(s=a*J.getNumber("DIMENSION_ARROW_MAX_PROPORTION")/h,o*=s,h*=s);const c=this.getModelPoint(0,0),l=M.S4.normalize(M.S4.subtract(this.getModelPoint(1,0),c)),u=M.S4.normalize(M.S4.subtract(this.getModelPoint(0,1),c)),d=this.getTextureInfoForLabel(a,t),g=r*d.filledWidthPx,m=r*d.filledHeightPx,f=(0,p.orientText)(e,l,u,this.transform),E=this.wantArcLengthSymbol()?this.addArcLengthSymbol(n,g,m,f[1]):.5*m,S=this.getModelPoint(n[0],n[1]),T=I.scale(I.create(),l,.5*g),C=I.scale(I.create(),u,.5*m),D=I.subtract(I.create(),S,T),P=I.add(I.create(),S,T),y=I.subtract(I.create(),D,C),O=I.subtract(I.create(),P,C),R=I.add(I.create(),D,C),w=this.getModelPoint(0,0),_=I.scale(I.create(),u,E),N=this.updateIconDimensionComponent(r,f[0]?P:D,l,u,f),b=N>0?I.scale(I.create(),l,.5*g+N+this.getIconPadding(r)):T,L=[I.subtract(I.create(),S,f[0]?T:b),I.add(I.create(),S,f[0]?b:T),I.subtract(I.create(),S,f[1]?_:C),I.add(I.create(),S,f[1]?C:_)];let F=null,B=null;for(const e of L){const t=I.squaredLength(I.subtract(I.create(),e,w));(!F||t<F)&&(F=t,B=e)}const U=[],V=I.normalize(I.create(),I.subtract(I.create(),B,w)),G=I.transformMat4(I.create(),[0,0,1],this.getPlaneMatrix()),W=I.normalize(I.create(),I.cross(I.create(),V,G)),q=this,Z=function(e,t,i,s){const n=q.getModelPoint(i,s),r=I.add(I.create(),n,I.add(I.create(),I.scale(I.create(),V,e),I.scale(I.create(),W,t)));for(let e=0;e<3;++e)U.push(r[e])};Z(0,0,0,0),Z(h,.5*-o,0,0),Z(h,.5*o,0,0),this.updateDimensionComponent(k,"",(0,p.createTriangles)(U,[0,1,2],void 0,this.getArrowColor()),z),this.updateDimensionComponent(X,A,this.createComponentLine(w,B),H),this.updateDimensionComponent(x,v,(0,p.createQuad)(y,O,R,void 0,[f[0]?d.rightCoordinate:d.leftCoordinate,f[1]?d.topCoordinate:d.bottomCoordinate],[f[0]?d.leftCoordinate:d.rightCoordinate,f[1]?d.bottomCoordinate:d.topCoordinate]),this.valueNodeProperties);const Y=f[1]?I.subtract(I.create(),S,_):I.add(I.create(),S,_);this.updateExpressionDimensionComponent(r,Y,l,u,f)}getTextureInfoForLabel(e,t){const i=(0,o.KZ)(e,t.getLengthUnits());return this.updateValueTexture(i,t)}getFitBounds(){const e=new p.BoundingBox;this.addPointToBounds(this.getModelPoint(0,0),e);const t=this.getPosition();return this.addPointToBounds(this.getModelPoint(t[0],t[1]),e),e}wantArcLengthSymbol(){return!1}getDisplayData(){return null}addArcLengthSymbol(e,t,i,s){const n=J.getNumber("DIMENSION_ARC_LENGTH_SCALE"),r=n*t/2,a=s?-i:i,o=m.fromValues(e[0]-r,e[1]+a/2),h=m.fromValues(e[0],e[1]+n*a),c=m.fromValues(e[0]+r,o[1]),l=new ae;this.makeThreePointArc(o,h,c,l);const u=new p.MeshIncrement(p.PrimitiveType.LINES,l.points,l.indices);return(0,p.addColorToIncrement)(this.getLineColor(),u),(0,p.addSizeToIncrement)(this.getLineWidth(),u),this.updateDimensionComponent(V,v,u,H),i*(n+J.getNumber("DIMENSION_TEXT_GAP"))}getLabelPositionInPlane(){return M.xB.multiplyVec2(this.dimensionMatrix,this.getPosition(),E.create())}}class Ee extends Ie{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="BezierDegreeDimension"}isLengthDimension(){return!1}updateFromDisplayData(e){this.displayData=e,super.updateFromDisplayData(e)}getDisplayData(){return this.displayData}getPosition(){return m.fromValues(this.displayData.positionX,this.displayData.positionY)}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}getRoundedDimensionValueForTextDisplay(e,t){return e}getDimensionUnits(e){return""}getTextureInfoForLabel(e,t){return this.updateValueTexture(e,t,"Deg ")}canBeDrivenDimension(){return!1}}class Se extends Ie{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="RhoDimension"}isLengthDimension(){return!1}updateFromDisplayData(e){this.displayData=e,super.updateFromDisplayData(e)}getDisplayData(){return this.displayData}getPosition(){return m.fromValues(this.displayData.positionX,this.displayData.positionY)}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}getRoundedDimensionValueForTextDisplay(e,t){return(0,l.roundTo)(e,t.getLengthUnitsDisplayPrecision())}getDimensionUnits(e){return""}getTextureInfoForLabel(e,t){return this.updateValueTexture(e,t,"Rho ")}}class Te extends Ie{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="CurveLengthDimension"}wantArcLengthSymbol(){return!this.isForPreview()}isLengthDimension(){return!0}getRoundedDimensionValueForTextDisplay(e,t){return(0,l.roundTo)(e,t.getLengthUnitsDisplayPrecision())}getDimensionUnits(e){return e.getLengthUnits()}getTextureInfoForLabel(e,t){if(this.isForPreview())return this.updateRawValueTexture("⌒");{const i=(0,o.KZ)(e,t.getLengthUnits());return this.updateValueTexture(i,t)}}updateFromDisplayData(e){this.displayData=e,super.updateFromDisplayData(e)}getDisplayData(){return this.displayData}getPosition(){return m.fromValues(this.displayData.positionX,this.displayData.positionY)}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}}class Me extends Ie{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="CountDimension"}getTextureInfoForLabel(e,t){return this.updateValueTexture(e,t,void 0,"x")}getRoundedDimensionValueForTextDisplay(e,t){return(0,l.roundTo)(e,0)}getDimensionUnits(e){return""}updateFromDisplayData(e){this.displayData=e,super.updateFromDisplayData(e)}getDisplayData(){return this.displayData}getPosition(){return m.fromValues(this.displayData.positionX,this.displayData.positionY)}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}canBeDrivenDimension(){return!1}}function Ce(e,t,i,s){s||(s={forPreview:void 0,isMateValue:void 0});let n=null;return e instanceof h.Vh_?n=new fe(i,!!s.forPreview,t):e instanceof h.eor?n=new he(i,!!s.forPreview,t):e instanceof h.ktz?n=new ce(i,!!s.forPreview,t):e instanceof h.Ye1?n=new oe(i,!!s.forPreview,t):e instanceof h.oTb?n=new me(i,!!s.forPreview,t):e instanceof h.lAf?n=new pe(i,!!s.forPreview,t):e instanceof h.oUi?n=new Te(i,!!s.forPreview,t):e instanceof h.ohc?n=new Me(i,!!s.forPreview,t):e instanceof h.Id4?n=new Se(i,!!s.forPreview,t):e instanceof h.jJ2&&(n=new Ee(i,!!s.forPreview,t)),s.isMateValue&&(n.getClearModelSelectionsOnPrehilite=function(){return!1}),n}},83290:function(e,t,i){i.d(t,{IK:function(){return m},XH:function(){return S},l_:function(){return E},lv:function(){return T},po:function(){return p}});var s=i(92709),n=i(93249),r=i(79275),a=i(41810),o=i(57532),h=i(44072),c=i(26407),l=i(43310),u=i(78591);const d=[a.ls1.ANGULAR_TOLERANCE_COARSE,a.ls1.ANGULAR_TOLERANCE_MEDIUM,a.ls1.ANGULAR_TOLERANCE_FINE,a.ls1.ANGULAR_TOLERANCE_VERY_FINE,a.ls1.ANGULAR_TOLERANCE_CURVATURE_ANALYSIS],g=[a.ls1.CHORDAL_TOLERANCE_RATIO_COARSE,a.ls1.CHORDAL_TOLERANCE_RATIO_MEDIUM,a.ls1.CHORDAL_TOLERANCE_RATIO_FINE,a.ls1.CHORDAL_TOLERANCE_RATIO_VERY_FINE,a.ls1.CHORDAL_TOLERANCE_RATIO_CURVATURE_ANALYSIS];var p;function m(e,t){switch(e){case p.PART:return t?i18n("parts"):i18n("part");case p.SURFACE:return t?i18n("surfaces"):i18n("surface");case p.MESH:return t?i18n("meshes"):i18n("mesh");case p.CURVE:return t?i18n("curves"):i18n("curve");case p.POINT:return t?i18n("points"):i18n("point");case p.SKETCH:return t?i18n("sketches"):i18n("sketch");default:return""}}function f(e){const t=1/e;return a.ls1.ESTIMATION_COEFFICIENT_0+a.ls1.ESTIMATION_COEFFICIENT_1*t+a.ls1.ESTIMATION_COEFFICIENT_2*t*t}!function(e){e[e.PART=0]="PART",e[e.SURFACE=1]="SURFACE",e[e.MESH=2]="MESH",e[e.CURVE=3]="CURVE",e[e.POINT=4]="POINT",e[e.SKETCH=5]="SKETCH",e[e.NUMBER_OF_TYPES=6]="NUMBER_OF_TYPES"}(p||(p={}));const I=f(a.ls1.ANGULAR_TOLERANCE_COARSE);function E(e,t,i){const s=f(d[i]);return t/I*s+e}class S{constructor(e){this.id=e,this.name="",this.meshState=a.W6T.NO_MESH,this.constituentsContainMesh=!1,this.isModifiable=!0,this.foundInPreview=!1,this.appearance=null,this.defaultColorHash="",this.meshIncrement=null,this.tessellationSettings=null,this.isFlattenedSheetMetalBody=!1,this.isBendCenterLineBody=!1,this.ownerFlattenedBodyId="",this.sheetMetalModelId="",this.isActiveSheetMetal=!1,this.sheetMetalOrderId="",this.sheetMetalOrder=0,this.isTessellationLoaded=!1,this.coarseTriangleCount=0,this.coarsePlanarFaceTriangleCount=0,this.isAssociatedWithFlat=!1,this.colorCycle=null,this.totalEntityCount=0,this.lastViewTime=0,this.lastViewportOccupancy=0,this.partStudioVisibility=u.Visibility.VISIBLE,this.isComposite=!1,this.isClosedComposite=!1,this.constituentBodyIds_=null,this.consumingClosedCompositeData=null,this.referencingOpenCompositeData_=null,this.isSketchBody=!1,this.type=a.wG2.UNKNOWN,this.bounds=new u.BoundingBox,this.bestAvailableTessellationSetting=a.XiJ.UNKNOWN,this.tessellationSettingOverride=a.XiJ.AUTO,this.constituentTypeCounts=new Array(p.NUMBER_OF_TYPES).fill(0)}getId(){return this.id}setAppearanceFromDisplayData(e){e?(e.appearance&&e.appearance.color&&(this.appearance=(0,l.shallowClone)(e.appearance),this.appearance.color=new Uint8Array(e.appearance.color)),this.defaultColorHash=e.defaultColorHash):r.log.warn("setAppearanceFromDisplayData called without valid display data")}setColorCycle(e){this.colorCycle=e}getColorCycle(){return this.colorCycle}getColor(){var e,t,i,a;const o=n.default.getManager();if(this.containsOnlyWireBodies()){if(!this.isModifiableBody())return o.getColor("REFERENCE_GEOMETRY_COLOR");if(!(0,s.r)())return o.getColor("LINE_POINT_COLOR");if(3!==(null===(t=null===(e=this.appearance)||void 0===e?void 0:e.color)||void 0===t?void 0:t.length))return o.getColor("LINE_POINT_COLOR")}if(3===(null===(a=null===(i=this.appearance)||void 0===i?void 0:i.color)||void 0===a?void 0:a.length)){const e=this.appearance.color;return[e[0]/255,e[1]/255,e[2]/255,this.appearance.opacity/255]}{if(!this.isModifiableBody())return o.getColor("REFERENCE_GEOMETRY_COLOR");const e=(0,c.ek)(this.defaultColorHash,this.colorCycle);return this.appearance?this.appearance.color=new Uint8Array(e.slice(0,3)):r.log.warn("No appearance object associated with BodyMetaData"),(0,u.convertRGBA255ToRGBA)(e)}}isTranslucent(){return null!==this.appearance&&this.appearance.opacity<255}clone(){const e=new S(this.id);return(0,l.overwriteMatchingProperties)(e,this),e.bounds=new u.BoundingBox(this.bounds.getMin(),this.bounds.getMax()),this.referencingOpenCompositeData_&&(e.referencingOpenCompositeData_=new Map(this.referencingOpenCompositeData_)),e}setIsTessellationLoaded(e){this.isTessellationLoaded=e}getIsTessellationLoaded(){return this.consumingClosedCompositeData?this.consumingClosedCompositeData.getIsTessellationLoaded():this.isTessellationLoaded}setLastViewTime(e){this.lastViewTime=e}getLastViewTime(){return this.lastViewTime}setLastViewportOccupancy(e){this.lastViewportOccupancy=e}getLastViewportOccupancy(){return this.lastViewportOccupancy}getType(){return this.type}isSolidBody(){return!this.isComposite&&this.containsOnlySolidBodies()}containsOnlySolidBodies(){return this.type===a.wG2.SOLID}isSheetBody(){return!this.isComposite&&this.containsOnlySheetBodies()}containsOnlySheetBodies(){return this.type===a.wG2.SHEET}isWireBody(){return!this.isComposite&&this.containsOnlyWireBodies()}containsOnlyWireBodies(){return this.type===a.wG2.WIRE}isPointBody(){return!this.isComposite&&this.containsOnlyPointBodies()}containsOnlyPointBodies(){return this.type===a.wG2.POINT}containsMesh(){return this.constituentsContainMesh||a.QsM.containsMesh(this.meshState)}getMeshState(){return this.meshState}getMeshIncrement(){return this.meshIncrement}isModifiableBody(){return this.isModifiable}getBounds(){return this.bounds}resetMeshIncrement(){this.meshIncrement=null}getIsFlattenedSheetMetalBody(){return this.isFlattenedSheetMetalBody}getIsActiveSheetMetal(){return this.isActiveSheetMetal}getIsBendCenterLineBody(){return this.isBendCenterLineBody}isForFlattenedView(){return this.isFlattenedSheetMetalBody||this.isBendCenterLineBody||this.isAssociatedWithFlat}isSubsidiaryBody(){return this.isBendCenterLineBody}getOwnerBodyId(){return this.ownerFlattenedBodyId}get isOpenCompositeBody(){return this.isComposite&&!this.isClosedComposite}get constituentBodyIds(){return this.constituentBodyIds_}removeOpenCompositeBodyReferences(e){if(this.constituentBodyIds_)for(let t=0;t<this.constituentBodyIds_.length;++t){const i=e[this.constituentBodyIds_[t]];i&&i.removeReferencingOpenCompositeBody(this.id)}}updateConstituentBodyIds(e,t){if(this.removeOpenCompositeBodyReferences(t),this.constituentBodyIds_=e,this.constituentBodyIds_&&this.isOpenCompositeBody)for(let e=0;e<this.constituentBodyIds_.length;++e){const i=t[this.constituentBodyIds_[e]];i&&i.addReferencingOpenCompositeBody(this)}}get referencingOpenCompositeData(){return this.referencingOpenCompositeData_}addReferencingOpenCompositeBody(e){this.referencingOpenCompositeData_||(this.referencingOpenCompositeData_=new Map),this.referencingOpenCompositeData_.set(e.id,e)}removeReferencingOpenCompositeBody(e){this.referencingOpenCompositeData_&&this.referencingOpenCompositeData_.delete(e)}get isCompositeConstituent(){return this.isClosedCompositeConstituent||this.hasReferencingOpenCompositeBody}get hasReferencingOpenCompositeBody(){return!!this.referencingOpenCompositeData_&&this.referencingOpenCompositeData_.size>0}get isClosedCompositeConstituent(){return!!this.consumingClosedCompositeData}get closedCompositeParentId(){return this.consumingClosedCompositeData?this.consumingClosedCompositeData.id:null}get isGroupableCompositeBody(){return this.isClosedComposite&&this.type!==a.wG2.UNKNOWN}get isNonGroupingCompositeBody(){return!!this.isComposite&&(!this.isClosedComposite||!this.isGroupableCompositeBody)}get canBeGroupedWithOtherConstituents(){return!!this.consumingClosedCompositeData&&this.consumingClosedCompositeData.isGroupableCompositeBody}get meshGroupId(){return this.canBeGroupedWithOtherConstituents?this.consumingClosedCompositeData.id:this.id}hasFaces(){return this.containsOnlySolidBodies()||this.containsOnlySheetBodies()}hasEdges(){return this.hasFaces()||this.containsOnlyWireBodies()}hasPoints(){return this.hasEdges()||this.containsOnlyPointBodies()}hasTessellationSettings(){return null!==this.getFinestTessellationSettingOnClient()}canEntitiesBeLoaded(){return this.hasTessellationSettings()||this.isWireBody()||this.isClosedComposite&&this.containsOnlyWireBodies()}getFinestTessellationSettingOnClient(){let e=null;for(let t=0;this.tessellationSettings&&t<this.tessellationSettings.length;++t)this.tessellationSettings[t]!==a.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING&&(null===e||this.tessellationSettings[t]>e)&&(e=this.tessellationSettings[t]);return e}getBestAvailableTessellationSettingIndex(e){return e?a.ls1.getTessellationSettingIndexFromEnum(a.XiJ.VERY_FINE):this.bestAvailableTessellationSetting===a.XiJ.AUTO||this.bestAvailableTessellationSetting===a.XiJ.UNKNOWN?null:this.bestAvailableTessellationSetting-1}getTessellationSettingOverride(){return this.tessellationSettingOverride}getChordalTolerance(){const e=this.getFinestTessellationSettingOnClient();return null===e?null:this.getChordalToleranceForSetting(e)}getChordalToleranceForSetting(e){return e<0||e>=g.length?(r.log.warn("Attempt to retrieve chordal tolerance for invalid tessellation setting"),0):this.getBounds().diameter()/2*g[e]}estimateTriangleCountAtSettingIndex(e){return E(this.coarsePlanarFaceTriangleCount,this.coarseTriangleCount,e)}getEstimatedMemoryUsage(e){if(!e&&this.hasTessellationSettings()&&(e=this.tessellationSettings),!e||0===e.length)return 0;let t=0,i=!1;for(let s=0;s<e.length;++s)e[s]!==a.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING&&(t+=this.estimateTriangleCountAtSettingIndex(e[s])*a.ls1.BYTES_PER_TRIANGLE,i=!0);return t+(i?this.totalEntityCount*a.ls1.BYTES_PER_ENTITY:0)}shouldProduceLocalThumbnail(){const e=!this.isOpenCompositeBody;return this.isModifiable&&!this.isClosedCompositeConstituent&&!this.isForFlattenedView()&&(!e||this.hasTessellationSettings())}updateConstituentTypeCounts(e){if(!this.isComposite)return;this.constituentTypeCounts.fill(0);const t=new Set;for(let i=0;i<this.constituentBodyIds_.length;i++){const s=this.constituentBodyIds_[i],n=e.getBodyType(s);n===a.wG2.SOLID?this.constituentTypeCounts[p.PART]++:n===a.wG2.SHEET?this.constituentTypeCounts[p.SURFACE]++:n===a.wG2.WIRE?this.constituentTypeCounts[p.CURVE]++:n===a.wG2.POINT?this.constituentTypeCounts[p.POINT]++:null===n&&e.accumulateSketchIdsFromBodyId(s,t)}this.constituentTypeCounts[p.SKETCH]=t.size}updateDataDerivedFromConstituents(e,t){if(!this.isComposite)return;this.constituentsContainMesh=!1,this.type=null;const i=e=>{null===this.type?this.type=e:this.type!==e&&(this.type=a.wG2.UNKNOWN)};for(let s=0;s<this.constituentBodyIds_.length;++s){const n=this.constituentBodyIds_[s],r=t[n];if(r){this.constituentsContainMesh=this.constituentsContainMesh||a.QsM.containsMesh(r.closedConstituentPartData.meshState),i(r.closedConstituentPartData.bodyType);continue}const o=e[n];o&&(this.constituentsContainMesh=this.constituentsContainMesh||a.QsM.containsMesh(o.meshState),i(o.type))}null===this.type&&(this.type=a.wG2.UNKNOWN)}getConstituentsContainMesh(){return this.constituentsContainMesh}getName(){return this.name}getIsFromSketch(){return this.isSketchBody}}function T(e){return(0,h.dS)(e?e.type:a.wG2.UNKNOWN)}(0,o.s)((function(e,t){const i=t.getBodyId(),s=t.getMeshIncrement();if(!i||!s)return null;const n=new S(i);return n.type=e,n.bounds=s.getBounds(),n}))},53544:function(e,t,i){i.d(t,{BW:function(){return A},EH:function(){return y},QQ:function(){return O},QV:function(){return _},XX:function(){return v},gm:function(){return R},ol:function(){return P},rY:function(){return w},wA:function(){return N}});var s=i(72224),n=i(32435),r=i(93249),a=i(96265),o=i(92230),h=i(63903),c=i(94128),l=i(79275),u=i(41810),d=i(15563),g=i(91275),p=i(56849),m=i(54673),f=i(54861),I=i(78591),E=i(77484);const S=r.default.getManager();let T=1;const M=a.fromValues(1,0,0),C=a.fromValues(0,1,0),D=a.fromValues(0,0,1);class v extends n.T{constructor(e){super(),this.viewer=e,this.dragManipulator=null,this.lockedManipulator=null,this.sequenceId=0,(0,I.viewerCheck)(e)}remove(){this.stopListening(),this.removeGraphicsManipulator()}show(){var e,t;null===(e=this.lockedManipulator)||void 0===e||e.show(),null===(t=this.dragManipulator)||void 0===t||t.show()}hide(){var e,t;null===(e=this.lockedManipulator)||void 0===e||e.hide(),null===(t=this.dragManipulator)||void 0===t||t.hide()}removeGraphicsManipulator(){this.dragManipulator&&(this.dragManipulator.remove(),this.dragManipulator=null),this.lockedManipulator&&(this.lockedManipulator.remove(),this.lockedManipulator=null)}getManipulatorId(){return this.manipulatorData?this.manipulatorData.manipulatorId:""}removeGraphicsManipulatorIfCannotBeDisplayed(){return!(0,I.canPointBeDisplayed)(this.manipulatorData.getDisplayLocation())&&(this.removeGraphicsManipulator(),l.log.info("Did not display feature manipulator(s), likely because it was out of bounds."),!0)}setManipulatorData(e,t){this.manipulatorData=e,this.removeGraphicsManipulatorIfCannotBeDisplayed()||(this.dragManipulator&&this.dragManipulator.isBeingManipulated()?this.updateLockedManipulator():this.updateDragManipulator(t))}updateDragManipulator(e){}updateLockedManipulator(){}sendValue(e,t){this.manipulatorData&&this.trigger(g.jC.VALUE_CHANGED,this.manipulatorData.manipulatorId,e,this.sequenceId,!!t)}onManipulationStarted(){this.sequenceId=T++,this.trigger(g.jC.MANIPULATION_STARTED,this.manipulatorData.manipulatorId,this.sequenceId,this.manipulatorData.primaryParameterId)}onManipulationEnded(){this.lockedManipulator&&(this.lockedManipulator.remove(),this.lockedManipulator=null),this.trigger(g.jC.MANIPULATION_ENDED,this.manipulatorData.manipulatorId,this.sequenceId,this.manipulatorData.primaryParameterId)}sendValueWithNoDrag(e){this.onManipulationStarted(),this.sendValue(e,!0),this.onManipulationEnded()}computeCenterOfOccurrenceBounds(e,t){let i=0,s=a.create();return e.forEach((e=>{const n=u._oC.getOccurrenceFromPathString(e),r=t.getOccurrenceBounds(n);let a=null;r&&r.isFinite()&&(a=r.center(),f.S4.add(a,s,s),++i)})),i<1?null:(i>1&&(s=f.S4.scale(s,1/i)),s)}}class P extends v{constructor(e){super(e),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null,this.cachedBaseOccurrenceTransform=null}isManipulatorInGlobalCoordinateSystem(e){return!e.useCenterOfBoundsOfSourceIds&&(null===e.baseOccurrencePath||0===e.baseOccurrencePath.length)}convertLocalToWorldManipulatorData(e){if(this.isManipulatorInGlobalCoordinateSystem(e))return e;const t=e.clone(),i=(0,E.uQ)();if(!i)return e;const s=i.getModelViewManagers().getManager();if(!s)return e;if(!u._oC.getOccurrenceFromPathString(e.baseOccurrencePath))return e;if(0===e.sourceIds.length)return e;const n=i.getOccurrenceIdManager().getIdForName(e.baseOccurrencePath);if(n===m.Qy)return e;const r=this.viewer.getOccurrenceDataManager().getOccurrenceTransform(n),h=new u.d0F,c=f.w$.toMat3(r,o.create());let l=f.xB.multiplyVec3(c,e.direction.getVec3(),a.create());l=f.S4.normalize(l,a.create()),h.updateFromArray(l),t.direction=h;const d=new u.d0F,g=this.computeCenterOfOccurrenceBounds(e.sourceIds,s);return g&&(d.updateFromArray(g),t.base=d),t}updateManipulatorFromDefinition(e){if(this.manipulatorData){if(e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData))e.updateDefinition(this.manipulatorData.base.getVec3(),this.manipulatorData.direction.getVec3(),this.manipulatorData.getValue().offset);else{const t=this.cachedBaseOccurrenceTransform?this.cachedBaseOccurrenceTransform:this.convertLocalToWorldManipulatorData(this.manipulatorData);if(this.cachedBaseOccurrenceTransform)e.updateDefinition(t.base.getVec3(),t.direction.getVec3(),this.manipulatorData.getValue().offset);else{const i=this.manipulatorData.getValue().offset<0;e.updateDefinitionForLocalManipulatorAtRest(t.base.getVec3(),t.direction.getVec3(),i)}}e.updateLimits(this.manipulatorData.minValue,this.manipulatorData.maxValue)}}setManipulatorData(e){this.manipulatorData=e,this.removeGraphicsManipulatorIfCannotBeDisplayed()||(!this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)&&this.dragManipulator||this.updateDragManipulator(),this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)&&this.dragManipulator&&this.dragManipulator.isBeingManipulated()&&this.updateLockedManipulator())}onManipulationStarted(){super.onManipulationStarted(),this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)||(this.cachedBaseOccurrenceTransform=this.convertLocalToWorldManipulatorData(this.manipulatorData))}onManipulationEnded(){super.onManipulationEnded(),this.cachedBaseOccurrenceTransform&&(this.cachedBaseOccurrenceTransform=null,this.updateManipulatorFromDefinition(this.dragManipulator))}getFlipDirectionWhenNegative(){var e;return(null===(e=this.manipulatorData)||void 0===e?void 0:e.style)!==u.xKD.SIMPLE}updateDragManipulator(){this.dragManipulator||(this.dragManipulator=new I.Linear(this.viewer),this.dragManipulator.setFlipDirectionWhenNegative(this.getFlipDirectionWhenNegative()),this.listenTo(this.dragManipulator,g.Wb.VALUE_CHANGED,this.onManipulatorValueChanged),this.listenTo(this.dragManipulator,g.Wb.VALUE_EDITED,this.onManipulatorValueEdited),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.dragManipulator,g.Wb.CLICKED,this.onManipulatorFlipped)),this.updateManipulatorFromDefinition(this.dragManipulator)}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=new I.Linear(this.viewer),this.lockedManipulator.setFlipDirectionWhenNegative(this.getFlipDirectionWhenNegative()),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}onManipulatorValueChanged(){if(!this.dragManipulator)return;const e=new u.Ygf;e.offset=this.dragManipulator.getOffset(),this.sendValue(e)}onManipulatorValueEdited(){if(!this.dragManipulator)return;const e=new u.Ygf;e.offset=this.dragManipulator.getEditOffset(),this.sendValueWithNoDrag(e)}onManipulatorFlipped(){var e,t;if(!this.dragManipulator)return;const i=-this.manipulatorData.getValue().offset;if(i<this.manipulatorData.minValue||i>this.manipulatorData.maxValue||0===i)return;const s=new u.Ygf;s.offset=i,this.sendValueWithNoDrag(s);const n=null===(e=this.manipulatorData)||void 0===e?void 0:e.getValue();n.offset=-n.offset,(null===(t=this.manipulatorData)||void 0===t?void 0:t.updateClientGraphicsOnFlip)&&this.updateDragManipulator(),this.viewer.doPreHighlightPick()}}class y extends v{constructor(e){super(e),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null,this.cachedManipulatorData=null}setManipulatorData(e){this.manipulatorData=e,this.removeGraphicsManipulatorIfCannotBeDisplayed()||(this.updateDragManipulator(),this.dragManipulator&&this.dragManipulator.isBeingManipulated()&&this.updateLockedManipulator())}isManipulatorInGlobalCoordinateSystem(e){return!e.useCenterOfBoundsOfSourceIds&&(null===e.baseOccurrencePath||0===e.baseOccurrencePath.length)}convertLocalToWorldManipulatorData(e){if(this.isManipulatorInGlobalCoordinateSystem(e))return e;const t=(0,E.uQ)();if(!t)return e;const i=t.getModelViewManagers().getManager();if(!i)return e;if(!u._oC.getOccurrenceFromPathString(e.baseOccurrencePath))return e;if(0===e.sourceIds.length)return e;const s=t.getOccurrenceIdManager().getIdForName(e.baseOccurrencePath);if(s===m.Qy)return e;const n=this.viewer.getOccurrenceDataManager().getOccurrenceTransform(s),r=f.w$.toMat3(n,o.create()),c=e.axisDirection.getVec3(),l=f.xB.multiplyVec3(r,c,a.create());f.S4.normalize(l);const g=e.clone();g.axisDirection.updateFromArray(l);const p=this.computeCenterOfOccurrenceBounds(e.sourceIds,i);if(!p)return e;let I=null,S=f.w$.multiplyVec3(n,e.axisOrigin.getVec3(),a.create());const T=f.S4.subtract(p,S,a.create()),M=(0,d.areUnitVectorsParallel)(f.S4.normalize(T,a.create()),l);if((0,d.arePointsCoincident)(S,p)||M){I=this.getVectorNormalTo(c);const e=.01;f.S4.scale(I,e),I=f.xB.multiplyVec3(r,I,a.create()),g.axisOrigin.updateFromArray(p),S=p}else{const e=a.dot(T,l),t=f.S4.add(S,f.S4.scale(l,e,a.create()));g.axisOrigin.updateFromArray(t),I=f.S4.subtract(p,t,a.create())}if(I){const t=f.Jb.toMat4(f.Jb.fromAngleAxis(-e.getValue().angle,l),h.create());I=f.w$.multiplyVec3(t,I);const i=f.S4.add(I,S,a.create());g.rotationOrigin.updateFromArray(i)}return g}getVectorNormalTo(e){return(0,d.areUnitVectorsParallel)(M,e)?a.clone(C):(0,d.areUnitVectorsParallel)(C,e)?a.clone(D):(0,d.areUnitVectorsParallel)(D,e)?a.clone(M):f.S4.normalize(f.S4.getAPerpendicularVector(e))}updateManipulatorFromDefinition(e){if(this.manipulatorData)if(this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)){const t=f.S4.subtract(this.manipulatorData.rotationOrigin.getVec3(),this.manipulatorData.axisOrigin.getVec3(),a.create()),i=f.S4.length(t);f.S4.normalize(t),e.setId(this.manipulatorData.manipulatorId),e.updateDefinition(this.manipulatorData.axisOrigin.getVec3(),this.manipulatorData.axisDirection.getVec3(),t,i,this.manipulatorData.getValue().angle),e.updateLimits(this.manipulatorData.minValue,this.manipulatorData.maxValue),e.setStyle(this.manipulatorData.style),e.setDisableMinimumOffset(this.manipulatorData.disableMinimumOffset)}else{const t=this.cachedManipulatorData?this.cachedManipulatorData:this.convertLocalToWorldManipulatorData(this.manipulatorData),i=f.S4.subtract(t.rotationOrigin.getVec3(),t.axisOrigin.getVec3(),a.create()),s=f.S4.length(i);f.S4.normalize(i),e.setId(t.manipulatorId),e.updateDefinition(t.axisOrigin.getVec3(),t.axisDirection.getVec3(),i,s,t.getValue().angle),e.updateLimits(t.minValue,t.maxValue),e.setStyle(t.style),e.setDisableMinimumOffset(t.disableMinimumOffset)}}createManipulator(){var e;return(null===(e=this.manipulatorData)||void 0===e?void 0:e.style)===u.xKD.SIMPLE?new I.Angular(this.viewer):new I.AngularWithArrow(this.viewer)}updateDragManipulator(){this.dragManipulator||(this.dragManipulator=this.createManipulator(),this.listenTo(this.dragManipulator,g.Wb.VALUE_CHANGED,this.onManipulatorValueChanged),this.listenTo(this.dragManipulator,g.Wb.VALUE_EDITED,this.onManipulatorValueEdited),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.dragManipulator,g.Wb.CLICKED,this.onManipulatorFlipped)),this.updateManipulatorFromDefinition(this.dragManipulator)}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=this.createManipulator(),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}onManipulationStarted(){super.onManipulationStarted(),this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)||(this.cachedManipulatorData=this.convertLocalToWorldManipulatorData(this.manipulatorData))}onManipulationEnded(){super.onManipulationEnded(),this.cachedManipulatorData&&(this.cachedManipulatorData=null,this.updateManipulatorFromDefinition(this.dragManipulator))}onManipulatorValueChanged(){if(!this.dragManipulator)return;const e=new u.N1L;e.angle=this.dragManipulator.getAngle(),this.sendValue(e)}onManipulatorValueEdited(){if(!this.dragManipulator)return;const e=new u.N1L;e.angle=this.dragManipulator.getAngle(),this.sendValueWithNoDrag(e)}onManipulatorFlipped(){var e;if(!this.dragManipulator||this.manipulatorData.minValue*this.manipulatorData.maxValue>=0)return;const t=new u.N1L;t.angle=-this.manipulatorData.getValue().angle,this.sendValueWithNoDrag(t);const i=this.manipulatorData.getValue();i.angle=-i.angle,(null===(e=this.manipulatorData)||void 0===e?void 0:e.updateClientGraphicsOnFlip)&&this.updateDragManipulator(),this.viewer.doPreHighlightPick()}}class A extends v{constructor(e){super(e),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;let t=this.manipulatorData.direction.getVec3();if(this.manipulatorData.getValue().flipped){const e=this.manipulatorData.otherDirection.getVec3();f.S4.length(e)>0?t=e:f.S4.scale(t,-1)}e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),e.updateDefinition(this.manipulatorData.base.getVec3(),t,0)}updateDragManipulator(){this.dragManipulator||(this.dragManipulator=new I.Linear(this.viewer),this.dragManipulator.setShaftLength(S.getNumber("MANIPULATOR_FLIP_SHAFT_LENGTH_PX")),this.dragManipulator.setIsDraggable(!1),this.listenTo(this.dragManipulator,g.Wb.CLICKED,this.onManipulatorFlipped)),this.updateManipulatorFromDefinition(this.dragManipulator)}updateLockedManipulator(){var e;this.lockedManipulator||(this.lockedManipulator=new I.Linear(this.viewer),this.lockedManipulator.setShaftLength(S.getNumber("MANIPULATOR_FLIP_SHAFT_LENGTH_PX")),null===(e=this.dragManipulator)||void 0===e||e.setIsDraggable(!1),this.lockedManipulator.setFlipDirectionWhenNegative(!0),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}onManipulatorFlipped(){var e,t,i;if(!this.dragManipulator)return;const s=new u.OHR;s.flipped=!(null===(e=this.manipulatorData)||void 0===e?void 0:e.getValue().flipped),this.sendValueWithNoDrag(s);const n=null===(t=this.manipulatorData)||void 0===t?void 0:t.getValue();n.flipped=!(null==n?void 0:n.flipped),(null===(i=this.manipulatorData)||void 0===i?void 0:i.updateClientGraphicsOnFlip)&&this.updateDragManipulator(),this.viewer.doPreHighlightPick()}}class O extends v{constructor(e){super(e),this.manipulatorData=null,this.dragManipulator=null}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;const t=this.manipulatorData.points.map((e=>a.fromValues(e.x,e.y,e.z)));e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),e.updateDefinition(t,new Set([this.manipulatorData.getValue().index]))}updateDragManipulator(){this.dragManipulator||(this.dragManipulator=new I.PointSelection(this.viewer,!1),this.listenTo(this.dragManipulator,g.Wb.VALUE_CHANGED,this.onManipulatorValueChanged)),this.updateManipulatorFromDefinition(this.dragManipulator)}onManipulatorValueChanged(e){const t=new u.DxO;t.index=e.findIndex((e=>e)),this.sendValueWithNoDrag(t)}}class R extends v{constructor(e){super(e),this.manipulatorData=null,this.dragManipulator=null}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;const t=this.manipulatorData.points.map((e=>a.fromValues(e.x,e.y,e.z)));e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style);const i=this.manipulatorData.getValue();e.updateDefinition(t,new Set(null==i?void 0:i.selectedIndices),new Set(this.manipulatorData.suppressedIndices))}updateDragManipulator(e){this.dragManipulator||(this.dragManipulator=new I.PointSelection(this.viewer,!0,e),this.listenTo(this.dragManipulator,g.Wb.VALUE_CHANGED,this.onManipulatorValueChanged)),this.updateManipulatorFromDefinition(this.dragManipulator)}onManipulatorValueChanged(e){const t=new u.kr3;t.selectedIndices=e.reduce(((e,t,i)=>(t&&e.push(i),e)),[]),this.sendValueWithNoDrag(t)}}class w extends v{constructor(e,t){super(t),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null,this.dragStart=e.getValue().offset.getVec3()}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;const t=this.manipulatorData.base,i=this.manipulatorData.getValue().offset,s=h.create();s[12]=i.x+t.x,s[13]=i.y+t.y,s[14]=i.z+t.z,e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),e.updateDefinition(s)}updateDragManipulator(){var e;if(!this.dragManipulator){const e={displayEditView:!1};this.dragManipulator=new I.Triad(this.viewer,g.Ak.DRAG,e),this.dragManipulator.setDisableInactiveComponents(!0),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_START,this.translationStart),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_CHANGE,this.translationChange),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_END,this.translationEnd)}this.dragStart=null===(e=this.manipulatorData)||void 0===e?void 0:e.getValue().offset.getVec3(),this.updateManipulatorFromDefinition(this.dragManipulator)}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=new I.Triad(this.viewer,g.Ak.DRAG),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}translationStart(){this.dragManipulator.isDragging=!0}translationChange(e){if(!this.dragManipulator)return;const t=new u.Kxj;t.offset=new u.d0F,t.offset.x=e[0]+this.dragStart[0],t.offset.y=e[1]+this.dragStart[1],t.offset.z=e[2]+this.dragStart[2],this.sendValue(t)}translationEnd(){this.dragManipulator.isDragging=!1}}class _ extends v{constructor(e,t,i){super(t),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null,this.inferenceController=null,this.baseTransform=null,this.valueTransform=null,this.rotationAxisIndex=null,this.preRepositionTransform=null,this.manipulatorData=e,this.valueTransform=h.clone(e.getValue().transform.getGlMatrix()),this.baseTransform=h.clone(e.base.getGlMatrix()),this.coordinateDisplayFactory=(e,t)=>t.createInferenceDisplay(e),this.inferenceController=new s.ae(i,this.coordinateDisplayFactory,!0,!0,this.viewer,!0),this.listenTo(this.inferenceController,s.lp.MOUSE_ENTER,this.onEnterInference),this.listenTo(this.inferenceController,s.lp.MOUSE_LEAVE,this.onLeaveInference)}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;const t=this.manipulatorData.getValue().transform.getGlMatrix(),i=this.manipulatorData.base.getGlMatrix();e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),e.updateDefinition(h.multiply(h.create(),i,t)),h.equals(i,this.baseTransform)||(this.valueTransform=h.clone(t),this.baseTransform=h.clone(i))}updateDragManipulator(){var e,t,i,s,n;if(!this.dragManipulator){const e={displayEditView:!1};this.dragManipulator=new I.Triad(this.viewer,g.Ak.FULL,e),this.dragManipulator.setDisableInactiveComponents(!0),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_START,this.translationStart),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_CHANGE,this.translationChange),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_END,this.translationEnd),this.listenTo(this.dragManipulator,p.w0.ROTATION_START,this.rotationStart),this.listenTo(this.dragManipulator,p.w0.ROTATION_CHANGE,this.rotationChange),this.listenTo(this.dragManipulator,p.w0.ROTATION_END,this.rotationEnd),this.listenTo(this.dragManipulator,p.w0.REPOSITION_START,this.onTriadRepositionStarted),this.listenTo(this.dragManipulator,p.w0.REPOSITION_END,this.onTriadRepositionEnded)}this.updateManipulatorFromDefinition(this.dragManipulator),this.valueTransform=h.clone(null===(i=null===(t=null===(e=this.manipulatorData)||void 0===e?void 0:e.getValue())||void 0===t?void 0:t.transform)||void 0===i?void 0:i.getGlMatrix()),this.baseTransform=h.clone(null===(n=null===(s=this.manipulatorData)||void 0===s?void 0:s.base)||void 0===n?void 0:n.getGlMatrix())}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=new I.Triad(this.viewer,g.Ak.FULL),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}translationStart(){this.dragManipulator.isDragging=!0}translationChange(e){if(!this.dragManipulator||this.dragManipulator.getIsLocked())return;const t=new u.SP9;t.transform=new u.u8g,t.transform.updateFromGlMatrix(this.valueTransform);const i=c.transformMat4(c.create(),e,h.transpose(h.create(),this.baseTransform));t.transform.m03+=i[0],t.transform.m13+=i[1],t.transform.m23+=i[2],this.sendValue(t)}translationEnd(){this.dragManipulator.isDragging=!1}rotationStart(e,t){this.dragManipulator.isDragging=!0;const i=a.create();i[0]=t[0],i[1]=t[1],i[2]=t[2];const s=h.mul(h.create(),this.baseTransform,this.valueTransform);for(let e=0;e<3;++e){const t=a.create();if(t[0]=s[4*e],t[1]=s[4*e+1],t[2]=s[4*e+2],a.equals(t,i)){this.rotationAxisIndex=e;break}}null===this.rotationAxisIndex&&(this.dragManipulator.isDragging=!1)}rotationChange(e){var t;if(!(null===(t=this.dragManipulator)||void 0===t?void 0:t.isDragging)||this.dragManipulator.getIsLocked())return;let i=h.clone(this.valueTransform);switch(this.rotationAxisIndex){case 0:i=h.rotateX(h.create(),this.valueTransform,e);break;case 1:i=h.rotateY(h.create(),this.valueTransform,e);break;case 2:i=h.rotateZ(h.create(),this.valueTransform,e)}const s=new u.SP9;s.transform=new u.u8g,s.transform.updateFromGlMatrix(i),this.sendValue(s)}rotationEnd(e){this.dragManipulator.isDragging=!1,this.rotationAxisIndex=null}onTriadRepositionStarted(){var e;null===(e=this.inferenceController)||void 0===e||e.startInferencing(),this.preRepositionTransform=h.clone(this.valueTransform)}sendRepositionStartTranform(){if(null===this.preRepositionTransform)return;const e=new u.SP9;e.transform=new u.u8g,e.transform.updateFromGlMatrix(this.preRepositionTransform),this.sendValue(e)}onTriadRepositionEnded(e){var t;null===(t=this.inferenceController)||void 0===t||t.stopInferencing(),this.preRepositionTransform=null}onEnterInference(e){var t;if(!e)return;const i=new u.SP9;i.transform=new u.u8g;const s=e.coordinateSystem.getGlMatrix();i.transform.updateFromGlMatrix(h.mul(h.create(),h.invert(h.create(),this.baseTransform),s)),this.sendValue(i),null===(t=this.dragManipulator)||void 0===t||t.setIsLocked(!0)}onLeaveInference(e){var t;null===(t=this.dragManipulator)||void 0===t||t.setIsLocked(!1),this.sendRepositionStartTranform()}stopInferencing(){var e;null===(e=this.inferenceController)||void 0===e||e.stopInferencing()}}function N(e,t,i){return e instanceof u.EyX?new P(t):e instanceof u.AyX?new y(t):e instanceof u.bD3?new A(t):e instanceof u.CXU?new w(e,t):e instanceof u.Y6l?new O(t):e instanceof u.GR3?new R(t):e instanceof u.nBh?new _(e,t,i):null}},39108:function(e,t,i){var s;i.d(t,{Z:function(){return s}}),function(e){e[e.ONGOING=0]="ONGOING",e[e.COMPLETE=1]="COMPLETE"}(s||(s={}))},44956:function(e,t,i){var s;i.d(t,{I:function(){return s}}),function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INSIDE=1]="INSIDE",e[e.INTERSECTING=2]="INTERSECTING"}(s||(s={}))},67628:function(e,t,i){i.d(t,{Wz:function(){return n},w:function(){return r},xV:function(){return s}});const s="curvatureColorMap",n="curvature-analysis-canvas-controls-preferred-location",r="curvatureAnalysis-canvas-controls"},39303:function(e,t,i){var s;i.d(t,{Q:function(){return s}}),function(e){e.FULL="full",e.INTERACTIVE="interactive",e.MANIPULATING="manipulating"}(s||(s={}))},33293:function(e,t,i){var s;i.d(t,{Po:function(){return n},aU:function(){return r},o2:function(){return s}}),function(e){e.UI="UI",e.RELATED_OCCURRENCE="RELATED_OCCURRENCE",e.RELATED_OCCURRENCE_MATE="RELATED_OCCURRENCE_MATE",e.ACCUMULATED_SMART_SELECTION="ACCUMULATED_SMART_SELECTION",e.SMART_SELECTION="SMART_SELECTION",e.ENTITY="ENTITY",e.UI_RELATED_ENTITY="UI_RELATED_ENTITY",e.FEATURE="FEATURE",e.PART="PART",e.OCCURRENCE="OCCURRENCE",e.OCCURRENCE_COMMENT="OCCURRENCE_COMMENT",e.COMMENT="COMMENT",e.FILTERED_ENTITIES="FILTERED_ENTITIES",e.OCCURRENCE_PRE="OCCURRENCE_PRE",e.PRE="PRE",e.ERROR="ERROR",e.SECONDARY="SECONDARY",e.SECONDARY_PRE="SECONDARY_PRE",e.OCCURRENCE_SECONDARY_PRE="OCCURRENCE_SECONDARY_PRE",e.ASSOCIATED_OCCURRENCE="ASSOCIATED_OCCURRENCE",e.ASSOCIATED_OCCURRENCE_PRE="ASSOCIATED_OCCURRENCE_PRE",e.INCONTEXT_REFERENCE="INCONTEXT_REFERENCE",e.INCONTEXT_REFERENCE_PRE="INCONTEXT_REFERENCE_PRE",e.RETRIEVAL="RETRIEVAL",e.OPERATION_PERSISTENT="OPERATION_PERSISTENT",e.REPAIR="REPAIR",e.REPAIR_HOVER="REPAIR_HOVER"}(s||(s={}));const n=[s.UI,s.ACCUMULATED_SMART_SELECTION,s.SMART_SELECTION,s.ENTITY,s.FEATURE,s.PART,s.OCCURRENCE,s.SECONDARY];var r;!function(e){e[e.REMOVE=0]="REMOVE",e[e.ADD=1]="ADD"}(r||(r={}))},16169:function(e,t,i){var s;i.d(t,{t:function(){return s}}),function(e){e[e.LEFT=1]="LEFT",e[e.MIDDLE=2]="MIDDLE",e[e.RIGHT=3]="RIGHT"}(s||(s={}))},91275:function(e,t,i){var s,n,r;function a(e){return e.isManipulator()}function o(e){return void 0!==e.getAngle}function h(e){return void 0!==e.ray}function c(e){return void 0!==e.origin}function l(e){return void 0!==e.lastMouseRay}i.d(t,{Ak:function(){return s},Kg:function(){return o},Kl:function(){return h},LD:function(){return a},MJ:function(){return l},Wb:function(){return n},jC:function(){return r},xD:function(){return c}}),function(e){e.EXPLODE_CONVENIENCE_MANIPULATOR="explodeConvenienceManipulator",e.DRAG="drag",e.FULL="full",e.PLANE="plane",e.SKETCH="sketch",e.UNKNOWN="unknown"}(s||(s={})),function(e){e.MANIPULATION_STARTED="manipulationstarted",e.MANIPULATION_ENDED="manipulationended",e.VALUE_CHANGED="valuechanged",e.VALUE_EDITED="valueedited",e.CACHE_TRANSFORM="cachetransform",e.CLICKED="clicked",e.DOUBLE_CLICKED="doubleclicked",e.MANIPULATOR_ENTER="enter",e.MANIPULATOR_LEAVE="leave"}(n||(n={})),function(e){e.MANIPULATION_STARTED="manipulationstarted",e.VALUE_CHANGED="valuechanged",e.MANIPULATION_ENDED="manipulationended"}(r||(r={}))},47851:function(e,t,i){i.d(t,{G2:function(){return a},X5:function(){return n},ZB:function(){return r},s_:function(){return s}});const s="sectionPlaneSelection";let n=!1;function r(){n=!0}function a(){n=!1}},91334:function(e,t,i){i.d(t,{I:function(){return n},S:function(){return s}});const s="simulationColorMap",n="sim-canvas-controls"},37739:function(e,t,i){i.d(t,{LI:function(){return n},_s:function(){return r},d0:function(){return s}});const s="thicknessColorMap",n="thickness-analysis-canvas-controls-panel",r="thicknessAnalysis-canvas-controls"},56849:function(e,t,i){var s,n,r;i.d(t,{tF:function(){return r},vn:function(){return n},w0:function(){return s}}),function(e){e.REPOSITION_START="repositionStart",e.REPOSITION="reposition",e.REPOSITION_END="repositionEnd",e.ROTATION_START="rotationStart",e.ROTATION_CHANGE="rotationChange",e.ROTATION_END="rotationEnd",e.ROTATION_EDIT="rotationEdit",e.TRANSLATION_START="translationStart",e.TRANSLATION_CHANGE="translationChange",e.TRANSLATION_END="translationEnd",e.TRANSLATION_EDIT="translationEdit",e.SCALING_START="scalingStart",e.SCALING_CHANGE="scalingChange",e.SCALING_END="scalingEnd",e.SCALING_EDIT="scalingEdit",e.COMMAND="componentCommand",e.ENTER_INFERENCE="enterInference",e.LEAVE_INFERENCE="leaveInference",e.DOUBLE_CLICKED="doubleClicked"}(s||(s={})),function(e){e.X_ROTATION="TRIAD_X_ROTATION",e.Y_ROTATION="TRIAD_Y_ROTATION",e.Z_ROTATION="TRIAD_Z_ROTATION",e.X_DIRECTION="TRIAD_X_DIRECTION",e.Y_DIRECTION="TRIAD_Y_DIRECTION",e.Z_DIRECTION="TRIAD_Z_DIRECTION",e.XY_PLANE="TRIAD_XY_PLANE",e.XZ_PLANE="TRIAD_XZ_PLANE",e.YZ_PLANE="TRIAD_YZ_PLANE",e.FREE_DRAG="TRIAD_FREE_DRAG",e.SCALING="SCALING"}(n||(n={})),function(e){e[e.Origin=0]="Origin",e[e.X=1]="X",e[e.Y=2]="Y",e[e.Z=3]="Z"}(r||(r={}))},26564:function(e,t,i){function s(e){return e&&e.getId&&"image"===e.getId()}i.d(t,{AW:function(){return r},Eg:function(){return s},Wf:function(){return n}});class n{constructor(e,t,i,s,n,r,a,o,h){this.deterministicId=e,this.secondDeterministicId=t,this.occurrence=i,this.inferenceType=s,this.coordinateSystem=n,this.sourceIsFeature=r,this.meshPointData=null,this.isInContextEntity=!!a,this.isPartStudioMateConnector=!!o,this.isInstanceOrigin=!!h}}const r="clicked"},11365:function(e,t,i){var s;i.d(t,{k:function(){return s}}),function(e){e.NONE="none",e.ROTATE="rotate",e.AXIS_ROTATE="axisRotate",e.PAN="pan",e.ZOOM="zoom"}(s||(s={}))},76247:function(e,t,i){var s;i.d(t,{C:function(){return s}}),function(e){e.DEFAULT="default",e.CROSSHAIR="url(/images/crosshair-cursor.svg) 7.5 7.5,crosshair",e.HAND="hand",e.GRAB="grab",e.GRABBING="grabbing",e.POINTER="pointer",e.ZOOM_IN="zoom-in",e.MOVE="move",e.TEXT="text",e.WAIT="wait",e.HELP="help",e.N_RESIZE="n-resize",e.NE_RESIZE="ne-resize",e.NS_RESIZE="ns-resize",e.E_RESIZE="e-resize",e.EW_RESIZE="ew-resize",e.SE_RESIZE="se-resize",e.S_RESIZE="s-resize",e.SW_RESIZE="sw-resize",e.W_RESIZE="w-resize",e.NW_RESIZE="nw-resize",e.PROGRESS="progress",e.NOT_ALLOWED="not-allowed",e.NO_DROP="no-drop",e.VERTICAL_TEXT="vertical-text",e.ALL_SCROLL="all-scroll",e.COL_RESIZE="col-resize",e.ROW_RESIZE="row-resize",e.SNAPMATE_GENERIC="url(/images/cursors/macSnapMate_Cursor.svg) 7.5 7.5,url(/images/cursors/SnapMate_Cursor.png) 7.5 7.5,nesw-resize",e.CONFIRMATION_GENERIC="url(/images/cursors/macConfirmation_Cursor.svg) 1 1,url(/images/cursors/Confirmation_Cursor.png) 1 1,default",e.SNAPMATE_WINDOWS="url(/images/cursors/winSnapMate_Cursor.svg) 7.5 7.5,url(/images/cursors/SnapMate_Cursor.png) 7.5 7.5,nesw-resize",e.CONFIRMATION_WINDOWS="url(/images/cursors/winConfirmation_Cursor.svg) 1 1,url(/images/cursors/Confirmation_Cursor.png) 1 1,default"}(s||(s={}))},10700:function(e,t,i){var s;i.d(t,{$:function(){return s}}),function(e){e.VR="immersive-vr",e.AR="immersive-ar"}(s||(s={}))},64022:function(e,t,i){var s;i.d(t,{L:function(){return s}}),function(e){e[e.BASE=0]="BASE",e[e.PREVIEW=1]="PREVIEW"}(s||(s={}))},85075:function(e,t,i){var s;i.d(t,{N:function(){return s}}),function(e){e.MINIMUM_RADIUS="minimum_radius",e.CURVATURE_COMBS="show_curvature",e.INFLECTION_POINTS="inflection_points",e.U_CURVES="u_curves",e.V_CURVES="v_curves",e.CROSS_FACE="cross_face",e.CPT_GRIDS="control_point_grids"}(s||(s={}))},99548:function(e,t,i){var s;i.d(t,{K:function(){return s},Y:function(){return n}}),function(e){e[e.EDGE_U=0]="EDGE_U",e[e.FACE_U=1]="FACE_U",e[e.FACE_V=2]="FACE_V"}(s||(s={}));class n{constructor(e,t){this.curvatureType=e,this.curvatureData=t}isEdgeCurvature(){return this.curvatureType===s.EDGE_U}isFaceUCurve(){return this.curvatureType===s.FACE_U}isFaceVCurve(){return this.curvatureType===s.FACE_V}isFaceCurvature(){return this.isFaceUCurve()||this.isFaceVCurve()}}},61090:function(e,t,i){i.d(t,{$_:function(){return S},A1:function(){return Ye},AD:function(){return x},Aw:function(){return $e},CD:function(){return H},CJ:function(){return ae},Cg:function(){return ye},Cr:function(){return ce},Cv:function(){return We},F5:function(){return de},FM:function(){return d},Fc:function(){return Te},GO:function(){return it},Gf:function(){return et},Hq:function(){return we},Hv:function(){return m},Ip:function(){return Be},JF:function(){return U},JH:function(){return Ze},Jm:function(){return Le},Jp:function(){return Oe},KB:function(){return at},KO:function(){return pe},LA:function(){return Y},M1:function(){return ge},Mp:function(){return rt},NM:function(){return b},Nf:function(){return Je},Nw:function(){return Ke},P1:function(){return J},PX:function(){return xe},Q6:function(){return v},Qe:function(){return Pe},R1:function(){return tt},RV:function(){return Ce},Sr:function(){return le},Sz:function(){return se},T$:function(){return oe},TN:function(){return Me},Uj:function(){return Re},V1:function(){return Se},Vp:function(){return D},W2:function(){return G},WB:function(){return ke},WY:function(){return Z},Wp:function(){return M},Xc:function(){return ve},YW:function(){return Ge},_h:function(){return B},a:function(){return L},aI:function(){return ze},ad:function(){return z},am:function(){return Ae},b3:function(){return ie},b9:function(){return f},bh:function(){return me},bs:function(){return F},cW:function(){return _},cp:function(){return C},cu:function(){return P},cy:function(){return W},d:function(){return Ue},dP:function(){return A},eR:function(){return g},f4:function(){return nt},fd:function(){return qe},fu:function(){return fe},gV:function(){return De},gW:function(){return Qe},h0:function(){return ee},hj:function(){return q},iH:function(){return je},ib:function(){return Xe},kl:function(){return Ee},m2:function(){return _e},nh:function(){return Ne},oG:function(){return $},oL:function(){return re},ox:function(){return j},pB:function(){return c},pF:function(){return T},pK:function(){return y},pO:function(){return N},pU:function(){return K},pj:function(){return Fe},rw:function(){return ne},sJ:function(){return k},sd:function(){return te},so:function(){return w},t0:function(){return X},tS:function(){return Ie},u:function(){return O},u5:function(){return Q},u9:function(){return I},uv:function(){return E},v9:function(){return ot},vk:function(){return He},vu:function(){return Ve},wf:function(){return V},xA:function(){return u},xy:function(){return be},yB:function(){return R},ye:function(){return he},zK:function(){return ue},zT:function(){return p},zi:function(){return st}});var s=i(77484),n=i(32435),r=i(22738),a=i(48820),o=i(33745),h=i(7366);class c extends n.T{constructor(){super()}}let l=new c;function u(){if(s.uQ){const e=(0,s.uQ)();if(e)return e.getEventDispatcher()}return l}function d(e,t){t&&(t.setEventDispatcher(l),l=new c),e&&!t&&(l=e.getEventDispatcher(),e.setEventDispatcher(new c))}function g(e){return(0,r.R)((function(t){return u().on(e,t)}),(function(t){return u().off(e,t)}),(function(e){return arguments}))}const p="ACTIVE_VIEWER_SET",m="VIEW_WILL_DRAW",f="VIEW_WILL_PICK",I="VIEW_DID_DRAW",E="ASSEMBLY_TIMES",S="PART_STUDIO_TIMES",T="EVENT_NEEDS_ANGULAR_BROADCAST",M="ELEMENT_GRAPHICS_LOADING",C="ELEMENT_VIEW_INITIALIZED",D="ELEMENT_PREVIEW_GRAPHICS_LOADED",v="DIMENSION_TEXT_SINGLE_CLICKED",P="DIMENSION_TEXT_DOUBLE_CLICKED",y="DIMENSION_EDIT_CLOSED",A="CLOSE_DIMENSION_EDIT",O="DIMENSION_DELETE_REQUEST",R="SHOW_DIMENSION_EXPRESSIONS_CHANGED",w="SESSION_ENDED",_="GL_CONTEXT_LOST",N="GL_CONTEXT_RESTORED",b="SELECT_OTHER",L="SELECT_OTHER_REVERSE",F="SHOW_SMART_SELECTION",x="CLOSE_SELECT_OTHER",B="SHOW_SKETCH_TEXT",U="SKETCH_COMMAND_ACTIVATED",V="CLOSE_SKETCH_SUB_DIALOG",G="NEW_PART_LIST",H="NON_TRIVIAL_PART_STUDIO_DATA_PROCESSED",k="PART_STUDIO_PART_VISIBILITY_CHANGED",W="PART_STUDIO_DATA_AND_SELECTION_REMAP_PROCESSED",z="DISPLAYED_PART_STUDIO",X="DISPLAYED_ASSEMBLY",q="ASSEMBLY_DATA_PROCESSED",Z="DIMENSION_VALUE_CHANGED",Y="BODIES_LOADED",K="CANVAS_CLICK",j="CANVAS_MOUSEENTER",Q="CANVAS_MOUSELEAVE",$="CANVAS_MOUSEMOVE",J="CHANGE_FEATURE_APPEARANCE",ee="CHANGE_VIEW",te="GRAPHICS_HANDLED_CLICK_EVENT",ie="DEVICE_PIXEL_RATIO_CHANGED",se="SELECTION_REJECTED",ne="CLOSE_MATE_DOF_CHOOSER",re="VIEW_CONTAINER_MENU_INVOKED",ae="ANALYSIS_MENU_INVOKED",oe="CREATE_SECTION_PLANE_INFERENCE_CONTROLLER",he="DESTROY_SECTION_PLANE_INFERENCE_CONTROLLER",ce="DEFAULT_UNITS_CHANGED",le="SECTION_PLANE_ADDED",ue="SECTION_PLANE_REMOVED",de="MAXIMUM_NUMBER_OF_SECTION_PLANES_REACHED",ge="SECTION_VIEW_DIALOG_OPENED",pe="SECTION_VIEW_DIALOG_CLOSED",me="UPDATE_INCONTEXT_ISOLATION",fe="UI_ELEMENT_CLICK",Ie="VIEWER_CANVAS_ATTACHED_TO_CONTAINER",Ee="ASSEMBLY_ANIMATE_MATE_STARTED",Se="ASSEMBLY_ANIMATE_MATE_ENDED",Te="SPACEMOUSE_ACTION_SET_CHANGED",Me="SPACEMOUSE_COMMANDS_RECEIVED",Ce="SPACEMOUSE_COMMAND",De="WILL_RENDER_THUMBNAILS",ve="DID_RENDER_THUMBNAILS",Pe="RETRIEVE_OCCURRENCE_DISPLAY_DATA",ye="RETRIEVE_ELEMENT_DISPLAY_DATA",Ae="ADD_TEMPORARY_TESSELLATION_OVERRIDE",Oe="CLEAR_TEMPORARY_TESSELLATION_OVERRIDES",Re="RETRIEVE_SMOOTH_EDGE_INFORMATION",we="ACTIVE_SHEETMETAL_MODEL_CHANGED",_e="BEFORE_PRINT_IMAGE_GENERATION",Ne="AFTER_PRINT_IMAGE_GENERATION",be="SIMULATION_MINIMUM_CLICKED",Le="SIMULATION_MAXIMUM_CLICKED",Fe="SIMULATION_RANGE_CHANGED",xe="SIMULATION_LEGEND_OPENED",Be="SIMULATION_LEGEND_CLOSED",Ue="THICKNESS_ANALYSIS_COLOR_MAPPING_CHANGED",Ve="THICKNESS_ANALYSIS_DISPLAYED_FIELD_CHANGED",Ge="THICKNESS_ANALYSIS_MINIMUM_CLICKED",He="THICKNESS_ANALYSIS_MAXIMUM_CLICKED",ke="THICKNESS_ANALYSIS_RANGE_CHANGED",We="THICKNESS_ANALYSIS_LEGEND_OPENED",ze="THICKNESS_ANALYSIS_LEGEND_CLOSED",Xe="CURVATURE_ANALYSIS_LEGEND_MINIMUM_CLICKED",qe="CURVATURE_ANALYSIS_LEGEND_MAXIMUM_CLICKED",Ze="CURVATURE_ANALYSIS_RANGE_CHANGED",Ye="CURVATURE_ANALYSIS_LEGEND_OPENED",Ke="CURVATURE_ANALYSIS_LEGEND_CLOSED",je="CURVATURE_ANALYSIS_COLOR_MAPPING_CHANGED",Qe="CURVATURE_ANALYSIS_CURVATURE_CONTROL_CHANGED",$e="FOLLOW_MODE_LEADER_MOUSE_MOVED",Je="FOLLOW_MODE_LEADER_MOUSE_OUT",et="FOLLOW_MODE_DEACTIVATED",tt="SIMULATION_RESULTS_DISPLAYED",it="SIMULATION_CONNECTIONS_DISPLAYED",st="NAMED_VIEW_APPLIED",nt="PICKS_BOX_SELECTED",rt="PICK_CONSTRAINT_SELECTED",at="BOX_SELECTION_FINISHED";function ot(){const e=g(z).pipe((0,a.h)((e=>e[1]))),t=g(X).pipe((0,a.h)((e=>e[1])));return e.pipe((0,o.b)(t),(0,h.q)(1))}},65464:function(e,t,i){i.d(t,{JE:function(){return n},U2:function(){return h},UQ:function(){return g},_6:function(){return o},c2:function(){return p},lm:function(){return a},nD:function(){return u},qR:function(){return l},rp:function(){return d},s:function(){return m},si:function(){return c},vN:function(){return r}});var s=i(28817);const n=[],r=0,a=[1];var o,h;!function(e){e[e.DEFAULT=32]="DEFAULT",e[e.ENTITY=20]="ENTITY",e[e.OCCURRENCE_SLICE=12]="OCCURRENCE_SLICE",e[e.OCCURRENCE_ID=24]="OCCURRENCE_ID",e[e.HIGHLIGHT=16]="HIGHLIGHT"}(o||(o={})),function(e){e[e.ENTITY=1048575]="ENTITY",e[e.OCCURRENCE_SLICE=4095]="OCCURRENCE_SLICE"}(h||(h={}));class c{constructor(e){this.freeIds=[],this.nextId=a.slice(0);const t=e||o.DEFAULT;this.maximumElementSize=Math.pow(2,t)-1}clone(){const e=new c;return e.nextId=this.nextId.slice(0),e.freeIds=this.freeIds.slice(0),e.maximumElementSize=this.maximumElementSize,e}reset(){this.nextId=a.slice(0),this.freeIds=[]}getId(){if(this.freeIds.length>1)return this.freeIds.pop();const e=this.nextId.slice(0);let t,i=!1;for(t=0;t<this.nextId.length;++t)if(this.nextId[t]<this.maximumElementSize){this.nextId[t]=this.nextId[t]+1;for(let e=0;e<t;++e)this.nextId[e]=1;i=!0;break}if(!i){for(t=0;t<this.nextId.length;++t)this.nextId[t]=1;this.nextId.push(1)}return e}freeId(e){d(e)&&this.freeIds.push(e)}}function l(e){return e}function u(e,t){return(0,s.arraysEqual)(e,t)}function d(e){if(!e||e.length<1)return!1;for(let t=0;t<e.length;++t)if(e[t]===r)return!1;return!0}function g(e){const t=e.split(","),i=[];for(let e=0;e<t.length;e++)i.push(+t[e]);return i}const p=0;class m{constructor(e){this.freeIds=[],this.nextId=1;const t=e||o.DEFAULT;this.maximumNumberSize=Math.pow(2,t)-1}reset(){this.nextId=1,this.freeIds=[]}getId(){if(this.freeIds.length>1)return this.freeIds.pop();if(this.nextId===p)return p;const e=this.nextId++;return this.nextId>=this.maximumNumberSize&&(this.nextId=p),e}isIdValid(e){return e!==p}freeId(e){this.isIdValid(e)&&this.freeIds.push(e)}}},28784:function(e,t,i){i.d(t,{HqE:function(){return n.Hq},zTe:function(){return n.zT},am2:function(){return n.am},nhj:function(){return n.nh},V11:function(){return n.V1},klk:function(){return n.kl},hjy:function(){return n.hj},uvd:function(){return n.uv},aUM:function(){return T.aU},ZK6:function(){return r.Z},m2d:function(){return n.m2},KB0:function(){return n.KB},AWD:function(){return _.AW},LgS:function(){return F.L},pUS:function(){return n.pU},oxn:function(){return n.ox},u5l:function(){return n.u5},oGi:function(){return n.oG},P1w:function(){return n.P1},h02:function(){return n.h0},JpA:function(){return n.Jp},dPN:function(){return n.dP},rwQ:function(){return n.rw},AD7:function(){return n.AD},wfd:function(){return n.wf},T$E:function(){return n.T$},Wzm:function(){return P.Wz},wao:function(){return P.w},iHz:function(){return n.iH},gWk:function(){return n.gW},Nwl:function(){return n.Nw},fdd:function(){return n.fd},ibh:function(){return n.ib},A1q:function(){return n.A1},JHq:function(){return n.JH},xV6:function(){return P.xV},CF9:function(){return b.C},CrY:function(){return n.Cr},ye3:function(){return n.ye},b3:function(){return n.b3},Xc0:function(){return n.Xc},uav:function(){return n.u},pKY:function(){return n.pK},cu9:function(){return n.cu},Q6T:function(){return n.Q6},WYs:function(){return n.WY},t0J:function(){return n.t0},adC:function(){return n.ad},FZj:function(){return o},Wp_:function(){return n.Wp},Vpt:function(){return n.Vp},cpE:function(){return n.cp},pFt:function(){return n.pF},Gfg:function(){return n.Gf},Awy:function(){return n.Aw},NfU:function(){return n.Nf},QpP:function(){return E.Q},cWC:function(){return n.cW},pOz:function(){return n.pO},sdI:function(){return n.sd},Rng:function(){return s},$Ky:function(){return V.$K},o2L:function(){return T.o2},JE9:function(){return U.JE},Qyk:function(){return B.Qy},UKE:function(){return v},siw:function(){return U.si},_6$:function(){return U._6},Wfq:function(){return _.Wf},IiW:function(){return a.I},i8U:function(){return I},lLv:function(){return V.lL},F59:function(){return n.F5},kJR:function(){return N.k},tcH:function(){return M.t},ziX:function(){return n.zi},W2m:function(){return n.W2},CDm:function(){return n.CD},EBu:function(){return x.E},M81:function(){return S},sJs:function(){return n.sJ},$_3:function(){return n.$_},f4Y:function(){return n.f4},Mpj:function(){return n.Mp},Cgl:function(){return n.Cg},Qeo:function(){return n.Qe},Uj6:function(){return n.Uj},s_Y:function(){return y.s_},Srw:function(){return n.Sr},zKA:function(){return n.zK},KOV:function(){return n.KO},M1t:function(){return n.M1},SzR:function(){return n.Sz},NMw:function(){return n.NM},aat:function(){return n.a},_hB:function(){return n._h},bsB:function(){return n.bs},GOH:function(){return n.GO},Ipz:function(){return n.Ip},PXv:function(){return n.PX},Jml:function(){return n.Jm},xy2:function(){return n.xy},pjn:function(){return n.pj},R1N:function(){return n.R1},JFj:function(){return n.JF},TN9:function(){return n.TN},vjd:function(){return A},LIN:function(){return w.LI},_s_:function(){return w._s},daY:function(){return n.d},vu3:function(){return n.vu},aIt:function(){return n.aI},CvC:function(){return n.Cv},vkO:function(){return n.vk},YWe:function(){return n.YW},WBF:function(){return n.WB},d07:function(){return w.d0},bhj:function(){return n.bh},tSV:function(){return n.tS},oLC:function(){return n.oL},u9p:function(){return n.u9},Hvz:function(){return n.Hv},gV9:function(){return n.gV},dPT:function(){return O},qT7:function(){return R},$Xk:function(){return L.$},ZBF:function(){return y.ZB},G29:function(){return y.G2},uQB:function(){return H.uQ},xA2:function(){return n.xA},IOg:function(){return H.IO},v93:function(){return n.v9},N9r:function(){return H.N9},eRd:function(){return n.eR},PoX:function(){return T.Po},rp5:function(){return U.rp},nD6:function(){return U.nD},jeL:function(){return c},jep:function(){return l},uAu:function(){return p},rxY:function(){return f},Yn_:function(){return u},vMe:function(){return h},Xc1:function(){return d},Egl:function(){return _.Eg},nYd:function(){return g},wLR:function(){return D},DAH:function(){return m},tYI:function(){return G.t},Ykz:function(){return H.Yk}});var s,n=i(61090);!function(e){e[e.NORMAL=0]="NORMAL",e[e.AGGRESSIVE_USER_CAUSED=1]="AGGRESSIVE_USER_CAUSED"}(s||(s={}));var r=i(39108),a=i(44956);class o{constructor(){this.ignoreSpaceParameters=!1,this.displayLimitRangeText=!0,this.displayLimitRangeTicks=!1,this.textReadOnly=!1,this.textPrefix=""}}function h(e){return e&&e.isDimension()}function c(e){return e&&"AngularDimension"===e.getId()}function l(e){return e&&"ArcLengthDimension"===e.getId()}function u(e){return e&&"CurveLengthDimension"===e.getId()}function d(e){return e&&"EllipseDiameterDimension"===e.getId()}function g(e){return e&&"LinearDimension"===e.getId()}function p(e){return e&&"CenterlineDimension"===e.getId()}function m(e){return e&&"RadialDimension"===e.getId()}function f(e){return e&&"CountDimension"===e.getId()}const I=function(e){return e.isEdge()&&!e.isInternalEdge()&&e.isFromBody()&&!e.isFromWireBody()};var E=i(39303);const S=.3;var T=i(33293),M=i(16169),C=i(41810);function D(e){return e&&e.getElementType()===C.GNh.PARTSTUDIO}var v,P=i(67628),y=i(47851);!function(e){e[e.NOT_SELECTED=0]="NOT_SELECTED",e[e.PREHILITE=1]="PREHILITE",e[e.SELECTED=2]="SELECTED",e[e.MUTED=3]="MUTED"}(v||(v={}));class A{constructor(){this.lowerLeft=null,this.lowerRight=null,this.upperLeft=null,this.pixelSize=1}}var O,R,w=i(37739),_=i(26564),N=i(11365),b=i(76247),L=i(10700);!function(e){e[e.DOMINANT=0]="DOMINANT",e[e.NON_DOMINANT=1]="NON_DOMINANT"}(O||(O={})),function(e){e[e.TRIGGER=0]="TRIGGER",e[e.SQUEEZE=1]="SQUEEZE",e[e.TOUCH_PAD_PRESS=2]="TOUCH_PAD_PRESS",e[e.THUMBSTICK_PRESS=3]="THUMBSTICK_PRESS",e[e.A=4]="A",e[e.B=5]="B"}(R||(R={}));var F=i(64022),x=i(78769),B=i(54673),U=i(65464),V=(i(34132),i(91755)),G=i(29443),H=i(77484)},78769:function(e,t,i){i.d(t,{E:function(){return r}});var s=i(41622),n=i(28784);class r{constructor(e){this.nameToId={},this.idToName={},this.idManager=new n.siw(e)}reset(){this.nameToId={},this.idToName={},this.idManager.reset()}clone(){const e=new r;return e.nameToId=(0,s.Z)(this.nameToId),e.idToName=(0,s.Z)(this.idToName),e.idManager=this.idManager.clone(),e}getOrCreateIdForName(e){let t=this.nameToId[e];return t||(t=this.idManager.getId(),this.nameToId[e]=t,this.idToName[t]=e),t}getIdForName(e){const t=this.nameToId[e];return t||n.JE9}getNameForId(e){const t=this.idToName[e];return t||null}removeName(e){const t=this.nameToId[e];t&&(this.idManager.freeId(t),delete this.nameToId[e],delete this.idToName[t])}}},54673:function(e,t,i){i.d(t,{$J:function(){return d},KF:function(){return c},QC:function(){return h},Qy:function(){return o},yx:function(){return u}});var s=i(77484),n=i(65464),r=i(78769),a=i(79275);const o=-1,h=0,c=0,l=1<<n._6.OCCURRENCE_SLICE;class u{constructor(e){this.viewer=e,(0,s.Yk)(e),this.namedIdManager=new r.E(n._6.OCCURRENCE_ID)}reset(){this.namedIdManager.reset()}convertToOccurrenceId(e){if(!(0,n.rp)(e))return o;if(e.length>1)return a.log.warn("More than the allowed number of occurrences have been allocated"),o;let t=e[0],i=1;for(;t>=l;)++i,t/=l;return this.viewer.notifyOfPickPassCount(i),e[0]}getOrCreateIdForName(e){return this.convertToOccurrenceId(this.namedIdManager.getOrCreateIdForName(e))}getIdForName(e){return this.convertToOccurrenceId(this.namedIdManager.getIdForName(e))}getNameForId(e){return this.namedIdManager.getNameForId([e])}removeName(e){this.namedIdManager.removeName(e)}}function d(e){return null!=e&&e!==o}},78077:function(e,t,i){var s;i.d(t,{E1:function(){return r},JB:function(){return a},MX:function(){return s},ip:function(){return n}}),function(e){e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.INFINITE_LINES=2]="INFINITE_LINES",e[e.TRIANGLES=3]="TRIANGLES",e[e.TRIANGLE_STRIP=4]="TRIANGLE_STRIP",e[e.SILHOUETTES=5]="SILHOUETTES",e[e.COUNT=6]="COUNT",e[e.PRIMITIVE_UNKNOWN=-1]="PRIMITIVE_UNKNOWN"}(s||(s={}));const n=Math.ceil(Math.log(s.COUNT)/Math.log(2));function r(e){switch(e){case s.POINTS:return"POINTS";case s.LINES:return"LINES";case s.INFINITE_LINES:return"INFINITE_LINES";case s.TRIANGLES:return"TRIANGLES";case s.TRIANGLE_STRIP:return"TRIANGLE_STRIP";case s.SILHOUETTES:return"SILHOUETTES";default:return"PRIMITIVE_UNKNOWN"}}function a(e){switch(e){case s.POINTS:return s.POINTS;case s.LINES:return s.LINES;case s.INFINITE_LINES:return s.INFINITE_LINES;case s.TRIANGLES:return s.TRIANGLES;case s.TRIANGLE_STRIP:return s.TRIANGLE_STRIP;case s.SILHOUETTES:return s.SILHOUETTES}return s.PRIMITIVE_UNKNOWN}},34132:function(e,t,i){i.d(t,{HN:function(){return l},Vp:function(){return c},Xd:function(){return h},oA:function(){return s}});var s,n=i(10867);!function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.AUTO=2]="AUTO"}(s||(s={}));let r,a=s.AUTO,o=null;function h(e){switch(a=e,a){case s.OFF:(0,n.Ko)(!0);break;case s.ON:(0,n.Ko)(!1);break;case s.AUTO:l()}}function c(e){o=e,l()}function l(){if(a!==s.AUTO)return;let e=(void 0===r&&(r=navigator.platform.indexOf("Mac")>-1),!r);const t=new RegExp(".*intel.*","i");o&&t.test(o.glRenderer)&&(e=!0),(0,n.Ko)(e)}l()},91755:function(e,t,i){i.d(t,{$K:function(){return a},EG:function(){return r},Jh:function(){return o},Vv:function(){return n},lL:function(){return s}});const s="mainSceneGraph",n="previewSceneGraph",r="hudSceneGraph",a="hudModelSceneGraph",o="inferencePickerSceneGraph"},54124:function(e,t,i){i.d(t,{kW:function(){return s},qn:function(){return o},xv:function(){return r}});var s,n=i(65583);!function(e){e.UPDATES="counter updates",e.DRAW_CALLS="draw calls",e.TRIANGLES="triangles",e.LINES="lines",e.POINTS="points"}(s||(s={}));class r{constructor(){this.countersSubject=new n.x,this.counters={}}increment(e,t){void 0===t&&(t=1);let i=this.counters[e];i||(i=0),this.counters[e]=i+t}resetCounters(){this.counters={}}updateModel(){this.increment(s.UPDATES),this.countersSubject.next(this.counters)}get countersObservable(){return this.countersSubject.asObservable()}}const a=new r;function o(){return a}},29443:function(e,t,i){i.d(t,{t:function(){return o}});var s=i(34132),n=i(77484);class r{constructor(){this.retinaDisplaySetting=s.oA.AUTO}getRetinaDisplaySetting(){return this.retinaDisplaySetting}setRetinaDisplaySetting(e){this.retinaDisplaySetting=e,(0,s.Xd)(this.retinaDisplaySetting),(0,n.uQ)().requestDraw()}setUserWebPreference(e){const t=s.oA[e.retinaDisplaySetting];this.setRetinaDisplaySetting(t)}}let a=null;function o(){return a||(a=new r),a}},77484:function(e,t,i){i.d(t,{IO:function(){return l},KO:function(){return o},N9:function(){return u},Yk:function(){return d},e$:function(){return h},uQ:function(){return c}});var s=i(79275),n=i(61090);let r=null,a=null;function o(e){a=e,a?a.getPrimaryViewController()&&(null==r?void 0:r.getPrimaryViewController())&&(a.getPrimaryViewController().forcedManipulationMode=r.getPrimaryViewController().forcedManipulationMode):a=r}function h(e){(0,n.FM)(r,e),r&&e&&s.log.warn("A second viewer was set to be active before the first was deactivated."),r=e,o(e)}function c(){return r}function l(){const e=c();return e?e.getModelViewManagers():null}function u(){return a}function d(e){return!!e||(s.log.warn("viewer is null or undefined"),!1)}},54861:function(e,t,i){i.d(t,{Jb:function(){return c},S4:function(){return n},cD:function(){return a},gv:function(){return s},jA:function(){return r},w$:function(){return h},xB:function(){return o}});var s,n,r,a,o,h,c,l=i(80675),u=i(96265),d=i(94128),g=i(63903),p=i(33804),m=i(92230),f=i(37603),I=i(37754);function E(e){return(t,i,s)=>(s||(s=t),e(s,t,i))}function S(e){return t=>e(t)}function T(e){return(t,i,s)=>(s||(s=t),e(s,t,i))}function M(e){return(t,i)=>e(t,i)}function C(e){return(t,i)=>(i||(i=t),e(i,t))}function D(e){return(t,i)=>(i||(i=t),e(i,t))}function v(e){return(t,i)=>e(t,i)}function P(e){return(t,i)=>e(i,t)}function y(e){return(t,i)=>e(t,i)}function A(e){return(t,i,s)=>(s||(s=i),e(s,i,t))}function O(e){return(t,i)=>(i||(i=t),e(i,t))}function R(e){return(t,i,s)=>(s||(s=t),e(s,t,i))}function w(e){return(t,i,s)=>(s||(s=t),e(s,t,i))}!function(e){var t;e.subtract=E(l.subtract),e.length=S(l.length),e.scale=T(l.scale),e.add=(t=l.add,(e,i,s)=>(s||(s=i),t(s,e,i))),e.dot=M(l.dot),e.normalize=C(l.normalize),e.negate=D(l.negate),e.dist=v(l.dist),e.direction=(e,t,i)=>{i||(i=e);const s=e[0]-t[0],n=e[1]-t[1];let r=s*s+n*n;return r?(r=1/Math.sqrt(r),i[0]=s*r,i[1]=n*r,i):(i[0]=0,i[1]=0,i[2]=0,i)},e.squaredLength=e=>l.squaredLength(e),e.set=P(l.copy),e.distanceSquared=y(l.squaredDistance),e.cross=(e,t)=>{const i=u.create();return l.cross(i,e,t),i[2]}}(s||(s={})),function(e){e.getAPerpendicularVector=e=>{const t=e[0],i=e[1];return Math.abs(t)<I.W.ZERO_LENGTH&&Math.abs(i)<I.W.ZERO_LENGTH?u.fromValues(1,0,0):u.fromValues(-i,t,0)},e.equal=u.equals,e.subtract=E(u.subtract),e.dist=v(u.dist),e.setXYZ=(e,t,i,s)=>(u.set(s,e,t,i),s),e.set=P(u.copy),e.scale=T(u.scale),e.dot=M(u.dot),e.add=(e,t,i)=>(i||(i=e),u.add(i,e,t)),e.negate=D(u.negate),e.normalize=C(u.normalize),e.length=S(u.length),e.cross=(e,t,i)=>(i||(i=e),u.cross(i,e,t)),e.distanceSquared=y(u.squaredDistance),e.squaredLength=e=>u.squaredLength(e),e.linComb=(e,t,i,s,n)=>(n||(n=e),n[0]=e[0]*t+i[0]*s,n[1]=e[1]*t+i[1]*s,n[2]=e[2]*t+i[2]*s,n);let t=null;const i=d.create();e.unproject=(e,s,n,r,a)=>{a||(a=e),t||(t=g.create());const o=t,h=i;return h[0]=2*(e[0]-r[0])/r[2]-1,h[1]=2*(e[1]-r[1])/r[3]-1,h[2]=2*e[2]-1,h[3]=1,g.multiply(o,n,s),g.invert(o,o)?(d.transformMat4(h,h,o),0===h[3]?null:(a[0]=h[0]/h[3],a[1]=h[1]/h[3],a[2]=h[2]/h[3],a)):null}}(n||(n={})),function(e){e.negate=D(d.negate),e.setXYZW=(e,t,i,s,n)=>(d.set(n,e,t,i,s),n),e.distanceSquared=y(d.squaredDistance),e.subtract=E(d.subtract),e.set=P(d.copy)}(r||(r={})),function(e){e.multiplyVec2=(e,t,i)=>{i||(i=t);const s=t[0],n=t[1];return i[0]=s*e[0]+n*e[1],i[1]=s*e[2]+n*e[3],i},e.transpose=O(p.transpose)}(a||(a={})),function(e){e.multiplyVec2=A(l.transformMat3),e.transpose=O(m.transpose),e.multiply=R(m.multiply),e.multiplyVec3=A(u.transformMat3)}(o||(o={})),function(e){e.createFrom=g.fromValues,e.equal=g.equals,e.multiply=R(g.multiply),e.multiplyVec4=A(d.transformMat4),e.multiplyVec3=A(u.transformMat4),e.inverse=(e,t)=>(t||(t=e),g.invert(t,e)),e.toRotationMat=(e,t)=>(t||(t=g.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t),e.translate=(e,t,i)=>(i||(i=e),g.translate(i,e,t)),e.rotate=(e,t,i,s)=>(s||(s=e),g.rotate(s,e,t,i)),e.toMat3=(e,t)=>(t||(t=m.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t),e.fromRotationTranslation=(e,t,i)=>(i||(i=g.create()),g.fromRotationTranslation(i,e,t)),e.scale=(e,t,i)=>(i||(i=e),g.scale(i,e,t)),e.rotateX=w(g.rotateX),e.rotateY=w(g.rotateY),e.rotateZ=w(g.rotateZ),e.lookAt=(e,t,i,s)=>(s||(s=g.create()),g.lookAt(s,e,t,i)),e.perspective=(e,t,i,s,n)=>{n||(n=g.create());const r=i*Math.tan(e*Math.PI/360),a=r*t;return g.frustum(n,-a,a,-r,r,i,s)},e.ortho=(e,t,i,s,n,r,a)=>(a||(a=g.create()),g.ortho(a,e,t,i,s,n,r)),e.set=(e,t)=>g.copy(t,t)}(h||(h={})),function(e){e.normalize=C(f.normalize),e.multiply=(e,t,i)=>(i||(i=e),f.multiply(i,e,t)),e.toMat4=(e,t)=>(t||(t=g.create()),g.fromQuat(t,e)),e.dot=f.dot,e.multiplyVec3=(e,t,i)=>(i||(i=t),u.transformQuat(i,t,e)),e.fromAngleAxis=(e,t,i)=>{i||(i=f.create());const s=.5*e,n=Math.sin(s);return i[3]=Math.cos(s),i[0]=n*t[0],i[1]=n*t[1],i[2]=n*t[2],i}}(c||(c={}))},11039:function(e,t,i){i.d(t,{m:function(){return c}});var s=i(93249),n=i(78591),r=i(80675),a=i(96265),o=i(63903),h=i(54861);class c extends n.UIElement{constructor(e,t,i){super(i,n.HUD_SCENEGRAPH_ID),this.iconNodeProperties=this.viewer.getResources().typeToNodeProperties[n.sketchinformation.nodePropertiesTypes.OK],this.worldLocation=t;const r=s.default.getManager();this.iconSizeConstantName="CONSTRAINT_INDICATOR_PIXEL_SIZE",this.iconSize=r.getNumber(this.iconSizeConstantName),this.icon=e,this.listenTo(this.viewer.getEventDispatcher(),n.VIEW_WILL_PICK,this.onViewWillDraw),(0,n.ensureTextureAtlas)(this.viewer),this.invalidateDisplay()}invalidateDisplay(){this.removeMeshIncrements(),(0,n.requestDraw)()}getOffset(e){const t=r.fromValues(0,1),i=function(e,i){return r.dot(r.fromValues(e,i),t)},a=-Math.abs(i(.5,.5)),o=-Math.abs(i(.5,-.5)),h=s.default.getManager().getNumber("TEMPORARY_INFERENCE_OFFSET")-Math.min(a,o),c=-.99*(0,n.getHudLayerDepthRange)(e.getViewport())[1];return[t[0]*h,t[1]*h,c]}onDevicePixelRatioChanged(e){const t=s.default.getManager();this.iconSize=t.getNumber(this.iconSizeConstantName),this.invalidateDisplay()}onViewWillDraw(e,t){if(!this.viewer.getResources().constraintAtlas)return;const i=this.getOffset(e),s=this.getDefaultTransform(e);h.w$.translate(s,i),s[12]=Math.floor(s[12]),s[13]=Math.floor(s[13]),this.setTransform(s),this.updateIconGraphics()}getDefaultTransform(e){let t=e.projectWorldPointToViewport(this.worldLocation);t[2]=0;const i=a.fromValues(0,0,0);t=h.S4.add(t,i);const s=h.w$.translate(o.create(),t),n=this.iconSize;return h.w$.scale(s,[n,n,1]),s}updateIconGraphics(){if(!this.viewer.getResources().constraintAtlas)return;const e=-.5,t=this.icon.id,i=this.viewer.getResources().constraintAtlas.getTextureCoords(t);if(!i)return;const s=(0,n.createQuad)([e,-.5,0],[.5,-.5,0],[e,.5,0],t,[i.lowS,i.highT],[i.highS,i.lowT]);this.updateMeshIncrement(t,"0",s,this.iconNodeProperties)}}},96955:function(e,t,i){i.r(t),i.d(t,{ACTIVE_SHEETMETAL_MODEL_CHANGED:function(){return o.HqE},ACTIVE_VIEWER_SET:function(){return o.zTe},ADD_TEMPORARY_TESSELLATION_OVERRIDES:function(){return o.am2},ASSEMBLY_ANIMATE_MATE_ENDED:function(){return o.V11},ASSEMBLY_ANIMATE_MATE_STARTED:function(){return o.klk},ASSEMBLY_DATA_PROCESSED:function(){return o.hjy},Action:function(){return o.aUM},AnimationCallbackStatus:function(){return o.ZK6},BTGraphicsUsage:function(){return o.LgS},CANVAS_CLICK:function(){return o.pUS},CANVAS_MOUSELEAVE:function(){return o.u5l},CANVAS_MOUSEMOVE:function(){return o.oGi},CHANGE_FEATURE_APPEARANCE:function(){return o.P1w},CHANGE_VIEW:function(){return o.h02},CLEAR_TEMPORARY_TESSELLATION_OVERRIDES:function(){return o.JpA},CLOSE_DIMENSION_EDIT:function(){return o.dPN},CLOSE_MATE_DOF_CHOOSER:function(){return o.rwQ},CLOSE_SELECT_OTHER:function(){return o.AD7},CLOSE_SKETCH_SUB_DIALOG:function(){return o.wfd},CREATE_SECTION_PLANE_INFERENCE_CONTROLLER:function(){return o.T$E},CursorAppendage:function(){return a.CursorAppendage},CursorAppendageLeader:function(){return a.CursorAppendageLeader},DEFAULT_PREVIEW_OPACITY:function(){return a.DEFAULT_PREVIEW_OPACITY},DEFAULT_SIMULATION_COLOR_MAPPING:function(){return a.DEFAULT_SIMULATION_COLOR_MAPPING},DEFAULT_UNITS_CHANGED:function(){return o.CrY},DESTROY_SECTION_PLANE_INFERENCE_CONTROLLER:function(){return o.ye3},DEVICE_PIXEL_RATIO_CHANGED:function(){return o.b3},DID_RENDER_THUMBNAILS:function(){return o.Xc0},DIMENSION_DELETE_REQUEST:function(){return o.uav},DIMENSION_EDIT_CLOSED:function(){return o.pKY},DIMENSION_TEXT_DOUBLE_CLICKED:function(){return o.cu9},DIMENSION_TEXT_SINGLE_CLICKED:function(){return o.Q6T},DIMENSION_VALUE_CHANGED:function(){return o.WYs},DISPLAYED_PART_STUDIO:function(){return o.adC},DragTrimLine:function(){return a.DragTrimLine},ELEMENT_GRAPHICS_LOADING:function(){return o.Wp_},ELEMENT_PREVIEW_GRAPHICS_LOADED:function(){return o.Vpt},ELEMENT_VIEW_INITIALIZED:function(){return o.cpE},EntityData:function(){return a.EntityData},ExplodeLine:function(){return a.ExplodeLine},ExplodeLineArcSegment:function(){return a.ExplodeLineArcSegment},ExplodeLineLineSegment:function(){return a.ExplodeLineLineSegment},FrameType:function(){return o.QpP},GL_CONTEXT_LOST:function(){return o.cWC},GL_CONTEXT_RESTORED:function(){return o.pOz},GRAPHICS_HANDLED_CLICK_EVENT:function(){return o.sdI},GraphicsRefinementMode:function(){return o.Rng},HUD_MODEL_SCENEGRAPH_ID:function(){return o.$Ky},HighlightType:function(){return o.o2L},INVALID_ID:function(){return o.JE9},INVALID_OCCURRENCE_ID:function(){return o.Qyk},IdManager:function(){return o.siw},IdSizes:function(){return o._6$},IntersectionType:function(){return o.IiW},IsolatedOccurrencesManager:function(){return a.IsolatedOccurrencesManager},MAIN_SCENEGRAPH_ID:function(){return o.lLv},MAXIMUM_NUMBER_OF_SECTION_PLANES_REACHED:function(){return o.F59},ManipulationMode:function(){return o.kJR},NAMED_VIEW_APPLIED:function(){return o.ziX},NEW_PART_LIST:function(){return o.W2m},NON_TRIVIAL_PART_STUDIO_DATA_PROCESSED:function(){return o.CDm},NamedIdManager:function(){return o.EBu},PART_STUDIO_PART_VISIBILITY_CHANGED:function(){return o.sJs},PREVIOUS_VERSION_CANVAS_SELECTOR:function(){return a.PREVIOUS_VERSION_CANVAS_SELECTOR},RETRIEVE_ELEMENT_DISPLAY_DATA:function(){return o.Cgl},RETRIEVE_OCCURRENCE_DISPLAY_DATA:function(){return o.Qeo},RETRIEVE_SMOOTH_EDGE_INFORMATION:function(){return o.Uj6},SECTIONPLANE_SELECTION_ID:function(){return o.s_Y},SECTION_PLANE_ADDED:function(){return o.Srw},SECTION_PLANE_REMOVED:function(){return o.zKA},SECTION_VIEW_DIALOG_CLOSED:function(){return o.KOV},SECTION_VIEW_DIALOG_OPENED:function(){return o.M1t},SELECTION_REJECTED:function(){return o.SzR},SELECT_OTHER:function(){return o.NMw},SELECT_OTHER_REVERSE:function(){return o.aat},SHOW_SKETCH_TEXT:function(){return o._hB},SHOW_SMART_SELECTION:function(){return o.bsB},SKETCH_COMMAND_ACTIVATED:function(){return o.JFj},SPACEMOUSE_COMMANDS_RECEIVED:function(){return o.TN9},Sketch:function(){return a.Sketch},SketchPlaneDisplay:function(){return a.SketchPlaneDisplay},SplineHandle:function(){return a.SplineHandle},StandardViews:function(){return a.StandardViews},TemporarySketchComponent:function(){return a.TemporarySketchComponent},Text:function(){return a.Text},UIElement:function(){return a.UIElement},UISelection:function(){return a.UISelection},UPDATE_INCONTEXT_ISOLATION:function(){return o.bhj},UiEvents:function(){return a.UiEvents},VIEWER_CANVAS_ATTACHED_TO_CONTAINER:function(){return o.tSV},VIEW_CONTAINER_MENU_INVOKED:function(){return o.oLC},VIEW_DID_DRAW:function(){return o.u9p},VIEW_WILL_DRAW:function(){return o.Hvz},View:function(){return a.View},WILL_RENDER_THUMBNAILS:function(){return o.gV9},addStyleToIncrement:function(){return a.addStyleToIncrement},angleBetweenVectors:function(){return a.angleBetweenVectors},are2dPointsEqual:function(){return a.are2dPointsEqual},areAnySectionPlanesSelectedOrPreselected:function(){return a.areAnySectionPlanesSelectedOrPreselected},areMatricesEqual:function(){return a.areMatricesEqual},basicPickSort:function(){return h.G},btTs:function(){return c},cacheCapabilities:function(){return a.cacheCapabilities},clearSavedSectionPlaneParameters:function(){return a.clearSavedSectionPlaneParameters},collectGraphicsDataForHeapDump:function(){return a.collectGraphicsDataForHeapDump},createArcPolyline:function(){return a.createArcPolyline},createCirclePolyline:function(){return a.createCirclePolyline},createDimensionForDisplayData:function(){return a.createDimensionForDisplayData},createInferenceIcon:function(){return a.createInferenceIcon},createPolyline:function(){return a.createPolyline},createTestViewer:function(){return a.createTestViewer},deselectEntities:function(){return a.deselectEntities},disableSectionPlaneSelection:function(){return o.ZBF},displayEntity:function(){return a.displayEntity},distanceSquaredBetweenPoints:function(){return a.distanceSquaredBetweenPoints},distanceSquaredToLineSegment2d:function(){return a.distanceSquaredToLineSegment2d},enableSectionPlaneSelection:function(){return o.G29},estimateTriangleCountAtSettingIndexUsingTriangleCounts:function(){return a.estimateTriangleCountAtSettingIndexUsingTriangleCounts},forEachActiveSectionPlane:function(){return a.forEachActiveSectionPlane},getActiveSectionPlane:function(){return a.getActiveSectionPlane},getActiveSectionViewState:function(){return a.getActiveSectionViewState},getActiveViewer:function(){return o.uQB},getActiveViewerEventDispatcher:function(){return o.xA2},getActiveViewerHasSketch:function(){return a.getActiveViewerHasSketch},getActiveViewerModelViewManagers:function(){return o.IOg},getAngle:function(){return a.getAngle},getColorStringArray:function(){return a.getColorStringArray},getCounters:function(){return a.getCounters},getCurrentSectionPlaneParameters:function(){return a.getCurrentSectionPlaneParameters},getDefaultNameForBody:function(){return a.getDefaultNameForBody},getDisplayedElementObservable:function(){return o.v93},getDrawer:function(){return a.getDrawer},getDrawers:function(){return a.getDrawers},getEditState:function(){return a.getEditState},getFeatureThumbnailKey:function(){return a.getFeatureThumbnailKey},getFocusedViewer:function(){return o.N9r},getHasFeatureQLVFacePatternCapability:function(){return a.getHasFeatureQLVFacePatternCapability},getMaxSectionPlanes:function(){return a.getMaxSectionPlanes},getMostRecentActiveSectionPlaneParameters:function(){return a.getMostRecentActiveSectionPlaneParameters},getMouseSettingsManager:function(){return a.getMouseSettingsManager},getObservableFromActiveViewerForEvent:function(){return o.eRd},getOrCreateViewerSet:function(){return a.getOrCreateViewerSet},getPartStudioThumbnailKey:function(){return a.getPartStudioThumbnailKey},getPartThumbnailKey:function(){return a.getPartThumbnailKey},getPerpendicularBisector2d:function(){return a.getPerpendicularBisector2d},getPlaneIndexToAlignNormalTo:function(){return a.getPlaneIndexToAlignNormalTo},getPointAtAngle:function(){return a.getPointAtAngle},getRendererInfo:function(){return a.getRendererInfo},getSectionPlaneCount:function(){return a.getSectionPlaneCount},getSectionedItemsSize:function(){return a.getSectionedItemsSize},getSerializablePlaneData:function(){return a.getSerializablePlaneData},getSerializableSectionViewData:function(){return a.getSerializableSectionViewData},getThumbnailForKey:function(){return a.getThumbnailForKey},getTimeInMilliseconds:function(){return a.getTimeInMilliseconds},getUnavailableRendererInfo:function(){return a.getUnavailableRendererInfo},getZoomToWindowState:function(){return a.getZoomToWindowState},graphicsTakesSelectionPrecedence:function(){return a.graphicsTakesSelectionPrecedence},idIsValid:function(){return o.rp5},idsEqual:function(){return o.nD6},initializePreviousVersionViewer:function(){return a.initializePreviousVersionViewer},intersectLineSegmentRay:function(){return a.intersectLineSegmentRay},intersectTwoLineSegments2d:function(){return a.intersectTwoLineSegments2d},intersectTwoLines2d:function(){return a.intersectTwoLines2d},isInSectionPlaneMode:function(){return a.isInSectionPlaneMode},isMapEmpty:function(){return a.isMapEmpty},isRendererStringForDedicatedIntel:function(){return a.isRendererStringForDedicatedIntel},isRendererStringForIntel:function(){return a.isRendererStringForIntel},isSectionPlaneModeEnabled:function(){return a.isSectionPlaneModeEnabled},isUsageBase:function(){return a.isUsageBase},isUsageCompare:function(){return a.isUsageCompare},isUsagePreview:function(){return a.isUsagePreview},loadSectionPlanesFromParameters:function(){return a.loadSectionPlanesFromParameters},preserveViewersForDocumentId:function(){return a.preserveViewersForDocumentId},projectToLine:function(){return a.projectToLine},removeGraphicsViewers:function(){return a.removeGraphicsViewers},removeSectionPlane:function(){return a.removeSectionPlane},removeSectionPlanes:function(){return a.removeSectionPlanes},requestDraw:function(){return a.requestDraw},resetUsage:function(){return a.resetUsage},setBaseHighlightsEnabled:function(){return a.setBaseHighlightsEnabled},setBoxSelectionEnabled:function(){return a.setBoxSelectionEnabled},setDimensionToolActive:function(){return a.setDimensionToolActive},setForceHideInteriorSelections:function(){return a.setForceHideInteriorSelections},setFromSerializablePlaneData:function(){return a.setFromSerializablePlaneData},setFromSerializableSectionViewData:function(){return a.setFromSerializableSectionViewData},setInteractionEnabled:function(){return a.setInteractionEnabled},setIsInFollowMode:function(){return a.setIsInFollowMode},setIsInSectionPlaneMode:function(){return a.setIsInSectionPlaneMode},setSectionEntitiesEnabled:function(){return a.setSectionEntitiesEnabled},setSectionPlaneOnMateConnector:function(){return a.setSectionPlaneOnMateConnector},setSectionPlaneOnMatrix:function(){return a.setSectionPlaneOnMatrix},setShowDimensionsMode:function(){return a.setShowDimensionsMode},setThumbnailForKey:function(){return a.setThumbnailForKey},setTransparencyTransition:function(){return a.setTransparencyTransition},setViewCubeMenuMgrInstance:function(){return a.setViewCubeMenuMgrInstance},setZoomModeEnabled:function(){return a.setZoomModeEnabled},snapshotScenegraph:function(){return a.snapshotScenegraph},tessellateArc:function(){return a.tessellateArc},timeRendering:function(){return a.timeRendering},toggleZoomModifierEnabled:function(){return a.toggleZoomModifierEnabled},unprojectPlaneToWorld:function(){return a.unprojectPlaneToWorld},unprojectVectorToWorld:function(){return a.unprojectVectorToWorld},userWebPreferencesGetManager:function(){return o.tYI},viewerCheck:function(){return o.Ykz}});var s,n=i(18572),r=i(77484),a=i(78591);!function(e){!function(e){e.camera=a,e.frametimer=a,e.math=a,e.editstate=a,e.debugTools=a,e.eventdispatcher=a,e.utilities=(0,n.Z)({},a,{RetinaDisplayMode:a.RetinaDisplayMode},{pixelscaling:a}),e.viewcontroller=a,e.measurementdisplay=a,e.sectionplane=a,e.statistics=a,e.sketchdisplaydata=a,e.imagedisplay=a,e.sketchcomponent=a,e.splinehandle=a,e.zoomToWindowState=a,e.dimensions=a,e.coordinatesysteminference=a,e.triad=a,e.mateconnector=a,e.animationcontroller=a,e.occurrence=a,e.manipulators=a,e.idmanager=a,e.inferencepicker=a,e.mateindicator=a,e.viewerset=a,e.viewmanipulator=a,e.axes=a,e.inputhandler=a}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.getActiveViewer=r.uQ,e.viewerCheck=r.Yk,e.getFocusedViewer=a.getFocusedViewer,e.getActiveViewerModelViewManagers=r.IO,e.retrieveViewportAsImage=a.retrieveViewportAsImage,e.getActiveViewerOccurrenceDataManager=a.getActiveViewerOccurrenceDataManager}(e.viewer||(e.viewer={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.setRefinementMode=a.setRefinementMode,e.RefinementMode=a.RefinementMode}(e.bodymanager||(e.bodymanager={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.View=a.View}(e.sketchinformation||(e.sketchinformation={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.PrimitiveType=a.PrimitiveType}(e.meshattr||(e.meshattr={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.EdgePoint=a.EdgePoint}(e.edgepoint||(e.edgepoint={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.Manager=a.DetailManager}(e.detail||(e.detail={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.visualizePicks=a.visualizePicks}(e.debug||(e.debug={}))}(e.graphics||(e.graphics={}))}(s||(s={}));var o=i(28784),h=i(50098);const c=(0,n.Z)({},s)},78591:function(e,t,i){i.r(t),i.d(t,{ACTIVE_SHEETMETAL_MODEL_CHANGED:function(){return VM.Hq},ACTIVE_VIEWER_SET:function(){return VM.zT},ADD_TEMPORARY_TESSELLATION_OVERRIDES:function(){return VM.am},AFTER_MARKUP_IMAGE_GENERATION:function(){return VM.nh},ANALYSIS_MENU_INVOKED:function(){return VM.CJ},ASSEMBLY_ANIMATE_MATE_ENDED:function(){return VM.V1},ASSEMBLY_ANIMATE_MATE_STARTED:function(){return VM.kl},ASSEMBLY_DATA_PROCESSED:function(){return VM.hj},ASSEMBLY_PREFIX:function(){return bI},ASSEMBLY_TIMES:function(){return VM.uv},ATTRIBUTES:function(){return tg},ATTRIBUTE_LAYOUT:function(){return ig},AXES_ID:function(){return ls},Action:function(){return yn.aU},ActionIds:function(){return ms},ActionSetController:function(){return fs},AngleDisplay:function(){return AC},Angular:function(){return Ur},AngularDimension:function(){return hE.$R},AngularFeatureManipulator:function(){return wl.EH},AngularToolPreview:function(){return on},AngularWithArrow:function(){return Hr},AnimationController:function(){return lM},AnnotationComponent:function(){return ou},AnnotationDisplay:function(){return hu},AnnotationPlane:function(){return od},Arc:function(){return hE.wN},ArcLengthDimension:function(){return hE.uU},Arrow:function(){return tu},Assembly:function(){return yd},AssemblyEnabledPartStudioComponent:function(){return ag},AssemblyIsolateManager:function(){return RM},AssemblyIsolateManagerBase:function(){return OM},AssemblyMakeTransparentManager:function(){return _M},AssignIdGLContext:function(){return EM},AtlasTexture:function(){return bs.KL},Attribute:function(){return Qd},AttributeBinding:function(){return Of},AttributeNames:function(){return $d},Attributes:function(){return Jd},Axes:function(){return gs},AxisLabel:function(){return ds},BEFORE_MARKUP_IMAGE_GENERATION:function(){return VM.m2},BODIES_LOADED:function(){return VM.LA},BODY_MANAGER_NONISOLATED_INCREMENT_GROUP_ID:function(){return Uc},BODY_MANAGER_OPAQUE_INCREMENT_GROUP_ID:function(){return xc},BODY_MANAGER_TRANSPARENT_INCREMENT_GROUP_ID:function(){return Bc},BOUNDING_BOX_MESH_INCREMENT_NAME:function(){return oM},BOX_SELECTION_FINISHED:function(){return VM.KB},BTGraphicsUsage:function(){return Ls.L},BackFaceSilhouettePass:function(){return Bt},BackFaceStencilPass:function(){return Ut},Ball:function(){return Jg},Base:function(){return eu},BaseDisplay:function(){return ld},BezierDegreeDimension:function(){return hE.z$},BitShiftId:function(){return Ni},BlendFilter:function(){return n},BlendMode:function(){return d},BlitBlendMode:function(){return p},BlitBufferedPass:function(){return S},BlitFramebufferPass:function(){return T},BlitPass:function(){return E},BodyCheckCustomPass:function(){return Tt},BodyCheckPass:function(){return Mt},BodyComponent:function(){return Hp},BodyComponentId:function(){return gp},BodyLoadTasks:function(){return cl},BodyLoader:function(){return hl},BodyManager:function(){return il},BodyMetaData:function(){return Nh.XH},BodyOccurrence:function(){return Jc},BodyToProcess:function(){return ol},BooleanIterator:function(){return TE},BoundingBox:function(){return Li.kB},BoundingBox2D:function(){return Li.tO},BoundingSpot:function(){return Li.iK},BoxSelector:function(){return Sn},BrowserRefreshRate:function(){return zf},Budget:function(){return uM},Buffer:function(){return MS},BufferAllocationPolicy:function(){return CI},BufferSet:function(){return LS},BufferSetBase:function(){return sg},BufferedPass:function(){return M},CANVAS_CLICK:function(){return VM.pU},CANVAS_MOUSEENTER:function(){return VM.ox},CANVAS_MOUSELEAVE:function(){return VM.u5},CANVAS_MOUSEMOVE:function(){return VM.oG},CHANGE_FEATURE_APPEARANCE:function(){return VM.P1},CHANGE_VIEW:function(){return VM.h0},CLEAR_TEMPORARY_TESSELLATION_OVERRIDES:function(){return VM.Jp},CLOSE_DIMENSION_EDIT:function(){return VM.dP},CLOSE_MATE_DOF_CHOOSER:function(){return VM.rw},CLOSE_SELECT_OTHER:function(){return VM.AD},CLOSE_SKETCH_SUB_DIALOG:function(){return VM.wf},COLLECTION_ID_PREFIX:function(){return qI},COLOR_MAP_TESSELLATION_SETTING_INDEX:function(){return Dc},CONSTANTS:function(){return vd},CREATE_SECTION_PLANE_INFERENCE_CONTROLLER:function(){return VM.T$},CURVATURE_ANALYSIS_COLOR_MAPPING_CHANGED:function(){return VM.iH},CURVATURE_ANALYSIS_CURVATURE_CONTROL_CHANGED:function(){return VM.gW},CURVATURE_ANALYSIS_LEGEND_CLOSED:function(){return VM.Nw},CURVATURE_ANALYSIS_LEGEND_MAXIMUM_CLICKED:function(){return VM.fd},CURVATURE_ANALYSIS_LEGEND_MINIMUM_CLICKED:function(){return VM.ib},CURVATURE_ANALYSIS_LEGEND_OPENED:function(){return VM.A1},CURVATURE_ANALYSIS_RANGE_CHANGED:function(){return VM.JH},CURVATURE_VISUALIZATION_MANAGER_NODE_ID:function(){return Cc},CachedOccurrenceState:function(){return Pd},CalculateOcclusionPass:function(){return Ee},CallCountingGLContext:function(){return IM},Camera:function(){return Ch},CanvasTextureDefinition:function(){return Eo},CenterOfMassIndicator:function(){return xd},CenterlineDimension:function(){return hE.SM},ChainedOperator:function(){return Kr},ClippingPlaneNames:function(){return ur},CombDisplay:function(){return OC},CombinedPickPass:function(){return Re},CommentIndicator:function(){return Fd},CompareBlendPass:function(){return Ze},ComponentNames:function(){return BD.vn},ConnectionVisualizationManager:function(){return xh},ConstituentType:function(){return Nh.po},ConstructionPlaneDisplay:function(){return zC},ControlPointGridDisplay:function(){return nm},CountDimension:function(){return hE.JO},CounterNames:function(){return Un.kW},Counters:function(){return Un.xv},CullFace:function(){return Rh},CullingState:function(){return Js.uc},Cursor:function(){return Xn.C},CursorAppendage:function(){return Ts},CursorAppendageLeader:function(){return Cs},CurvatureAnalysisLegend:function(){return mc},CurvatureAnalysisManager:function(){return vc},CurvatureAnalysisScenegraphManager:function(){return yc},CurveLengthDimension:function(){return hE.U8},CustomPass:function(){return se},Cylindrical:function(){return Qg},DEFAULT_MATERIAL:function(){return zi},DEFAULT_OPTIONS:function(){return To},DEFAULT_PERSPECTIVE_FOV:function(){return Dh},DEFAULT_PREVIEW_OPACITY:function(){return Vs},DEFAULT_SIMULATION_COLOR_MAPPING:function(){return Gm},DEFAULT_UNITS_CHANGED:function(){return VM.Cr},DEPTH_PASS_CLEAR_COLOR:function(){return Js.XD},DESTROY_SECTION_PLANE_INFERENCE_CONTROLLER:function(){return VM.ye},DEVICE_PIXEL_RATIO_CHANGED:function(){return VM.b3},DID_RENDER_THUMBNAILS:function(){return VM.Xc},DIMENSION_ATLAS:function(){return _C},DIMENSION_DELETE_REQUEST:function(){return VM.u},DIMENSION_EDIT_CLOSED:function(){return VM.pK},DIMENSION_TEXT_DOUBLE_CLICKED:function(){return VM.cu},DIMENSION_TEXT_SINGLE_CLICKED:function(){return VM.Q6},DIMENSION_VALUE_CHANGED:function(){return VM.WY},DIRECTION:function(){return D},DISPLAYED_ASSEMBLY:function(){return VM.t0},DISPLAYED_PART_STUDIO:function(){return VM.ad},DataManager:function(){return Oh},DatumDisplay:function(){return ud},DebugPickPass:function(){return ot},Decal:function(){return Hd},DecalComponent:function(){return kd},DefaultPassUsage:function(){return _e},DefaultPasses:function(){return Ne},DepthClearPass:function(){return V},DepthRetrievalPass:function(){return Xe},DepthSamplingPass:function(){return le},DepthTestMode:function(){return g},DetailDisplay:function(){return pd},DetailManager:function(){return da},DihedralCombDisplay:function(){return Bm},DihedralExtremaDisplay:function(){return Vm},Dimension:function(){return hE.Ro},DimensionComponent:function(){return Zd},DimensionPreferences:function(){return Ms.FZj},DirectionalScreenFacingSpaceQuadGlyphComponent:function(){return Zl},Display:function(){return MI},DistanceDisplay:function(){return yC},DoubleClickHandler:function(){return XI},DraftAnalysisDrawPass:function(){return Ot},DraftAnalysisShadowTestPass:function(){return yt},DraftAnalysisShadowTestPasses:function(){return At},DraftAngleRetrievalPass:function(){return pt},DragTrimLine:function(){return Cn},DrawPass:function(){return f},DrawPassVisibility:function(){return o},DropdownButton:function(){return $T},ELEMENT_GRAPHICS_LOADING:function(){return VM.Wp},ELEMENT_PREVIEW_GRAPHICS_LOADED:function(){return VM.Vp},ELEMENT_PREVIEW_NODE_ID:function(){return yl},ELEMENT_VIEW_INITIALIZED:function(){return VM.cp},ELLIPSIS_ID:function(){return bs.WD},EMPTY_HIGHLIGHT_STYLE:function(){return lS},EVENT_NEEDS_ANGULAR_BROADCAST:function(){return VM.pF},EXCELLENT_GPU_RESULTS:function(){return Gf},EdgeAndHiddenEdgePass:function(){return j},EdgeCurvatureDisplay:function(){return vm},EdgeDetectAndBlurPass:function(){return N},EdgeDetectBufferPass:function(){return w},EdgeDetectPass:function(){return O},EdgePoint:function(){return Td},EdgePointController:function(){return Ci},Element:function(){return Md},ElementLoadState:function(){return cT},ElementPreviewManager:function(){return Al},EllipseDiameterDimension:function(){return hE.Xk},EntityData:function(){return Ya},ErrorComponent:function(){return kp},EventDispatcher:function(){return VM.pB},Events:function(){return Ns},ExplodeLine:function(){return wD},ExplodeLineArcSegment:function(){return ND},ExplodeLineLineSegment:function(){return LD},ExpressionType:function(){return hE.t_},FALSE_INT_UNIFORM:function(){return Mf},FIRST_ID:function(){return Di.lm},FOLLOW_MODE_DEACTIVATED:function(){return VM.Gf},FOLLOW_MODE_LEADER_MOUSE_MOVED:function(){return VM.Aw},FOLLOW_MODE_LEADER_MOUSE_OUT:function(){return VM.Nf},FaceAllHighlightsDrawPass:function(){return ae},FaceEdgePointPass:function(){return H},FaceHighlightBufferPass:function(){return wt},FaceHighlightMaskPass:function(){return _t},FaceSingleHighlightDrawPass:function(){return Ct},FacesShadeMode:function(){return h},Factory:function(){return NC},Fastened:function(){return qg},FeatureManipulator:function(){return wl.XX},FilterCandidate:function(){return gf},FilterEdgePointCandidate:function(){return mf},FilterOcclusionPass:function(){return Se},FilterVertexCandidate:function(){return pf},FilteredEntitiesHighlightController:function(){return $C},Fixed:function(){return nu},FixedMateIndicator:function(){return ip},Flip:function(){return wl.BW},FrameBuffer:function(){return Xo},FrameTimer:function(){return zo},FreeDrag:function(){return kr},FullTriadFeatureManipulator:function(){return wl.QV},GLContext:function(){return fM},GLYPH_SELECTION_ID:function(){return Wl},GL_CONTEXT_LOST:function(){return VM.cW},GL_CONTEXT_RESTORED:function(){return VM.pO},GRAPHICS_HANDLED_CLICK_EVENT:function(){return VM.sd},Gauge:function(){return Xf},GenerativeDesignManager:function(){return df},GeometryMate:function(){return su},GhostParentPass:function(){return at},GlDataType:function(){return Ht},GlPixelFormat:function(){return Wt},GlRenderBufferType:function(){return kt},GlyphComponent:function(){return zl},GlyphHighlightStates:function(){return Gl},GlyphResources:function(){return kl},GlyphStateTextureSuffixes:function(){return Vl},GlyphStates:function(){return Ul},GraphicsRefinementMode:function(){return Ms.Rng},GraphicsWebAssemblyUtils:function(){return If},GroupRanges:function(){return xS},HIGHLIGHTED_LINE_PROPERTIES:function(){return pl},HIGHLIGHTED_TRIANGLE_PROPERTIES:function(){return El},HUD_MODEL_SCENEGRAPH_ID:function(){return sh.$K},HUD_SCENEGRAPH_ID:function(){return sh.EG},Highlight:function(){return Rn},HighlightFlag:function(){return On},HighlightManager:function(){return Ln},HighlightPriority:function(){return An},HighlightType:function(){return yn.o2},HudModelPass:function(){return b},HudPass:function(){return L},IDENTITY_MATRIX:function(){return Li.Ad},INFERENCE_LINE_PROPERTIES:function(){return gl},INFERENCE_PICKER_SCENEGRAPH_ID:function(){return sh.Jh},INFERENCE_TRIANGLE_PROPERTIES:function(){return fl},INFINITE_CURVATURE_CUTOFF:function(){return Mc},INVALID_FRAME_ID:function(){return sE},INVALID_ID:function(){return Di.JE},INVALID_ID_ELEMENT:function(){return Di.vN},INVALID_NUMBER_ID:function(){return Di.c2},INVALID_OCCURRENCE_ID:function(){return DI.Qy},IconBorderState:function(){return bs.Te},IconData:function(){return bs.b2},IconSelectionType:function(){return Ms.UKE},IdManager:function(){return Di.si},IdMasks:function(){return Di.U2},IdSizes:function(){return Di._6},ImageComponent:function(){return Rl},ImageData:function(){return Nl},ImageDisplay:function(){return Jn},IncrementDetails:function(){return wS},IncrementId:function(){return Tl},IncrementRanges:function(){return BS},InferenceData:function(){return Ms.Wfq},InferenceDisplay:function(){return dg},InferenceDisplayWithoutHover:function(){return gg},InferencePickPass:function(){return we},InferencePicker:function(){return rM},InputHandler:function(){return _s},InteractionTypes:function(){return Wo},InterferenceDisplay:function(){return hM},IntersectIterator:function(){return JE},IntersectOperator:function(){return eS},IntersectionType:function(){return dr.I},IsolateContextPass:function(){return rt},IsolateFlag:function(){return xM},IsolatedManagerBase:function(){return DM},IsolatedManagersUtils:function(){return FM},IsolatedOccurrencesManager:function(){return UM},LARGEST_REPRESENTABLE_INTEGER:function(){return Li.s9},LINE_PROPERTIES:function(){return dl},LOADED_TESSELLATION_SETTING:function(){return Yc},LeaderDisplay:function(){return Id},LinePointAllHighlightsDrawPass:function(){return he},LinePointSingleHighlightDrawPass:function(){return oe},Linear:function(){return br},Linear1d:function(){return wl.ol},LinearDimension:function(){return hE.mI},LinearDisplacement:function(){return xr},LinearToolPreview:function(){return cn},Listener:function(){return Jo},LoadTextures:function(){return Cg},Lod:function(){return eg},MAIN_SCENEGRAPH_ID:function(){return sh.lL},MANIPULATOR_BUTTONS_ID:function(){return zT},MANIPULATOR_ID:function(){return WT},MATE_INDICATOR_ATLAS:function(){return wC},MAXIMUM_NUMBER_OF_SECTION_PLANES_REACHED:function(){return VM.F5},MAX_COLLAPSED_ICONS:function(){return bs.eL},MEDIUM_INTERACTIVE_BUDGET:function(){return gM},MESH_EDGE_NODE_PROPERTIES:function(){return Ap},MINIMUM_REFRESH_RATE_FPS:function(){return Wf},MODEL_MESH_MANAGER_SETTINGS:function(){return xI},MainDrawPass:function(){return Rt},Manager:function(){return Dn},ManipulationMode:function(){return FD.k},Manipulator:function(){return Nr},MateConnector:function(){return Dl},MateConnectorComponent:function(){return zg},MateGroup:function(){return iu},MateGroupMateIndicator:function(){return ep},MateIndicator:function(){return Xg},MateIndicatorComponent:function(){return Jl},Material:function(){return ki},MemoryGauge:function(){return Zf},Mesh:function(){return OI},MeshIncrement:function(){return jE},MeshManager:function(){return zS},MeshPointController:function(){return Kn},ModelViewManager:function(){return Sh},ModelViewManagers:function(){return Th},MouseButton:function(){return Ms.tcH},MouseEvents:function(){return zI},NAMED_VIEW_APPLIED:function(){return VM.zi},NEW_PART_LIST:function(){return VM.W2},NON_TRIVIAL_PART_STUDIO_DATA_PROCESSED:function(){return VM.CD},NO_ID:function(){return DI.QC},NO_RANGE_OPERATOR:function(){return AE},NO_RETRIEVAL_SENT_FOR_OCCURRENCE:function(){return Wc},NO_SECTION_SHADER_ID_SUFFIX:function(){return Df},NO_SELECTION_ID:function(){return yi},NUMBER_INTEGER_BITS:function(){return Li.tl},NamedIdManager:function(){return vI.E},NoRangeOperator:function(){return yE},Node:function(){return ts},NodeOccurrence:function(){return DS},NodeProperties:function(){return Qi},NodePropertiesTypes:function(){return Bn},NonInstantiatedBody:function(){return Kc},NormalDepthFilter:function(){return Ie},NormalDepthPass:function(){return x},NormalDepthWithMaskPass:function(){return k},NumberIdManager:function(){return Di.s},OCCURRENCE_SOURCE:function(){return LI},OFFSET_DIRECTION_PIXEL_TOLERANCE:function(){return bs.wm},OITBufferPass:function(){return qe},OITColorPass:function(){return F},OITComponent:function(){return r},OITCompositePass:function(){return Ue},OS_TO_Y_UP:function(){return vD},OccurrenceData:function(){return Qr},OccurrenceHighlights:function(){return uS},OccurrenceIdManager:function(){return DI.yx},Opacity:function(){return a},OriginAxesIndex:function(){return BD.tF},OriginElement:function(){return Lc},OrthographicCamera:function(){return Ph},OrthographicController:function(){return lr},OutlineMeshId:function(){return WC},PART_STUDIO_DATA_AND_SELECTION_REMAP_PROCESSED:function(){return VM.cy},PART_STUDIO_ELEMENT_ID:function(){return DI.KF},PART_STUDIO_OCCURRENCE_ID:function(){return FI},PART_STUDIO_PART_VISIBILITY_CHANGED:function(){return VM.sJ},PART_STUDIO_PREFIX:function(){return NI},PART_STUDIO_TIMES:function(){return VM.$_},PICKS_BOX_SELECTED:function(){return VM.f4},PICK_CLEAR_COLOR:function(){return Js.o0},PICK_CONSTRAINT_SELECTED:function(){return VM.Mp},PREVIEW_SCENEGRAPH_ID:function(){return sh.Vv},PREVIOUS_VERSION_CANVAS_SELECTOR:function(){return gC.TC},PRIMITIVE_TYPE_BITS:function(){return _i.ip},Parallel:function(){return Kg},PartComparePass:function(){return We},PartPreviewPass:function(){return Ye},PartStudio:function(){return qd},PartStudioBlendPass:function(){return z},PartStudioComponent:function(){return rg},PartStudioIsolateManager:function(){return bM},PartStudioIsolateManagerBase:function(){return NM},PartStudioMakeTransparentManager:function(){return LM},PerspectiveCamera:function(){return vh},PerspectiveController:function(){return cr},Pick:function(){return Ef.D},PickAlternates:function(){return ze},PickPass:function(){return Ae},PickPriority:function(){return Ef.z},PinSlot:function(){return $g},Planar:function(){return Br},PlanarMateIndicator:function(){return Yg},PlaneComponent:function(){return cg},PlaneComponentId:function(){return og},PlaneIdPass:function(){return Dt},PlaneMeshId:function(){return kC},PlaneProperties:function(){return GC},PointBodyComponent:function(){return hp},PointDimension:function(){return hE.IG},PointElement:function(){return au},PointSelection:function(){return qr},PointsFeatureManipulator:function(){return wl.QQ},PolarDimension:function(){return hE.$d},PreviewBlendPass:function(){return ue},Primitive:function(){return s},PrimitiveType:function(){return _i.MX},Quad:function(){return cM},QualityVisualizationPass:function(){return re},REFRESH_RATE_MEASURE_SAMPLE_START_TIME_MS:function(){return Hf},REFRESH_RATE_MEASURE_TIME_MS:function(){return kf},RETRIEVE_ELEMENT_DISPLAY_DATA:function(){return VM.Cg},RETRIEVE_OCCURRENCE_DISPLAY_DATA:function(){return VM.Qe},RETRIEVE_SMOOTH_EDGE_INFORMATION:function(){return VM.Uj},ROOT_ELEMENT_NODE_ID:function(){return RI},ROOT_ELEMENT_PREVIEW_NODE_ID:function(){return wI},RadialDimension:function(){return hE.nl},RangeSetIterator:function(){return QE},Ranges:function(){return $E},Ray:function(){return Li.zH},RayVisualization:function(){return Nf},ReferenceHighlights:function(){return bn},RefinementMode:function(){return Gc},RenderContext:function(){return oE},RenderOrderPriority:function(){return Yi},ResizeManipulator:function(){return QC},ResizeManipulatorIds:function(){return VC},ResourceManager:function(){return EI},Resources:function(){return Wn},Results:function(){return Vf},RetinaDisplayMode:function(){return _h.oA},RetrievalRequestSource:function(){return zc},Revolute:function(){return Zg},RhoDimension:function(){return hE.Mm},RotationComponentToAxesIndexMap:function(){return Yr.L},SCALAR_VISUALIZATION_FACE_SOLID_NODE_PROPERTIES:function(){return Mp},SCALAR_VISUALIZATION_FACE_SURFACE_NODE_PROPERTIES:function(){return Cp},SECTION_PLANE_ADDED:function(){return VM.Sr},SECTION_PLANE_REMOVED:function(){return VM.zK},SECTION_VIEW_DIALOG_CLOSED:function(){return VM.KO},SECTION_VIEW_DIALOG_OPENED:function(){return VM.M1},SELECTION_ID:function(){return gn},SELECTION_REJECTED:function(){return VM.Sz},SELECT_OTHER:function(){return VM.NM},SELECT_OTHER_REVERSE:function(){return VM.a},SESSION_ENDED:function(){return VM.so},SHEET_FACE_NODE_PROPERTIES:function(){return Rp},SHEET_FACE_NODE_PROPERTIES_TRANSPARENT:function(){return wp},SHOW_DIMENSION_EXPRESSIONS_CHANGED:function(){return VM.yB},SHOW_SKETCH_TEXT:function(){return VM._h},SHOW_SMART_SELECTION:function(){return VM.bs},SIMULATION_CONNECTIONS_DISPLAYED:function(){return VM.GO},SIMULATION_LEGEND_CANVAS_CONTROLS_PANEL_ID:function(){return Hm},SIMULATION_LEGEND_CLOSED:function(){return VM.Ip},SIMULATION_LEGEND_OPENED:function(){return VM.PX},SIMULATION_MAXIMUM_CLICKED:function(){return VM.Jm},SIMULATION_MINIMUM_CLICKED:function(){return VM.xy},SIMULATION_RANGE_CHANGED:function(){return VM.pj},SIMULATION_RESULTS_DISPLAYED:function(){return VM.R1},SKETCH_COMMAND_ACTIVATED:function(){return VM.JF},SKETCH_CONSTRAINT_TEXTURE_ATLAS:function(){return RC},SMALL_INTERACTIVE_BUDGET:function(){return dM},SOLID_FACE_NODE_PROPERTIES:function(){return Ip},SOLID_FACE_NODE_PROPERTIES_TRANSPARENT:function(){return Op},SPACEMOUSE_ACTION_SET_CHANGED:function(){return VM.Fc},SPACEMOUSE_COMMAND:function(){return VM.RV},SPACEMOUSE_COMMANDS_RECEIVED:function(){return VM.TN},SVG_TOKENS_FOR_STYLE:function(){return Fl},ScalarRetrievalPass:function(){return bt},ScalarVisualizationLegend:function(){return dc},ScalarVisualizationManager:function(){return pc},ScalingManipulator:function(){return Zr},SceneGraph:function(){return nh},SceneGraphs:function(){return rh},ScreenFacingSpaceQuadGlyphComponent:function(){return ql},ScreenOccupancyMap:function(){return Vi},ScreenSpaceData:function(){return Ms.vjd},ScreenSpaceQuadGlyphComponent:function(){return Xl},SectionPlane:function(){return Na.O},SectionPlaneEndcapDrawPass:function(){return y},SectionPlaneEndcapDrawPasses:function(){return A},SectionPlaneEndcapMaskDrawPass:function(){return mt},SectionPlaneEndcapMaskPass:function(){return Fe},SectionViewState:function(){return QS.aA},SectionedItemType:function(){return QS.oj},SelectionIds:function(){return AT},SeparatedGaussianFilterBufferPass:function(){return _},SeparatedGaussianFilterPass:function(){return R},Settings:function(){return ua},ShaderProgram:function(){return wf},Silhouette:function(){return yI},SilhouettePass:function(){return Vt},SilhouetteTask:function(){return fI},SimpleBufferSet:function(){return ng},SimulationLegend:function(){return km},SimulationLoadDisplay:function(){return Vg},SimulationLoadDisplayGroup:function(){return Hg},SimulationLoadDisplayManager:function(){return kg},SimulationLoadGlyphResources:function(){return Wg},SimulationManager:function(){return Xm},Sketch:function(){return vs},SketchComponent:function(){return Yp},SketchComponentId:function(){return Zp},SketchPlaneDisplay:function(){return sM},SkipProgramsGLContext:function(){return SM},Slider:function(){return jg},SnapIndicator:function(){return fg},SpaceballConnection:function(){return Ua},SplineHandle:function(){return wc},StandardViews:function(){return rr},State:function(){return di},StateCachingGLContext:function(){return CM},StateRepeatingGLContext:function(){return TM},StencilMode:function(){return c},StencilRefMask:function(){return u},StencilRefValue:function(){return l},Style:function(){return fE},StyleMergeIterator:function(){return ME},StyleModificationOperator:function(){return sS},StyleModifierIterator:function(){return iS},StyleOverwriteIterator:function(){return nS},StyleOverwriteOperator:function(){return rS},StyleResetIterator:function(){return CE},StyleResetOperator:function(){return DE},StyleUnionIterator:function(){return gS},StyleUnionOperator:function(){return pS},StyledMeshRanges:function(){return PE},SubtractIterator:function(){return FS},SubtractMeshRanges:function(){return VS},SubtractOperator:function(){return XS},SwitchPass:function(){return I},TEMPORARY_SKETCH_COMPONENT_NODE_ID:function(){return _I},THICKNESS_ANALYSIS_COLOR_MAPPING_CHANGED:function(){return VM.d},THICKNESS_ANALYSIS_DISPLAYED_FIELD_CHANGED:function(){return VM.vu},THICKNESS_ANALYSIS_LEGEND_CLOSED:function(){return VM.aI},THICKNESS_ANALYSIS_LEGEND_OPENED:function(){return VM.Cv},THICKNESS_ANALYSIS_MAXIMUM_CLICKED:function(){return VM.vk},THICKNESS_ANALYSIS_MINIMUM_CLICKED:function(){return VM.YW},THICKNESS_ANALYSIS_RANGE_CHANGED:function(){return VM.WB},TINT_TEST_TYPE:function(){return Ce},TOOL_EDGE_PROPERTIES:function(){return sn},TOOL_FACE_PROPERTIES:function(){return tn},TRIANGLE_PROPERTIES:function(){return Il},TRUE_INT_UNIFORM:function(){return Tf},Tangent:function(){return tp},TaskManager:function(){return pM},TemporarySketchComponent:function(){return jp},Text:function(){return ba},Text2D:function(){return La},TextTexture:function(){return So},Texture:function(){return uo},TextureAtlas:function(){return bl},TextureDefinition:function(){return co},ThicknessAnalysisManager:function(){return sf},TimingDetails:function(){return ko},TintedPass:function(){return De},TogglePointsFeatureManipulator:function(){return wl.gm},ToolDisplay:function(){return nn},TrackedGraphicsComponents:function(){return uC},TranslucentPass:function(){return xe},TransparencySwitchPass:function(){return Be},TransparentFaceDepth:function(){return Gt},Triad:function(){return Yr._},TriadFeatureManipulator:function(){return wl.rY},UIElement:function(){return Ri},UISelection:function(){return wh.i},UISelectionManager:function(){return wh.z},UI_ELEMENT_CLICK:function(){return VM.fu},UNKNOWN_DEPTH:function(){return Js.BG},UNLIT_COLOR_FROM_ATTRIBUTE:function(){return Wi},UNLOADED_BODY_OPACITY_FACTOR:function(){return Xc},UPDATE_INCONTEXT_ISOLATION:function(){return VM.bh},UiEvents:function(){return Pi},UniformAttribRepeatingGLContext:function(){return MM},VIEWER_CANVAS_ATTACHED_TO_CONTAINER:function(){return VM.tS},VIEW_CONTAINER_MENU_INVOKED:function(){return VM.oL},VIEW_DID_DRAW:function(){return VM.u9},VIEW_MANIPULATOR_EVENT:function(){return vT},VIEW_WILL_DRAW:function(){return VM.Hv},VIEW_WILL_PICK:function(){return VM.b9},View:function(){return bs.G7},ViewController:function(){return hr},ViewFrustum:function(){return pr},ViewManipulator:function(){return JT},ViewManipulatorButtons:function(){return qT},Viewer:function(){return fT},ViewerUsage:function(){return ra},Visibility:function(){return Js.EE},WEBGL_ERROR_LOG_TAG:function(){return WM},WILL_RENDER_THUMBNAILS:function(){return VM.gV},XR_POINTER_TIP_Z_OFFSET:function(){return nD},XrCamera:function(){return Ah},XrCommentController:function(){return sD},XrController:function(){return tD},XrEventEnum:function(){return cD},XrGamepadButtonPressEvent:function(){return uD},XrInputDispatcher:function(){return pD},XrInputDisplay:function(){return hD},XrInputEvent:function(){return lD},XrLineMarkup:function(){return fD},XrMarkupController:function(){return ED},XrSelectionHandler:function(){return SD},XrTeleportPreview:function(){return DD},XrViewController:function(){return OD},Y_UP_TO_OS:function(){return PD},ZoomToWindowState:function(){return ch},activeViewerChanging:function(){return VM.FM},addByteColorToIncrement:function(){return Vu},addChildDebugObjectsFromProperties:function(){return Js.Ir},addColorToIncrement:function(){return Uu},addDebuggableChild:function(){return Js.n9},addDrawer:function(){return Js.jo},addHighlightToList:function(){return Fn},addLineToMesh:function(){return mu},addLinesToMesh:function(){return Eu},addNormalToIncrement:function(){return xu},addPackedIntegerToIncrement:function(){return Gu},addParentlessNode:function(){return Ji},addQuadToMesh:function(){return Fu},addSizeToIncrement:function(){return Hu},addStyleToIncrement:function(){return ku},addTextureCoordinateToIncrement:function(){return Bu},addTriangleNormals:function(){return id},afterPrint:function(){return ui.py},angleBetweenVectors:function(){return Li.FE},applySmoothEdgesRenderingStyleChanges:function(){return Tp},are2dPointsEqual:function(){return Li.tm},areAnySectionPlanesSelectedOrPreselected:function(){return QS.cP},areMatricesEqual:function(){return Li.cl},areTexturesPendingLoad:function(){return ho},areVectorsEqual:function(){return Li.nP},arraySubtract:function(){return Js.iq},beforePrint:function(){return ui.lp},binarySearchRanges:function(){return YI},bindTexture:function(){return go},buildFacesLinesPointsPasses:function(){return Me},buildHudPass:function(){return be},byteToMbString:function(){return Zc},cacheCapabilities:function(){return Js.B2},canPointBeDisplayed:function(){return Li.fB},ceilAwayFromZero:function(){return Li.S_},checkError:function(){return lC},clamp:function(){return Li.uZ},cleanUpParentlessNodes:function(){return es},clearPlaneEquationIds:function(){return ed},clearSavedSectionPlaneParameters:function(){return QS.ny},clearStencilBuffer:function(){return ut},clearStencilBufferBit:function(){return dt},cloneStyledRangeSet:function(){return mE},closestAngle:function(){return Li._k},closestAngleGreaterThanOrEqual:function(){return Li.Tu},closestAngleInRange:function(){return Li.Kf},closestAngleLessThanOrEqual:function(){return Li.Kb},closestPointOnLine:function(){return Li.vu},collectGraphicsDataForHeapDump:function(){return dC},compareOutlineNodeProperties:function(){return FC},concatenateFloat32Arrays:function(){return Js.Mz},concatenateUint8Arrays:function(){return Js.Lf},constituentTypeToString:function(){return Nh.IK},convertIntToUcharArray:function(){return Js.fA},convertRGBA255ToRGBA:function(){return Js.zF},convertRGBAToRGBA255:function(){return Js.Db},convertRGBToRGBA255:function(){return Js.C2},createAngularToolPreview:function(){return hn},createArc:function(){return Du},createArcPolyline:function(){return eo},createArrow:function(){return vu},createArrowPrimitives:function(){return Lr},createAtlasFromResources:function(){return Bl},createBox:function(){return bu},createCircle:function(){return Cu},createCirclePolyline:function(){return Ka},createConicPolyline:function(){return to},createDimensionForDisplayData:function(){return hE.j$},createDisc:function(){return Mu},createDoubleHeadArrow:function(){return Pu},createEdgesFromTriangleStrip:function(){return cu},createEdgesFromTriangles:function(){return lu},createEllipsePolyline:function(){return ja},createEntityMetaData:function(){return no},createInferenceIcon:function(){return bs.wg},createLine:function(){return pu},createLineLoop:function(){return fu},createLinearToolPreview:function(){return ln},createLines:function(){return Iu},createManipulator:function(){return wl.wA},createMateIndicator:function(){return sp},createMeshIncrementForEntityData:function(){return GI},createMeshIncrementForPolylineLines:function(){return ro},createOffsetTileViewportMatrix:function(){return Li.zD},createPickMatrix:function(){return Li.zL},createPoint:function(){return Su},createPolyline:function(){return so},createQuad:function(){return Ou},createQuadOutline:function(){return Ru},createRGBATexture:function(){return fo},createRing:function(){return yu},createRoundedRectangle:function(){return wu},createSplinePolyline:function(){return io},createTestViewer:function(){return IT},createTextCanvas:function(){return Oo},createTextDebugObject:function(){return Js.z4},createTextureFromText:function(){return Go},createTextureMaterial:function(){return Xi},createTileViewportMatrix:function(){return Li.vG},createTriangle:function(){return Au},createTriangleStrip:function(){return zu},createTriangles:function(){return Wu},createWireBox:function(){return Lu},crossProduct2d:function(){return Li.tV},database:function(){return oa},debugIdCount:function(){return bS},debugToPostOnLoad:function(){return nC},decodeAngle:function(){return Js.Pm},decodeDepth:function(){return Js.Rg},decodeFloat:function(){return Js.NP},decodePickingIndex:function(){return Js.EI},deselectEntities:function(){return bs.Wt},difference2d:function(){return Li.r7},disableSectionPlaneSelection:function(){return xD.ZB},displayCanvasInDom:function(){return xo},displayEntity:function(){return ao},distanceSquaredBetweenPoints:function(){return Li.B$},distanceSquaredToLineSegment2d:function(){return Li.o5},doesNodeContainPlaneEntities:function(){return HC},drawBackgroundIntoCanvas:function(){return Ro},drawBorderIntoCanvas:function(){return wo},drawTextIntoCanvas:function(){return bo},dumpShader:function(){return _f},enableSectionPlaneSelection:function(){return xD.G2},encodePickingIndex:function(){return Js.ow},ensureMateIndicatorResources:function(){return $l},ensureTextureAtlas:function(){return bs.bt},estimateTriangleCountAtSettingIndexUsingTriangleCounts:function(){return Nh.l_},executePerformanceTests:function(){return qf},extractPlaneFromMatrix:function(){return Li.sc},fillCanvasWithTransparentColor:function(){return yo},fillHighlightWithDefault:function(){return _n},fillInDefaultAttributes:function(){return wi},filterActiveSectionPlanes:function(){return QS.HX},filterEntitiesWithData:function(){return kI},findTextBounds:function(){return Bo},flipImageVertically:function(){return Js.Dy},floorTowardsZero:function(){return Li.Tc},forEachActiveSectionPlane:function(){return QS.Lz},forceRequestDraw:function(){return Js.tj},generateThumbnails:function(){return _a},getActiveSectionPlane:function(){return QS.tz},getActiveSectionViewState:function(){return QS.Ky},getActiveViewer:function(){return ui.uQ},getActiveViewerCanvasCoordinateFromEvent:function(){return ui.P6},getActiveViewerEventDispatcher:function(){return VM.xA},getActiveViewerHasSketch:function(){return ui.aN},getActiveViewerOccurrenceDataManager:function(){return ui.x},getActiveViewerSceneGraphs:function(){return ui.KX},getAlphaModifierFunction:function(){return tS},getAngle:function(){return Li._O},getAssemblyInContextElementId:function(){return Js.HL},getBitForPlaneEquation:function(){return Qu},getBitForPlaneEquationId:function(){return $u},getBlankCanvas:function(){return Mo},getBlendAmount:function(){return Nt},getChannelCountOfGlPixelFormat:function(){return Zt},getCirclePoints:function(){return Tu},getCollectionId:function(){return al},getColorFromDebugEntityColor:function(){return UI},getColorString:function(){return Js.o3},getColorStringArray:function(){return Js.p7},getCosineOfAngleBetweenTwoVectors:function(){return Li.g7},getCounters:function(){return Un.qn},getCurrentActiveViewerSet:function(){return gC.w5},getCurrentSectionPlaneParameters:function(){return QS.nL},getDataUri:function(){return Ra},getDefaultNameForBody:function(){return Nh.lv},getDisplayDataTimerLoggingOptions:function(){return ET},getDisplayedElementObservable:function(){return VM.v9},getDrawer:function(){return Js.HB},getDrawerForId:function(){return Js.Jb},getDrawers:function(){return Js.u4},getEditState:function(){return ks},getEntityPrimitiveType:function(){return HI},getEulerAnglesFromMatrix:function(){return Li.df},getExpressionType:function(){return hE._p},getFeatureThumbnailKey:function(){return Oa},getFocusedViewer:function(){return Ih.N9},getFramerateFromTime:function(){return Ho},getGLTarget:function(){return Xt},getGpuMemoryUsage:function(){return cC},getHasFeatureQLVFacePatternCapability:function(){return Js.XM},getHasLongPressHandlerCapability:function(){return Js.x4},getHudLayerDepthRange:function(){return yh},getIndexBufferType:function(){return oi},getIndexElementSize:function(){return ci},getIndexElementType:function(){return hi},getIntersectionParameters:function(){return Li.dm},getLatestDisplayDataUsage:function(){return Ks},getManipulatorDisplacementDisplayManager:function(){return ih},getMatrixFromEulerAngles:function(){return Li.Wm},getMaxSectionPlanes:function(){return QS.j1},getMaximumVerticesPerVbo:function(){return li},getMeshIncrementForEntityData:function(){return BI},getMostRecentActiveSectionPlaneParameters:function(){return QS.tb},getMouseSettingsManager:function(){return kM},getNewOwnerId:function(){return WS},getNextPowerOfTwo:function(){return Li.cP},getNodeProperties:function(){return TI},getObservableFromActiveViewerForEvent:function(){return VM.eR},getOrCreateViewerSet:function(){return gC.G$},getPartStudioThumbnailKey:function(){return ya},getPartThumbnailKey:function(){return Aa},getPartstudioElementIdFromContextId:function(){return Js.dV},getPerpendicularBisector2d:function(){return Li.eB},getPickUsage:function(){return qs},getPlaneEquationColor:function(){return Ju},getPlaneEquationId:function(){return ju},getPlaneIndexToAlignNormalTo:function(){return QS.qT},getPointAtAngle:function(){return Li.iD},getPreviewAlpha:function(){return zs},getPrimitiveTypeDescription:function(){return _i.E1},getRendererInfo:function(){return Qt},getScaleFromMatrix:function(){return Li.g9},getSceneGraphIdForUsage:function(){return ah},getScratchSpace:function(){return SS},getSectionPlaneCount:function(){return QS.ti},getSectionPlaneOccurrenceIds:function(){return QS.WC},getSectionedItemsSize:function(){return QS.rv},getSelectedSectionPlane:function(){return Na.C},getSerializablePlaneData:function(){return QS.OR},getSerializableSectionViewData:function(){return QS.p$},getSerializableSectionViewDataWithPersistentQueries:function(){return QS.bm},getSettingsKey:function(){return aa},getShaderIdWithExtension:function(){return Af},getSilhouetteIncrement:function(){return mI},getSilhouettesId:function(){return pI},getStaticIncrements:function(){return vl},getTagIntCount:function(){return Js.q7},getTestingBuffers:function(){return fS},getTextureSize:function(){return mo},getThumbnailForKey:function(){return Ma},getTimeElapsed:function(){return Js.Es},getTimeInMilliseconds:function(){return Js.Wj},getTransparencyTransition:function(){return Qe},getUnavailableRendererInfo:function(){return Kt},getUnitBoxIncrement:function(){return tl},getUtilityContext:function(){return Do},getViewerFitPoints:function(){return wa},getViewerForDebugOrTestPurposes:function(){return ui.f1},getXrSystem:function(){return yD},getZoomModeEnabled:function(){return dh},getZoomToWindowState:function(){return lh},graphicsTakesSelectionPrecedence:function(){return Js.Ec},hasSpaceballConnected:function(){return Wa},hashPoint:function(){return qu},hashXYZ:function(){return Zu},hidePartNodesThatDoNotAddToBoundsFilter:function(){return ne},hideSectionPlaneFromPick:function(){return QS.Mi},highlightsEqual:function(){return wn},idFromString:function(){return Di.UQ},idIsValid:function(){return Di.rp},idsEqual:function(){return Di.nD},imageCaptureToJpeg:function(){return Js.Z$},inZoom:function(){return ph},incrementListenerIdCounter:function(){return NS},initialize32BitIndexSupport:function(){return ai},initializePreviousVersionViewer:function(){return gC.fT},initializeSpaceballConnection:function(){return Ha},insertRange:function(){return KI},insertRangeStartEnd:function(){return QI},insertStyledRange:function(){return dE},interpolateInArray:function(){return Li.HO},intersectLineSegmentRay:function(){return Li.wd},intersectRayBox:function(){return Li.Lr},intersectRayPlane:function(){return Li.fE},intersectRayPlaneMatrix:function(){return Li.bZ},intersectRaySphere:function(){return Li.ss},intersectRayTriangle:function(){return Li.AF},intersectTwoLineSegments2d:function(){return Li.u3},intersectTwoLines2d:function(){return Li.TE},intervalsOverlap:function(){return Li.Ao},isCpuRenderer:function(){return Yt},isFeatureIdCompound:function(){return WI},isFinite:function(){return Li.xV},isFiniteVector:function(){return Li.Cu},isHighPrecisionFragmentShaderSupported:function(){return Js.J5},isIdValid:function(){return DI.$J},isInFollowMode:function(){return Js.sW},isInSectionPlaneMode:function(){return Js.SU},isMapEmpty:function(){return Js.hW},isMatrixIdentity:function(){return Li.n_},isNodeForDecal:function(){return Gd},isNodeForSurfaceBody:function(){return Lp},isOccurrenceNameForUi:function(){return ZI},isOrderIndependentTransparencyEnabled:function(){return Js.Z},isRendererStringForDedicatedIntel:function(){return ei},isRendererStringForIntel:function(){return Jt},isRetrievalDebuggingEnabled:function(){return qc},isRunningIntelGpu:function(){return $t},isSSAOSupported:function(){return Js.pc},isSceneDebuggerWindowLoaded:function(){return sC},isSectionPlaneModeEnabled:function(){return QS.eQ},isSpaceballSupported:function(){return Js.CF},isTrimetricCorner:function(){return OT},isUnitVector:function(){return Li.jP},isUsageBase:function(){return Zs},isUsageCompare:function(){return Ys},isUsagePreview:function(){return js},isUsagePreviewAfter:function(){return Qs},isUsagePreviewFinal:function(){return $s},isValidForBounding:function(){return Li.rQ},lastFrameTimeRendering:function(){return oC},loadAndApplySectionViewState:function(){return QS.Wh},loadSectionPlanesFromParameters:function(){return QS.F6},log:function(){return na},logToInfo:function(){return sa},makeBufferedNormalDepthPass:function(){return U},makeBufferedNormalDepthWithMaskPass:function(){return Le},makeBufferedPass:function(){return C},makeCone:function(){return gu},makeCylinder:function(){return du},makeDepthClearPass:function(){return G},makeFullId:function(){return LE},makeId:function(){return Di.qR},makePlaneEquationMatrixDirty:function(){return QS.qf},makeRoundedRectanglePath:function(){return _o},makeSSAOPass:function(){return Te},makeSceneDebugObjectFromObject:function(){return Js.bN},makeSphere:function(){return uu},measureTextWidth:function(){return Ao},merge:function(){return SE},mix:function(){return Li.CD},nextOwnerId:function(){return kS},normalDepthClearColor:function(){return B},numberToFixedPointString:function(){return Xu},numberToPrimitiveType:function(){return _i.JB},occurrenceSortFunction:function(){return sl},off:function(){return $o},on:function(){return Qo},onViewerDraw:function(){return za},orientText:function(){return Lo},outlineNodeProperties:function(){return LC},packedNormalsToFloatArray:function(){return Li.w5},pickFromPreview:function(){return Xs},planeToWorld:function(){return Li.qm},prepareShaderCode:function(){return yf},preserveViewersForDocumentId:function(){return gC.cv},projectToLine:function(){return Li.WW},projectWorldToPlane:function(){return Li.Oh},recordWebClientCapabilities:function(){return pC},registerDragHelper:function(){return ys},releaseScratchSpace:function(){return TS},removeDrawer:function(){return Js.Dz},removeGraphicsViewers:function(){return gC.jB},removeHighlightFromList:function(){return xn},removeRange:function(){return $I},removeSectionPlane:function(){return QS.v5},removeSectionPlanes:function(){return QS.UB},removeStyledRange:function(){return gE},removeThumbnailForKey:function(){return Da},requestDraw:function(){return Js.vm},requestDrawForInteractiveProcessing:function(){return Js.et},requestDrawUsingAnimationFrame:function(){return Js.HK},requestDrawUsingTimer:function(){return Js.Sd},resetSectionPlanesHiddenFromPick:function(){return QS.X9},resetSharedOperators:function(){return dS},resetStaticSilhouetteState:function(){return II},resetUsage:function(){return Ws},retrieveViewportAsImage:function(){return ui.Xs},saveAndClearSectionViewState:function(){return QS.o_},sceneDebuggerWindow:function(){return iC},scratchSpaces:function(){return ES},sectionPlaneSelectionDisabled:function(){return xD.X5},setBaseHighlightsEnabled:function(){return ui.GB},setBoxSelectionEnabled:function(){return fn},setDimensionToolActive:function(){return hE.io},setFocusedViewer:function(){return Ih.KO},setForceHideInteriorSelections:function(){return ui.iM},setForcePredictableHatching:function(){return QS.jf},setFromSerializablePlaneData:function(){return QS.Rb},setFromSerializableSectionViewData:function(){return QS.rH},setIncrementOpacity:function(){return td},setInteractionEnabled:function(){return hE.Jq},setIsInFollowMode:function(){return Js.NC},setIsInSectionPlaneMode:function(){return Js.km},setOrderIndependentTransparencyEnabled:function(){return Js.uP},setPartThumbnailNeedsToBeRerendered:function(){return Ta},setRefinementMode:function(){return kc},setRendererInfo:function(){return _h.Vp},setRetinaDisplayMode:function(){return _h.Xd},setSectionEntitiesEnabled:function(){return QS.CF},setSectionPlaneOnMateConnector:function(){return QS.hJ},setSectionPlaneOnMatrix:function(){return QS.N3},setSerializableDataDirty:function(){return QS.P_},setShowDimensionsMode:function(){return hE.CO},setSketchNeedsThumbnail:function(){return va},setSubtract:function(){return Js.R},setTestingBuffers:function(){return IS},setThumbnailForKey:function(){return Ca},setTransparencyTransition:function(){return je},setViewCubeMenuMgrInstance:function(){return yT},setZoomModeEnabled:function(){return gh},setupContextForText:function(){return vo},setupDatabase:function(){return ha},setupStencilForTestAndWrite:function(){return lt},setupStencilForTestWithoutWrite:function(){return ht},setupStencilForWriteWithoutTest:function(){return ct},shaderExistsForId:function(){return Rf},sign:function(){return Sr.sign},sizeOfGlRenderBufferType:function(){return qt},sizeOfGlType:function(){return zt},sketchinformation:function(){return zn},smoothstep:function(){return Li.CW},snapshotScenegraph:function(){return aC},sortHighlights:function(){return Nn},spliceRangesFromArray:function(){return JI},stopActionController:function(){return ka},styleMapsEqual:function(){return IE},stylesEqual:function(){return EE},tessellateArc:function(){return Ja},timeRendering:function(){return hC},toDegrees:function(){return Li.Ux},toRadians:function(){return Li.Yr},toRotationMat:function(){return Li.iM},toString:function(){return pE},toggleZoomModifierEnabled:function(){return uh},unbindTexture:function(){return po},unitBoxIncrement:function(){return el},unprojectPlaneToWorld:function(){return Li.KU},unprojectVectorToWorld:function(){return Li.$o},updateAutoSetting:function(){return _h.HN},updateMateConnectorSelectedColor:function(){return Pl},updateShaderClippingUniforms:function(){return QS.qS},updateShaderEndcapPatternUniforms:function(){return QS.cV},updateShaderEndcapPickingUniforms:function(){return QS.fI},updateShaderEndcapUniforms:function(){return QS.le},userWebPreferencesGetManager:function(){return Vn.t},vec4FromVec3:function(){return Li.Ot},viewCubeMenuMgrInstance:function(){return PT},viewManipulationSettingsGetManager:function(){return uE},viewerCheck:function(){return Ih.Yk},visibilityDescriptor:function(){return Js._I},visualizeCoordinateSystem:function(){return eC},visualizeDebugBox:function(){return $M},visualizeDebugPoint:function(){return QM},visualizeLine:function(){return JM},visualizePicks:function(){return tC},visualizeVisiblePicks:function(){return XM},worldToPlane:function(){return Li.LK},zeroOutArrayBuffer:function(){return Js.rS}});var s,n,r,a,o,h,c,l,u,d,g,p,m=i(32435);!function(e){e[e.POINTS=0]="POINTS",e[e.EDGES=1]="EDGES",e[e.FACES=2]="FACES",e[e.SILHOUETTES=3]="SILHOUETTES"}(s||(s={})),function(e){e[e.BLEND_ONLY=0]="BLEND_ONLY",e[e.NON_BLEND_ONLY=1]="NON_BLEND_ONLY",e[e.ALL=2]="ALL"}(n||(n={})),function(e){e.ACCUMULATION="Accumulation",e.REVEALAGE="Revealage"}(r||(r={})),function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.ALL=2]="ALL"}(a||(a={})),function(e){e[e.VISIBLE=0]="VISIBLE",e[e.SHOWTHROUGH=1]="SHOWTHROUGH"}(o||(o={})),function(e){e[e.OPAQUE=0]="OPAQUE",e[e.ZEBRA_STRIPES=1]="ZEBRA_STRIPES",e[e.DRAFT=2]="DRAFT",e[e.QUALITY_VISUALIZATION=3]="QUALITY_VISUALIZATION"}(h||(h={})),function(e){e[e.WRITE_EDGES_AND_POINTS=0]="WRITE_EDGES_AND_POINTS",e[e.TEST_EDGES_AND_POINTS=1]="TEST_EDGES_AND_POINTS",e[e.WRITE_AND_TEST_FACES=2]="WRITE_AND_TEST_FACES",e[e.OFF=3]="OFF"}(c||(c={})),function(e){e[e.LOW_PRIORITY_EDGES=1]="LOW_PRIORITY_EDGES",e[e.EDGES=2]="EDGES",e[e.POINTS=4]="POINTS",e[e.FACES=8]="FACES"}(l||(l={})),function(e){e[e.EDGES=3]="EDGES",e[e.POINTS=4]="POINTS",e[e.FACES=8]="FACES"}(u||(u={})),function(e){e[e.OVER_WITH_SEPARATE_ALPHA=0]="OVER_WITH_SEPARATE_ALPHA",e[e.ADD=1]="ADD"}(d||(d={})),function(e){e[e.NEVER=512]="NEVER",e[e.LESS=513]="LESS",e[e.EQUAL=514]="EQUAL",e[e.LEQUAL=515]="LEQUAL",e[e.GREATER=516]="GREATER",e[e.NOTEQUAL=517]="NOTEQUAL",e[e.GEQUAL=518]="GEQUAL",e[e.ALWAYS=519]="ALWAYS"}(g||(g={}));class f extends m.T{constructor(e,t){super(),this.viewer=e,this.childPasses=null,this.shaderTag=null,this.inputs={},this.enabled=!0,this.checkFrameId=!1,this.hideSelectionInterior=!1,(0,Ih.Yk)(e),this.parentPass=t,this.lastRenderedFrame=sE}reloadShaders(){if(this.shader&&this.viewer&&(this.shader=this.viewer.getShader(this.shader.getId())),this.childPasses)for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].reloadShaders();Object.values(this.inputs).forEach((function(e){e.reloadShaders()}))}prepareShaders(){if(!this.shader&&this.getEnabled()&&this.viewer){if(this.usesShader()&&this.initializeShader(),this.childPasses)for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].prepareShaders();Object.values(this.inputs).forEach((function(e){e.prepareShaders()}))}}usesShader(){return!1}initializeShader(){this.shader||(this.shader=this.viewer.getShader(this.getShaderId()))}setShaderUniform(e,t){if(this.childPasses)for(let i=0;i<this.childPasses.length;++i)this.childPasses[i].setShaderUniform(e,t)}onSessionEnded(){this.stopListening()}destroy(){if(this.onSessionEnded(),this.childPasses)for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].destroy(),this.childPasses[e]=null;this.childPasses=null;for(const e in this.inputs)this.inputs[e].destroy(),this.inputs[e]=null;this.inputs=null,this.parentPass=null}setEnabled(e){this.enabled=e}getEnabled(){return this.enabled}setCheckFrameId(e){this.checkFrameId=e}getSceneGraph(){return this.parentPass?this.parentPass.getSceneGraph():this.viewer.getSceneGraphs().getMainSceneGraph()}getLastRenderedFrame(){return this.lastRenderedFrame}setInput(e,t){this.inputs[e]=t}drawInputs(e){if(this.getEnabled()){if(this.childPasses)for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].drawInputs(e);Object.values(this.inputs).forEach((function(t){t.drawInputs(e),t.draw(e)}))}}preDraw(e){return(0,Ih.Yk)(this.viewer),(!this.checkFrameId||e.getFrameId()!==this.lastRenderedFrame)&&(this.lastRenderedFrame=e.getFrameId(),!0)}justBeforeDraw(e){this.parentPass&&this.parentPass.justBeforeDraw(e)}postDraw(e){}onShaderActivated(e,t){}justAfterDraw(e){this.parentPass&&this.parentPass.justAfterDraw(e)}draw(e){if(!this.getEnabled())return;const t=this;if(this.childPasses||this.getSceneGraph().passesNodeFilter((function(e){return t.nodeFilter(e)})))if(e.setActivePass(this),e.getState().capture(),this.preDraw(e)){if(this.childPasses)for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].draw(e);else this.justBeforeDraw(e),this.getSceneGraph().draw(e),this.justAfterDraw(e);this.postDraw(e),e.getState().restore()}else e.getState().restore()}isPickPass(){return!!this.parentPass&&this.parentPass.isPickPass()}isHighlightPass(){return!!this.parentPass&&this.parentPass.isHighlightPass()}getActiveHighlightType(){return this.parentPass?this.parentPass.getActiveHighlightType():null}isShowthroughPass(){return!!this.parentPass&&this.parentPass.isShowthroughPass()}testIsolation(e){return!1}forIsolate(){return!this.parentPass||this.parentPass.forIsolate()}forSectionPlaneEndcapMask(){return!!this.parentPass&&this.parentPass.forSectionPlaneEndcapMask()}getShaderId(){let e="";return this.parentPass&&(e=this.parentPass.getShaderId()),this.shaderTag&&(e+="-"+this.shaderTag),e}needsAttribute(e){return!!this.parentPass&&this.parentPass.needsAttribute(e)}getPickIteration(){return this.parentPass?this.parentPass.getPickIteration():-1}nodeFilter(e){return!this.parentPass||this.parentPass.nodeFilter(e)}addChildPass(e){this.childPasses||(this.childPasses=[]),this.childPasses.push(e)}getChildPass(e){return this.childPasses&&e<this.childPasses.length?this.childPasses[e]:null}getChildPassCount(){return this.childPasses?this.childPasses.length:0}setBlendFilter(e){for(let t=0;this.childPasses&&t<this.childPasses.length;++t)this.childPasses[t].setBlendFilter(e)}getPerformIsolationTest(){for(let e=0;this.childPasses&&e<this.childPasses.length;++e)if(this.childPasses[e].getPerformIsolationTest())return!0;return!1}setPerformIsolationTest(e){for(let t=0;this.childPasses&&t<this.childPasses.length;++t)this.childPasses[t].setPerformIsolationTest(e)}setHideSelectionInterior(e){this.hideSelectionInterior=e}createExcludeForNonBodyFilter(e){const t=this.viewer.getModelViewManagers().getManager();return i=>i.getParent()&&t.isNodeForBody(i.getParent(),e)}createExcludeForNonBodyFilterNoDecals(e){const t=this.viewer.getModelViewManagers().getManager();return i=>i.getParent()&&t.isNodeForBody(i.getParent(),e)&&!Gd(i)}createOnlyDecalsFilter(){const e=this.viewer.getModelViewManagers().getManager();return t=>t.getParent()&&e.isNodeForBody(t.getParent())&&Gd(t)}createExcludeForBodyFilter(){const e=this.viewer.getModelViewManagers().getManager();return t=>t.getParent()&&!e.isNodeForBody(t.getParent())}needsFaceAppearances(){return!0}setNodeOccurrenceFilterFunction(e){if(this.childPasses)for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].setNodeOccurrenceFilterFunction(e)}onAppearanceConstantsUpdated(){if(this.childPasses)for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].onAppearanceConstantsUpdated()}}class I extends f{constructor(e,t,i,s){super(e,null),this.pass1=t,this.pass2=i,this.predicate=s,this.childPasses=[this.pass1,this.pass2]}setInput(e,t){this.pass1.setInput(e,t),this.pass2.setInput(e,t)}prepareShaders(){this.predicate()?this.pass1.prepareShaders():this.pass2.prepareShaders()}drawInputs(e){this.predicate()?this.pass1.drawInputs(e):this.pass2.drawInputs(e)}preDraw(e){return this.predicate()?this.pass1.preDraw(e):this.pass2.preDraw(e)}justBeforeDraw(e){this.predicate()?this.pass1.justBeforeDraw(e):this.pass2.justBeforeDraw(e)}postDraw(e){this.predicate()?this.pass1.postDraw(e):this.pass2.postDraw(e)}justAfterDraw(e){this.predicate()?this.pass1.justAfterDraw(e):this.pass2.justAfterDraw(e)}draw(e){this.predicate()?this.pass1.draw(e):this.pass2.draw(e)}setEnabled(e){this.pass1.setEnabled(e),this.pass2.setEnabled(e)}destroy(){this.pass1.destroy(),this.pass2.destroy()}setCheckFrameId(e){this.pass1.setCheckFrameId(e),this.pass2.setCheckFrameId(e)}getSceneGraph(){return this.predicate()?this.pass1.getSceneGraph():this.pass2.getSceneGraph()}isPickPass(){return this.predicate()?this.pass1.isPickPass():this.pass2.isPickPass()}isHighlightPass(){return this.predicate()?this.pass1.isHighlightPass():this.pass2.isHighlightPass()}getActiveHighlightType(){return this.predicate()?this.pass1.getActiveHighlightType():this.pass2.getActiveHighlightType()}isShowthroughPass(){return this.predicate()?this.pass1.isShowthroughPass():this.pass2.isShowthroughPass()}forIsolate(){return this.predicate()?this.pass1.forIsolate():this.pass2.forIsolate()}getShaderId(){return this.predicate()?this.pass1.getShaderId():this.pass2.getShaderId()}needsAttribute(e){return this.predicate()?this.pass1.needsAttribute(e):this.pass2.needsAttribute(e)}getPickIteration(){return this.predicate()?this.pass1.getPickIteration():this.pass2.getPickIteration()}nodeFilter(e){return this.predicate()?this.pass1.nodeFilter(e):this.pass2.nodeFilter(e)}setNodeFilter(e){this.pass1.setNodeFilter(e),this.pass2.setNodeFilter(e)}setExtraMeshNodeFilter(e){this.pass1.setExtraMeshNodeFilter(e),this.pass2.setExtraMeshNodeFilter(e)}setBlendFilter(e){this.pass1.setBlendFilter(e),this.pass2.setBlendFilter(e)}setSceneGraph(e){this.pass1.setSceneGraph(e),this.pass2.setSceneGraph(e)}setEnableColorWrites(e){this.pass1.setEnableColorWrites(e),this.pass2.setEnableColorWrites(e)}setOpacity(e){this.pass1.setOpacity(e),this.pass2.setOpacity(e)}setDrawHidden(e){this.pass1.setDrawHidden(e),this.pass2.setDrawHidden(e)}setDrawBackFaceSilhouettes(e){this.pass1.setDrawBackFaceSilhouettes(e),this.pass2.setDrawBackFaceSilhouettes(e)}setMaskOpaqueFaces(e){this.pass1.setMaskOpaqueFaces(e),this.pass2.setMaskOpaqueFaces(e)}getLastRenderedFrame(){return this.predicate()?this.pass1.getLastRenderedFrame():this.pass2.getLastRenderedFrame()}setHideSelectionInterior(e){this.pass1.setHideSelectionInterior(e),this.pass2.setHideSelectionInterior(e)}getPerformIsolationTest(){return this.pass1.getPerformIsolationTest()||this.pass2.getPerformIsolationTest()}setPerformIsolationTest(e){this.pass1.setPerformIsolationTest(e),this.pass2.setPerformIsolationTest(e)}needsFaceAppearances(){return this.predicate()?this.pass1.needsFaceAppearances():this.pass2.needsFaceAppearances()}onAppearanceConstantsUpdated(){this.predicate()?this.pass1.onAppearanceConstantsUpdated():this.pass2.onAppearanceConstantsUpdated()}}!function(e){e[e.BLEND_ALL=0]="BLEND_ALL",e[e.BLEND_ALPHA=1]="BLEND_ALPHA",e[e.BLEND_OFF=2]="BLEND_OFF"}(p||(p={}));class E extends f{constructor(e){super(e,null),this.blendMode=p.BLEND_ALL}usesShader(){return!0}preDraw(e){this.initializeShader(),e.getState().capture();const t=this.viewer.getGlContext();switch(this.blendMode){case p.BLEND_ALL:t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case p.BLEND_ALPHA:t.enable(t.BLEND),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case p.BLEND_OFF:t.disable(t.BLEND)}t.disable(t.DEPTH_TEST),e.getState().callGl("depthMask",!1),e.activateShader(this.shader);const i=this;return Object.entries(this.inputs).forEach((([e,t])=>{i.shader.useTexture(e,t.getColorTexture())})),e.nodeFilter=function(e){return!0},!0}drawBlitNodes(e){this.viewer.getResources().getBlitNode().draw(e)}draw(e){this.enabled&&(e.setActivePass(this),this.preDraw(e)&&(this.justBeforeDraw(e),this.drawBlitNodes(e),this.justAfterDraw(e),this.postDraw(e)))}postDraw(e){const t=this.viewer.getGlContext();t.disable(t.BLEND),t.enable(t.DEPTH_TEST),e.getState().restore()}}class S extends E{constructor(e,t,i){super(e),i=i||{},this.shaderTag=i.shaderTag?i.shaderTag:"drawTexture",this.inputs.uTexture=t,this.performDrawInputs=void 0!==i.performDrawInputs,this.viewport=i.viewport}drawInputs(e){}preDraw(e){return this.performDrawInputs&&super.drawInputs(e),this.viewport&&e.pushViewport(this.viewport),!!super.preDraw(e)||(this.viewport&&e.popViewport(),!1)}postDraw(e){this.viewport&&e.popViewport(),super.postDraw(e)}}class T extends E{constructor(e,t){super(e),this.frameBuffer=t,this.shaderTag="drawTexture"}preDraw(e){this.initializeShader(),e.getState().capture();const t=this.viewer.getGlContext();return t.disable(t.BLEND),e.getState().callGl("depthMask",!1),e.activateShader(this.shader),this.shader.useTexture("uTexture",this.frameBuffer.getTexture()),e.nodeFilter=function(){return!0},!0}}class M extends f{constructor(e,t){super(e,null),this.clearColor=[0,0,0,0],this.viewportScale=1,this.checkFrameId=!0,this.frameBuffer=null;let i=!0;t&&(this.id=t.id,i=!t.hasOwnProperty("makeFrameBuffer")||!!t.makeFrameBuffer),this.makeFrameBuffer=!!i;const s=this.viewer.getGlContext();i&&s&&this.initializeFrameBuffer(s),this.listenTo(this.viewer.getEventDispatcher(),VM.pO,this.onGlContextRestored),this.listenTo(this.viewer.getEventDispatcher(),VM.so,this.onSessionEnded)}onGlContextRestored(e){!this.frameBuffer&&this.makeFrameBuffer&&this.initializeFrameBuffer(e),this.resetBuffer()}getColorTexture(){return this.colorTexture}getWidth(){var e;return null===(e=this.frameBuffer)||void 0===e?void 0:e.getWidth()}getHeight(){var e;return null===(e=this.frameBuffer)||void 0===e?void 0:e.getHeight()}initializeFrameBuffer(e){this.frameBuffer=this.viewer.getOrCreateFrameBuffer(this.textureType?this.textureType:e.UNSIGNED_BYTE,this.id,{storageType:this.storageType?this.storageType:e.DEPTH_STENCIL,attachmentType:this.attachmentType?this.attachmentType:e.DEPTH_STENCIL_ATTACHMENT})}resetBuffer(){var e;null===(e=this.frameBuffer)||void 0===e||e.resetBuffer()}preDraw(e){var t,i,s;if(!super.preDraw(e))return!1;if(1!==this.viewportScale){const t=e.getViewport().slice(0);t[2]=Math.max(1,Math.floor(t[2]*this.viewportScale)),t[3]=Math.max(1,Math.floor(t[3]*this.viewportScale)),e.pushViewport(t)}null===(t=this.frameBuffer)||void 0===t||t.update(e),this.colorTexture=null===(i=this.frameBuffer)||void 0===i?void 0:i.getTexture();const n=this.viewer.getGlContext();return this.oldBufferBinding=n.getParameter(n.FRAMEBUFFER_BINDING),null===(s=this.frameBuffer)||void 0===s||s.bindBuffer(),this.clearBuffer(e),!0}clearBuffer(e){const t=this.viewer.getGlContext();t.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),t.clearStencil(0),t.stencilMask(255),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT)}postDraw(e){1!==this.viewportScale&&e.popViewport();const t=this.viewer.getGlContext();t.bindFramebuffer(t.FRAMEBUFFER,this.oldBufferBinding?this.oldBufferBinding:null)}getFrameBuffer(){return this.frameBuffer}setFrameBuffer(e){this.frameBuffer=e}}function C(e,t,i,s){const n=new M(e,{id:s});return n.childPasses=[t],n.viewportScale=i,n}var D,v=i(96265),P=i(94128);class y extends E{constructor(e,t,i,s,n){super(e),this.shaderTag="endcap",this.forDepthTesting=!1,this.parentPass=t,this.planeIndex=i,this.inputs.uEndcapMaskTexture=s,n&&(this.inputs.uEdgeDetectTexture=n)}setEndcapMaskPass(e){this.inputs.uEndcapMaskTexture=e}getEnabled(){return!!super.getEnabled()&&(0,QS.ti)()>this.planeIndex}isFacingTheViewer(e){const t=e.getActiveCamera().getForward(),i=(0,QS.tz)(this.planeIndex).normal;return v.dot(t,i)<0}preDraw(e){return!((0,QS.ti)()<=this.planeIndex||this.isFacingTheViewer(e)||!this.inputs.uEndcapMaskTexture.getColorTexture())&&(!!super.preDraw(e)&&(e.setOverrideFaceCullingMode(Rh.NONE),!0))}justBeforeDraw(e){super.justBeforeDraw(e);const t=this.viewer.getGlContext();this.inputs.uEdgeDetectTexture&&e.detailSettings.enableSectionPlaneEdgeDetection||this.shader.useBlankTexture("uEdgeDetectTexture"),this.shader.uniformMatrix4fv("uPMatrix",!1,e.getProjectionMatrix());const i=P.create();i[this.planeIndex]=1,this.shader.uniform4fv("uPlaneSelector",i);const s=e.getActiveCamera().getSceneBounds().diameter();this.shader.uniform1f("uSceneDiameter",s),(0,QS.qS)(this.viewer,!0),(0,QS.le)(e,this.planeIndex),this.isPickPass()?(this.shader.uniform4fv("uPickRect",this.parentPass.pickRect),this.shader.uniform2f("uPickRectScale",this.parentPass.pickRect[2]/this.parentPass.pickViewportWidthHeight[0],this.parentPass.pickRect[3]/this.parentPass.pickViewportWidthHeight[1]),this.shader.uniform2f("uMaskTextureDimensions",this.inputs.uEndcapMaskTexture.getWidth(),this.inputs.uEndcapMaskTexture.getHeight()),(0,QS.fI)(e,this.planeIndex),t.disable(t.BLEND)):(0,QS.cV)(e,this.planeIndex),t.enable(t.DEPTH_TEST)}draw(e){if(!this.enabled)return;if(e.setActivePass(this),!this.preDraw(e))return;this.justBeforeDraw(e);const t=this.viewer.getGlContext();this.isPickPass()||(ct(t,l.LOW_PRIORITY_EDGES,u.EDGES),this.forDepthTesting||this.shader.uniform1f("uDiscardPatternBackground",1),t.colorMask(!1,!1,!1,!1),e.getState().callGl("depthMask",!1),this.drawBlitNodes(e),t.colorMask(!0,!0,!0,!0),this.forDepthTesting||this.shader.uniform1f("uDiscardPatternBackground",0),t.disable(t.STENCIL_TEST)),e.getState().callGl("depthMask",!0),this.forDepthTesting&&t.colorMask(!1,!1,!1,!1),this.drawBlitNodes(e),this.justAfterDraw(e),this.postDraw(e)}postDraw(e){super.postDraw(e);const t=this.viewer.getGlContext();this.isPickPass()&&t.enable(t.BLEND),t.colorMask(!0,!0,!0,!0),e.clearOverrideFaceCullingMode()}}class A extends f{constructor(e,t,i,s){super(e,t),this.childPasses=[new y(e,t,0,i,s),new y(e,t,1,i,s),new y(e,t,2,i,s),new y(e,t,3,i,s)]}setEndcapMaskPass(e){for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].setEndcapMaskPass(e)}}class O extends E{constructor(e,t){super(e),this.shaderTag="edgeDetect",this.inputs.uSourceBuffer=t}justBeforeDraw(e){super.justBeforeDraw(e);const t=e.getViewport();this.shader.uniform2f("uPixelScale",1/t[2],1/t[3]),this.shader.uniform1f("uDoEdgeDetection",1)}}!function(e){e.X="X",e.Y="Y"}(D||(D={}));class R extends E{constructor(e,t,i){super(e),this.direction=i,this.shaderTag="gaussianFilter",this.inputs.uSourceBuffer=t}justBeforeDraw(e){super.justBeforeDraw(e);const t=e.getViewport();this.shader.uniform2f("uPixelScale",1/t[2],1/t[3]),this.direction===D.X?this.shader.uniform2f("uDirection",1,0):this.shader.uniform2f("uDirection",0,1)}}class w extends M{constructor(e,t){super(e,{id:"edgeDetectAndBlurPassBufferA"}),this.childPasses=[new O(e,t)]}}class _ extends M{constructor(e,t,i){super(e,{id:"edgeDetectAndBlurPassBufferB"}),this.childPasses=[new R(e,t,i)]}}class N extends M{constructor(e,t){super(e,{id:"edgeDetectAndBlurPassBufferA"}),this.edgeDetect=new w(e,t),this.filterX=new _(e,this.edgeDetect,D.X),this.filterY=new R(e,this.filterX,D.Y),this.childPasses=[this.filterY]}preDraw(e){return!!e.detailSettings.enableSectionPlaneEdgeDetection&&super.preDraw(e)}}class b extends f{constructor(e,t){super(e,t),this.previousModelViewMatrix=null,this.previousProjectionMatrix=null;const i=new H(this.viewer,this,{opacity:a.ALL});this.childPasses=[i]}getSceneGraph(){return this.viewer.getSceneGraphs().getHudModelSceneGraph()}preDraw(e){return this.previousModelViewMatrix=e.getModelViewMatrix(),this.previousProjectionMatrix=e.getProjectionMatrix(),e.popProjectionMatrix(),e.popModelViewMatrix(),!0}postDraw(e){e.pushModelViewMatrix(this.previousModelViewMatrix),e.pushProjectionMatrix(this.previousProjectionMatrix)}}class L extends f{constructor(e,t){let i;super(e,t);const s=new Ne(this.viewer,this,null,_e.HUD,!0);for(this.childPasses=[],this.childPasses.push(s.opaqueFaces),this.childPasses.push(new b(this.viewer,this)),this.childPasses.push(s.nonOitTransparentFaces),this.childPasses.push(s.opaqueEdges),this.childPasses.push(s.opaquePoints),i=0;i<this.childPasses.length;++i){const e=this.childPasses[i];e instanceof se&&(e.clipToSectionPlanes=!1)}this.childPasses.push(s.showThroughStencilTested),this.childPasses.push(s.showThroughNotStencilTested)}getSceneGraph(){return this.viewer.getSceneGraphs().getHudSceneGraph()}preDraw(e){const t=this.viewer.getGlContext();t.clear(t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT);const i=this.isPickPass()&&this.parentPass&&this.parentPass.oldViewport&&this.parentPass.pickRect;let s,n,r,a,o=i?this.parentPass.oldViewport:e.getViewport();const h=e.getActiveCamera(),c=h.getTileViewport();let l;i?l=this.parentPass.pickRect:c&&(l=c,o=h.getViewport(!0)),l?(s=l[0],n=l[0]+l[2],r=o[3]-(l[1]+l[3]),a=o[3]-l[1]):(s=o[0],n=o[0]+o[2],r=o[1],a=o[1]+o[3]);const u=yh(o),d=new Ph({eye:[0,0,0],direction:[0,0,-1],up:[0,1,0],left:s,right:n,bottom:r,top:a,near:u[0],far:u[1]});return e.pushModelViewMatrix(d.getViewMatrix()),e.pushProjectionMatrix(d.getProjectionMatrix()),!0}postDraw(e){e.popProjectionMatrix(),e.popModelViewMatrix()}}class F extends f{constructor(e,t){super(e,null),this.component=t,this.applyTranslucentAlphaToAll=!1,this.sceneGraph=null,this.tintColor=[1,1,1],this.tintFactor=0,this.performIsolationTest=!1,this.shaderTag="OIT"+t,this.blendFilter=n.ALL}usesShader(){return!0}preDraw(e){this.initializeShader();const t=this.viewer.getGlContext();e.setMaterial(),e.activateShader(this.shader);const i=this;return e.nodeFilter=function(e){if(e.getIsShowThrough()||!e.getIsDepthTested())return!1;if(i.blendFilter===n.BLEND_ONLY){if(!e.getIncludedInBlend())return!1}else if(i.blendFilter===n.NON_BLEND_ONLY&&e.getIncludedInBlend())return!1;return!(!i.applyTranslucentAlphaToAll||!e.isFaces())||!(i.extraMeshNodeFilter&&!i.extraMeshNodeFilter(e))&&!(!e.isFaces()||!e.hasTransparency())},e.getState().callGl("depthMask",!1),this.component===r.ACCUMULATION?t.blendFunc(t.ONE,t.ONE):t.blendFunc(t.ZERO,t.ONE_MINUS_SRC_ALPHA),this.applyTranslucentAlphaToAll?t.disable(t.DEPTH_TEST):t.enable(t.DEPTH_TEST),t.enable(t.BLEND),!0}onShaderActivated(e,t){if((0,QS.qS)(this.viewer,!0),t.uniform1i("uApplyTranslucentAlphaToAll",this.applyTranslucentAlphaToAll?1:0),t.uniform1i("uHideSelectionInterior",this.hideSelectionInterior?1:0),t.uniform1f("uTintFactor",this.tintFactor),t.uniform3fv("uTintColor",this.tintColor),this.testIsolation(e)?t.uniform1f("uIsolationSelector",this.forIsolate()?1:0):t.uniform1f("uIsolationSelector",-1),this.component===r.ACCUMULATION){const e=this.viewer.getResources().getHighlightTexture();t.useTexture("uHighlightColorTexture",e),t.uniform1f("uHighlightColorTextureWidth",this.viewer.getReferenceHighlights().getHighlightTextureWidth())}}appliesTranslucentAlphaToAll(e){this.applyTranslucentAlphaToAll=e}setSceneGraph(e){this.sceneGraph=e}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}setBlendFilter(e){this.blendFilter=e}setExtraMeshNodeFilter(e){this.extraMeshNodeFilter=e}setTintColor(e){this.tintColor=e}setTintFactor(e){this.tintFactor=e}testIsolation(e){return this.performIsolationTest&&e.getHasIsolate()}}class x extends f{constructor(e){super(e,null),this.shaderTag="normalDepth",this.childPasses=[],this.points=[],this.scenegraph=null,this.opaqueFacePass=new se(this.viewer,this,{}),this.childPasses.push(this.opaqueFacePass)}setSceneGraph(e){this.sceneGraph=e,this.opaqueFacePass.setSceneGraph(e)}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}setOpacity(e){this.opaqueFacePass.setOpacity(e)}justBeforeDraw(e){const t=this.viewer.getGlContext();t.disable(t.BLEND),super.justBeforeDraw(e)}nodeFilter(e){const t=this.viewer.getModelViewManagers().getManager();return!!(!e.isMeshNode()||t.isNodeForModel(e)&&t.isNodeForFaces(e))&&e.getIsVisible()}}const B=[.5,.5,1,1];function U(e,t,i){const s=C(e,new x(e),t,i);return s.clearColor=B,s}class V extends f{constructor(e,t){super(e,t),this.childPasses=[]}preDraw(e){const t=this.viewer.getGlContext();return t.clear(t.DEPTH_BUFFER_BIT),!0}}function G(e,t){return new V(e,t)}class H extends f{constructor(e,t,i){super(e,t),this.childPasses=Me(e,this,i)}}class k extends x{constructor(e,t){super(e),this.shaderTag="normalDepthWithMask",this.tintedEdges=new se(this.viewer,this,{primitiveType:s.EDGES}),this.tintedEdges.setExtraMeshNodeFilter((function(e){return e.getIsTintedByCompare()})),this.tintedPoints=new se(this.viewer,this,{primitiveType:s.POINTS}),this.tintedPoints.setExtraMeshNodeFilter((function(e){return e.getIsTintedByCompare()})),this.childPasses.push(this.tintedEdges),this.childPasses.push(this.tintedPoints),t&&(this.inputs.uMask=t)}justBeforeDraw(e){const t=e.getActiveShader();if(this.inputs.uMask){t.useTexture("uMask",this.inputs.uMask.getColorTexture());const i=e.getViewport();t.uniform2f("uMaskWidthHeight",i[2],i[3]),t.uniform1f("uUseMask",1)}else t.uniform1f("uUseMask",0),t.useBlankTexture("uMask");super.justBeforeDraw(e)}nodeFilter(e){return!!e.isMeshNode()&&e.getIsVisible()}}var W=i(41810);class z extends f{constructor(e,t){super(e,t);const i=this.viewer.getSceneGraphs().getMainSceneGraph(),n=this.viewer.getSceneGraphs().getPreviewSceneGraph();this.baseDefaultPasses=new Ne(this.viewer,this,i,_e.RENDERING),this.compareDefaultPasses=new Ne(this.viewer,this,n,_e.RENDERING),this.baseDefaultPasses.depthTransparentFaces.setEnabled(!1),this.compareDefaultPasses.depthTransparentFaces.setEnabled(!1),this.nonEditedFaceDepthPass=new se(this.viewer,this,{primitiveType:s.FACES,disableColorWrites:!0}),this.nonEditedEdgeDepthPass=new se(this.viewer,this,{primitiveType:s.EDGES,disableColorWrites:!0}),this.setRenderingMode(W.P1.SHADED_WITH_EDGES)}setBlendFilters(){this.baseDefaultPasses.setBlendFilter(n.BLEND_ONLY),this.compareDefaultPasses.setBlendFilter(n.BLEND_ONLY),this.nonEditedFaceDepthPass.setBlendFilter(n.NON_BLEND_ONLY),this.nonEditedEdgeDepthPass.setBlendFilter(n.NON_BLEND_ONLY)}setHideSelectionInterior(e){this.baseDefaultPasses.setHideSelectionInterior(e),this.compareDefaultPasses.setHideSelectionInterior(e)}pushOpaqueDepthPassWithAlpha(){zs()>.5?(this.childPasses.push(this.compareDefaultPasses.depthFaces),this.childPasses.push(this.compareDefaultPasses.sectionPlaneEndcap),this.childPasses.push(this.compareDefaultPasses.depthEdges)):(this.childPasses.push(this.baseDefaultPasses.depthFaces),this.childPasses.push(this.baseDefaultPasses.sectionPlaneEndcap),this.childPasses.push(this.baseDefaultPasses.depthEdges))}setRenderingMode(e){this.baseDefaultPasses.setRenderingMode(e),this.compareDefaultPasses.setRenderingMode(e)}getBaseEndcapMaskPass(){return this.baseDefaultPasses.sectionPlaneEndcapMask}getPreviewEndcapMaskPass(){return this.compareDefaultPasses.sectionPlaneEndcapMask}}var X=i(41622),q=i(93249);const Z=function(e){if(!e.isMeshNode())return!1;if(this.blendFilter===n.BLEND_ONLY){if(!e.getIncludedInBlend())return!1}else if(this.blendFilter===n.NON_BLEND_ONLY&&e.getIncludedInBlend())return!1;return!!e.getIsDepthTested()&&(!e.hasTransparency()&&(!(e.getIsStencilTested()||!e.getIsStencilWritten())&&(this.priority===e.getRenderOrderPriority()&&this.parentPass.nodeFilter(e))))},Y=function(e){const t=this.viewer.getModelViewManagers().getManager(),i=e.getParent();return!!(e.isEdges()&&i&&t.isNodeForBody(i))&&Z.call(this,e)},K=function(e){return!!e.isSilhouettes()&&Z.call(this,e)};class j extends f{constructor(e,t,i){super(e,t),this.childPasses=[];const n=q.default.getManager(),r=(0,X.Z)(i);r.extraShaderUniforms=[{name:"uBackgroundMixProportion",value:0}];const a=(0,X.Z)(i);a.stencilMode=c.TEST_EDGES_AND_POINTS,a.stencilRefValue=l.LOW_PRIORITY_EDGES,a.visibility=o.SHOWTHROUGH,a.disableDepthTest=!0,a.extraShaderUniforms=[{name:"uBackgroundMixProportion",value:n.getNumber("HIDDEN_LINE_FADE_AMOUNT")}],this.visibleEdgePass1=new se(this.viewer,this,r),r.shaderTagSuffix=Df,this.visibleEdgePass2=new se(this.viewer,this,r),this.visibleEdgePass=new I(this.viewer,this.visibleEdgePass1,this.visibleEdgePass2,QS.eQ),this.childPasses.push(this.visibleEdgePass),this.hiddenEdgePass=new se(this.viewer,this,a),i.primitiveType===s.EDGES?this.hiddenEdgePass.setNodeFilter(Y):this.hiddenEdgePass.setNodeFilter(K),this.hiddenEdgePass.setEnabled(!1),this.childPasses.push(this.hiddenEdgePass)}setDrawHidden(e){this.hiddenEdgePass.setEnabled(e),this.updateMixColor()}onAppearanceConstantsUpdated(){this.updateMixColor()}updateMixColor(){this.hiddenEdgePass.getEnabled()&&this.setShaderUniform("uBackgroundColor",q.default.getManager().getColor("BACKGROUND_COLOR"))}setDrawVisibleParts(e){e?this.visibleEdgePass.setNodeFilter(null):this.visibleEdgePass.setNodeFilter(ne)}setBlendFilter(e){this.visibleEdgePass.setBlendFilter(e),this.hiddenEdgePass.setBlendFilter(e)}setExtraMeshNodeFilter(e){this.visibleEdgePass.setExtraMeshNodeFilter(e),this.hiddenEdgePass.setExtraMeshNodeFilter(e)}set nodeOccurrenceFilterFunction(e){this.visibleEdgePass1.nodeOccurrenceFilterFunction=e,this.visibleEdgePass1.nodeOccurrenceFilterFunction=e,this.hiddenEdgePass.nodeOccurrenceFilterFunction=e}}var Q=i(43310),$=i(80675);const J=q.default.getManager(),ee=$.create(),te=v.create(),ie=P.create();class se extends f{constructor(e,t,i){switch(super(e,t),this.stencilRefValue=null,this.extraShaderUniforms=[],this.disableColorWrites=!1,this.clipToSectionPlanes=!0,this.disableDepthTest=!1,this.performIsolationTest=!1,this.sceneGraph=null,this.shaderTag="points",this.forDepth=!1,this.shader=null,this.occlusionMapTextureUnit=0,this.applyTranslucentAlphaToAll=!1,this.nodeOccurrenceFilterFunction=null,this.primitiveType=s.FACES,this.opacity=a.OPAQUE,this.visibility=o.VISIBLE,this.stencilMode=c.WRITE_EDGES_AND_POINTS,this.priority=Yi.DEFAULT,this.facesShader=h.OPAQUE,this.blendMode=d.OVER_WITH_SEPARATE_ALPHA,this.blendFilter=n.ALL,this.depthTestMode=g.LESS,i&&(0,Q.overwriteMatchingProperties)(this,i),this.primitiveType){case s.POINTS:break;case s.EDGES:this.shaderTag="edges";break;case s.FACES:switch(this.facesShader){case h.OPAQUE:this.shaderTag="faces";break;case h.ZEBRA_STRIPES:this.shaderTag="zebraStripes";break;case h.DRAFT:this.shaderTag="draftAnalysis";break;case h.QUALITY_VISUALIZATION:this.shaderTag="qualityVisualization"}break;case s.SILHOUETTES:this.shaderTag="silhouettes"}i.shaderTagSuffix&&(this.shaderTag=this.shaderTag+i.shaderTagSuffix)}setExtraMeshNodeFilter(e){this.extraMeshNodeFilter=e}setSceneGraph(e){this.sceneGraph=e}setBlendFilter(e){this.blendFilter=e}getPerformIsolationTest(){return this.performIsolationTest}setPerformIsolationTest(e){this.performIsolationTest=e}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}setEnableColorWrites(e){this.disableColorWrites=!e}setOpacity(e){this.opacity=e}setShaderUniform(e,t){for(const i of this.extraShaderUniforms)if(i.name===e)return void(i.value=t);this.extraShaderUniforms.push({name:e,value:t})}appliesTranslucentAlphaToAll(e){this.applyTranslucentAlphaToAll=e}isShowthroughPass(){return this.visibility===o.SHOWTHROUGH||!!this.parentPass&&this.parentPass.isShowthroughPass()}rendersPoints(){return this.primitiveType===s.POINTS}rendersEdges(){return this.primitiveType===s.EDGES||this.primitiveType===s.SILHOUETTES}rendersFaces(){return this.primitiveType===s.FACES}testIsolation(e){return this.performIsolationTest&&e.getHasIsolate()}usesShader(){return!0}setNodeOccurrenceFilterFunction(e){this.nodeOccurrenceFilterFunction=e}preDraw(e){if(!super.preDraw(e))return!1;const t=this.viewer.getGlContext();this.initializeShader(),e.activateShader(this.shader),this.isPickPass()||e.setMaterial();const i=this;switch(e.nodeFilter=function(e){return i.nodeFilter(e)},this.blendMode){case d.OVER_WITH_SEPARATE_ALPHA:t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case d.ADD:t.blendFunc(t.ONE,t.ONE);break;default:throw"Unrecognized blend mode"}t.enable(t.BLEND),this.updateIsolationUniform(e,this.shader);const s=this.parentPass&&"depth"===this.parentPass.shaderTag,n=this.opacity===a.TRANSPARENT&&!this.disableColorWrites,r=this.rendersPoints()||this.rendersEdges(),o=s||this.forDepth||!n&&!r;e.getState().callGl("depthMask",o),this.disableDepthTest?(t.disable(t.DEPTH_TEST),e.getState().callGl("depthMask",!1)):(t.enable(t.DEPTH_TEST),e.getState().callGl("depthMask",o),t.depthFunc(this.depthTestMode));const h=!this.isPickPass()&&!this.isHighlightPass(),l=(this.rendersEdges()||this.rendersPoints())&&h,u=this.rendersFaces()&&h;return l&&this.stencilMode===c.TEST_EDGES_AND_POINTS?ht(t,this.getStencilRefValue(),this.getStencilRefMask()):l&&this.stencilMode===c.WRITE_EDGES_AND_POINTS?ct(t,this.getStencilRefValue(),this.getStencilRefMask()):u&&this.stencilMode===c.WRITE_AND_TEST_FACES?lt(t,this.getStencilRefValue(),this.getStencilRefMask()):t.disable(t.STENCIL_TEST),this.isPickPass()&&(e.getState().callGl("depthMask",!0),t.disable(t.BLEND)),this.disableColorWrites&&t.colorMask(!1,!1,!1,!1),this.rendersPoints()&&this.shader.uniform1f("uPointFilterWidth",J.getNumber("POINT_FILTER_WIDTH")),this.rendersEdges()&&(this.forDepth?this.shader.uniform1f("uLineFilterWidth",0):this.shader.uniform1f("uLineFilterWidth",J.getNumber("LINE_FILTER_WIDTH"))),this.nodeOccurrenceFilterFunction&&e.setNodeOccurrenceFilterFunction(this.nodeOccurrenceFilterFunction),!0}onShaderActivated(e,t){e.getDetailSettings().enableSSAO&&this.inputs.hasOwnProperty("uOcclusionMap")&&!e.getHasIsolate()?(t.useTexture("uOcclusionMap",this.inputs.uOcclusionMap.getColorTexture()),t.uniform1f("uOcclusionFactor",J.getNumber("AMBIENT_OCCLUSION_EFFECT_FACTOR"))):t.uniform1f("uOcclusionFactor",0),this.updateIsolationUniform(e,t);const i=this.viewer.getResources().getHighlightTexture();t.useTexture("uHighlightColorTexture",i),t.uniform1f("uHighlightColorTextureWidth",this.viewer.getReferenceHighlights().getHighlightTextureWidth()),(0,QS.qS)(this.viewer,this.clipToSectionPlanes),this.rendersFaces()&&(t.uniform1f("uTintFactor",0),t.uniform3f("uTintColor",1,1,1),t.uniform1i("uApplyTranslucentAlphaToAll",this.applyTranslucentAlphaToAll?1:0)),this.applyExtraUniforms(t)}updateIsolationUniform(e,t){this.testIsolation(e)?t.uniform1i("uOutsideIsolation",this.forIsolate()?0:1):t.uniform1i("uOutsideIsolation",0)}getStencilRefValue(){return this.stencilRefValue?this.stencilRefValue:this.rendersEdges()?l.EDGES:this.rendersFaces()?l.FACES:l.POINTS}getStencilRefMask(){return this.rendersEdges()?u.EDGES:this.rendersFaces()?u.FACES:u.POINTS}justBeforeDraw(e){super.justBeforeDraw(e),this.shader.uniform1i("uHideSelectionInterior",this.hideSelectionInterior?1:0),this.applyExtraUniforms(this.shader)}applyExtraUniforms(e){for(const t of this.extraShaderUniforms)if(t.value)switch(t.value.length){case 4:e.uniform4fv(t.name,t.value);break;case 3:e.uniform3fv(t.name,t.value);break;case 2:e.uniform2fv(t.name,t.value);break;default:e.uniform1f(t.name,t.value)}}justAfterDraw(e){super.justAfterDraw(e);const t=e.getActiveShader();this.extraShaderUniforms.forEach((function(e){if(e.value)switch(e.value.length){case 4:t.uniform4fv(e.name,ie);break;case 3:t.uniform3fv(e.name,te);break;case 2:t.uniform2fv(e.name,ee);break;default:t.uniform1f(e.name,0)}}),this)}postDraw(e){const t=this.viewer.getGlContext();t.disable(t.STENCIL_TEST),t.enable(t.DEPTH_TEST),t.disable(t.BLEND),t.colorMask(!0,!0,!0,!0),this.nodeOccurrenceFilterFunction&&e.setNodeOccurrenceFilterFunction(null)}nodeFilter(e){if(!e.isMeshNode())return!1;if(this.blendFilter===n.BLEND_ONLY){if(!e.getIncludedInBlend())return!1}else if(this.blendFilter===n.NON_BLEND_ONLY&&e.getIncludedInBlend())return!1;if(this.extraMeshNodeFilter&&!this.extraMeshNodeFilter(e))return!1;if(this.disableDepthTest===e.getIsDepthTested())return!1;switch(this.primitiveType){case s.POINTS:if(!e.isPoints())return!1;break;case s.EDGES:if(!e.isEdges())return!1;break;case s.FACES:if(!e.isFaces())return!1;break;case s.SILHOUETTES:if(!e.isSilhouettes())return!1}switch(this.visibility){case o.VISIBLE:if(e.getIsShowThrough())return!1;switch(this.opacity){case a.OPAQUE:if(e.hasTransparency())return!1;break;case a.TRANSPARENT:if(!e.hasTransparency()&&!this.applyTranslucentAlphaToAll)return!1}break;case o.SHOWTHROUGH:if(!e.getIsShowThrough())return!1}const t=e.getIsStencilTested(),i=e.getIsStencilWritten();return!(this.stencilMode===c.TEST_EDGES_AND_POINTS&&!t)&&(!(this.stencilMode===c.WRITE_EDGES_AND_POINTS&&(!i||t))&&((this.stencilMode!==c.OFF||!t&&!i)&&(this.priority===e.getRenderOrderPriority()&&this.parentPass.nodeFilter(e))))}setNodeFilter(e){this.nodeFilter=e||se.prototype.nodeFilter}}function ne(e){const t=this.viewer.getModelViewManagers().getManager(),i=e.getParent();return!(i&&t.isNodeForBody(i)&&!e.getAddsToBounds())&&se.prototype.nodeFilter.call(this,e)}class re extends se{constructor(e,t,i,s){super(e,t,{facesShader:h.QUALITY_VISUALIZATION,performIsolationTest:i}),this.setSceneGraph(s)}}class ae extends f{constructor(e,t,i,s,n){super(e,t),this.childPasses=[];const r=!!n;this.scenegraph=this.viewer.getSceneGraphs().getMainSceneGraph(),s===Ls.L.PREVIEW&&(this.scenegraph=this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.usage=s||Ls.L.BASE;const a=this.viewer.getReferenceHighlights().sortedHighlights;for(let e=0;e<a.length;++e){const t=a[e].type;if(n&&!n.has(t))continue;yn.o2.FILTERED_ENTITIES;const s=t===yn.o2.FILTERED_ENTITIES&&!r,o=new Ct(this.viewer,t,i,s);o.setSceneGraph(this.scenegraph),this.childPasses.push(o)}}setInteriorHighlightOpacity(e){for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].setInteriorHighlightOpacity(e)}getSceneGraph(){return this.scenegraph}drawInputs(e){}draw(e){if(this.usage!==Ls.L.BASE||e.getBaseHighlightsEnabled())for(let t=0;t<this.childPasses.length;++t)this.viewer.getHighlightManager(this.usage).highlightHasSelections(this.childPasses[t].highlightType)&&(this.childPasses[t].drawInputs(e),this.childPasses[t].draw(e))}setHideSelectionInterior(e){for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].setHideSelectionInterior(!!e&&this.childPasses[t].highlightType!==yn.o2.PRE)}setMaskOpaqueFaces(e){for(let t=0;t<this.childPasses.length;t++)this.childPasses[t].setMaskOpaqueFaces(e)}}class oe extends f{constructor(e,t,i,n,r,h,l){let u;super(e,i),this.highlightType=t,this.useDepthTest=n,this.stippleOverride=r,this.clipAgainstSectionPlane=h,this.disableDuringPreview=l,this.shaderTag="highlightDraw",this.childPasses=[],h||(u=Df);const d=q.default.getManager();for(let e=0;e<Yi.COUNT;++e)this.childPasses.push(new se(this.viewer,this,{primitiveType:s.EDGES,visibility:o.SHOWTHROUGH,stencilMode:c.TEST_EDGES_AND_POINTS,disableDepthTest:!0,priority:e,shaderTagSuffix:u})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,stencilMode:c.TEST_EDGES_AND_POINTS,disableDepthTest:!0,priority:e,shaderTagSuffix:u})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.EDGES,visibility:o.SHOWTHROUGH,disableDepthTest:!0,priority:e,shaderTagSuffix:u})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,disableDepthTest:!0,priority:e,shaderTagSuffix:u})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.EDGES,visibility:o.SHOWTHROUGH,priority:e,shaderTagSuffix:u})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,priority:e,shaderTagSuffix:u}));this.childPasses.push(new se(this.viewer,this,{primitiveType:s.EDGES,shaderTagSuffix:u})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.EDGES,opacity:a.TRANSPARENT,stencilMode:c.OFF,extraShaderUniforms:[{name:"uHighlightLineWidthMin",value:d.getNumber("HIGHLIGHT_LINE_WIDTH_TRANSPARENT_MIN")}],shaderTagSuffix:u})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.POINTS,shaderTagSuffix:u}))}isHighlightPass(){return!0}getActiveHighlightType(){return this.highlightType}needsAttribute(e){const t=e===$d.HIGHLIGHT_ID;return this.parentPass?t||this.parentPass.needsAttribute(e):t}getHighlight(){return this.viewer.getReferenceHighlights().highlights[this.highlightType]}getEnabled(){return this.enabled&&(!this.disableDuringPreview||!js())}nodeFilter(e){return this.getHighlight().forOccurrences?e.getParent()&&!this.viewer.getModelViewManagers().getManager().isNodeForBody(e.getParent()):f.prototype.nodeFilter.apply(this,arguments)}justBeforeDraw(e){const t=q.default.getManager();super.justBeforeDraw(e);const i=e.getActiveShader(),s=this.getHighlight(),n=s.type===yn.o2.FILTERED_ENTITIES;i.uniform1f("uActiveHighlightIndex",s.index),i.uniform4fv("uHighlightColor",s.color1),i.uniform1f("uHighlightLineWidthMin",n?t.getNumber("HIGHLIGHT_LINE_WIDTH_REDUCED_PX"):t.getNumber("HIGHLIGHT_LINE_WIDTH_MIN_PX")),i.uniform1f("uHighlightPointSizeMin",t.getNumber("HIGHLIGHT_POINT_SIZE_MIN_PX")),this.stippleOverride?(i.uniform4fv("uHighlightLineStipple",this.stippleOverride),i.uniform1f("uUseHighlightLineStipple",1),e.setUseHiddenOpacityForEdgeHighlights(!0)):(i.uniform1f("uUseHighlightLineStipple",0),e.setUseHiddenOpacityForEdgeHighlights(!1)),i.uniform1i("uClippedBySectionPlanes",this.clipAgainstSectionPlane?1:0);const r=this.viewer.getGlContext();r.enable(r.BLEND),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA),this.useDepthTest?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),e.getState().callGl("depthMask",!1)}}class he extends f{constructor(e,t,i,s){super(e,null),this.childPasses=[];const n=q.default.getManager();this.usage=t||Ls.L.BASE,this.scenegraph=this.viewer.getSceneGraphs().getMainSceneGraph(),t===Ls.L.PREVIEW&&(this.scenegraph=this.viewer.getSceneGraphs().getPreviewSceneGraph());const r=!!s;for(let e=0;e<this.viewer.getReferenceHighlights().sortedHighlights.length;++e){const t=this.viewer.getReferenceHighlights().sortedHighlights[e].type;if(s&&!s.has(t))continue;const a=t===yn.o2.FILTERED_ENTITIES,o=t===yn.o2.FILTERED_ENTITIES,h=t===yn.o2.FILTERED_ENTITIES&&!r;i?a&&this.childPasses.push(new oe(this.viewer,t,this,!0,null,o,h)):a?this.childPasses.push(new oe(this.viewer,t,this,!1,n.getStipple("HIGHLIGHT_HIDDEN_LINE_STIPPLE"),o,h)):this.childPasses.push(new oe(this.viewer,t,this,!1,null,o,h))}}preDraw(e){return!(this.usage===Ls.L.BASE&&!e.getBaseHighlightsEnabled())&&super.preDraw(e)}drawInputs(e){for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].setEnabled(this.viewer.getHighlightManager(this.usage).highlightHasSelections(this.childPasses[e].highlightType));f.prototype.drawInputs.apply(this,arguments)}setSceneGraph(e){this.scenegraph=e}getSceneGraph(){return this.scenegraph}}const ce=q.default.getManager();class le extends M{constructor(e){super(e),this.checkFrameId=!1,this.shaderTag="depth",this.useHighlightsOnly=!1,this.childPasses=[],this.points=[],this.numSamples=0,this.includePlanes=!0,this.childPasses.push(new se(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!0,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0,opacity:a.TRANSPARENT,stencilMode:c.OFF,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.POINTS,performIsolationTest:!0,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.POINTS,performIsolationTest:!0,visibility:o.SHOWTHROUGH,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,sceneGraph:this.viewer.getSceneGraphs().getPreviewSceneGraph(),extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,opacity:a.TRANSPARENT,sceneGraph:this.viewer.getSceneGraphs().getPreviewSceneGraph(),extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.clearColor=Js.XD}setIncludePlanes(e){this.includePlanes=e}nodeFilter(e){return!!e.getIsVisible()&&(!e.isMeshNode()||!HC(e)||this.includePlanes)}needsAttribute(e){const t=e===$d.HIGHLIGHT_ID&&this.useHighlightsOnly;return this.parentPass?t||this.parentPass.needsAttribute(e):t}isHighlightPass(){return this.useHighlightsOnly}getActiveHighlightType(){return yn.o2.ENTITY}setUseHighlightsOnly(e){this.useHighlightsOnly=e;const t=e?1:0;for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].setShaderUniform("uUseHighlightsOnly",t)}draw(e){throw"Use DepthSamplingPass retrieve method instead"}retrieve(e,t){t=t||{},this.numSamples=void 0===t.numSamples?ce.getNumber("DEPTH_SAMPLES_PER_VIEWPORT"):t.numSamples,this.includePlanes=void 0===t.includePlanes||t.includePlanes,this.setPerformIsolationTest(void 0===t.performIsolationTest||t.performIsolationTest),this.setUseHighlightsOnly(void 0!==t.useHighlightsOnly&&t.useHighlightsOnly),super.draw(e)}preDraw(e){const t=e.getViewport(),i=Math.min(Math.sqrt(this.numSamples/(t[2]*t[3])),1);return this.horizontalScale=Math.ceil(t[2]*i)/t[2],this.verticalScale=Math.ceil(t[3]*i)/t[3],this.fullViewport=t,this.shrunkViewport=[0,0,Math.max(Math.round(this.horizontalScale*t[2]),1),Math.max(Math.round(this.verticalScale*t[3]),1)],e.pushViewport(this.shrunkViewport),super.preDraw(e)}postDraw(e){const t=this.shrunkViewport[2]*this.shrunkViewport[3]*4,i=new Uint8Array(t),s=this.viewer.getGlContext();s.readPixels(0,0,this.shrunkViewport[2],this.shrunkViewport[3],s.RGBA,s.UNSIGNED_BYTE,i),this.points=[];for(let e=0;e<t/4;e++){const t=4*e,s=(0,Js.Rg)([i[t],i[t+1],i[t+2],i[t+3]],this.viewer.isHighPrecisionSupportedInFragmentShader());if(s===Js.BG)continue;const n=e%this.shrunkViewport[2]+.5,r=this.shrunkViewport[3]-Math.floor(e/this.shrunkViewport[2])-.5,a=this.fullViewport[0]+n/this.horizontalScale,o=this.fullViewport[1]+r/this.verticalScale;this.points.push([a,o,s])}e.popViewport(),super.postDraw(e)}}class ue extends E{constructor(e,t,i){super(e),this.shaderTag="previewBlend",this.inputs.uBaseTexture=t,this.inputs.uPreviewTexture=i,this.blendMode=p.BLEND_ALPHA}justBeforeDraw(e){super.justBeforeDraw(e),this.shader.uniform1f("uPreviewAlpha",ks().previewAlpha)}}var de=i(96408),ge=i(63903),pe=i(54861);const me=64,fe=function(e){const t=new de.H(0),i=new Uint8Array(4096);for(let e=0;e<4096;++e)i[e]=Math.floor(256*t.random());const s=new co(e);return s.internalFormat=e.LUMINANCE,s.format=e.LUMINANCE,s.bytes=i,s.width=me,s.height=me,s.minificationFilter=e.LINEAR,s.magnificationFilter=e.LINEAR,s.wrapS=e.REPEAT,s.wrapT=e.REPEAT,s};class Ie extends E{constructor(e,t){super(e),this.shaderTag="normalDepthFilter",this.blendMode=p.BLEND_OFF,this.inputs.uNormalDepthTexture=t}}class Ee extends E{constructor(e,t,i){super(e),this.shaderTag="occlusion",this.inputs.uNormalDepthTexture=i||t,this.normalDepthPass=t,this.filteredNormalDepthPass=i,this.randomTexture=new uo(this.viewer,fe)}drawInputs(e){const t=e.getDetailSettings();this.filteredNormalDepthPass&&t.enableSSAOFilter?this.inputs.uNormalDepthTexture=this.filteredNormalDepthPass:this.inputs.uNormalDepthTexture=this.normalDepthPass,E.prototype.drawInputs.call(this,e)}justBeforeDraw(e){const t=q.default.getManager();super.justBeforeDraw(e),this.shader.useTexture("uRandomTexture",this.randomTexture);const i=e.getViewport(),s=i[2],n=i[3],r=Math.sqrt(s*s+n*n);this.shader.uniform2fv("uRandomTextureScale",[(s-1)/me,(n-1)/me]);const a=pe.w$.inverse(e.getProjectionMatrix(),ge.create());a&&this.shader.uniformMatrix4fv("uPMatrixInv_fs",!1,a),this.shader.uniform1f("uIntensity",t.getNumber("AMBIENT_OCCLUSION_INTENSITY")),this.shader.uniform1f("uBias",t.getNumber("AMBIENT_OCCLUSION_BIAS")),this.shader.uniform1f("uScale",t.getNumber("AMBIENT_OCCLUSION_SCALE")),this.shader.uniform1f("uRadiusNear",Math.max(t.getNumber("AMBIENT_OCCLUSION_RADIUS_NEAR")*r,2)),this.shader.uniform1f("uRadiusFar",Math.max(t.getNumber("AMBIENT_OCCLUSION_RADIUS_FAR")*r,2))}}class Se extends E{constructor(e,t){super(e),this.shaderTag="occlusionFilter",this.blendMode=p.BLEND_OFF,this.inputs.uOcclusionMap=t}}function Te(e){const t=q.default.getManager(),i=U(e,t.getNumber("AMBIENT_OCCLUSION_VIEWPORT_RATIO"),"ssaoBuffer1");let s=null;if(e.isSSAOFilteringSupported()){s=C(e,new Ie(e,i),t.getNumber("AMBIENT_OCCLUSION_VIEWPORT_RATIO"),"ssaoFilterBuffer")}const n=C(e,new Ee(e,i,s),t.getNumber("AMBIENT_OCCLUSION_VIEWPORT_RATIO"),"ssaoBuffer2");return C(e,new Se(e,n),t.getNumber("AMBIENT_OCCLUSION_VIEWPORT_RATIO"),"ssaoBuffer1")}function Me(e,t,i){const n=[],r=!!i.hasOwnProperty("usePickAlternates")&&i.usePickAlternates;return i.primitiveType=s.FACES,n.push(new se(e,t,i)),r&&n.push(new ze(e,t,i)),i.primitiveType=s.EDGES,n.push(new se(e,t,i)),r&&n.push(new ze(e,t,i)),i.primitiveType=s.POINTS,n.push(new se(e,t,i)),n}var Ce;!function(e){e[e.DEPTH_AND_NORMAL=0]="DEPTH_AND_NORMAL",e[e.DEPTH_ONLY=1]="DEPTH_ONLY",e[e.PLANE_ID=2]="PLANE_ID"}(Ce||(Ce={}));class De extends se{constructor(e,t,i,n,r,o){super(e,t,i),this.tintOpacity=1,this.tintColor=n,this.matchesCompareColor=r,this.inputs.uCompareBuffer=o,this.tintTestType=Ce.DEPTH_ONLY,this.primitiveType===s.FACES&&(this.opacity===a.TRANSPARENT?this.tintTestType=Ce.PLANE_ID:this.tintTestType=Ce.DEPTH_AND_NORMAL),this.opacity===a.TRANSPARENT&&(this.tintOpacity=q.default.getManager().getNumber("COMPARE_TRANSLUCENT_FACE_OPACITY")),this.tintTestType===Ce.DEPTH_ONLY&&this.setExtraMeshNodeFilter((function(e){return e.getIsTintedByCompare()}))}getShaderId(){return this.tintTestType===Ce.PLANE_ID?"-tintByPlaneId-"+this.shaderTag:this.tintTestType===Ce.DEPTH_AND_NORMAL?"-tintByNormalDepth-"+this.shaderTag:"-tintByDepth-"+this.shaderTag}justBeforeDraw(e){super.justBeforeDraw(e);const t=e.getActiveShader();t.uniform3f("uTintColor",this.tintColor[0],this.tintColor[1],this.tintColor[2]),t.uniform1f("uTintOpacity",this.tintOpacity),t.uniform1f("uBlendOverdrawAdjustment",1/(1+Nt())),t.uniform3f("uMatchesCompareColor",this.matchesCompareColor[0],this.matchesCompareColor[1],this.matchesCompareColor[2]),this.inputs.uCompareBuffer&&t.useTexture("uCompareBuffer",this.inputs.uCompareBuffer.getColorTexture())}}var ve=i(50568),Pe=i(48820);const ye=q.default.getManager();class Ae extends M{constructor(e,t){super(e),this.mainDrawPass=t,this.TEMP_VEC4=P.create(),this.TEMP_MAT4=ge.create(),this.shaderTag="pick",this.checkFrameId=!1,this.pickBuffer=null,this.pickRect=[0,0,1,1],this.pickViewportWidthHeight=[1,1],this.enablePickViewportScaling=!0,this.oldViewport=[0,0,1,1],this.hitlist=[],this.isBoxSelecting=!1,this.suppressNonIsolatedPicks=!0,this.childrenPerformIsolationTest=null,this.childPassIsolateTests=[],this.nodeFilterOverride=null,this.pickFromPreview=!1,this.pickFrustum=new pr;const i=new Ne(this.viewer,this,null,_e.PICKING);this.opaqueFacePass=i.opaqueFaces,this.opaqueFaceAlternatePass=new ze(this.viewer,this,{performIsolationTest:!0}),this.previewStateChangeSubscription=ks().stateChangedObservable.pipe((0,Pe.h)((e=>e===Ns.PREVIEW_STATE_CHANGE))).subscribe((()=>this.onPreviewStateChange())),this.childPasses=[],this.childPasses.push(this.opaqueFacePass),this.childPasses.push(this.opaqueFaceAlternatePass),t&&(this.sectionPlaneEndcapDrawPasses=new A(this.viewer,this,t.sectionPlaneEndcapMaskPass),this.childPasses.push(this.sectionPlaneEndcapDrawPasses)),this.transparentFacePass=i.nonOitTransparentFaces,this.transparentFaceAlternatePass=new ze(this.viewer,this,{opacity:a.TRANSPARENT,performIsolationTest:!0}),this.childPasses.push(this.transparentFacePass),this.childPasses.push(this.transparentFaceAlternatePass),this.childPasses.push(i.sketchImageFaces),this.postOpaqueFaceDepthClearPass=G(this.viewer,this),this.postOpaqueFaceDepthClearPass.setEnabled(!1),this.childPasses.push(this.postOpaqueFaceDepthClearPass),this.opaqueEdgesPass=new se(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0}),this.opaqueEdgesAlternatesPass=new ze(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0}),this.childPasses.push(this.opaqueEdgesPass),this.childPasses.push(this.opaqueEdgesAlternatesPass),this.childPasses.push(i.transparentEdges),this.childPasses.push(new ze(this.viewer,this,{primitiveType:s.EDGES,opacity:a.TRANSPARENT,performIsolationTest:!0})),this.opaquePointsPass=i.opaquePoints,this.childPasses.push(this.opaquePointsPass),this.childPasses.push(G(this.viewer,this));for(let e=0;e<Yi.COUNT;++e)this.childPasses.push(i.showThroughStencilTested.getChildPass(e)),this.childPasses.push(i.showThroughNotStencilTested.getChildPass(e)),this.childPasses.push(i.showThroughDepthTested.getChildPass(e));this.childPasses.push(be(this.viewer,this)),this.clearColor=Js.o0;for(let e=0;e<this.childPasses.length;e++)this.childPassIsolateTests[e]=this.childPasses[e].getPerformIsolationTest();this.isolatedNodeOccurrenceFilter=e=>{if(e.occurrenceData.getIsolated()||!this.viewer.getIsolatedOccurrenceManager().isInIsolateMode()&&!this.viewer.getIsolatedOccurrenceManager().isInMakeTransparentMode()||this.viewer.getIsForFlattenedDisplay())return!0;const t=e.occurrenceData.getOccurrenceId();return t===DI.KF||!(!this.viewer.getModelViewManagers().getManager().isDisplayingIncontextAssembly()||!this.viewer.getModelViewManagers().getManager().isOccurrenceIdForInContext(t))}}onSessionEnded(){this.previewStateChangeSubscription.unsubscribe(),super.onSessionEnded()}setPickFromPreview(e){this.pickFromPreview!==e&&(this.pickFromPreview=e,this.onPreviewStateChange())}setPickAlternatesEnabled(e){for(let t=0;t<this.childPasses.length;++t)if(this.childPasses[t]instanceof ze)this.childPasses[t].setEnabled(e);else if(this.childPasses[t]instanceof H)for(let i=0;i<this.childPasses[t].childPasses.length;++i)this.childPasses[t].childPasses[i]instanceof ze&&this.childPasses[t].childPasses[i].setEnabled(e)}setPerformIsolationTest(e){if(this.childrenPerformIsolationTest!==e)if(this.childrenPerformIsolationTest=e,this.childrenPerformIsolationTest)for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].setPerformIsolationTest(this.childPassIsolateTests[e]);else for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].setPerformIsolationTest(!1)}setSuppressNonIsolatedPicks(e){this.suppressNonIsolatedPicks=e}setIsBoxSelecting(e){this.isBoxSelecting=e}setRenderingMode(e){const t=this,i=function(e){e?(t.opaqueEdgesPass.setNodeFilter(null),t.opaqueEdgesAlternatesPass.setNodeFilter(null),t.opaquePointsPass.setNodeFilter(null)):(t.opaqueEdgesPass.setNodeFilter(ne),t.opaqueEdgesAlternatesPass.setNodeFilter(ne),t.opaquePointsPass.setNodeFilter(ne))};switch(e){case W.P1.SHADED_WITH_EDGES:case W.P1.DRAFT_ANALYSIS:case W.P1.SHADED_CURVATURE_VISUALIZATION:case W.P1.CURVATURE_VISUALIZATION:case W.P1.SIMULATION_RESULTS:case W.P1.SHADED_WITHOUT_EDGES:this.postOpaqueFaceDepthClearPass.setEnabled(!1),i(!0);break;case W.P1.SHADED_WITH_HIDDEN_EDGES:this.postOpaqueFaceDepthClearPass.setEnabled(!0),i(!0);break;case W.P1.HIDDEN_LINE_REMOVED:this.postOpaqueFaceDepthClearPass.setEnabled(!1),i(!0);break;case W.P1.HIDDEN_LINE_VISIBLE:case W.P1.WIREFRAME:case W.P1.TRANSLUCENT:this.postOpaqueFaceDepthClearPass.setEnabled(!0),i(!0)}}isPickPass(){return!0}setEnablePickViewportScaling(e){this.enablePickViewportScaling=e}getMaxHighResPickViewportSamples(){return ye.getNumber("MAX_HIGH_RES_PICKING_RECT_SAMPLES")}setPickRect(e,t,i,s,n){this.pickRect=[e,t,i,s];const r=i*s;if(n&&r>n){const e=Math.sqrt(n/r),t=Math.floor((i-1)*e)+1,a=Math.floor((s-1)*e)+1;this.pickViewportWidthHeight=[t,a]}else if(this.enablePickViewportScaling&&r>this.getMaxHighResPickViewportSamples()){const e=ye.getNumber("LOW_RES_PICKING_RECT_SCALE"),t=1/Math.min(i,s),n=Math.max(e,t),r=Math.floor((i-1)*n)+1,a=Math.floor((s-1)*n)+1;this.pickViewportWidthHeight=[r,a]}else this.pickViewportWidthHeight=[i,s]}getPickRect(){return this.pickRect}getPickViewportWidthHeight(){return this.pickViewportWidthHeight}getPickFrustum(e,t){const i=this.TEMP_VEC4;i[0]=this.pickRect[0]-t,i[1]=this.pickRect[1]-t,i[2]=this.pickRect[2]+2*t,i[3]=this.pickRect[3]+2*t;const s=(0,Li.zL)(i,e.getViewport(),e.getActiveCamera().getCanvasHeight()),n=pe.w$.multiply(s,e.getProjectionMatrix(),this.TEMP_MAT4);return this.pickFrustum.updateClippingPlanes(e.getModelViewMatrix(),n),this.pickFrustum}preDraw(e){e.setNodeOccurrenceFilterFunction(this.isolatedNodeOccurrenceFilter);const t=this.getAllowedSelections(),i=this.suppressNonIsolatedPicks||!1===t.allowsNonModifiableGeometry;this.setPerformIsolationTest(i),this.oldViewport=e.getViewport();const s=(0,Li.zL)(this.pickRect,this.oldViewport,e.getActiveCamera().getCanvasHeight()),n=pe.w$.multiply(s,e.getProjectionMatrix(),this.TEMP_MAT4);return e.pushProjectionMatrix(n),e.pushViewport([0,0,this.pickViewportWidthHeight[0],this.pickViewportWidthHeight[1]]),super.preDraw(e)}getAllowedSelections(){return this.isBoxSelecting?(0,ve.Ac)():(0,ve.y0)()}setNodeFilterOverride(e){this.nodeFilterOverride=e||null}nodeFilter(e){if(this.nodeFilterOverride)return this.nodeFilterOverride(e);const t=this.getAllowedSelections(),i=this.viewer.getModelViewManagers().getManagerForUsage(this.getUsage());if(t&&i.isNodeForModel(e)){const s=e.getParent();if(!1===t.allowsBodies&&!1===t.allowsSketchEntities&&i.isNodeForSketch(s))return!1;if(!1===t.allowsBodyEntities&&!1===t.allowsBodies&&i.isNodeForBody(s))return!1;if(e.isMeshNode()){if(!1===t.allowsBodies&&!1===t.allowsEdges&&i.isNodeForEdges(e))return!1;if(!1===t.allowsBodies&&!1===t.allowsVertices&&i.isNodeForPoints(e))return!1}}return e.getIsPickable()}postDraw(e){e.setNodeOccurrenceFilterFunction(null);const t=this.pickViewportWidthHeight[0]*this.pickViewportWidthHeight[1]*4;(!this.pickBuffer||this.pickBuffer.length<t)&&(this.pickBuffer=new Uint8Array(t));const i=this.viewer.getGlContext();i.readPixels(0,0,this.pickViewportWidthHeight[0],this.pickViewportWidthHeight[1],i.RGBA,i.UNSIGNED_BYTE,this.pickBuffer),this.hitlist=[];for(let e=0;e<t/4;e++){const t=4*e,i=(0,Js.EI)(this.pickBuffer[t],this.pickBuffer[t+1],this.pickBuffer[t+2],this.pickBuffer[t+3]);this.hitlist.push(i)}e.popProjectionMatrix(),e.popViewport(),super.postDraw(e)}getPositionForPickHit(e){const t=this.pickRect[0],i=this.pickRect[1],s=this.pickRect[2],n=this.pickRect[3],r=s/this.pickViewportWidthHeight[0],a=n/this.pickViewportWidthHeight[1],o=e%this.pickViewportWidthHeight[0]*r,h=Math.floor(e/this.pickViewportWidthHeight[0])*a;return $.fromValues(t+o,i+(n-1-h))}getSceneGraph(){return this.pickFromPreview?this.viewer.getSceneGraphs().getPreviewSceneGraph():this.viewer.getSceneGraphs().getMainSceneGraph()}getUsage(){return this.pickFromPreview?Ls.L.PREVIEW:Ls.L.BASE}onPreviewStateChange(){this.sectionPlaneEndcapDrawPasses&&this.sectionPlaneEndcapDrawPasses.setEndcapMaskPass(this.mainDrawPass.getSectionEndcapMaskPassForPicking(this.pickFromPreview))}}const Oe=q.default.getManager();class Re extends Ae{constructor(e,t){super(e,t),this.primitivePickIds=[],this.occurrencePickIds=[],this.primitiveIdPool=[],this.currentPass=0,this.pickMask=null}setEmptyHitList(){this.hitlist=[];const e=this.pickRect[2]*this.pickRect[3],t=Di.JE.slice(0);for(let i=0;i<e;++i)this.primitivePickIds[i]=t,this.occurrencePickIds[i]=DI.Qy}getPickIteration(){return this.currentPass}justBeforeDraw(e){e.getActiveShader().uniform1f("uPickPassIteration",this.getPickIteration())}draw(e){if(this.primitiveIdPool=this.primitivePickIds,this.primitivePickIds=[],this.occurrencePickIds=[],!this.enabled)return void this.setEmptyHitList();e.setActivePass(this);const t=[];let i,s;for(i=this.viewer.getPickPassCount()-1;i>=0;--i)this.currentPass=i,super.draw(e),t.unshift(this.hitlist);if(t.length<1)return void this.setEmptyHitList();const n=t[0].length;for(i=0;i<n;++i){const e=this.primitiveIdPool.length>0?this.primitiveIdPool.pop():[];let n=0,r=-1;for(s=0;s<t.length;++s){const a=t[s][i],o=a&Di.U2.ENTITY;o!==Di.vN&&(e[s]=o,r=s);n|=(a>>>Di._6.ENTITY&Di.U2.OCCURRENCE_SLICE)<<s*Di._6.OCCURRENCE_SLICE}e.length!==r+1&&(e.length=r+1),this.primitivePickIds.push((0,Di.qR)(e)),this.occurrencePickIds.push(n)}}gatherPicksFromPickPass(){const e={};let t,i,s;const n=this.getPickRect(),r=n[2],a=n[3],o=[n[0]+.5*r,n[1]+.5*a],h=this.getPickViewportWidthHeight(),c=2/Math.sqrt((r-1)*(r-1)+(a-1)*(a-1)),l=1/(h[0]*h[1]);for(let n=0;n<this.primitivePickIds.length;++n){if(null!==this.pickMask&&0!==this.pickMask[n])continue;const r=this.getPositionForPickHit(n);if(i=this.primitivePickIds[n],t=this.occurrencePickIds[n],(0,Di.rp)(i)&&t!==DI.Qy){s=e[t],s||(s={},e[t]=s);let n=s[i];n?n.incorporateLocation(r):(n=new Ef.D(i,t,r,this.getUsage()),s[i]=n),n.distance=Math.min(n.distance,pe.gv.length(pe.gv.subtract(r,o,$.create()))*c),n.coverage+=l}}for(t in e)for(i in s=e[t],s)s[i].determineBestLocation();return e}clearPickMask(){this.pickMask=null}updatePickMask(e,t,i){this.pickMask||(this.pickMask=new Uint8Array(this.primitivePickIds.length));let s,n=!1;for(s=0;s<this.primitivePickIds.length;++s){if(0!==this.pickMask[s])continue;const r=this.primitivePickIds[s],a=this.occurrencePickIds[s];if(!(0,Di.rp)(r)||a===DI.Qy)this.pickMask[s]=1;else for(let o=0;o<e.length;++o){const h=e[o];if((0,Di.nD)(r,h.primitiveId)&&a===h.pickedOccurrenceId){h.canPickThrough(t,this.viewer,i)?n=!0:this.pickMask[s]=1;break}}}return!n}}class we extends Re{constructor(e){super(e,null),this.childPasses=[],this.sceneGraph=null;for(let e=0;e<Yi.COUNT;++e)this.childPasses.push(new H(this.viewer,this,{visibility:o.SHOWTHROUGH,usePickAlternates:!0,disableDepthTest:!0,priority:e}))}getMaxHighResPickViewportSamples(){return Oe.getNumber("MAX_INFERENCE_PICKING_RECT_SAMPLES")}setSceneGraph(e){this.sceneGraph=e}getSceneGraph(){return this.sceneGraph}setPerformIsolationTest(e){}}var _e;!function(e){e[e.RENDERING=0]="RENDERING",e[e.HUD=1]="HUD",e[e.ISOLATION=2]="ISOLATION",e[e.PICKING=3]="PICKING"}(_e||(_e={}));class Ne extends f{constructor(e,t,i,n,r){super(e,t),this.opaqueFaces=null,this.opaqueFacesZebraStripes=null,this.draftAnalysisFaces=null,this.qualityVisualization=null,this.opaqueEdges=null,this.silhouettes=null,this.opaquePoints=null,this.nonOitTransparentFaces=null,this.transparentFaces=null,this.transparentEdges=null,this.depthFaces=null,this.depthTransparentFaces=null,this.depthEdges=null,this.showThroughStencilTested=null,this.showThroughNotStencilTested=null,this.showThroughDepthTested=null,this.sectionPlaneEndcapEdge=null,this.sectionPlaneEndcapMask=null,this.sectionPlaneEndcap=null,this.sketchImageFaces=null,this.isolatePass=null,this.contextPass=null,this.compareTransparentFaces=null,this.compareTintedEdges=null,this.compareTintedPoints=null;const l=t.isPickPass(),u=new se(e,t,{performIsolationTest:!r}),d=new se(e,t,{performIsolationTest:!r,shaderTagSuffix:"-nosection"}),g=new I(e,u,d,QS.eQ);g.setSceneGraph(i),this.opaqueFaces=g;const p=q.default.getManager(),m=new se(e,t,{facesShader:h.ZEBRA_STRIPES,sceneGraph:i,performIsolationTest:!r,extraShaderUniforms:[{name:"uStripeCount",value:p.getNumber("ZEBRA_STRIPE_COUNT")},{name:"uStripeRotation",value:p.getNumber("ZEBRA_STRIPE_ROTATION")},{name:"uFilterWidth",value:p.getNumber("ZEBRA_STRIPE_FILTER_WIDTH")},{name:"uRespectOrthographic",value:p.getNumber("ZEBRA_STRIPE_RESPECT_ORTHOGRAPHIC")}]});this.opaqueFacesZebraStripes=m;const E=new Ot(e,t,!r,i);this.draftAnalysisFaces=E,this.qualityVisualization=new re(e,t,!r,i);const S=new j(e,t,{primitiveType:s.EDGES,performIsolationTest:!r,sceneGraph:i});if(this.opaqueEdges=S,!l){const s=new Vt(e,t,i,!1),n=new Vt(e,t,i,!0),r=new I(e,s,n,QS.eQ);this.silhouettes=r}const T=new se(e,t,{primitiveType:s.POINTS,performIsolationTest:!r});T.setSceneGraph(i),this.opaquePoints=T;const M=new se(e,t,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!r}),C=new se(e,t,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!r,shaderTagSuffix:Df}),D=new I(e,M,C,QS.eQ);if(D.setSceneGraph(i),this.nonOitTransparentFaces=D,e.supportsOrderIndependentTranslucency()){const s=new xe(e,t,i);s.setPerformIsolationTest(!r),D.performIsolationTest=!r,this.transparentFaces=new Be(e,s,D,Js.Z)}else this.transparentFaces=D;const v=new se(e,t,{primitiveType:s.EDGES,opacity:a.TRANSPARENT,stencilMode:c.OFF,clipToSectionPlanes:!1,performIsolationTest:!r});v.setSceneGraph(i),this.transparentEdges=v;const P=new se(e,t,{primitiveType:s.FACES,disableColorWrites:!0});P.setSceneGraph(i),this.depthFaces=P,this.depthTransparentFaces=new Gt(e,t,i,!r);const y=new se(e,t,{primitiveType:s.EDGES,disableColorWrites:!0});y.setSceneGraph(i),this.depthEdges=y;const O=new f(e,t);for(let s=0;s<Yi.COUNT;++s){const n=new H(e,t,{visibility:o.SHOWTHROUGH,disableDepthTest:!0,stencilMode:c.TEST_EDGES_AND_POINTS,priority:s,sceneGraph:i,usePickAlternates:l,performIsolationTest:!r});O.addChildPass(n)}this.showThroughStencilTested=O;const R=new f(e,t);for(let s=0;s<=Yi.HIGHEST;++s){const n=new H(e,t,{disableDepthTest:!0,visibility:o.SHOWTHROUGH,priority:s,sceneGraph:i,usePickAlternates:l});R.addChildPass(n)}this.showThroughNotStencilTested=R;const w=new f(e,t);for(let s=0;s<=Yi.HIGHEST;++s){const n=new H(e,t,{visibility:o.SHOWTHROUGH,priority:s,sceneGraph:i,usePickAlternates:l});w.addChildPass(n)}this.showThroughDepthTested=w;const _=new Fe(e,i),b=new N(e,_);this.sectionPlaneEndcapEdge=b,this.sectionPlaneEndcapMask=_,this.sectionPlaneEndcap=new A(e,t,_,b);const L=new se(e,t,{primitiveType:s.FACES,opacity:a.TRANSPARENT,disableDepthTest:!0,sceneGraph:i,performIsolationTest:!r});this.sketchImageFaces=L,n===_e.RENDERING&&(this.isolatePass=new at(e,t,!1,i),this.contextPass=new at(e,t,!0,i))}setBlendFilter(e){this.opaqueFaces.setBlendFilter(e),this.opaqueFacesZebraStripes.setBlendFilter(e),this.draftAnalysisFaces.setBlendFilter(e),this.qualityVisualization.setBlendFilter(e),this.sketchImageFaces.setBlendFilter(e),this.opaqueEdges.setBlendFilter(e),this.silhouettes.setBlendFilter(e),this.depthTransparentFaces.setBlendFilter(e),this.transparentFaces.setBlendFilter(e),this.transparentEdges.setBlendFilter(e),this.opaquePoints.setBlendFilter(e),this.isolatePass&&this.isolatePass.setBlendFilter(e),this.contextPass&&this.contextPass.setBlendFilter(e),this.showThroughStencilTested.setBlendFilter(e),this.showThroughNotStencilTested.setBlendFilter(e),this.showThroughDepthTested.setBlendFilter(e),this.depthFaces.setBlendFilter(e),this.depthEdges.setBlendFilter(e)}setHideSelectionInterior(e){this.opaqueFaces.setHideSelectionInterior(e),this.transparentFaces.setHideSelectionInterior(e),this.draftAnalysisFaces.setHideSelectionInterior(e),this.qualityVisualization.setHideSelectionInterior(e),this.isolatePass&&this.isolatePass.setHideSelectionInterior(e),this.contextPass&&this.contextPass.setHideSelectionInterior(e)}setRenderingMode(e){switch(this.isolatePass&&this.isolatePass.setRenderingMode(e),this.contextPass&&this.contextPass.setRenderingMode(e),e){case W.P1.SHADED_WITH_EDGES:case W.P1.SIMULATION_RESULTS:case W.P1.THICKNESS_ANALYSIS_VISUALIZATION:this.enableOpaqueFaces(!0,!0,h.OPAQUE),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,null,a.OPAQUE,!0));break;case W.P1.SHADED_WITHOUT_EDGES:this.enableOpaqueFaces(!0,!0,h.OPAQUE),this.enableEdges(!1,!1,!1),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,null,a.OPAQUE,!0));break;case W.P1.SHADED_WITH_HIDDEN_EDGES:this.enableOpaqueFaces(!0,!0,h.OPAQUE),this.enableEdges(!0,!0,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,null,a.OPAQUE,!0));break;case W.P1.HIDDEN_LINE_REMOVED:this.enableOpaqueFaces(!0,!1,h.OPAQUE),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!0),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0));break;case W.P1.HIDDEN_LINE_VISIBLE:this.enableOpaqueFaces(!0,!1,h.OPAQUE),this.enableEdges(!0,!0,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!0),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0));break;case W.P1.WIREFRAME:this.enableOpaqueFaces(!1,!1,h.OPAQUE),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.OPAQUE,!1));break;case W.P1.TRANSLUCENT:this.enableOpaqueFaces(!1,!0,h.OPAQUE),this.enableEdges(!0,!1,!1),this.enableFullOpacity(!1),this.adjustTransparentFacePass(!0,null,a.OPAQUE,!0);break;case W.P1.SHADED_CURVATURE_VISUALIZATION:this.enableOpaqueFaces(!0,!0,h.OPAQUE),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,null,a.OPAQUE,!0));break;case W.P1.CURVATURE_VISUALIZATION:this.enableOpaqueFaces(!0,!0,h.ZEBRA_STRIPES),this.enableEdges(this.viewer.getZebraStripeEdgesOn(),!1,!0),this.enableFullOpacity(!0),this.viewer.supportsOrderIndependentTranslucency()&&this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0);break;case W.P1.DRAFT_ANALYSIS:this.enableOpaqueFaces(!0,!0,h.DRAFT),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!0),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0));break;case W.P1.DEBUG_QUALITY_VISUALIZATION:this.enableOpaqueFaces(!0,!0,h.QUALITY_VISUALIZATION),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!0),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0))}}enableEdges(e,t,i){this.opaqueEdges.setDrawVisibleParts(e),this.silhouettes.setEnabled(e),this.opaqueEdges.setDrawHidden(t),this.silhouettes.setDrawHidden(t),this.silhouettes.setDrawBackFaceSilhouettes(i)}enableOpaqueFaces(e,t,i){let s;switch(i){case h.OPAQUE:s=this.opaqueFaces;break;case h.DRAFT:s=this.draftAnalysisFaces;break;case h.QUALITY_VISUALIZATION:s=this.qualityVisualization;break;case h.ZEBRA_STRIPES:s=this.opaqueFacesZebraStripes}const n=this.getFacePasses();for(let i=0;i<n.length;++i){const r=n[i];r===s?(r.setEnabled(e),r.setEnableColorWrites(t)):r.setEnabled(!1)}}enableFullOpacity(e){let t,i,s;e?(t=a.ALL,i=this.createExcludeForNonBodyFilter(),s=this.createExcludeForNonBodyFilterNoDecals()):(t=a.OPAQUE,i=null,s=null);const n=this.getFacePasses();for(let e=0;e<n.length;++e)n[e].setOpacity(t),n[e]===this.opaqueFaces?n[e].setExtraMeshNodeFilter(i):n[e].setExtraMeshNodeFilter(s)}adjustTransparentFacePass(e,t,i,s){this.transparentFaces.setExtraMeshNodeFilter(t),(this.transparentFaces instanceof Be||this.transparentFaces instanceof xe)&&(this.transparentFaces.appliesTranslucentAlphaToAll(e),this.transparentFaces.setDepthOpacity(i),this.transparentFaces.setDepthPassEnabled(s))}enableTransparentDepth(e){this.depthTransparentFaces.setEnabled(e),e?this.depthTransparentFaces.setNodeFilter(this.createExcludeForNonBodyFilter()):this.depthTransparentFaces.setNodeFilter(null)}getFacePasses(){return[this.opaqueFaces,this.opaqueFacesZebraStripes,this.draftAnalysisFaces,this.qualityVisualization]}setZebraStripeCount(e){var t,i;this.opaqueFacesZebraStripes.setShaderUniform("uStripeCount",e),null===(t=this.contextPass)||void 0===t||t.setZebraStripeCount(e),null===(i=this.isolatePass)||void 0===i||i.setZebraStripeCount(e)}setZebraStripeRotation(e){var t,i;this.opaqueFacesZebraStripes.setShaderUniform("uStripeRotation",e),null===(t=this.contextPass)||void 0===t||t.setZebraStripeRotation(e),null===(i=this.isolatePass)||void 0===i||i.setZebraStripeRotation(e)}}function be(e,t){return new L(e,t)}function Le(e,t,i,s){const n=C(e,new k(e,t),i,s);return n.clearColor=B,n}class Fe extends M{constructor(e,t){super(e),this.checkFrameId=!0,this.shaderTag="endcapMask",this.frameBuffer=null,this.childPasses=[],this.childPasses.push(new mt(this.viewer,this,t));const i=this.viewer.getIsolatedOccurrenceManager();this.fullyTransparentGhostedNodeOccurrenceFilter=e=>{if(e.occurrenceData.getIsolated())return!0;return this.viewer.getModelViewManagers().getManager().isOccurrenceIdForInContext(e.occurrenceData.getOccurrenceId())?!(0===i.getContextTransparencyMultiplier()):!(i.isInIsolateOrMakeTransparentMode()&&i.getIsIsolateFullyTransparent())}}shouldCheckSectionPlaneCount(){return!0}forSectionPlaneEndcapMask(){return!0}preDraw(e){if(!this.frameBuffer){const e=this.viewer.getGlContext();this.frameBuffer=this.viewer.getOrCreateFrameBuffer(this.viewer.getHighPrecisionFloatTextureType(),void 0,{storageType:e.DEPTH_STENCIL,attachmentType:e.DEPTH_STENCIL_ATTACHMENT})}if(this.shouldCheckSectionPlaneCount()&&0===(0,QS.ti)())return!1;if(!super.preDraw(e))return!1;const t=this.viewer.getGlContext();t.disable(t.DEPTH_TEST),t.blendFunc(t.ONE,t.ONE),t.enable(t.BLEND),e.setOverrideFaceCullingMode(Rh.NONE);const i=this.viewer.getIsolatedOccurrenceManager();return(i.isInIsolateOrMakeTransparentMode()&&i.getIsIsolateFullyTransparent()||(0,ve.Eo)()&&0===i.getContextTransparencyMultiplier())&&e.setNodeOccurrenceFilterFunction(this.fullyTransparentGhostedNodeOccurrenceFilter),!0}postDraw(e){super.postDraw(e);const t=this.viewer.getGlContext();t.enable(t.DEPTH_TEST),t.disable(t.BLEND),e.clearOverrideFaceCullingMode(),e.setNodeOccurrenceFilterFunction(null)}}class xe extends f{constructor(e,t,i,a){super(e,t),this.childPasses=[],this.applyTranslucentAlphaToAll=!1,this.blendFilter=n.ALL,this.sceneGraph=i;const o=new se(this.viewer,t,{primitiveType:s.FACES,disableColorWrites:!0,performIsolationTest:!0}),h=new se(this.viewer,t,{primitiveType:s.FACES,disableColorWrites:!0,performIsolationTest:!0,shaderTagSuffix:Df}),c=new I(e,o,h,QS.eQ);c.setCheckFrameId(!0),this.accumulationPass=new qe(this.viewer,t,r.ACCUMULATION,c),this.revealagePass=new qe(this.viewer,t,r.REVEALAGE,c),this.compositePass=new Ue(this.viewer,this.accumulationPass,this.revealagePass,i,a),this.setSceneGraph(i),this.childPasses.push(this.compositePass)}appliesTranslucentAlphaToAll(e){this.applyTranslucentAlphaToAll=e,this.accumulationPass.appliesTranslucentAlphaToAll(e),this.revealagePass.appliesTranslucentAlphaToAll(e)}setSceneGraph(e){this.sceneGraph=e,this.accumulationPass.setSceneGraph(e),this.revealagePass.setSceneGraph(e),this.compositePass.setSceneGraph(e)}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}setBlendFilter(e){this.blendFilter=e,this.accumulationPass.setBlendFilter(e),this.revealagePass.setBlendFilter(e)}setDepthPassEnabled(e){this.accumulationPass.setDepthPassEnabled(e),this.revealagePass.setDepthPassEnabled(e)}setDepthOpacity(e){this.accumulationPass.setDepthOpacity(e),this.revealagePass.setDepthOpacity(e)}setExtraMeshNodeFilter(e){this.accumulationPass.setExtraMeshNodeFilter(e),this.revealagePass.setExtraMeshNodeFilter(e),this.extraMeshNodeFilter=e}setTintColor(e){this.accumulationPass.setTintColor(e)}setTintFactor(e){this.accumulationPass.setTintFactor(e)}setHideSelectionInterior(e){this.accumulationPass.setHideSelectionInterior(e)}setPerformIsolationTest(e){this.accumulationPass.setPerformIsolationTest(e),this.revealagePass.setPerformIsolationTest(e)}}class Be extends I{constructor(e,t,i,s){super(e,t,i,s)}appliesTranslucentAlphaToAll(e){this.pass1.appliesTranslucentAlphaToAll(e)}setDepthOpacity(e){this.pass1.setDepthOpacity(e)}setDepthPassEnabled(e){this.pass1.setDepthPassEnabled(e)}setExtraMeshNodeFilter(e){this.pass1.setExtraMeshNodeFilter(e),this.pass2.setExtraMeshNodeFilter(e)}}class Ue extends E{constructor(e,t,i,s,n){super(e),this.shaderTag="OITComposite",this.inputs.uAccumulationBuffer=t,this.inputs.uRevealageBuffer=i,this.sceneGraph=s;const r=this.viewer.getGlContext(),a={id:"transparency",storageType:r.DEPTH_COMPONENT16,attachmentType:r.DEPTH_ATTACHMENT};n=n||"";const o=this.viewer.getOrCreateFrameBuffer(this.viewer.getDefaultFloatTextureType(),n+"TranslucentBufferAccumulation",a),h=this.viewer.getOrCreateFrameBuffer(r.UNSIGNED_BYTE,n+"TranslucentBufferRevealage",a);this.inputs.uAccumulationBuffer.setFrameBuffer(o),this.inputs.uRevealageBuffer.setFrameBuffer(h)}setSceneGraph(e){this.sceneGraph=e}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}}const Ve=q.default.getManager(),Ge=a,He=s,ke=function(e,t,i,s,n,r){const a=new xe(e,t,i,r);return a.setTintColor(s),a.setTintFactor(n),a};class We extends z{constructor(e,t){super(e,t),this.overBlendColorNeedsUpdate=!0;const i=this.viewer.getSceneGraphs().getPreviewSceneGraph(),s=Ve.getColor("COMPARE_BASE_TINT").slice(0,3),r=Ve.getColor("COMPARE_TARGET_TINT").slice(0,3),a=Ve.getColor("COMPARE_SAME_LIT_TINT").slice(0,3),o=Ve.getColor("COMPARE_SAME_UNLIT_TINT").slice(0,3);this.underDepthPass=Le(this.viewer,null,1),this.existsInBothDepthPass=Le(this.viewer,this.underDepthPass,1),this.underPlaneIdPass=C(this.viewer,new Dt(this.viewer,this,null),1),this.existsInBothPlaneIdPass=C(this.viewer,new Dt(this.viewer,this,this.underPlaneIdPass),1),this.baseDefaultPasses.opaqueFaces=new De(this.viewer,this,{},s,a,this.existsInBothDepthPass),this.compareDefaultPasses.opaqueFaces=new De(this.viewer,this,{sceneGraph:i},r,a,this.existsInBothDepthPass),this.viewer.supportsOrderIndependentTranslucency()&&(this.baseDefaultPasses.transparentFaces=ke(this.viewer,this,null,s,1,"CompareBase"),this.compareDefaultPasses.transparentFaces=ke(this.viewer,this,i,r,1,"CompareTarget")),this.baseDefaultPasses.opaqueEdges.setExtraMeshNodeFilter((function(e){return!e.getIsTintedByCompare()})),this.compareDefaultPasses.opaqueEdges.setExtraMeshNodeFilter((function(e){return!e.getIsTintedByCompare()})),this.baseDefaultPasses.opaquePoints.setExtraMeshNodeFilter((function(e){return!e.getIsTintedByCompare()})),this.compareDefaultPasses.opaquePoints.setExtraMeshNodeFilter((function(e){return!e.getIsTintedByCompare()})),this.baseDefaultPasses.compareTransparentFaces=new De(this.viewer,this,{opacity:Ge.TRANSPARENT},s,o,this.existsInBothPlaneIdPass),this.compareDefaultPasses.compareTransparentFaces=new De(this.viewer,this,{sceneGraph:i,opacity:Ge.TRANSPARENT},r,o,this.existsInBothPlaneIdPass),this.baseDefaultPasses.compareTintedEdges=new De(this.viewer,this,{primitiveType:He.EDGES},s,o,this.existsInBothDepthPass),this.baseDefaultPasses.compareTintedPoints=new De(this.viewer,this,{primitiveType:He.POINTS},s,o,this.existsInBothDepthPass),this.compareDefaultPasses.compareTintedEdges=new De(this.viewer,this,{sceneGraph:i,primitiveType:He.EDGES},r,o,this.existsInBothDepthPass),this.compareDefaultPasses.compareTintedPoints=new De(this.viewer,this,{sceneGraph:i,primitiveType:He.POINTS},r,o,this.existsInBothDepthPass);const h=function(e,t,i,s){const r=[];let a;for(r.push(i.opaqueFaces),r.push(i.opaqueFacesZebraStripes),r.push(i.draftAnalysisFaces),r.push(i.qualityVisualization),r.push(i.transparentFaces),r.push(i.sketchImageFaces),r.push(i.compareTransparentFaces),r.push(i.opaqueEdges),r.push(i.silhouettes),r.push(i.compareTintedEdges),r.push(new ae(e,t,!1,s)),r.push(i.opaquePoints),r.push(i.compareTintedPoints),r.push(new he(e,s,!0)),r.push(new V(e,t)),a=0;a<=Yi.DEFAULT;++a)r.push(i.showThroughNotStencilTested.getChildPass(a)),r.push(i.showThroughDepthTested.getChildPass(a));for(r.push(new he(e,s,!1)),a=Yi.HIGHER;a<=Yi.HIGHEST;++a)r.push(i.showThroughNotStencilTested.getChildPass(a)),r.push(i.showThroughDepthTested.getChildPass(a));return i.showThroughNotStencilTested.setBlendFilter(n.BLEND_ONLY),i.showThroughDepthTested.setBlendFilter(n.BLEND_ONLY),r};this.underBasePass=new f(this.viewer,this),this.underBasePass.childPasses=h(this.viewer,this.underBasePass,this.baseDefaultPasses,Ls.L.BASE),this.underComparePass=new f(this.viewer,this),this.underComparePass.childPasses=h(this.viewer,this.underComparePass,this.compareDefaultPasses,Ls.L.PREVIEW),this.overBufferPass=new M(this.viewer),this.overBufferPass.clearColor=[1,1,1,1],this.overBufferPass.childPasses=[];for(let e=0;e<this.underBasePass.childPasses.length;++e)this.overBufferPass.childPasses.push(this.underBasePass.childPasses[e]),this.overBufferPass.childPasses.push(this.underComparePass.childPasses[e]);this.compareBlendPass=new Ze(this.viewer,this.overBufferPass),this.previewBlendChangedSubscription=ks().stateChangedObservable.pipe((0,Pe.h)((e=>e===Ns.PREVIEW_BLEND_CHANGE))).subscribe((()=>this.onStateChange())),this.listenTo(this.viewer.getEventDispatcher(),VM.so,this.onSessionEnded),this.setBlendFilters()}onSessionEnded(){this.previewBlendChangedSubscription.unsubscribe(),super.onSessionEnded()}onStateChange(){this.enabled&&(0,Js.vm)()}drawInputs(e){let t;if(zs()<.5){for(t=0;t<this.underDepthPass.childPasses.length;++t)this.underDepthPass.childPasses[t].setSceneGraph(this.viewer.getSceneGraphs().getMainSceneGraph()),this.existsInBothDepthPass.childPasses[t].setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph());this.underPlaneIdPass.childPasses[0].setSceneGraph(this.viewer.getSceneGraphs().getMainSceneGraph()),this.existsInBothPlaneIdPass.childPasses[0].setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses=[this.underBasePass,this.compareBlendPass]}else{for(t=0;t<this.underDepthPass.childPasses.length;++t)this.underDepthPass.childPasses[t].setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.existsInBothDepthPass.childPasses[t].setSceneGraph(this.viewer.getSceneGraphs().getMainSceneGraph());this.underPlaneIdPass.childPasses[0].setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.existsInBothPlaneIdPass.childPasses[0].setSceneGraph(this.viewer.getSceneGraphs().getMainSceneGraph()),this.childPasses=[this.underComparePass,this.compareBlendPass]}f.prototype.drawInputs.call(this,e)}setZebraStripeCount(e){this.baseDefaultPasses.setZebraStripeCount(e),this.compareDefaultPasses.setZebraStripeCount(e)}setZebraStripeRotation(e){this.baseDefaultPasses.setZebraStripeRotation(e),this.compareDefaultPasses.setZebraStripeRotation(e)}preDraw(e){if(this.overBlendColorNeedsUpdate){const e=this.viewer.$el.css("background-color");this.overBufferPass.clearColor=q.default.getManager().parseColor(e),this.overBlendColorNeedsUpdate=!1}return super.preDraw(e)}}class ze extends se{constructor(e,t,i){super(e,t,i),this.enabled=!1,this.shaderTag="alternates-"+this.shaderTag}usesShader(){return!0}preDraw(e){return this.initializeShader(),e.setPickPrimitiveAlternates(!0),super.preDraw(e)}postDraw(e){return e.setPickPrimitiveAlternates(!1),super.postDraw(e)}}class Xe extends Ae{constructor(e){super(e,null),this.shaderTag="depth",this.points=[],this.includePlanes=!0,this.childPasses=[],this.previewPasses=[],this.clearColor=Js.XD;for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].destroy();this.childPasses.push(new se(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!0}));const t=function(e){return e.getParent().getId()===Zp},i=new se(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0,extraShaderUniforms:[{name:"uUsePrimitiveSize",value:1}]});i.setExtraMeshNodeFilter(t),this.childPasses.push(i);const n=new se(this.viewer,this,{primitiveType:s.POINTS,performIsolationTest:!0,extraShaderUniforms:[{name:"uUsePrimitiveSize",value:1}]});n.setExtraMeshNodeFilter(t),this.childPasses.push(n);const r=new se(this.viewer,this,{performIsolationTest:!0});r.setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses.push(r),this.previewPasses.push(r);const o=new se(this.viewer,this,{opacity:a.TRANSPARENT,performIsolationTest:!0});o.setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses.push(o),this.previewPasses.push(o)}setRetrieveFromPreview(e){for(let t=0;t<this.previewPasses.length;++t)this.previewPasses[t].setEnabled(e)}nodeFilter(e){if(e.isMeshNode()){if(!e.getIncludedInBlend())return!1;if(HC(e))return this.includePlanes}return!0}draw(e){throw"Use DepthRetrievalPass retrieve method instead"}retrieve(e,t){this.includePlanes=t,super.draw(e)}postDraw(e){const t=this.pickRect[2]*this.pickRect[3]*4,i=new Uint8Array(t),s=this.viewer.getGlContext();s.readPixels(0,0,this.pickRect[2],this.pickRect[3],s.RGBA,s.UNSIGNED_BYTE,i),this.points=[];for(let e=0;e<t/4;e++){const t=4*e,s=(0,Js.Rg)([i[t],i[t+1],i[t+2],i[t+3]],this.viewer.isHighPrecisionSupportedInFragmentShader());this.points.push([this.pickRect[0]+e%this.pickRect[2],this.pickRect[1]+(this.pickRect[3]-Math.floor(e/this.pickRect[2])),s])}M.prototype.postDraw.call(this,e),super.postDraw(e)}}class qe extends M{constructor(e,t,i,s){super(e,{makeFrameBuffer:!1}),this.component=i,this.depthPass=s,this.sceneGraph=null,this.clearColor=[0,0,0,0],this.colorPass=new F(this.viewer,i),this.childPasses=[this.depthPass,this.colorPass],this.component!==r.ACCUMULATION&&(this.clearColor=[1,1,1,1])}clearBuffer(e){const t=this.viewer.getGlContext();t.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),e&&e.getFrameId()===this.depthPass.getLastRenderedFrame()?t.clear(t.COLOR_BUFFER_BIT):t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}appliesTranslucentAlphaToAll(e){this.colorPass.appliesTranslucentAlphaToAll(e)}setSceneGraph(e){this.colorPass.setSceneGraph(e),this.depthPass.setSceneGraph(e)}setBlendFilter(e){this.colorPass.setBlendFilter(e)}setDepthPassEnabled(e){this.depthPass.setEnabled(e)}setDepthOpacity(e){e===a.ALL?this.depthPass.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilter()):this.depthPass.setExtraMeshNodeFilter(null),this.depthPass.setOpacity(e)}setExtraMeshNodeFilter(e){this.colorPass.setExtraMeshNodeFilter(e)}setTintColor(e){this.colorPass.setTintColor(e)}setTintFactor(e){this.colorPass.setTintFactor(e)}setHideSelectionInterior(e){this.colorPass.setHideSelectionInterior(e)}setPerformIsolationTest(e){this.colorPass.performIsolationTest=e}}class Ze extends E{constructor(e,t){super(e),this.shaderTag="compareBlend",this.inputs.uOverBufferPass=t}justBeforeDraw(e){super.justBeforeDraw(e),this.shader.uniform1f("uBlend",Nt())}}class Ye extends z{constructor(e,t){super(e,t);const i=[0,0,0,0];this.baseBufferPass=new M(this.viewer),this.compareBufferPass=new M(this.viewer),this.baseBufferPass.clearColor=i,this.compareBufferPass.clearColor=i;const s=new Set;s.add(yn.o2.FILTERED_ENTITIES);const n=(e,t,i)=>{const n=[this.nonEditedFaceDepthPass,this.nonEditedEdgeDepthPass,t.opaqueFaces,t.opaqueFacesZebraStripes,t.draftAnalysisFaces,t.qualityVisualization,t.transparentFaces,t.depthTransparentFaces,t.sketchImageFaces,t.sectionPlaneEndcap,t.opaqueEdges,t.silhouettes,t.transparentEdges,t.opaquePoints,t.isolatePass];t.contextPass&&n.push(t.contextPass),n.push(new ae(e,null,!1,i,s)),n.push(new he(e,i,!0,s)),n.push(new V(e,this));for(let e=0;e<Yi.COUNT;++e)n.push(t.showThroughStencilTested.getChildPass(e)),n.push(t.showThroughNotStencilTested.getChildPass(e)),n.push(t.showThroughDepthTested.getChildPass(e));return n.push(new he(e,i,!1,s)),n};this.baseBufferPass.childPasses=n(this.viewer,this.baseDefaultPasses,Ls.L.BASE),this.compareBufferPass.childPasses=n(this.viewer,this.compareDefaultPasses,Ls.L.PREVIEW),this.previewBlendPass=new ue(this.viewer,this.baseBufferPass,this.compareBufferPass),this.setBlendFilters(),this.previewStateChangeSubscription=ks().stateChangedObservable.subscribe((()=>this.onStateChange())),this.listenTo(this.viewer.getEventDispatcher(),VM.so,this.onSessionEnded),this.onStateChange()}onSessionEnded(){this.previewStateChangeSubscription.unsubscribe(),super.onSessionEnded()}onStateChange(){if(this.childPasses=[],!Zs()&&!Ys())if(Qs())this.pushOpaqueDepthPassWithAlpha(),this.childPasses.push(this.previewBlendPass);else for(let e=0;e<this.compareBufferPass.childPasses.length;++e){const t=this.compareBufferPass.childPasses[e];t!==this.nonEditedFaceDepthPass&&t!==this.nonEditedEdgeDepthPass&&this.childPasses.push(t)}this.viewer.requestDraw()}setDraftAnalysisPullDirection(e){this.baseDefaultPasses.draftAnalysisFaces.setPullDirection(e),this.compareDefaultPasses.draftAnalysisFaces.setPullDirection(e)}setDraftAnalysisMinimumAngle(e){this.baseDefaultPasses.draftAnalysisFaces.setMinimumAngle(e),this.compareDefaultPasses.draftAnalysisFaces.setMinimumAngle(e)}setDraftAnalysisParts(e){this.baseDefaultPasses.draftAnalysisFaces.setParts(e),this.compareDefaultPasses.draftAnalysisFaces.setParts(e)}setDraftAnalysisShowUndercut(e){this.baseDefaultPasses.draftAnalysisFaces.setShowUndercut(e),this.compareDefaultPasses.draftAnalysisFaces.setShowUndercut(e)}setZebraStripeCount(e){this.baseDefaultPasses.setZebraStripeCount(e),this.compareDefaultPasses.setZebraStripeCount(e)}setZebraStripeRotation(e){this.baseDefaultPasses.setZebraStripeRotation(e),this.compareDefaultPasses.setZebraStripeRotation(e)}}let Ke=0;function je(e){Ke=e}function Qe(){return Ke}const $e=q.default.getManager(),Je="uIsolateContextOpacity",et=$e.getNumber("ISOLATE_CONTEXT_FACE_TRANSPARENCY"),tt=$e.getNumber("ISOLATE_CONTEXT_EDGE_TRANSPARENCY");class it extends Ne{constructor(e,t,i,n){super(e,t,i,n,!1);const r=function(e){dt(e.viewer.getGlContext(),u.FACES),se.prototype.postDraw.apply(this,arguments)};this.depthFaces.postDraw=r,this.depthFaces.opacity=a.ALL,this.depthEdges.forDepth=!0,this.depthEdges.postDraw=function(e){dt(e.viewer.getGlContext(),u.EDGES),se.prototype.postDraw.apply(this,arguments)},this.depthEdges.opacity=a.ALL,this.sectionPlaneEndcap.childPasses.forEach((e=>{e.forDepthTesting=!0,e.shaderTag="endcap-depth"})),this.opaqueFaces=new se(this.viewer,this,{primitiveType:s.FACES,opacity:a.ALL,depthTestMode:g.LEQUAL,performIsolationTest:!0,stencilMode:c.WRITE_AND_TEST_FACES,sceneGraph:i}),this.opaqueFaces.postDraw=r,this.decalPass=new se(this.viewer,this,{primitiveType:s.FACES,opacity:a.ALL,depthTestMode:g.LEQUAL,performIsolationTest:!0,sceneGraph:i}),this.decalPass.setExtraMeshNodeFilter(this.createOnlyDecalsFilter()),this.opaqueFacesZebraStripes=new se(this.viewer,this,{facesShader:h.ZEBRA_STRIPES,performIsolationTest:!0,opacity:a.ALL,depthTestMode:g.LEQUAL,extraShaderUniforms:[{name:"uStripeCount",value:$e.getNumber("ZEBRA_STRIPE_COUNT")},{name:"uStripeRotation",value:$e.getNumber("ZEBRA_STRIPE_ROTATION")},{name:"uFilterWidth",value:$e.getNumber("ZEBRA_STRIPE_FILTER_WIDTH")},{name:"uRespectOrthographic",value:$e.getNumber("ZEBRA_STRIPE_RESPECT_ORTHOGRAPHIC")}]});const o=function(e){const t=this.viewer.getGlContext();t.disable(t.BLEND),se.prototype.justBeforeDraw.apply(this,arguments)};this.opaqueFaces.justBeforeDraw=o,this.opaqueFacesZebraStripes.justBeforeDraw=o,this.sketchImageFaces.justAfterDraw=o}setFilters(){const e=this.getNodeOccurrenceFilter();if(e){this.depthFaces.setNodeOccurrenceFilterFunction(e),this.opaqueFaces.setNodeOccurrenceFilterFunction(e),this.decalPass.setNodeOccurrenceFilterFunction(e),this.opaqueFacesZebraStripes.setNodeOccurrenceFilterFunction(e),this.sketchImageFaces.setNodeOccurrenceFilterFunction(e),this.opaqueEdges.setNodeOccurrenceFilterFunction(e),this.transparentEdges.setNodeOccurrenceFilterFunction(e),this.opaquePoints.setNodeOccurrenceFilterFunction(e);for(let t=Yi.LOWER;t<=Yi.HIGHEST;++t)this.showThroughStencilTested.getChildPass(t).setNodeOccurrenceFilterFunction(e)}this.depthEdges.setNodeOccurrenceFilterFunction((e=>e.occurrenceData.getIsolated()));this.depthFaces.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilterNoDecals(!0))}preDraw(e){if(0===this.getTransparencyMultiplier())return!1;const t=this.getTransparencyMultiplier(),i=t*et*Ke+(1-Ke),s=Math.min(1,3*i);let n=t*tt*Ke+(1-Ke);n=Math.sqrt(n),this.opaqueFaces.setShaderUniform(Je,i),this.decalPass.setShaderUniform(Je,i),this.opaqueFacesZebraStripes.setShaderUniform(Je,i),this.sketchImageFaces.setShaderUniform(Je,s),this.opaqueEdges.setShaderUniform(Je,n),this.transparentEdges.setShaderUniform(Je,n),this.opaquePoints.setShaderUniform(Je,n);for(let e=Yi.LOWER;e<=Yi.HIGHEST;++e)this.showThroughStencilTested.getChildPass(e).setShaderUniform(Je,i);return super.preDraw(e)}setRenderingMode(e){super.setRenderingMode(e),this.opaqueFaces.setOpacity(a.ALL),this.depthFaces.setOpacity(a.ALL),this.depthEdges.setOpacity(a.ALL);this.opaqueFaces.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilterNoDecals(!0));const t=e!==W.P1.HIDDEN_LINE_REMOVED&&e!==W.P1.HIDDEN_LINE_VISIBLE;this.decalPass.setEnabled(t)}setZebraStripeCount(e){this.opaqueFacesZebraStripes.setShaderUniform("uStripeCount",e)}setZebraStripeRotation(e){this.opaqueFacesZebraStripes.setShaderUniform("uStripeRotation",e)}}class st extends it{constructor(e,t,i,s){super(e,t,i,s),this.setFilters()}getNodeOccurrenceFilter(){const e=this.viewer.getModelViewManagers().getManager();return t=>{const i=t.occurrenceData.getOccurrenceId();return!e.isOccurrenceIdForInContext(i)}}getTransparencyMultiplier(){return this.viewer.getIsolatedOccurrenceManager().getIsIsolateFullyTransparent()?0:1}preDraw(e){const t=this.viewer.getModelViewManagers().getManager().getSimulationManager();return!!(this.viewer.getIsolatedOccurrenceManager().isInIsolateOrMakeTransparentMode()||t&&t.isIsolateEffectActive()||null!==this.viewer.getInterferenceCallId()&&""!==this.viewer.getInterferenceCallId())&&super.preDraw(e)}}class nt extends it{constructor(e,t,i,s,n){super(e,t,i,s),this.filterForInContext=n,this.setFilters()}getNodeOccurrenceFilter(){const e=this.viewer.getModelViewManagers().getManager();if(this.filterForInContext){return t=>{if(!e.isDisplayingIncontextAssembly())return!1;const i=t.occurrenceData.getOccurrenceId();return e.isOccurrenceIdForInContext(i)}}return t=>{if(!this.viewer.getIsolatedOccurrenceManager().isInIsolateOrMakeTransparentMode())return!0;const i=t.occurrenceData;return e.isOccurrenceIdForInContext(i.getOccurrenceId())||i.getIsolated()}}getTransparencyMultiplier(){return this.viewer.getIsolatedOccurrenceManager().getContextTransparencyMultiplier()}preDraw(e){return!!(0,ve.Eo)()&&super.preDraw(e)}}class rt extends f{constructor(e,t,i,s){if(super(e,t),this.ghostedChildrenPasses=[],s=s||this.viewer.getSceneGraphs().getMainSceneGraph(),i){this.ghostedChildrenPasses.push(new nt(this.viewer,this,s,_e.ISOLATION,!1));if(s.isForPreview()){const e=this.viewer.getSceneGraphs().getMainSceneGraph();this.ghostedChildrenPasses.push(new nt(this.viewer,this,e,_e.ISOLATION,!0))}}else this.ghostedChildrenPasses.push(new st(this.viewer,this,s,_e.ISOLATION));this.childPasses=[],this.ghostedChildrenPasses.forEach((e=>{this.childPasses.push(e.depthFaces)})),this.ghostedChildrenPasses.forEach((e=>{this.childPasses.push(e.sectionPlaneEndcap)})),this.ghostedChildrenPasses.forEach((e=>{this.childPasses.push(e.depthEdges)})),this.ghostedChildrenPasses.forEach((e=>{this.addModelPasses(e)})),this.childPasses.push(new V(this.viewer,this)),this.ghostedChildrenPasses.forEach((e=>{this.addShowThroughPasses(e)})),this.setRenderingMode(W.P1.SHADED_WITH_EDGES)}addModelPasses(e){this.childPasses.push(e.opaqueFaces),this.childPasses.push(e.decalPass),this.childPasses.push(e.opaqueFacesZebraStripes),this.childPasses.push(e.sketchImageFaces),this.childPasses.push(e.opaqueEdges),this.childPasses.push(e.transparentEdges),this.childPasses.push(e.opaquePoints)}addShowThroughPasses(e){for(let t=Yi.LOWER;t<=Yi.HIGHEST;++t)this.childPasses.push(e.showThroughStencilTested.getChildPass(t))}forIsolate(){return!1}preDraw(e){return!!this.ghostedChildrenPasses.reduce(((t,i)=>i.preDraw(e)||t),!1)&&super.preDraw(e)}setRenderingMode(e){e!==W.P1.TRANSLUCENT&&e!==W.P1.DRAFT_ANALYSIS||(e=W.P1.SHADED_WITH_EDGES),this.ghostedChildrenPasses.forEach((t=>{t.setRenderingMode(e)}))}setHideSelectionInterior(e){this.ghostedChildrenPasses.forEach((t=>{t.setHideSelectionInterior(e)}))}setZebraStripeCount(e){this.ghostedChildrenPasses.forEach((t=>t.setZebraStripeCount(e)))}setZebraStripeRotation(e){this.ghostedChildrenPasses.forEach((t=>t.setZebraStripeRotation(e)))}}class at extends f{constructor(e,t,i,s){super(e,t),this.isolateContextPass=new rt(e,this,i,s);this.childBuffer=C(this.viewer,this.isolateContextPass,1,"highlightBuffer"),this.childBuffer.clearColor=[1,1,1,0];const n=new S(this.viewer,this.childBuffer,{performDrawInputs:!0});this.childPasses=[n]}preDraw(e){return!!this.isolateContextPass.preDraw(e)&&super.preDraw(e)}setRenderingMode(e){this.isolateContextPass.setRenderingMode(e)}setHideSelectionInterior(e){this.isolateContextPass.setHideSelectionInterior(e)}setZebraStripeCount(e){this.isolateContextPass.setZebraStripeCount(e)}setZebraStripeRotation(e){this.isolateContextPass.setZebraStripeRotation(e)}}class ot extends E{constructor(e){super(e),this.shaderTag="debugPickPass",this.pickPass=null}setPickPass(e){this.pickPass=e,this.inputs.uPickBuffer=e}drawInputs(e){}preDraw(e){if(!this.pickPass)return!1;const t=this.pickPass.getPickViewportWidthHeight();let i=10;return t[0]>50&&(i=3),t[0]>200&&(i=1),e.pushViewport([0,0,t[0]*i,t[1]*i]),super.preDraw(e)}postDraw(e){super.postDraw(e),e.popViewport()}}function ht(e,t,i){e.enable(e.STENCIL_TEST),e.stencilFunc(e.GREATER,t,i),e.stencilMask(0),e.stencilOp(e.KEEP,e.KEEP,e.KEEP)}function ct(e,t,i){e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,t,255),e.stencilMask(i),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE)}function lt(e,t,i){e.enable(e.STENCIL_TEST),e.stencilFunc(e.GREATER,t,i),e.stencilMask(i),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE)}function ut(e){e.clearStencil(0),e.stencilMask(255),e.clear(e.STENCIL_BUFFER_BIT)}function dt(e,t){e.clearStencil(0),e.stencilMask(t),e.clear(e.STENCIL_BUFFER_BIT)}var gt=i(28360);class pt extends Ae{constructor(e){super(e,null),this.shaderTag="draftAngle",this.clearColor=[0,0,0,0],this.nodeOccurrenceFilterFunction=null,this.direction=null,this.points=[],this.childPasses=[],this.previewPasses=[],this.nodeFilterFunction=this.createExcludeForNonBodyFilter();for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].destroy();const t=[{name:"uPullDirection",value:v.fromValues(0,0,0)}];this.childPasses.push(new se(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,extraShaderUniforms:t})),this.childPasses.push(new se(this.viewer,this,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!0,extraShaderUniforms:t}));const i=new se(this.viewer,this,{performIsolationTest:!0,extraShaderUniforms:t});i.setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses.push(i),this.previewPasses.push(i);const n=new se(this.viewer,this,{opacity:a.TRANSPARENT,performIsolationTest:!0,extraShaderUniforms:t});n.setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses.push(n),this.previewPasses.push(n)}nodeFilter(e){return this.nodeFilterFunction(e)}setDirection(e){this.direction=e}setOccurrenceIds(e){const t={},i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(!i)return;const s=i.getBodyComponent();for(const i in e){const e=s.retrieveBodyMetaData(i);if(!e)continue;if(!e.isSolidBody()&&!e.isSheetBody())continue;const n=s.partStudioBodyIdToOccurrenceId[i];n&&(t[n]=!0)}this.nodeOccurrenceFilterFunction=e=>t[e.occurrenceData.getOccurrenceId()]}preDraw(e){return!!this.direction&&super.preDraw(e)}justBeforeDraw(e){super.justBeforeDraw(e);const t=e=>{e.setShaderUniform("uPullDirection",this.direction)};(0,gt.Z)(this.childPasses,t),this.previewPasses.forEach(t)}draw(e){throw"Use DraftAngleRetrievalPass retrieve method instead"}retrieve(e){e.setNodeOccurrenceFilterFunction(this.nodeOccurrenceFilterFunction),super.draw(e),e.setNodeOccurrenceFilterFunction(null)}postDraw(e){const t=this.pickRect[2]*this.pickRect[3]*4,i=new Uint8Array(t),s=this.viewer.getGlContext();s.readPixels(0,0,this.pickRect[2],this.pickRect[3],s.RGBA,s.UNSIGNED_BYTE,i),this.points=[];for(let e=0;e<t/4;e++){const t=4*e,s=(0,Js.Pm)([i[t],i[t+1],i[t+2],i[t+3]],this.viewer.isHighPrecisionSupportedInFragmentShader());this.points.push({canvasCoordinate:[this.pickRect[0]+e%this.pickRect[2],this.pickRect[1]+(this.pickRect[3]-Math.floor(e/this.pickRect[2]))],angle:s})}super.postDraw(e)}}class mt extends f{constructor(e,t,i){super(e,t),this.shaderTag="faces",this.sceneGraph=i}usesShader(){return!0}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}preDraw(e){this.initializeShader(),e.activateShader(this.shader);const t=this;return e.nodeFilter=function(e){return t.nodeFilter(e)},!0}onShaderActivated(e,t){(0,QS.qS)(this.viewer,!0)}postDraw(e){}nodeFilter(e){return!(!(e.isMeshNode()&&e.getIsVisible()&&e.isFaces()&&!Lp(e)&&e.getClippedBySectionPlanes())||Gd(e))&&this.parentPass.nodeFilter(e)}needsFaceAppearances(){return!1}}var ft=i(66246),It=i(79275),Et=i(17738),St=i(65044);class Tt extends mt{constructor(e,t){super(e,t,null)}preDraw(e){this.initializeShader(),e.activateShader(this.shader),this.shader.uniform1f("uSectionPlaneCount",0);const t=this;return e.nodeFilter=function(e){return t.nodeFilter(e)},!0}}class Mt extends Fe{constructor(e,t){super(e,null),this.reportedWarning=!1,this.reportedOnCracks=!1,this.childPasses=[],this.visualizedRays=[],this.forFullScreenVisualization=!!t,this.checkFrameId=!this.forFullScreenVisualization,this.camera=new Ph,this.camera.setViewport([0,0,Mt.TEST_VIEWPORT_WIDTH,Mt.TEST_VIEWPORT_HEIGHT]),this.camera.setCanvasDimensions(Mt.TEST_VIEWPORT_WIDTH,Mt.TEST_VIEWPORT_HEIGHT),this.camera.setFrame(rr.Isometric);const i=!(0,Et.isBrowserSafari)();this.resultBuffer=i?new Float32Array(Mt.TEST_VIEWPORT_HEIGHT*Mt.TEST_VIEWPORT_HEIGHT*4):new Uint8Array(Mt.TEST_VIEWPORT_HEIGHT*Mt.TEST_VIEWPORT_HEIGHT*4),this.childPasses.push(new Tt(this.viewer,this)),this.clearColor=this.forFullScreenVisualization?[0,0,0,0]:[0,0,0,1]}shouldCheckSectionPlaneCount(){return!1}preDraw(e){if(this.reportedWarning)return!1;if(!this.forFullScreenVisualization){const e=this.viewer.getModelViewManagers().getManager().getModelBounds();if(!(e&&e.isInitialized()&&e.isFinite()&&e.isExtensive()))return!1;this.camera.setSceneBounds(e),this.camera.zoomToFit(e.getCorners()),this.camera.updateNearFar(),this.viewer.pushCameraState(this.camera)}const t=Fe.prototype.preDraw.apply(this,arguments);return t||this.forFullScreenVisualization||this.viewer.popCameraState(),t}postDraw(e){this.forFullScreenVisualization||(this.viewer.popCameraState(),this.checkBuffer()),Fe.prototype.postDraw.apply(this,arguments)}checkBuffer(){if(this.viewer.areOptimizedBuffersEnabled)return;const e=this.viewer.getGlContext();this.resultBuffer instanceof Float32Array?e.readPixels(0,0,Mt.TEST_VIEWPORT_WIDTH,Mt.TEST_VIEWPORT_HEIGHT,e.RGBA,e.FLOAT,this.resultBuffer):e.readPixels(0,0,Mt.TEST_VIEWPORT_WIDTH,Mt.TEST_VIEWPORT_HEIGHT,e.RGBA,e.UNSIGNED_BYTE,this.resultBuffer);const t=Mt.TEST_VIEWPORT_HEIGHT*Mt.TEST_VIEWPORT_HEIGHT;let i=0,s=0;for(let e=0;e<t;++e)this.checkPixel(s)||++i,s+=4;if(i>=4){const e=i/t*100,s="bad pixel count: "+i+", total pixel count: "+t+", percentage of bad pixels: "+e.toFixed(1)+"%, last element and microversion interval processed: "+this.viewer.getModelViewManagers().getManager().getDescriptionOfLastProcessedPartStudio();if(e>=3){const e=ft.T.getOpenDocumentModel().get("public");It.log.warn("Encountered body/bodies with significant display errors. "+s+"\nisPublic: "+e),this.findBadEntities(),this.reportedWarning=!0}else this.reportedOnCracks||(It.log.info("Encountered body/bodies with display errors.  The body may have cracks in it. "+s),this.reportedOnCracks=!0)}this.reportedWarning||window.localStorage.removeItem(this.getEntityCheckKey())}checkPixel(e){for(let t=0;t<3;++t)if(Math.abs(this.resultBuffer[e+t])>=.001)return!1;return!0}getEntityCheckKey(){let e="loggedBadEntities.";const t=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();return t&&(e+=t.id),e}findBadEntities(){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(!e)return;if(window.localStorage.getItem(this.getEntityCheckKey()))return;const t=e.bodyComponent;let i=0;const s=[],n=v.create(),r=function(e,t){return s.length=0,t&&t.isTriangles()&&(0,Li.Lr)(e,t.getBounds(),n)?(t.iteratePrimitives((function(t,i,n){if(!i||!n)return;const r=(0,Li.AF)(e,t,i,n);void 0!==r&&s.push(r)})),s):s},a=(0,Js.Wj)(),o=new St.StringSet;for(let e=0;e<Mt.TEST_VIEWPORT_HEIGHT;++e)for(let s=0;s<Mt.TEST_VIEWPORT_WIDTH;++s){if(!this.checkPixel(i)){const i=this.camera.getRay(s,Mt.TEST_VIEWPORT_HEIGHT-e);for(const e in t.bodyMetaData){const s=t.bodyMetaData[e];if(!s.isSolidBody()||s.meshState===W.W6T.ALL_MESH)continue;const a=t.bodyToEntity.get(e);if(!a)continue;if(!(0,Li.Lr)(i,s.getBounds(),n))continue;const h={};a.each((function(e,s){const n=t.idToMetaData[s];if(!n)return;const a=r(i,n.getMeshIncrement());for(let e=0;e<a.length;++e){const t=Xu(a[e]);let i=h[t];i||(h[t]=i=new St.StringSet),i.add(s)}return!1}),this);for(const e in h){const t=h[e];t.size()>1&&o.addAll(t.getKeyArray())}}}i+=4}const h=(0,Js.Es)(a);if(h>400&&window.localStorage.setItem(this.getEntityCheckKey(),"true"),o.size()>0){let e="Found overlapping entities ("+h.toFixed(0)+" ms):\n";o.each((function(i){const s=(0,ve.cF)(i),n=t.idToMetaData[i];let r=null;s&&(r=(0,ve.fM)(s)),e+="  entityId: "+i+", bodyId: "+n.getBodyId()+", featureIds: ["+n.getFeatureIds()+"]",e+=r?", featureName: "+r.getName()+", featureType: "+r.getFeatureType()+"\n":" (parent feature not found)\n"}),this),It.log.warn(e)}}toggleRayVisualization(){if(this.visualizedRays.length>0){for(let e=0;e<this.visualizedRays.length;++e)this.visualizedRays[e].remove();this.visualizedRays=[]}else{let e=0;for(let t=0;t<Mt.TEST_VIEWPORT_HEIGHT;++t)for(let i=0;i<Mt.TEST_VIEWPORT_WIDTH;++i){if(!this.checkPixel(e)){const e=this.camera.getRay(i,Mt.TEST_VIEWPORT_HEIGHT-t);this.visualizedRays.push(new Nf(this.viewer,e))}e+=4}}}}Mt.TEST_VIEWPORT_WIDTH=100,Mt.TEST_VIEWPORT_HEIGHT=100;class Ct extends E{constructor(e,t,i,s){super(e),this.highlightType=t,this.disableDuringPreview=s,this.shaderTag="highlightDraw",this.interiorHighlightOpacity=.5,this.inputs.uHighlightBuffer=new wt(this.viewer,t);const n=new _t(this.viewer,t,i),r=n.opaqueFacePass.nodeFilter;n.opaqueFacePass.setNodeFilter((function(e){this.viewer.getIsolatedOccurrenceManager().hasIsolatedInstances()&&e.hasNonIsolatedOccurrences()&&this.viewer.getModelViewManagers().getManager().isNodeForModel(e)&&n.opaqueFacePass.setOpacity(a.ALL);const t=r.call(n.opaqueFacePass,e);return n.opaqueFacePass.setOpacity(a.OPAQUE),t})),n.opaqueFacePass.setNodeOccurrenceFilterFunction((e=>!(!this.viewer.getIsolatedOccurrenceManager().hasIsolatedInstances()||e.occurrenceData.getIsolated())||!e.parentHasTransparency())),this.inputs.uHighlightMask=n,this.scenegraph=this.viewer.getSceneGraphs().getMainSceneGraph()}setMaskOpaqueFaces(e){this.inputs.uHighlightMask.opaqueFacePass.setEnabled(e)}setSceneGraph(e){this.scenegraph=e,this.inputs.uHighlightBuffer.setSceneGraph(e),this.inputs.uHighlightMask.setSceneGraph(e)}getSceneGraph(){return this.scenegraph}getEnabled(){return this.enabled&&(!this.disableDuringPreview||!js())}setInteriorHighlightOpacity(e){this.interiorHighlightOpacity=e}justBeforeDraw(e){super.justBeforeDraw(e);const t=this.viewer.getReferenceHighlights().highlights[this.highlightType];this.shader.uniform4fv("uHighlightColor1",t.color1),this.shader.uniform4fv("uHighlightColorBorder",t.colorBorder),this.shader.uniform1f("uInteriorHighlightOpacity",this.interiorHighlightOpacity),this.shader.uniform1i("uHideSelectionInterior",this.hideSelectionInterior?1:0),this.shader.uniform1i("uOutlineOverlappingInteriorRegions",t.outlineOverlappingInteriorRegions?1:0)}postDraw(e){super.postDraw(e)}}class Dt extends se{constructor(e,t,i){super(e,t,{opacity:a.TRANSPARENT,blendMode:d.ADD}),this.setExtraMeshNodeFilter((function(e){return e.getIsTintedByCompare()})),i&&(this.inputs.uPlaneIdSetBuffer=i)}getShaderId(){return"-planeId-"+this.shaderTag}justBeforeDraw(e){super.justBeforeDraw(e);const t=e.getActiveShader();t.uniform1i("uDoSetTest",this.inputs.uPlaneIdSetBuffer?1:0),this.inputs.uPlaneIdSetBuffer?t.useTexture("uPlaneIdSetBuffer",this.inputs.uPlaneIdSetBuffer.getColorTexture()):t.useBlankTexture("uPlaneIdSetBuffer")}}const vt=P.fromValues(0,0,2048,2048),Pt=ge.create();class yt extends se{constructor(e,t,i,n){super(e,t,{primitiveType:s.FACES,opacity:a.ALL}),this.parentPass=t,this.withDirection=i,this.setSceneGraph(n)}preDraw(e){if(this.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilter()),super.preDraw(e)){e.setOverrideFaceCullingMode(Rh.NONE),e.setOverridePolygonOffset(0,0);const t=this.parentPass.draftAnalysisDrawPass;return e.pushModelViewMatrix(this.withDirection?t.viewMatrixWithDirection:t.viewMatrixAgainstDirection),e.pushProjectionMatrix(this.withDirection?t.projectionMatrixWithDirection:t.projectionMatrixAgainstDirection),(0,QS.qS)(this.viewer,!0,!0),this.viewer.getGlContext().colorMask(this.withDirection,!this.withDirection,!1,!1),!0}return!1}postDraw(e){e.popModelViewMatrix(),e.popProjectionMatrix(),(0,QS.qS)(this.viewer,!0,!0),e.clearOverrideFaceCullingMode(),e.clearOverridePolygonOffset(),super.postDraw(e)}}class At extends M{constructor(e,t,i){super(e,{id:"draftAnalysisShadowTest"}),this.shaderTag="draftShadow",this.checkFrameId=!1,this.clearColor=[255,255,255,255],this.draftAnalysisDrawPass=t,this.childPasses=[new yt(e,this,!0,i),new V(e,this),new yt(e,this,!1,i)]}initializeFrameBuffer(e){this.textureType=e.FLOAT,super.initializeFrameBuffer(e)}preDraw(e){return e.pushViewport(vt),!!super.preDraw(e)||(e.popViewport(),!1)}postDraw(e){e.popViewport(),super.postDraw(e)}}class Ot extends se{constructor(e,t,i,s){super(e,t,{facesShader:h.DRAFT,performIsolationTest:i}),this.pullDirection=null,this.showUndercut=!0,this.idToParts={},this.doDraftAnalysis=!0,this.setSceneGraph(s),this.angle=W.zG4.DEFAULT_MINIMUM_ANGLE_RADIANS,this.viewMatrixWithDirection=this.projectionMatrixWithDirection=this.viewMatrixAgainstDirection=this.projectionMatrixAgainstDirection=Pt,this.inputs.uDraftShadowMap=new At(e,this,s),this.usage=s===this.viewer.getSceneGraphs().getMainSceneGraph()?Ls.L.BASE:Ls.L.PREVIEW}setPullDirection(e){this.pullDirection=e}setMinimumAngle(e){this.angle=e}setParts(e){e?(this.idsToParts={},e.forEach((function(e){Object.values(e.getDeterministicIds()).forEach((function(t){this.idsToParts[t]=e}),this)}),this)):It.log.error("Tried to set the draft analysis parts array to null.")}setShowUndercut(e){this.showUndercut=e}getIdsToParts(){return this.idsToParts}justBeforeDraw(e){let t;if(super.justBeforeDraw(e),this.shader.uniform1i("uDoDraftAnalysis",this.doDraftAnalysis&&this.pullDirection?1:0),this.pullDirection){const i=pe.w$.multiplyVec4(e.getActiveCamera().getViewMatrix(),P.fromValues(this.pullDirection[0],this.pullDirection[1],this.pullDirection[2],0));t=pe.S4.normalize(v.clone(i))}else t=v.create();this.shader.uniform3fv("uDraftAnalysisDirection",t),this.shader.uniform1f("uMinimumDraftAngle",this.angle);const i=q.default.getManager();this.shader.uniform4fv("uSteepDraftColor",i.getColor("DRAFT_ANALYSIS_STEEP_COLOR")),this.shader.uniform4fv("uUndercutColor",i.getColor("DRAFT_ANALYSIS_UNDERCUT_COLOR")),this.shader.uniform4fv("uWithDirectionColor",i.getColor("DRAFT_ANALYSIS_WITH_DIRECTION_COLOR")),this.shader.uniform4fv("uAgainstDirectionColor",i.getColor("DRAFT_ANALYSIS_AGAINST_DIRECTION_COLOR")),this.shader.uniform1i("uShowUndercut",this.showUndercut?1:0),this.shader.uniformMatrix4fv("uPMVMatrixWith",!1,pe.w$.multiply(this.projectionMatrixWithDirection,this.viewMatrixWithDirection,ge.create())),this.shader.uniformMatrix4fv("uPMVMatrixAgainst",!1,pe.w$.multiply(this.projectionMatrixAgainstDirection,this.viewMatrixAgainstDirection,ge.create())),this.shader.uniform1f("uDraftShadowMapPixelWidth",1/vt[2]),this.shader.uniform1f("uDraftShadowMapPixelHeight",1/vt[3]),this.shader.useTexture("uDraftShadowMap",this.inputs.uDraftShadowMap.getColorTexture())}createCamera(e,t,i){const s=new Ph({direction:e,up:t});s.setViewport(P.clone(vt));const n=i.getBounds();return s.setSceneBounds(n),s.zoomToFit(n.getCorners(),1,P.fromValues(1,1,vt[2]-2,vt[3]-2)),s}addToAnalyseIfApplicable(e,t,i,s){s||(s=t.retrieveBodyMetaData(e)),s&&(s.containsOnlySolidBodies()||s.containsOnlySheetBodies())&&i.set(e,s)}draw(e){if(!this.getEnabled())return;const t=this.viewer.getModelViewManagers().getManagerForUsage(this.usage).getDisplayedPartStudio();if(!t)return;let i=0,s=function(e){return e.occurrenceData.getOccurrenceId()===i};e.setNodeOccurrenceFilterFunction(s);const n=t.getBodyComponent(),r={};this.doDraftAnalysis=!0;for(const t in this.idsToParts){const s=n.retrieveBodyMetaData(t),a=new Map;if(s&&s.isOpenCompositeBody)for(const e of s.constituentBodyIds)this.addToAnalyseIfApplicable(e,n,a);else this.addToAnalyseIfApplicable(t,n,a,s);for(const[t,s]of a.entries())if(i=n.partStudioBodyIdToOccurrenceId[t],i){if(r[i]=!0,this.pullDirection){const e=pe.S4.normalize(pe.S4.getAPerpendicularVector(this.pullDirection),v.create());let t=this.createCamera(v.clone(this.pullDirection),e,s);this.viewMatrixWithDirection=t.getViewMatrix(),this.projectionMatrixWithDirection=t.getProjectionMatrix(),t=this.createCamera(pe.S4.scale(this.pullDirection,-1,v.create()),e,s),this.viewMatrixAgainstDirection=t.getViewMatrix(),this.projectionMatrixAgainstDirection=pe.w$.scale(t.getProjectionMatrix(),[-1,1,1])}else this.viewMatrixWithDirection=this.projectionMatrixWithDirection=this.viewMatrixAgainstDirection=this.projectionMatrixAgainstDirection=Pt;super.drawInputs(e),super.draw(e)}}s=function(e){return!r[e.occurrenceData.getOccurrenceId()]},e.setNodeOccurrenceFilterFunction(s),this.doDraftAnalysis=!1,super.draw(e),e.setNodeOccurrenceFilterFunction(null),this.postDraw(e)}postDraw(e){this.viewMatrixWithDirection=this.projectionMatrixWithDirection=this.viewMatrixAgainstDirection=this.projectionMatrixAgainstDirection=Pt}}class Rt extends f{constructor(e){super(e,null),this.shaderTag="draw",this.ssaoBufferPass=null,this.inferenceDisplayPasses=[],this.clearColor=[0,0,0,0],this.forceHideInteriorSelections=!1;const t=q.default.getManager();this.defaultPasses=new Ne(this.viewer,this,this.viewer.getSceneGraphs().getMainSceneGraph(),_e.RENDERING),this.childPasses=[],this.childPasses.push(this.defaultPasses.opaqueFaces),this.childPasses.push(this.defaultPasses.opaqueFacesZebraStripes),this.childPasses.push(this.defaultPasses.draftAnalysisFaces),this.childPasses.push(this.defaultPasses.qualityVisualization),t.getNumber("AMBIENT_OCCLUSION_EFFECT_FACTOR")>0&&(0,Js.pc)(e.getGlContext())&&(this.ssaoBufferPass=Te(this.viewer),this.defaultPasses.opaqueFaces.setInput("uOcclusionMap",this.ssaoBufferPass)),this.partPreviewPass=new Ye(this.viewer,this),this.childPasses.push(this.partPreviewPass),this.partComparePass=new We(this.viewer,this),this.childPasses.push(this.partComparePass),this.childPasses.push(this.defaultPasses.transparentFaces),this.defaultPasses.depthTransparentFaces.setEnabled(!1),this.childPasses.push(this.defaultPasses.depthTransparentFaces),this.childPasses.push(this.defaultPasses.sketchImageFaces),this.childPasses.push(this.defaultPasses.sectionPlaneEndcap),this.childPasses.push(this.defaultPasses.opaqueEdges),this.childPasses.push(this.defaultPasses.silhouettes);const i=new se(this.viewer,this,{primitiveType:s.EDGES,stencilMode:c.OFF});this.childPasses.push(i),this.childPasses.push(this.defaultPasses.transparentEdges);const n=new he(this.viewer,Ls.L.BASE,!0);this.childPasses.push(n),this.childPasses.push(this.defaultPasses.isolatePass),this.defaultPasses.contextPass&&this.childPasses.push(this.defaultPasses.contextPass),this.childPasses.push(this.defaultPasses.opaquePoints);const r=new ae(this.viewer,this,!1),a=new ae(this.viewer,this,!0);this.faceHighlightDrawPass=new I(this.viewer,r,a,QS.eQ),this.childPasses.push(this.faceHighlightDrawPass),this.childPasses.push(new V(this.viewer,this));for(let e=Yi.LOWER;e<=Yi.DEFAULT;++e)this.childPasses.push(this.defaultPasses.showThroughStencilTested.getChildPass(e)),this.childPasses.push(this.defaultPasses.showThroughNotStencilTested.getChildPass(e)),this.childPasses.push(this.defaultPasses.showThroughDepthTested.getChildPass(e));this.linePointAllHighlightsDrawPass=new he(this.viewer,Ls.L.BASE,!1),this.childPasses.push(this.linePointAllHighlightsDrawPass);for(let e=Yi.HIGHER;e<=Yi.HIGHEST;++e)this.childPasses.push(this.defaultPasses.showThroughStencilTested.getChildPass(e)),this.childPasses.push(this.defaultPasses.showThroughNotStencilTested.getChildPass(e)),this.childPasses.push(this.defaultPasses.showThroughDepthTested.getChildPass(e));if(this.childPasses.push(new L(this.viewer,this)),this.visualizeBodyCheckPass=new S(this.viewer,this.viewer.bodyCheckPass,{viewport:[0,0,Mt.TEST_VIEWPORT_WIDTH,Mt.TEST_VIEWPORT_HEIGHT]}),this.visualizeBodyCheckPass.setEnabled(!1),this.childPasses.push(this.visualizeBodyCheckPass),this.visualizeFullScreenBodyCheckPass=new S(this.viewer,new Mt(e,!0),{shaderTag:"blitBodyCheck",performDrawInputs:!0}),this.visualizeFullScreenBodyCheckPass.setEnabled(!1),this.childPasses.push(this.visualizeFullScreenBodyCheckPass),this.debugDrawPickPass=new ot(this.viewer),this.debugDrawPickPass.setEnabled(!1),this.childPasses.push(this.debugDrawPickPass),0!==t.getNumber("DISPLAY_INFERENCE_BUFFER")){const e=new se(this.viewer,this,{primitiveType:s.EDGES,visibility:o.SHOWTHROUGH,priority:Yi.LOWER,disableDepthTest:!0});e.setEnabled(!1);const t=new se(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,priority:Yi.DEFAULT,disableDepthTest:!0});t.setEnabled(!1);const i=new se(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,priority:Yi.HIGHER,disableDepthTest:!0});i.setEnabled(!1),this.childPasses.push(e),this.childPasses.push(t),this.childPasses.push(i),this.inferenceDisplayPasses.push(e),this.inferenceDisplayPasses.push(t),this.inferenceDisplayPasses.push(i)}this.setRenderingMode(W.P1.SHADED_WITH_EDGES),this.previewStateChangeSubscription=ks().stateChangedObservable.pipe((0,Pe.h)((e=>e===Ns.PREVIEW_STATE_CHANGE))).subscribe((()=>this.onPreviewStateChange())),this.previewBlendChangeSubscription=ks().stateChangedObservable.pipe((0,Pe.h)((e=>e===Ns.PREVIEW_BLEND_CHANGE))).subscribe((()=>this.updateHideInteriorSelections())),this.onPreviewStateChange(),this.listenTo(this.viewer.getEventDispatcher(),VM.so,this.onSessionEnded)}onSessionEnded(){this.previewStateChangeSubscription.unsubscribe(),this.previewBlendChangeSubscription.unsubscribe(),super.onSessionEnded()}setClearColor(e,t,i,s){this.clearColor=[e,t,i,s]}getClearColor(){return this.clearColor.slice()}onPreviewStateChange(){this.partPreviewPass.setEnabled(js()),this.partComparePass.setEnabled(Ys()),Ys()?(this.faceHighlightDrawPass.setEnabled(!1),this.linePointAllHighlightsDrawPass.setEnabled(!1)):(this.faceHighlightDrawPass.setEnabled(!0),this.linePointAllHighlightsDrawPass.setEnabled(!0)),!Zs()&&this.viewer.getSupportsPreview()?(this.defaultPasses.setBlendFilter(n.NON_BLEND_ONLY),$s()&&this.defaultPasses.transparentFaces.setEnabled(!1),this.defaultPasses.sectionPlaneEndcap.setEnabled(!1),this.defaultPasses.isolatePass.setEnabled(!1),this.defaultPasses.contextPass&&this.defaultPasses.contextPass.setEnabled(!1)):(this.defaultPasses.setBlendFilter(n.ALL),this.defaultPasses.transparentFaces.setEnabled(!0),this.defaultPasses.sectionPlaneEndcap.setEnabled(!0),this.defaultPasses.isolatePass.setEnabled(!0),this.defaultPasses.contextPass&&this.defaultPasses.contextPass.setEnabled(!0)),this.updateHideInteriorSelections(),this.viewer.requestDraw()}get sectionPlaneEndcapMaskPass(){return this.defaultPasses.sectionPlaneEndcapMask}get draftAnalysisPass(){return this.defaultPasses.draftAnalysisFaces}setForceHideInteriorSelections(e){this.forceHideInteriorSelections=e,this.updateHideInteriorSelections()}updateHideInteriorSelections(){const e=Qs();let t=q.default.getManager().getNumber("DEFAULT_INTERIOR_HIGHLIGHT_OVERLAY_OPACITY");this.forceHideInteriorSelections?this.setHideSelectionInterior(!0):e?(this.defaultPasses.setHideSelectionInterior(!0),this.faceHighlightDrawPass.setHideSelectionInterior(!1),this.partPreviewPass.setHideSelectionInterior(!0),t=q.default.getManager().getNumber("PREVIEW_INTERIOR_HIGHLIGHT_OVERLAY_OPACITY")):this.setHideSelectionInterior(!1),this.faceHighlightDrawPass.pass1.setInteriorHighlightOpacity(t),this.faceHighlightDrawPass.pass2.setInteriorHighlightOpacity(t)}setHideSelectionInterior(e){this.defaultPasses.setHideSelectionInterior(e),this.faceHighlightDrawPass.setHideSelectionInterior(e),this.partPreviewPass.setHideSelectionInterior(e)}visualizeInferenceSceneGraph(e){for(let t=0;t<this.inferenceDisplayPasses.length;++t)this.inferenceDisplayPasses[t].setEnabled(!!e),this.inferenceDisplayPasses[t].setSceneGraph(e)}setRenderingMode(e){this.defaultPasses.setRenderingMode(e),this.partPreviewPass.setRenderingMode(e),this.partComparePass.setRenderingMode(e)}drawInputs(e){this.ssaoBufferPass&&this.ssaoBufferPass.setEnabled(e.getDetailSettings().enableSSAO),super.drawInputs(e)}preDraw(e){if(this.viewer.getXrController().getIsXrRunning())return!0;const t=this.viewer.getGlContext();return t.stencilMask(255),t.clearStencil(0),t.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[1],this.clearColor[2]),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),!0}nodeFilter(e){return e.isMeshNode()||e.getIsVisible()}setDraftAnalysisPullDirection(e){this.defaultPasses.draftAnalysisFaces.setPullDirection(e),this.partPreviewPass.setDraftAnalysisPullDirection(e)}setDraftAnalysisMinimumAngle(e){this.defaultPasses.draftAnalysisFaces.setMinimumAngle(e),this.partPreviewPass.setDraftAnalysisMinimumAngle(e)}setDraftAnalysisParts(e){this.defaultPasses.draftAnalysisFaces.setParts(e),this.partPreviewPass.setDraftAnalysisParts(e)}setDraftAnalysisShowUndercut(e){this.defaultPasses.draftAnalysisFaces.setShowUndercut(e),this.partPreviewPass.setDraftAnalysisShowUndercut(e)}getDebugDrawPickPass(){return this.debugDrawPickPass}setZebraStripeCount(e){this.defaultPasses.setZebraStripeCount(e),this.partComparePass.setZebraStripeCount(e),this.partPreviewPass.setZebraStripeCount(e)}setZebraStripeRotation(e){this.defaultPasses.setZebraStripeRotation(e),this.partComparePass.setZebraStripeRotation(e),this.partPreviewPass.setZebraStripeRotation(e)}getSectionEndcapMaskPassForPicking(e){return js()?e?this.partPreviewPass.getPreviewEndcapMaskPass():this.partPreviewPass.getBaseEndcapMaskPass():Ys()?e?this.partComparePass.getPreviewEndcapMaskPass():this.partComparePass.getBaseEndcapMaskPass():this.sectionPlaneEndcapMaskPass}}class wt extends M{constructor(e,t){super(e,{id:"highlightBuffer"}),this.highlightType=t,this.shaderTag="highlightBuffer",this.childPasses=[],this.clearColor=[0,0,0,0],this.childPasses.push(new se(this.viewer,this,{})),this.childPasses.push(new se(this.viewer,this,{opacity:a.TRANSPARENT}));for(let e=0;e<Yi.COUNT;++e)this.childPasses.push(new se(this.viewer,this,{visibility:o.SHOWTHROUGH,priority:e}))}justBeforeDraw(e){super.justBeforeDraw(e);const t=this.viewer.getGlContext();t.enable(t.BLEND),t.blendFuncSeparate(t.ONE,t.ONE,t.ONE,t.ONE),t.disable(t.DEPTH_TEST),e.getState().callGl("depthMask",!1);const i=e.getActiveShader(),s=this.viewer.getReferenceHighlights().highlights[this.highlightType];i.uniform1f("uActiveHighlightIndex",s.index)}isHighlightPass(){return!0}getActiveHighlightType(){return this.highlightType}needsAttribute(e){const t=e===$d.HIGHLIGHT_ID;return this.parentPass?t||this.parentPass.needsAttribute(e):t}setSceneGraph(e){this.scenegraph=e}getSceneGraph(){return this.scenegraph}}class _t extends M{constructor(e,t,i){super(e,{id:"highlightMask"}),this.highlightType=t,this.shaderTag="highlightMask",this.childPasses=[],this.clearColor=[255,255,255,255],this.opaqueFacePass=new se(this.viewer,this,{shaderTagSuffix:i?Df:""}),this.childPasses.push(this.opaqueFacePass)}justBeforeDraw(e){const t=e.getActiveShader(),i=this.viewer.getReferenceHighlights().highlights[this.highlightType];t.uniform1f("uActiveHighlightIndex",i.index)}setSceneGraph(e){for(let t=0;t<this.childPasses.length;t++)this.childPasses[t].setSceneGraph(e)}needsAttribute(e){const t=e===$d.HIGHLIGHT_ID;return this.parentPass?t||this.parentPass.needsAttribute(e):t}getActiveHighlightType(){return this.highlightType}}function Nt(){const e=ks().previewAlpha;return e<.5?2*e:2*(1-e)}class bt extends Ae{constructor(e,t){super(e,null),this.managerNodeId=t,this.shaderTag="retrieveScalar",this.clearColor=[0,0,0,0],this.results=[];for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].destroy();const i=new se(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,disableColorWrites:!0});i.setNodeFilter((e=>{var t,i;return 0===(null!==(i=null===(t=e.getParent())||void 0===t?void 0:t.getId())&&void 0!==i?i:"").indexOf(gp)&&e.getIsVisible()}));this.setNodeFilterOverride((e=>{const t=e.getParent();return 0===(t?t.getId():"").indexOf(this.managerNodeId)&&t.getIsVisible()}));const n=new se(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0});this.childPasses=[i,n]}draw(e){throw"Use retrieve method instead"}retrieve(e,t){return this.scalarRange=t,super.draw(e),this.results}postDraw(e){const t=this.pickRect[2]*this.pickRect[3]*4,i=new Uint8Array(t),s=this.viewer.getGlContext();s.readPixels(0,0,this.pickRect[2],this.pickRect[3],s.RGBA,s.UNSIGNED_BYTE,i),this.results=[];const n=this.viewer.isHighPrecisionSupportedInFragmentShader();for(let e=0;e<t/4;e++){const t=4*e,s=[i[t],i[t+1],i[t+2],i[t+3]];if(i[3]===this.clearColor[3])continue;const r=(0,Js.NP)(s,n),a=this.scalarRange.scalarFromTextureCoordinate(r);this.results.push({canvasCoordinate:[this.pickRect[0]+e%this.pickRect[2],this.pickRect[1]+(this.pickRect[3]-Math.floor(e/this.pickRect[2]))],scalar:a})}super.postDraw(e)}}var Lt=i(74177),Ft=i(68017);const xt=q.default.getManager();class Bt extends f{constructor(e,t,i,s){super(e,t),this.noSection=s,this.isBackFacePassEnabled=!0,this.blendFilter=n.ALL,this.sceneGraph=i}usesShader(){return!0}getShaderId(){return"-backfacesil-faces"+(this.noSection?Df:"")}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}preDraw(e){if(this.viewer.getIsolatedOccurrenceManager().hasIsolatedInstances())return!1;this.initializeShader(),super.preDraw(e);const t=this.viewer.getGlContext();e.setOverrideFaceCullingMode(Rh.FRONT),e.activateShader(this.shader);const i=this;return e.nodeFilter=function(e){return i.nodeFilter(e)},(0,QS.qS)(this.viewer,!0),this.shader.uniform1f("uLineWidth",xt.getNumber("DEFAULT_LINE_WIDTH")*xt.getNumber("BACKFACE_SILHOUETTE_WIDTH_FACTOR")),this.shader.uniform4fv("uLineColor",this.viewer.getResources().PART_SURFACE_LINE_POINT_MATERIAL.color),this.shader.uniform1f("uSceneDiameter",e.getActiveCamera().getSceneBounds().diameter()),ht(t,l.LOW_PRIORITY_EDGES,u.EDGES),!0}postDraw(e){super.postDraw(e);const t=this.viewer.getGlContext();e.clearOverrideFaceCullingMode(),t.disable(t.STENCIL_TEST)}nodeFilter(e){const t=this.viewer.getModelViewManagers().getManager(),i=e.getParent();if(this.blendFilter===n.BLEND_ONLY){if(!e.getIncludedInBlend())return!1}else if(this.blendFilter===n.NON_BLEND_ONLY&&e.getIncludedInBlend())return!1;return!e.hasTransparency()&&(!!(e.isFaces()&&i&&t.isNodeForBody(i))&&this.parentPass.nodeFilter(e))}setBlendFilter(e){this.blendFilter=e}}class Ut extends se{constructor(e,t,i,n){super(e,t,{primitiveType:s.FACES,sceneGraph:i,disableColorWrites:!0,performIsolationTest:!0}),this.noSection=n}getShaderId(){return"-depth-faces"+(this.noSection?Df:"")}preDraw(e){if(!super.preDraw(e))return!1;const t=this.viewer.getGlContext();return e.setOverrideFaceCullingMode(Rh.FRONT),e.getState().callGl("depthMask",!1),ct(t,l.LOW_PRIORITY_EDGES,u.EDGES),!0}postDraw(e){super.postDraw(e),e.clearOverrideFaceCullingMode()}}class Vt extends f{constructor(e,t,i,n){super(e,t),this.isBackFacePassEnabled=!0,this.edgePass=new j(e,this,{primitiveType:s.SILHOUETTES,performIsolationTest:!0,sceneGraph:i,shaderTagSuffix:n?Df:""}),this.backFaceStencilPass=new Ut(e,this,i,n),this.backfacePass=new Bt(e,this,i,n),this.childPasses=[this.edgePass,this.backFaceStencilPass,this.backfacePass]}setDrawHidden(e){this.edgePass.setDrawHidden(e)}setDrawVisibleParts(e){this.edgePass.setDrawVisibleParts(e),this.backFaceStencilPass.setEnabled(e),this.backfacePass.setEnabled(e)}setBlendFilter(e){this.edgePass.setBlendFilter(e),this.backFaceStencilPass.setBlendFilter(e),this.backfacePass.setBlendFilter(e)}setDrawBackFaceSilhouettes(e){this.isBackFacePassEnabled=e}preDraw(e){if(!this.viewer.debugIsShowingSilhouetteEdgesOnNonVisibleTangentEdgeStyle()&&this.viewer.getSmoothEdgesRenderStyle()!==Ft.Y.VISIBLE&&this.viewer.getRenderingMode()!==Lt.P.HIDDEN_LINE_VISIBLE&&this.viewer.getRenderingMode()!==Lt.P.HIDDEN_LINE_REMOVED)return!1;super.preDraw(e);const t=e.getDetailSettings();this.edgePass.setEnabled(t.enableEdgeSilhouettes);const i=t.enableBackfaceSilhouettes&&this.isBackFacePassEnabled;return this.backFaceStencilPass.setEnabled(i),this.backfacePass.setEnabled(i),!0}}class Gt extends se{constructor(e,t,i,n){super(e,t,{primitiveType:s.FACES,opacity:a.TRANSPARENT,disableColorWrites:!0,performIsolationTest:n}),this.setSceneGraph(i),this.setNodeFilter(this.createExcludeForNonBodyFilter())}getEnabled(){var e,t;switch(this.viewer.getRenderingMode()){case W.P1.SHADED_WITH_HIDDEN_EDGES:return!0;case W.P1.SHADED_WITH_EDGES:case W.P1.SHADED_WITHOUT_EDGES:case W.P1.TRANSLUCENT:case W.P1.SIMULATION_RESULTS:return(null===(t=null===(e=this.viewer.getFilteredEntitiesHighlightController())||void 0===e?void 0:e.getSelectionList())||void 0===t?void 0:t.length)>0;default:return!1}}}var Ht,kt,Wt;function zt(e){switch(e){case Ht.BYTE:case Ht.UNSIGNED_BYTE:return 1;case Ht.SHORT:case Ht.UNSIGNED_SHORT:case Ht.HALF_FLOAT:return 2;case Ht.INT:case Ht.UNSIGNED_INT:case Ht.FLOAT:return 4;default:return It.log.warn("Unrecognized GL type: 0x"+e.toString(16)),0}}function Xt(e,t){return t===W.xB1.ARRAY_BUFFER?e.ARRAY_BUFFER:t===W.xB1.ELEMENT_ARRAY_BUFFER?e.ELEMENT_ARRAY_BUFFER:null}function qt(e){switch(e){case kt.STENCIL_INDEX:case kt.STENCIL_INDEX8:return 1;case kt.RGBA4:case kt.RGB5_A1:case kt.RGB565:case kt.DEPTH_COMPONENT16:return 2;case kt.DEPTH_STENCIL:return 4;default:return It.log.warn("Unrecognized GL render buffer type: 0x"+e.toString(16)),0}}function Zt(e){switch(e){case Wt.DEPTH_COMPONENT:case Wt.ALPHA:case Wt.LUMINANCE:return 1;case Wt.LUMINANCE_ALPHA:return 2;case Wt.RGB:return 3;case Wt.RGBA:return 4;default:return It.log.warn("Unrecognized GL pixel format: 0x"+e.toString(16)),0}}function Yt(e){if(e){const t=["swiftshader"],i=e.toLowerCase();return t.some((e=>i.includes(e)))}return!1}function Kt(){return{glVendor:"unavailable",glRenderer:"unavailable",isCpuRenderer:!1}}!function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT",e[e.HALF_FLOAT=36193]="HALF_FLOAT"}(Ht||(Ht={})),function(e){e[e.RGBA4=32854]="RGBA4",e[e.RGB5_A1=32855]="RGB5_A1",e[e.RGB565=36194]="RGB565",e[e.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",e[e.STENCIL_INDEX=6401]="STENCIL_INDEX",e[e.STENCIL_INDEX8=36168]="STENCIL_INDEX8",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL"}(kt||(kt={})),function(e){e[e.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"}(Wt||(Wt={}));const jt=new Map;function Qt(e){let t=null;if(e){if(t=jt.get(e),t)return t;const i=e.getExtension("WEBGL_debug_renderer_info");if(i){const s=e.getParameter(i.UNMASKED_RENDERER_WEBGL);t={glVendor:e.getParameter(i.UNMASKED_VENDOR_WEBGL),glRenderer:s,isCpuRenderer:Yt(s)},jt.set(e,t)}else t={glVendor:"unavailable",glRenderer:"unavailable",isCpuRenderer:!1}}return t}function $t(e){return Jt(Qt(e).glRenderer)}function Jt(e){return!!e&&e.toLowerCase().indexOf("intel")>=0}function ei(e){if(!e)return!1;const t=e.toLowerCase();return!(t.indexOf("intel")<0)&&(t.indexOf("arc")>=0||t.indexOf("dg1")>=0)}let ti,ii=null,si=null,ni=null,ri=null;function ai(e){void 0===ti?(ti=e,ti?(ii=Uint32Array,si=Ht.UNSIGNED_INT):(ii=Uint16Array,si=Ht.UNSIGNED_SHORT),ni=zt(si),ri=Math.pow(2,8*ni)):ti!==e&&It.log.warn("initialize32BitIndexSupport called twice with two different values")}function oi(){if(!ii)throw"Attempt to get indexBufferType before gl initialized";return ii}function hi(){if(!si)throw"Attempt to get indexElementType before gl initialized";return si}function ci(){if(!ni)throw"Attempt to get indexElementSize before gl initialized";return ni}function li(){if(!ri)throw"Attempt to get maximumVerticesPerVbo before gl initialized "+(new Error).stack;return ri}var ui=i(79493);class di{constructor(){this.gl=null,this.state={},this.stack=[]}setGlContext(e){this.gl=e,this.callGl("depthMask",!0),this.callGl("depthFunc",this.getGl().LEQUAL)}getGl(){return this.gl}capture(){this.stack.push(this.state),this.state=Object.create(this.state)}restore(){if(0===this.stack.length)return void It.log.warn("Graphics state restore attempted without previous capture");const e=this.state,t=this.stack.pop();for(const i in e)if(e.hasOwnProperty(i)){const e=t[i];e&&this.callGl(i,e[0],e[1],e[2],e[3])}this.state=t}callGl(e,t,i,s,n){const r=this.state[e];if(r&&r[0]===t&&r[1]===i&&r[2]===s&&r[3]===n)return;const a=[t,i,s,n];this.gl[e].apply(this.gl,a),this.state[e]=a}getState(e){return this.state[e]}}var gi=i(34444),pi=i(28817),mi=i(94291);class fi{constructor(){this.selected=!1,this.preSelected=!1,this.edgePreSelected=!1,this.edgePointUiElement=null,this.selectedSheetmetalModelId=null}}const Ii=function(e){return e===(0,ve.Wf)()},Ei=function(e,t){if(!(t.isEdge()&&!t.isClosedCurve()))return!1;const i=e.getSketch();if(!t.getSketchEntityId()||!i)return!0;const s=t.getFeatureIds();return 1!==s.length||i.id!==s[0]},Si=function(e){return e.isEdgePoint()},Ti=function(e){if(!e.isVertex())return!1;const t=ft.T.getFeatureOrSubfeatureNode((0,ve.hN)(e));return(null==t?void 0:t.getFeatureType())===mi._.CONSTRUCTION_POINT&&(null==t?void 0:t.getName())===ve.o$.EDGE_POINT},Mi=function(e){const t=gi._3.getActiveFeatureController();if(t){const i=t.featureModel;if(i&&(!e||!i.get("isSketch")))return i}return null};class Ci extends m.T{constructor(e){super(),this.viewer=e,this.edgePointUiElements={},this.purgeTimer=null,this.isEnabled=!1,(0,Ih.Yk)(e),this.edgePointCandidate=new mf;const t=q.default.getManager();this.edgePointPixelSize=t.getNumber("POINT_BODY_SIZE")}enable(){this.viewer.getIsForPreviousVersionDisplay()||(this.isEnabled=!0,this.stopListening(),this.listenTo((0,ve.vi)(),"add",this.onSelectionAdded),this.listenTo((0,ve.vi)(),"remove",this.onSelectionRemoved),this.listenTo((0,ve.vi)(),"reset",this.onSelectionReset),this.listenTo((0,ve.Wf)(),"add",this.onSelectionAdded),this.listenTo((0,ve.Wf)(),"remove",this.onSelectionRemoved),this.listenTo((0,ve.Wf)(),"reset",this.onSelectionReset))}disable(){this.isEnabled&&(this.isEnabled=!1,this.stopListening(),this.removeAllEdgePointUiElements((0,ve.vi)()),this.removeAllEdgePointUiElements((0,ve.Wf)()))}addEdgePointUiElement(e,t,i){let s;s=t?e.getDeterministicId():e.getIdString();let n=this.edgePointUiElements[s];if(n||(n=new fi),t?n.edgePreSelected=!0:i?n.preSelected=!0:n.selected=!0,t&&i){const t=Td.getEdgePointLocation(this.viewer,e,.5),i=this.viewer.getCamera().getPixelSizeAtWorldPoint(t)*this.edgePointPixelSize;if(!t||(0,ve.vi)().models.find((e=>{if(Ti(e)){const s=this.viewer.getModelViewManagers().getManager().extractMeshIncrement(e.getDeterministicId());if(s){const e=s.points;return pe.S4.length(pe.S4.subtract(t,e,v.create()))<i}}return!1}),this))return null}return n.edgePointUiElement||(n.edgePointUiElement=new Td(sh.lL,e,.5,this.viewer)),this.edgePointUiElements[s]=n,n.edgePointUiElement}removeEdgePointUiElementWithDeterministicId(e,t){return!!this.edgePointUiElements.hasOwnProperty(e)&&(t?(this.edgePointUiElements[e].preSelected=!1,this.edgePointUiElements[e].edgePreSelected=!1):this.edgePointUiElements[e].selected=!1,!0)}purgeEdgePointUiElements(e){this.purgeTimer&&(clearTimeout(this.purgeTimer),this.purgeTimer=null);const t=[];Object.entries(this.edgePointUiElements).forEach((function([i,s]){!e&&(s.selected||s.preSelected||s.edgePreSelected)||(s.edgePointUiElement.remove(),t.push(i))})),this.edgePointUiElements=(0,Q.omitProperty)(this.edgePointUiElements,t)}delayedPurgeUiElements(){if(this.purgeTimer)return;const e=this;this.purgeTimer=window.setTimeout((function(){e.purgeEdgePointUiElements()}),0)}removeEdgePointUiElement(e,t,i){let s=e.getDeterministicId();t||(s=e.getIdString()),this.removeEdgePointUiElementWithDeterministicId(s,i)}removeAllEdgePointUiElements(e){const t=Ii(e);Object.entries(this.edgePointUiElements).forEach((function([e,i]){this.removeEdgePointUiElementWithDeterministicId(e,t)}),this)}addSelection(e,t){if(e.isFromOccurrence()||e.isSectionEntity())return;const i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(i&&"string"==typeof e.selectionId)if(e.entityMetaData&&e.entityMetaData.isFromSketch()){if(e.isFlattened()!==this.viewer.getIsForFlattenedDisplay())return!1}else{const t=i.getBodyComponent(null).idToMetaData[e.selectionId];if(!t&&this.viewer.getIsForFlattenedDisplay())return!1;if(t&&t instanceof W.Wzw&&t.getBodyMetaData().isForFlattenedView()!==this.viewer.getIsForFlattenedDisplay())return!1;if(t&&t instanceof W.Wzw&&this.selectedSheetmetalModelId&&t.getBodyMetaData().sheetMetalModelId!==this.selectedSheetmetalModelId)return!1}const s=Ii(t),n=Si(e),r=Ei(this.viewer,e);if(n)this.addEdgePointUiElement(e,!1,s);else if(r){if(s){const t=(0,ve.Nd)();if(!t||t.filter(this.edgePointCandidate)){if("string"==typeof e.selectionId&&e.entityMetaData instanceof W.Wzw&&!(null==i?void 0:i.getBodyComponent().containsEntity(e.selectionId)))return!1;if("string"==typeof e.selectionId&&e.entityMetaData instanceof W.S5B&&!(null==i?void 0:i.getSketchComponent().containsEntity(e.selectionId)))return!1;this.addEdgePointUiElement(e,!0,s)}}}else if(Ti(e)&&!s){const t=this.viewer.getModelViewManagers().getManager();e.getFeatureIds().forEach((function(e){t.showPointBodies(e)}))}}onSelectionAdded(e,t){if(!e)return!1;const i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio(),s=i?i.getEntityIdManager():null;s&&s.getIdForName(e.getIdString())!==Di.JE&&this.addSelection(e,t)}onSelectionRemoved(e,t){if(!e)return!1;const i=this.viewer.getModelViewManagers().getManager(),s=Ii(t),n=Si(e),r=Ei(this.viewer,e);if(n){this.removeEdgePointUiElement(e,!1,s);const t=e.getSubfeatureId();t&&!s&&i.hidePointBodies(t),this.delayedPurgeUiElements()}else if(r&&s)this.removeEdgePointUiElement(e,!0,s),this.delayedPurgeUiElements();else if(Ti(e)&&!s&&Mi(!0)){e.getFeatureIds().forEach((function(e){i.hidePointBodies(e)}))}}addMultipleSelections(e){e.models.forEach((function(t){this.addSelection(t,e)}),this)}onSelectionReset(e,t){if(this.removeAllEdgePointUiElements(e),!Ii(e)){const t=Mi(!0);if(t&&!t.get("isSketch")){const i=function(e){const t=e.get("featureMsg");return t&&t.subFeatures?t.subFeatures.map((function(e){return e.featureId})):[]}(t),s=function(e){return e.filter((function(e){return Ti(e)&&1===e.getFeatureIds().length})).map((function(e){return e.getFeatureIds()[0]}))}(e),n=this.viewer.getModelViewManagers().getManager();(0,pi.difference)(i,s).forEach((function(e){n.hidePointBodies(e)}))}}this.addMultipleSelections(e),t&&t.isForRemapping?this.purgeEdgePointUiElements(!0):this.delayedPurgeUiElements()}getUIElementsForSelection(e){if(Si(e)){const t=this.edgePointUiElements[e.getIdString()];if(t)return[t.edgePointUiElement]}return[]}hideUIElementsForSelection(e){this.getUIElementsForSelection(e).forEach((function(e){e.hide()}))}setSelectedSheetmetalModelId(e){this.selectedSheetmetalModelId=e}}var Di=i(65464);const vi=q.default.getManager();var Pi;!function(e){e.MOUSE_ENTER="mouseenter:",e.MOUSE_MOVE="mousemove:",e.MOUSE_LEAVE="mouseleave:",e.DOUBLE_CLICK="doubleclick:",e.CLICK="click:",e.DRAG_START="dragstart:",e.DRAG="drag:",e.DRAG_STOP="dragstop:",e.SELECT="select:",e.DESELECT="deselect:",e.COMMAND="command:",e.LONG_PRESS_START="longpressstart:",e.LONG_PRESS_END="longpressend:",e.XR_DRAG_START="xrdragstart:",e.XR_DRAG="xrdrag:",e.XR_DRAG_STOP="xrdragstop:"}(Pi||(Pi={}));const yi="",Ai=new Di.si;class Oi{constructor(e,t){this.nodeProperties=e,this.meshIncrement=t,this.selectionId=yi}}class Ri extends m.T{constructor(e,t){super(),this.viewer=e,this.SHARED_DELETION_DETAILS={wasHidden:!1,wasHiddenFromPick:!1,highlights:null},this.nameToMeshIncrement={},this.isHidden=!1,this.isTransparent=!1,this.transform=null,this.normalTransform=null,this.isBeingDragged=!1,this.id="",this.incrementRanges={},this.highlights=[],this.allocatedHighlights=[],this.hasBeenRemoved=!1,this.removeHighlightFromOccurrence=function(e){const t=""+this.graphicsOccurrenceId;let i=null,s=-1;for(let n=0;n<this.allocatedHighlights.length;++n){const r=this.allocatedHighlights[n];if(r.selectionId===t&&e===r.highlightType){i=r,s=n;break}}if(!i)return;this.allocatedHighlights.splice(s,1);const n=this.viewer.getHighlightManager(this.getUsage()),r=n.freeHighlightForSelection(i.highlightType,i.selectionId);if((0,Di.rp)(r)){const t=n.constructHighlightForTypeAndInstance(e,r);this.occurrenceData.updateOccurrenceHighlight(yn.aU.REMOVE,t,this.getUsage())}},(0,Ih.Yk)(e),this.sceneGraphId=t||sh.lL,this.collectionId=qI+Ai.getId(),this.graphicsOccurrenceId=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.collectionId),this.meshOwnerId=WS(),this.occurrenceData=this.viewer.getOccurrenceDataManager().setOccurrenceTransform(this.graphicsOccurrenceId,ge.create()),this.idManager=new vI.E(Di._6.ENTITY),this.viewer.addUIElement(this),this.listenTo(this.viewer.getEventDispatcher(),VM.b3,this.onDevicePixelRatioChanged),this.occurrenceData.setIsolated(!0),this.occurrenceData.setCanIsolateChange(!1)}getDebugId(){return"UIElement"}getOccurrenceData(){return this.occurrenceData}setIsolated(e){this.occurrenceData.setIsolated(e)}onDevicePixelRatioChanged(e){}onAppearanceConstantsUpdated(){}remove(){this.hasBeenRemoved?It.log.warn("Attempted to remove ui element "+this.getDebugId()+"-"+this.meshOwnerId+" multiple times"):(this.hasBeenRemoved=!0,this.stopListening(),this.viewer&&this.viewer.removeUIElement(this),this.viewer.getOccurrenceDataManager().destroyOccurrenceData(this.graphicsOccurrenceId),this.viewer.getOccurrenceIdManager().removeName(this.collectionId),this.removeMeshIncrements(),this.freeAllocatedHighlights())}freeAllocatedHighlights(){const e=this.viewer.getHighlightManager(this.getUsage());for(let t=0;t<this.allocatedHighlights.length;++t){const i=this.allocatedHighlights[t];e.freeHighlightForSelection(i.highlightType,i.selectionId)}}getMeshManager(){return this.viewer.getUiResourceManager().getMeshManager()}getNode(){return this.viewer.getUiResourceManager().getNode(this.sceneGraphId)}getCollectionId(){return this.collectionId}removeMeshIncrements(){for(const e in this.nameToMeshIncrement)this.removeMeshIncrement(e);this.nameToMeshIncrement={},this.viewer.requestDraw()}hasMeshIncrements(){return!(0,Js.hW)(this.nameToMeshIncrement)}containsMeshIncrementWithName(e){return this.nameToMeshIncrement.hasOwnProperty(e)}getInstantiatedMeshIncrement(e){return this.nameToMeshIncrement[e]||null}shouldBeClearedWithSelections(){return!0}getId(){return this.id}setId(e){this.id=e}isVisibleToUser(){return!this.isTransparent&&!this.isHidden}hideIncrements(){for(const e in this.nameToMeshIncrement)this.hideInstantiatedMeshIncrement(e,this.nameToMeshIncrement[e])}showIncrements(){for(const e in this.nameToMeshIncrement)this.showInstantiatedMeshIncrement(e,this.nameToMeshIncrement[e])}hideIncrement(e){const t=this.nameToMeshIncrement[e];t&&this.hideInstantiatedMeshIncrement(e,t)}showIncrement(e){const t=this.nameToMeshIncrement[e];t&&this.showInstantiatedMeshIncrement(e,t)}hide(){(0,Ih.Yk)(this.viewer),this.isVisibleToUser()&&this.hideIncrements(),this.isHidden=!0,this.viewer.requestDraw()}show(){(0,Ih.Yk)(this.viewer);const e=this.isVisibleToUser();this.isHidden=!1,!e&&this.isVisibleToUser()&&this.showIncrements(),this.viewer.requestDraw()}makeTransparent(){this.isVisibleToUser()&&this.hideIncrements(),this.isTransparent=!0}makeOpaque(){const e=this.isVisibleToUser();this.isTransparent=!1,!e&&this.isVisibleToUser()&&this.showIncrements()}isInteractionEnabled(){return!0}getClearModelSelectionsOnPrehilite(){return!0}getTransform(){return this.transform}setTransform(e){e?(this.transform=ge.clone(e),this.viewer.getOccurrenceDataManager().setOccurrenceTransform(this.graphicsOccurrenceId,e)):(this.transform=null,this.viewer.getOccurrenceDataManager().setOccurrenceTransform(this.graphicsOccurrenceId,ge.create()))}transformPoint(e){return this.transform?pe.w$.multiplyVec3(this.transform,e,v.create()):v.clone(e)}getSelection(e,t){if(this.graphicsOccurrenceId!==e)return It.log.warn("An attempt was made to get a selection from a ui element with the wrong occurrence id"),null;const i=this.idManager.getNameForId(t);if(!i)return null;const s=this.nameToMeshIncrement[i];return s?new wh.i(this,s.selectionId,i):null}canPickThrough(){return!1}getModelSelection(e){return null}getPickPriority(e){return null}getUsage(){return Ls.L.BASE}setIncrementPickId(e,t){t.pickId=this.idManager.getOrCreateIdForName(e)}updateMeshIncrement(e,t,i,s){if(!s)return;wi(i);const n=this.removeMeshIncrement(e);i.id=e,this.setIncrementPickId(e,i);const r=new Oi(s,i);r.selectionId=t;const a=this.getMeshManager().addMeshIncrement(i,this.meshOwnerId);if(a){let e=this.incrementRanges[s.id];if(!e){this.incrementRanges[s.id]=e=new BS(this.getDebugId()+" - "+s.toString(!0));const t=new fE;this.getNode().addOccurrenceGeometryToNode(s,this.occurrenceData,t,e)}e.onIncrementAdded(a)}this.nameToMeshIncrement[e]=r,n&&(n.wasHidden&&this.hideIncrement(e),n.wasHiddenFromPick&&this.hideIncrementFromPick(e),n.highlights&&n.highlights.forEach((t=>{this.addHighlightToIncrement(e,t)}))),this.viewer.requestDraw()}updateIncrementAttribute(e,t,i){const s=this.nameToMeshIncrement[e];if(s){const e=this.getMeshManager().getMeshForIncrement(s.meshIncrement);e&&e.updateIncrementAttribute(t,s.meshIncrement.getFullId(),i)}}removeMeshIncrement(e){const t=this.nameToMeshIncrement[e];let i=null;return t&&(i=this.removeInstantiatedMeshIncrement(e,t),this.viewer.requestDraw()),i}removeInstantiatedMeshIncrement(e,t){this.idManager.removeName(e);const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId),s=this.SHARED_DELETION_DETAILS;if(i){const e=this.getUsage();s.wasHidden=this.occurrenceData.isIncrementHidden(i,e),s.wasHiddenFromPick=this.occurrenceData.isIncrementHiddenFromPick(i,e),s.highlights=this.occurrenceData.getEntityHighlights(i,e),s.highlights&&this.occurrenceData.removeEntityHighlights(i,e)}else s.wasHidden=!1,s.wasHiddenFromPick=!1,s.highlights=null;if(this.getMeshManager().removeMeshIncrement(e,this.meshOwnerId),i){const e=this.incrementRanges[t.nodeProperties.id];e&&(e.onIncrementRemoved(i),e.isEmpty()&&(this.getNode().removeOccurrenceFromNode(t.nodeProperties,this.graphicsOccurrenceId),delete this.incrementRanges[t.nodeProperties.id]))}return delete this.nameToMeshIncrement[e],s}hideInstantiatedMeshIncrement(e,t){const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);i&&this.occurrenceData.hideIncrement(i,this.getUsage())}showInstantiatedMeshIncrement(e,t){const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);i&&this.occurrenceData.showIncrement(i,this.getUsage())}hideIncrementFromPick(e){const t=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);t&&this.occurrenceData.hideIncrementFromPick(t,this.getUsage())}addHighlight(e){Fn(e,this.highlights)}removeHighlight(e){return xn(e,this.highlights,!1)>=0}isHighlighted(){return this.highlights.length>0}getHighlight(){return this.isHighlighted()?this.highlights[this.highlights.length-1]:null}triggerMouseEnter(e,t){this.isBeingDragged||this.trigger(Pi.MOUSE_ENTER+e.selectionId,e,t)}triggerMouseMove(e,t){this.isBeingDragged||this.trigger(Pi.MOUSE_MOVE+e.selectionId,e,t)}triggerMouseLeave(e,t){this.isBeingDragged||this.trigger(Pi.MOUSE_LEAVE+e.selectionId,e,t)}triggerClick(e,t){const i={requestSelectedStatus:!1};return this.trigger(Pi.CLICK+e.selectionId,e,t,i),i.requestSelectedStatus}triggerDoubleClick(e,t){const i={requestSelectedStatus:!1};return this.trigger(Pi.DOUBLE_CLICK+e.selectionId,e,t,i),i.requestSelectedStatus}triggerSelect(e){this.trigger(Pi.SELECT+e.selectionId,e)}triggerDeselect(e){this.trigger(Pi.DESELECT+e.selectionId,e)}triggerDragStart(e,t){const i={requestDrag:!1};return this.trigger(Pi.DRAG_START+e.selectionId,e,t,i),this.isBeingDragged=i.requestDrag,i.requestDrag}triggerDrag(e,t){this.trigger(Pi.DRAG+e.selectionId,e,t)}triggerDragStop(e,t){this.trigger(Pi.DRAG_STOP+e.selectionId,e,t),this.isBeingDragged=!1}triggerXrDragStart(e,t){const i={requestDrag:!1};return this.trigger(Pi.XR_DRAG_START+e.selectionId,e,t,i),this.isBeingDragged=i.requestDrag,i.requestDrag}triggerXrDrag(e,t){this.trigger(Pi.XR_DRAG+e.selectionId,e,t)}triggerXrDragStop(e,t){this.trigger(Pi.XR_DRAG_STOP+e.selectionId,e,t),this.isBeingDragged=!1}triggerLongPressStart(e,t){this.trigger(Pi.LONG_PRESS_START+e.selectionId,e,t)}triggerLongPressEnd(e,t){this.trigger(Pi.LONG_PRESS_END+e.selectionId,e,t)}addHighlightToIncrement(e,t){const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);i&&this.occurrenceData.updateEntityHighlight(yn.aU.ADD,t,i,this.getUsage())}removeHighlightFromIncrement(e,t){const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);i&&this.occurrenceData.updateEntityHighlight(yn.aU.REMOVE,t,i,this.getUsage())}addNewHighlightToIncrement(e,t){const i=e+"."+this.graphicsOccurrenceId,s=this.viewer.getHighlightManager(this.getUsage()).createHighlightForSelection(t,i);return this.addHighlightToIncrement(e,s),this.allocatedHighlights.push({selectionId:i,highlightType:t}),s}addNewHighlightToOccurrence(e){const t=""+this.graphicsOccurrenceId,i=this.viewer.getHighlightManager(this.getUsage()).createHighlightForSelection(e,t);this.occurrenceData.updateOccurrenceHighlight(yn.aU.ADD,i,this.getUsage()),this.allocatedHighlights.push({selectionId:t,highlightType:e})}preventsSketching(){return!0}getFitBounds(){return null}onViewWillDraw(e,t){}isViewManipulator(){return!1}onDefaultUnitsChanged(e){}onIsolateChanged(){}isDimension(){return!1}isManipulator(){return!1}onHighlightColorUpdated(){}}function wi(e){if(e.primitiveType===_i.MX.TRIANGLES||e.primitiveType===_i.MX.TRIANGLE_STRIP){if(e.colors||Uu(vi.getColor("DEFAULT_TRIANGLE_COLOR"),e),!e.textureCoordinates){Bu([0,0],e)}e.normals||xu([0,0,1],e)}else e.primitiveType===_i.MX.LINES?(e.colors||Uu(vi.getColor("DEFAULT_MATERIAL_COLOR"),e),e.primitiveSizes||Hu(vi.getNumber("DEFAULT_LINE_WIDTH"),e),e.primitiveStyles||ku(vi.getStipple("DEFAULT_LINE_STIPPLE"),e)):e.primitiveType===_i.MX.POINTS&&(e.colors||Uu(vi.getColor("DEFAULT_MATERIAL_COLOR"),e),e.primitiveSizes||Hu(vi.getNumber("DEFAULT_POINT_SIZE"),e),e.primitiveStyles||ku(vi.getPointFont("DEFAULT_POINT_FONT"),e))}var _i=i(78077);class Ni{constructor(){this.id=0,this.shiftCount=0}getId(){return this.id}getShiftCount(){return this.shiftCount}reset(){this.id=0,this.shiftCount=0}addNumber(e,t){this.id|=e<<this.shiftCount,this.shiftCount+=t,this.shiftCount>31&&It.log.warn("BitShiftId exceeded 31 shifts; loss of uniqueness is possible")}addBoolean(e){this.addNumber(e?1:0,1)}getIdWithIdAppended(e){e>=Math.pow(2,Li.tl-this.shiftCount)&&It.log.warn("Lost uniqueness in creating id with getIdWithIdAppended");const t=e*Math.pow(2,this.shiftCount);return this.id+t}}var bi=i(37754),Li=i(55029);const Fi=$.create(),xi=$.create(),Bi=[];for(let e=0;e<4;++e)Bi.push($.create());const Ui=new Li.tO;class Vi{constructor(){this.occupiedBounds=[]}clearOccupiedRegions(){this.occupiedBounds=[]}addOccupiedRegion(e){this.occupiedBounds.push(e)}getUnoccupiedOffsetAlongDirection(e,t){const i=Ui;i.copyFrom(e);let s=0;for(;;){let e=-1/0,n=!1;const r=i.center(Fi);for(let s=0;s<this.occupiedBounds.length;++s)if(this.occupiedBounds[s].overlapsWith(i)){n=!0;let i=-1/0;const a=this.occupiedBounds[s].getCorners(Bi);for(let e=0;e<a.length;++e){const s=$.dot(t,pe.gv.subtract(a[e],r,xi));s>i&&(i=s)}i>e&&(e=i)}if(!n)break;{let n=1/0;const a=i.getCorners(Bi);for(let e=0;e<a.length;++e){const i=$.dot(t,pe.gv.subtract(a[e],r,xi));i<n&&(n=i)}const o=e-n;if(!(o>bi.W.ZERO_LENGTH))break;i.translate(pe.gv.scale(t,o,xi)),s+=o}}return s}}var Gi=i(24934);const Hi=new Di.s;class ki{constructor(e){this.ambientTextureFactor=0,this.ambientTexture=null,this.shaderId=null,this.customFloatUniformSettings=null,this.customIntUniformSettings=null,this.customMatrixUniforms=null,this.customVectorUniforms=null;const t=q.default.getManager();this.color=t.getColor("DEFAULT_MATERIAL_COLOR"),this.specularColor=t.getColor("DEFAULT_SPECULAR"),this.diffuseFactor=t.getNumber("COLOR_DIFFUSE_FACTOR"),this.ambientFactor=t.getNumber("COLOR_AMBIENT_FACTOR"),this.shininess=t.getNumber("DEFAULT_SHININESS"),this.translucentPassAlpha=t.getNumber("TRANSLUCENT_PASS_ALPHA"),this.pointSize=t.getNumber("DEFAULT_POINT_SIZE"),this.pointFont=t.getPointFont("DEFAULT_POINT_FONT"),this.lineWidth=t.getNumber("DEFAULT_LINE_WIDTH"),this.lineStipple=t.getStipple("DEFAULT_LINE_STIPPLE"),e&&((0,Q.overwriteMatchingProperties)(this,e),e.hasOwnProperty("ambientTexture")&&!e.hasOwnProperty("ambientTextureFactor")&&(this.ambientTextureFactor=1)),this.id=Hi.getId(),this.specularColor=this.specularColor.slice(0,3),this.highlightSpecularContribution=t.getNumber("HIGHLIGHT_SPECULAR_CONTRIBUTION")}destroy(){Hi.isIdValid(this.id)&&(Hi.freeId(this.id),this.id=Di.c2)}setTexture(e){this.ambientTexture!==e&&(this.ambientTexture=e,this.ambientTextureFactor=1)}getTexture(){return this.ambientTexture}makeSceneDebugObject(){return(0,Js.bN)(this,"Material "+this.id)}setCustomFloatUniform(e,t){this.customFloatUniformSettings||(this.customFloatUniformSettings=new Gi.N),this.customFloatUniformSettings.set(e,t)}setCustomIntUniform(e,t){this.customIntUniformSettings||(this.customIntUniformSettings=new Gi.N),this.customIntUniformSettings.set(e,t)}setCustomMatrixUniform(e,t){this.customMatrixUniforms||(this.customMatrixUniforms=new Gi.N),this.customMatrixUniforms.set(e,t)}setCustomVectorUniform(e,t){this.customVectorUniforms||(this.customVectorUniforms=new Gi.N),this.customVectorUniforms.set(e,t)}setAttributes(e,t){if(e){if(t.setLastBufferBound(null),e.vertexAttrib4fv($d.COLOR,this.color),e.uniform3fv("uSpecular",this.specularColor),e.uniform1f("uShininess",this.shininess),e.uniform1f("uColorDiffuseFactor",this.diffuseFactor),e.uniform1f("uColorAmbientFactor",this.ambientFactor),this.ambientTexture?(this.ambientTexture.viewer=t.viewer,e.useTexture("uAmbientTexture",this.ambientTexture)):e.useBlankTexture("uAmbientTexture"),e.uniform1f("uAmbientTextureFactor",this.ambientTextureFactor),e.uniform1f("uTranslucentPassAlpha",this.translucentPassAlpha),e.uniform1f("uHighlightSpecularContribution",this.highlightSpecularContribution),this.customFloatUniformSettings){const t=this.customFloatUniformSettings.getKeyValues();for(let i=0;i<t.length;i+=2)e.setFloatUniform(t[i],t[i+1])}if(this.customIntUniformSettings){const t=this.customIntUniformSettings.getKeyValues();for(let i=0;i<t.length;i+=2)e.setIntUniform(t[i],t[i+1])}if(this.customMatrixUniforms){const t=this.customMatrixUniforms.getKeyValues();for(let i=0;i<t.length;i+=2)e.setMatrixUniform(t[i],t[i+1])}if(this.customVectorUniforms){const t=this.customVectorUniforms.getKeyValues();for(let i=0;i<t.length;i+=2)e.setVectorUniform(t[i],t[i+1])}}}hasTransparency(){return this.color[3]<1||!!this.ambientTexture&&this.ambientTexture.getHasTransparency()}getExtendedShaderId(){return this.shaderId}}const Wi=new ki({ambientFactor:1,diffuseFactor:0,specularColor:[0,0,0]}),zi=new ki;function Xi(e){return new ki({ambientTexture:e,diffuseFactor:0,ambientFactor:1,specularColor:[0,0,0]})}class qi{constructor(e,t,i){this.setStyle(t),this.setBufferSet(i),this.parent=e}getStyle(){return this.style}setStyle(e){this.style=e}getBufferSet(){return this.bufferSet}setBufferSet(e){this.bufferSet=e}damageBounds(){this.parent.damageBounds()}getBounds(e,t){return this.bufferSet.getBounds(e,t)}draw(e){this.bufferSet&&(null!=this.style&&e.applyStyle(this.style),this.bufferSet.draw(e))}makeSceneDebugObject(e){const t=[];return t.push(this.bufferSet.makeSceneDebugObject(e+1)),{text:"StyledSimpleBufferSet",children:t,state:{opened:e<2}}}}const Zi=q.default.getManager();var Yi;!function(e){e[e.LOWER=0]="LOWER",e[e.DEFAULT=1]="DEFAULT",e[e.HIGHER=2]="HIGHER",e[e.HIGHEST=3]="HIGHEST",e[e.COUNT=4]="COUNT"}(Yi||(Yi={}));const Ki=Math.ceil(Math.log(Yi.COUNT)/Math.log(2)),ji=new Ni;class Qi{constructor(e){this.isVisible=!0,this.isPickable=!0,this.isHighlightable=!0,this.isTwoSided=!1,this.isTintedByCompare=!1,this.isShowThrough=!1,this.isDepthTested=!0,this.isStencilTested=!1,this.isStencilWritten=!0,this.clippedBySectionPlanes=!1,this.addsToSectionMask=!0,this.primitivesHaveTransparency=!1,this.zOffset=0,this.pickZOffset=0,this.addsToBounds=!0,this.includedInBlend=!1,this.priority=Yi.DEFAULT,this.primitiveType=_i.MX.PRIMITIVE_UNKNOWN,this.material=zi,this.initializeFromProperties(e),this.updateId()}initializeFromProperties(e){e&&(0,Q.overwriteMatchingProperties)(this,e),(null==e?void 0:e.hasOwnProperty("pickZOffset"))||(this.pickZOffset=this.zOffset)}clone(){return new Qi(this)}cloneAndModify(e){const t=new Qi(this);return t.initializeFromProperties(e),t.updateId(),t}toString(e){return e?(this.primitiveType!==_i.MX.PRIMITIVE_UNKNOWN?"primitiveType:"+(0,_i.E1)(this.primitiveType):"")+(this.material?",m:"+this.material.id:""):"NodeProperties: primitiveType:"+(0,_i.E1)(this.primitiveType)+",m:"+(this.material?this.material.id:"null")+",iV:"+this.isVisible+",iP:"+this.isPickable+",iH:"+this.isHighlightable+",iTS:"+this.isTwoSided+",iTBC:"+this.isTintedByCompare+",iShTh:"+this.isShowThrough+",iDT:"+this.isDepthTested+",iStTe:"+this.isStencilTested+",iStWr:"+this.isStencilWritten+",cBSP:"+this.clippedBySectionPlanes+",aTSM:"+this.addsToSectionMask+",pHT:"+this.primitivesHaveTransparency+",p:"+this.priority+",zO:"+this.zOffset+",pZO:"+this.pickZOffset+",aTB:"+this.addsToBounds+",iIB:"+this.includedInBlend}makeSceneDebugObject(){const e=[];return e.push((0,Js.z4)("primitiveType",(0,_i.E1)(this.primitiveType))),e.push(this.material?this.material.makeSceneDebugObject():(0,Js.z4)("material",null)),(0,Js.Ir)(e,this,{id:!0,primitiveType:!0,material:!0}),{text:"[Node properties] "+this.id+" "+this.toString(!0),children:e}}updateId(){ji.reset(),ji.addBoolean(this.isVisible),ji.addBoolean(this.isPickable),ji.addBoolean(this.isHighlightable),ji.addBoolean(this.isTwoSided),ji.addBoolean(this.isShowThrough),ji.addBoolean(this.isDepthTested),ji.addBoolean(this.isStencilTested),ji.addBoolean(this.isStencilWritten),ji.addBoolean(this.clippedBySectionPlanes),ji.addBoolean(this.addsToSectionMask),ji.addBoolean(this.primitivesHaveTransparency),ji.addBoolean(this.includedInBlend),ji.addNumber(this.priority,Ki),ji.addNumber(this.primitiveType,_i.ip),ji.addNumber(this.zOffset+31,6),ji.addNumber(this.pickZOffset+31,6),Math.abs(this.zOffset)>31&&It.log.warn("zOffset "+this.zOffset+" could result in a duplicate node id, resulting in bad z offset state"),Math.abs(this.pickZOffset)>31&&It.log.warn("pickZOffset "+this.pickZOffset+" could result in a duplicate node id, resulting in bad pick z offset state"),ji.addBoolean(this.addsToBounds);let e=ji.getId();this.material&&(e=ji.getIdWithIdAppended(this.material.id)),this.id=e}}let $i=[];function Ji(e){$i.push(e)}function es(){for(let e=0;e<$i.length;++e){const t=$i[e];t&&!t.getParent()&&t.onPermanentlyRemoved()}$i=[]}class ts{constructor(e,t,i){this.id=e,this.pose=null,this.children=null,this.childMap={},this.parent=null,this.areBoundsDamaged=!1,this.nodeOccurrences=null,this.usage=void 0!==i?i:Ls.L.BASE,this.properties=new Qi(t),this.boundingBox=new Li.kB}integrityCheck(){this.nodeOccurrences&&this.children&&this.children.length>0&&It.log.error("Found non-leaf scenegraph node with a node occurrences. Node id: "+this.id)}getId(){return this.id}setPose(e){e&&this.pose&&ge.equals(e,this.pose)||(this.pose=e,this.damageBounds())}getPose(){return this.pose}damageBounds(){this.areBoundsDamaged||(this.areBoundsDamaged=!0,this.parent&&this.parent.damageBounds())}getUsage(){return this.usage}updateBounds(e){const t=!!e&&!!e.includeHiddenBounds;if(this.areBoundsDamaged||t)if(this.boundingBox.reset(),this.nodeOccurrences){if(this.getAddsToBounds()||t){const t=this.nodeOccurrences.getKeyValues();for(let i=0;i<t.length;i+=2)t[i+1].addBounds(this.boundingBox,e)}this.areBoundsDamaged=!1}else if(this.children){this.areBoundsDamaged=!1;for(let t=0;t<this.children.length;++t){const i=this.children[t].getBoundingBox(e);this.children[t].getIsVisible()&&this.children[t].getAddsToBounds()&&(0,Li.rQ)(i)&&(this.boundingBox.addBox(i,this.pose),this.areBoundsDamaged=this.areBoundsDamaged||this.children[t].areBoundsDamaged)}}}getBoundingBox(e){return(this.areBoundsDamaged||e&&e.includeHiddenBounds)&&this.updateBounds(e),this.boundingBox}getOccurrenceBounds(e,t){if(this.getAddsToBounds())if(this.nodeOccurrences){const i=this.nodeOccurrences.get(e);i&&i.addBounds(t)}else if(this.children)for(let i=0;i<this.children.length;++i)this.children[i].getOccurrenceBounds(e,t)}addChild(e,t){if(e){switch(this.children||(this.children=[]),void 0===t?this.children.push(e):(t=(0,Li.uZ)(Math.round(t),0,this.children.length),this.children.splice(t,0,e)),this.childMap[e.id]=e,e.parent=this,e.usage){case Ls.L.PREVIEW:this.usage!==Ls.L.PREVIEW&&It.log.warn("Adding PREVIEW node to non-PREVIEW node (usage "+this.usage+")");break;case Ls.L.BASE:e.usage=this.usage}this.damageBounds(),this.integrityCheck()}else It.log.warn("A scenegraph node cannot add a null child")}findOrCreateChildNodeByProperties(e){const t=e.id.toString();let i=this.getChildById(t);return i||(i=new ts(t.toString(),e,this.usage),this.addChild(i)),i}addOccurrenceGeometryToNode(e,t,i,s,n,r){const a=this.findOrCreateChildNodeByProperties(e),o=a.findOrCreateNodeOccurrenceByData(t).addStyledMeshRanges(i,s,n,r);return a.damageBounds(),o}addOccurrenceBufferSetToNode(e,t,i,s){const n=this.findOrCreateChildNodeByProperties(e),r=n.findOrCreateNodeOccurrenceByData(t),a=new qi(r,i,s);return r.addStyledBufferSet(a),n.damageBounds(),a}findOrCreateNodeOccurrenceByData(e){this.nodeOccurrences||(this.nodeOccurrences=new Gi.N);let t=this.nodeOccurrences.get(e.getOccurrenceId());return t||(t=new DS(this,e),this.nodeOccurrences.set(e.getOccurrenceId(),t)),t}removeOccurrenceFromNode(e,t){const i=e.id.toString(),s=this.getChildById(i);s&&s.removeOccurrence(t),this.cleanEmptyMeshNodes()}hasNonIsolatedOccurrences(){if(this.nodeOccurrences){const e=this.nodeOccurrences.getKeyValues();for(let t=1;t<e.length;t+=2){if(!e[t].occurrenceData.getIsolated())return!0}}return!1}removeOccurrence(e){if(e=+e,this.nodeOccurrences){const t=this.nodeOccurrences.get(e);t&&(t.destroy(),this.nodeOccurrences.delete(e),this.damageBounds())}else{for(let t=0;this.children&&t<this.children.length;++t)this.children[t].removeOccurrence(e);this.cleanEmptyMeshNodes()}}removeMeshGroupFromOccurrence(e,t){if(t=+t,this.isMeshNode()){const i=this.nodeOccurrences.get(t);if(i){i.removeAllChildrenForMeshGroup(e)&&(i.isEmpty&&(i.destroy(),this.nodeOccurrences.delete(t)),this.damageBounds())}}else{for(let i=0;this.children&&i<this.children.length;++i)this.children[i].removeMeshGroupFromOccurrence(e,t);this.cleanEmptyMeshNodes()}}removeChild(e,t){if(!this.children)return;const i=this.children.indexOf(e);i>-1&&(delete this.childMap[e.id],this.children.splice(i,1),e.onRemoved(t),this.damageBounds())}removeChildById(e){if(!this.children)return;const t=this.childMap[e];t&&this.removeChild(t)}removeAllChildren(){if(this.children){for(let e=0;e<this.children.length;++e)this.children[e].onRemoved();this.childMap={},this.children=[],this.damageBounds()}}remove(){this.parent?this.parent.removeChild(this):It.log.error("Trying to remove parentless child")}onRemoved(e){this.parent=null,e||Ji(this)}onPermanentlyRemoved(){if(this.children)for(let e=0;e<this.children.length;++e)this.children[e]&&this.children[e].onPermanentlyRemoved();else if(this.nodeOccurrences){const e=this.nodeOccurrences.getKeyValues();for(let t=0;t<e.length;t+=2)e[t+1].destroy();this.nodeOccurrences=null}}cleanEmptyMeshNodes(){if(this.children)for(let e=0;e<this.children.length;++e)this.children[e].isMeshNode()?this.children[e].isEmptyMeshNode()&&this.children[e].remove():this.children[e].cleanEmptyMeshNodes()}getParent(){return this.parent}getChildById(e){return this.children&&this.childMap[e]||null}getChildrenWithPrefix(e){if(!this.children)return null;let t=null;for(const i in this.childMap)0===i.indexOf(e)&&(t=t||[],t.push(this.childMap[i]));return t}getChildByIndex(e){return!this.children||e>=this.children.length||e<0?null:this.children[e]}getChildCount(){return this.children?this.children.length:0}isMeshNode(){return!!this.nodeOccurrences}isEmptyMeshNode(){return this.isMeshNode()&&0===this.nodeOccurrences.size}getPrimitiveType(){return this.properties?this.properties.primitiveType:_i.MX.PRIMITIVE_UNKNOWN}isFaces(){if(!this.isMeshNode())return!1;const e=this.getPrimitiveType();return e===_i.MX.TRIANGLES||e===_i.MX.TRIANGLE_STRIP}isEdges(){if(!this.isMeshNode())return!1;const e=this.getPrimitiveType();return e===_i.MX.LINES||e===_i.MX.INFINITE_LINES}isPoints(){if(!this.isMeshNode())return!1;return this.getPrimitiveType()===_i.MX.POINTS}isSilhouettes(){if(!this.isMeshNode())return!1;return this.getPrimitiveType()===_i.MX.SILHOUETTES}getProperties(){return this.properties}getMaterial(){return this.properties.material}getIsVisible(){return this.properties.isVisible}getIsPickable(){return this.properties.isPickable}getIsHighlightable(){return this.properties.isHighlightable}getIsTwoSided(){return this.properties.isTwoSided}getIsTintedByCompare(){return this.properties.isTintedByCompare}getIsShowThrough(){return this.properties.isShowThrough}getIsDepthTested(){return this.properties.isDepthTested}getIsStencilTested(){return this.properties.isStencilTested}getIsStencilWritten(){return this.properties.isStencilWritten}getClippedBySectionPlanes(){return this.properties.clippedBySectionPlanes}getAddsToSectionMask(){return this.properties.addsToSectionMask}hasTransparency(){return this.properties.primitivesHaveTransparency||!!this.properties.material&&this.properties.material.hasTransparency()}getRenderOrderPriority(){return this.properties.priority}getIncludedInBlend(){return this.properties.includedInBlend}getAddsToBounds(){return this.properties.addsToBounds}getZOffset(){return this.properties.zOffset}getPickZOffset(){return this.properties.pickZOffset}draw(e){if((!e.isHighlighting()||this.getIsHighlightable())&&(e.isHighlighting()||e.isPicking()||this.getIsVisible())&&(this.children||e.nodeFilter(this))){if(this.pose&&e.pushModelViewMatrix(pe.w$.multiply(e.getModelViewMatrix(),this.pose,ge.create())),this.isMeshNode()){this.properties.material&&e.pushMaterial(this.properties.material),e.activateTopShader();const t=e.getActiveShader();if(!t)return this.properties.material&&e.popMaterial(),void(this.pose&&e.popModelViewMatrix());e.setMaterial(),e.updateModelviewUniforms(),e.setUsage(this.usage);const i=this.nodeOccurrences?this.nodeOccurrences.getKeyValues():null;if(i&&e.isHighlighting()){this.isEdges()?(e.getUseHiddenOpacityForEdgeHighlights()?(t.uniform1f("uHighlightOpacity",Zi.getNumber("HIGHLIGHT_HIDDEN_EDGE_OPACITY")),t.uniform1f("uHighlightBorderOpacity",Zi.getNumber("HIGHLIGHT_HIDDEN_EDGE_BORDER_OPACITY"))):(t.uniform1f("uHighlightOpacity",Zi.getNumber("HIGHLIGHT_EDGE_OPACITY")),t.uniform1f("uHighlightBorderOpacity",Zi.getNumber("HIGHLIGHT_EDGE_BORDER_OPACITY"))),e.setLineWidth(this.properties.material.lineWidth),e.setLineStipple(this.properties.material.lineStipple)):this.isPoints()&&(t.uniform1f("uHighlightOpacity",Zi.getNumber("HIGHLIGHT_POINT_OPACITY")),e.setPointSize(this.properties.material.pointSize)),e.setFacesToCull(Rh.NONE);for(let t=0;t<i.length;t+=2)i[t+1].draw(e);e.setFacesToCull(Rh.BACK)}if((this.getIsVisible()||e.isPicking())&&!e.isHighlighting()&&(this.getIsTwoSided()||e.isPickingBackFaces()?e.setFacesToCull(Rh.NONE):e.setFacesToCull(Rh.BACK),this.isPoints()?(e.setPointSize(this.properties.material.pointSize),e.setPointFont(this.properties.material.pointFont)):(this.isEdges()||this.isSilhouettes())&&(e.setLineWidth(this.properties.material.lineWidth),e.setLineStipple(this.properties.material.lineStipple)),t.uniform1i("uClippedBySectionPlanes",this.getClippedBySectionPlanes()?1:0),t.uniform1f("uAddsToSectionMask",this.getAddsToSectionMask()?1:0),i))for(let t=0;t<i.length;t+=2)i[t+1].draw(e);this.properties.material&&e.popMaterial()}else if(this.children)for(let t=0;t<this.children.length;++t)this.children[t].draw(e);this.pose&&e.popModelViewMatrix()}}passesNodeFilter(e){if(e(this))return!0;if(this.children)for(let t=0;t<this.children.length;++t)if(this.children[t].passesNodeFilter(e))return!0;return!1}walk(e){if(e(this))return!0;let t=!1;for(let i=0;i<this.getChildCount()&&!t;++i)t=this.getChildByIndex(i).walk(e);return t}getIdPath(){let e="",t=this;for(;t;)e.length>0&&(e="."+e),e=t.id+e,t=t.parent;return e}makeSceneDebugObject(e){let t="Node: "+this.getId();this.properties.primitiveType!==_i.MX.PRIMITIVE_UNKNOWN&&(t+=" ",t+=this.properties.toString(!0));const i=[];i.push(this.properties.makeSceneDebugObject());const s=this.getBoundingBox();if(s&&i.push(s.makeSceneDebugObject()),this.isMeshNode()){const t=this.nodeOccurrences.getKeyValues();for(let s=0;s<t.length;s+=2)i.push(t[s+1].makeSceneDebugObject(e+1))}else for(let t=0;t<this.getChildCount();t++)i.push(this.getChildByIndex(t).makeSceneDebugObject(e+1));return{text:t,children:i,state:{opened:e<2}}}setVisible(e){if(this.getIsVisible()!==e){const t=this.properties.cloneAndModify({isVisible:e});this.properties=t}}}const is=q.default.getManager(),ss=new Qi({isShowThrough:!0,isPickable:!1,primitiveType:_i.MX.LINES}),ns=v.fromValues(1,0,0),rs=v.fromValues(0,1,0),as=v.fromValues(0,0,1),os=new Qi({isPickable:!1,primitiveType:_i.MX.TRIANGLES,material:null}),hs=(0,Li.Yr)(is.getNumber("VIEW_CUBE_AXIS_LABEL_FADE_START_ANGLE")),cs=(0,Li.Yr)(is.getNumber("VIEW_CUBE_AXIS_LABEL_FADE_END_ANGLE")),ls="axes3D",us="axis_label";class ds extends Ri{constructor(e,t,i,s,n){super(n,sh.EG),this.label=e,this.direction=t,this.color=i,this.axisLength=s,this.transformedDirection=null,this.labelTexture=null,this.position=null,this.lastSetOpacity=-1,this.nodeProperties=new Qi(os),this.nodeProperties.material=Xi(),this.nodeProperties.updateId(),this.ensureTexture(),this.show()}onDevicePixelRatioChanged(e){this.labelTexture=null,this.ensureTexture(),this.updateIncrements()}remove(){this.labelTexture&&(this.labelTexture.destroy(),this.labelTexture=null),this.nodeProperties.material&&(this.nodeProperties.material.destroy(),this.nodeProperties.material=null),super.remove()}updateIncrements(){const e=is.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX"),t=this.labelTexture.filledWidthPx,i=Ou([-t/2,-e/2,0],[t/2,-e/2,0],[-t/2,e/2,0],void 0,[this.labelTexture.leftCoordinate,this.labelTexture.bottomCoordinate],[this.labelTexture.rightCoordinate,this.labelTexture.topCoordinate]);this.updateMeshIncrement(us,yi,i,this.nodeProperties)}ensureTexture(){this.viewer.getGlContext()&&(this.labelTexture||(this.labelTexture=Go(this.viewer,this.label,{color:this.color,font:is.getString("VIEW_CUBE_TEXT_FONT"),size:is.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX")}),this.nodeProperties.material.ambientTexture=this.labelTexture,this.updateIncrements()))}updateTransform(e){if(!this.position||!this.transformedDirection)return;const t=Math.acos(Math.abs(v.dot(e.getForward(),this.transformedDirection))),i=(0,Li.CW)(cs,hs,t);this.setOpacity(i),this.setTransform(pe.w$.translate(ge.create(),this.position))}setOpacity(e){if(e===this.lastSetOpacity)return;const t=new Uint8Array([255,255,255,255*e]);this.updateIncrementAttribute(us,Jd.COLOR,t),this.lastSetOpacity=e}}class gs extends Ri{constructor(e,t){super(e),this.coordinateSystemTransform=null,this.axisLabels={},this.setId(ls),this.highlightId=yi,t=t||{},this.axesName=t.hasOwnProperty("axesName")?t.axesName:null,this.hasXAxis=!t.hasOwnProperty("hasXAxis")||t.hasXAxis,this.hasYAxis=!t.hasOwnProperty("hasYAxis")||t.hasYAxis,this.hasZAxis=!t.hasOwnProperty("hasZAxis")||t.hasZAxis,this.XAxisColor=t.hasOwnProperty("XAxisColor")?t.XAxisColor:is.getColor("X_AXIS_COLOR"),this.YAxisColor=t.hasOwnProperty("YAxisColor")?t.YAxisColor:is.getColor("Y_AXIS_COLOR"),this.ZAxisColor=t.hasOwnProperty("ZAxisColor")?t.ZAxisColor:is.getColor("Z_AXIS_COLOR");const i=is.getNumber("AXIS_LINE_WIDTH_PX");this.XAxisWidth=t.hasOwnProperty("XAxisWidth")?t.XAxisWidth:i,this.YAxisWidth=t.hasOwnProperty("YAxisWidth")?t.YAxisWidth:i,this.ZAxisWidth=t.hasOwnProperty("ZAxisWidth")?t.ZAxisWidth:i;const s=is.getNumber("AXIS_LINE_LENGTH_PX");this.XAxisStartEndPixel=t.hasOwnProperty("XAxisStartEndPixel")?t.XAxisStartEndPixel:[0,s],this.YAxisStartEndPixel=t.hasOwnProperty("YAxisStartEndPixel")?t.YAxisStartEndPixel:[0,s],this.ZAxisStartEndPixel=t.hasOwnProperty("ZAxisStartEndPixel")?t.ZAxisStartEndPixel:[0,s],this.hasXAxis&&(this.axisLabels.X=new ds("X",ns,is.getColor("X_AXIS_COLOR"),this.XAxisStartEndPixel[1],this.viewer)),this.hasYAxis&&(this.axisLabels.Y=new ds("Y",rs,is.getColor("Y_AXIS_COLOR"),this.YAxisStartEndPixel[1],this.viewer)),this.hasZAxis&&(this.axisLabels.Z=new ds("Z",as,is.getColor("Z_AXIS_COLOR"),this.ZAxisStartEndPixel[1],this.viewer)),this.ensureTexture(),this.listenTo(this.viewer.getEventDispatcher(),VM.Hv,this.onViewWillDraw)}onViewWillDraw(e,t){if(this.updateGraphics(e),this.coordinateSystemTransform)for(const t in this.axisLabels){const i=this.axisLabels[t],s=i.axisLength+is.getNumber("AXIS_LABEL_OFFSET_PX"),n=pe.S4.scale(this.axisLabels[t].direction,s,v.create()),r=pe.w$.multiplyVec4(this.transform,P.fromValues(n[0],n[1],n[2],1),P.create()),a=e.projectWorldPointToViewport(r);i.position=a;const o=P.fromValues(i.direction[0],i.direction[1],i.direction[2],0);pe.w$.multiplyVec4(this.transform,o,P.create());i.transformedDirection||(i.transformedDirection=P.create()),v.copy(i.transformedDirection,i.direction),i.transformedDirection[3]=0,pe.w$.multiplyVec4(this.transform,i.transformedDirection),pe.S4.normalize(i.transformedDirection),i.updateTransform(e)}}addAxis(e,t,i,s,n){const r=pu(pe.S4.scale(t,n[0],v.create()),pe.S4.scale(t,n[1],v.create()));Hu(s,r),Uu(i,r),this.updateMeshIncrement(e,yi,r,ss)}updateGraphics(e){if(null===this.coordinateSystemTransform)return;!this.hasMeshIncrements()&&this.coordinateSystemTransform&&(this.hasXAxis&&this.addAxis("X_AXIS",ns,this.XAxisColor,this.XAxisWidth,this.XAxisStartEndPixel),this.hasYAxis&&this.addAxis("Y_AXIS",rs,this.YAxisColor,this.YAxisWidth,this.YAxisStartEndPixel),this.hasZAxis&&this.addAxis("Z_AXIS",as,this.ZAxisColor,this.ZAxisWidth,this.ZAxisStartEndPixel));const t=v.fromValues(this.coordinateSystemTransform[12],this.coordinateSystemTransform[13],this.coordinateSystemTransform[14]),i=e.getPixelSizeAtWorldPoint(t),s=v.fromValues(i,i,i),n=pe.w$.scale(this.coordinateSystemTransform,s,ge.create());this.setTransform(n)}updateDefinition(e){this.coordinateSystemTransform=e}hide(){this.hasXAxis&&this.axisLabels.X.hide(),this.hasYAxis&&this.axisLabels.Y.hide(),this.hasZAxis&&this.axisLabels.Z.hide(),super.hide()}show(){this.hasXAxis&&this.axisLabels.X.show(),this.hasYAxis&&this.axisLabels.Y.show(),this.hasZAxis&&this.axisLabels.Z.show(),super.show()}ensureTexture(){for(const e in this.axisLabels)this.axisLabels[e].ensureTexture()}remove(){for(const e in this.axisLabels)this.axisLabels[e].remove();super.remove()}}var ps=i(57692);const ms={ASSEMBLY:"Assembly",PART_STUDIO:"Part Studio",SKETCH:"Sketch",UNSUPPORTED:"Default"};class fs extends m.T{constructor(e){super(),this.commands={},this.spaceBallConnection=e}startListeningToEvents(){this.listenTo((0,VM.xA)(),VM.Fc,this.setActiveCommandSet),this.listenTo((0,VM.xA)(),VM.RV,this.executeCommand),this.listenTo((0,VM.xA)(),VM.TN,this.commandSetReceived)}stopListeningToEvents(){this.stopListening()}setActiveCommandSet(e){this.spaceBallConnection.update3dcontroller({commands:{activeSet:e}})}commandSetReceived(e){const t=new _3Dconnexion.ActionTree,i=new _3Dconnexion.ImageCache,s=this;for(let s=0;s<e.length;s++){const n=e[s],r=n.tabType,a=t.push(new _3Dconnexion.ActionSet(r,"")).push(new _3Dconnexion.Category("Action_Id_"+r,"Commands"));for(let e=0;e<n.commands.length;e++){const t=n.commands[e];let s=t.command,o=t.icon?"/images/"+t.icon+".svg":"";(this.commands[s]||n.tabId===W.GNh.PARTSTUDIO&&"mateConnector"===t.command)&&(s=r+"-"+t.command),(t.command.indexOf("mate")>-1||t.command.indexOf("Mate")>-1)&&"mateConnector"!==t.command&&(t.icon&&(o="/images/mate/"+t.icon+".svg"),s=t.command+"_"+t.commandDetails),"load"===t.command&&(s=t.command+"_"+t.commandDetails),a.push(new _3Dconnexion.Action(s,i18n(t.name),"")),this.commands[s]=t,o&&i.push(_3Dconnexion.ImageItem.fromURL(o,s))}}t.push(new _3Dconnexion.ActionSet(ms.UNSUPPORTED,"")),i.onload=function(){s.spaceBallConnection.update3dcontroller({images:i.images})};let n=ms.UNSUPPORTED;(0,ft._R)()?n=ms.ASSEMBLY:(0,ft._B)()&&(n=ms.PART_STUDIO),this.spaceBallConnection.update3dcontroller({commands:{activeSet:n,tree:t}})}executeCommand(e){this.commands[e]&&ps.Jq.SpaceballService.executeCommand(this.commands[e])}}var Is=i(33074),Es=i(10867),Ss=i(32659);class Ts extends m.T{constructor(e,t){super(),this.viewer=e,this.mouseMoveTextCallback=t,this.APPENDAGE_ID="cursor-appendage-user",this.addListeners()}addListeners(){const e=this.viewer.getEventDispatcher();this.listenTo(e,VM.oG,this.onMouseMove),this.listenTo(e,VM.u5,this.onMouseLeave)}destroy(){this.removeContainer(),this.stopListening()}onMouseMove(e){const t=this.viewer.getCanvasCoordinateFromEvent(e);this.updatePosition([...t])}updatePosition(e){const t=this.mouseMoveTextCallback(e[0],e[1]);if(t){const i=(0,Es.x_)(),s=[e[0]/i,e[1]/i],n=this.getContainer();n.text(t),n.css({left:s[0]+25+"px",top:s[1]+"px"})}else this.removeContainer()}onMouseLeave(e){this.removeContainer()}getContainer(){let e=Ss("#"+this.APPENDAGE_ID);return 0===e.length&&(e=Ss("<div></div>").appendTo((0,Is.Ug)()),e.attr("class",Ts.CONTAINER_CLASS),e.attr("id",this.APPENDAGE_ID)),e}removeContainer(){Ss("#"+this.APPENDAGE_ID).remove()}}Ts.CONTAINER_CLASS="cursor-appendage";var Ms=i(28784);class Cs extends Ts{constructor(){super(...arguments),this.APPENDAGE_ID="cursor-appendage-leader"}addListeners(){const e=this.viewer.getEventDispatcher();this.listenTo(e,Ms.Awy,this.updatePosition),this.listenTo(e,Ms.NfU,this.onMouseLeave),this.listenTo(e,Ms.Gfg,this.removeContainer)}updatePosition(e){const t=(0,Es.x_)(),i=e.map((e=>e*t));super.updatePosition(i)}}var Ds=i(34881);class vs{constructor(e,t,i){this.viewer=i,this.dragItems=null,this.dragSequenceId=1,this.showDimensionExpressions_=!1,this.id=e,this.planeMatrix=ge.create(),this.planeMatrixrixInverse=ge.create(),this.appliedTransform=ge.create(),this.computedPlaneMatrix=ge.create(),this.computedInverse=ge.create(),t?(this.planeMatrix[0]=t.m00,this.planeMatrix[1]=t.m10,this.planeMatrix[2]=t.m20,this.planeMatrix[3]=0,this.planeMatrix[4]=t.m01,this.planeMatrix[5]=t.m11,this.planeMatrix[6]=t.m21,this.planeMatrix[7]=0,this.planeMatrix[8]=t.m02,this.planeMatrix[9]=t.m12,this.planeMatrix[10]=t.m22,this.planeMatrix[11]=0,this.planeMatrix[12]=t.m03,this.planeMatrix[13]=t.m13,this.planeMatrix[14]=t.m23,this.planeMatrix[15]=1):It.log.info("invalid plane definition"),this.planeMatrixrixInverse=pe.w$.set(this.planeMatrix,this.planeMatrixrixInverse),pe.w$.inverse(this.planeMatrixrixInverse),this.startPt=v.create(),this.endPt=v.create(),this.p0=P.create(),this.p1=P.create(),this.p2=P.create(),this.p3=P.create(),this.updateComputedTransforms()}set showDimensionExpressions(e){this.showDimensionExpressions_=e,this.viewer.getEventDispatcher().trigger(VM.yB,e)}get showDimensionExpressions(){return this.showDimensionExpressions_}updateComputedTransforms(){return pe.w$.multiply(this.appliedTransform,this.planeMatrix,this.computedPlaneMatrix),pe.w$.inverse(pe.w$.multiply(this.appliedTransform,this.planeMatrix,this.computedInverse))}getId(){return this.id}getAppliedTransform(){return this.appliedTransform}getPlaneMatrix(){return this.computedPlaneMatrix}getPlaneMatrixInverse(){return this.computedInverse}setAppliedTransform(e){this.appliedTransform=e,this.updateComputedTransforms()}startPointScreen(e){this.startPt=this.toWorld(e)}endPointScreen(e){this.endPt=this.toWorld(e)}resetState(){this.entityIds=null,this.dragItems=null}toPlane(e){const t=this.toWorld(e);if(!t)return null;let i=P.create();const s=P.create();return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=1,i=pe.w$.multiplyVec4(this.getPlaneMatrixInverse(),s,i),[i[0],i[1],0]}toWorld(e){const t=(0,Q.as)(hr,this.viewer.getPrimaryViewController()).camera.getRay(e[0],e[1]);return(0,Li.bZ)(t,this.getPlaneMatrix())}getCanvasCoordinates(e){const t=this.viewer.getCamera(),i=this.planeToWorld(e),s=t.projectWorldPointToCanvas(i);return pe.S4.scale(s,1/(0,Es.x_)())}planeVec4ToWorld(e){let t=P.create();return t=pe.w$.multiplyVec4(this.getPlaneMatrix(),e,t),v.fromValues(t[0],t[1],t[2])}planeToWorld(e){return this.planeVec4ToWorld(P.fromValues(e[0],e[1],0,1))}planeVectorToWorld(e){return this.planeVec4ToWorld(P.fromValues(e[0],e[1],e[2],0))}worldToPlane(e){let t=P.create();const i=P.create();return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=1,t=pe.w$.multiplyVec4(this.getPlaneMatrixInverse(),i,t),[t[0],t[1],t[2]]}getSketchNormal(){const e=[],t=this.getPlaneMatrix();return e[2]=t[10],e[1]=t[9],e[0]=t[8],e}createIncludeNonParallelPlaneFilter(){const e=this.getSketchNormal();return(0,Ds.iQ)(e)}}var Ps=i(32659);function ys(){!function(e){let t=null;e(document).on("mouseup",(function(e){t=null})),e.widget("bti.mouse",{version:"1.9.2",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){const t=this;this.element.on("mousedown."+this.widgetName,(function(e){return t._mouseDown(e)})).on("click."+this.widgetName,(function(i){if(!0===e.data(i.target,t.widgetName+".preventClickEvent"))return e.removeData(i.target,t.widgetName+".preventClickEvent"),i.stopImmediatePropagation(),!1})),this.started=!1,this.buttonState={leftButton:!1,middleButton:!1,rightButton:!1}},_mouseDestroy:function(){if(this.element.off("."+this.widgetName),this._mouseMoveDelegate){e(document).off("mousemove."+this.widgetName,this._mouseMoveDelegate);for(let t=1;t<=3;++t)e(document).off("mouseup."+this.widgetName+t,this._mouseUpDelegate)}},_mouseDown:function(i){if(t&&t!==this)return;this._mouseDownEvent=i;const s=this;return!!("string"==typeof this.options.cancel&&i.target.nodeName&&e(i.target).closest(this.options.cancel).length||!this._mouseCapture(i))||(1===i.which?this.buttonState.leftButton=!0:2===i.which?this.buttonState.middleButton=!0:3===i.which&&(this.buttonState.rightButton=!0),this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout((function(){s.mouseDelayMet=!0}),this.options.delay)),this._mouseDistanceMet(i)&&this._mouseDelayMet(i)&&(this._mouseStarted=!1!==this._mouseStart(i),!this._mouseStarted)?(i.preventDefault(),!0):(!0===e.data(i.target,this.widgetName+".preventClickEvent")&&e.removeData(i.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate||(this._mouseMoveDelegate=function(e){return s._mouseMove(e)},e(document).on("mousemove."+this.widgetName,this._mouseMoveDelegate)),this._mouseUpDelegate=function(e){return s._mouseUp(e)},e(document).on("mouseup."+this.widgetName+i.which,this._mouseUpDelegate),i.preventDefault(),t=this,!0))},_mouseMove:function(t){return e.ui.ie&&document.documentMode<9&&!t.button?this._mouseUp(t):this._mouseStarted?(this._mouseDrag(t),t.preventDefault()):(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)&&(this._mouseStarted=!1!==this._mouseStart(this._mouseDownEvent,t),this._mouseStarted?this._mouseDrag(t):this._mouseUp(t)),!this._mouseStarted)},_mouseUp:function(i){e(document).off("mouseup."+this.widgetName+i.which,this._mouseUpDelegate),1===i.which?this.buttonState.leftButton=!1:2===i.which?this.buttonState.middleButton=!1:3===i.which&&(this.buttonState.rightButton=!1);const s=!this.buttonState.leftButton&&!this.buttonState.middleButton&&!this.buttonState.rightButton;return s&&(t=null,e(document).off("mousemove."+this.widgetName,this._mouseMoveDelegate),this._mouseMoveDelegate=null),this._mouseStarted&&s?(i.target===this._mouseDownEvent.target&&e.data(i.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(i),this._mouseStarted=!1):this._mouseStarted&&this._mouseDrag(i),!1},_mouseDistanceMet:function(e){return Math.max(Math.abs(this._mouseDownEvent.pageX-e.pageX),Math.abs(this._mouseDownEvent.pageY-e.pageY))>=this.options.distance},_mouseDelayMet:function(e){return this.mouseDelayMet},_mouseStart:function(e){},_mouseDrag:function(e){},_mouseStop:function(e){},_mouseCapture:function(e){return!0}}),e.widget("bti.dragHelper",e.bti.mouse,{widgetEventPrefix:"dragHelper",options:{onStart:function(e){},onDrag:function(e){},onStop:function(e){}},_create:function(){this._mouseInit(),this._dragging=!1},destroy:function(){return this.element.off(".dragHelper"),this._mouseDestroy(),this},dragging:function(){return this._dragging},cancelDragging:function(t){return this.buttonState.leftButton=!1,this.buttonState.middleButton=!1,this.buttonState.rightButton=!1,e.bti.mouse.prototype._mouseUp.call(this,t)},_mouseStart:function(e,t){this._dragging=!0,this.lastX=e.pageX,this.lastY=e.pageY,this.options.onStart.call(this,e,t)},_mouseDrag:function(e){this.options.onDrag.call(this,e,e.pageX-this.lastX,e.pageY-this.lastY),this.lastX=e.pageX,this.lastY=e.pageY},_mouseStop:function(e){this._dragging=!1,this.options.onStop.call(this,e)}})}(Ps)}i(26646);var As=i(93961),Os=i(85968),Rs=i(16169),ws=i(32659);ys();class _s{constructor(e,t){this.editFeatureUnderCursor=e,this.viewer=t,this.sketch=null,this.lastMouseMovedEvent=null,this.lastMouseMoveTime=-1,this.showContextMenuOnMouseUp=!1,this.timeOfRightMouseButtonDown=0,this.mouseTravelSinceRightButtonDown=0,this.preHighlightTimeout=0,this.suppressMouseMovePick=!1,this.hoveredUiSelection=null,this.draggedUiSelection=null,this.longPressedUiSelection=null,this.skipNextClickSelection=!1,this.externalDragHandler=null,this.dragHandledExternally=!1,this.initialDragEvent=null,this.leftButtonDownOnDragStart=!1,this.startedLeftButtonDrag=!1,this.forcedManipulationActive=!1,this.dragTravel=0,this.dragStartTime=0,this.mouseInCanvas=!1,this.buttonState={leftButton:!1,middleButton:!1,rightButton:!1},this.middleMouseButtonDoubleClickHandler=null,this.altHeld=!1,(0,Ih.Yk)(t),this.boxSelector=new Sn(this.viewer),this.setupEventHandlers()}setupEventHandlers(){const e=this,t=this.getViewer().$el;t.dragHelper({lastX:0,lastY:0,onStart:function(t,i){e.buttonState=this.buttonState,e.onDragStart(t,i)},onDrag:function(t,i,s){e.buttonState=this.buttonState;const n=(0,Es.x_)();e.onDrag(t,i*n,s*n,this.lastX*n,this.lastY*n)},onStop:function(t){e.buttonState=this.buttonState,e.onDragStop(t)}});const i=function(t){return t.bind(e)};t.on("mouseenter",i(_s.prototype.onMouseEnter)),t.on("mouseleave",i(_s.prototype.onMouseLeave)),t.on("mousemove",i(_s.prototype.onMouseMove)),t.on("mousedown",i(_s.prototype.onMouseDown)),t.on("mouseup",i(_s.prototype.onMouseUp)),t.on("click",i(_s.prototype.onClick)),t.on("dblclick",i(_s.prototype.onDoubleClick)),t.on("mousewheel DOMMouseScroll",i(_s.prototype.onMouseWheelScroll)),Qo(t,i(_s.prototype.onLongPress)),this.middleMouseButtonDoubleClickHandler=new XI(t,i(_s.prototype.onMiddleMouseButtonDoubleClick)),ws(document).on("keyup",i(_s.prototype.onKeyUp)),ws(document).on("keydown",i(_s.prototype.onKeyDown))}remove(){this.boxSelector&&(this.boxSelector.remove(),this.boxSelector=null),this.middleMouseButtonDoubleClickHandler&&(this.middleMouseButtonDoubleClickHandler.off(),this.middleMouseButtonDoubleClickHandler=null)}setSketch(e){this.sketch=e}setExternalDragHandler(e){this.externalDragHandler=e}setSuppressMouseMovePick(e){this.suppressMouseMovePick=e,this.suppressMouseMovePick&&this.clearPreHighlightTimeout()}getLastMouseMovedEvent(){return this.lastMouseMovedEvent}isMouseRightButtonDown(){return this.buttonState.rightButton}isMouseMiddleButtonDown(){return this.buttonState.middleButton}isMouseLeftButtonDown(){return this.buttonState.leftButton}getViewer(){return this.viewer}onMouseEnter(e){this.viewer.getEventDispatcher().trigger(VM.ox,e),this.mouseInCanvas=!0,this.lastMouseMoveTime=-1,window.focus()}trackMouseMovement(e){let t=1/0;const i=(0,Js.Wj)(),s=i-this.lastMouseMoveTime,n=q.default.getManager(),r=n.getNumber("CONTEXT_MENU_DISTANCE_THRESHOLD"),a=this.viewer.getCanvasCoordinateFromEvent(e),o=this.viewer.getCanvasCoordinateFromEvent(this.lastMouseMovedEvent);if(this.lastMouseMoveTime>0&&this.lastMouseMovedEvent){const e=pe.gv.length([a[0]-o[0],a[1]-o[1]]);t=e/s,n.getNumber("OUTPUT_MOUSE_SPEED")&&It.log.debug("Mouse speed: "+t.toFixed(3)+", distance since last movement: "+e.toFixed(2)+", time since last movement: "+s.toFixed(1)),this.mouseTravelSinceRightButtonDown+=e}return this.lastMouseMoveTime=i,this.lastMouseMovedEvent=e,this.showContextMenuOnMouseUp&&this.mouseTravelSinceRightButtonDown>r&&(this.showContextMenuOnMouseUp=!1),t}isViewManipulationActive(e){const t=this.getViewer().getPrimaryViewController();if(null!==t){if(t.isBeingManipulated())return!0;if(t.getManipulationMode(e,this.buttonState)!==FD.k.NONE)return!0}return ph()}isNotManipulatingAndNotInZoom(e){return!this.suppressMouseMovePick&&!this.isViewManipulationActive(e)&&!this.draggedUiSelection}onMouseMove(e){if(this.viewer.getEventDispatcher().trigger(VM.oG,e),e.isPropagationStopped())return!1;if(!this.viewer.isReadyForDrawing())return!1;const t=q.default.getManager(),i=this.trackMouseMovement(e);this.clearPreHighlightTimeout();const s=this.getViewer();s.updateLastMouseLocation(e),this.isNotManipulatingAndNotInZoom(e)&&(i<t.getNumber("PREHIGHLIGHT_SPEED_THRESHOLD")?this.triggerPreHighlightPick(e):(0,ve.Wf)().length>0?this.triggerPreHighlightPick(e,!0):this.schedulePreHighlightPick(e));const n=As.k.getLeaderFollowModel();if(n.active){n.width=s.el.width,n.height=s.el.height;const t=s.isMouseInsideViewManipulator()?[-1,-1]:s.getCanvasCoordinateFromEvent(e);n.setCursorPosition(t)}return!0}onMouseLeave(e){this.viewer.getEventDispatcher().trigger(VM.u5,e),this.mouseInCanvas=!1,this.clearPreHighlightTimeout(),this.suppressMouseMovePick||(0,ve.Zs)(!0,!1)}eventCanBeUsedForContextMenu(e){return e.ctrlKey||e.which===Rs.t.RIGHT}onMouseDown(e){ph()&&(this.hoveredUiSelection=new wh.i(this.boxSelector,gn,""),this.viewer.getUISelectionManager().setHoveredSelection(this.hoveredUiSelection,e)),this.eventCanBeUsedForContextMenu(e)&&(this.lastMouseMovedEvent=e,this.showContextMenuOnMouseUp=!0,this.mouseTravelSinceRightButtonDown=0,this.timeOfRightMouseButtonDown=(0,Js.Wj)())}isMouseInCanvas(){return this.mouseInCanvas}onContextMenuWillHide(e,t){this.eventCanBeUsedForContextMenu(t)&&(this.lastMouseMovedEvent=null,this.showContextMenuOnMouseUp=!0,this.mouseTravelSinceRightButtonDown=0,this.timeOfRightMouseButtonDown=(0,Js.Wj)())}onMouseUp(e){this.trackMouseMovement(e);const t=(0,Js.Es)(this.timeOfRightMouseButtonDown)>q.default.getManager().getNumber("CONTEXT_MENU_TIME_THRESHOLD_MS");if(this.eventCanBeUsedForContextMenu(e)&&this.showContextMenuOnMouseUp&&!t){this.cancelDragging(e);const t={pickHandled:!1,contextMenuEnabled:!0,altKey:e.altKey};this.notifyGraphicsHandledClick(t),this.showContextMenu(e),ws("#context-menu-layer").on("contextmenu:willhide",this.onContextMenuWillHide.bind(this))}this.longPressedUiSelection&&e.which===Rs.t.LEFT&&(this.longPressedUiSelection.uiElement.triggerLongPressEnd(this.longPressedUiSelection,e),this.longPressedUiSelection=null,this.skipNextClickSelection=!0)}updatePicksForKeyEvent(e){if(this.isNotManipulatingAndNotInZoom(e)){const t=this.getViewer();if(!t||!t.getGlContext()||null===this.lastMouseMovedEvent)return;if(t!==(0,Ih.N9)())return;const i=t.getCanvasCoordinateFromEvent(this.lastMouseMovedEvent);t.doPick(i[0],i[1],!0,!0,{onlyRemovePreHighlight:!1,sourceEvent:e,altKey:e.altKey})}}onKeyDown(e){e.altKey&&!this.altHeld&&(this.altHeld=!0,this.updatePicksForKeyEvent(e))}onKeyUp(e){!e.altKey&&this.altHeld&&(this.altHeld=!1,this.updatePicksForKeyEvent(e)),e.which===Os.R8.ALT&&e.preventDefault()}onClick(e){if(this.viewer.getEventDispatcher().trigger(VM.pU,e),e.isPropagationStopped()||this.showContextMenuOnMouseUp&&this.eventCanBeUsedForContextMenu(e))return;let t={altKey:e.altKey};const i=e.which===Rs.t.LEFT;if(!this.isDragging()&&i&&!this.skipNextClickSelection){const i=this.getViewer(),s=i.getCanvasCoordinateFromEvent(e);t={click:!0,shiftKey:e.shiftKey,altKey:this.altHeld,sourceEvent:e},t.pickHandled=i.doPick(s[0],s[1],!1,!0,t)}this.skipNextClickSelection=!1,this.notifyGraphicsHandledClick(t)}onDoubleClick(e){if(this.viewer.getIsForPreviousVersionDisplay())return;let t;if(!this.isDragging()){if(e.which===Rs.t.LEFT){const i=this.viewer.getCanvasCoordinateFromEvent(e);t=this.viewer.onDoubleClick(i[0],i[1],e),!t&&this.viewer.getCanEdit()&&this.editFeatureUnderCursor(i[0],i[1])}}this.notifyGraphicsHandledClick({pickHandled:t,altKey:e.altKey})}onMiddleMouseButtonDoubleClick(e){this.isDragging()||this.viewer.animateZoomFit()}onMouseWheelScroll(e){if(this.viewer.performingBoxSelection())return!1;if(!this.viewer.isReadyForDrawing())return!1;return!!this.viewer.getPrimaryViewController().zoomOnMouseWheelScroll(e)&&(this.viewer.getEventDispatcher().trigger(VM.h0,e),this.viewer.setUserIsAdjustingCamera(),this.viewer.requestDraw(),!1)}cancelDragging(e){this.getViewer().$el.dragHelper("cancelDragging",e)}isDragging(){return this.getViewer().$el.dragHelper("dragging")}onDragStart(e,t){if(this.leftButtonDownOnDragStart=this.buttonState.leftButton,this.viewer.performingBoxSelection())return;if(!this.viewer.isReadyForDrawing())return;this.initialDragEvent=e,this.dragTravel=0,this.dragStartTime=(0,Js.Wj)();const i=this.viewer.getPrimaryViewController(),s=i.onDragStart(e,t,this.buttonState);this.leftButtonDownOnDragStart&&i.isBeingForceManipulated()&&(this.forcedManipulationActive=!0,this.leftButtonDownOnDragStart=!1),s&&this.viewer.getEventDispatcher().trigger(VM.h0,e),this.draggedUiSelection=null,this.dragHandledExternally=!1,this.startedLeftButtonDrag=!1,this.preHighlightTimeout&&(this.triggerPreHighlightPick(t),this.clearPreHighlightTimeout()),this.hoveredUiSelection=this.viewer.getUISelectionManager().getHoveredSelection()}onDrag(e,t,i,s,n){this.dragTravel+=pe.gv.length([t,i]);const r=this.getViewer();if(!r.performingBoxSelection()&&r.isReadyForDrawing())if(r.getPrimaryViewController().onDrag(e,this.buttonState,t,i,s,n),r.getPrimaryViewController().isBeingManipulated()?(this.viewer.setUserIsAdjustingCamera(),(0,ve.IQ)()):this.viewer.setUserIsManipulatingWithTimeout(),this.buttonState.leftButton||this.stopLeftMouseButtonHandlers.call(this,e),!this.startedLeftButtonDrag&&this.shouldStartLeftButtonDrag())this.startLeftButtonDrag();else if(this.draggedUiSelection){const t=r.getCanvasCoordinateFromEvent(e);this.draggedUiSelection.uiElement.triggerDrag(this.draggedUiSelection,{mouseX:t[0],mouseY:t[1],camera:r.getCamera(),shiftKey:e.shiftKey})}else this.dragHandledExternally&&(this.sketch&&this.sketch.endPointScreen(r.getCanvasCoordinateFromEvent(e)),this.externalDragHandler&&this.externalDragHandler.onDrag(e))}onDragStop(e){const t=this.getViewer();this.leftButtonDownOnDragStart&&!this.startedLeftButtonDrag&&this.initialDragEvent&&!this.forcedManipulationActive&&this.onClick(this.initialDragEvent),this.forcedManipulationActive=!1,t.isReadyForDrawing()&&(t.getPrimaryViewController().onDragStop(e),this.stopLeftMouseButtonHandlers.call(this,e),this.suppressMouseMovePick||this.schedulePreHighlightPick(e))}schedulePreHighlightPick(e){const t=this,i=this.viewer.getAveragePickDuration()*q.default.getManager().getNumber("PAUSED_MOUSE_PREHIGHLIGHT_TIMEOUT_MULTIPLIER");this.preHighlightTimeout=window.setTimeout((function(){t.triggerPreHighlightPick(e),t.preHighlightTimeout=0}),i)}clearPreHighlightTimeout(){this.preHighlightTimeout&&(window.clearTimeout(this.preHighlightTimeout),this.preHighlightTimeout=0)}triggerPreHighlightPick(e,t){if(!e)return;const i=this.getViewer();if(!i||!i.getGlContext())return;if(this.viewer.getIsForPreviousVersionDisplay()&&"mousemove"!==e.type)return;const s=i.getCanvasCoordinateFromEvent(e);i.doPick(s[0],s[1],!0,!0,{onlyRemovePreHighlight:!!t,sourceEvent:e,altKey:this.altHeld})}shouldStartLeftButtonDrag(){const e=q.default.getManager(),t=(0,Js.Wj)()-this.dragStartTime,i=this.getViewer().getPrimaryViewController();return!this.startedLeftButtonDrag&&!i.isBeingForceManipulated()&&this.leftButtonDownOnDragStart&&t>e.getNumber("LEFT_MOUSE_DRAG_TIME_TOLERANCE")&&this.dragTravel>e.getNumber("LEFT_MOUSE_DRAG_DISTANCE_TOLERANCE")}startLeftButtonDrag(){const e=this.getViewer();ph()?this.hoveredUiSelection=new wh.i(this.boxSelector,gn,""):this.triggerPreHighlightPick(this.initialDragEvent);const t=e.getCanvasCoordinateFromEvent(this.initialDragEvent);this.hoveredUiSelection&&this.hoveredUiSelection.uiElement.triggerDragStart(this.hoveredUiSelection,{mouseX:t[0],mouseY:t[1],camera:e.getCamera()})&&(this.draggedUiSelection=this.hoveredUiSelection),this.dragHandledExternally=!1,this.draggedUiSelection||(this.sketch&&this.sketch.startPointScreen(t),this.externalDragHandler&&(this.dragHandledExternally=this.externalDragHandler.onDragStart(this.initialDragEvent))),this.draggedUiSelection||this.dragHandledExternally||(this.draggedUiSelection=new wh.i(this.boxSelector,gn,""),this.draggedUiSelection.uiElement.triggerDragStart(this.draggedUiSelection,{mouseX:t[0],mouseY:t[1],camera:e.getCamera()})||(this.draggedUiSelection=null)),this.startedLeftButtonDrag=!0}stopLeftMouseButtonHandlers(e){const t=this.getViewer();if(this.draggedUiSelection){const i=this.viewer.getCanvasCoordinateFromEvent(e);this.draggedUiSelection.uiElement.triggerDragStop(this.draggedUiSelection,{mouseX:i[0],mouseY:i[1],camera:t.getCamera()}),this.draggedUiSelection=null}this.dragHandledExternally&&(this.sketch&&this.sketch.endPointScreen([e.pageX,e.pageY]),this.externalDragHandler&&this.externalDragHandler.onDragStop(e),this.dragHandledExternally=!1)}showContextMenu(e){this.getViewer().$el.osContextMenu({x:e.pageX,y:e.pageY})}notifyGraphicsHandledClick(e){(0,VM.xA)().trigger(VM.sd,e),ps.Jq.FlyoutService.collapseAllFlyouts(),e&&e.skipCommentClearHighlight||ps.Jq.CommentEditService.clearCommentHighlights()}onLongPress(e,t){const i=this.viewer.getCanvasCoordinateFromEvent(t),s=this.viewer.pickIteratively(i[0],i[1],this.viewer.getDefaultPickTerminationEvaluator(),{altKey:e.altKey});let n=null;for(let e=0;e<s.length&&!n;++e)n=s[e].uiSelection;n&&(this.longPressedUiSelection=n,this.longPressedUiSelection.uiElement.triggerLongPressStart(this.longPressedUiSelection,e))}getAltHeld(){return this.altHeld}}var Ns,bs=i(6805),Ls=i(64022),Fs=i(65583),xs=i(66792),Bs=i(56393),Us=i(40870);!function(e){e.PREVIEW_STATE_CHANGE="previewStateChange",e.PREVIEW_BLEND_CHANGE="previewBlendChange"}(Ns||(Ns={}));const Vs=.7;class Gs{constructor(){this.eventsSubject=new Fs.x,this.stateProperties=new xs.X({previewAlpha:Vs,latestDisplayDataUsage:W.rvN.BASE,inCompareMode:!1}),ps.Jq.StateService?this.inCompareMode=ps.Jq.StateService.isOnDocumentCompare():this.inCompareMode=!1,this.inCompareModeChangedObservable.subscribe((()=>{this.eventsSubject.next(Ns.PREVIEW_STATE_CHANGE)})),this.latestDisplayDataUsageChangedObservable.subscribe((()=>{const e=this.inCompareMode;e||this.eventsSubject.next(Ns.PREVIEW_STATE_CHANGE);const t=this.latestDisplayDataUsage===W.rvN.BASE,i=this.latestDisplayDataUsage===W.rvN.COMPARE_TARGET;!e||t||i?!e&&i&&It.log.warn("Received COMPARE_TARGET message while not in compare mode."):It.log.warn("Received a non-BASE and non-COMPARE_TARGET message while in compare mode.")})),this.previewAlphaChangedObservable.subscribe((()=>{this.eventsSubject.next(Ns.PREVIEW_BLEND_CHANGE)}))}get inCompareModeChangedObservable(){return this.stateProperties.asObservable().pipe((0,Bs.G)(),(0,Pe.h)((([e,t])=>e.inCompareMode!==t.inCompareMode)),(0,Us.U)((([e,t])=>t)))}get stateChangedObservable(){return this.eventsSubject.asObservable()}get latestDisplayDataUsageChangedObservable(){return this.stateProperties.asObservable().pipe((0,Bs.G)(),(0,Pe.h)((([e,t])=>e.latestDisplayDataUsage!==t.latestDisplayDataUsage)),(0,Us.U)((([e,t])=>t)))}get previewAlphaChangedObservable(){return this.stateProperties.asObservable().pipe((0,Bs.G)(),(0,Pe.h)((([e,t])=>e.previewAlpha!==t.previewAlpha)),(0,Us.U)((([e,t])=>t)))}get latestDisplayDataUsage(){return this.stateProperties.getValue().latestDisplayDataUsage}set latestDisplayDataUsage(e){const t={...this.stateProperties.getValue(),latestDisplayDataUsage:e};this.stateProperties.next(t)}get inCompareMode(){return this.stateProperties.getValue().inCompareMode}set inCompareMode(e){const t={...this.stateProperties.getValue(),inCompareMode:e};this.stateProperties.next(t)}get previewAlpha(){return this.stateProperties.getValue().previewAlpha}set previewAlpha(e){const t={...this.stateProperties.getValue(),previewAlpha:e};this.stateProperties.next(t)}}let Hs=null;function ks(){return Hs||(Hs=new Gs),Hs}function Ws(){ks().inCompareMode=!1,ks().latestDisplayDataUsage=W.rvN.BASE}function zs(){return ks().previewAlpha}function Xs(){return!!Ys()&&ks().previewAlpha>.5}function qs(){return Xs()?Ls.L.PREVIEW:Ls.L.BASE}function Zs(){return ks().latestDisplayDataUsage===W.rvN.BASE&&!ks().inCompareMode}function Ys(){return ks().inCompareMode}function Ks(){return ks().latestDisplayDataUsage}function js(){const e=Ks();return e===W.rvN.PREVIEW_BEFORE||e===W.rvN.PREVIEW_AFTER||e===W.rvN.PREVIEW_FINAL}function Qs(){return Ks()===W.rvN.PREVIEW_AFTER}function $s(){return Ks()===W.rvN.PREVIEW_FINAL}var Js=i(5651);const en=new ki({diffuseFactor:.5,ambientFactor:.5}),tn=new Qi({isPickable:!1,isTwoSided:!0,primitiveType:_i.MX.TRIANGLE_STRIP,isShowThrough:!0,isDepthTested:!1,priority:Yi.LOWER,material:en}),sn=new Qi({isPickable:!1,primitiveType:_i.MX.LINES});class nn extends Ri{constructor(e,t){super(e),this.manipulatorId=t,this.sourcePrimitives=[],this.sourceIds=[]}initialize(e){return!(e.length<1)&&(!!this.createPreviewMeshes(e)&&!!this.updateMeshes())}duplicatePrimitive(e){const t=e.clone();return t.id="",e.points&&(t.points=new Float32Array(e.points)),t}createPreviewMeshes(e){this.sourcePrimitives=[];const t=q.default.getManager().getColor("FEATURE_FAST_PREVIEW_COLOR"),i=this.viewer.getModelViewManagers().getManager();return i&&e.forEach((function(e){const s=i.extractMeshIncrement(e);if(s){const i=this.duplicatePrimitive(s);i.colors=null,Uu(t,i),this.sourcePrimitives.push(i),this.sourceIds.push(e)}}),this),this.sourceIds.length>=1}updateMeshes(){return!1}}var rn=i(37603),an=i(41057);class on extends nn{constructor(e,t){super(e,t),this.axisDirection=null,this.axisRoot=null,this.angle=0}setAngle(e){this.update(null,e)}update(e,t,i,s){return!(e&&!(0,an.Z)(e,this.sourceIds))&&(t&&(this.angle=t),i&&(this.axisRoot=i),s&&(this.axisDirection=s),this.updateMeshes())}updateMeshes(){let e,t,i,s,n;const r=pe.Jb.fromAngleAxis(this.angle,this.axisDirection,rn.create());for(let a=0;a<this.sourceIds.length;++a){for(e=this.sourcePrimitives[a],t=this.duplicatePrimitive(e),i=this.sourceIds[a],s=0;s<e.points.length;s+=3){const i=v.fromValues(e.points[s],e.points[s+1],e.points[s+2]);for(pe.S4.subtract(i,this.axisRoot),pe.Jb.multiplyVec3(r,i),pe.S4.add(i,this.axisRoot),n=0;n<3;++n)t.points[s+n]=i[n]}t.isTriangles()?this.updateMeshIncrement(i,yi,t,tn):this.updateMeshIncrement(i,yi,t,sn)}return!0}}function hn(e,t,i,s,n,r){const a=new on(r,e);return a.axisRoot=s,a.axisDirection=n,a.angle=i,a.initialize(t)?a:null}class cn extends nn{constructor(e,t){super(e,t),this.direction=null,this.distance=0,this.offset=0}setDistance(e){this.update(null,null,e)}update(e,t,i,s){return!(e&&!(0,an.Z)(e,this.sourceIds))&&(t&&(this.direction=t),i&&(this.distance=i),void 0!==s&&(this.offset=s),this.updateMeshes())}updateMeshes(){let e,t,i,s,n;const r=v.create();pe.S4.scale(this.direction,this.distance+this.offset,r);for(let a=0;a<this.sourceIds.length;++a){for(e=this.sourcePrimitives[a],t=this.duplicatePrimitive(e),i=this.sourceIds[a],s=0;s<e.points.length;s+=3)for(n=0;n<3;++n)t.points[s+n]=e.points[s+n]+r[n];t.isTriangles()?this.updateMeshIncrement(i,yi,t,tn):this.updateMeshIncrement(i,yi,t,sn)}return!0}}function ln(e,t,i,s,n,r){const a=new cn(n,e);return a.direction=i,a.distance=s,void 0!==r&&(a.offset=r),a.initialize(t)?a:null}var un=i(38481),dn=i(32659);const gn="box",pn=q.default.getManager();let mn=!0;function fn(e){mn=e}const In=new Qi({isPickable:!1,primitiveType:_i.MX.LINES}),En=new Qi({isPickable:!1,primitiveType:_i.MX.TRIANGLES,primitivesHaveTransparency:!0,material:Wi});class Sn extends Ri{constructor(e){super(e,sh.EG),this.mouseDown=[0,0],this.lastMouse=[0,0],this.canceled=!1,this.zoomCursorOnStack=!1,this.zoomTriggeredByMenu=!1,this.zoomModifier=!1,this.dragging=!1,this.listeningToKeyDispatcher=!1,this.listeningToOutsideClick=!1,this.mouseOnCanvas=!0,this.messageBubble=ps.Jq.MessageBubbleService.createMessageBubble(),this.listenTo(this,Pi.DRAG_START+gn,this.onDragStart),this.listenTo(this,Pi.DRAG+gn,this.onDrag),this.listenTo(this,Pi.DRAG_STOP+gn,this.onDragStop),this.zoomModeEnabledSubscription=lh().zoomModeEnabledObservable.subscribe((()=>this.onZoomModeChange()))}remove(){this.zoomModeEnabledSubscription.unsubscribe(),super.remove()}getPositionFromEvent(e){return[e.mouseX,e.camera.getViewportHeight()-e.mouseY]}performContainmentSelection(){return this.lastMouse[0]>this.mouseDown[0]}left(){return Math.min(this.lastMouse[0],this.mouseDown[0])}right(){return Math.max(this.lastMouse[0],this.mouseDown[0])}bottom(){return Math.min(this.lastMouse[1],this.mouseDown[1])}top(){return Math.max(this.lastMouse[1],this.mouseDown[1])}onDragStart(e,t,i){this.viewer.getSuppressModelSelection()?this.canceled=!0:(this.lastMouse=this.mouseDown=this.getPositionFromEvent(t),this.updateGraphics(),i.requestDrag=!0,this.canceled=!1,this.dragging=!0,this.listenToKeyDispatcher(),(0,Js.vm)())}onDrag(e,t){this.canceled||(this.lastMouse=this.getPositionFromEvent(t),this.updateGraphics(),(0,Js.vm)())}onDragStop(e,t){if(this.canceled)return;this.dragging=!1;const i=this.right()-this.left(),s=this.top()-this.bottom(),n=t.camera.getViewportHeight()-this.top();if(this.zoomIsEnabled())gh(!1),this.viewer.animateZoomToRectangle(this.left(),n,i,s),this.removeMeshIncrements(),this.stopListeningToKeyDispatcher(),this.tearDownOutsideClickListeners();else{const e=this.viewer.performBoxSelection(this.left(),n,i,s,this.performContainmentSelection()),t=this;e?e.then((function(){t.removeMeshIncrements(),t.stopListeningToKeyDispatcher()})):(t.removeMeshIncrements(),this.stopListeningToKeyDispatcher())}}onKeyDown(e){e.which===Os.R8.CANCEL&&this.cancelSelection()}outsideClickHandler(e){!this.mouseOnCanvas&&e&&e.target&&gh(!1)}setupOutsideClickListeners(){this.listeningToOutsideClick||(this.mouseOnCanvas=!0,dn(document).on("click.boxSelector",this.outsideClickHandler.bind(this)),this.listenTo(this.viewer.getEventDispatcher(),VM.ox,this.onMouseEnter),this.listenTo(this.viewer.getEventDispatcher(),VM.u5,this.onMouseLeave),this.listeningToOutsideClick=!0)}onMouseEnter(e){this.mouseOnCanvas=!0}onMouseLeave(e){this.mouseOnCanvas=!1}tearDownOutsideClickListeners(){this.listeningToOutsideClick&&(dn(document).off("click.boxSelector"),this.listeningToOutsideClick=!1)}listenToKeyDispatcher(){this.listeningToKeyDispatcher||(this.listenTo((0,un.getDispatcher)(),un.Events.KEYDOWN,this.onKeyDown),this.listeningToKeyDispatcher=!0)}stopListeningToKeyDispatcher(){this.listeningToKeyDispatcher&&(this.stopListening((0,un.getDispatcher)()),this.listeningToKeyDispatcher=!1)}pushZoomCursor(){this.zoomCursorOnStack||(this.viewer.pushCursor(Xn.C.ZOOM_IN),this.zoomCursorOnStack=!0)}popZoomCursor(){this.zoomCursorOnStack&&(this.viewer.removeTopOccurrenceOfCursor(Xn.C.ZOOM_IN),this.zoomCursorOnStack=!1)}cancelSelection(){this.viewer.performingBoxSelection()?this.viewer.stopBoxSelection():(this.resetZoomState(),this.canceled=!0,this.removeMeshIncrements(),this.stopListeningToKeyDispatcher(),this.tearDownOutsideClickListeners()),this.dragging=!1}getVertex(e,t){return[e,t,0]}getBoxLineColor(){if(this.zoomIsEnabled())return pn.getColor("BOX_ZOOM_COLOR");return this.performContainmentSelection()?pn.getColor("BOX_SELECT_COLOR"):pn.getColor("CROSS_SELECT_COLOR")}getBoxStipple(){if(this.zoomIsEnabled())return pn.getStipple("BOX_ZOOM_LINE_STIPPLE");return this.performContainmentSelection()?pn.getStipple("BOX_SELECT_LINE_STIPPLE"):pn.getStipple("CROSS_SELECT_LINE_STIPPLE")}updateGraphics(){const e=Iu([this.getVertex(this.mouseDown[0],this.mouseDown[1]),this.getVertex(this.lastMouse[0],this.mouseDown[1]),this.getVertex(this.lastMouse[0],this.mouseDown[1]),this.getVertex(this.lastMouse[0],this.lastMouse[1]),this.getVertex(this.lastMouse[0],this.lastMouse[1]),this.getVertex(this.mouseDown[0],this.lastMouse[1]),this.getVertex(this.mouseDown[0],this.lastMouse[1]),this.getVertex(this.mouseDown[0],this.mouseDown[1])]);let t;this.left()!==this.right()&&this.bottom()!==this.top()&&(t=Ou(this.getVertex(this.left(),this.bottom()),this.getVertex(this.right(),this.bottom()),this.getVertex(this.left(),this.top())));const i=this.getBoxLineColor(),s=this.getBoxStipple();if(Uu(i,e),ku(s,e),Hu(pn.getNumber("BOX_SELECT_LINE_WIDTH"),e),this.updateMeshIncrement("lines",yi,e,In),t){const e=i.slice(0);e[3]=pn.getNumber("BOX_SELECT_INFILL_OPACITY"),Uu(e,t),this.updateMeshIncrement("interior",yi,t,En)}else this.removeMeshIncrement("interior")}triggerDragStart(e,t){const i=!!(0,ve.VT)()&&(0,ve.VT)().getIsAQueryList()&&1===(0,ve.HP)();return!!(this.zoomIsEnabled()||mn&&!i)&&super.triggerDragStart(e,t)}zoomIsEnabled(){return dh()}startZoom(){this.pushZoomCursor()}stopZoom(){this.popZoomCursor()}resetZoomState(){gh(!1)}showZoomMessage(){this.messageBubble.showMessage(i18n("Drag to create zoom bounding box."))}dismissZoomMessage(){this.messageBubble.dismissMessage()}onZoomModeChange(){this.zoomIsEnabled()?(this.startZoom(),this.listenToKeyDispatcher(),this.setupOutsideClickListeners(),this.dragging?this.updateGraphics():this.showZoomMessage()):(this.dragging&&this.updateGraphics(),this.stopListeningToKeyDispatcher(),this.stopZoom(),this.tearDownOutsideClickListeners(),this.dismissZoomMessage())}}const Tn=q.default.getManager(),Mn=new Qi({isPickable:!1,primitiveType:_i.MX.LINES});class Cn extends Ri{constructor(e){super((0,Q.as)(fT,e),sh.EG),this.mousePositions=[],this.color=Tn.getColor("SKETCH_DRAG_TRIM_PATH_COLOR"),this.number=Tn.getNumber("SKETCH_DRAG_TRIM_PATH_WIDTH"),this.newLineSegment=!0}onAppearanceConstantsUpdated(){this.color=Tn.getColor("SKETCH_DRAG_TRIM_PATH_COLOR"),this.updateGraphics()}reset(){this.mousePositions=[],this.newLineSegment=!0,this.updateGraphics(),this.viewer.forceRequestDraw()}addPositionToDragTrimLine(e){const t=this.viewer.getCanvasCoordinateFromEvent(e);this.updateMousePositionsWithDragEvent(t),this.updateGraphics(),(0,Js.vm)()}makeNewLineSegment(){this.newLineSegment=!0}updateMousePositionsWithDragEvent(e){const t=new W.YFv;t.updateFromArray(this.viewer.getCamera().viewportToCanvas(e)),this.newLineSegment||this.mousePositions.length%2!=0?(this.mousePositions.push(t),this.newLineSegment=!1):this.mousePositions[this.mousePositions.length-1].equals(t)||(this.mousePositions.push(this.mousePositions[this.mousePositions.length-1]),this.mousePositions.push(t))}updateGraphics(){if(this.mousePositions.length%2!=0)return;const e=Iu(this.mousePositions.map((e=>[e.x,e.y,0])),"dragTrimLine",this.color,this.number);this.updateMeshIncrement("lines",yi,e,Mn)}}class Dn{constructor(){this.activeMateConnectorMap=new Map}addMateConnector(e){e&&e.length>0&&this.activeMateConnectorMap.set(e,null)}removeMateConnector(e){if(e&&e.length>0&&this.activeMateConnectorMap.has(e)){const t=this.activeMateConnectorMap.get(e);this.activeMateConnectorMap.delete(e),t&&!t.isHidden&&t.muteIfActive()}}removeAllMateConnectors(){for(const e of this.activeMateConnectorMap.keys())this.removeMateConnector(e)}resetMateConnectors(e){this.removeAllMateConnectors();for(const t of e)this.addMateConnector(t)}isMateConnectorActive(e,t){const i=this.activeMateConnectorMap.has(e);return i&&!this.activeMateConnectorMap.get(e)&&this.activeMateConnectorMap.set(e,t),i}destroy(){this.removeAllMateConnectors()}}var vn=i(50529),Pn=i(40620),yn=i(33293);var An,On;!function(e){e[e.OPERATION_PERSISTENT=0]="OPERATION_PERSISTENT",e[e.UI=1]="UI",e[e.FILTERED_ENTITIES=2]="FILTERED_ENTITIES",e[e.ACCUMULATED_SMART_SELECTION=3]="ACCUMULATED_SMART_SELECTION",e[e.SMART_SELECTION=4]="SMART_SELECTION",e[e.INCONTEXT_REFERENCE_PRE=5]="INCONTEXT_REFERENCE_PRE",e[e.ASSOCIATED_OCCURRENCE_PRE=6]="ASSOCIATED_OCCURRENCE_PRE",e[e.OCCURRENCE_SECONDARY_PRE=7]="OCCURRENCE_SECONDARY_PRE",e[e.PRE=8]="PRE",e[e.OCCURRENCE_PRE=9]="OCCURRENCE_PRE",e[e.COMMENT=10]="COMMENT",e[e.INCONTEXT_REFERENCE=11]="INCONTEXT_REFERENCE",e[e.OCCURRENCE_COMMENT=12]="OCCURRENCE_COMMENT",e[e.UI_RELATED_ENTITY=13]="UI_RELATED_ENTITY",e[e.ASSOCIATED_OCCURRENCE=14]="ASSOCIATED_OCCURRENCE",e[e.RELATED_OCCURRENCE=15]="RELATED_OCCURRENCE",e[e.OCCURRENCE=16]="OCCURRENCE",e[e.PART=17]="PART",e[e.FEATURE=18]="FEATURE",e[e.ENTITY=19]="ENTITY",e[e.ERROR=20]="ERROR",e[e.SECONDARY_PRE=21]="SECONDARY_PRE",e[e.SECONDARY=22]="SECONDARY",e[e.RETRIEVAL=23]="RETRIEVAL",e[e.REPAIR=24]="REPAIR",e[e.REPAIR_HOVER=25]="REPAIR_HOVER"}(An||(An={})),function(e){e[e.NO_HIGHLIGHT=0]="NO_HIGHLIGHT",e[e.HIGHLIGHT=1]="HIGHLIGHT",e[e.SUPPRESS_INTERIOR=2]="SUPPRESS_INTERIOR"}(On||(On={}));class Rn{constructor(e,t,i,s,n,r){this.type=e,this.priority=t,this.color1=[0,0,0,0],this.colorBorder=[0,0,0,0],this.indexInstanceIdColor=[0,0,0,On.HIGHLIGHT/255],this.style=null,this.index=0,this.idString="",this.debugStack=null,this.usage=Ls.L.BASE,this.associatedPrimaryHighlightType=r||null,this.outlineOverlappingInteriorRegions=this.type===yn.o2.ENTITY||this.type===yn.o2.SMART_SELECTION||this.type===yn.o2.ACCUMULATED_SMART_SELECTION,this.forOccurrences=this.type===yn.o2.OCCURRENCE||this.type===yn.o2.OCCURRENCE_PRE||this.type===yn.o2.OCCURRENCE_COMMENT||this.type===yn.o2.OCCURRENCE_SECONDARY_PRE||this.type===yn.o2.RELATED_OCCURRENCE||this.type===yn.o2.RELATED_OCCURRENCE_MATE||this.type===yn.o2.ASSOCIATED_OCCURRENCE||this.type===yn.o2.ASSOCIATED_OCCURRENCE_PRE||this.type===yn.o2.RETRIEVAL||this.type===yn.o2.OPERATION_PERSISTENT,this.updateColors(),void 0!==i&&this.setIndex(i),this.instanceId=Di.JE,void 0!==s&&this.setInstanceId(s),this.occurrence=n}updateColors(e){const t=q.default.getManager();if(this.color1=t.getColor(this.type+"_HIGHLIGHT_COLOR1"),this.colorBorder=t.getColor(this.type+"_HIGHLIGHT_COLOR_BORDER"),e)for(let t=0;t<3;t++)this.color1[t]=e[t],this.colorBorder[t]=e[t]}getIdString(){return this.idString}cloneForOccurrence(e){return new Rn(this.type,this.priority,this.index,this.instanceId,e,this.associatedPrimaryHighlightType)}cloneForInstance(e){return new Rn(this.type,this.priority,this.index,e,this.occurrence,this.associatedPrimaryHighlightType)}setIndex(e){this.index=e,this.updateIndexInstanceColor()}setInstanceId(e){this.instanceId=e,this.idString=this.type+"."+this.instanceId,this.updateIndexInstanceColor()}getInstanceNumber(){return(0,Di.rp)(this.instanceId)?Math.max(255&this.instanceId[0],1):0}updateIndexInstanceColor(){this.indexInstanceIdColor[0]=(255&this.index)/255;const e=this.getInstanceNumber();this.indexInstanceIdColor[1]=(e>>>4&15)/255,this.indexInstanceIdColor[2]=(15&e)/255}getStyle(){return this.style||(this.style=new fE,this.style.setAttribute(Jd.HIGHLIGHT_ID,this.indexInstanceIdColor)),this.style}getIndexInstanceEncodedInFloat(){return this.index+256*this.getInstanceNumber()}}function wn(e,t){return e.type===t.type&&e.instanceId===t.instanceId&&e.associatedPrimaryHighlightType===t.associatedPrimaryHighlightType&&(0,vn.wB)(e.occurrence,t.occurrence)}function _n(e){e[yn.o2.UI]=new Rn(yn.o2.UI,An.UI),e[yn.o2.RELATED_OCCURRENCE]=new Rn(yn.o2.RELATED_OCCURRENCE,An.RELATED_OCCURRENCE),e[yn.o2.RELATED_OCCURRENCE_MATE]=new Rn(yn.o2.RELATED_OCCURRENCE_MATE,An.RELATED_OCCURRENCE),e[yn.o2.ACCUMULATED_SMART_SELECTION]=new Rn(yn.o2.ACCUMULATED_SMART_SELECTION,An.ACCUMULATED_SMART_SELECTION),e[yn.o2.SMART_SELECTION]=new Rn(yn.o2.SMART_SELECTION,An.SMART_SELECTION),e[yn.o2.UI_RELATED_ENTITY]=new Rn(yn.o2.UI_RELATED_ENTITY,An.ENTITY),e[yn.o2.ENTITY]=new Rn(yn.o2.ENTITY,An.ENTITY),e[yn.o2.FEATURE]=new Rn(yn.o2.FEATURE,An.FEATURE),e[yn.o2.PART]=new Rn(yn.o2.PART,An.PART),e[yn.o2.OCCURRENCE]=new Rn(yn.o2.OCCURRENCE,An.OCCURRENCE),e[yn.o2.OCCURRENCE_PRE]=new Rn(yn.o2.OCCURRENCE_PRE,An.OCCURRENCE_PRE),e[yn.o2.PRE]=new Rn(yn.o2.PRE,An.PRE),e[yn.o2.SECONDARY]=new Rn(yn.o2.SECONDARY,An.SECONDARY),e[yn.o2.SECONDARY_PRE]=new Rn(yn.o2.SECONDARY_PRE,An.SECONDARY_PRE),e[yn.o2.OCCURRENCE_SECONDARY_PRE]=new Rn(yn.o2.OCCURRENCE_SECONDARY_PRE,An.OCCURRENCE_SECONDARY_PRE),e[yn.o2.COMMENT]=new Rn(yn.o2.COMMENT,An.COMMENT),e[yn.o2.FILTERED_ENTITIES]=new Rn(yn.o2.FILTERED_ENTITIES,An.FILTERED_ENTITIES),e[yn.o2.OCCURRENCE_COMMENT]=new Rn(yn.o2.OCCURRENCE_COMMENT,An.OCCURRENCE_COMMENT),e[yn.o2.ASSOCIATED_OCCURRENCE]=new Rn(yn.o2.ASSOCIATED_OCCURRENCE,An.ASSOCIATED_OCCURRENCE),e[yn.o2.ASSOCIATED_OCCURRENCE_PRE]=new Rn(yn.o2.ASSOCIATED_OCCURRENCE_PRE,An.ASSOCIATED_OCCURRENCE_PRE),e[yn.o2.ERROR]=new Rn(yn.o2.ERROR,An.ERROR),e[yn.o2.INCONTEXT_REFERENCE]=new Rn(yn.o2.INCONTEXT_REFERENCE,An.INCONTEXT_REFERENCE),e[yn.o2.INCONTEXT_REFERENCE_PRE]=new Rn(yn.o2.INCONTEXT_REFERENCE_PRE,An.INCONTEXT_REFERENCE_PRE),e[yn.o2.RETRIEVAL]=new Rn(yn.o2.RETRIEVAL,An.RETRIEVAL),e[yn.o2.OPERATION_PERSISTENT]=new Rn(yn.o2.OPERATION_PERSISTENT,An.OPERATION_PERSISTENT),e[yn.o2.REPAIR]=new Rn(yn.o2.REPAIR,An.REPAIR),e[yn.o2.REPAIR_HOVER]=new Rn(yn.o2.REPAIR_HOVER,An.REPAIR_HOVER)}function Nn(e,t){for(const i in e)t.push(e[i]);t.sort((function(e,t){return e.priority>t.priority?1:e.priority<t.priority?-1:0}));for(let e=0;e<t.length;++e)t[e].setIndex(e)}class bn{constructor(e){this.viewer=e,this.highlights={},this.sortedHighlights=[],(0,Ih.Yk)(e),_n(this.highlights),Nn(this.highlights,this.sortedHighlights)}getSortedHighlights(){return this.sortedHighlights}getHighlightTextureWidth(){return this.sortedHighlights.length}updateHighlightColor(e,t){this.highlights[e].updateColors(t),this.viewer.getResources().invalidateHighlightTexture()}destroy(){this.highlights={},this.sortedHighlights=[]}}class Ln{constructor(e){this.referenceHighlights=e,this.highlightInstanceIdManagers={},this.highlightToSelectionToInstanceId={},this.usage=Ls.L.BASE;for(const e in yn.o2)this.highlightInstanceIdManagers[e]=new Di.si(Di._6.HIGHLIGHT),this.highlightToSelectionToInstanceId[e]={}}getInstanceIdForHighlightAndSelection(e,t){const i=this.highlightToSelectionToInstanceId[e][t];return i||Di.JE}constructHighlightForTypeAndInstance(e,t,i=!1){const s=this.referenceHighlights.highlights[e].cloneForInstance(t);if(s.usage=this.usage,i){(255*s.indexInstanceIdColor[3]&On.SUPPRESS_INTERIOR)>0||(s.indexInstanceIdColor[3]+=On.SUPPRESS_INTERIOR/255)}return s}createHighlightForSelection(e,t,i=!1){if(!this.referenceHighlights)return new Rn(yn.o2.ERROR,An.ERROR);let s=this.getInstanceIdForHighlightAndSelection(e,t);return(0,Di.rp)(s)||(s=this.highlightInstanceIdManagers[e].getId(),this.highlightToSelectionToInstanceId[e][t]=s),this.constructHighlightForTypeAndInstance(e,s,i)}freeHighlightForSelection(e,t){const i=this.getInstanceIdForHighlightAndSelection(e,t);return(0,Di.rp)(i)&&(this.highlightInstanceIdManagers[e].freeId(i),delete this.highlightToSelectionToInstanceId[e][t]),i}createSecondaryHighlight(e,t,i){const s=this.createHighlightForSelection(e,i+Pn.ID_SEPARATOR+t);return s.associatedPrimaryHighlightType=t,s}freeSecondaryHighlight(e,t,i){this.freeHighlightForSelection(e,i+Pn.ID_SEPARATOR+t)}resetHighlightInstanceIds(e){this.highlightInstanceIdManagers[e].reset(),this.highlightToSelectionToInstanceId[e]={}}highlightHasSelections(e){return!(0,Js.hW)(this.highlightToSelectionToInstanceId[e])}}function Fn(e,t){let i=0;for(let s=0;s<t.length;++s){if(wn(t[s],e))return-1;if(e.priority<t[s].priority)break;++i}return t.splice(i,0,e),i}function xn(e,t,i){let s=-1;for(let n=0;n<t.length;++n)if(i&&e.type===t[n].type||wn(t[n],e)){s=n;break}return s<0||t.splice(s,1),s}var Bn,Un=i(54124),Vn=i(29443);!function(e){e[e.OVERDEFINED=1]="OVERDEFINED",e[e.EXTERNAL_AND_OK=2]="EXTERNAL_AND_OK",e[e.OK=3]="OK",e[e.DRIVEN=4]="DRIVEN"}(Bn||(Bn={}));const Gn=function(e){const t=this.viewer.getReferenceHighlights(),i=new Uint8Array(4*t.sortedHighlights.length);for(let e=0;e<t.sortedHighlights.length;e++){const s=(0,Js.Db)(t.sortedHighlights[e].color1);for(let t=0;t<4;t++)i[4*e+t]=s[t]}const s=new co(e);return s.bytes=i,s.width=i.length/4,s.height=1,s},Hn={isVisible:!0,isTwoSided:!0,priority:Yi.HIGHER,primitiveType:_i.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!1},kn=q.default.getManager();class Wn extends m.T{constructor(e){super(),this.viewer=e,this.blitQuad=null,this.highlightColorTexture=null,this.blankTexture=null,this.primitiveRestartBuffer=null,this.constraintAtlas=null,this.typeToNodeProperties={},this.constraintAtlasCreationInitiated=!1,this.constraintAtlasCreationId=0,this.commentIndicatorAtlas=null,this.commentIndicatorAtlasCreationInitiated=!1,this.dimensionAtlas=null,this.dimensionAtlasCreationInitiated=!1,this.dimensionAtlasCreationId=-1,this.centerOfMassIndicatorNodeProperties=null,this.scalarVisualizationTextures=new Map,this.imageTextureCache=new Map,this.PART_SURFACE_LINE_POINT_MATERIAL=new ki({color:kn.getColor("LINE_POINT_COLOR")}),this.WIRE_LINE_POINT_MATERIAL=new ki({color:kn.getColor("LINE_POINT_COLOR")}),this.PART_EDGE_NODE_PROPERTIES=new Qi({material:this.PART_SURFACE_LINE_POINT_MATERIAL,zOffset:kn.getNumber("PART_EDGES_Z_OFFSET"),primitiveType:_i.MX.LINES,addsToBounds:!1,includedInBlend:!0,clippedBySectionPlanes:!0}),this.SURFACE_EDGE_NODE_PROPERTIES=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({zOffset:kn.getNumber("SURFACE_EDGES_Z_OFFSET")}),this.WIRE_EDGE_NODE_PROPERTIES=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({material:this.WIRE_LINE_POINT_MATERIAL,zOffset:kn.getNumber("WIRE_EDGES_Z_OFFSET"),addsToBounds:!0}),this.PART_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({zOffset:kn.getNumber("NON_MODIFIABLE_Z_OFFSET_EDGE")}),this.SURFACE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.SURFACE_EDGE_NODE_PROPERTIES.cloneAndModify({zOffset:kn.getNumber("NON_MODIFIABLE_Z_OFFSET_EDGE")}),this.WIRE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.WIRE_EDGE_NODE_PROPERTIES.cloneAndModify({zOffset:kn.getNumber("NON_MODIFIABLE_Z_OFFSET_EDGE")}),this.CENTER_LINE_MATERIAL=new ki({color:kn.getColor("LINE_POINT_COLOR"),lineStipple:kn.getStipple("CENTER_LINE_STIPPLE")}),this.CENTER_LINE_NODE_PRPOPERTIES=this.WIRE_EDGE_NODE_PROPERTIES.cloneAndModify({material:this.CENTER_LINE_MATERIAL}),this.SILHOUETTE_NODE_PROPERTIES=new Qi({material:this.PART_SURFACE_LINE_POINT_MATERIAL,zOffset:kn.getNumber("PART_EDGES_Z_OFFSET"),primitiveType:_i.MX.SILHOUETTES,addsToBounds:!1,includedInBlend:!0,clippedBySectionPlanes:!0}),this.SMOOTH_EDGE_COLOR=kn.getColor("LINE_POINT_COLOR"),(0,Ih.Yk)(e),this.constraintMaterial=Xi(),(0,gt.Z)(Bn,(e=>{this.typeToNodeProperties[e]=new Qi({isPickable:!0,primitiveType:_i.MX.TRIANGLES,material:this.constraintMaterial,isVisible:!0,zOffset:e})})),this.inferenceNodeProperties=new Qi({isPickable:!1,primitiveType:_i.MX.TRIANGLES,material:this.constraintMaterial,isVisible:!0,zOffset:0}),this.listenTo(this.viewer.getEventDispatcher(),VM.pO,this.onGlContextRestored),this.commentIndicatorMaterial=Xi(),this.commentIndicatorNodeProperties=new Qi({primitiveType:_i.MX.TRIANGLES,material:this.commentIndicatorMaterial}),this.dimensionMaterial=Xi(),this.dimensionNodeProperties=[new Qi(Object.assign({isPickable:!0,material:this.dimensionMaterial},Hn)),new Qi(Object.assign({isPickable:!1,material:this.dimensionMaterial},Hn))],this.initializeBodyEdgeResources()}initializeBodyEdgeResources(){}onGlContextRestored(){this.constraintAtlas&&(this.constraintMaterial.ambientTexture=this.constraintAtlas.texture)}reset(){this.blitQuad&&(this.blitQuad.remove(),this.blitQuad=null),this.blankTexture&&(this.blankTexture.destroy(),this.blankTexture=null),this.invalidateHighlightTexture(),this.constraintMaterial.destroy(),this.mateIndicatorGlyphResources&&this.mateIndicatorGlyphResources.destroy(),this.loadGlyphResources&&this.loadGlyphResources.destroy(),this.commentIndicatorMaterial.destroy(),this.dimensionMaterial.destroy(),this.stopListening(),this.primitiveRestartBuffer&&(this.primitiveRestartBuffer.destroy(),this.primitiveRestartBuffer=null)}getBlitNode(){if(!this.blitQuad){const e=new Qi({primitiveType:_i.MX.TRIANGLES,isPickable:!0,isTwoSided:!0,material:null});this.blitQuad=new cM([-1,-1,0],[1,-1,0],[-1,1,0],e,this.viewer,"blit"),this.blitQuad.getOccurrenceData().setShouldSetOccurrenceUniform(!1)}return this.blitQuad.getNode()}getHighlightTexture(){return this.highlightColorTexture||(this.highlightColorTexture=new uo(this.viewer,Gn)),this.highlightColorTexture}invalidateHighlightTexture(){this.highlightColorTexture&&(this.highlightColorTexture.destroy(),this.highlightColorTexture=null)}getBlankTexture(){if(!this.blankTexture){const e=this.viewer.getGlContext(),t=new co(e);t.width=2,t.height=2,t.bytes=new Uint8Array(t.width*t.height*4),this.blankTexture=new uo(this.viewer,t)}return this.blankTexture}getImageTexture(e){let t=this.imageTextureCache.get(e);if(!t){const i=this.viewer.getGlContext(),s=new co(i);s.imageSource=e,s.wrapS=i.CLAMP_TO_EDGE,s.wrapT=i.CLAMP_TO_EDGE,t=new uo(this.viewer,s),t.hasTransparency=!1,this.imageTextureCache.set(e,t)}return t}onDevicePixelRatioChanged(){var e;this.resetConstraintAtlas(),this.resetDimensionAtlas(),null===(e=this.loadGlyphResources)||void 0===e||e.onDevicePixelRatioChanged()}onAppearanceConstantsUpdated(){var e;this.resetConstraintAtlas(),this.resetDimensionAtlas(),null===(e=this.loadGlyphResources)||void 0===e||e.reinitialize(),this.updateBodyEdgeColors()}resetConstraintAtlas(){this.constraintAtlasCreationInitiated=!1,this.constraintAtlas&&(this.constraintAtlas.destroy(),this.constraintAtlas=null),this.viewer.getTextureAtlasFactory().clearAtlas(RC)}resetDimensionAtlas(){this.dimensionAtlasCreationInitiated=!1,this.dimensionAtlas&&(this.dimensionAtlas.destroy(),this.dimensionAtlas=null),this.viewer.getTextureAtlasFactory().clearAtlas(_C)}onRenderingModeChanged(){this.updateBodyEdgeColors()}updateBodyEdgeColors(){switch(this.viewer.getRenderingMode()){case W.P1.HIDDEN_LINE_REMOVED:case W.P1.HIDDEN_LINE_VISIBLE:case W.P1.WIREFRAME:this.PART_SURFACE_LINE_POINT_MATERIAL.color=kn.getColor("UNSHADED_BODY_LINE_COLOR"),this.CENTER_LINE_MATERIAL.color=kn.getColor("UNSHADED_BODY_LINE_COLOR");break;default:this.PART_SURFACE_LINE_POINT_MATERIAL.color=kn.getColor("LINE_POINT_COLOR"),this.CENTER_LINE_MATERIAL.color=kn.getColor("LINE_POINT_COLOR")}this.updateSmoothEdgeColor()}updateSmoothEdgeColor(){const e=this.viewer.getSmoothEdgesRenderStyle();if(e===W.YUG.HIDDEN){const e=[0,0,0,0];this.SMOOTH_EDGE_COLOR=e}else{switch(this.viewer.getRenderingMode()){case W.P1.HIDDEN_LINE_REMOVED:case W.P1.HIDDEN_LINE_VISIBLE:case W.P1.WIREFRAME:this.SMOOTH_EDGE_COLOR=(W.YUG.PHANTOM,kn.getColor("UNSHADED_BODY_LINE_COLOR"));break;default:this.SMOOTH_EDGE_COLOR=e===W.YUG.PHANTOM?kn.getColor("SMOOTH_EDGE_PHANTOM_COLOR"):kn.getColor("LINE_POINT_COLOR")}}}}const zn={nodePropertiesTypes:Bn};zn.nodePropertiesTypes=Bn;var Xn=i(76247);const qn=q.default.getManager().getColor("DEFAULT_MATERIAL_COLOR"),Zn=function(e){return e===(0,ve.Wf)()};class Yn{constructor(e,t,i){this.pointElement=e,this.highlight=t,this.isPreSelection=i}}class Kn extends m.T{constructor(e){super(),this.viewer=e,this.meshPoints={},(0,Ih.Yk)(e),this.addMultipleSelections((0,ve.Wf)()),this.addMultipleSelections((0,ve.vi)()),this.resetSelectionListHandlers()}resetSelectionListHandlers(){this.listenTo((0,ve.Wf)(),"add",this.onSelectionAdded),this.listenTo((0,ve.Wf)(),"remove",this.onSelectionRemoved),this.listenTo((0,ve.Wf)(),"reset",this.onSelectionReset),this.listenTo((0,ve.vi)(),"add",this.onSelectionAdded),this.listenTo((0,ve.vi)(),"remove",this.onSelectionRemoved),this.listenTo((0,ve.vi)(),"reset",this.onSelectionReset)}onSelectionAdded(e,t){this.addSelection(e,t)}onSelectionReset(e){this.deleteAllMeshPoints(Zn(e)),this.addMultipleSelections(e)}onSelectionRemoved(e,t){this.removeSelection(e,t)}addMultipleSelections(e){e.each((function(t){this.addSelection(t,e)}),this)}deleteAllMeshPoints(e){Object.entries(this.meshPoints).forEach((function([t,i]){i.isPreSelection===e&&this.deleteMeshPoint(t)}),this)}removeSelection(e,t){if(!e||!e.isMeshPoint()||!(e.id in this.meshPoints))return;Zn(t)===this.meshPoints[e.id].isPreSelection&&this.deleteMeshPoint(e.id)}deleteMeshPoint(e){if(e in this.meshPoints){const t=this.meshPoints[e].pointElement,i=this.meshPoints[e].highlight;this.viewer.getHighlightManager(Ls.L.BASE).freeHighlightForSelection(i.type,e),t.removeHighlight(i),t.remove(),delete this.meshPoints[e]}}addSelection(e,t){if(!e||!e.isMeshPoint())return;const i=Zn(t);if(e.id in this.meshPoints){if(i)return;this.deleteMeshPoint(e.id)}const s=this.viewer.getHighlightManager(Ls.L.BASE).createHighlightForSelection(function(e){return Zn(e)?yn.o2.PRE:yn.o2.ENTITY}(t),e.id),n=e.sourcePick?this.viewer.getOccurrenceDataManager().getOccurrenceTransform(e.sourcePick.getOccurrenceId()):null,r=function(e,t,i,s){if(!e)return null;let n=v.clone(e);s&&(n=pe.w$.multiplyVec3(s,n));const r=new au(n,sh.lL,qn,0,i);return r.addHighlight(t),r}(e.getMeshPointData().point,s,this.viewer,n);r&&(this.meshPoints[e.id]=new Yn(r,s,i))}destroy(){this.deleteAllMeshPoints(!0),this.deleteAllMeshPoints(!1),this.stopListening()}}var jn=i(53596);const Qn=q.default.getManager(),$n="image";class Jn extends Ri{constructor(e,t,i,s,n,r,a,o,h,c,l){super(o,a===Ls.L.PREVIEW?sh.Vv:void 0),this.sketchEntityId=e,this.bottomLeftCorner=i,this.bottomRightCorner=s,this.topLeftCorner=n,this.texture=r,this.usage=a,this.isOnFlat=h,this.flattenedBodyId=c,this.transform=l,this.ownsTexture=!1,this.material=null,this.isActive=!1,this.id="image",this.url=(0,jn.e)(t),this.listenTo(this,Pi.CLICK+$n,this.onClick),this.updateImage(t,i,s,n),this.occurrenceData.setCanIsolateChange(!0)}getSource(){return{documentId:(0,jn.a)(this.url,"/d/"),elementId:(0,jn.a)(this.url,"/e/"),documentVersionId:(0,jn.a)(this.url,"/v/")}}updateImage(e,t,i,s){const n=this.viewer.getGlContext();let r=(0,jn.e)(e);if(r||(r=this.url),this.url=r,this.bottomLeftCorner=t,this.bottomRightCorner=i,this.topLeftCorner=s,!r)return void this.removeMeshIncrement("image");if(!n)return;if(this.texture&&this.url!==r&&(this.texture.destroy(),this.texture=null,this.material&&(this.material.destroy(),this.material=null)),!this.texture){const e=new co(n);e.imageSource=r,e.minificationFilter=n.LINEAR,e.magnificationFilter=n.LINEAR,e.defersRendering=!0,this.texture=new uo(this.viewer,e),this.ownsTexture=!0}this.material||(this.material=Xi(this.texture));const a=new Qi({primitiveType:_i.MX.TRIANGLES,isPickable:this.isActive,isDepthTested:!1,isTwoSided:!0,includedInBlend:!0,material:this.material}),o=Ou(this.bottomLeftCorner,this.bottomRightCorner,this.topLeftCorner,void 0,[0,1],[1,0]).createTransformed(this.transform);Uu([1,1,1,this.isActive?Qn.getNumber("SKETCH_IMAGE_ACTIVE_OPACITY"):Qn.getNumber("SKETCH_IMAGE_INACTIVE_OPACITY")],o),this.updateMeshIncrement($n,$n,o,a),this.isHidden&&this.hideIncrements()}remove(){this.texture&&this.ownsTexture&&(this.texture.destroy(),this.texture=null,this.ownsTexture=!1),this.material&&(this.material.destroy(),this.material=null),super.remove()}getUsage(){return this.usage}onClick(){(0,ve.MO)()}getPickPriority(e){return Ef.z.SKETCH_FACE}cloneForPreview(){const e=new Jn(this.sketchEntityId,this.url,this.bottomLeftCorner,this.bottomRightCorner,this.topLeftCorner,this.texture,Ls.L.PREVIEW,this.viewer,this.isOnFlat,this.flattenedBodyId,this.transform);return this.isHidden&&e.hide(),this.isActive&&e.activate(),e}activate(){this.isActive=!0,this.updateImage(this.url,this.bottomLeftCorner,this.bottomRightCorner,this.topLeftCorner)}deactivate(){this.isActive=!1,this.updateImage(this.url,this.bottomLeftCorner,this.bottomRightCorner,this.topLeftCorner)}preventsSketching(){return!1}}var er=i(68662),tr=i(73972),ir=i(39108);var sr;!function(e){e[e.RIGHT_FRONT=0]="RIGHT_FRONT",e[e.RIGHT_BACK=1]="RIGHT_BACK",e[e.LEFT_BACK=2]="LEFT_BACK",e[e.LEFT_FRONT=3]="LEFT_FRONT"}(sr||(sr={}));const nr=function(e,t){const i=ge.create();return pe.w$.rotate(i,e*Math.PI/2+Math.PI/6,[0,0,1]),pe.w$.rotate(i,t?Math.PI/3:2*Math.PI/3,[1,0,0]),i},rr={XY:ge.create(),XYback:[1,0,0,0,0,-1,0,0,0,0,-1,0,0,0,0,1],YZ:[0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,1],YZback:[0,-1,0,0,0,0,1,0,-1,0,0,0,0,0,0,1],XZ:[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],XZback:[-1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1],Isometric:function(){const e=Math.sqrt(.5),t=Math.sqrt(1/3),i=Math.sqrt(1/6);return[e,e,0,0,-i,i,2*i,0,t,-t,t,0,0,0,0,1]}(),Dimetric:function(){const e=ge.create();return pe.w$.rotate(e,Math.PI/4,[0,0,1]),pe.w$.rotate(e,Math.PI/3,[1,0,0]),e}(),Trimetric:nr(sr.RIGHT_FRONT,!0),TrimetricTopRightBack:nr(sr.RIGHT_BACK,!0),TrimetricTopLeftBack:nr(sr.LEFT_BACK,!0),TrimetricTopLeftFront:nr(sr.LEFT_FRONT,!0),TrimetricBottomRightFront:nr(sr.RIGHT_FRONT,!1),TrimetricBottomRightBack:nr(sr.RIGHT_BACK,!1),TrimetricBottomLeftBack:nr(sr.LEFT_BACK,!1),TrimetricBottomLeftFront:nr(sr.LEFT_FRONT,!1)},ar=q.default.getManager();function or(e,t){return P.copy(P.create(),t.getViewport())}class hr{constructor(e){this.viewer=e,this.camera=null,this.axisRotateUpAxis=[0,0,1],this.axisRotateCanvasTag="axisRotateView",this.rotateOrPanCenter=[0,0,0],this.haltPostRotationAnimation=!1,this.lastRotationTime=0,this.rotationSpeedX=0,this.rotationSpeedY=0,this.lastButtonState={leftButton:!1,middleButton:!1,rightButton:!1},this.lastCtrlState=!1,this.lastShiftState=!1,this.lastAltState=!1,this.isSpaceballMoving=!1,this.dragZoomCanvasCoordinates=[0,0],(0,Ih.Yk)(e),this.animationController=e.getAnimationController(),this.manipulationMode=FD.k.NONE,this.forcedManipulationMode=FD.k.NONE}getViewer(){return this.viewer}isPerspective(){return!1}isOrthographic(){return!1}getCamera(){return this.camera}getRotateOrPanCenter(){return this.rotateOrPanCenter}getAxisRotateUpAxis(){return this.axisRotateUpAxis}resetInputState(){this.lastButtonState={leftButton:!1,middleButton:!1,rightButton:!1},this.lastCtrlState=!1,this.lastShiftState=!1,this.lastAltState=!1}updateInputState(e,t){let i=!1;return Object.entries(t).forEach((function([e,t]){this.lastButtonState[e]!==t&&(this.lastButtonState[e]=t,i=!0)}),this),uE().usesControlKey()&&e.ctrlKey!==this.lastCtrlState&&(this.lastCtrlState=e.ctrlKey,i=!0),uE().usesShiftKey()&&e.shiftKey!==this.lastShiftState&&(this.lastShiftState=e.shiftKey,i=!0),uE().usesAltKey()&&e.altKey!==this.lastAltState&&(this.lastAltState=e.altKey,i=!0),i}getMouseKeyValues(e,t){const i=[];t.rightButton&&i.push(er.tc.RIGHT),t.middleButton&&i.push(er.tc.MIDDLE),t.leftButton&&i.push(er.tc.LEFT);const s=[];return uE().usesControlKey()&&e.ctrlKey&&s.push(Os.R8.CONTROL),uE().usesShiftKey()&&e.shiftKey&&s.push(Os.R8.SHIFT),uE().usesAltKey()&&e.altKey&&s.push(Os.R8.ALT),{mouseButtonSettings:i,modifierKeys:s}}getManipulationMode(e,t){if(this.forcedManipulationMode!==FD.k.NONE&&t.leftButton)return this.forcedManipulationMode;const i=this.getMouseKeyValues(e,t),s=i.mouseButtonSettings,n=i.modifierKeys,r=uE().getManipulationMode(s,n);return r!==FD.k.ZOOM&&r!==FD.k.AXIS_ROTATE&&r!==FD.k.PAN&&r!==FD.k.ROTATE?FD.k.NONE:r}forceManipulationMode(e){this.forcedManipulationMode=e}getClosestMode(e,t,i){const s=this.getMouseKeyValues(e,t),n=s.mouseButtonSettings,r=s.modifierKeys;return uE().getClosestMode(n,r,i)}updateManipulationMode(e,t){if(!this.updateInputState(e,t))return;const i=this.manipulationMode,s=this.forcedManipulationMode!==FD.k.NONE?this.forcedManipulationMode:this.getManipulationMode(e,t);if(s!==FD.k.NONE)this.manipulationMode=s;else{const i=this.getClosestMode(e,t,this.manipulationMode);i!==FD.k.NONE?this.manipulationMode=i:this.manipulationMode=this.getClosestMode(e,t)}i!==this.manipulationMode&&(!(this.isRotating()||this.isPanning()||this.isAxisRotating())||this.isRotating()&&i===FD.k.AXIS_ROTATE||this.isAxisRotating()&&i===FD.k.ROTATE||this.updateRotationPanCenter(e),this.isRotating()&&(this.lastRotationTime=(0,Js.Wj)(),this.rotationSpeedX=0,this.rotationSpeedY=0))}setRotationPivotPosition(e){this.rotateOrPanCenter=e}setIsSpaceballMoving(e){this.isSpaceballMoving=e}isPanning(){return this.manipulationMode===FD.k.PAN}isRotating(){return this.manipulationMode===FD.k.ROTATE}isAxisRotating(){return this.manipulationMode===FD.k.AXIS_ROTATE}isZooming(){return this.manipulationMode===FD.k.ZOOM}isBeingManipulated(){return this.manipulationMode!==FD.k.NONE}isBeingForceManipulated(){return this.isBeingManipulated()&&this.manipulationMode===this.forcedManipulationMode}getRotateCenterUnderPoint(e,t){const i=ar.getNumber("ROTATION_CENTER_SEARCH_RADIUS"),s=2*i+1,n=2*i+1,r=e-i,a=t-i,o=this.viewer.findDepthsInRect(r,a,s,n,!1);let h=null,c=1/0;const l=$.create(),u=[e,t];for(let e=0;e<o.length;++e)if(o[e][2]!==Js.BG){const t=o[e],i=$.squaredLength(pe.gv.subtract(t,u,l));i<c&&(h=t,c=i)}return h?this.camera.canvasToWorld(h):null}getRotateCenterBasedOnWindowDepths(e){const t=this.viewer.retrieveDepthSampling(e),i=[0,0,0],s=t.length;for(let e=0;e<s;++e)for(let s=0;s<3;++s)i[s]+=t[e][s];return s>0&&s>=ar.getNumber("MIN_SAMPLES_TO_USE_FOR_DEPTH_AVERAGED_ROTATION_CENTER")?this.camera.canvasToWorld([i[0]/s,i[1]/s,i[2]/s]):null}getRotateCenterBasedOnBounds(){const e=this.viewer.getModelViewManagers().getManager().getModelBounds();return e&&e.isInitialized()&&!e.isInfinite()?this.camera.doBoundsFitInViewport(e,this.camera.getViewport(),ar.getNumber("MODEL_SIZE_TO_VIEWPORT_ROTATE_BOUNDS_FACTOR"))?e.center():null:v.create()}getRotateCenterBasedOnCanvasLocationAndBoundsDepth(e,t){const i=this.viewer.getModelViewManagers().getManager().getModelBounds();if(!i||!i.isInitialized()||i.isInfinite())return v.create();const s=this.camera.getRay(e,t),n=.01*i.diameter();return pe.S4.add(s.point,pe.S4.scale(s.direction,Math.max(v.dot(s.direction,pe.S4.subtract(i.center(),s.point,v.create())),n),v.create()))}getRotateCenterForCanvasLocation(e,t){let i=this.getRotateCenterUnderPoint(e,t);return i||(i=this.getRotateCenterBasedOnWindowDepths({includePlanes:!1}),i||(i=this.getRotateCenterBasedOnWindowDepths({includePlanes:!0}),i||(i=this.getRotateCenterBasedOnBounds(),i||this.getRotateCenterBasedOnCanvasLocationAndBoundsDepth(e,t))))}getRotateCenterForSpaceball(){let e=this.getRotateCenterBasedOnBounds();if(e)return e;const t=[this.camera.getViewportWidth()/2,this.camera.getViewportHeight()/2];return e=this.getRotateCenterUnderPoint(t[0],t[1]),e||(e=this.getRotateCenterBasedOnWindowDepths({includePlanes:!1}),e||(e=this.getRotateCenterBasedOnWindowDepths({includePlanes:!0}),e||this.getRotateCenterBasedOnCanvasLocationAndBoundsDepth(t[0],t[1])))}updateRotationPanCenterForSpaceball(){this.setRotationPivotPosition(this.getRotateCenterForSpaceball())}updateRotationPanCenter(e){this.rotateOrPanCenter=[0,0,0];const t=this.viewer.getCanvasCoordinateFromEvent(e),i=t[0],s=t[1];(this.isRotating()||this.isAxisRotating()||this.isPanning()&&this.isPerspective())&&this.setRotationPivotPosition(this.getRotateCenterForCanvasLocation(i,s))}onDragStart(e,t,i){const s=this.isZooming();this.updateManipulationMode(t,i);if(!s&&this.isZooming()){const t=this.viewer.getCanvasCoordinateFromEvent(e);this.dragZoomCanvasCoordinates[0]=t[0],this.dragZoomCanvasCoordinates[1]=t[1]}return this.haltPostRotationAnimation=this.isBeingManipulated(),this.isBeingManipulated()}zoomOnCanvasPoint(e,t,i){const s=this.camera.viewNormalPlaneAtPoint(this.camera.focalPoint()),n=(0,Li.fE)(this.camera.getRay(e,0),s);let r,a=(0,Li.fE)(this.camera.getRay(e,t),s);n&&a?(r=pe.S4.subtract(a,this.camera.getEye(),v.create()),pe.S4.normalize(r)):(i=0,r=this.camera.getEye());const o=this.viewer.getSceneBounds().getCorners();i<0&&q.default.getManager().getNumber("USE_CENTRAL_ZOOM_OUT")&&(a=(0,Li.fE)(this.camera.getRay(this.camera.getViewportWidth()/2,this.camera.getViewportHeight()/2),s)),a?this.zoomPoint(a,{direction:r},i,o):It.log.debug("No point intersection found for zoomOnCanvasPoint")}zoomOnMouseWheelScroll(e){e.preventDefault();const t=e.originalEvent;let i=0,s=.5;if("mousewheel"===e.type){if(0===t.wheelDelta||t.wheelDeltaX&&Math.abs(t.wheelDeltaX)>Math.abs(t.wheelDeltaY))return!1;s/=120,(0,Et.isPlatformWindows)()&&(s*=3),i=s*t.wheelDelta}else{if(0===t.detail||1===t.axis)return!1;i=-s*t.detail}const n=this.viewer.getCanvasCoordinateFromEvent(t),r=n[0],a=n[1];return kM().isScrollZoomDefault()||(i=-i),this.zoomOnCanvasPoint(r,a,i),!0}zoomOnDrag(e){if(Math.abs(e)<bi.W.ZERO_LENGTH)return;const t=this.dragZoomCanvasCoordinates[0],i=this.dragZoomCanvasCoordinates[1];e=-1*e/q.default.getManager().getNumber("DRAG_ZOOM_FACTOR"),this.zoomOnCanvasPoint(t,i,e)}onDrag(e,t,i,s,n,r){this.forcedManipulationMode===FD.k.NONE&&this.updateManipulationMode(e,t);const a=this.viewer.$el,o=this.camera.viewNormalPlaneAtPoint(this.rotateOrPanCenter),h=function(){const e=(0,Li.fE)(this.camera.getRay(n,r),o),t=(0,Li.fE)(this.camera.getRay(n+i,r+s),o);return e&&t?(pe.S4.subtract(t,e),t):null};if(this.isPanning()){const e=h.call(this);e&&this.pan(e)}else if(this.isRotating()){const e=[+a.attr("width"),+a.attr("height")],t=2*Math.PI*ar.getNumber("ROTATION_CYCLES_PER_SCREEN")/pe.gv.length(e);this.rotateAbout(-i*t,this.camera.getUp(),this.rotateOrPanCenter),this.rotateAbout(-s*t,this.camera.getRight(),this.rotateOrPanCenter),this.lastRotationTime=(0,Js.Wj)(),this.rotationSpeedX=.5*(this.rotationSpeedX+i),this.rotationSpeedY=.5*(this.rotationSpeedY+s),this.tagCanvasWithView("unknown")}else if(this.isAxisRotating()){const e=a.attr("data-view-shown")===this.axisRotateCanvasTag;if(!this.animationController.isCameraAnimating())if(e){const e=[+a.attr("width"),+a.attr("height")],t=2*Math.PI*ar.getNumber("ROTATION_CYCLES_PER_SCREEN")/pe.gv.length(e),n=(0,Sr.sign)(this.camera.getUp()[2])||1;this.rotateAbout(-i*n*t,this.axisRotateUpAxis,this.rotateOrPanCenter),this.rotateAbout(-s*t,this.camera.getRight(),this.rotateOrPanCenter)}else{const e=Math.asin(v.dot(this.camera.getRight(),this.axisRotateUpAxis)),t=pe.S4.cross(this.camera.getRight(),this.axisRotateUpAxis,v.create()),i=Math.abs(e);if(i<ar.getNumber("AXIS_ROTATION_SNAP_TOLERANCE"))this.rotateAbout(-e,t,this.rotateOrPanCenter),this.tagCanvasWithView(this.axisRotateCanvasTag);else{const s=this.camera.clone();s.rotateAbout(-e,t,this.rotateOrPanCenter);const n=ar.getNumber(i>Math.PI/4?"CAMERA_SHORT_ANIMATION_TIME_MS":"CAMERA_SNAP_ANIMATION_TIME_MS");this.animateToCustomView(s,n,this.axisRotateCanvasTag)}}}else this.isZooming()&&this.zoomOnDrag(s);this.updateCameraNearFar(),this.afterViewChange()}onDragStop(e){this.isRotating()&&this.performStopRotationAnimation(),this.resetInputState(),this.manipulationMode=FD.k.NONE}getPointerPosition(){return this.viewer.getCanvasCoordinateFromEvent(this.viewer.getLastMouseMovedEvent())}performStopRotationAnimation(){if(this.viewer.isInteractiveFramerateBelowThreshold())return;this.haltPostRotationAnimation=!1;const e=pe.gv.length([this.camera.getViewportWidth(),this.camera.getViewportHeight()]),t=2*Math.PI*ar.getNumber("ROTATION_CYCLES_PER_SCREEN")/e,i=ar.getNumber("ROTATION_INERTIA");let s=1;let n=(0,Js.Wj)();(0,Js.Wj)()-this.lastRotationTime<50&&this.animationController.startCameraAnimation((e=>{const r=(0,Js.Wj)();s*=Math.pow(i,(r-n)/16.666666666666668),n=r;const a=this.rotationSpeedX*s,o=this.rotationSpeedY*s;return!this.haltPostRotationAnimation&&(Math.abs(a)>1||Math.abs(o)>1)?(this.rotateAbout(-a*t,this.camera.getUp(),this.rotateOrPanCenter),this.rotateAbout(-o*t,this.camera.getRight(),this.rotateOrPanCenter),ir.Z.ONGOING):ir.Z.COMPLETE}))}rotateAbout(e,t,i){this.camera.rotateAbout(e,t,i)}pan(e){this.camera.pan(e)}canZoom(e,t){if(t){const i=new Li.kB;for(let e=0;e<t.length;e++)i.addPoint(t[e]);if(i.diameter()>0){const t=this.camera.getPixelSizeAtWorldPoint(i.center()),s=q.default.getManager().getNumber("MIN_MODEL_PIXEL_SIZE");return!(e>=1&&i.diameter()/t<=e*s||e<=1&&1/t>=e*Math.pow(2,24))}}return!1}adjustCameraToValidZoom(e){if(!e)return!1;const t=this.viewer.getFitBounds();if(!this.canBoundsBeFit(t))return!1;const i=q.default.getManager().getNumber("MIN_MODEL_PIXEL_SIZE"),s=e.getPixelSizeAtWorldPoint(t.center());let n=1;return t.diameter()/s<=i?n=t.diameter()/s/i:1/s>=Math.pow(2,24)&&(n=1/(Math.pow(2,24)*s)),1!==n&&(It.log.debug("Given camera would result in invalid scene zoom. Applying zoom: "+n),e.zoom(n)),!0}zoom(e){}setStandardView(e){const t=rr[e];t&&(this.camera.setFrame(t),this.tagCanvasWithView(e))}animateToCustomView(e,t,i){this.animateTo(e,t,i)}animateViewNormalToPlaneMatrix(e,t,i){if(!e)return;let s;const n=or(this.viewer,this.camera);if(this.camera.canBoundsFitInViewport(t,n)){const i=this.camera.viewportToCanvas([n[0]+n[2]/2-this.camera.getViewportLeft(),n[1]+n[3]/2-this.camera.getViewportBottom(),0]);s=this.camera.getCameraRotatedToViewAndTranslated(e,t.center(),i)}else{const t=i?i[0]:this.camera.getViewportWidth()/2,n=i?i[1]:this.camera.getViewportHeight()/2,r=this.getRotateCenterForCanvasLocation(t,n);s=this.camera.getCameraRotatedToView(e,r)}this.animateToCustomView(s,ar.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"))}animateTo(e,t,i){if(this.animationController.isCameraAnimating())return;if(this.tagCanvasWithView(),this.viewer.isInteractiveFramerateBelowThreshold())return this.camera.copyFrom(e),this.updateCameraNearFar(),this.afterViewChange(),this.viewer.getAnimationController().incrementAnimationSequence(),this.tagCanvasWithView(i),void this.viewer.getBodyManager().onUserIsAdjustingCamera();const s=(0,Js.Wj)(),n=new tr.f(this.camera,e);this.animationController.startCameraAnimation((e=>{const r=(0,Js.Wj)();let a;const o=r-s;a=o>=t?1:o/t,a=a*a*a*(a*(6*a-15)+10);const h=n.interpolate(a);return(0,Li.nP)(this.camera.getViewport(),h.viewport)?(this.camera.copyFrom(h),this.updateCameraNearFar(),r-s<t?ir.Z.ONGOING:(this.tagCanvasWithView(i),this.viewer.getBodyManager().onUserIsAdjustingCamera(),this.viewer.getEventDispatcher().trigger(VM.h0,null),ir.Z.COMPLETE)):(It.log.trace("Camera viewport changed mid-animation, terminating animation early"),ir.Z.COMPLETE)}))}tagCanvasWithView(e){e?this.viewer.$el.attr("data-view-shown",e):this.viewer.$el.attr("data-view-shown","unknown")}getViewportCenter(){const e=or(this.viewer,this.camera);return $.fromValues(e[0]+e[2]/2,e[1]+e[3]/2)}canBoundsBeFit(e){const t=e.isInitialized()&&!e.isInfinite();return t||It.log.warn("An attempt was made to fit a camera with invalid bounds"),t}animateToFrameWithZoomFit(e,t,i,s,n,r){if(!this.canBoundsBeFit(t))return;const a=this.getZoomFitTargetCamera(e,t,n,r);this.adjustCameraToValidZoom(a)&&this.animateTo(a,i,s)}getZoomFitTargetCamera(e,t,i,s){const n=t.getCorners();let r=null;i||(r=or(this.viewer,this.camera));const a=this.camera.clone();a.setFrame(e);let o=s;return o||(o=ar.getNumber("CAMERA_ZOOM_TO_FIT_PADDING")),a.zoomToFit(n,o,r),a.updateNearFar(),a}animateToStandardView(e,t){if(!this.canBoundsBeFit(t))return;const i=rr[e];i&&this.animateToFrameWithZoomFit(i,t,ar.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"),e)}animateToStandardViewIgnoringUIPanels(e,t,i){if(!this.canBoundsBeFit(t))return;const s=rr[e];s&&this.animateToFrameWithZoomFit(s,t,ar.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"),e,!0,i)}animateZoomToFit(e){if(!this.canBoundsBeFit(e))return;const t=e.getCorners(),i=or(this.viewer,this.camera),s=this.camera.clone();s.zoomToFit(t,ar.getNumber("CAMERA_ZOOM_TO_FIT_PADDING"),i),this.adjustCameraToValidZoom(s)&&this.animateTo(s,ar.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"))}zoomFitCamera(e,t,i){if(!this.canBoundsBeFit(e))return;const s=e.getCorners(),n=this.camera.clone();n.zoomToFit(s,ar.getNumber("CAMERA_ZOOM_TO_FIT_PADDING"),t),n.updateNearFar(s),this.adjustCameraToValidZoom(n)&&(this.camera=n,this.afterViewChange(i))}zoomFit(e,t){this.animationController.haltCameraAnimation(),this.zoomFitCamera(e,or(this.viewer,this.camera),t)}zoomFitWithoutPanels(e){this.zoomFitCamera(e)}animateRotation(e,t,i,s){let n=0;const r=(0,Js.Wj)();if(s||(s=this.camera.focalPoint()),this.tagCanvasWithView(),this.viewer.isInteractiveFramerateBelowThreshold())return this.rotateAbout(t,e,s),this.updateCameraNearFar(),void this.afterViewChange();this.animationController.startAnimation((a=>{if(Math.abs(n)<Math.abs(t)){if(!this.viewer.isReadyForDrawing())return;const a=(0,Js.Wj)(),o=Math.min(a-r,i)/i*t,h=o-n;return this.rotateAbout(h,e,s),this.updateCameraNearFar(),n=o,a-r<=i?ir.Z.ONGOING:(this.viewer.getEventDispatcher().trigger(VM.h0,null),ir.Z.COMPLETE)}}))}rotateInDirection(e,t){const i=this.camera.up,s=this.camera.direction,n=pe.S4.cross(s,i,v.create());switch(e){case"left":this.animateRotation(i,t,ar.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"right":this.animateRotation(i,-t,ar.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"up":this.animateRotation(n,t,ar.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"down":this.animateRotation(n,-t,ar.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"clockwise":this.animateRotation(s,-t,ar.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"counterclockwise":this.animateRotation(s,t,ar.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"180":this.animateRotation(i,Math.PI,ar.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"))}}animatePan(e,t){const i=this.camera.clone(),s=i.getPixelSizeAtWorldPoint(i.getSceneBounds().center()),n=pe.S4.add(pe.S4.scale(i.getRight(),s*-e,v.create()),pe.S4.scale(i.getUp(),s*-t,v.create()));i.pan(n),this.animateTo(i,ar.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"))}panRight(){this.animatePan(ar.getNumber("DEFAULT_PAN_AMOUNT_PX"),0)}panLeft(){this.animatePan(-ar.getNumber("DEFAULT_PAN_AMOUNT_PX"),0)}panUp(){this.animatePan(0,ar.getNumber("DEFAULT_PAN_AMOUNT_PX"))}panDown(){this.animatePan(0,-ar.getNumber("DEFAULT_PAN_AMOUNT_PX"))}animateZoom(e){const t=this.camera.clone();t.zoom(e),this.adjustCameraToValidZoom(t)&&this.animateTo(t,ar.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"))}zoomIn(){this.animateZoom(1/ar.getNumber("DEFAULT_ZOOM_FACTOR"))}zoomOut(){this.animateZoom(ar.getNumber("DEFAULT_ZOOM_FACTOR"))}zoomPoint(e,t,i,s){}updateCameraNearFar(){const e=this.viewer.getSceneGraphs().getMainSceneGraph().getBounds();e.isFinite()&&this.camera.updateNearFar(e.getCorners())}getMatchingOrthographicController(){return null}getMatchingPerspectiveController(){return null}afterViewChange(e){e||this.viewer.getEventDispatcher().trigger(VM.h0,null),this.viewer.requestDraw()}}class cr extends hr{constructor(e,t){super(e),this.camera=new vh(t)}isPerspective(){return!0}clone(){const e=new cr(this.viewer);return e.camera=this.camera.clone(),e.forcedManipulationMode=this.forcedManipulationMode,e}zoom(e){const t=this.camera,i=Math.max(t.distanceToCenter(),t.getMinDistance())*e/6;t.dolly(i),t.updateNearFar()}zoomPoint(e,t,i,s){const n=Math.pow(2,-i/6);if(this.canZoom(n,s)){const e=this.camera,n=Math.max(e.distanceToCenter(),e.getMinDistance())*i/6;e.dollyAlong(n,t.direction),e.updateNearFar(s)}}getMatchingOrthographicController(){const e=new lr(this.viewer);return e.camera=this.camera.getOrthographicCamera(),e.forcedManipulationMode=this.forcedManipulationMode,e}}class lr extends hr{constructor(e,t){super(e),this.camera=new Ph(t)}isOrthographic(){return!0}zoom(e){const t=Math.pow(2,-e/6);this.camera.zoom(t)}zoomPoint(e,t,i,s){const n=Math.pow(2,-i/6);this.canZoom(n,s)&&this.camera.zoomPoint(e,t,n,s)}clone(){const e=new lr(this.viewer);return e.camera=this.camera.clone(),e.forcedManipulationMode=this.forcedManipulationMode,e}getMatchingPerspectiveController(){const e=new cr(this.viewer);return e.camera=this.camera.getPerspectiveCamera(),e.forcedManipulationMode=this.forcedManipulationMode,e}}var ur,dr=i(44956);!function(e){e.RIGHT="Right",e.LEFT="Left",e.TOP="Top",e.BOTTOM="Bottom",e.NEAR="Near",e.FAR="Far"}(ur||(ur={}));class gr{constructor(e,t,i,s){const n=Math.sqrt(e*e+t*t+i*i);this.normal=[e/n,t/n,i/n],this.d=s/n}}class pr{constructor(e,t){this.clippingPlanes={},this.clippingMatrix=ge.create(),e&&t&&this.updateClippingPlanes(e,t)}updateClippingPlanes(e,t){e&&t&&(this.clippingMatrix[0]=e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],this.clippingMatrix[1]=e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],this.clippingMatrix[2]=e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],this.clippingMatrix[3]=e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],this.clippingMatrix[4]=e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],this.clippingMatrix[5]=e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],this.clippingMatrix[6]=e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],this.clippingMatrix[7]=e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],this.clippingMatrix[8]=e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],this.clippingMatrix[9]=e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],this.clippingMatrix[10]=e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],this.clippingMatrix[11]=e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],this.clippingMatrix[12]=e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],this.clippingMatrix[13]=e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],this.clippingMatrix[14]=e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],this.clippingMatrix[15]=e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15],this.updateClippingPlane(ur.BOTTOM,this.clippingMatrix[3]+this.clippingMatrix[1],this.clippingMatrix[7]+this.clippingMatrix[5],this.clippingMatrix[11]+this.clippingMatrix[9],this.clippingMatrix[15]+this.clippingMatrix[13]),this.updateClippingPlane(ur.TOP,this.clippingMatrix[3]-this.clippingMatrix[1],this.clippingMatrix[7]-this.clippingMatrix[5],this.clippingMatrix[11]-this.clippingMatrix[9],this.clippingMatrix[15]-this.clippingMatrix[13]),this.updateClippingPlane(ur.LEFT,this.clippingMatrix[3]+this.clippingMatrix[0],this.clippingMatrix[7]+this.clippingMatrix[4],this.clippingMatrix[11]+this.clippingMatrix[8],this.clippingMatrix[15]+this.clippingMatrix[12]),this.updateClippingPlane(ur.RIGHT,this.clippingMatrix[3]-this.clippingMatrix[0],this.clippingMatrix[7]-this.clippingMatrix[4],this.clippingMatrix[11]-this.clippingMatrix[8],this.clippingMatrix[15]-this.clippingMatrix[12]))}updateClippingPlane(e,t,i,s,n){if(this.clippingPlanes[e]){const r=Math.sqrt(t*t+i*i+s*s),a=[t/r,i/r,s/r],o=n/r;this.clippingPlanes[e].normal=a,this.clippingPlanes[e].d=o}else this.clippingPlanes[e]=new gr(t,i,s,n)}getSphereFrustumIntersection(e,t){let i=this.clippingPlanes[ur.BOTTOM],s=i.normal[0]*e[0]+i.normal[1]*e[1]+i.normal[2]*e[2]+i.d;return s<-t?dr.I.OUTSIDE:(i=this.clippingPlanes[ur.TOP],s=i.normal[0]*e[0]+i.normal[1]*e[1]+i.normal[2]*e[2]+i.d,s<-t?dr.I.OUTSIDE:(i=this.clippingPlanes[ur.RIGHT],s=i.normal[0]*e[0]+i.normal[1]*e[1]+i.normal[2]*e[2]+i.d,s<-t?dr.I.OUTSIDE:(i=this.clippingPlanes[ur.LEFT],s=i.normal[0]*e[0]+i.normal[1]*e[1]+i.normal[2]*e[2]+i.d,s<-t?dr.I.OUTSIDE:dr.I.INSIDE)))}}var mr=i(13762),fr=i(40219),Ir=i(44111),Er=i(82695),Sr=i(15563),Tr=i(91275);const Mr=q.default.getManager(),Cr="selection",Dr="lines.",vr="outlines.",Pr="lines",yr="manipulator-displacement-graphics",Ar=new Qi({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,priority:Yi.DEFAULT,primitiveType:_i.MX.LINES}),Or=new Qi(Object.assign({},Ar,{priority:Yi.HIGHEST})),Rr=new Qi({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,priority:Yi.LOWER,primitiveType:_i.MX.LINES}),wr=new Qi(Object.assign({},Rr,{priority:Yi.HIGHER})),_r=new Qi({isVisible:!1,isPickable:!0,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,primitiveType:_i.MX.TRIANGLES});class Nr extends Ri{constructor(e,t){super(e),this.isDragging=!1,this.isHovering=!1,this.isEnabled=!0,this.meshIncrement=null,this.pickIncrement=null,this.updateIncrement=!1,this.doSnappingBehavior=!0,this.offsetRoundDecimals=8,this.hasEditView=!1,this.isLocked=!1,t||(t={displayEditView:!1}),this.style=W.xKD.DEFAULT,this.lineColor=new Uint8Array([0,0,0,0]),this.outlineColor=new Uint8Array([0,0,0,0]),this.triadOwnerType=Tr.Ak.UNKNOWN,this.displayEditView=t.displayEditView,this.listenTo(this,Pi.MOUSE_ENTER+Cr,this.onMouseEnter),this.listenTo(this,Pi.MOUSE_LEAVE+Cr,this.onMouseLeave),this.listenTo(this,Pi.DRAG_START+Cr,this.onDragStart),this.listenTo(this,Pi.DRAG+Cr,this.onDrag),this.listenTo(this,Pi.DRAG_STOP+Cr,this.onDragStop),this.listenTo(this,Pi.CLICK+Cr,this.onClick),this.listenTo(this,Pi.DOUBLE_CLICK+Cr,this.onDoubleClick),this.listenTo(this,Pi.XR_DRAG_START+Cr,this.onXrDragStart),this.listenTo(this,Pi.XR_DRAG+Cr,this.onXrDrag),this.listenTo(this,Pi.XR_DRAG_STOP+Cr,this.onXrDragStop)}onAppearanceConstantsUpdated(){this.updateIncrement=!0}isManipulator(){return!0}setIsLocked(e){this.isLocked=e}getIsLocked(){return this.isLocked}onDevicePixelRatioChanged(e){this.meshIncrement=null,this.updateGraphics(e)}setStyle(e){this.style=e||W.xKD.DEFAULT}setFadeParameters(e,t){this.fadeAngleStart=(0,Li.Yr)((0,Li.uZ)(e,0,90)),this.fadeAngleEnd=(0,Li.Yr)((0,Li.uZ)(t,0,90))}setIsEnabled(e){this.isEnabled=e,(0,Js.vm)()}getIsEnabled(){return this.isEnabled}setTriadOwnerType(e){this.triadOwnerType=e}getTriadOwnerType(){return this.triadOwnerType}onViewWillDraw(e,t){this.isHidden||this.updateGraphics(e)}onMouseEnter(e,t){this.isEnabled&&(this.isHovering=!0,this.updateIncrement=!0,this.trigger(Tr.Wb.MANIPULATOR_ENTER,this),(0,Js.vm)())}onMouseLeave(e,t){this.isEnabled&&(this.isHovering=!1,this.updateIncrement=!0,this.trigger(Tr.Wb.MANIPULATOR_LEAVE,this),(0,Js.vm)())}onDragStart(e,t,i){this.isEnabled&&(this.isDragging=!0,this.updateIncrement=!0,i.requestDrag=!0,this.trigger(Tr.Wb.MANIPULATION_STARTED,this),(0,Js.vm)())}onDragStop(e,t){this.isDragging=!1,this.updateIncrement=!0,this.trigger(Tr.Wb.MANIPULATION_ENDED),(0,Js.vm)()}onDrag(e,t){}onXrDragStart(e,t,i){this.isEnabled&&(this.isDragging=!0,this.updateIncrement=!0,i.requestDrag=!0,this.trigger(Tr.Wb.MANIPULATION_STARTED,this),this.viewer.requestDraw())}onXrDragStop(e,t){this.isDragging=!1,this.updateIncrement=!0,this.trigger(Tr.Wb.MANIPULATION_ENDED),(0,Js.vm)()}onXrDrag(e,t){}onClick(e,t){this.isEnabled&&this.trigger(Tr.Wb.CLICKED,this)}onDoubleClick(e,t){this.isEnabled&&this.trigger(Tr.Wb.DOUBLE_CLICKED,this,e)}getOutlineColor(){return this.isEnabled?this.isDragging?Mr.getColor("MANIPULATOR_OUTLINE_DRAG_COLOR"):this.isHovering?Mr.getColor("MANIPULATOR_OUTLINE_HOVER_COLOR"):Mr.getColor("MANIPULATOR_OUTLINE_COLOR"):Mr.getColor("MANIPULATOR_OUTLINE_DISABLED_COLOR")}getLineColor(){return this.isEnabled?this.isDragging?Mr.getColor("MANIPULATOR_LINE_DRAG_COLOR"):this.isHovering?Mr.getColor("MANIPULATOR_LINE_HOVER_COLOR"):Mr.getColor("MANIPULATOR_LINE_COLOR"):Mr.getColor("MANIPULATOR_LINE_DISABLED_COLOR")}isHighlighted(){return this.isDragging||this.isHovering}updateLines(e,t,i){const s=t.clone();i=void 0!==i?i:1,this.isEnabled||(i*=Mr.getNumber("MANIPULATOR_DISABLED_OPACITY"));const n=this.getLineColor();n[3]=(0,Li.uZ)(n[3]*i,1/255,1),Uu(n,t),Hu(Mr.getNumber("MANIPULATOR_LINE_WIDTH"),t),this.updateMeshIncrement(Dr+e,yi,t,this.isHighlighted()?Or:Ar);const r=this.getOutlineColor();r[3]=(0,Li.uZ)(r[3]*i,1/255,1),Uu(r,s),Hu(Mr.getNumber("MANIPULATOR_LINE_WIDTH")+2*Mr.getNumber("MANIPULATOR_OUTLINE_WIDTH"),s),this.updateMeshIncrement(vr+e,yi,s,this.isHighlighted()?wr:Rr)}removeDisplacementMeshIncrements(){this.removeMeshIncrement(yr)}updatePickArea(e){this.viewer.performingBoxSelection()||(Uu([0,0,0,1],e),this.updateMeshIncrement("pickarea",Cr,e,_r))}updateGeometry(){}updateColor(e){if(e=void 0!==e?e:1,this.isEnabled||(e*=Mr.getNumber("MANIPULATOR_DISABLED_OPACITY")),e<=0?this.isTransparent||this.makeTransparent():this.isTransparent&&this.makeOpaque(),this.isHidden||this.isTransparent)return;let t=this.getLineColor();t[3]=(0,Li.uZ)(t[3]*e,1/255,1),t=[255*t[0],255*t[1],255*t[2],255*t[3]],this.lineColor[0]===t[0]&&this.lineColor[1]===t[1]&&this.lineColor[2]===t[2]&&this.lineColor[3]===t[3]||(this.lineColor.set(t),this.updateIncrementAttribute(Dr+Pr,Jd.COLOR,this.lineColor));let i=this.getOutlineColor();i[3]=(0,Li.uZ)(i[3]*e,1/255,1),i=[255*i[0],255*i[1],255*i[2],255*i[3]],this.outlineColor[0]===i[0]&&this.outlineColor[1]===i[1]&&this.outlineColor[2]===i[2]&&this.outlineColor[3]===i[3]||(this.outlineColor.set(i),this.updateIncrementAttribute(vr+Pr,Jd.COLOR,this.outlineColor))}updateGraphics(e){let t=this.updateIncrement;this.meshIncrement||(this.updateGeometry(),t=!0),this.meshIncrement&&t&&(this.updateLines(Pr,this.meshIncrement),this.updatePickArea(this.pickIncrement))}isBeingManipulated(){return this.isDragging}getLinearSnapValue(e,t,i){const s=e.camera.getPixelSizeAtWorldPoint(i),n=Mr.getNumber("MANIPULATOR_LINEAR_SNAP_RESOLUTION_PX")*s,r=(0,Ir.vx)().getLengthUnits(),a=(0,Er.KZ)(n,r);if(a<=0)return t;const o=Math.round(Math.log(a)/Math.log(10));let h=Math.pow(10,o-1);h/=Mr.getNumber("MANIPULATOR_LINEAR_INCREMENT_DIVISOR");const c=(0,Er.KZ)(t,r)/h,l=Math.round(c),u=l-c,d=Mr.getNumber("MANIPULATOR_LINEAR_SNAP_DEVIATION");if(Math.abs(u)<=d){const e=h*l;t=(0,Er.Fv)(e,r)}return t}onEditChange(e){}onEditCreate(){this.hasEditView=!0}onEditClose(){this.hasEditView=!1}triggerEditValueChange(e){(0,fr.m)().trigger(mr.C.SET_EDIT_VALUE,e)}triggerEditValueChangeNoUnit(e){(0,fr.m)().trigger(mr.C.SET_EDIT_VALUE_NO_UNIT,e)}triggerEditOriginChange(e,t){(0,fr.m)().trigger(mr.C.SET_EDIT_VIEW_ORIGIN,e,t)}remove(){this.hasEditView&&((0,fr.m)().trigger(mr.C.CLOSE_MANIPULATOR_EDIT_VIEW),ih().setActiveManipulator(null)),super.remove()}removeEditViewAndHighlights(){this.isHovering=!1,(0,fr.m)().trigger(mr.C.CLOSE_MANIPULATOR_EDIT_VIEW),ih().setActiveManipulator(null)}dragByIncrementValue(e){}}class br extends Nr{constructor(e,t){super(e,t),this.offset=0,this.initialRay=null,this.editOffset=0,this.visualGapPx=0,this.flipDirectionWhenNegative=!1,this.dragOffset=0,this.minOffset=-1/0,this.maxOffset=1/0,this.displacementGraphics=null,this.ray=new Li.zH([0,0,0],[0,0,1]),this.shaftLengthPx=Mr.getNumber("MANIPULATOR_LINEAR_SHAFT_LENGTH_PX"),this.isDraggable=!t||!t.hasOwnProperty("isDraggable")||t.isDraggable,this.setFadeParameters(Mr.getNumber("MANIPULATOR_LINEAR_FADE_ANGLE_START"),Mr.getNumber("MANIPULATOR_LINEAR_FADE_ANGLE_END"))}remove(){super.remove(),this.displacementGraphics&&(this.displacementGraphics.remove(),this.displacementGraphics=null)}updateGeometry(){let e=this.shaftLengthPx,t=Mr.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX"),i=Mr.getNumber("MANIPULATOR_LINEAR_HEAD_RADIUS_PX");const s=Mr.getNumber("MANIPULATOR_CIRCLE_SEGMENTS");if(this.style===W.xKD.TANGENTIAL){const e=Mr.getNumber("MANIPULATOR_TANGENTIAL_SHAFT_LENGTH_PX"),t=Mr.getNumber("MANIPULATOR_TANGENTIAL_HEAD_LENGTH_PX"),i=Mr.getNumber("MANIPULATOR_TANGENTIAL_HEAD_RADIUS_PX"),n=Mr.getNumber("MANIPULATOR_TANGENTIAL_BASE_RADIUS_PX"),r=2*Math.max(i,n),a=2*(t+e)+n,o=vu(v.fromValues(0,0,n),v.fromValues(0,0,1),v.fromValues(1,0,0),e,t,i),h=vu(v.fromValues(0,0,-n),v.fromValues(0,0,-1),v.fromValues(1,0,0),e,t,i),c=Cu(v.fromValues(0,0,0),n,v.fromValues(0,1,0),s);this.meshIncrement=c.concatenate(o).concatenate(h),this.pickIncrement=Ou(v.fromValues(-r/2,0,-a/2),v.fromValues(r/2,0,-a/2),v.fromValues(-r/2,0,a/2))}else this.style===W.xKD.SECONDARY?(e-=t*Mr.getNumber("SECOND_DIRECTION_MANIPULATOR_OFFSET_PERCENT"),this.meshIncrement=Pu(v.fromValues(0,0,0),v.fromValues(0,0,1),v.fromValues(1,0,0),e,t,i),this.pickIncrement=Ou(v.fromValues(-i,0,0),v.fromValues(i,0,0),v.fromValues(-i,0,e+t))):(this.style!==W.xKD.DEFAULT&&this.style!==W.xKD.SIMPLE&&It.log.debug("Manipulator style "+W.sAS[this.style]+" not implemented.  Using default style"),this.style===W.xKD.SIMPLE&&(e=0,t=Mr.getNumber("MANIPULATOR_LINEAR_SIMPLE_HEAD_LENGTH_PX"),i=Mr.getNumber("MANIPULATOR_LINEAR_SIMPLE_HEAD_RADIUS_PX")),this.meshIncrement=vu(v.fromValues(0,0,0),v.fromValues(0,0,1),v.fromValues(1,0,0),e,t,i),this.pickIncrement=Ou(v.fromValues(-i,0,0),v.fromValues(i,0,0),v.fromValues(-i,0,e+t)))}setVisualGap(e){this.visualGapPx=e}setShaftLength(e){this.shaftLengthPx=e}setFlipDirectionWhenNegative(e){this.flipDirectionWhenNegative=e}setIsDraggable(e){this.isDraggable=e}getOffsetFromEvent(e){const t=e.camera.getRay(e.mouseX,e.mouseY),i=this.ray.findClosestPositionToOtherRay(t);return i||0}getOffsetFromXrInputEvent(e){const t=this.ray.findClosestPositionToOtherRay(e.modelSpaceRay);return t||0}onDefaultUnitsChanged(){this.hasEditView&&this.createEditView()}createEditView(){this.editViewUnits=(0,Ir.vx)().getLengthUnits();const e=new W.wtM;e.parameterId="length",e.units=this.editViewUnits,e.value=this.offset;const t={paramQuantity:e,quantityType:W.Uqp.LENGTH,range:null};(0,fr.m)().trigger(mr.C.CREATE_MANIPULATOR_EDIT_VIEW,this,t,this.viewer)}onDragStart(e,t,i){this.dragOffset=this.getOffsetFromEvent(t)-this.offset,super.onDragStart(e,t,i),this.initializeEditView()}onXrDragStart(e,t,i){this.dragOffset=this.getOffsetFromXrInputEvent(t)-this.offset,super.onXrDragStart(e,t,i),this.initializeEditView()}initializeEditView(){this.displayEditView&&!this.hasEditView&&(this.createEditView(),this.initialRay=new Li.zH(this.ray.point,this.ray.direction),ih().setActiveManipulator(this))}onEditChange(e){const t=e.units;this.editOffset=(0,Er.Fv)(e.value,t),this.trigger(Tr.Wb.VALUE_EDITED)}onDrag(e,t){if(this.isLocked||!this.isDraggable)return;const i=this.getOffsetFromEvent(t)-this.dragOffset,s=!t.shiftKey;this.handleDrag(i,t.camera.getRay(t.mouseX,t.mouseY),s,t)}onXrDrag(e,t){if(this.isLocked||!this.isDraggable)return;const i=this.getOffsetFromXrInputEvent(t)-this.dragOffset;this.handleDrag(i,t.modelSpaceRay,!1)}handleDrag(e,t,i,s){var n;if(e=(0,Li.uZ)(e,this.minOffset,this.maxOffset),i&&(e=this.getLinearSnapValue(s,e,this.ray.point),e=(0,Li.uZ)(e,this.minOffset,this.maxOffset)),this.offset=parseFloat(e.toFixed(this.offsetRoundDecimals)),this.hasEditView){let e=null===(n=this.initialRay)||void 0===n?void 0:n.findClosestPositionToOtherRay(t);e=e?e-this.dragOffset:0,i&&(e=this.getLinearSnapValue(s,e,this.initialRay.point),e=(0,Li.uZ)(e,this.minOffset,this.maxOffset)),this.editOffset=e}this.trigger(Tr.Wb.VALUE_CHANGED,this.offset,s),this.viewer.requestDraw()}updateDefinition(e,t,i){if(this.isBeingManipulated()){const i=this.ray.evaluate(this.offset);this.ray=new Li.zH(e,t);const s=this.ray.findPositionOfPoint(i);this.offset=s}else this.ray=new Li.zH(e,t),i||(i=0),this.offset=i;(0,Js.vm)()}updateDefinitionForLocalManipulatorAtRest(e,t,i){const s=2*bi.W.ZERO_LENGTH,n=i?-s:s;this.updateDefinition(e,t,n)}updateLimits(e,t){this.minOffset=e,this.maxOffset=t}getOffset(){return this.offset}getEditOffset(){return this.editOffset}getOffsetPosition(){return this.ray.evaluate(this.offset)}getEditOffsetPosition(){return this.initialRay.evaluate(this.editOffset)}getInitialOffsetPosition(){return this.initialRay.point}getEditTranslation(){return pe.S4.subtract(this.getOffsetPosition(),this.getInitialOffsetPosition(),v.create())}dragByIncrementValue(e){const t=this.ray.point,i=this.viewer.getCamera();if(!i)return;const s=i.projectWorldPointToCanvas(t),n={mouseX:s[0],mouseY:s[1],camera:i};this.onDragStart(null,n,{requestDrag:!1});const r=(0,Ir.vx)().getLengthUnits(),a=(0,Er.Fv)(e,r),o=this.ray.evaluate(a),h=i.projectWorldPointToCanvas(o);n.mouseX=h[0],n.mouseY=h[1],this.onDrag(null,n),this.onDragStop(null,n)}updateGraphics(e){super.updateGraphics(e);const t=Math.acos(Math.min(Math.abs(v.dot(e.getForward(),this.ray.direction)),1)),i=this.isBeingManipulated()?1:(0,Li.CW)(this.fadeAngleEnd,this.fadeAngleStart,t);if(this.updateColor(i),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.ray.evaluate(this.offset)),i=this.offset<0&&this.flipDirectionWhenNegative?-1:1,s=this.visualGapPx*t+this.offset,n=this.ray.evaluate(s),r=pe.S4.scale(pe.S4.normalize(this.ray.direction,v.create()),i*t),a=pe.S4.scale(pe.S4.normalize(pe.S4.cross(e.getForward(),r,v.create())),t),o=pe.S4.scale(pe.S4.normalize(pe.S4.cross(r,a,v.create())),t),h=ge.fromValues(a[0],a[1],a[2],0,o[0],o[1],o[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],1);if(this.hasEditView){const i=(0,Ir.vx)().getLengthUnits(),s=this.getEditTranslation(),r=v.dot(this.initialRay.direction,s)<0?-1:1,o=pe.S4.length(s)*r,h=(0,Er.KZ)(o,i);this.triggerEditValueChange({value:h,isLength:!0});const c=(0,Es.x_)(),l=this.shaftLengthPx*t*c,u=this.ray.evaluate(this.offset+l),d=e.projectWorldPointToCanvas(u),g=Fr(e.projectWorldPointToCanvas(n),d);d[0]=g.x+d[0]/(0,Es.x_)(),d[1]=g.y+d[1]/(0,Es.x_)(),this.triggerEditOriginChange(d[0],d[1]),this.displacementGraphics||(this.displacementGraphics=new xr(this.viewer,this)),this.displacementGraphics.updateGraphics(e,a,o)}this.setTransform(h)}}removeDisplacementMeshIncrements(){this.displacementGraphics&&this.displacementGraphics.removeMeshIncrement(yr)}}function Lr(e,t,i,s,n,r){r=r||W.xKD.DEFAULT;const a=e.point,o=e.evaluate(t),h=pe.S4.cross(e.direction,n.getForward(),v.create());pe.S4.normalize(h);const c=pe.S4.add(pe.S4.scale(h,i,v.create()),o),l=pe.S4.add(pe.S4.scale(h,-i,v.create()),o),u=e.evaluate(t+s),d={};if(r!==W.xKD.SECONDARY)d.lines=Iu([a,o,c,l,c,u,l,u]);else{const n=e.evaluate(t+.5*s),r=pe.S4.add(pe.S4.scale(h,i,v.create()),n),g=pe.S4.add(pe.S4.scale(h,-i,v.create()),n);d.lines=Iu([a,o,c,l,c,n,l,n,r,g,r,u,g,u])}const g=pe.S4.add(pe.S4.scale(h,-i,v.create()),a),p=pe.S4.add(pe.S4.scale(h,-i,v.create()),u),m=pe.S4.add(pe.S4.scale(h,i,v.create()),a);return d.pickArea=Ou(g,p,m),d}function Fr(e,t){let i=pe.S4.subtract(t,e,v.create());i=pe.S4.normalize(i,v.create());const s=Math.atan2(-i[1],i[0]),n={x:Mr.getNumber("MANIPULATOR_EDIT_VIEW_ORIGIN_X_OFFSET"),y:Mr.getNumber("MANIPULATOR_EDIT_VIEW_ORIGIN_Y_OFFSET")};return Math.abs(s)>=Math.PI/2&&(n.x=-(n.x+75)),s>=0&&(n.y=-(30+n.y)),n}class xr extends Ri{constructor(e,t){super(e),this.parent=t}updateGraphics(e,t,i){const s=Mr.getNumber("MANIPULATOR_LINEAR_START_LINE_LENGTH_PX"),n=e.getPixelSizeAtWorldPoint(this.parent.initialRay.point);let r=pe.S4.normalize(t,v.create());r=pe.S4.scale(r,n*s,v.create());const a=pe.S4.add(this.parent.initialRay.point,r,v.create());r=pe.S4.scale(r,-1);const o=pe.S4.add(this.parent.initialRay.point,r,v.create()),h=Iu([this.parent.initialRay.point,this.parent.initialRay.evaluate(i),a,o]);Uu(Mr.getColor("MANIPULATOR_DISPLACEMENT_COLOR"),h),Hu(Mr.getNumber("MANIPULATOR_DISPLACEMENT_LINE_WIDTH"),h),this.updateMeshIncrement(yr,yi,h,Ar)}}class Br extends Nr{constructor(e,t){super(e,t),this.direction0=v.fromValues(1,0,0),this.direction1=v.fromValues(0,1,0),this.normal=v.fromValues(0,0,1),this.visualGapPx=0,this.sideLengthPx=0,this.dragOffset=$.create(),this.origin=v.create(),this.offset=$.create(),this.dragDelta=$.create(),this.setFadeParameters(Mr.getNumber("MANIPULATOR_PLANAR_FADE_ANGLE_START"),Mr.getNumber("MANIPULATOR_PLANAR_FADE_ANGLE_END"))}updateGeometry(){this.meshIncrement=Iu([v.fromValues(0,0,0),v.fromValues(1,0,0),v.fromValues(1,0,0),v.fromValues(1,1,0),v.fromValues(1,1,0),v.fromValues(0,1,0),v.fromValues(0,1,0),v.fromValues(0,0,0)]),this.pickIncrement=Ou(v.fromValues(0,0,0),v.fromValues(1,0,0),v.fromValues(0,1,0))}setVisualGap(e){this.visualGapPx=e}setSideLength(e){this.sideLengthPx=e}getOffsetFromEvent(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return this.getOffsetFromRay(t)}getOffsetFromXrInputEvent(e){return this.getOffsetFromRay(e.modelSpaceRay)}getOffsetFromRay(e){const t=v.create(),i=P.fromValues(this.normal[0],this.normal[1],this.normal[2],-v.dot(this.normal,this.origin)),s=(0,Li.fE)(e,i);if(null===s)return null;const n=v.dot(pe.S4.subtract(s,this.origin,t),this.direction0),r=v.dot(pe.S4.subtract(s,this.origin,t),this.direction1);return $.fromValues(n,r)}onDragStart(e,t,i){const s=this.getOffsetFromEvent(t);this.displayEditView&&((0,fr.m)().trigger(mr.C.CLOSE_MANIPULATOR_EDIT_VIEW),ih().setActiveManipulator(null)),s&&(this.dragOffset=pe.gv.subtract(s,this.offset,$.create()),super.onDragStart(e,t,i))}onXrDragStart(e,t,i){const s=this.getOffsetFromXrInputEvent(t);this.displayEditView&&((0,fr.m)().trigger(mr.C.CLOSE_MANIPULATOR_EDIT_VIEW),ih().setActiveManipulator(null)),s&&(this.dragOffset=pe.gv.subtract(s,this.offset,$.create()),super.onXrDragStart(e,t,i))}onDrag(e,t){if(this.isLocked)return;const i=this.getOffsetFromEvent(t),s=!t.shiftKey;this.handleDrag(i,s,t)}onXrDrag(e,t){if(this.isLocked)return;const i=this.getOffsetFromXrInputEvent(t);this.handleDrag(i,!1)}handleDrag(e,t,i){if(e){this.offset=pe.gv.subtract(e,this.dragOffset,$.create());for(let e=0;e<this.offset.length;e++)t&&(this.offset[e]=this.getLinearSnapValue(i,this.offset[e],this.origin)),this.offset[e]=parseFloat(this.offset[e].toFixed(this.offsetRoundDecimals));this.trigger(Tr.Wb.VALUE_CHANGED,this.offset,i),this.viewer.requestDraw()}}updateDefinition(e,t,i,s){this.origin=e,this.direction0=t,this.direction1=i,(0,Sr.areUnitVectorsParallel)(this.direction0,this.direction1)?It.log.warn("Trying to create a planar manipulator with two parallel directions"):this.normal=pe.S4.normalize(pe.S4.cross(this.direction0,this.direction1,v.create())),this.offset=s,(0,Js.vm)()}getOffset(){return this.offset}evaluatePosition(e,t){return pe.S4.add(pe.S4.scale(this.direction0,e,v.create()),pe.S4.add(pe.S4.scale(this.direction1,t,v.create()),this.origin))}getOffsetPosition(){return this.evaluatePosition(this.offset[0],this.offset[1])}updateGraphics(e){super.updateGraphics(e);const t=Math.acos(Math.min(Math.abs(v.dot(e.getForward(),this.normal)),1)),i=this.isBeingManipulated()?1:1-(0,Li.CW)(this.fadeAngleStart,this.fadeAngleEnd,t);if(this.updateColor(i),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.getOffsetPosition()),i=this.visualGapPx*t,s=this.sideLengthPx*t,n=this.evaluatePosition(this.offset[0]+i,this.offset[1]+i),r=pe.S4.scale(this.direction0,s,v.create()),a=pe.S4.scale(this.direction1,s,v.create()),o=this.normal,h=ge.fromValues(r[0],r[1],r[2],0,a[0],a[1],a[2],0,o[0],o[1],o[2],0,n[0],n[1],n[2],1);this.setTransform(h)}}}class Ur extends Nr{constructor(e,t){super(e,t),this.zeroAngleDirection=v.fromValues(1,0,0),this.upDirection=v.fromValues(0,1,0),this.angle=0,this.angleRelativeToInitialZeroDirection=0,this.angleRelativeToInitialZeroDirectionForEdit=0,this.isClockWiseRotation=!0,this.radius=0,this.radialOffsetPx=0,this.dragOffset=0,this.disableMinimumOffset=!1,this.axis=new Li.zH([0,0,0],[0,0,1]),this.initialZeroAngleDirection=this.zeroAngleDirection,this.initialUpDirection=this.upDirection,this.minAngle=-Math.PI,this.maxAngle=Math.PI,this.minDisplayAngle=-Math.PI,this.maxDisplayAngle=Math.PI,this.setFadeParameters(Mr.getNumber("MANIPULATOR_ANGULAR_FADE_ANGLE_START"),Mr.getNumber("MANIPULATOR_ANGULAR_FADE_ANGLE_END"))}updateGeometry(){this.meshIncrement=Cu(v.fromValues(0,0,0),1,v.fromValues(0,0,1),Mr.getNumber("MANIPULATOR_CIRCLE_SEGMENTS"));const e=Mr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS_SCALE"),t=Math.abs(Math.atan(1/e)),i=Mr.getNumber("MANIPULATOR_ANGULAR_HANDLE_SUBTENSION_FACTOR"),s=Mr.getNumber("MANIPULATOR_ANGULAR_HANDLE_ARC_SEGMENTS"),n=Du(v.fromValues(-e,0,0),e,v.fromValues(0,0,1),v.fromValues(1,0,0),t,i*t,s);this.meshIncrement=this.meshIncrement.concatenate(n);const r=Du(v.fromValues(-e,0,0),e,v.fromValues(0,0,1),v.fromValues(1,0,0),-t,-i*t,s);this.meshIncrement=this.meshIncrement.concatenate(r);const a=6*e*t;this.pickIncrement=Ou(v.fromValues(-1,a/2,0),v.fromValues(-1,-a/2,0),v.fromValues(1,a/2,0))}setAngle(e){this.angle=e}setRadialOffset(e){this.radialOffsetPx=e}getPlaneDefinition(){return P.fromValues(this.axis.direction[0],this.axis.direction[1],this.axis.direction[2],-v.dot(this.axis.point,this.axis.direction))}getMousePlanePosition(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return(0,Li.fE)(t,this.getPlaneDefinition())}getXrInputPlanePosition(e){return(0,Li.fE)(e.modelSpaceRay,this.getPlaneDefinition())}getAngleFromEvent(e,t,i,s,n,r,a){const o=this.getMousePlanePosition(e);return this.getAngleFromPlanePosition(o,t,i,s,n,r,a)}getAngleFromXrInputEvent(e,t,i,s,n,r,a){const o=this.getXrInputPlanePosition(e);return this.getAngleFromPlanePosition(o,t,i,s,n,r,a)}getAngleFromPlanePosition(e,t,i,s,n,r,a){if(!e)return null;const o=pe.S4.subtract(e,this.axis.point),h=v.dot(o,i),c=v.dot(o,s);if(h*h+c*c<bi.W.ZERO_LENGTH*bi.W.ZERO_LENGTH)return null;const l=Math.atan2(c,h)+t;return(0,Li.Kf)(l,n,r,a)}onDefaultUnitsChanged(){this.hasEditView&&this.createEditView()}createEditView(){const e=new W.wtM;e.parameterId="angle",e.units=(0,Ir.vx)().getAngleUnits(),e.value=this.angle;const t=new W.ySX;t.minValue=Math.max(0,Gr(this.minDisplayAngle)),t.maxValue=Math.max(0,Gr(this.maxDisplayAngle)),t.units=e.units;const i={paramQuantity:e,quantityType:W.Uqp.ANGLE,range:t};(0,fr.m)().trigger(mr.C.CREATE_MANIPULATOR_EDIT_VIEW,this,i,this.viewer)}onDragStart(e,t,i){this.dragOffset=this.angle-this.getAngleFromEvent(t,0,this.zeroAngleDirection,this.upDirection,this.angle,this.minAngle,this.maxAngle),super.onDragStart(e,t,i),this.initializeEditView()}onXrDragStart(e,t,i){this.dragOffset=this.angle-this.getAngleFromXrInputEvent(t,0,this.zeroAngleDirection,this.upDirection,this.angle,this.minAngle,this.maxAngle),super.onXrDragStart(e,t,i),this.initializeEditView()}initializeEditView(){this.displayEditView&&!this.hasEditView&&(this.createEditView(),this.initialZeroAngleDirection=v.clone(this.zeroAngleDirection),this.initialUpDirection=v.clone(this.upDirection),this.trigger(Tr.Wb.CACHE_TRANSFORM),this.isClockWiseRotation=this.dragOffset>0,this.angleRelativeToInitialZeroDirectionForEdit=0,ih().setActiveManipulator(this))}onEditChange(e){const t=Math.abs(Vr(e.value));this.isClockWiseRotation?this.angleRelativeToInitialZeroDirectionForEdit=t:this.angleRelativeToInitialZeroDirectionForEdit=-t,this.trigger(Tr.Wb.VALUE_EDITED)}getSnapAngle(e,t){const i=e.camera,s=Mr.getNumberArray("MANIPULATOR_ANGULAR_SNAP_DIVISOR"),n=Mr.getNumber("MANIPULATOR_ANGULAR_SNAP_RESOLUTION_PX"),r=this.getMousePlanePosition(e);let a=0;if(r){const e=i.getUnitSizeAtWorldPoint(r)/(0,Es.x_)(),t=pe.S4.subtract(r,this.axis.point),o=pe.S4.length(t);for(;a<s.length;++a){if(o*(Math.PI/s[a])*e<=n)break}}const o=s[a]*t/Math.PI,h=Math.round(o),c=h-o;let l=Mr.getNumber("MANIPULATOR_ANGULAR_SNAP_ANGLE_DEVIATION");return l*=1+a/s.length,Math.abs(c)<=l&&(t=h*Math.PI/s[a]),t}onDrag(e,t){if(this.isLocked)return;const i=this.getAngleFromEvent(t,this.dragOffset,this.zeroAngleDirection,this.upDirection,this.angle,this.minAngle,this.maxAngle),s=this.hasEditView?this.getAngleFromEvent(t,this.dragOffset,this.initialZeroAngleDirection,this.initialUpDirection,this.angleRelativeToInitialZeroDirectionForEdit,this.minDisplayAngle,this.maxDisplayAngle):null,n=!t.shiftKey;this.handleDrag(i,s,n,t)}onXrDrag(e,t){if(this.isLocked)return;const i=this.getAngleFromXrInputEvent(t,this.dragOffset,this.zeroAngleDirection,this.upDirection,this.angle,this.minAngle,this.maxAngle),s=this.hasEditView?this.getAngleFromXrInputEvent(t,this.dragOffset,this.initialZeroAngleDirection,this.initialUpDirection,this.angleRelativeToInitialZeroDirectionForEdit,this.minDisplayAngle,this.maxDisplayAngle):null;this.handleDrag(i,s,!1)}handleDrag(e,t,i,s){if(null!==e){if(this.angle=parseFloat(e.toFixed(this.offsetRoundDecimals)),i&&(this.angle=this.getSnapAngle(s,this.angle)),this.angle=(0,Li.uZ)(this.angle,this.minAngle,this.maxAngle),this.hasEditView&&null!==t){this.isClockWiseRotation=t>0;let e=(0,Li.FE)(this.initialZeroAngleDirection,this.zeroAngleDirection,this.getAxis().direction)+this.angle;e<this.minDisplayAngle?e=(0,Li.Tu)(e,this.minDisplayAngle):e>this.maxDisplayAngle&&(e=(0,Li.Kb)(e,this.maxDisplayAngle)),this.angleRelativeToInitialZeroDirection=t,this.angleRelativeToInitialZeroDirectionForEdit=e}this.trigger(Tr.Wb.VALUE_CHANGED,this.angle,s),this.viewer.requestDraw()}}updateDefinition(e,t,i,s,n){let r;if(this.isBeingManipulated()&&(r=pe.S4.add(pe.S4.scale(this.zeroAngleDirection,Math.cos(this.angle),v.create()),pe.S4.scale(this.upDirection,Math.sin(this.angle),v.create()))),this.axis=new Li.zH(e,t),this.zeroAngleDirection=pe.S4.normalize(i,v.create()),this.radius=s,this.upDirection=pe.S4.cross(this.axis.direction,this.zeroAngleDirection,v.create()),pe.S4.normalize(this.upDirection),n||(n=0),this.isBeingManipulated()&&r){const e=v.dot(r,this.zeroAngleDirection),t=v.dot(r,this.upDirection);if(e*e+t*t<bi.W.ZERO_LENGTH*bi.W.ZERO_LENGTH)this.angle=n;else{const i=Math.atan2(t,e);this.angle=(0,Li.Kf)(i,this.angle,this.minAngle,this.maxAngle)}}else this.angle=n;(0,Js.vm)()}updateLimits(e,t){this.minAngle=e,this.maxAngle=t}updateEditLimits(e,t){this.minDisplayAngle=e,this.maxDisplayAngle=t}setDisableMinimumOffset(e){this.disableMinimumOffset=e}getAngle(){return this.angle}getEditAngle(){return this.angleRelativeToInitialZeroDirectionForEdit}getEditAngleDisplacement(){let e=(0,Li.FE)(this.initialZeroAngleDirection,this.zeroAngleDirection,this.getAxis().direction);if(this.maxDisplayAngle-this.minDisplayAngle>2*Math.PI&&(0,Sr.sign)(e)!==(0,Sr.sign)(this.angleRelativeToInitialZeroDirection)){const t=2*Math.PI-Math.abs(e);e=(0,Sr.sign)(this.angleRelativeToInitialZeroDirection)*t}let t=Math.abs(e)-Math.abs(this.angleRelativeToInitialZeroDirectionForEdit);return this.angleRelativeToInitialZeroDirection<0&&(t=-t),t}getAxis(){return this.axis}getZeroAngleDirection(){return this.zeroAngleDirection}getPosition(e,t){const i=Math.cos(e)*t,s=Math.sin(e)*t,n=v.create(),r=v.create();return pe.S4.add(pe.S4.scale(this.zeroAngleDirection,i,n),pe.S4.add(pe.S4.scale(this.upDirection,s,r),this.axis.point))}updateEditBoxPosition(e){const t=e.getPixelSizeAtWorldPoint(this.axis.point),i=(0,Es.x_)(),s=(Mr.getNumber("MANIPULATOR_ANGULAR_ARROW_SHAFT_LENGTH_PX")+Mr.getNumber("MANIPULATOR_ANGULAR_ARROW_RADIUS_PX")+Mr.getNumber("MANIPULATOR_ANGULAR_ARROW_LENGTH_PX")+2*Mr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS")*i+2*Mr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS")*i)*t,n=this.getPosition(0,s),r=e.projectWorldPointToCanvas(this.axis.point),a=e.projectWorldPointToCanvas(n),o=Fr(r,a);a[0]=o.x+a[0]/(0,Es.x_)(),a[1]=o.y+a[1]/(0,Es.x_)(),this.triggerEditOriginChange(a[0],a[1])}updateGraphics(e){super.updateGraphics(e);const t=Math.acos(Math.abs(v.dot(e.getForward(),this.axis.direction))),i=this.isBeingManipulated()?1:1-(0,Li.CW)(this.fadeAngleStart,this.fadeAngleEnd,t);if(this.updateColor(i),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.axis.point),i=this.axis.point,s=this.radius+t*this.radialOffsetPx,n=this.getPosition(this.angle,s),r=Mr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS")*t,a=n,o=pe.S4.scale(pe.S4.normalize(pe.S4.subtract(n,i,v.create())),r),h=pe.S4.normalize(this.axis.direction,v.create()),c=pe.S4.cross(h,o,v.create()),l=ge.fromValues(o[0],o[1],o[2],0,c[0],c[1],c[2],0,h[0],h[1],h[2],0,a[0],a[1],a[2],1),u=(0,Es.x_)();if(pe.w$.scale(l,v.fromValues(u,u,u)),this.hasEditView){this.updateEditBoxPosition(e);let t=0;if(this.isDragging)t=this.angleRelativeToInitialZeroDirectionForEdit;else{let e=(0,Li.FE)(this.initialZeroAngleDirection,this.zeroAngleDirection,this.getAxis().direction);this.maxDisplayAngle-this.minDisplayAngle>2*Math.PI&&(e=Math.abs(this.angleRelativeToInitialZeroDirectionForEdit)>bi.W.ZERO_ANGLE?function(e,t,i,s){let n=(0,Li.FE)(e,t,i);s?n<0&&(n=2*Math.PI+n):n>0&&(n=-1*(2*Math.PI-n));return n}(this.initialZeroAngleDirection,this.zeroAngleDirection,this.getAxis().direction,this.isClockWiseRotation):this.angleRelativeToInitialZeroDirectionForEdit),t=e}const i=Math.abs(Gr(t));this.triggerEditValueChange({value:i,isLength:!1});const s=1.5,n=Mr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS_SCALE")-s,r=Mr.getNumber("MANIPULATOR_ANGULAR_HANDLE_SUBTENSION_FACTOR")*Math.abs(Math.atan(1/n)),a=2*Mr.getNumber("MANIPULATOR_CIRCLE_SEGMENTS"),o=t<0?r:-r,h=v.fromValues(-n,0,0);let c=Du(h,n,v.fromValues(0,0,1),v.fromValues(1,0,0),o,-t,a);const l=v.create(),u=v.fromValues(0,1,0),d=v.fromValues(1,0,0),g=n*Math.cos(-t),p=n*Math.sin(-t);pe.S4.add(h,pe.S4.add(pe.S4.scale(u,p,v.create()),pe.S4.scale(d,g,v.create()),l),l);const m=new Li.zH(h,pe.S4.subtract(h,l,v.create())),f=Mr.getNumber("MANIPULATOR_ANGULAR_START_LINE_LENGTH_FACTOR"),I=Iu([m.evaluate(-n+f),m.evaluate(-n-f)]);c=c.concatenate(I),Uu(Mr.getColor("MANIPULATOR_DISPLACEMENT_COLOR"),c),Hu(Mr.getNumber("MANIPULATOR_DISPLACEMENT_LINE_WIDTH"),c),this.updateMeshIncrement(yr,yi,c,Ar)}this.setTransform(l)}}dragByIncrementValue(e){const t=this.viewer.getCamera();if(!t)return;const i=t.getPixelSizeAtWorldPoint(this.axis.point),s=this.getClampedRadius(i,!0);let n=t.projectWorldPointToCanvas(this.getPosition(this.angle,s));const r={mouseX:n[0],mouseY:n[1],camera:t};this.onDragStart(null,r,{requestDrag:!1}),e=Vr(e),n=t.projectWorldPointToCanvas(this.getPosition(this.angle+e,s)),r.mouseX=n[0],r.mouseY=n[1],this.onDrag(null,r),this.onDragStop(null,r)}getClampedRadius(e,t){if(this.disableMinimumOffset)return this.radius;let i=this.radius;const s=Mr.getNumber("MANIPULATOR_ANGULAR_MINIMUM_RADIUS_PX")*e;return i<s&&(i=s),t&&(i+=e*this.radialOffsetPx),i}}function Vr(e){return e="degree"===(0,Ir.vx)().getAngleUnits()?e*Math.PI/180:e}function Gr(e){return e="degree"===(0,Ir.vx)().getAngleUnits()?180*e/Math.PI:e}class Hr extends Ur{constructor(e){super(e)}updateGraphics(e){let t=Math.abs(v.dot(e.getForward(),this.axis.direction));t>1?t=1:t<-1&&(t=-1);const i=Math.acos(t),s=this.isBeingManipulated()?1:1-(0,Li.CW)(this.fadeAngleStart,this.fadeAngleEnd,i);if(s<=0)return void this.removeMeshIncrements();const n=e.getPixelSizeAtWorldPoint(this.axis.point),r=this.getClampedRadius(n,!0),a=this.getPosition(this.angle,r),o=Math.cos(this.angle),h=Math.sin(this.angle),c=pe.S4.add(pe.S4.scale(this.zeroAngleDirection,-h,v.create()),pe.S4.scale(this.upDirection,o,v.create()));this.angle<0&&pe.S4.negate(c);const l=Lr(new Li.zH(a,c),Mr.getNumber("MANIPULATOR_ANGULAR_ARROW_SHAFT_LENGTH_PX")*n,Mr.getNumber("MANIPULATOR_ANGULAR_ARROW_RADIUS_PX")*n,Mr.getNumber("MANIPULATOR_ANGULAR_ARROW_LENGTH_PX")*n,e,this.style);this.updateLines("linear",l.lines,s),this.updatePickArea(l.pickArea);const u=this.getClampedRadius(n,!1),d=u+Mr.getNumber("MANIPULATOR_ANGULAR_ARROW_LEADER_EXTENSION_PX")*n,g=this.getPosition(0,d),p=this.getPosition(this.angle,d),m=Iu([this.axis.point,g,this.axis.point,p]);this.updateLines("leaders",m,.5*s);const f=Math.abs(this.angle)*u/n,I=Du(this.axis.point,u,this.axis.direction,this.zeroAngleDirection,0,this.angle,Math.floor(f/10));this.updateLines("arc",I,.5*s),!this.isHidden&&this.hasEditView&&this.updateEditBoxPosition(e)}}class kr extends Nr{constructor(e,t){super(e,t),this.position=v.fromValues(0,0,0),this.dragPlane=P.fromValues(0,0,1,0),this.xrDragDistance=-1,this.lastMouseRay=new Li.zH([0,0,0],[1,0,0])}updateGeometry(){const e=Mr.getNumber("MANIPULATOR_CIRCLE_SEGMENTS");this.meshIncrement=Cu(v.fromValues(0,0,0),1,v.fromValues(0,0,1),e),this.pickIncrement=Mu(v.fromValues(0,0,0),1,v.fromValues(0,0,1),e)}onDragStart(e,t,i){if(!this.isEnabled)return;this.displayEditView&&((0,fr.m)().trigger(mr.C.CLOSE_MANIPULATOR_EDIT_VIEW),ih().setActiveManipulator(null));const s=t.camera.getForward();this.dragPlane=[s[0],s[1],s[2],v.dot(s,this.position)],super.onDragStart(e,t,i)}onXrDragStart(e,t,i){this.isEnabled&&(this.displayEditView&&((0,fr.m)().trigger(mr.C.CLOSE_MANIPULATOR_EDIT_VIEW),ih().setActiveManipulator(null)),this.xrDragDistance=t.modelSpaceRay.findPositionOfPoint(this.position),super.onXrDragStart(e,t,i))}onDrag(e,t){if(this.isLocked)return;this.lastMouseRay=t.camera.getRay(t.mouseX,t.mouseY);const i=(0,Li.fE)(this.lastMouseRay,this.dragPlane);this.handleDrag(i,t)}onXrDrag(e,t){if(this.isLocked)return;const i=t.modelSpaceRay.evaluate(this.xrDragDistance);this.handleDrag(i)}handleDrag(e,t){e&&(this.position=e,this.trigger(Tr.Wb.VALUE_CHANGED,this.position,null==t?void 0:t.mouseX,null==t?void 0:t.mouseY,t),this.viewer.requestDraw())}getLastMouseRay(){return this.lastMouseRay}updateDefinition(e){this.position=e,(0,Js.vm)()}updateGraphics(e){if(super.updateGraphics(e),this.updateColor(),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.position),i=Mr.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX")*t,s=this.position,n=pe.S4.scale(e.getForward(),-1,v.create()),r=pe.S4.scale(e.getRight(),i,v.create()),a=pe.S4.scale(e.getUp(),i,v.create()),o=ge.fromValues(r[0],r[1],r[2],0,a[0],a[1],a[2],0,n[0],n[1],n[2],0,s[0],s[1],s[2],1);this.setTransform(o)}}}const Wr=new Qi({isVisible:!0,isPickable:!0,isShowThrough:!0,isDepthTested:!1,priority:Yi.DEFAULT,primitiveType:_i.MX.POINTS}),zr=new Qi(Object.assign({},Wr,{priority:Yi.HIGHEST})),Xr=new Qi(Object.assign({},Wr,{isPickable:!1}));class qr extends Nr{constructor(e,t,i){super(e),this.points=[],this.pointBoundsCenter=v.create(),this.minimimumPointDistance=-1,this.lastPixelSize=-1,this.pointSize=-1,this.hoveredPointIndex=qr.NO_SELECTED_INDEX,this.isMultiSelect=!1,this.isPointSelected=[],this.suppressedIndices=new Set,this.selectedIndicesServerState=new Set,this.boxSelectedIndices=new Set,this.isMultiSelect=t,this.isMultiSelect&&(this.listenTo(e.getEventDispatcher(),Ms.f4Y,this.onPicksBoxSelected),this.listenTo(e.getEventDispatcher(),Ms.KB0,this.onBoxSelectionFinished)),this.manipulatorChangesInFlightSubscription=null==i?void 0:i.subscribe((e=>{this.manipulatorChangesInFlight=e}))}updateDefinition(e,t,i){var s;this.selectedIndicesServerState=t,0===(null!==(s=this.manipulatorChangesInFlight)&&void 0!==s?s:0)&&(this.isPointSelected=e.map(((e,t)=>this.selectedIndicesServerState.has(t)))),this.suppressedIndices=null!=i?i:new Set,this.processPoints(e)}processPoints(e){this.points=e;const t=new Li.kB;t.addPointArray(e),t.isFinite()&&(this.pointBoundsCenter=t.center());let i=-1;this.minimimumPointDistance=-1;for(let t=0;t<e.length;++t)for(let s=t+1;s<e.length;++s){const n=v.squaredDistance(e[t],e[s]);(i<0||n<i)&&(i=n)}i>=0&&(this.minimimumPointDistance=Math.sqrt(i)),this.lastPixelSize=-1,this.pointSize=-1}updatePointGraphics(){if(this.isMultiSelect&&this.viewer.performingBoxSelection())return;if(this.removeMeshIncrements(),this.stopListening(this),this.stopListening(this.viewer.getEventDispatcher()),this.pointSize<=0)return;const e=Mr.getPointFont("MANIPULATOR_POINT_FONT");for(let t=0;t<this.points.length;++t){const i="point"+t,s=this.getSelectionIdForIndex(t),n=this.isMultiSelect?this.getPointColorMultiSelect(t):this.getPointColor(t),r=this.isMultiSelect&&this.suppressedIndices.has(t)?this.pointSize/1.5:this.pointSize,a=Su(this.points[t],i,n,r,e);this.updateMeshIncrement(i,s,a,this.getPointNodeProperties(t)),this.listenTo(this,Pi.MOUSE_ENTER+s,this.onMouseEnter),this.listenTo(this,Pi.MOUSE_LEAVE+s,this.onMouseLeave),this.listenTo(this,Pi.CLICK+s,this.onClick)}this.isMultiSelect&&(this.listenTo(this.viewer.getEventDispatcher(),Ms.f4Y,this.onPicksBoxSelected),this.listenTo(this.viewer.getEventDispatcher(),Ms.KB0,this.onBoxSelectionFinished))}onViewWillDraw(e,t){if(this.isHidden)return;const i=e.getPixelSizeAtWorldPoint(this.pointBoundsCenter);if(i!==this.lastPixelSize){let e;this.lastPixelSize=i;const t=this.minimimumPointDistance/i,s=Mr.getNumber("MANIPULATOR_SMALL_POINT_DISTANCE_PX"),n=Mr.getNumber("MANIPULATOR_LARGE_POINT_DISTANCE_PX");if(t<=s)e=qr.SMALL_SIZE_CONSTANT;else if(t>=n)e=qr.LARGE_SIZE_CONSTANT;else{const i=(t-s)/(n-s);e=(0,Li.CD)(qr.SMALL_SIZE_CONSTANT,qr.LARGE_SIZE_CONSTANT,i)}this.pointSize!==e&&(this.pointSize=e,this.updatePointGraphics())}}onMouseEnter(e){this.isEnabled&&this.setHoveredPoint(this.getIndexForSelection(e))}onMouseLeave(e){if(!this.isEnabled)return;this.getIndexForSelection(e)===this.hoveredPointIndex&&this.setHoveredPoint(qr.NO_SELECTED_INDEX)}onClick(e){if(!this.isEnabled)return;const t=this.getIndexForSelection(e);!this.isMultiSelect&&this.isPointSelected[t]||this.setSelectedPoint(t)}onPicksBoxSelected(e){this.isEnabled&&this.queueManipulatorSelectionsFromPicks(e)}onBoxSelectionFinished(){this.setBoxSelectedPoints()}queueManipulatorSelectionsFromPicks(e){var t;for(const i of e){const e=null===(t=(0,Q.as)(Ef.D,i))||void 0===t?void 0:t.uiSelection;(null==e?void 0:e.uiElement)instanceof qr&&this.boxSelectedIndices.add(this.getIndexForSelection(e))}}getSelectionIdForIndex(e){return""+e}getIndexForSelection(e){return+e.selectionId}getPointColor(e){return this.isPointSelected[e]?Mr.getColor("MANIPULATOR_OUTLINE_DRAG_COLOR"):e===this.hoveredPointIndex?Mr.getColor("MANIPULATOR_OUTLINE_HOVER_COLOR"):Mr.getColor("MANIPULATOR_OUTLINE_COLOR")}getPointColorMultiSelect(e){return this.suppressedIndices.has(e)?Mr.getColor("MANIPULATOR_OUTLINE_DISABLED_COLOR"):e===this.hoveredPointIndex?Mr.getColor("MANIPULATOR_OUTLINE_HOVER_COLOR"):this.isPointSelected[e]?Mr.getColor("MANIPULATOR_OUTLINE_DRAG_COLOR"):Mr.getColor("MANIPULATOR_OUTLINE_COLOR")}getPointNodeProperties(e){return this.suppressedIndices.has(e)?Xr:this.isPointSelected[e]||e===this.hoveredPointIndex?zr:Wr}setHoveredPoint(e){this.hoveredPointIndex!==e&&(this.hoveredPointIndex=e,this.updatePointGraphics())}setSelectedPoint(e){this.isMultiSelect?this.isPointSelected[e]=!this.isPointSelected[e]:(this.isPointSelected[this.isPointSelected.findIndex((e=>e))]=!1,this.isPointSelected[e]=!0),this.trigger(Tr.Wb.VALUE_CHANGED,this.isPointSelected),this.updatePointGraphics()}setBoxSelectedPoints(){for(const e of this.boxSelectedIndices)this.isPointSelected[e]=!this.isPointSelected[e];this.boxSelectedIndices.clear(),this.trigger(Tr.Wb.VALUE_CHANGED,this.isPointSelected),this.updatePointGraphics()}remove(){var e;super.remove(),null===(e=this.manipulatorChangesInFlightSubscription)||void 0===e||e.unsubscribe()}}qr.NO_SELECTED_INDEX=-1,qr.SMALL_SIZE_CONSTANT=Mr.getNumber("MANIPULATOR_POINT_SMALL_SIZE"),qr.LARGE_SIZE_CONSTANT=Mr.getNumber("MANIPULATOR_POINT_LARGE_SIZE");class Zr extends Nr{constructor(e,t){super(e,t),this.scale=1,this.dragScale=1,this.minScale=1e-5,this.maxScale=1e3,this.ray=new Li.zH([0,0,0],[0,0,1]),this.gapLengthPx=Mr.getNumber("MANIPULATOR_LINEAR_SHAFT_LENGTH_PX")*Math.sqrt(2),Mr.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX"),this.headLengthPx=Mr.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX"),this.isDraggable=!t||!t.hasOwnProperty("isDraggable")||!!t.isDraggable,this.setFadeParameters(Mr.getNumber("MANIPULATOR_PLANAR_FADE_ANGLE_START"),Mr.getNumber("MANIPULATOR_PLANAR_FADE_ANGLE_END"))}updateGeometry(){this.meshIncrement=vu(v.fromValues(0,0,this.gapLengthPx),v.fromValues(0,0,1),v.fromValues(1,0,0),0,this.headLengthPx,this.headLengthPx/Math.sqrt(3)),this.pickIncrement=Ou(v.fromValues(-this.headLengthPx/2,0,this.gapLengthPx),v.fromValues(this.headLengthPx/2,0,this.gapLengthPx),v.fromValues(-this.headLengthPx/2,0,this.gapLengthPx+this.headLengthPx))}setGapLength(e){this.gapLengthPx=e}setHeadLength(e){this.headLengthPx=e}setIsDraggable(e){this.isDraggable=e}getPlaneDefinition(){return P.fromValues(this.normal[0],this.normal[1],this.normal[2],-v.dot(this.ray.point,this.normal))}getMousePlanePosition(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return(0,Li.fE)(t,this.getPlaneDefinition())}getXrInputPlanePosition(e){return(0,Li.fE)(e.modelSpaceRay,this.getPlaneDefinition())}createEditView(){const e=new W.wtM;e.parameterId="scale",e.units="",e.value=this.scale;const t=new W.ySX;t.minValue=this.minScale,t.maxValue=this.maxScale,t.units="";const i={paramQuantity:e,quantityType:W.Uqp.REAL,range:t};(0,fr.m)().trigger(mr.C.CREATE_MANIPULATOR_EDIT_VIEW,this,i,this.viewer)}onDragStart(e,t,i){const s=this.getMousePlanePosition(t);s&&(this.initializeDrag(s),super.onDragStart(e,t,i))}onXrDragStart(e,t,i){const s=this.getXrInputPlanePosition(t);s&&(this.initializeDrag(s),super.onXrDragStart(e,t,i))}initializeDrag(e){if(!e)return;const t=pe.S4.subtract(e,this.ray.point,v.create());this.originToInitialLength=pe.S4.length(t),this.dragScale=this.scale,this.displayEditView&&!this.hasEditView&&(this.createEditView(),ih().setActiveManipulator(this))}onEditChange(e){this.scale=Math.max(0,e.value),this.trigger(Tr.Wb.VALUE_EDITED)}getScaleFromEvent(e){return this.getScaleFromPosition(this.getMousePlanePosition(e))}getScaleFromXrInputEvent(e){return this.getScaleFromPosition(this.getXrInputPlanePosition(e))}getScaleFromPosition(e){const t=pe.S4.subtract(e,this.ray.point,v.create());return pe.S4.length(t)/this.originToInitialLength}onDrag(e,t){!this.isLocked&&this.isDraggable&&this.handleDrag(this.getScaleFromEvent(t),t)}onXrDrag(e,t){!this.isLocked&&this.isDraggable&&this.handleDrag(this.getScaleFromXrInputEvent(t))}handleDrag(e,t){this.scale=this.dragScale*e,this.scale=parseFloat(this.scale.toFixed(this.offsetRoundDecimals)),this.trigger(Tr.Wb.VALUE_CHANGED,this.scale,t),this.viewer.requestDraw()}resetScale(){this.scale=1}updateDefinition(e,t,i){this.ray=new Li.zH(e,i),this.normal=t,(0,Js.vm)()}getScale(){return this.scale}updateGraphics(e){super.updateGraphics(e);const t=Math.acos(Math.min(Math.abs(v.dot(e.getForward(),this.normal)),1)),i=this.isBeingManipulated()?1:1-(0,Li.CW)(this.fadeAngleStart,this.fadeAngleEnd,t);if(this.updateColor(i),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.ray.point),i=this.isBeingDragged?this.scale/this.dragScale:1,s=this.ray.point,n=pe.S4.scale(pe.S4.normalize(this.ray.direction,v.create()),i*t),r=pe.S4.scale(pe.S4.normalize(pe.S4.cross(e.getForward(),n,v.create())),i*t),a=pe.S4.scale(pe.S4.normalize(pe.S4.cross(n,r,v.create())),i*t),o=ge.fromValues(r[0],r[1],r[2],0,a[0],a[1],a[2],0,n[0],n[1],n[2],0,s[0],s[1],s[2],1);if(this.hasEditView){this.triggerEditValueChangeNoUnit({value:this.scale});const i=(0,Es.x_)(),n=this.gapLengthPx*t*i,r=this.ray.evaluate(n),a=e.projectWorldPointToCanvas(r),o=Fr(e.projectWorldPointToCanvas(s),a);a[0]=o.x+a[0]/(0,Es.x_)(),a[1]=a[1]/(0,Es.x_)(),this.triggerEditOriginChange(a[0],a[1])}this.setTransform(o)}}}var Yr=i(13214);class Kr{constructor(){this.operandA=null,this.operandB=null}resetWithOperands(e,t){return this.operandA=e,this.operandB=t,this.operandB.setOperand(this.operandA),this}getRangeIteratorForBufferSet(e){return this.operandA&&this.operandB?this.operandB.getRangeIteratorForBufferSet(e):null}setOperand(e){this.operandA.setOperand(e)}makeSceneDebugObject(){const e={text:"ChainedOperator",children:[]};return(0,Js.n9)(e,this.operandA),e}}const jr=new Kr;class Qr{constructor(e,t){this.occurrenceId=e,this.shouldSetOccurrenceUniform=!0,this.isolated=!1,this.canIsolateChange=!0,this.cullingState=null,this.hiddenBaseMeshRanges=null,this.hiddenPreviewMeshRanges=null,this.hiddenFromPickBaseMeshRanges=null,this.hiddenFromPickPreviewMeshRanges=null,this.baseHighlights=null,this.previewHighlights=null,this.transform=ge.create(),this.lod=eg.DEFAULT,this.visibility=Js.EE.VISIBLE,this.boundables=new Set,this.isClippedBySectionPlane=t}destroy(){this.hiddenBaseMeshRanges&&(this.hiddenBaseMeshRanges.destroy(),this.hiddenBaseMeshRanges=null),this.hiddenPreviewMeshRanges&&(this.hiddenPreviewMeshRanges.destroy(),this.hiddenPreviewMeshRanges=null),this.hiddenFromPickBaseMeshRanges&&(this.hiddenFromPickBaseMeshRanges.destroy(),this.hiddenFromPickBaseMeshRanges=null),this.hiddenFromPickPreviewMeshRanges&&(this.hiddenFromPickPreviewMeshRanges.destroy(),this.hiddenFromPickPreviewMeshRanges=null),this.baseHighlights&&(this.baseHighlights.destroy(),this.baseHighlights=null),this.previewHighlights&&(this.previewHighlights.destroy(),this.previewHighlights=null),this.boundables.clear()}onPreviewDestroyed(){this.hiddenPreviewMeshRanges&&(this.hiddenPreviewMeshRanges.destroy(),this.hiddenPreviewMeshRanges=null),this.hiddenFromPickPreviewMeshRanges&&(this.hiddenFromPickPreviewMeshRanges.destroy(),this.hiddenFromPickPreviewMeshRanges=null),this.previewHighlights&&(this.previewHighlights.destroy(),this.previewHighlights=null)}getOccurrenceId(){return this.occurrenceId}setShouldSetOccurrenceUniform(e){this.shouldSetOccurrenceUniform=e}getShouldSetOccurrenceUniform(){return this.shouldSetOccurrenceUniform}setTransform(e){(0,Li.cl)(this.transform,e)||(this.transform=ge.clone(e),this.damageBoundables())}getTransform(){return this.transform}setIsolated(e){this.canIsolateChange&&(this.isolated=e)}getIsolated(){return this.isolated}setCanIsolateChange(e){this.canIsolateChange=e}setLod(e){this.lod=e}getLod(){return this.lod}setVisibility(e){e!==this.visibility&&(this.visibility=e,this.damageBoundables())}getVisibility(){return this.visibility}getCullingState(){return this.cullingState}get culledMeshGroupIdSet(){const e=this.cullingState;return e&&e.size?e:null}setCullingState(e,t){if(!t)return void(this.cullingState=e);let i=this.culledMeshGroupIdSet;e===Js.uc.CULLED?(i||(i=new Set,this.cullingState=i),i.add(t)):i&&(i.delete(t),0===i.size&&(this.cullingState=Js.uc.VISIBLE))}getMeshGroupCullingState(e){if(this.cullingState===Js.uc.VISIBLE||this.cullingState===Js.uc.CULLED)return this.cullingState;const t=this.culledMeshGroupIdSet;return t&&t.has(e)?Js.uc.CULLED:Js.uc.VISIBLE}isStyledRangeCulled(e,t){const i=e.getMeshRangesGroupId();return this.isMeshGroupCulled(i,t)}isMeshGroupCulled(e,t){return this.cullingState!==Js.uc.VISIBLE&&t.getUsage()===Ls.L.BASE&&(this.cullingState===Js.uc.CULLED||!!e&&this.getMeshGroupCullingState(e)===Js.uc.CULLED)}isVisible(e){return!(this.cullingState===Js.uc.CULLED&&e.getUsage()===Ls.L.BASE)&&(e.isHighlighting()?this.hasHighlight():this.visibility===Js.EE.VISIBLE)}isBoundable(){return this.visibility===Js.EE.VISIBLE||this.hasHighlight()}isIncrementBoundable(e,t){const i=this.getHiddenRangesForUsage(t),s=this.getHighlightsForUsage(t),n=!!i&&i.containsIncrement(e),r=!!s&&s.entityHasHighlight(e);return!n||r}hasHighlight(){let e=!1;return this.baseHighlights&&(e=this.baseHighlights.hasHighlight()),this.previewHighlights&&(e=e||this.previewHighlights.hasHighlight()),e}getOrCreateHiddenRangesForUsage(e){return e===Ls.L.BASE?(this.hiddenBaseMeshRanges||(this.hiddenBaseMeshRanges=new VS(this.occurrenceId+".hiddenBaseMeshRanges")),this.hiddenBaseMeshRanges):(this.hiddenPreviewMeshRanges||(this.hiddenPreviewMeshRanges=new VS(this.occurrenceId+".hiddenPreviewMeshRanges")),this.hiddenPreviewMeshRanges)}getHiddenRangesForUsage(e){return e===Ls.L.BASE?this.hiddenBaseMeshRanges:this.hiddenPreviewMeshRanges}getOrCreateHiddenFromPickRangesForUsage(e){return e===Ls.L.BASE?(this.hiddenFromPickBaseMeshRanges||(this.hiddenFromPickBaseMeshRanges=new VS(this.occurrenceId+".hiddenFromPickBaseMeshRanges")),this.hiddenFromPickBaseMeshRanges):(this.hiddenFromPickPreviewMeshRanges||(this.hiddenFromPickPreviewMeshRanges=new VS(this.occurrenceId+".hiddenFromPickPreviewMeshRanges")),this.hiddenFromPickPreviewMeshRanges)}getHiddenFromPickRangesForUsage(e){return e===Ls.L.BASE?this.hiddenFromPickBaseMeshRanges:this.hiddenFromPickPreviewMeshRanges}hideIncrement(e,t){this.getOrCreateHiddenRangesForUsage(t).onIncrementAdded(e)&&this.damageBoundables()}showIncrement(e,t){const i=this.getHiddenRangesForUsage(t);i&&i.onIncrementRemoved(e)&&this.damageBoundables()}isIncrementHidden(e,t){const i=this.getHiddenRangesForUsage(t);return!!i&&i.containsIncrement(e)}hideIncrementFromPick(e,t){this.getOrCreateHiddenFromPickRangesForUsage(t).onIncrementAdded(e)}isIncrementHiddenFromPick(e,t){const i=this.getHiddenFromPickRangesForUsage(t);return!!i&&i.containsIncrement(e)}resetHiddenFromPick(){this.hiddenFromPickBaseMeshRanges&&(this.hiddenFromPickBaseMeshRanges.destroy(),this.hiddenFromPickBaseMeshRanges=null),this.hiddenFromPickPreviewMeshRanges&&(this.hiddenFromPickPreviewMeshRanges.destroy(),this.hiddenFromPickPreviewMeshRanges=null)}getOrCreateHighlightsForUsage(e){return e===Ls.L.BASE?(this.baseHighlights||(this.baseHighlights=new uS),this.baseHighlights):(this.previewHighlights||(this.previewHighlights=new uS),this.previewHighlights)}getBaseOccurrenceHighlight(){return this.baseHighlights?this.baseHighlights.getHighestPriorityOccurrenceHighlight():null}getHighlightsForUsage(e){return e===Ls.L.BASE?this.baseHighlights:this.previewHighlights}updateEntityHighlight(e,t,i,s){const n=this.hasHighlight();this.getOrCreateHighlightsForUsage(s).updateEntityHighlight(e,t,i),n!==this.hasHighlight()&&this.damageBoundables()}updateOccurrenceHighlight(e,t,i){const s=this.hasHighlight();this.getOrCreateHighlightsForUsage(i).updateOccurrenceHighlight(e,t),s!==this.hasHighlight()&&this.damageBoundables()}clearHighlight(e,t){const i=this.hasHighlight(),s=this.getHighlightsForUsage(t);s&&s.clearHighlight(e),i!==this.hasHighlight()&&this.damageBoundables()}clearAllOccurrenceLevelHighlights(){this.hasHighlight()&&(this.baseHighlights&&this.baseHighlights.clearAllOccurrenceLevelHighlights(),this.previewHighlights&&this.previewHighlights.clearAllOccurrenceLevelHighlights(),this.damageBoundables())}getEntityHighlights(e,t){const i=this.getHighlightsForUsage(t);return i?i.getEntityHighlights(e):null}removeEntityHighlights(e,t){const i=this.getHighlightsForUsage(t);i&&i.removeEntityHighlights(e)}getMeshRangeOperator(e){if(e.isHighlighting()){const t=this.getHighlightsForUsage(e.getUsage());return t?t.getHighlightOperator(e):AE}if(e.isPicking()){const t=this.getHiddenRangesForUsage(e.getUsage()),i=this.getHiddenFromPickRangesForUsage(e.getUsage());return i&&t?(jr.resetWithOperands(t,i),jr):t||i}{e.applyStyle(lS);const t=this.getHighlightsForUsage(e.getUsage()),i=this.getHiddenRangesForUsage(e.getUsage());return t?t.getHighlightStyleOperator(e,i):i}}addBoundable(e){this.boundables.add(e)}removeBoundable(e){this.boundables.delete(e)}damageBoundables(){for(const e of this.boundables.values())e.damageBounds()}makeSceneDebugObject(){const e="Occurrence "+this.occurrenceId,t=[];return t.push((0,Js.z4)("transform",this.transform)),t.push((0,Js.z4)("isolated",this.isolated)),t.push((0,Js.z4)("clippedBySectionPlane",this.isClippedBySectionPlane)),t.push((0,Js.z4)("lod",this.lod)),t.push((0,Js.z4)("visibility",(0,Js._I)(this.visibility))),t.push((0,Js.z4)("cullingState",this.cullingState instanceof Set?Array.from(this.cullingState).toString():(0,Q.getKeyForValue)(Js.uc,this.cullingState))),t.push((0,Js.z4)("shouldSetOccurrenceUniform",this.shouldSetOccurrenceUniform)),this.hiddenBaseMeshRanges&&t.push(this.hiddenBaseMeshRanges.makeSceneDebugObject()),this.hiddenPreviewMeshRanges&&t.push(this.hiddenPreviewMeshRanges.makeSceneDebugObject()),this.hiddenFromPickBaseMeshRanges&&t.push(this.hiddenFromPickBaseMeshRanges.makeSceneDebugObject()),this.hiddenFromPickPreviewMeshRanges&&t.push(this.hiddenFromPickPreviewMeshRanges.makeSceneDebugObject()),this.baseHighlights&&t.push(this.baseHighlights.makeSceneDebugObject("baseHighlights")),this.previewHighlights&&t.push(this.previewHighlights.makeSceneDebugObject("previewHighlights")),{text:e,children:t}}getIsClippedBySectionPlanes(){return this.isClippedBySectionPlane}setIsClippedBySectionPlanes(e){this.isClippedBySectionPlane=e}}var $r=i(20516),Jr=i(58749),ea=i(43258),ta=i(73008),ia=i(39303);const sa=!1;function na(e){sa?It.log.info&&It.log.info(e):It.log.trace&&It.log.trace(e)}var ra;function aa(e,t,i,s){return e+"."+t+"."+i+"."+s}!function(e){e.NORMAL="NORMAL",e.FLATTENED="FLATTENED"}(ra||(ra={}));let oa=null;function ha(){if((0,Et.supportsIndexedDb)(window))try{let e=new ea.ZP("GraphicsDetailSettings");e.version(1).stores({settings:"[viewerUsage+workspaceOrVersionId+elementId+modelUsage], enableSSAOFilter, enableEdgeSilhouettes, enableSSAO, enableBackfaceSilhouettes, enableLowestLodSwitching, enableSectionPlaneEdgeDetection"}),e.version(2).stores({settings:"[viewerUsage+workspaceOrVersionId+elementId+modelUsage], enableSSAOFilter, enableEdgeSilhouettes, enableSSAO, enableBackfaceSilhouettes, enableLowestLodSwitching, enableSectionPlaneEdgeDetection, lowLevelBodyProportion"}).upgrade((function(e){e.settings.toCollection().modify((function(e){e.lowLevelBodyProportion=0}))})),e.version(3).stores({settings:"[viewerUsage+workspaceOrVersionId+elementId+modelUsage], enableSSAOFilter, enableEdgeSilhouettes, enableSSAO, enableBackfaceSilhouettes, enableSectionPlaneEdgeDetection, lowLevelBodyProportion"}).upgrade((function(e){e.settings.toCollection().modify((function(e){delete e.enableLowestLodSwitching}))})),e.open().then((function(){na("Opened graphics detail database")})).catch((function(t){e=null,It.log.warn("Failed to open graphics detail database: "+t)})),oa=e}catch(e){oa=null,It.log.warn("Exception while creating settings database: "+e)}}ha();const ca=q.default.getManager().getNumber("MAX_LOW_LEVEL_BODY_PROPORTION"),la=q.default.getManager().getNumber("LOW_LEVEL_BODY_PROPORTION_STEP");class ua{constructor(e,t,i,s){this.CLONING_PROPERTIES_TO_SKIP={viewerUsage:!0,workspaceOrVersionId:!0,elementId:!0,modelUsage:!0,enableSSAOFilter:!0},this.enableSSAOFilter=!1,this.enableEdgeSilhouettes=!0,this.enableSSAO=!0,this.enableBackfaceSilhouettes=!0,this.lowLevelBodyProportion=0,this.enableSectionPlaneEdgeDetection=!0,this.viewerUsage=e||ra.NORMAL,this.workspaceOrVersionId=t||"",this.elementId=i||"",this.modelUsage=s||W.rvN.BASE}getKeyPath(){return[this.viewerUsage,this.workspaceOrVersionId,this.elementId,this.modelUsage]}getKeyString(){return aa(this.viewerUsage,this.workspaceOrVersionId,this.elementId,this.modelUsage)}persistSettings(){oa?(na("Saving detail settings for "+this.getKeyString()),oa.settings.put(this).catch((function(e){na("Save failed: "+e)}))):na("Database not available for persisting settings "+this.getKeyString())}updateFromDatabase(e){const t=$r.defer();return oa?oa.settings.get(this.getKeyPath()).then((t=>{t?(na("Got saved details settings for "+this.getKeyString()+": "+JSON.stringify(t)),(0,Q.overwriteMatchingProperties)(this,t)):(e?(na("No saved details settings for "+this.getKeyString()+" - initializing from "+e.getKeyString()),(0,Q.overwriteMatchingProperties)(this,e,this.CLONING_PROPERTIES_TO_SKIP)):na("No saved details settings for "+this.getKeyString()+" - creating new settings"),this.persistSettings())})).catch((function(e){It.log.info("Failed to retrieve graphics detail settings: "+e)})).finally((function(){t.resolve()})):(na("Settings database not available for updating settings"),t.resolve()),t.promise}decreaseDetail(){let e=!1;return this.enableEdgeSilhouettes||this.enableSectionPlaneEdgeDetection?(this.enableEdgeSilhouettes=!1,this.enableSectionPlaneEdgeDetection=!1,e=!0,na("Decreasing graphics detail: dropped edge-based silhouettes and section plane edges")):this.enableSSAO?(this.enableSSAO=!1,e=!0,na("Decreasing graphics detail: dropped ambient occlusion")):this.enableBackfaceSilhouettes?(this.enableBackfaceSilhouettes=!1,e=!0,na("Decreasing graphics detail: dropped image-based silhouettes")):this.lowLevelBodyProportion<ca&&(this.lowLevelBodyProportion=Math.min(this.lowLevelBodyProportion+la,ca),na("Decreasing graphics detail: Increased lowest LOD proportion to: "+this.lowLevelBodyProportion),e=!0),e&&this.persistSettings(),e}increaseDetail(e,t){let i=!1;this.lowLevelBodyProportion>0?(this.lowLevelBodyProportion=Math.max(0,this.lowLevelBodyProportion-la),na("Increasing graphics detail: decreased lowest LOD proportion to: "+this.lowLevelBodyProportion),i=!0):!this.enableBackfaceSilhouettes&&t?(this.enableBackfaceSilhouettes=!0,i=!0,na("Increasing graphics detail: adding image-based silhouettes")):!this.enableSSAO&&e?(this.enableSSAO=!0,i=!0,na("Increasing graphics detail: enabled ambient occlusion")):!this.enableEdgeSilhouettes&&t?(this.enableEdgeSilhouettes=!0,i=!0,na("Increasing graphics detail: enabled edge based silhouette edges")):this.enableSectionPlaneEdgeDetection||(this.enableSectionPlaneEdgeDetection=!0,i=!0,na("Increasing graphics detail: enabled section plane edges")),i&&this.persistSettings()}}class da{constructor(e,t,i){this.AnalyticsService=e,this.viewer=t,this.frameTimer=i,this.REDUCTION_THRESHOLD_MS=1e3/q.default.getManager().getNumber("DETAIL_REDUCTION_THRESHOLD_FPS"),this.ENHANCEMENT_THRESHOLD_MS=1e3/q.default.getManager().getNumber("DETAIL_ENHANCEMENT_THRESHOLD_FPS"),this.FULL_DETAIL_OCCURRENCE_REDUCTION_THRESHOLD=q.default.getManager().getNumber("FULL_DETAIL_OCCURRENCE_REDUCTION_THRESHOLD"),this.RENDER_PERFORMANCE_WARNING_TIMEOUT_SECONDS=q.default.getManager().getNumber("RENDER_PERFORMANCE_WARNING_TIMEOUT_SECONDS"),this.RENDER_PERFORMANCE_CLEAR_WARNING_TIMEOUT_SECONDS=q.default.getManager().getNumber("RENDER_PERFORMANCE_CLEAR_WARNING_TIMEOUT_SECONDS"),this.detailSettings={},this.activeInteractiveKey="",this.lastInteractiveTimingActedOn=-1,this.overrideSettings=null,this.disableInterativeUpdates=!1,this.renderingPerformanceMessageEnabled=!0,this.renderingPerformanceMessageTimeout=null,this.clearRenderingPerformanceMessageTimeout=null,this.clientVersion=null,this.viewerUsage=t.getIsForFlattenedDisplay()?ra.FLATTENED:ra.NORMAL,this.detailSettings[ia.Q.FULL]=new ua(this.viewerUsage),this.detailSettings[ia.Q.FULL].enableSSAOFilter=!0}onSettingStateChange(){const e=ps.Jq.StateParameterService.workspaceId()||ps.Jq.StateParameterService.versionId()||"",t=ps.Jq.StateParameterService.elementId()||"",i=Ks(),s=aa(this.viewerUsage,e,t,i);s!==this.activeInteractiveKey&&(na("Switching to detail settings for "+s),this.activeInteractiveKey=s,this.lastInteractiveTimingActedOn=-1)}ensureInteractiveSettingsExist(){if(this.detailSettings[this.activeInteractiveKey]){const e=$r.defer();return e.resolve(),e.promise}{const e=ps.Jq.StateParameterService.workspaceId()||ps.Jq.StateParameterService.versionId()||"",t=ps.Jq.StateParameterService.elementId()||"",i=Ks();na("Initializing detail settings for "+this.activeInteractiveKey);const s=aa(this.viewerUsage,e,t,W.rvN.BASE),n=this.detailSettings[s]||this.detailSettings[ia.Q.FULL],r=new ua(this.viewerUsage,e,t,i);return this.detailSettings[this.activeInteractiveKey]=r,r.updateFromDatabase(n).then((()=>{r.enableSSAO&&!this.isInteractiveSsaoEnabled()&&(na("Ambient occlusion disabled for interactive frames due to performance issues"),r.enableSSAO=!1),!r.enableBackfaceSilhouettes&&!r.enableEdgeSilhouettes||this.areInteractiveSilhouettesEnabled()||(na("Silhouette Edges disabled for interactive frames due to performance issues"),r.enableBackfaceSilhouettes=!1,r.enableEdgeSilhouettes=!1)}))}}forceLowestDetailSettings(e){this.ensureInteractiveSettingsExist();const t=this.detailSettings[this.activeInteractiveKey];t.enableSSAOFilter=!1,t.enableEdgeSilhouettes=!1,t.enableSSAO=!1,t.enableBackfaceSilhouettes=!1,t.enableSectionPlaneEdgeDetection=!1,t.lowLevelBodyProportion=ca,e&&t.persistSettings()}increaseDetail(){this.disableInterativeUpdates=!0,this.detailSettings[this.activeInteractiveKey].increaseDetail(this.isInteractiveSsaoEnabled(),this.areInteractiveSilhouettesEnabled())}decreaseDetail(){this.disableInterativeUpdates=!0,this.detailSettings[this.activeInteractiveKey].decreaseDetail()}getDetailSettings(){if(this.overrideSettings)return this.overrideSettings;let e=ia.Q.FULL;return this.frameTimer.userIsInteracting()?(this.updateInteractiveSettings(),e=this.activeInteractiveKey):this.frameTimer.userIsManipulating()&&(e=this.activeInteractiveKey),this.detailSettings[e]?this.detailSettings[e]:(It.log.warn("Could not find detail settings for key: "+e),this.detailSettings[ia.Q.FULL])}getInteractiveSettings(){return this.ensureInteractiveSettingsExist(),this.detailSettings[this.activeInteractiveKey]}updateInteractiveSettings(){if(this.disableInterativeUpdates)return;this.ensureInteractiveSettingsExist();const e=this.frameTimer.getDrawLoopDetails(ia.Q.INTERACTIVE),t=this.frameTimer.getTimingDetails(ia.Q.INTERACTIVE);if(this.lastInteractiveTimingActedOn<0)return void(this.lastInteractiveTimingActedOn=t.timingCount);const i=t.timingCount-this.lastInteractiveTimingActedOn;if(e.averageTime>this.REDUCTION_THRESHOLD_MS)this.detailSettings[this.activeInteractiveKey].decreaseDetail(),e.reset();else if(i>=2)if(t.averageTime>this.REDUCTION_THRESHOLD_MS){const e=this.detailSettings[this.activeInteractiveKey].decreaseDetail();this.lastInteractiveTimingActedOn=t.timingCount,e&&!$t(this.viewer.getGlContext())||this.startRenderingPerformanceMessageTimeout()}else t.averageTime<this.ENHANCEMENT_THRESHOLD_MS?(this.detailSettings[this.activeInteractiveKey].increaseDetail(this.isInteractiveSsaoEnabled(),this.areInteractiveSilhouettesEnabled()),this.lastInteractiveTimingActedOn=t.timingCount,this.startClearRenderingPerformanceMessageTimeout()):this.startClearRenderingPerformanceMessageTimeout()}isInteractiveFramerateBelowThreshold(){const e=this.frameTimer.getDrawLoopDetails(ia.Q.INTERACTIVE),t=this.frameTimer.getTimingDetails(ia.Q.INTERACTIVE);return e.timingCount>0&&e.averageTime>this.REDUCTION_THRESHOLD_MS||t.timingCount>0&&t.averageTime>this.REDUCTION_THRESHOLD_MS}isInteractiveSsaoEnabled(){if((0,Et.isPlatformMetaQuest)())return!1;const e=this.viewer.getRendererInfo();if(!e)return!0;const t=/AMD/gi.test(e.glRenderer)||(0,Et.isBrowserFirefox)()&&/Radeon/gi.test(e.glRenderer)&&/ATI Technologies/gi.test(e.glVendor),i=/Apple GPU/gi.test(e.glRenderer);return!((0,Et.isPlatformMac)()&&(t||i&&(0,Et.isBrowserSafari)()))}areInteractiveSilhouettesEnabled(){return!(0,Et.isBrowserSafari)()||15!==(0,Et.getSafariVersion)()}setOverrideSettings(e){this.overrideSettings=e}updateFromLoadedScene(){const e=this.viewer.getModelViewManagers().getManager().getModelStatistics(!1),t=e.partOccurrences+e.surfaceOccurrences+e.curveOccurrences,i=this.detailSettings[ia.Q.FULL],s=!i.enableEdgeSilhouettes;t>=this.FULL_DETAIL_OCCURRENCE_REDUCTION_THRESHOLD?(s||na("Reducing full detail rendering settings due to large occurrence count: "+t),i.enableEdgeSilhouettes=!1,i.enableSSAO=!1,i.enableBackfaceSilhouettes=!1,i.enableSectionPlaneEdgeDetection=!1,this.viewer.getSilhouetteTask().clearPendingRequests()):(s&&na("Increasing full detail rendering settings due to smaller occurrence count: "+t),i.enableEdgeSilhouettes=!0,i.enableSSAO=!0,i.enableBackfaceSilhouettes=!0,i.enableSectionPlaneEdgeDetection=!0)}areFullDetailEdgeSilhouettesEnabled(){return this.detailSettings[ia.Q.FULL].enableEdgeSilhouettes}getClientVersion(){if(!this.clientVersion){const e=ps.Jq.ClientVersionService.getRunningVersion(),t=e.match(new RegExp("(\\d+\\.\\d+)","i"));t&&t.length>0?this.clientVersion=t[0]:this.clientVersion=e}return this.clientVersion}setRenderingPerformanceMessageEnabled(e){this.renderingPerformanceMessageEnabled=e}startRenderingPerformanceMessageTimeout(){if((0,Jr.Z)(this.clearRenderingPerformanceMessageTimeout)&&(window.clearTimeout(this.clearRenderingPerformanceMessageTimeout),this.clearRenderingPerformanceMessageTimeout=null),!this.renderingPerformanceMessageEnabled||(0,Jr.Z)(this.renderingPerformanceMessageTimeout)||this.viewer.hasPendingBodiesToLoad()||this.viewer.getIsForFlattenedDisplay())return;const e=""+(0,Et.getBrowserMajorVersion)(),t=this.getClientVersion();window.localStorage.getItem("osRenderPerformanceMessageBrowserVersion")===e&&window.localStorage.getItem("osRenderPerformanceMessageClientVersion")===t||(na("Starting render performance message timeout"),this.renderingPerformanceMessageTimeout=window.setTimeout((()=>{window.localStorage.setItem("osRenderPerformanceMessageBrowserVersion",e),window.localStorage.setItem("osRenderPerformanceMessageClientVersion",t);const i=ps.Jq.MessageBubbleService.createMessageBubble();i.showMessage(i18n("Reduced rendering performance detected."),void 0,i18n("Check system compatibility in a new tab")).then((()=>{this.AnalyticsService.trackEventForDocumentId("PERFORMANCE_MESSAGE","render_performance_action_click",(0,ta.n)());const e=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+"/check";window.open(e),i.dismissMessage()})),this.AnalyticsService.trackEventForDocumentId("PERFORMANCE_MESSAGE","render_performance_warning",(0,ta.n)()),this.renderingPerformanceMessageTimeout=null}),1e3*this.RENDER_PERFORMANCE_WARNING_TIMEOUT_SECONDS))}startClearRenderingPerformanceMessageTimeout(e){!e&&$t(this.viewer.getGlContext())||(0,Jr.Z)(this.clearRenderingPerformanceMessageTimeout)||!(0,Jr.Z)(this.renderingPerformanceMessageTimeout)||(na("Starting clear render performance message timeout"),this.clearRenderingPerformanceMessageTimeout=window.setTimeout((()=>{(0,Jr.Z)(this.renderingPerformanceMessageTimeout)&&(window.clearTimeout(this.renderingPerformanceMessageTimeout),this.renderingPerformanceMessageTimeout=null,na("Cleared performance message timeout")),this.clearRenderingPerformanceMessageTimeout=null}),1e3*this.RENDER_PERFORMANCE_CLEAR_WARNING_TIMEOUT_SECONDS))}}var ga=i(99534),pa=i(99093);const ma=window.document.createElement("canvas"),fa=window.document.createElement("canvas"),Ia={},Ea={};let Sa={};function Ta(e){Ea[e]=!0}function Ma(e){const t=(0,Js.Wj)(),i=Ia[e];return i&&t-i[0]<q.default.getManager().getNumber("THUMBNAIL_LOCAL_EXPIRATION_INTERVAL")?i[1]:null}function Ca(e,t){const i=(0,Js.Wj)();Ia[e]=[i,t]}function Da(e){delete Ia[e]}function va(e){Sa[e]=!0}const Pa=new ua;function ya(e,t,i,s){return e+"-"+t+"-"+i+"x"+s}function Aa(e,t,i,s){return e+"-"+t+"-"+i+"x"+s}function Oa(e,t,i,s){return e+"-"+t+"-"+i+"x"+s}function Ra(e,t,i,s){ma.width=e,ma.height=t,fa.width=e/s,fa.height=t/s;const n=ma.getContext("2d"),r=n.createImageData(e,t);r.data.set(i),n.putImageData(r,0,0);const a=fa.getContext("2d");return a.translate(0,t/s),a.scale(1/s,-1/s),a.drawImage(ma,0,0),fa.toDataURL()}function wa(e){const t=e.getPrimaryViewController().getZoomFitTargetCamera(e.getCamera().getFrame(),e.getFitBounds());e.pushCameraState(t),e.getBodyManager().updateForFrame(e.getRenderContext()),e.renderContext.prepareForNextFrame(),e.depthSamplingPass.retrieve(e.getRenderContext(),{includePlanes:!0,performIsolationTest:!0}),e.popCameraState();const i=[];for(let s=0;s<e.depthSamplingPass.points.length;++s)i.push(t.canvasToWorld(e.depthSamplingPass.points[s]));return i}function _a(e,t,i){if(!e.getCamera())return;const s=e.getModelViewManagers().getManager(),n=s.partStudios[s.getDisplayedFullElementId()];if(!n)return;pa.t.getController().pauseListeningForRedraw();const r=n.bodyComponent,a=n.sketchComponent,o=s.getDisplayedElementId(),h=ga.W.getSingleton().getComputedData(o),c=(0,Js.Wj)(),l=q.default.getManager().getNumber("THUMBNAIL_PART_RENDER_LIMIT"),u=q.default.getManager().getNumber("THUMBNAIL_PART_RENDER_TIME_LIMIT");n.removeInContextAssemblies();const d=e.getGlContext();if(!d)return;const g=e.getOrCreateFrameBuffer(d.UNSIGNED_BYTE,"",{storageType:d.DEPTH_STENCIL,attachmentType:d.DEPTH_STENCIL_ATTACHMENT});e.setUserIsManipulatingWithTimeout(),e.detailManager.setOverrideSettings(Pa),e.getEventDispatcher().trigger(VM.gV);const p=e.getRenderingMode();e.setRenderingMode(W.P1.SHADED_WITH_EDGES),e.getIsolatedOccurrenceManager().clearAllIsolateNoAnimation();const m=e.getFilteredEntitiesHighlightController();let f=!1;m&&(f=m.getIsEnabled(),e.disableCurrentLaminarHighlightController());const I=e.getPrimaryViewController();I.isPerspective()&&e.setPrimaryViewController(I.getMatchingOrthographicController()),e.viewManipulator&&e.viewManipulator.hide();const E=e.getCamera().clone();let S=null;const T=(0,Js.Z)();(0,Js.uP)(!1);const M=n.getHideableFeatureIds(),C=[];for(const e in r.bodyMetaData){const t=r.retrieveBodyMetaData(e);t&&t.shouldProduceLocalThumbnail()&&C.push(e)}const D=[];for(const e in n.sketchComponent.sketchToSketchEntityMapping)Sa[e]&&D.push(e);const y=h?D.length:0,A=function(e,t,i,s){t&&t.forEach((t=>{const n=e.extractMeshIncrement(t);if(n){const e=v.create();for(let t=0;t<n.points.length;t+=3*i)e[0]=n.points[t],e[1]=n.points[t+1],e[2]=n.points[t+2],s(e)}return!1}))},O=ya(o,s.displayedElementMicroversionIdAndConfiguration.getKey(),t,i),R=!(O in Ia);let w=0;const _=!1;for(let e=0;e<C.length&&w<l;e++){Aa(o,C[e],t,i)in Ea&&w++}if(R||w>0||y>0){r.getDecalComponent().removeFromScene();for(const e in n.sketchComponent.sketchToSketchEntityMapping)n.imageComponent.onSketchHidden(e);n.planeComponent.getHideableFeatureIds().forEach((function(e){n.planeComponent.hideShowFeature(e,Js.EE.HIDDEN)}));const t=n.pointBodyComponent.featureToIds.firstKey();t&&n.pointBodyComponent.hideShowFeature(t,Js.EE.HIDDEN),n.mateConnectorComponent.getHideableFeatureIds().forEach((function(e){n.mateConnectorComponent.hideShowFeature(e,Js.EE.HIDDEN)})),e.getEdgePointController()&&(e.getEdgePointController().removeAllEdgePointUiElements((0,ve.vi)()),e.getEdgePointController().purgeEdgePointUiElements()),S=(0,QS.o_)(o),e.viewController.setStandardView("Trimetric")}const N=wa(e),b=P.fromValues(0,0,2*t,2*i),L=[1,1,2*t-2,2*i-2];e.setBaseFrameBuffer(g),e.renderContext.pushViewport(b),e.getCamera().setViewport(b),g.update(e.renderContext,b[2],b[3]);const F=g.width*g.height*4,x=new Uint8Array(F);if(g.bindBuffer(),R&&(e.getCamera().zoomToFit(N,1.05,L),e.draw(),d.readPixels(0,0,g.width,g.height,d.RGBA,d.UNSIGNED_BYTE,x),Ca(O,Ra(g.width,g.height,x,2))),w>0||y>0){for(let e=0;e<M.length;e++)for(let t=0;t<n.components.length;++t)n.components[t].hasFeature(M[e])&&(M[e]in n.sketchComponent.sketchToSketchEntityMapping?n.hideSketch(M[e]):n.components[t].hideShowFeature(M[e],Js.EE.HIDDEN));for(const e in r.partStudioBodyIdToOccurrenceId)r.setBodyCullingState(r.partStudioBodyIdToOccurrenceId[e],Js.uc.CULLED,e,_);e.getBodyManager().setVisible(!1)}if(w>0){e.viewController.setStandardView("Trimetric");let s=0;for(let n=0;n<C.length&&s<l&&(0,Js.Es)(c)<u;n++){const a=Aa(o,C[n],t,i);if(a in Ea){const t=r.retrieveBodyMetaData(C[n]);let i=[];t.isOpenCompositeBody?i=r.getInstantiableConstituentIds(t):i.push(C[n]);let o=null;if(t.isComposite){o=[];for(let e=0;e<t.constituentBodyIds.length;++e){r.bodyToEntity.get(t.constituentBodyIds[e])&&(o=o.concat(r.bodyToEntity.get(t.constituentBodyIds[e]).getKeys()))}}else o=r.bodyToEntity.get(C[n]).getKeys();for(let e=0;e<i.length;++e)r.setBodyCullingState(r.partStudioBodyIdToOccurrenceId[i[e]],Js.uc.VISIBLE,i[e],_),r.hideShowBody(i[e],Js.EE.VISIBLE,r.partStudioBodyIdToOccurrenceId[i[e]]);const h=2,c=1;e.getCamera().zoomToFit(A.bind(void 0,r,o,h),c,L),e.draw(0,{skipUpdateBodyCulling:!0}),d.readPixels(0,0,g.width,g.height,d.RGBA,d.UNSIGNED_BYTE,x),Ca(a,Ra(g.width,g.height,x,2));for(let e=0;e<i.length;++e)r.setBodyCullingState(r.partStudioBodyIdToOccurrenceId[i[e]],Js.uc.CULLED,i[e],_);delete Ea[a],s++}}}if(y>0)for(let s=0;s<D.length&&!((0,Js.Es)(c)>=u);++s){const r=D[s],c=h.computedData[r];if(c&&c.planeMatrix){let s;const h=a.featureToIds.get(r);if(h&&(s=h.getKeys()),!s)continue;const l=Oa(o,r,t,i);n.sketchComponent.hideShowFeature(r,Js.EE.VISIBLE);const u=c.planeMatrix,p=[u.m00,u.m10,u.m20,0,u.m01,u.m11,u.m21,0,u.m02,u.m12,u.m22,0,0,0,0,1],m=e.getCamera().clone();m.setFrame(p),e.getCamera().copyFrom(m),e.getCamera().zoomToFit(A.bind(void 0,a,s,1),1.05,L),e.draw(0,{skipUpdateBodyCulling:!0}),d.readPixels(0,0,g.width,g.height,d.RGBA,d.UNSIGNED_BYTE,x),Ca(l,Ra(g.width,g.height,x,2)),n.sketchComponent.hideShowFeature(r,Js.EE.HIDDEN)}}e.setBaseFrameBufferToDefault(),g.unbindBuffer(),g.destroy(),e.renderContext.popViewport(),e.getCamera().copyFrom(E),e.viewManipulator&&e.viewManipulator.show(),e.detailManager.setOverrideSettings(null),e.setRenderingMode(p),e.setPrimaryViewController(I),e.getBodyManager().setVisible(!0),S&&(0,QS.Wh)(S,o),f&&(e.setFilteredEntitiesHighlightController(m),m.enable()),(0,Js.uP)(T),pa.t.resumeListeningForRedraw();const B=(0,Js.Wj)();Sa={},e.getEventDispatcher().trigger(VM.Xc),It.log.trace("thumbnailgenerator.generateThumbnail time "+(B-c))}Pa.enableSSAO=!1,Pa.enableEdgeSilhouettes=!1,Pa.enableBackfaceSilhouettes=!1;var Na=i(49635);class ba extends Ri{constructor(e,t){super((0,Q.as)(fT,t),e.sceneGraphId),this.texture=null,this.text="",this.offsetAdjustmentFunction=null,this.drawBox=!1,this.boxOffsetPixels=0,this.backgroundColor=[1,1,1,1],this.backgroundOpacity=0,this.updateOnEachFrame=!0,this.origin=e.origin,this.right=e.right,this.up=e.up,this.heightPx=e.heightPx,this.orientToScreen=!!e.orientToScreen,this.offsetUp=void 0!==e.offsetUp?e.offsetUp:Li.iK.MID,this.offsetRight=void 0!==e.offsetRight?e.offsetRight:Li.iK.MID,this.orientToScreen&&(this.right=[1,0,0],this.up=[0,0,1]);const i=q.default.getManager();this.color=e.color||i.getColor("DEFAULT_TEXT_COLOR"),this.font=e.font||i.getString("DEFAULT_TEXT_FONT"),this.material=Xi(),this.nodeProperties=new Qi(Object.assign({},{isPickable:!1,isTwoSided:!0,primitiveType:_i.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!1,material:this.material},e.textNodePropertyOptions||{})),this.boxNodeProperties=new Qi(Object.assign({},{isPickable:!1,primitiveType:_i.MX.LINES},e.boxNodePropertyOptions||{}))}remove(){this.destroyText(),this.material&&(this.material.destroy(),this.material=null),super.remove()}destroyText(){this.texture&&(this.texture.destroy(),this.texture=null)}setOffsetAdjustmentFunction(e){const t=this.offsetAdjustmentFunction;return this.offsetAdjustmentFunction=e,t}setDrawBox(e,t,i,s){this.drawBox=e,t&&(this.boxOffsetPixels=t),i&&(this.backgroundColor=i),s&&(this.backgroundOpacity=s),e||this.removeMeshIncrement("box")}setHeightPx(e){this.setHeightAndColor(e)}setText(e){this.text!==e&&(this.destroyText(),this.text=e,this.texture=Go(this.viewer,e,{color:this.color,font:this.font,size:this.heightPx}),this.material.ambientTexture=this.texture,(0,Js.vm)())}setHeightAndColor(e,t){let i=!1;t&&this.color!==t&&(this.color=t,i=!0),e&&this.heightPx!==e&&(this.heightPx=e,i=!0),i&&this.text&&(this.destroyText(),this.drawBox?this.texture=Go(this.viewer,this.text,{color:this.color,font:this.font,size:this.heightPx,paddingWithinBorder:this.boxOffsetPixels,backgroundColor:this.backgroundColor,backgroundOpacity:this.backgroundOpacity}):this.texture=Go(this.viewer,this.text,{color:this.color,font:this.font,size:this.heightPx}),this.material.ambientTexture=this.texture,(0,Js.vm)())}onViewWillDraw(e){if(!this.texture)return;if(!this.updateOnEachFrame&&this.hasMeshIncrements())return;const t=this.getTextCorners(e);if(this.updateMeshIncrement("text",yi,this.createScreenSpaceQuad(e,t.lowerLeft,t.lowerRight,t.upperLeft),this.nodeProperties),this.orientToScreen){const t=v.clone(e.getUp()),i=v.create();v.normalize(i,v.cross(i,e.getForward(),t));const s=v.create();v.normalize(s,v.cross(s,t,i));const n=ge.fromValues(i[0],i[1],i[2],0,s[0],s[1],s[2],0,t[0],t[1],t[2],0,this.origin[0],this.origin[1],this.origin[2],1);this.setTransform(n)}if(this.drawBox){const e=pe.S4.scale(pe.S4.subtract(t.lowerRight,t.lowerLeft,v.create()),.5),i=pe.S4.scale(pe.S4.subtract(t.upperLeft,t.lowerLeft,v.create()),.5),s=pe.S4.scale(pe.S4.add(t.lowerRight,t.upperLeft,v.create()),.5);this.updateMeshIncrement("box",yi,Ru(s,e,i,this.color,1),this.boxNodeProperties)}}getTextCorners(e){const t=this.origin;this.transform&&pe.w$.multiplyVec3(this.transform,this.origin,v.create());const i=e.getPixelSizeAtWorldPoint(t);let s=this.origin;this.orientToScreen&&(s=this.getOffsetOrigin(i));let n=new Ms.vjd;return n.pixelSize=i,n.lowerLeft=v.clone(s),n.lowerRight=pe.S4.add(pe.S4.scale(this.right,i*this.texture.filledWidthPx,v.create()),s),n.upperLeft=pe.S4.add(pe.S4.scale(this.up,i*this.texture.filledHeightPx,v.create()),s),this.offsetAdjustmentFunction&&(n=this.offsetAdjustmentFunction(n)),n}getOffsetOrigin(e){return[-this.offsetRight*e*this.texture.filledWidthPx,0,-this.offsetUp*e*this.texture.filledHeightPx]}createScreenSpaceQuad(e,t,i,s){const n=this.orientToScreen?[!1,!1]:Lo(e,this.right,this.up,this.transform);return Ou(t,i,s,void 0,[n[0]?this.texture.rightCoordinate:this.texture.leftCoordinate,n[1]?this.texture.topCoordinate:this.texture.bottomCoordinate],[n[0]?this.texture.leftCoordinate:this.texture.rightCoordinate,n[1]?this.texture.bottomCoordinate:this.texture.topCoordinate])}}class La extends Ri{constructor(e,t,i){super(e,sh.EG),this.text=t,this.options=i,this.texture=null,this.material=Xi(),this.nodeProperties=new Qi({isPickable:!0,primitiveType:_i.MX.TRIANGLES,material:this.material}),this.updateWithOptions(i)}hasEqualTextAndOptions(e,t){return this.text===e&&(0,an.Z)(this.options,t)}remove(){var e;super.remove(),null===(e=this.texture)||void 0===e||e.destroy(),this.material.destroy()}updateWithOptions(e){this.texture=Go(this.viewer,this.text,e),this.material.ambientTexture=this.texture;const t=this.texture.createTexturedQuad();this.bounds=t.getBounds(),this.options=e,this.updateMeshIncrement("text",La.SELECTION_ID,t,this.nodeProperties),this.updatePosition()}getDiagonalVector(e){return this.bounds.diagonalVector(e)}positionRelativeTo(e,t,i){this.anchorPoint=v.clone(e),this.textAttachmentSpotX=t,this.textAttachmentSpotY=i,this.updatePosition()}updatePosition(){if(this.anchorPoint){const e=Li.iK.LOW,t=this.bounds.getLocationInBox(this.textAttachmentSpotX,this.textAttachmentSpotY,e);this.setTransform(pe.w$.translate(ge.create(),pe.S4.subtract(this.anchorPoint,t,t)))}}getTextCenterInCanvas(){const e=this.bounds.createTransformedCopy(this.transform).center(),t=this.viewer.getCamera(),i=(0,Es.x_)();return[e[0]/i,(t.getCanvasHeight()-e[1])/i]}getTransformedBounds(){return this.bounds.createTransformedCopy(this.transform)}}La.SELECTION_ID="text";var Fa=i(40904),xa=i(32659);let Ba=!1;class Ua{constructor(){this.rayAperture=0,this.hitSelectionOnly=!1,this.mouseCreated=!1,this.mouseIsInMotion=!1,this.hitTestRay=new Li.zH([0,0,0],[0,0,0]),this.connexion=new _3Dconnexion(this),this.connexion.connect()||It.log.trace("Failed to initialize connection to 3Dconnexion NL-Proxy")}logMatrix(e,t){const i=function(t){return e[t].toFixed(2)};console.group(t),console.log(i(0)+" "+i(1)+" "+i(2)+" "+i(3)),console.log(i(4)+" "+i(5)+" "+i(6)+" "+i(7)),console.log(i(8)+" "+i(9)+" "+i(10)+" "+i(11)),console.log(i(12)+" "+i(13)+" "+i(14)+" "+i(15)),console.groupEnd()}logVector(e,t){console.group(t),console.log(e[0].toFixed(2)+" "+e[1].toFixed(2)+" "+e[2].toFixed(2)),console.groupEnd()}logNumber(e,t){console.group(t),console.log(e),console.groupEnd()}onConnect(){this.connexion.create3dmouse(window,"Onshape"),Ba=!0}onDisconnect(e){It.log.trace("3Dconnexion NL-Proxy disconnected: "+e)}getViewer(){return(0,Ih.N9)()}getViewController(){const e=this.getViewer();return e?e.getPrimaryViewController():null}getCamera(){const e=this.getViewer();return e?e.getCamera():null}checkState(e){return!!(this.getViewer()&&this.getViewController()&&this.getCamera())||(It.log.trace("Attempted to call spaceball."+e+" with no active document."),!1)}onViewerDraw(e,t){this.checkState("onViewerDraw")&&this.mouseCreated&&this.mouseIsInMotion&&e===this.getViewer()&&this.connexion.update3dcontroller({frame:{time:t}})}getViewMatrix(){return this.checkState("getViewMatrix")?this.getCamera().getFrame():null}getConstructionPlane(){if(!this.checkState("getConstructionPlane"))return null;const e=this.getViewer().getSketch();let t=null;return e&&(t=(0,Li.sc)(e.getPlaneMatrix()),t=Array.prototype.slice.call(t)),t}getViewExtents(){return this.checkState("getViewExtents")?this.getCamera().isOrthographic()?this.getCamera().getExtents():(It.log.info("Tried to get view extents for a non-orthographic camera."),null):null}getFov(){return this.checkState("getFov")?this.getCamera().isOrthographic()?(It.log.info("Tried to get fov for an orthographic camera"),0):(0,Li.Yr)(this.getCamera().getFieldOfView()):0}getViewFrustum(){return this.checkState("getViewFrustum")?this.getCamera().isOrthographic()?(It.log.info("Tried to get frustum for an orthographic camera"),null):this.getCamera().getFrustum():null}getPerspective(){return!!this.checkState("getPerspective")&&this.getCamera().isPerspective()}getViewTarget(){if(!this.checkState("getViewTarget"))return null;const e=this.getCamera().getViewport();return this.getCamera().getRay(e[2]/2,e[3]/2).point}getModelExtents(){if(!this.checkState("getModelExtents"))return null;const e=this.getCamera().getSceneBounds();return e?[e.min[0],e.min[1],e.min[2],e.max[0],e.max[1],e.max[2]]:[-1,-1,-1,1,1,1]}getPivotPosition(){if(!this.checkState("getPivotPosition"))return null;const e=this.getViewController();return e.updateRotationPanCenterForSpaceball(),e.getRotateOrPanCenter()}getLookAt(){if(!this.checkState("getLookAt"))return null;const e=this.getViewer(),t=this.getCamera(),i=this.hitTestRay.evaluate(1),s=t.projectWorldPointToCanvas(i);s[2]=0;const n=t.canvasToWorld(s),r=this.rayAperture/2*t.getUnitSizeAtWorldPoint(n),a=t.getViewport(),o=a[2]*a[3]/q.default.getManager().getNumber("DEPTH_SAMPLES_PER_VIEWPORT"),h=Math.sqrt(o/2),c=(r+h)*(r+h);let l;l=this.hitSelectionOnly?e.retrieveHighlightsOnlyDepthSampling():e.retrieveDepthSampling();let u=null;const d=$.create();for(let e=0;e<l.length;e++){$.copy(d,[s[0]-l[e][0],s[1]-l[e][1]]);$.squaredLength(d)<c&&(!u||l[e][2]<u[2])&&(u=l[e])}return u?t.canvasToWorld(u):null}getSelectionEmpty(){return!this.checkState("getSelectionEmpty")||0===(0,Fa.vi)().size()}getSelectionExtents(){if(!this.checkState("getSelectionExtents"))return null;const e=new Li.kB;(0,Fa.vi)().each((t=>{e.addBox(this.getViewer().getSelectionFitBounds(t))}));const t=e.getMin(),i=e.getMax();return[t[0],t[1],t[2],i[0],i[1],i[2]]}getPointerPosition(){if(!this.checkState)return null;const e=this.getViewController().getPointerPosition();return this.getCamera().getRay(e[0],e[1]).point}getCoordinateSystem(){return[1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1]}getFrontView(){return[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1]}setViewMatrix(e){if(!this.checkState("setViewMatrix"))return;const t=this.getViewer();this.getCamera().setFrame(e),t.setUserIsAdjustingCamera(),t.getEventDispatcher().trigger(VM.h0)}setViewExtents(e){this.checkState("setViewExtents")&&(this.getCamera().isOrthographic()?this.getCamera().setExtents(e):It.log.info("Tried to get view extents for a non-orthographic camera."))}setFov(e){this.checkState("setFov")&&this.getCamera().setFieldOfView((0,Li.Ux)(e))}setPivotPosition(e){this.checkState("setPivotPosition")&&this.getViewController().setRotationPivotPosition(e)}setPivotVisible(e){this.checkState("setPivotVisible")}setLookFrom(e){this.hitTestRay.setPoint(e)}setLookDirection(e){this.hitTestRay.setDirection(e)}setLookAperture(e){this.rayAperture=e}setSelectionOnly(e){this.hitSelectionOnly=e}setTransaction(e){this.checkState("setTransaction")&&0===e&&this.getViewer().requestDraw()}onStartMotion(){this.checkState("onStartMotion")&&(this.mouseIsInMotion=!0,this.getViewer().setSuppressMouseMovePick(!0),(0,Fa.IQ)(),this.getViewController().setIsSpaceballMoving(!0),this.getViewer().requestDraw())}onStopMotion(){this.checkState("onStopMotion")&&(this.mouseIsInMotion=!1,this.getViewController().setIsSpaceballMoving(!1),this.getViewer().setSuppressMouseMovePick(!1),this.getViewer().doPreHighlightPick())}setActiveCommand(e){e&&(0,VM.xA)().trigger(VM.RV,e)}on3dmouseCreated(){Ba&&(ps.Jq.SpaceballService.initializeSpacemouseCommands(),this.connexion.update3dcontroller({frame:{timingSource:1}}),this.mouseCreated=!0)}update3dcontroller(e){Ba&&this.mouseCreated&&this.connexion.update3dcontroller(e)}}let Va=null,Ga=null;function Ha(){xa("iframe").attr("tabindex","-1"),!(0,Js.CF)()||Va||Ga||(Va=new Ua,Ga=new fs(Va),Ga.startListeningToEvents())}function ka(){Ga&&Ga.stopListeningToEvents()}function Wa(){return Ba}function za(e,t){Va&&Va.onViewerDraw(e,t)}var Xa=i(96955),qa=i(9412),Za=i(26407);class Ya{constructor(e,t){this.entityId=e,this.isSubEntity=!1,this.start=null,this.end=null,this.type="unknown",this.subEntities=[],this.mid=null,this.radius=void 0,this.minorRadius=void 0,this.center=null,this.xAxis=null,this.point=null,this.useCenterPointForArcRadius=void 0,this.splineCPData=null,this.splineKnotData=null,this.lowParameter=void 0,this.highParameter=void 0,this.closedSpline=void 0,this.rationalSpline=void 0,this.splineDegree=0,this.offset=0,this.sourceId=void 0,this.bottomLeftCorner=null,this.bottomRightCorner=null,this.topLeftCorner=null,this.rho=0,this.controlPoint=null,this.hasSplineHandlesInSketch=!1,t&&this.update(t)}update(e){const t=this;if(e instanceof W.tCU)this.point=e.getPoint(0),this.type="point";else if(e instanceof W.r9S)this.start=e.getPoint(0),this.end=e.getPoint(1),this.type="line";else if(e instanceof W.Eg0)this.start=e.getPoint(0),this.mid=e.getPoint(1),this.end=e.getPoint(2),this.center=e.getPoint(3),this.type="arc";else if(e instanceof W.YEZ){const t=e;this.center=t.getPoint(0),this.radius=t.radius,this.type="circle"}else if(e instanceof W.piN){const t=e;this.type="spline",this.closedSpline=t.closed,this.rationalSpline=t.rational,this.splineDegree=t.degree,this.hasSplineHandlesInSketch=e.hasHandlesInSketch;const i=t.controlPointCount,s=i+t.degree+1,n=3*i;if(this.splineCPData=t.points.slice(0,n),this.splineKnotData=t.points.slice(n,n+s),this.offset=t.points[n+s],t.segment){const e=n+s+1;this.start=[t.points[e],t.points[e+1]],this.lowParameter=t.points[e+2],this.end=[t.points[e+3],t.points[e+4]],this.highParameter=t.points[e+5]}else this.lowParameter=this.splineKnotData[this.splineDegree],this.highParameter=this.splineKnotData[this.splineKnotData.length-this.splineDegree-1]}else if(e instanceof W.Mbd||e instanceof W.HmT){const i=e instanceof W.Mbd;if(i)this.type="text";else{this.type="image";const t=e;this.sourceId=t.sourceId,this.bottomLeftCorner=t.bottomLeftCorner.getVec3(),this.bottomRightCorner=t.bottomRightCorner.getVec3(),this.topLeftCorner=t.topLeftCorner.getVec3()}let s=0;if(t.subEntities.length===e.entities.length)for(s=0;s<t.subEntities.length;s++)t.subEntities[s].update(e.entities[s]);else{t.subEntities=[];const n=i?W.whn.ID_PREFIX:W.a_n.ID_PREFIX;e.entities.forEach((function(e){const i=new Ya(t.entityId+n+"."+s);i.isSubEntity=!0,i.update(e),t.subEntities.push(i),s++}))}}else if(e instanceof W.Nz9){const t=e;this.type="ellipse",this.center=t.getPoint(0),this.xAxis=t.getPoint(1),this.radius=t.radius,this.minorRadius=t.minorRadius,this.offset=t.offset}else if(e instanceof W.HlM){const t=e;this.type="ellipticalArc",this.center=t.getPoint(0),this.xAxis=t.getPoint(1),this.radius=t.radius,this.minorRadius=t.minorRadius,this.lowParameter=t.startParam,this.highParameter=t.endParam,this.offset=t.offset}else if(e instanceof W.Ddh){const t=e;this.type="conic",this.start=t.getPoint(0),this.controlPoint=t.getPoint(1),this.end=t.getPoint(2),this.lowParameter=t.points[6],this.highParameter=t.points[7],this.offset=t.offset,this.rho=t.rho}}}function Ka(e){let t=null;const i=[e.center];if(e.radius>bi.W.ZERO_LENGTH){t=new Array(bi.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE);const i=2*Math.PI/(bi.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE-1);let s=0;const n=e.radius;for(let r=0;r<bi.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE;++r){s=i*r;const a=Math.cos(s),o=Math.sin(s);t[r]=[e.center[0]+a*n,e.center[1]+o*n]}}return{linePoints:t,points:i}}function ja(e,t,i){i<t&&(i+=2*Math.PI);let s=null;const n=[e.center],r=e.xAxis,a=[-e.xAxis[1],e.xAxis[0]],o=e.offset;if(e.radius>bi.W.ZERO_LENGTH&&e.minorRadius>bi.W.ZERO_LENGTH){s=[];let n=Math.max((i-t)/(2*Math.PI)*bi.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE,2);n=Math.floor(n);const h=(i-t)/(n-1);let c=0;const l=e.radius,u=e.minorRadius;for(let i=0;i<n;++i){c=h*i+t;const n=Math.cos(c),d=Math.sin(c);let g=r[0]*l*n+a[0]*u*d,p=r[1]*l*n+a[1]*u*d;if(0!==o){const e=r[0]*u*n+a[0]*l*d,t=r[1]*u*n+a[1]*l*d,i=Math.sqrt(e*e+t*t);g+=o*e/i,p+=o*t/i}s[i]=[e.center[0]+g,e.center[1]+p]}}return{linePoints:s,points:n}}const Qa=function(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])},$a=function(e,t,i){const s=Math.cos(i),n=Math.sin(i);return[e[0]+s*t,e[1]+n*t]};function Ja(e,t,i,s){const n=.01*Math.PI,r=2+Math.floor(Math.abs(s-i)/n),a=(s-i)/(r-1),o=new Array(r);for(let s=0;s<r;++s)o[s]=$a(e,t,i),i+=a;return o}function eo(e,t,i,s,n){if((0,Xa.are2dPointsEqual)(e,i))return null;let r=s;if(n){const s=[0,0],n=[0,0],a=[0,0],o=[0,0];if(!(0,Li.eB)(e,t,s,n)||!(0,Li.eB)(t,i,a,o))return null;const h=[0,0];if(!(0,Li.TE)(s,n,a,o,h))return null;r=h}let a=Qa(r,e),o=Qa(r,i);const h=Qa(r,t);let c=0;a>o&&(c=a,a=o,o=c),(h<a||h>o)&&(c=a,a=o,o=c+2*Math.PI);const l=e[0]-r[0],u=e[1]-r[1];return{linePoints:Ja(r,Math.sqrt(l*l+u*u),a,o),points:[e,i,r]}}function to(e){const t=new Ya(e.entityId);let i=1;return Math.abs(1-e.rho)>bi.W.ZERO_LENGTH?(i=e.rho/(1-e.rho),t.splineKnotData=[0,0,0,1,1,1],t.splineCPData=[e.start[0],e.start[1],1,e.controlPoint[0],e.controlPoint[1],i,e.end[0],e.end[1],1]):(t.splineKnotData=[0,0,0,.5,1,1,1],t.splineCPData=[e.start[0],e.start[1],1,e.controlPoint[0],e.controlPoint[1],i,e.controlPoint[0],e.controlPoint[1],i,e.end[0],e.end[1],1]),t.rationalSpline=!0,t.closedSpline=!1,t.offset=e.offset,t.splineDegree=2,t.lowParameter=e.lowParameter,t.highParameter=e.highParameter,io(t)}function io(e){let t=[];const i=[];if(e.splineCPData&&e.splineCPData.length>0&&e.splineDegree&&e.splineKnotData){const s=[];let n;for(n=0;n<e.splineCPData.length;n+=3)s.push([e.splineCPData[n]*e.splineCPData[n+2],e.splineCPData[n+1]*e.splineCPData[n+2],e.splineCPData[n+2]]);const r=new qa.Bspline(e.splineDegree,e.splineKnotData,s,v,!!e.closedSpline),a=e.splineCPData.length*bi.W.NUMBER_OF_POINTS_PER_BSPLINE_CPOINT,o=Math.min(e.lowParameter,e.highParameter),h=Math.abs(e.highParameter-e.lowParameter)/a;let c,l;for(n=0;n<=a;n++)c=o+n*h,l=r.evaluate(c),t.push([l[0]/l[2],l[1]/l[2]]);if(e.offset&&Math.abs(e.offset)>bi.W.ZERO_LENGTH){const i=[];let s=$.create(),o=$.create(),h=!1;if(e.closedSpline){const t=r.domain();h=Math.abs(Math.abs(e.highParameter-e.lowParameter)-t[1]+t[0])<bi.W.ZERO_LENGTH}for(n=0;n<=a;++n)s=0===n?pe.gv.subtract(t[1],t[0],s):n===a?h?pe.gv.subtract(t[1],t[0],s):pe.gv.subtract(t[a],t[a-1],s):pe.gv.subtract(t[n+1],t[n-1],s),pe.gv.normalize(s),o=pe.gv.scale([s[1],-s[0]],e.offset,o),i.push(pe.gv.add(t[n],o,$.create()));t=i}e.start&&i.push(e.start),e.end&&i.push(e.end)}return{linePoints:t,points:i}}function so(e){switch(e.type){case"line":const t=[e.start,e.end];return{linePoints:t,points:t};case"point":return{linePoints:null,points:[e.point]};case"circle":return Ka(e);case"arc":return eo(e.start,e.mid,e.end,e.center,!e.useCenterPointForArcRadius);case"spline":return io(e);case"ellipse":return ja(e,0,2*Math.PI);case"ellipticalArc":if(void 0!==e.lowParameter&&void 0!==e.highParameter)return ja(e,e.lowParameter,e.highParameter);break;case"conic":return to(e)}return console.warn("Failed to create polyline for unsupported entity type: "+e.type),{linePoints:null,points:null}}function no(e,t,i,s){let n=!1,r=!1,a=!1,o=!1;t&&((i||"point"===e.type)&&(n=t.isConstruction),r=t.forPreview,t.isFromSplineHandle&&(a=t.isFromSplineHandle),t.isFromSplineControlPolygon&&(o=t.isFromSplineControlPolygon));const h=t?t.status:W.ea7.UNKNOWN;return(0,Za.$V)(i,n,a,o,h,s,r)}function ro(e,t){const i=e.getSketch(),s=[],n=[];let r,a=0;if(t.linePoints){const e=t.linePoints.length;let o=0;t.linePoints.forEach((function(t){r=i.planeToWorld(t),s.push(r[0],r[1],r[2]),n.push(a),o>0&&o<e-1&&n.push(a),o++,a++}))}return s.length>0?new jE(_i.MX.LINES,s,n):null}function ao(e,t,i,s,n,r){const a=e.getSketch();if(!a)return;if(!t)return void i.removeEntity(n);let o=null;const h=[],c=[];let l=0;t.points&&t.points.forEach((function(e){o=a.planeToWorld(e),h.push(o[0],o[1],o[2]),c.push(l),l++}));const u=ro(e,t);u?i.updateTemporaryEntity(n,u,no(s,r,!0,n)):h.length>0&&i.updateTemporaryEntity(n,new jE(_i.MX.POINTS,h,c),no(s,r,!1,n))}const oo=new St.StringSet;function ho(){return!oo.isEmpty()}class co{constructor(e){this.bytes=null,this.floats=null,this.width=-1,this.height=-1,this.useMipmaps=!1,this.maxAnisotropy=-1,this.canvas=null,this.imageSource="",this.defersRendering=!1,this.internalFormat=e.RGBA,this.format=this.internalFormat,this.minificationFilter=e.NEAREST,this.magnificationFilter=e.NEAREST,this.wrapS=e.CLAMP_TO_EDGE,this.wrapT=e.CLAMP_TO_EDGE}isImage(){return!!this.imageSource}}let lo=0;class uo extends m.T{constructor(e,t,i){super(),this.viewer=e,this.GAUGE_MEMORY_TYPE="Texture",this.creationFunction=null,this.textureDefinition=null,this.waitingForTextureData=!1,this.texture=null,this.textureSize=0,this.textureNeedsUpdate=!1,this.hasTransparency=!0,this.performedImageLoadRetry=!1,(0,Ih.Yk)(e),"function"==typeof t?this.creationFunction=t:this.textureDefinition=t,this.updateFunction=i,this.id=lo.toString(),++lo,this.textureDefinition&&this.textureDefinition.isImage()&&this.createTexture(),this.listenTo(this.viewer.getEventDispatcher(),VM.so,this.onGlContextLostOrDestroyed),this.listenTo(this.viewer.getEventDispatcher(),VM.cW,this.onGlContextLostOrDestroyed)}destroy(){var e;this.stopListening(),this.texture&&(null===(e=this.viewer.getGlContext())||void 0===e||e.deleteTexture(this.texture),this.viewer.getMemoryGauge().decrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.textureSize)),this.texture=null}setTextureNeedsUpdate(e){this.textureNeedsUpdate=e}createTexture(){if(this.texture)return;const e=this.textureDefinition?this.textureDefinition:this.creationFunction(this.viewer.getGlContext());if(!e)return;const t=this.viewer.getGlContext();if(this.texture=t.createTexture(),this.textureNeedsUpdate=!1,e.isImage())this.loadTextureFromImage(e);else{const i="createTexture temporary";go(this.viewer,this.texture,i)>=0&&(e.bytes?(t.texImage2D(t.TEXTURE_2D,0,e.internalFormat,e.width,e.height,0,e.format,t.UNSIGNED_BYTE,e.bytes),this.setTextureSize(e.width,e.height,e.internalFormat,t.UNSIGNED_BYTE)):e.floats?this.viewer.areFloatTexturesSupported()?(t.texImage2D(t.TEXTURE_2D,0,e.internalFormat,e.width,e.height,0,e.format,t.FLOAT,e.floats),this.setTextureSize(e.width,e.height,e.internalFormat,t.FLOAT)):It.log.warn(WM+"An attempt was made to make a float texture without float texture support"):e.canvas?(t.texImage2D(t.TEXTURE_2D,0,e.internalFormat,e.format,t.UNSIGNED_BYTE,e.canvas),this.setTextureSize(e.canvas.width,e.canvas.height,e.internalFormat,t.UNSIGNED_BYTE)):It.log.warn(WM+"An attempt was made to create a texture without valid input"),this.finishTextureSpecification(e),this.viewer.releaseTextureUnit(i))}}get imageSourceUri(){return this.textureDefinition?this.textureDefinition.imageSource:null}setTextureSize(e,t,i,s){this.textureSize=mo(e,t,i,s),this.viewer.getMemoryGauge().incrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.textureSize)}loadTextureFromImage(e){const t=new Image;this.waitingForTextureData=!0,e.defersRendering&&oo.add(this.id),t.onload=()=>{const i=this.viewer.getGlContext();if(!i||!this.texture)return;this.waitingForTextureData=!1;go(this.viewer,this.texture,"loadTextureFromImage")>=0&&(i.texImage2D(i.TEXTURE_2D,0,e.internalFormat,e.format,i.UNSIGNED_BYTE,t),this.setTextureSize(t.width,t.height,e.internalFormat,i.UNSIGNED_BYTE),this.finishTextureSpecification(e),this.viewer.releaseTextureUnit("loadTextureFromImage")),oo.remove(this.id),(0,Js.vm)()},t.onerror=()=>{if(oo.remove(this.id),this.performedImageLoadRetry)It.log.warn("Could not load texture image: "+e.imageSource);else{It.log.info("Initial attempt to load texture image failed: "+e.imageSource),this.performedImageLoadRetry=!0;setTimeout((()=>{this.loadTextureFromImage(e)}),1e4)}(0,Js.vm)()};setTimeout((()=>{oo.contains(this.id)&&(oo.remove(this.id),(0,Js.vm)())}),2e3),t.src=e.imageSource}finishTextureSpecification(e){const t=this.viewer.getGlContext(),i=this.viewer.getAnisotropicExtension();i&&e.maxAnisotropy>0&&t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,e.maxAnisotropy),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e.magnificationFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e.minificationFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,e.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,e.wrapT),e.useMipmaps&&t.generateMipmap(t.TEXTURE_2D)}updateAndBindTexture(e){if((0,Ih.Yk)(this.viewer),this.texture||this.createTexture(),this.waitingForTextureData)return-1;const t=this.viewer.getGlContext(),i=go(this.viewer,this.texture,e);return i>=0&&this.textureNeedsUpdate&&this.updateFunction&&(t.activeTexture(t.TEXTURE0+i),this.updateFunction(),this.textureNeedsUpdate=!1),i}setHasTransparency(e){this.hasTransparency=e}getHasTransparency(){return this.hasTransparency}onGlContextLostOrDestroyed(){this.texture=null}}function go(e,t,i){(0,Ih.Yk)(e);const s=e.getOrAllocateTextureUnit(i);return s>=0&&e.bindTextureToUnit(t,s),s}function po(e,t){(0,Ih.Yk)(e);const i=e.getTextureUnit(t);i>=0&&(e.bindTextureToUnit(null,i),e.releaseTextureUnit(t))}function mo(e,t,i,s){return e*t*Zt(i)*zt(s)}function fo(e,t,i,s){(0,Ih.Yk)(e);const n=e.getGlContext(),r=n.createTexture(),a="createRGBATexture temporary",o=e.getOrAllocateTextureUnit(a);if(o<0)return null;try{e.bindTextureToUnit(r,o),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,t,i,0,n.RGBA,s,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),e.bindTextureToUnit(null,o),e.releaseTextureUnit(a)}catch(e){throw It.log.warn("BEL-56217 - exception while creating texture with width "+t+", height: "+i+", precision: "+s+", exception: "+e),e}return r}var Io=i(32659);class Eo{constructor(e,t,i,s,n){this.canvas=e,this.filledWidthPx=t,this.filledHeightPx=i,this.leftPixel=s,this.topPixel=n}}class So extends uo{constructor(e,t){super(e,(e=>this.textureCreationFunction(e))),this.canvasCreationFunction=t,this.width=-1,this.height=-1,this.filledWidthPx=-1,this.filledHeightPx=-1,this.leftCoordinate=-1,this.rightCoordinate=-1,this.bottomCoordinate=-1,this.topCoordinate=-1;this.createTexture()}createTexturedQuad(){return Ou([0,0,0],[this.filledWidthPx,0,0],[0,this.filledHeightPx,0],"textQuad",[this.leftCoordinate,this.bottomCoordinate],[this.rightCoordinate,this.topCoordinate])}textureCreationFunction(e){const t=this.canvasCreationFunction(e);this.width=t.canvas.width,this.height=t.canvas.height,this.filledWidthPx=t.filledWidthPx,this.filledHeightPx=t.filledHeightPx,this.leftCoordinate=t.leftPixel/t.canvas.width,this.rightCoordinate=this.leftCoordinate+t.filledWidthPx/t.canvas.width,this.topCoordinate=t.topPixel/t.canvas.height,this.bottomCoordinate=this.topCoordinate+t.filledHeightPx/t.canvas.height;const i=new co(e);return i.canvas=t.canvas,i.magnificationFilter=e.LINEAR,i.minificationFilter=e.LINEAR_MIPMAP_LINEAR,i.maxAnisotropy=4,i.wrapS=e.CLAMP_TO_EDGE,i.wrapT=e.CLAMP_TO_EDGE,i.useMipmaps=!0,i}}const To={font:"Arial",heightPx:10,weight:"",color:"#000000"};function Mo(e,t){const i=document.createElement("canvas");return i.width=(0,Li.cP)(e),i.height=(0,Li.cP)(t),i}let Co=null;function Do(){if(!Co){const e=Mo(128,128);Co=e.getContext("2d",{willReadFrequently:!0})}return Co}function vo(e,t){t=Object.assign({},To,t),e.font=(t.weight?t.weight+" ":"")+t.heightPx+"px "+t.font,e.textAlign="left",e.fillStyle=t.color,e.globalAlpha=1,e.textBaseline="hanging"}const Po=1;function yo(e,t){const i=e.getContext("2d",{willReadFrequently:!0}),s=i.getImageData(0,0,e.width,e.height),n=[t[0],t[1],t[2],Po],r=s.data.length/4;for(let e=0;e<r;++e)for(let t=0;t<4;++t)s.data[4*e+t]=n[t];return i.putImageData(s,0,0),n}function Ao(e,t){const i=Do();vo(i,t);let s=0;for(let t=0;t<e.length;++t)s=Math.max(s,i.measureText(e[t]).width);return s}function Oo(e,t){return Mo(e,t)}function Ro(e,t,i,s,n,r,a,o){const h=e.getContext("2d",{willReadFrequently:!0});yo(e,n),o=(o||0)+1,h.fillStyle="rgba("+n[0]+","+n[1]+","+n[2]+","+r+")",_o(h,t,i,s,a,o),h.fill()}function wo(e,t,i,s,n,r,a,o,h,c){const l=e.getContext("2d",{willReadFrequently:!0});c||yo(e,n),l.strokeStyle="rgba("+n[0]+","+n[1]+","+n[2]+", 1.0)",l.setLineDash([o,h]),l.lineWidth=a;_o(l,t,i,s,r+a/2,a/2+1),l.stroke()}function _o(e,t,i,s,n,r){const a=r,o=r;t-=2*r,i-=2*r,e.beginPath(),e.moveTo(a+n,o+s),e.arcTo(a+t,o+s,a+t,o+s+i,n),e.arcTo(a+t,o+s+i,a,o+s+i,n),e.arcTo(a,o+s+i,a,o+s,n),e.arcTo(a,o+s,a+t,o+s,n),e.closePath()}function No(e){return e.split("\n")}function bo(e,t,i,s,n){const r=i.getContext("2d",{willReadFrequently:!0});vo(r,t);const a=No(e);for(let e=0;e<a.length;++e)r.fillText(a[e],s,n+t.heightPx*e);i.filledWithText=e}function Lo(e,t,i,s){s&&(s=pe.w$.toMat3(s),t=pe.xB.multiply(s,t,v.create()),i=pe.xB.multiply(s,i,v.create()));const n=e.getRight(),r=e.getForward(),a=e.up,o=v.dot(t,n);let h=!1;o<=-bi.W.ZERO_LENGTH?h=!0:o<=bi.W.ZERO_LENGTH&&(h=v.dot(t,a)<=bi.W.ZERO_LENGTH);const c=h?pe.S4.scale(t,-1,v.create()):t,l=pe.S4.cross(c,r,v.create());return[h,v.dot(i,l)<=-bi.W.ZERO_LENGTH]}let Fo=null;function xo(e){Fo||(Fo=Io('<div style="z-index:999999;margin:5px;position:fixed;left:0;bottom:0"></div>').appendTo("body")),Io(e).css({background:"yellow",margin:"0 5px"}),Io(e).appendTo(Fo)}function Bo(e,t,i,s,n,r){const a=yo(e,i);return bo(t,s,e,n,n+r),(0,Et.isBrowserFirefox)()?function(e,t){const i=new Li.tO,s=e.getContext("2d",{willReadFrequently:!0}),n=e.width,r=e.height,a=s.getImageData(0,0,n,r).data;for(let e=0;e<r;++e)for(let s=0;s<n;++s)if(Vo(a,t,n,r,s,e)){const o=Vo(a,t,n,r,s-1,e)||Vo(a,t,n,r,s+1,e),h=Vo(a,t,n,r,s,e-1)||Vo(a,t,n,r,s,e+1);o&&h&&i.addPointXY(s,e)}return i}(e,a):function(e,t){const i=new Li.tO,s=e.getContext("2d",{willReadFrequently:!0}),n=e.width,r=e.height,a=s.getImageData(0,0,n,r).data;for(let e=0;e<r;++e)for(let s=0;s<n;++s)Vo(a,t,n,r,s,e)&&i.addPointXY(s,e);return i}(e,a)}const Uo=256;function Vo(e,t,i,s,n,r){if(n<0||n>=i||r<0||r>=s)return!1;const a=4*(r*i+n),o=e.subarray(a,a+4);if(o[3]>Po){if(pe.jA.distanceSquared(t,o)>Uo)return!0}return!1}function Go(e,t,{color:i,font:s,size:n,fontWeight:r,paddingWithinBorder:a,backgroundColor:o,backgroundOpacity:h,backgroundRadius:c,borderColor:l,borderThickness:u,dashLength:d,dashGapLength:g,underlineWidth:p}){return new So(e,(function(e){const m=[Math.floor(255*i[0]),Math.floor(255*i[1]),Math.floor(255*i[2])],f={color:"rgb("+m[0]+","+m[1]+","+m[2]+")",font:s,heightPx:n,weight:r},I=(a=a||0)+(u=u||0),E=Math.max(2,Math.ceil(.25*n)),S=No(t);let T=Math.ceil(Ao(S,f))+2*I;T=Math.min(T,e.getParameter(e.MAX_TEXTURE_SIZE));const M=n*S.length+2*I,C=Oo(T,M+2*E),D=C.getContext("2d",{willReadFrequently:!0}),v=Bo(C,t,m,f,I,E);v.isInitialized()||(It.log.warn("Did not find canvas bounds for text: "+t),v.addPointXY(0,E),v.addPointXY(T,E+M));const P=v.min[1];if(o){Ro(C,T,M,P-I,[Math.floor(255*o[0]),Math.floor(255*o[1]),Math.floor(255*o[2]),Math.floor(255*h)],h=h||1,c=c||0,u)}else yo(C,m);if(l){wo(C,T,M,P-I,[Math.floor(255*l[0]),Math.floor(255*l[1]),Math.floor(255*l[2])],c||0,u,d||1,g||0,!!o)}const y=v.getDimensions(),A=I+E+Math.floor((S.length*n-y[1])/(2*S.length));if(p){D.strokeStyle=f.color,D.lineWidth=p,D.beginPath();const e=.95,t=A+Math.floor(n*e)-.5*p;D.moveTo(I,t),D.lineTo(T-I,t),D.stroke()}return bo(t,f,C,I,A),new Eo(C,T,M,0,P-I)}))}function Ho(e){return e<0?"--":(1e3/e).toFixed(1)}class ko{constructor(){this.timings=[],this.averageTime=-1,this.framesSinceTiming=0,this.timingFrequency=10,this.timingCount=0,this.activeTimerQuery=null,this.pendingQueries=[],this.availableQueries=[],this.queryTimings=[],this.averageQueryTime=-1}reset(){this.timings=[],this.averageTime=-1,this.timingCount=0,this.framesSinceTiming=0,this.queryTimings=[],this.averageQueryTime=-1}onContextLost(){this.activeTimerQuery=null,this.pendingQueries=[],this.availableQueries=[]}hasTimings(){return this.timings.length>0}getAverageFramerate(){return 1e3/this.averageTime}onDrawStart(e,t){if(!e||!t)return;const i=t.getParameter(e.GPU_DISJOINT_EXT);let s;for(;s=this.pendingQueries.shift();)e.getQueryObjectEXT(s,e.QUERY_RESULT_AVAILABLE_EXT)&&(i||this.addQueryTiming(e.getQueryObjectEXT(s,e.QUERY_RESULT_EXT)/1e6),this.availableQueries.push(s));this.availableQueries.length>0?this.activeTimerQuery=this.availableQueries.shift():this.activeTimerQuery=e.createQueryEXT(),e.beginQueryEXT(e.TIME_ELAPSED_EXT,this.activeTimerQuery)}addQueryTiming(e){this.queryTimings.push(e),this.queryTimings.length>30&&this.queryTimings.shift();let t=0;for(let e=0;e<this.queryTimings.length;++e)t+=this.queryTimings[e];this.averageQueryTime=t/this.queryTimings.length}onDrawEnd(e){e&&this.activeTimerQuery&&(e.endQueryEXT(e.TIME_ELAPSED_EXT,this.activeTimerQuery),this.pendingQueries.push(this.activeTimerQuery),this.activeTimerQuery=null)}addTiming(e){this.timings.push(e),this.timings.length>5&&this.timings.shift();let t=0;for(let e=0;e<this.timings.length;++e)t+=this.timings[e];this.averageTime=t/this.timings.length,this.framesSinceTiming=0,++this.timingCount}}var Wo;!function(e){e[e.ADJUSTING_CAMERA=0]="ADJUSTING_CAMERA",e[e.MANIPULATING=1]="MANIPULATING",e[e.SYSTEM_ANIMATION=2]="SYSTEM_ANIMATION"}(Wo||(Wo={}));class zo{constructor(e){this.viewer=e,this.timingFrameType=null,this.frameTimeStart=0,this.drawLoopStart=0,this.frameTimings=[],this.frameDetails={},this.drawLoopDetails={},this.interactionTimeouts={},(0,Ih.Yk)(e),this.frameDetails[ia.Q.INTERACTIVE]=new ko,this.drawLoopDetails[ia.Q.INTERACTIVE]=new ko,this.disjointTimer=this.viewer.getExtension("EXT_disjoint_timer_query")}resetTimings(){this.frameDetails[ia.Q.INTERACTIVE].reset(),this.drawLoopDetails[ia.Q.INTERACTIVE].reset()}onContextLost(){Object.values(this.frameDetails).forEach((e=>{e.onContextLost()})),this.disjointTimer=null}onContextRestored(){this.disjointTimer=this.viewer.getExtension("EXT_disjoint_timer_query")}getAverageFrameRate(e){return Ho(this.frameDetails[e].averageTime)}getAverageQueryFrameRate(e){return this.disjointTimer?Ho(this.frameDetails[e].averageQueryTime):null}getTimingDetails(e){return this.frameDetails[e]}getDrawLoopDetails(e){return this.drawLoopDetails[e]}onDrawStart(){const e=this.getCurrentFrameType(),t=this.frameDetails[e];if(!t)return;t.onDrawStart(this.disjointTimer,this.viewer.getGlContext());const i=(0,Js.Wj)();this.drawLoopStart=i,this.timingFrameType===e?(this.frameTimings.push(i-this.frameTimeStart),this.frameTimings.length<2?(this.frameTimeStart=i,this.viewer.forceRequestDraw()):(t.addTiming(Math.max(this.frameTimings[0],this.frameTimings[1])),this.timingFrameType=null)):(t.framesSinceTiming++,t.framesSinceTiming>=t.timingFrequency&&(this.frameTimeStart=i,this.timingFrameType=e,this.frameTimings=[],this.viewer.forceRequestDraw()))}onDrawEnd(){const e=this.getCurrentFrameType(),t=this.frameDetails[e];t&&t.onDrawEnd(this.disjointTimer);const i=this.drawLoopDetails[e];if(!i)return;const s=(0,Js.Wj)();i.addTiming(s-this.drawLoopStart)}setUserIsInteractingWithTimeout(e){this.interactionTimeouts[e]&&window.clearTimeout(this.interactionTimeouts[e]);this.interactionTimeouts[e]=window.setTimeout((()=>{delete this.interactionTimeouts[e],this.viewer.requestDraw()}),500)}resetInteractionStatus(){Object.values(this.interactionTimeouts).forEach((function(e){window.clearTimeout(e)}),this),this.interactionTimeouts={}}setUserIsAdjustingCamera(){this.setUserIsInteractingWithTimeout(Wo.ADJUSTING_CAMERA)}setUserIsManipulatingWithTimeout(){this.setUserIsInteractingWithTimeout(Wo.MANIPULATING)}setSystemIsAnimating(){this.setUserIsInteractingWithTimeout(Wo.SYSTEM_ANIMATION)}userIsInteracting(){for(const e in this.interactionTimeouts)if(this.interactionTimeouts[e])return!0;return!1}userIsManipulating(){return!!this.interactionTimeouts[Wo.MANIPULATING]}getCurrentFrameType(){return this.userIsManipulating()?ia.Q.MANIPULATING:this.userIsInteracting()?ia.Q.INTERACTIVE:ia.Q.FULL}}class Xo extends m.T{constructor(e,t,i,s){super(),this.viewer=e,this.textureType=t,this.GAUGE_MEMORY_TYPE="Frame buffer",this.colorTexture=null,this.renderBuffer=null,this.frameBuffer=null,this.width=0,this.height=0,this.isWebXrEnabled=!1,(0,Ih.Yk)(e),this.renderBufferArguments=s,this.id=i||"",this.listenTo(this.viewer.getEventDispatcher(),VM.cW,this.onGlContextLost),this.listenTo(this.viewer.getEventDispatcher(),VM.so,this.onSessionEnded),ps.Jq.CapabilitiesService.isWebxrEnabled().then((e=>{this.isWebXrEnabled=e}))}destroy(){this.stopListening(),this.freeResources()}setExternalFrameBuffer(e,t,i){this.width=e,this.height=t,this.frameBuffer=i}onSessionEnded(){this.destroy()}onGlContextLost(){this.frameBuffer=null,this.colorTexture=null,this.renderBuffer=null}update(e,t,i){if(this.isWebXrEnabled){if(!t&&!i)if(e.isCustomViewportActive){const s=e.getViewport();t=s[2],i=s[3]}else t=this.viewer.getBaseFrameBufferWidth(),i=this.viewer.getBaseFrameBufferHeight()}else{const s=e.getViewport();t=s[2],i=s[3]}if(!this.colorTexture||t!==this.width||i!==this.height){const e=this.viewer.getGlContext();this.freeResources(),this.width=t,this.height=i;const s=e.getParameter(e.FRAMEBUFFER_BINDING);this.createBuffer(t,i),this.checkFrameBuffer()||this.textureType!==this.viewer.getHalfFloatType()||(this.textureType=e.FLOAT,It.log.info("The creation of a frame buffer with HALF_FLOAT failed.  Attempting to create buffer with full FLOAT"),this.freeResources(),this.createBuffer(t,i),this.checkFrameBuffer()),e.bindFramebuffer(e.FRAMEBUFFER,s||null)}}getColorTextureMemoryUsage(){return mo(this.width,this.height,Wt.RGBA,this.textureType)}getRenderBufferMemoryUsage(){return this.renderBufferArguments?this.width*this.height*qt(this.renderBufferArguments.storageType):0}incrementMemoryGauge(){const e=this.viewer.getMemoryGauge();this.colorTexture&&e.incrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.getColorTextureMemoryUsage()),this.renderBuffer&&e.incrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.getRenderBufferMemoryUsage())}freeResources(){const e=this.viewer.getGlContext();if(!e)return;const t=this.viewer.getMemoryGauge();this.frameBuffer&&(e.deleteFramebuffer(this.frameBuffer),this.frameBuffer=null),this.colorTexture&&(t.decrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.getColorTextureMemoryUsage()),e.deleteTexture(this.colorTexture),this.colorTexture=null),this.renderBuffer&&(t.decrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.getRenderBufferMemoryUsage()),e.deleteRenderbuffer(this.renderBuffer),this.renderBuffer=null)}createBuffer(e,t){const i=this.viewer.getGlContext();this.colorTexture=fo(this.viewer,e,t,this.textureType),this.renderBufferArguments&&(this.renderBuffer=this.viewer.getOrCreateRenderBuffer(e,t,this.renderBufferArguments)),this.frameBuffer=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.colorTexture,0),this.renderBufferArguments&&i.framebufferRenderbuffer(i.FRAMEBUFFER,this.renderBufferArguments.attachmentType,i.RENDERBUFFER,this.renderBuffer),this.incrementMemoryGauge()}checkFrameBuffer(){const e=this.viewer.getGlContext();switch(e.checkFramebufferStatus(e.FRAMEBUFFER)){case e.FRAMEBUFFER_UNSUPPORTED:return It.log.warn(WM+"Framebuffer is unsupported"),!1;case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return this.textureType===this.viewer.getHalfFloatType()?It.log.info("Framebuffer incomplete attachment for half float type"):It.log.warn(WM+"Framebuffer incomplete attachment"),!1;case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return It.log.warn(WM+"Framebuffer incomplete dimensions"),!1;case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return It.log.warn(WM+"Framebuffer incomplete missing attachment"),!1}return!0}bindBuffer(){const e=this.viewer.getGlContext();e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer)}unbindBuffer(){const e=this.viewer.getGlContext();e.bindFramebuffer(e.FRAMEBUFFER,null)}getTexture(){return this.colorTexture}resetBuffer(){this.freeResources()}getWidth(){return this.width}getHeight(){return this.height}}var qo=i(32659),Zo=i(32659);const Yo={duration:500,tolerance:10},Ko={mousedown:"mousedown",mouseup:"mouseup",mousemove:"mousemove",longpress:"longpress"},jo={LEFT:1,MIDDLE:2,RIGHT:3};function Qo(e,t){e.on(Ko.mousedown,Jo),e.on(Ko.longpress,t)}function $o(e){e.off(Ko.mousedown,void 0,Jo),e.off(Ko.longpress)}function Jo(e){if(e.which!==jo.LEFT)return;const t=qo(e.target),i=(new Date).getTime(),s=Zo.Event(Ko.longpress);for(const t in e)s[t]=e[t];s.type=Ko.longpress,t.on(Ko.mouseup,r),t.on(Ko.mousemove,a);const n=setTimeout((function(){t.trigger(Ko.longpress,s),o()}),Yo.duration);function r(e){(new Date).getTime()-i<Yo.duration?clearTimeout(n):t.trigger(Ko.longpress,s),o()}function a(e){(Math.abs(e.pageX-s.pageX)>Yo.tolerance||Math.abs(e.pageY-s.pageY)>Yo.tolerance)&&(clearTimeout(n),o())}function o(){t.off(Ko.mouseup,void 0,r),t.off(Ko.mousemove,void 0,a)}}class eh{constructor(){this.activeManipulator=null}setActiveManipulator(e){this.activeManipulator&&this.activeManipulator.removeDisplacementMeshIncrements(),this.activeManipulator=e}resetActiveManipulator(){this.setActiveManipulator(null)}}let th=null;function ih(){return th||(th=new eh),th}var sh=i(91755);class nh{constructor(e){this.id=e;const t=e===sh.Vv?Ls.L.PREVIEW:Ls.L.BASE;this.rootNode=new ts(e+" root",{},t)}getRootNode(){return this.rootNode}isForPreview(){return this.rootNode.getUsage()===Ls.L.PREVIEW}getBounds(){return this.rootNode.getBoundingBox()}updateBounds(){this.rootNode.updateBounds()}removeEverything(){this.rootNode&&this.rootNode.removeAllChildren()}draw(e){this.rootNode.draw(e)}passesNodeFilter(e){return this.rootNode.passesNodeFilter(e)}getAllNodesWithId(e){const t=[],i=function(s){s.getId()===e&&t.push(s);for(let e=0;e<s.getChildCount();++e)i(s.getChildByIndex(e))};return i(this.rootNode),t}getNodeAtEndOfPath(e){const t=e.slice(0);let i=this.rootNode;for(t.shift();t.length>0;){const e=t.shift();if(i=i.getChildById(e),null===i)return null}return i}ownsNode(e){for(;e;){if(e===this.rootNode)return!0;e=e.getParent()}return!1}makeSceneDebugObject(){return{text:this.id,children:[this.rootNode.makeSceneDebugObject(0)]}}}class rh{constructor(){this.theSceneGraphs={}}destroySceneGraphs(){Object.values(this.theSceneGraphs).forEach((function(e){e.getRootNode().onPermanentlyRemoved()})),this.theSceneGraphs={}}getSceneGraph(e){let t=this.theSceneGraphs[e];return t||(this.theSceneGraphs[e]=t=new nh(e)),t}getMainSceneGraph(){return this.getSceneGraph(sh.lL)}getPreviewSceneGraph(){return this.getSceneGraph(sh.Vv)}getHudSceneGraph(){return this.getSceneGraph(sh.EG)}getHudModelSceneGraph(){return this.getSceneGraph(sh.$K)}}function ah(e){return e===Ls.L.BASE?sh.lL:sh.Vv}var oh=i(33625);let hh=null;class ch{constructor(){this._zoomModifierEnabled=!1,this.zoomModeEnabledSubject=new xs.X(!1)}get zoomModeEnabledObservable(){return this.zoomModeEnabledSubject.asObservable().pipe((0,oh.x)())}get zoomModeEnabled(){return this.zoomModeEnabledSubject.getValue()}set zoomModeEnabled(e){this.zoomModeEnabledSubject.next(e)}}function lh(){return hh||(hh=new ch),hh}function uh(){const e=lh().zoomModeEnabled;lh().zoomModeEnabled=!e}function dh(){return lh().zoomModeEnabled}function gh(e){lh().zoomModeEnabled=e}function ph(){return dh()}var mh=i(21983),fh=i(50900),Ih=i(77484);const Eh=q.default.getManager();class Sh extends m.T{constructor(e,t,i){super(),this.usage=e,this.occurrenceDataManager=t,this.viewer=i,this.partStudios={},this.sharedBaseMeshManager=null,this.i18next=i18n,this.assemblies={},this.displayedElementMicroversionIdAndConfiguration=null,this.displayedElementType=null,this.displayedPartStudio=null,this.partStudioPreservedForPreview=null,this.pendingPartStudioComputedData=null,this.selectionsToClearOnReset={},this.secondaryOccurrenceHighlights={},this.secondaryEntityHighlights={},this.secondaryEntityHighlightSelectionRepeats={},this.addDerivedEntityHighlights=!0,this.selectionListNameToListAndHighlightType=new Map,this.bodyLoadTasks=null,this.meshPointController=null,this.queuedAssemblyDisplayData=[],this.queuedAssemblyTimeout=null,this.notCollapsedAssemblyMessageCount=0,this.selectedSheetmetalModelId=null,this.lastFitSheetMetalModelId=null,this.resyncFunction=null,this.resyncNeeded=!1,this.resyncReason=null,this.resyncPromise=null,this.lastPartStudioProcessed="",this.lastPartStudioMicroversionIdAndConfigurationIntervalProcessed=null,this.temporarySketchComponents={},this.partStudioVisibilityUpdated=!1,this.subFeaturesShownByParameters={},(0,Ih.Yk)(i),this.meshManager=new zS(this.viewer,xI),this.displayedElementId="",this.partsAtTheBeginningOfEdit=new St.StringSet,this.sheetModelIdsAtTheBeginningOfEdit=new St.StringSet,this.handleAllSelectionListHighlights(),this.collapsibleDisplayDataTimer=new ko,this.bodyNode=new ts(gp,new Qi,e),this.sketchNode=new ts(Zp,new Qi,e),this.elementPreviewBodyNode=new ts(gp,new Qi,e),this.isBase()&&(this.listenTo(this.viewer.getEventDispatcher(),VM.LA,this.refreshHighlight),i.getIsPrimaryViewer()&&(this.simulationManager=new Xm(this),this.generativeDesignManager=new df(this),this.thicknessAnalysisManager=new sf(this))),this.alternateEntityMapping=new fh.L,this.latestDisplayDataUsageSubscription=ks().latestDisplayDataUsageChangedObservable.subscribe((()=>this.clearAndRefreshHighlights())),this.meshPointController=new Kn(this.viewer)}clearAndRefreshHighlights(){this.clearHighlights(),this.refreshHighlight()}getViewer(){return this.viewer}onViewerShown(){this.viewer.getIsForFlattenedDisplay()&&this.fitToSelectedSheetMetalModel()}setAlternateEntityMapping(e){this.alternateEntityMapping=e}setResyncFunction(e){this.resyncFunction=e}getResyncPromise(){return this.resyncPromise?this.resyncPromise:null}getSimulationManager(){return this.simulationManager}getGenerativeDesignManager(){return this.generativeDesignManager}getThicknessAnalysisManager(){return this.thicknessAnalysisManager}purgeUnusedPartStudios(e,t){const i=[];for(const t of Object.keys(this.partStudios))e.contains(t)||i.push(this.partStudios[t]);i.sort((function(e,t){return e.getEstimatedMemoryUsageOfBodies()>t.getEstimatedMemoryUsageOfBodies()?-1:e.getEstimatedMemoryUsageOfBodies()<t.getEstimatedMemoryUsageOfBodies()?1:0}));const s=[];for(;(t||this.isEstimatedBodyMemoryUsageAboveThreshold())&&i.length>0;){const e=i.shift();if(t||!e.getIsCachedPartStudioPendingUse()){const t=e.getFullElementId();e.onDeletion(),delete this.partStudios[t],s.push(t),this.displayedElementId&&this.setResyncNeeded(W.ggp.CLIENT_UNLOADED_DISPLAY_DATA)}}t&&Object.keys(this.partStudios).length>0&&It.log.error("Failed to purge all part studios. Remaining part studios: "+Object.keys(this.partStudios)+", deleted part studios: "+s),s.length>0&&(this.meshManager.removeEmptyMeshes(),It.log.info("Purged unused, in-memory part studios: "+s))}getInUsePartStudioIds(){const e=new St.StringSet;if(this.displayingPartStudio()){this.getDisplayedPartStudio()&&e.add(this.getDisplayedPartStudio().getFullElementId());const t=this.getDisplayedInContextAssembly();t&&t.getUsedPartStudioIds(e)}else if(this.displayingAssembly()){const t=this.assemblies[this.displayedElementId];t&&t.getUsedPartStudioIds(e)}return e}getEstimatedMemoryUsageOfBodies(){const e=new mh.B7("ModelViewManager.prototype.getEstimatedMemoryUsageOfBodies");let t=0;return Object.values(this.partStudios).forEach((function(e){t+=e.getEstimatedMemoryUsageOfBodies()}),this),e.report(),t}getBodyDisplayMemoryLimit(){return 1024*(ps.Jq.CapabilitiesService.checkDecreasedBodyDisplayLimitCurrentlyEnabled()?Eh.getNumber("DECREASED_BODY_DISPLAY_MEMORY_LIMIT_MB"):(0,Et.isBrowser64BitFirefox)()?Eh.getNumber("BODY_DISPLAY_MEMORY_LIMIT_FIREFOX64_MB"):Eh.getNumber("BODY_DISPLAY_MEMORY_LIMIT_MB"))*1024}clearAllGenerativeDesignPartInstances(){for(const e of Object.values(this.partStudios))e.getBodyComponent().clearAllGenerativeDesignOccurrences()}getBodyRefinementMemoryLimit(){return this.getBodyDisplayMemoryLimit()}isEstimatedBodyMemoryUsageAboveThreshold(){return this.getEstimatedMemoryUsageOfBodies()>this.getBodyDisplayMemoryLimit()}checkBodyMemoryUsage(e){if(!this.isBase()||this.viewer.getIsForFlattenedDisplay()||this.bodyLoadTasks.hasPendingUnloads()||e.fromDisplayCache)return;const t=this.getEstimatedMemoryUsageOfBodies(),i=this.getBodyDisplayMemoryLimit();if(t<=i)return;this.purgeUnusedPartStudios(this.getInUsePartStudioIds());const s=this.getEstimatedMemoryUsageOfBodies();if(s<=i)return;const n=new mh.B7("ModelViewManager.prototype.checkBodyMemoryUsage",{logResult:qc()});qc()&&It.log.info("bodyMemoryUse before unload: "+Zc(s));const r=this.viewer.getBodyManager().unloadBodies(s-i,this);if(r){const e=new mh.B7("Unloading body display data",{logResult:qc()});r.then((t=>{if(this.setResyncNeeded(W.ggp.CLIENT_UNLOADED_DISPLAY_DATA),this.resyncAsNeeded(),e.report(),qc()){const e=this.getEstimatedMemoryUsageOfBodies();It.log.info("Unloaded "+t.bodiesProcessedSinceStart+" bodies after "+t.iterationsSinceStart+" frames. bodyMemoryUse after unload: "+Zc(e))}}))}n.report()}setResyncNeeded(e){this.resyncNeeded=!0,this.resyncReason=void 0!==e?e:null}resyncAsNeeded(){if(this.resyncFunction&&this.resyncNeeded){const e=this.resyncFunction(this.resyncReason);return this.resyncNeeded=!1,this.resyncReason=null,e}return $r()}integrityCheck(){if(this.displayedElementId in this.assemblies&&this.displayedElementType!==W.GNh.ASSEMBLY)It.log.warn("Found an assembly with the displayed element id, but the element type is incorrect");else{const e=this.displayedElementId;let t=!1;if(e)for(const i in this.partStudios)if(0===i.indexOf(e)){t=!0;break}t&&this.displayedElementType!==W.GNh.PARTSTUDIO&&It.log.warn("Found a part studio with the displayed element id, but the element type is incorrect")}}getSharedBodyNode(){return this.bodyNode}getSharedSketchNode(){return this.sketchNode}getElementPreviewBodyNode(){return this.elementPreviewBodyNode}clearSilhouetteRequests(){this.viewer.getSilhouetteTask().clearPendingRequestsForUsage(this.usage)}instantiateSharedNodes(e){e.addChild(this.bodyNode),e.addChild(this.sketchNode)}isBase(){return this.usage===Ls.L.BASE}getDisplayedFullElementId(){return this.displayedElementMicroversionIdAndConfiguration?W.lK7.getFullElementIdString(this.displayedElementId,this.displayedElementMicroversionIdAndConfiguration.getKey()):this.displayedElementId}setBodyLoadTasks(e){this.bodyLoadTasks=e}getHideableFeatureIdsForDisplayedPartStudio(e){if(e===this.getDisplayedElementId()){const e=this.partStudios[this.getDisplayedFullElementId()];if(e)return e.getHideableFeatureIds()}return[]}onDeletion(){Object.values(this.assemblies).forEach((function(e){e.onDeletion()})),Object.values(this.partStudios).forEach((function(e){e.onDeletion(!0)}),this),this.meshManager.destroy(),this.sharedBaseMeshManager&&(this.sharedBaseMeshManager.destroy(),this.sharedBaseMeshManager=null),this.stopListening(),this.latestDisplayDataUsageSubscription.unsubscribe(),this.meshPointController&&this.meshPointController.destroy(),this.clearSilhouetteRequests(),(0,Jr.Z)(this.queuedAssemblyTimeout)&&(window.clearTimeout(this.queuedAssemblyTimeout),this.queuedAssemblyTimeout=null)}getSceneGraph(){return this.usage===Ls.L.PREVIEW?this.viewer.getSceneGraphs().getPreviewSceneGraph():this.viewer.getSceneGraphs().getMainSceneGraph()}getMeshManager(){return this.meshManager}getSharedBaseMeshManager(){return this.sharedBaseMeshManager}displayedMicroversionAndConfigMatchesDisplayData(e){return!!this.displayedElementMicroversionIdAndConfiguration&&e.microversionIdAndConfigurationInterval.to.equals(this.displayedElementMicroversionIdAndConfiguration)}processRootAssemblyDisplayData(e,t){if(!t&&(e.isCollapsible||this.viewer.getFrameTimer().userIsInteracting()&&this.displayedMicroversionAndConfigMatchesDisplayData(e))){const t=this.queuedAssemblyDisplayData.length>0?this.queuedAssemblyDisplayData[this.queuedAssemblyDisplayData.length-1]:null;t&&t.isCollapsible&&e.isCollapsible?(++t.collapseCount,t.mergeCollapsibleData(e)):this.queuedAssemblyDisplayData.push(e),this.startAssemblyDisplayDataQueueTimeout()}else this.emptyAssemblyDisplayDataQueue(),this.processRootAssemblyDisplayDataInternal(e,t),this.collapsibleDisplayDataTimer.reset()}startAssemblyDisplayDataQueueTimeout(){if((0,Jr.Z)(this.queuedAssemblyTimeout))return;const e=this.viewer.getFrameTimer().getTimingDetails(ia.Q.INTERACTIVE).averageTime,t=this.collapsibleDisplayDataTimer.averageTime,i=Math.max((e+t)*Eh.getNumber("ASSEMBLY_DRAG_COLLAPSE_WAIT_RATIO"),0);this.queuedAssemblyTimeout=window.setTimeout((()=>this.processAssemblyDisplayDataQueue()),i)}emptyAssemblyDisplayDataQueue(){(0,Jr.Z)(this.queuedAssemblyTimeout)&&(window.clearTimeout(this.queuedAssemblyTimeout),this.queuedAssemblyTimeout=null);for(let e=0;e<this.queuedAssemblyDisplayData.length;++e){const t=this.queuedAssemblyDisplayData[e];t.elementId!==this.displayedElementId||t.isCollapsible||this.processRootAssemblyDisplayDataInternal(t)}this.queuedAssemblyDisplayData=[]}processAssemblyDisplayDataQueue(){this.queuedAssemblyTimeout=null;let e=!1;for(let t=0;t<this.queuedAssemblyDisplayData.length&&!e;++t)e=e||this.queuedAssemblyDisplayData[t].elementId===this.displayedElementId&&this.queuedAssemblyDisplayData[t].isCollapsible;if(!e&&this.viewer.getFrameTimer().userIsInteracting())return void this.startAssemblyDisplayDataQueueTimeout();const t=this.queuedAssemblyDisplayData.shift();if(t&&t.elementId===this.displayedElementId){t.isCollapsible&&Eh.getNumber("LOG_ASSEMBLY_DRAG_COLLAPSE_INFO")&&(t.collapseCount>1?(It.log.debug("Did not collapse "+this.notCollapsedAssemblyMessageCount+" messages"),It.log.debug("Collapsed "+t.collapseCount+" display data messages for "+t.elementId),this.notCollapsedAssemblyMessageCount=0):++this.notCollapsedAssemblyMessageCount);const e=(0,Js.Wj)();this.processRootAssemblyDisplayDataInternal(t),t.isCollapsible&&this.collapsibleDisplayDataTimer.addTiming((0,Js.Es)(e))}this.queuedAssemblyDisplayData.length>0&&this.startAssemblyDisplayDataQueueTimeout()}resetAllIncontextGraphicsForPartstudio(e){if(!this.assemblies)return;let t="";const i=Object.keys(this.assemblies);for(let s=0;s<i.length;s++){const n=i[s];if((0,Js.dV)(n)===e){t=n;const e=this.assemblies[t];if(!e)continue;e.reset()}}}processPartStudioDisplayDataList(e,t,i){let s=i;for(const i of e){const e=i;if(!e)return;const n=!0,r=this.getAndUpdatePartStudioForMessage(e,t,n),a=e.microversionIdAndConfigurationInterval.to.equals(e.microversionIdAndConfigurationInterval.from);r&&r.processDisplayData(e,!1,t,a),s=s&&a}return s}processRootAssemblyDisplayDataInternal(e,t){const i=new mh.B7("processRootAssemblyDisplayDataInternal",{setTraceId:!0}),s=e.elementId,n=!!t,r=this.displayedMicroversionAndConfigMatchesDisplayData(e);s!==this.displayedElementId||e.incremental||e.fromDisplayCache||this.clearSilhouetteRequests();let a=this.assemblies[s];a||(a=new yd(s,this,this.viewer),this.assemblies[s]=a,this.integrityCheck()),e.isForInContext&&this.showAssembly(s,e.isForInContext),this.clearHighlights(),a.processOccurrenceDeletions(e,t);const o=this.processPartStudioDisplayDataList(e.partStudioDisplayData,n,r);this.resyncNeeded&&this.resyncFunction?o?(this.resyncNeeded=!1,It.log.warn("Skipped resync when processing tessellation update for assembly "+this.displayedElementId+" "+this.displayedElementMicroversionIdAndConfiguration)):this.resyncPromise=this.resyncAsNeeded().then((()=>{this.processRootAssemblyDisplayDataHelper(s,a,e,o,i),this.resyncPromise=null})):this.processRootAssemblyDisplayDataHelper(s,a,e,o,i)}processRootAssemblyDisplayDataHelper(e,t,i,s,n){if(i.isForInContext&&this.showAssembly(e,i.isForInContext),s&&(this.viewer.getBodyManager().cleanupPendingRefinementRequests(),qc())){const e=[];for(let t=0;t<i.partStudioDisplayData.length;++t){const s=i.partStudioDisplayData[t],n=W.lK7.getFullElementIdString(s.elementId,s.microversionIdAndConfigurationInterval.to.getKey());if(this.getPartStudio(n)){for(const t in s.deterministicPartIdToData)if(s.deterministicPartIdToData.hasOwnProperty(t)){const i=s.deterministicPartIdToData[t];e.push(t+"-"+i.tessellationSettings)}}else It.log.warn(`Cannot find part studio: ${n} to apply display data refinement update.`)}It.log.info("Processing update for bodies:\n"+e);const t=this.getEstimatedMemoryUsageOfBodies();It.log.info("bodyMemoryUse prior to update: "+Zc(t))}if(t.processDisplayData(i),e===this.displayedElementId){const e=!!this.displayedElementMicroversionIdAndConfiguration;this.displayedElementMicroversionIdAndConfiguration=i.microversionIdAndConfigurationInterval.to,this.displayAssembly(this.displayedElementId,e)}if(this.updateOrVerifySelections(null,e),this.refreshHighlight(),this.viewer.getEventDispatcher().trigger(VM.hj,i,s),this.viewer.requestDraw(),t.microversionIdAndConfiguration=i.microversionIdAndConfigurationInterval.to,!s&&this.simulationManager&&this.simulationManager.onAssemblyChanged(),!s){const e=this.viewer.getPendingBodiesToLoadPromise();e?e.then((()=>{this.viewer.getBodyManager().initiateAutomaticRetrieval()})):this.viewer.getBodyManager().initiateAutomaticRetrieval()}this.checkBodyMemoryUsage(i),this.resyncAsNeeded(),n.report()}getOrCreatePartStudio(e,t){const i=t?W.lK7.getFullElementIdString(e,t.getKey()):e;let s=this.partStudios[i];if(!s){if(!this.bodyLoadTasks)throw"Loaders should be constructed prior to handling display data";s=new qd(e,t||null,this,this.bodyLoadTasks,this.usage,this.viewer),this.partStudios[i]=s,this.integrityCheck()}return s}getMicroversionIdsString(e){const t=[];for(const i in this.partStudios){const s=this.partStudios[i];s.getElementId()===e&&t.push(s.getMicroversionIdAndConfiguration())}return"["+t.join(", ")+"]"}getAndUpdatePartStudioForMessage(e,t,i,s){let n;if(!this.isBase())return n=this.partStudios[e.elementId]||this.getOrCreatePartStudio(e.elementId),n.microversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to,n;const r=!(t||i||e.elementId!==this.displayedElementId||e.fromDisplayCache||s);let a=!1;this.displayedElementMicroversionIdAndConfiguration&&!this.displayedElementIsPublicationItem||!r||(this.displayedElementMicroversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to,a=!0);const o=e.buildFullElementId(!0).toString(),h=e.buildFullElementId(!1).toString();if(this.isBase()&&this.viewer.getModelViewManagers().getPreviewManager()&&!e.incremental&&!e.keepFromMicroversion&&o in this.partStudios&&(It.log.info("Received non-incremental base display data during preview/compare. Cloning base reference"),n=this.partStudios[o],this.partStudioPreservedForPreview=n,this.partStudios[o]=n.clone(e.incremental)),o!==h&&o in this.partStudios)h in this.partStudios&&(It.log.info("Deleting existing local copy of : "+h),this.partStudios[h].onDeletion(),delete this.partStudios[h]),n=this.partStudios[o],e.keepFromMicroversion?n=n.clone(e.incremental):delete this.partStudios[o],this.partStudios[h]=n,n.microversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to,this.getDisplayedFullElementId()===o&&r&&(this.displayedElementMicroversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to);else{if(o!==h&&e.microversionIdAndConfigurationInterval.from&&e.microversionIdAndConfigurationInterval.from.microversion.theId)return this.partStudios[h]?(It.log.trace("Skipped application of increment for part studio "+e.elementId+" because it was incrementing to a microversion that was already present "+e.microversionIdAndConfigurationInterval.to),r&&(this.displayedElementMicroversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to),this.partStudios[h].updateExternalState(t,i)):(It.log.warn("Skipped application of increment for part studio "+e.elementId+" due to missing from data.  Interval with missing data: "+e.microversionIdAndConfigurationInterval+". Existing microversions for element: "+this.getMicroversionIdsString(e.elementId)),this.setResyncNeeded(),a&&(this.displayedElementMicroversionIdAndConfiguration=null)),null;if(e.incremental&&!(h in this.partStudios))return It.log.warn("Skipped creation of part studio "+e.elementId+" because the destination microversion is missing.  MV interval: "+e.microversionIdAndConfigurationInterval+". From display cache: "+e.fromDisplayCache+". Existing microversions for element: "+this.getMicroversionIdsString(e.elementId)),this.setResyncNeeded(),a&&(this.displayedElementMicroversionIdAndConfiguration=null),null;n=this.getOrCreatePartStudio(e.elementId,e.microversionIdAndConfigurationInterval.to)}return n.updateExternalState(t,i),n}processManagedData(e){var t,i;(null===(t=null==e?void 0:e.computedData)||void 0===t?void 0:t.computedData)&&(this.displayedPartStudio&&(null===(i=this.displayedPartStudio.microversionIdAndConfiguration)||void 0===i?void 0:i.equals(e.microversionIdAndConfigurationInterval.to))?(this.displayedPartStudio.addManagedIdMappings(e.computedData.computedData),this.pendingPartStudioComputedData=null):this.pendingPartStudioComputedData=e)}processReceivedInsertableDisplayData(e){const t=this.partStudios[this.getDisplayedFullElementId()];t&&t.processReceivedInsertableData(e)}processPartStudioDisplayData(e,t){var i,s;const n=!!this.displayedElementMicroversionIdAndConfiguration;this.lastPartStudioProcessed=e.elementId,this.lastPartStudioMicroversionIdAndConfigurationIntervalProcessed=e.microversionIdAndConfigurationInterval;const r=this.displayedMicroversionAndConfigMatchesDisplayData(e);r?this.viewer.getBodyManager().cleanupPendingRefinementRequests():this.viewer.getBodyManager().clearPreviewOccurrences(),this.isBase()&&this.hideInactiveContextAssemblies(e);const a=this.getAndUpdatePartStudioForMessage(e,e.isExternal);if(e.incremental)for(const t in e.deterministicPartIdToData)if(!e.deterministicPartIdToData[t].isACopyForTessellationSettings){const i=Aa(e.elementId,t,70,40);Da(i),Ta(i)}const o=this.isBase()?e.buildFullElementId().toString()===this.getDisplayedFullElementId():this.displayedElementId===e.elementId&&!e.fromDisplayCache;if(o&&(this.displayPartStudio(this.getDisplayedFullElementId()),e.incremental||(this.partStudioVisibilityUpdated=!1)),a&&!e.isNoop){const n=!1,h=this.viewer.getModelViewManagers().getManager();let c;if(e.usage===W.rvN.PREVIEW_AFTER){c=new St.StringSet;const t=h.partsAtTheBeginningOfEdit,i=h.sheetModelIdsAtTheBeginningOfEdit;e.partDisplayData.forEach((s=>{const n=e.deterministicPartIdToData[s.id];let r=null;if(n)r=n.sheetMetalModelId;else{const e=this.viewer.getModelViewManagers().getPreviewManager().retrieveBodyMetaData(null,s.id);r=e?e.sheetMetalModelId:null}t.contains(s.id)||i.contains(r)||c.add(s.id)}))}if(a.processDisplayData(e,o,n,r,c),null===(i=this.viewer.getCurvatureAnalysisManager())||void 0===i||i.onPartStudioDisplayDataChanged(e,e.buildFullElementId().toString()),null===(s=this.thicknessAnalysisManager)||void 0===s||s.onPartStudioDisplayDataChanged(e),e.usage===W.rvN.PREVIEW_BEFORE){this.partsAtTheBeginningOfEdit=new St.StringSet,this.sheetModelIdsAtTheBeginningOfEdit=new St.StringSet,this.newParts=new St.StringSet;const t=this.displayedPartStudio,i=this;e.partDisplayData.forEach((function(e){i.partsAtTheBeginningOfEdit.add(e.id);const s=t.retrieveBodyMetaData(e.id);s&&s.sheetMetalModelId&&i.sheetModelIdsAtTheBeginningOfEdit.add(s.sheetMetalModelId)}))}else e.usage===W.rvN.PREVIEW_AFTER&&(h.newParts=c);this.updateOrVerifySelections(t,e.elementId),this.viewer.getEventDispatcher().trigger(VM.cy,e.elementId),this.refreshHighlight()}else a&&a.processInContextData(e,o);return this.resyncNeeded&&(r?(this.resyncNeeded=!1,It.log.warn("Skipped resync when processing tessellation update for part studio "+this.displayedElementId+" "+this.displayedElementMicroversionIdAndConfiguration)):this.resyncAsNeeded()),o&&(this.processInContextDisplayData(e,r),this.selectedSheetmetalModelId&&this.showPartsWithSheetmetalModelIdOnly(this.selectedSheetmetalModelId),this.pendingPartStudioComputedData&&this.processManagedData(this.pendingPartStudioComputedData),n||this.viewer.getIsForFlattenedDisplay()||this.viewer.getEventDispatcher().trigger(VM.ad,e.elementId,!n)),this.checkBodyMemoryUsage(e),r}populateClientCacheStateDisplayInformation(e){this.emptyAssemblyDisplayDataQueue();this.viewer.processQueuedDisplayData(!0);this.getPartStudioSortedForCache().forEach((function(t){t.populateClientCacheStateDisplayInformation(e)}),this),Object.values(this.assemblies).forEach((function(t){t.populateClientCacheStateDisplayInformation(e)}),this)}displayPartStudio(e){var t;const i=this.partStudios[e];i!==this.displayedPartStudio&&this.removePartStudioDisplay(),i&&(i.instantiateForEditingInNode(this.getElementRootNode()),this.displayedPartStudio=i,null===(t=this.viewer.getCurvatureAnalysisManager())||void 0===t||t.onPartStudioDisplayed());ft.T.isElementAtVersionOrLater(W.vgi.V343_SUBFEATURES)&&!ps.Jq.StateService.isOnDocumentCompare()?(this.viewer.getEdgePointController()||this.viewer.createEdgePointController(),this.viewer.getEdgePointController().enable()):this.viewer.getEdgePointController()&&this.viewer.getEdgePointController().disable()}removePartStudioDisplay(){this.displayedPartStudio&&(this.displayedPartStudio.removeInstantiationForEditing(this.getElementRootNode()),this.displayedPartStudio=null)}displayAssembly(e,t){const i=this.assemblies[e];i&&(this.getElementRootNode(),i.show(),this.simulationManager&&this.simulationManager.onAssemblyDisplayed(),this.viewer.getEventDispatcher().trigger(VM.t0,e,t))}getModelBounds(e){const t=new Li.kB,i=this.getSceneGraph().getRootNode(),s=i.getChildById(RI);if(s&&s.getBoundingBox().isInitialized()&&t.addBox(s.getBoundingBox()),!e||!e.doNotBoundTemporarySketchEntities){const e=i.getChildrenWithPrefix(_I);if(e)for(let i=0;i<e.length;++i)t.addBox(e[i].getBoundingBox())}const n=this.getDisplayedElement();return n&&t.addBox(n.getBoundsOutsideElementNode()),t.addBox(this.viewer.getBodyManager().getUnloadedBodyBounds()),t.isInitialized()?t:null}setModelTransform(e){const t=this.getSceneGraph().getRootNode(),i=t.getChildById(RI),s=t.getChildById(wI);i&&i.setPose(e),s&&s.setPose(e),this.applyToPreview(this.setModelTransform,arguments)}getModelTransform(){const e=this.getSceneGraph().getRootNode().getChildById(RI);return e?e.getPose():null}getEntityBounds(e,t){const i=this.getPartStudioDataFromOccurrence(t);if(!i)return null;const s=i.getEntityBounds(e,t);return s&&t?s.createTransformedCopy(this.getOccurrenceTransform(t)):s}getFeatureBounds(e){if(!this.displayingPartStudio())return null;const t=this.getDisplayedPartStudio();return t?t.getFeatureBounds(e):null}getBodyBounds(e,t){const i=this.getDisplayedElement();return i?i.getBodyBounds(e,t):null}getSelectionFitBounds(e){if(!e)return null;const t=e.getIdString(),i=e.getOccurrence();switch(e.getType()){case W.lQt.ENTITY:let e=this.getEntityBounds(t,i);return e||(e=this.getEntityBounds(this.alternateEntityMapping.get(t),i)),e;case W.lQt.FEATURE:if(Ys()){const e=new Li.kB;return e.addBox((0,Ih.IO)().getManager().getFeatureBounds(t)),e.addBox((0,Ih.IO)().getPreviewManager().getFeatureBounds(t)),e}return this.getFeatureBounds(t);case W.lQt.BODY:let s=this.getBodyBounds(t,i);return s||(s=this.getBodyBounds(this.alternateEntityMapping.get(t),i)),s;case W.lQt.TABLE_ITEM:case W.lQt.OCCURRENCE:return i?this.getOccurrenceBounds(i):null;default:return null}}getElementRootNode(){const e=this.getSceneGraph().getRootNode();if(!e.getChildById(RI)){const t=new ts(RI);e.addChild(t,0),this.instantiateSharedNodes(t)}return e.getChildById(RI)}getElementPreviewRootNode(){const e=this.getSceneGraph().getRootNode();if(!e.getChildById(wI)){const t=new ts(wI);e.addChild(t),t.addChild(this.elementPreviewBodyNode)}return e.getChildById(wI)}cloneForPreview(e){const t=new mh.B7("ModelViewManager.cloneForPreview"),i=new Sh(Ls.L.PREVIEW,this.occurrenceDataManager,this.viewer),s=this.getDisplayedPartStudio();if(!s)throw"There is no base part studio to clone.";if(s.getElementId()!==e.elementId)throw"Displayed part studio does not match the part studio being previewed";i.sharedBaseMeshManager=this.meshManager.cloneForPreview(s.getMeshOwnerId());const n=s.cloneForPreview(i,!1);return i.partStudios[e.elementId]=n,i.displayedElementId=e.elementId,i.displayedElementType=W.GNh.PARTSTUDIO,i.setBodyLoadTasks(this.bodyLoadTasks),i.displayPartStudio(e.elementId),i.occurrenceDataManager=this.occurrenceDataManager,i.alternateEntityMapping=this.alternateEntityMapping,i.selectedSheetmetalModelId=this.selectedSheetmetalModelId,i.processManagedData(this.pendingPartStudioComputedData),t.report(),i}onPreviewDestroyed(){Object.values(this.partStudios).forEach((function(e){e.onPreviewDestroyed()}),this),this.partStudioPreservedForPreview&&(this.partStudioPreservedForPreview.onDeletion(),this.partStudioPreservedForPreview=null)}getPartStudioSortedForCache(){return Object.values(this.partStudios).sort((function(e,t){return e.getIsInternal()===t.getIsInternal()?e.microversionIdAndConfiguration.microversion.theId===t.microversionIdAndConfiguration.microversion.theId?e.microversionIdAndConfiguration.getKey()<t.microversionIdAndConfiguration.getKey()?-1:1:e.microversionIdAndConfiguration.microversion.theId<t.microversionIdAndConfiguration.microversion.theId?-1:1:e.getIsInternal()?-1:1}))}resetDisplayedElement(){this.displayedElementMicroversionIdAndConfiguration=null}onChangeActiveElement(e,t,i){var s,n;if(this.clearSilhouetteRequests(),this.simulationManager&&this.simulationManager.clearSimulationAndConnectionGraphics(),null===(s=this.viewer.getCurvatureAnalysisManager())||void 0===s||s.onChangeActiveElement(),null===(n=this.generativeDesignManager)||void 0===n||n.onChangeActiveElement(),this.displayingAssembly()){const e=this.assemblies[this.displayedElementId];e&&e.hide()}else this.displayingPartStudio()&&this.removePartStudioDisplay();this.displayedElementId="",this.displayedElementMicroversionIdAndConfiguration=null,this.displayedElementIsPublicationItem=void 0,this.partStudioVisibilityUpdated=!1,e?(this.displayedElementType=t,this.displayedElementType===W.GNh.PARTSTUDIO?(this.displayedElementId=e,this.displayedElementIsPublicationItem=i,this.displayedElementMicroversionIdAndConfiguration=null,this.viewer.requestDraw()):this.displayedElementType===W.GNh.ASSEMBLY?(this.displayedElementId=e,this.displayedElementIsPublicationItem=i,this.viewer.requestDraw()):this.displayedElementId=""):this.displayedElementId="",this.integrityCheck();!this.displayingPartStudio()&&this.viewer.getEdgePointController()&&this.viewer.getEdgePointController().disable()}displayingPartStudio(){return this.displayedElementType===W.GNh.PARTSTUDIO}displayingAssembly(){return this.displayedElementType===W.GNh.ASSEMBLY}getDisplayedElementId(){return this.displayedElementId}getDisplayedElement(){return this.displayingPartStudio()?this.partStudios[this.isBase()?this.getDisplayedFullElementId():this.displayedElementId]:this.displayingAssembly?this.assemblies[this.displayedElementId]:null}getDisplayedElementMicroversionId(e){if(e===Ls.L.PREVIEW&&this.usage!==Ls.L.PREVIEW)return this.applyToPreview(this.getDisplayedElementMicroversionId,arguments);const t=this.getDisplayedElement();return t&&t.microversionIdAndConfiguration&&t.microversionIdAndConfiguration.microversion?t.microversionIdAndConfiguration.microversion.theId:""}getDisplayedPartStudio(){return this.partStudios[this.getDisplayedFullElementId()]||null}getDisplayedInContextAssembly(){const e=this.getDisplayedPartStudio();return e&&e.isDisplayingIncontextAssembly()?this.assemblies[e.getVisibleInContextAssemblyId()]:null}getDisplayedAssembly(){return this.assemblies[this.displayedElementId]||null}getPartStudioVisibilityUpdated(){return this.partStudioVisibilityUpdated}setPartStudioVisibilityUpdated(){this.getDisplayedPartStudio()&&(this.partStudioVisibilityUpdated=!0)}getInContextOccurrenceDisplayData(e){const t=this.getDisplayedPartStudio();if(t){const i=this.assemblies[t.getVisibleInContextAssemblyId()];if(i){const t=i.getDisplayDataForOccurrence(e);if(t)return t}}return null}getOccurrenceDisplayData(e){const t=this.assemblies[this.displayedElementId];return t?t.getOccurrenceDisplayData(e):this.getInContextOccurrenceDisplayData(e)}getMateConnectorGraphics(e,t){if(this.displayingAssembly()){const i=this.assemblies[this.displayedElementId];if(i)return i.getMateConnectorGraphics(e,t)}else if(this.displayingPartStudio()){if(e){const i=this.getDisplayedInContextAssembly();if(i)return i.getMateConnectorGraphics(e,t)}const i=this.partStudios[this.getDisplayedFullElementId()];if(i)return i.getMateConnectorGraphics(e,t)}return null}hasMateIndicatorForOccurrence(e){if(this.displayingAssembly()){const t=this.assemblies[this.displayedElementId];if(t)return t.hasMateIndicatorForOccurrence(e)}return!1}hasGraphicsOccurrenceData(e){return!!e.isAssemblyRoot()||!!this.getOccurrenceDisplayData(e)}getOccurrenceElementId(e){const t=this.getOccurrenceDisplayData(e);return t?t.fullElementId:null}getOccurrenceTransform(e){const t=this.getOccurrenceDisplayData(e);return t?t.occurrenceData.transform.getGlMatrix():ge.create()}updateOccurrenceTransform(e,t){const i=this.assemblies[this.displayedElementId];i&&i.updateOccurrenceTransform(e,t)}batchUpdateOccurrenceTransforms(e){if(0===e.length)return!0;const t=this.assemblies[this.displayedElementId];return!!t&&t.batchUpdateOccurrenceTransforms(e)}getPartStudios(){return Object.values(this.partStudios)}getPartStudioDataFromOccurrence(e){if(this.displayingAssembly()){if(!e)return It.log.warn("An attempt was made to retrieve an part studio data from an assembly without a specified occurrence"),null;const t=this.assemblies[this.displayedElementId];if(t){const i=t.getDisplayDataForOccurrence(e);if(i)return this.partStudios[i.fullElementId.toString()]||null}}else if(this.displayingPartStudio()){if(e){const t=this.getInContextOccurrenceDisplayData(e);if(t&&this.partStudios[t.fullElementId.toString()])return this.partStudios[t.fullElementId.toString()]}return this.partStudios[this.getDisplayedFullElementId()]||null}return null}getPartStudio(e){return(e=e.toString()).length>0&&e.length<=25&&"-"!==e&&this.isBase()&&It.log.info("An attempt was made to get part studio with id that is not in elementId-microversionId format"),this.partStudios[e]||null}getDeterministicIdForFeature(e,t,i){let s;const n=this,r=n.getEntitiesForFeature(e,t);return r&&(s=r.find((function(t){const s=n.retrieveEntityMetaData(e,t);if(s){const n=(0,ve.fl)(t,s,{},e);if(n&&(!i||i.filter(n)))return!0}return!1}))),s||""}getDeterministicIdForPickId(e,t){const i=e?this.getPartStudioDataFromOccurrence(e):this.getDisplayedPartStudio();return i?i.getEntityIdManager().getNameForId(t):null}retrieveEntityMetaData(e,t){if(t.startsWith(W.FBt.SECTION_IDENTIFIER)){const e=(0,QS.Ky)();return null==e?void 0:e.getEntityMetaData(t)}let i=this.getDisplayedPartStudio();if(e&&(i=this.getPartStudioDataFromOccurrence(e)),!i)return null;let s=i.retrieveEntityMetaData(t);if(!s){const e=this.alternateEntityMapping.get(t);e&&(s=i.retrieveEntityMetaData(e))}return s}retrieveBodyMetaData(e,t){let i=this.getDisplayedPartStudio();if(e&&(i=this.getPartStudioDataFromOccurrence(e)),!i)return null;let s=i.retrieveBodyMetaData(t);return!s&&(s=this.applyToPreview(this.retrieveBodyMetaData,arguments)||null,s)?(s.foundInPreview=!0,s):s}retrieveAssociatedFeatureIds(e,t){let i=this.getDisplayedPartStudio();return e&&(i=this.getPartStudioDataFromOccurrence(e)),i?i.retrieveAssociatedFeatureIds(t):null}getFlattenedEntityOwnerBodyDetails(e,t){if(!this.viewer.getIsForFlattenedDisplay())return null;const i=this.retrieveEntityMetaData(t,e);if(!i)return null;const s=this.getPartStudioDataFromOccurrence(t);if(!s)return null;let n=null;if(n=i.isFromSketch()?s.getSketchComponent().getOwnerFlattenedBodyId(e):i.getBodyId(),!n)return null;const r=s.retrieveBodyMetaData(n);if(r){return{bodyMetaData:r,transform:s.getBodyComponent().getTransformFromSheetMetalBodyMetaData(r)}}return null}updatePSOI(e){const t=this.getDisplayedPartStudio();t&&t.updatePSOI(e)}getPartStudioBodyMetaDataAssociatedWithSelections(e){if(!this.displayingPartStudio())return[];const t=new Set;e&&t.add(e),(0,ve.vi)().each((function(e){if(!e.getOccurrence()){const i=e.getBodyId();i&&t.add(i)}}),this);const i=[];return t.forEach((function(e){const t=this.retrieveBodyMetaData(null,e);t&&i.push(t)}),this),i.filter((e=>!e.getIsFromSketch()))}getAssemblyOccurrencesAssociatedWithSelections(){if(!this.displayingAssembly())return[];const e=[];return(0,ve.vi)().forEach((t=>{e.push(t.getOccurrence().getPathAsString())})),e}hasEntity(e,t){return!!this.retrieveEntityMetaData(e,t)}hasFeature(e,t){const i=this.getCurrentPartStudioData(e);return!!i&&i.hasFeature(t)}getFirstMateConnectorId(e){const t=this.getCurrentPartStudioData(e);return t?t.mateConnectorComponent.featureToIds.firstKey():null}assemblyHasHiddenOccurrences(){const e=this.getDisplayedAssembly();if(e)for(const t in e.occurrences)if(e.occurrences[t].isHidden)return!0;return!1}getAllMateConnectorIds(e,t){let i=[];const s=this.getCurrentPartStudioData(e);if(s)i=s.mateConnectorComponent.getInstantiatedMateConnectorsForOccurrence(e);else if(this.displayingAssembly()&&e){const s=this.assemblies[this.displayedElementId];s&&(i=s.getMateConnectorIdsForOccurrence(e,t))}return i}hasBody(e,t){const i=this.getCurrentPartStudioData(e);return!!i&&i.hasBody(t)}getCurrentPartStudioData(e){return e?this.getPartStudioDataFromOccurrence(e):this.getDisplayedPartStudio()}hideSketch(e){const t=this.getDisplayedPartStudio();t&&t.hideSketch(e),this.applyToPreview(this.hideSketch,arguments)}retrieveSketchEntityDeterministicId(e,t){const i=this.getDisplayedPartStudio();return i?i.retrieveSketchEntityDeterministicId(e,t):null}showSketch(e){const t=this.getDisplayedPartStudio();t&&t.showSketch(e),this.applyToPreview(this.showSketch,arguments)}displaySketchAsActive(e){const t=this.getDisplayedPartStudio();t&&t.displaySketchAsActive(e)}displaySketchAsInactive(e){const t=this.getDisplayedPartStudio();t&&t.displaySketchAsInactive(e)}hasActiveSketch(){const e=this.getDisplayedPartStudio();return!!e&&e.hasActiveSketch()}hideInactiveContextAssemblies(e){if($s())return;const t=e.assemblyReferenceDisplayData,i=new St.StringSet;let s;for(s=0;s<t.assemblyReferences.length;s++){const e=t.assemblyReferences[s],n=e.assemblyDisplayData,r=(0,Js.HL)(n.elementId,t.elementId,e.referenceNodeId);i.add(r),e.visibility!==W.HRI.VISIBLE&&this.hideAssembly(r)}const n=this.getDisplayedPartStudio();if(n){const e=n.getReferencedInContextAssemblyIds();for(s=0;s<e.length;s++)i.contains(e[s])||this.hideAssembly(e[s])}}processInContextDisplayData(e,t){e.isBase()&&(this.viewer.getIsForFlattenedDisplay()?this.processInContextDisplayDataForFlat(e,t):this.viewer.getIsPrimaryViewer()&&this.processInContextDisplayDataFor3d(e,t))}processInContextDisplayDataFor3d(e,t){let i=!1;const s=e.assemblyReferenceDisplayData;for(let t=0;t<s.assemblyReferences.length;t++){const n=s.assemblyReferences[t],r=n.assemblyDisplayData;if(n.visibility!==W.HRI.VISIBLE)continue;r.elementId=(0,Js.HL)(r.elementId,s.elementId,n.referenceNodeId);const a=[];n.occurrencesToExclude.forEach((function(e){a.push(e.getPathAsString())}));const o=[];r.occurrences.push(W.yLM.createRootOccurrenceDisplayData(r.elementId)),r.occurrences.forEach((function(e){const t=e.occurrenceData.occurrence.getPathAsString(),i=e.occurrenceData.transform.getGlMatrix(),s=n.transform.getGlMatrix(),r=pe.w$.multiply(s,i,ge.create());e.occurrenceData.transform.updateFromGlMatrix(r),o.push(e),a.indexOf(t)>=0&&(e.partIds=[],e.fullElementId=new W.lK7)})),r.occurrences=o,$s()||this.viewer.onRootAssemblyDisplayData(r,e),i=!0}i?(0,VM.xA)().trigger(VM.bh,i):e.isNoop||(0,VM.xA)().trigger(VM.bh,i)}processInContextDisplayDataForFlat(e,t){if($s())return;const i=e.assemblyReferenceDisplayData;for(let e=0;e<i.assemblyReferences.length;e++){const s=i.assemblyReferences[e].assemblyDisplayData,n=!0;this.processPartStudioDisplayDataList(s.partStudioDisplayData,n,t)}}applyToPreview(e,t){if(this.isBase()){const i=this.viewer.getModelViewManagers().getPreviewManager();if(i)return e.apply(i,t)}return null}showConstructionPlane(e){const t=this.getDisplayedPartStudio();t&&t.showConstructionPlane(e),this.applyToPreview(this.showConstructionPlane,arguments),this.viewer.requestDraw()}hideMateConnector(e,t){const i=this.getDisplayedPartStudio();i&&i.hideMateConnector(e,t),this.applyToPreview(this.hideMateConnector,arguments),this.viewer.requestDraw()}showMateConnector(e,t){const i=this.getDisplayedPartStudio();i&&i.showMateConnector(e,t),this.applyToPreview(this.showMateConnector,arguments),this.viewer.requestDraw()}hideFeatureBodies(e,t){const i=this.getDisplayedPartStudio();i&&i.hideFeatureBodies(e,t),this.applyToPreview(this.hideFeatureBodies,arguments),this.viewer.requestDraw()}showFeatureBodies(e,t){const i=this.getDisplayedPartStudio();i&&i.showFeatureBodies(e,t),this.applyToPreview(this.showFeatureBodies,arguments),this.viewer.requestDraw()}hideConstructionPlane(e){const t=this.getDisplayedPartStudio();t&&t.hideConstructionPlane(e),this.applyToPreview(this.hideConstructionPlane,arguments),this.viewer.requestDraw()}hidePart(e){let t=!1;const i=this.getDisplayedPartStudio();return i&&(t=i.hidePart(e)),this.applyToPreview(this.hidePart,arguments),this.viewer.requestDraw(),t}showPart(e){let t=!1;const i=this.getDisplayedPartStudio();return i&&(t=i.showPart(e)),this.applyToPreview(this.showPart,arguments),this.viewer.requestDraw(),t}setPlaneAppearance(e,t){const i=this.getDisplayedPartStudio();i&&(i.setPlaneAppearance(e,t),this.viewer.requestDraw()),this.applyToPreview(this.setPlaneAppearance,arguments)}hidePointBodies(e){const t=this.getDisplayedPartStudio();t&&(t.hidePointBodies(e),this.applyToPreview(this.hidePointBodies,arguments),this.viewer.requestDraw())}showPointBodies(e){const t=this.getDisplayedPartStudio();t&&(t.showPointBodies(e),this.applyToPreview(this.showPointBodies,arguments),this.viewer.requestDraw())}changePartColor(e,t,i){const s=this.getDisplayedPartStudio();s&&(s.changePartColor(e,t,i),this.viewer.requestDraw())}changePartOpacity(e,t,i){const s=this.getDisplayedPartStudio();s&&(s.changePartOpacity(e,t,i),this.viewer.requestDraw())}getPartColor(e){const t=this.getDisplayedPartStudio();return t?t.getPartColor(e):null}getPartOpacity(e){const t=this.getDisplayedPartStudio();return t?t.getPartOpacity(e):-1}getOccurrenceColor(e){const t=this.getPartStudioDataFromOccurrence(e);return t?t.getBodyComponent(e).getOccurrenceColor(e):null}setOccurrenceAlphaModifier(e,t){const i=this.getPartStudioDataFromOccurrence(e);i&&i.getBodyComponent(e).setOccurrenceAlphaModifier(e,t)}clearOccurrenceAlphaModifier(e){const t=this.getPartStudioDataFromOccurrence(e);t&&t.getBodyComponent(e).clearOccurrenceAlphaModifier(e)}addTemporarySketchComponent(e){this.temporarySketchComponents[e.getUniqueId()]=e}removeTemporarySketchComponent(e){delete this.temporarySketchComponents[e.getUniqueId()]}processEntitiesHighlight(e,t,i,s){let n=DI.KF;const r=this.getPartStudioDataFromOccurrence(t);if(t&&(n=this.viewer.getOccurrenceIdManager().getIdForName(t.getPathAsString())),n!==DI.Qy)for(let t=0;t<i.length;++t){const a=i[t];r.updateEntityHighlight(e,s,a,n),this.updateTemprorarySketchHighlights(e,s,a,n);const o=this.alternateEntityMapping.get(a);if(o){const t=o.split(Pn.ID_SEPARATOR);for(let i=0;i<t.length;i++)r.updateEntityHighlight(e,s,t[i],n)}}}updateTemprorarySketchHighlights(e,t,i,s){for(const n in this.temporarySketchComponents)this.temporarySketchComponents[n].updateEntityHighlight(e,t,i,s)}getDimensionGraphic(e,t){let i=null;return this.displayedElementType===W.GNh.PARTSTUDIO&&(i=this.getDisplayedPartStudio()),i?i.getDimensionGraphic(e,t):null}processOccurrenceHighlight(e,t,i){const s=i.cloneForOccurrence(t);let n;if(t&&t.path[0]===Hp.PART_STUDIO_BODY_OCCURRENCE_PREFIX)n=[t];else{const i=this.assemblies[this.displayedElementId];if(!i)return;n=i.getLeafOccurrencesContainedWithinOccurrence(t);for(let t=0;t<n.length;++t){const r=i.getOccurrenceEntityIdsForHighlight(n[t]);r.length>0&&this.processEntitiesHighlight(e,n[t],r,s)}}this.viewer.getBodyManager().onOccurrencesHighlighted(e,n),this.occurrenceDataManager.processHighlightForOccurrences(e,n,s,this.usage)}getOccurrenceIdForSelection(e){if(e.getOccurrence())return this.viewer.getOccurrenceIdManager().getIdForName(e.getOccurrence().getPathAsString());{const t=this.getPartStudioDataFromOccurrence(e.getOccurrence());if(t)return t.getPartStudioOccurrenceIdForSelection(e)}return DI.Qy}getEntityIdsForSelection(e){let t=null;const i=this.getPartStudioDataFromOccurrence(e.getOccurrence());return i&&(t=i.getEntityIdsForSelection(e)),t||[]}getEntitiesForFeature(e,t,i){let s=this.displayedPartStudio;return e&&(s=this.getPartStudioDataFromOccurrence(e)),s?s.getEntitiesForFeature(t,i):null}getFeatureIdsRelatedToBody(e,t){const i=e?this.getPartStudioDataFromOccurrence(e):this.getDisplayedPartStudio();if(!i)return[];const s=new Set,n=i.getEntitiesForBody(t);for(let t=0;t<n.length;++t){const r=i.retrieveEntityMetaData(n[t]);if(r){const e=r.getFeatureIds();for(let t=0;t<e.length;++t)s.add(e[t])}for(const i of this.retrieveAssociatedFeatureIds(e,n[t]))s.add(i)}for(const i of this.retrieveAssociatedFeatureIds(e,t))s.add(i);return[...s]}getBodyIdsRelatedToFeature(e,t){const i=e?this.getPartStudioDataFromOccurrence(e):this.getDisplayedPartStudio();if(!i)return[];const s=i.getEntitiesForFeature(t),n=new Set;for(let e=0;e<s.length;++e){const t=i.retrieveEntityMetaData(s[e]);t&&n.add(t.getBodyId())}return[...n]}getEntitiesForBody(e,t){const i=this.getPartStudioDataFromOccurrence(e);return i?i.getEntitiesForBody(t):null}getIncrementsForFeature(e,t){const i=this,s=[],n=i.getEntitiesForFeature(e,t);return n&&n.forEach((function(t){const n=i.extractMeshIncrement(t,e);n&&s.push(n)})),s}extractMeshIncrement(e,t){var i;if(null==e?void 0:e.startsWith(W.FBt.SECTION_IDENTIFIER)){const t=(0,QS.Ky)();return null!==(i=null==t?void 0:t.extractMeshIncrement(e))&&void 0!==i?i:null}let s=this.getDisplayedPartStudio();return t&&(s=this.getPartStudioDataFromOccurrence(t)),s?s.extractMeshIncrement(e):null}isEntityOnOccurrence(e,t){const i=this.getOccurrenceDisplayData(t);if(!i)return!1;const s=this.retrieveEntityMetaData(t,e);return!!s&&(this.occurrenceContainsBody(i,s.getBodyId())||i.containsPart(e))}occurrenceContainsBody(e,t){if(e.containsPart(t))return!0;const i=this.partStudios[e.fullElementId.toString()];if(!i)return!1;if(i.getSketchComponent().hasBody(t)){const s=i.getEntitiesForBody(t);for(let t=0;t<s.length;++t)if(e.containsPart(s[t]))return!0}const s=i.retrieveBodyMetaData(t);if(!s)return!1;if(s.isClosedCompositeConstituent&&e.containsPart(s.consumingClosedCompositeData.id))return!0;if(s.referencingOpenCompositeData)for(const[t,i]of s.referencingOpenCompositeData)if(e.containsPart(t))return!0;return!1}isNodeForModel(e){return e.getId()===RI||!!e.getParent()&&this.isNodeForModel(e.getParent())}isNodeForSketch(e){return e.getId()===Zp}isNodeForBody(e,t){if(0===e.getId().indexOf(gp))return!0;if(t){if(this.simulationManager)return this.simulationManager.isNodeForBodyVisualization(e);if(this.thicknessAnalysisManager)return this.thicknessAnalysisManager.isNodeForBodyVisualization(e)}return!1}isNodeForFaces(e){return e.isFaces()}isNodeForEdges(e){return e.isEdges()}isNodeForPoints(e){return e.isPoints()}handleAllSelectionListHighlights(){var e;const t=null===(e=this.viewer.getFilteredEntitiesHighlightController())||void 0===e?void 0:e.getSelectionList();!this.selectionListNameToListAndHighlightType.get($C.SELECTION_LIST_NAME)&&t&&this.handleSelectionListHighlights($C.SELECTION_LIST_NAME,t,yn.o2.FILTERED_ENTITIES),this.viewer.getIsForPreviousVersionDisplay()||(this.handleSelectionListHighlights("selectionList",(0,ve.vi)()),this.handleSelectionListHighlights("preselectionList",(0,ve.Wf)(),yn.o2.PRE),this.handleSelectionListHighlights("secondarySelectionList",(0,ve.wT)(),yn.o2.SECONDARY),this.handleSelectionListHighlights("secondaryPreSelectionList",(0,ve.Dk)(),yn.o2.SECONDARY_PRE),this.handleSelectionListHighlights("smartSelectionList",(0,ve.PV)(),yn.o2.SMART_SELECTION),this.handleSelectionListHighlights("accumulatedSmartSelections",(0,ve.Tb)(),yn.o2.ACCUMULATED_SMART_SELECTION),this.handleSelectionListHighlights("commentSelectionList",(0,ve.d7)(),yn.o2.COMMENT),this.handleSelectionListHighlights("gapSelectionList",(0,Fa.d4)()),this.handleSelectionListHighlights("errorSelectionList",(0,ve.yb)(),yn.o2.ERROR),this.handleSelectionListHighlights("retrievalSelectionList",(0,ve.iH)(),yn.o2.RETRIEVAL))}resetSelectionListHandlers(){for(const e of this.selectionListNameToListAndHighlightType.values())this.stopListening(e.selectionList);this.selectionListNameToListAndHighlightType.clear(),this.handleAllSelectionListHighlights(),this.meshPointController&&this.meshPointController.resetSelectionListHandlers()}handleSelectionListHighlights(e,t,i){this.selectionListNameToListAndHighlightType.get(e)&&(It.log.warn(`Attempt to add selectionList with duplicate name ${ve.o$} to handle selections for. Removing the old one before adding the new one.`),this.removeSelectionListHandler(e)),this.selectionListNameToListAndHighlightType.set(e,{selectionList:t,highlightType:i});const s=this;this.selectionsToClearOnReset[e]={},this.listenTo(t,"add",(function(t){s.processSelectionHighlight(yn.aU.ADD,t,e,i)})),this.listenTo(t,"remove",(function(t){s.processSelectionHighlight(yn.aU.REMOVE,t,e,i)})),this.listenTo(t,"reset",(function(t){s.resetSelectionListHighlights(t,e,i)})),t.each((function(t){s.processSelectionHighlight(yn.aU.ADD,t,e,i)}))}removeSelectionListHandler(e){const t=this.selectionListNameToListAndHighlightType.get(e);t&&(this.clearSelectionHighlight(e,t.highlightType),this.stopListening(t.selectionList),this.selectionListNameToListAndHighlightType.delete(e)),delete this.selectionsToClearOnReset[e]}resetSelectionListHighlights(e,t,i){this.clearSelectionHighlight(t,i),e.each((function(e){this.processSelectionHighlight(yn.aU.ADD,e,t,i)}),this)}updateOrVerifySelections(e,t){if(!this.viewer.getIsPrimaryViewer())return;const i=this;(0,ve._g)().forEach((function(s){i.updateOrVerifySelectionsInList(e,t,s)}))}updateOrVerifySelectionsInList(e,t,i){const s=[];let n=!1,r=!0;const a=this,o={},h=(0,ve.VT)(),c=!h||!h.getReceivesComputedData();return i.each((function(i){let h=i;if(h.getUsage()!==a.usage)return;e&&(h=e.updateSelection(h,t),h=h||i);let l=!c&&!!h;if(h&&c)switch(h.getType()){case W.lQt.ENTITY:l=a.hasEntity(h.getOccurrence(),h.getIdString())||h.isSectionEntity();break;case W.lQt.FEATURE:case W.lQt.FOLDER:case W.lQt.ROLLBACKBAR:l=!0;break;case W.lQt.BODY:l=a.hasBody(h.getOccurrence(),h.getIdString());break;case W.lQt.MATE_CONNECTOR:case W.lQt.OCCURRENCE:case W.lQt.MATE:case W.lQt.NON_GEOMETRIC_ITEM:case W.lQt.SIMULATION_LOAD:case W.lQt.EDGE_POINT:case W.lQt.MESH_POINT:case W.lQt.TABLE_ITEM:l=!0}l?(n=n||h.getIdString()!==i.getIdString(),o.hasOwnProperty(h.id)?(s[o[h.id]]=h,n=!0):(o[h.id]=s.length,s.push(h))):(n=!0,r=r&&i.isInContextSubFeature())})),n&&i.reset(s,{suppressServerCalls:r,isForRemapping:!0}),n}clearHighlights(){for(const[e,t]of this.selectionListNameToListAndHighlightType.entries())this.clearSelectionHighlight(e,t.highlightType)}refreshHighlight(){const e=this,t=function(t,i,s){i.each((function(n){n.isMeshPoint()&&n.getMeshPointData()?e.meshPointController.addSelection(n,i):e.processSelectionHighlight(yn.aU.ADD,n,t,s)}))};for(const[e,i]of this.selectionListNameToListAndHighlightType.entries())t(e,i.selectionList,i.highlightType)}handlesHighlightForSelection(e,t){if(e.getUsage()!==this.usage)return!1;if(t===yn.o2.PRE&&e.source===ve.Hw.PICK&&Eh.getNumber("INHIBIT_PREHIGHLIGHT"))return!1;switch(e.getType()){case W.lQt.ENTITY:case W.lQt.FEATURE:case W.lQt.BODY:case W.lQt.OCCURRENCE:case W.lQt.MATE:case W.lQt.MATE_CONNECTOR:case W.lQt.EDGE_POINT:case W.lQt.TABLE_ITEM:case W.lQt.SKETCH_GROUP:case W.lQt.NON_GEOMETRIC_ITEM:case W.lQt.PROPERTY:case W.lQt.SIMULATION_LOAD:case W.lQt.FOLDER:return!0}return!1}getHighlightTypeForSelection(e,t){if(t===yn.o2.PRE&&(e.isOccurrence()||e.isFolder()))return yn.o2.OCCURRENCE_PRE;if(t===yn.o2.SECONDARY_PRE&&e.isOccurrence())return yn.o2.OCCURRENCE_SECONDARY_PRE;if(t===yn.o2.COMMENT&&e.isOccurrence())return yn.o2.OCCURRENCE_COMMENT;if(t)return t;switch(e.getType()){case W.lQt.ENTITY:return yn.o2.ENTITY;case W.lQt.FEATURE:case W.lQt.SKETCH_GROUP:return yn.o2.FEATURE;case W.lQt.BODY:return yn.o2.PART;case W.lQt.FOLDER:case W.lQt.OCCURRENCE:case W.lQt.NON_GEOMETRIC_ITEM:return yn.o2.OCCURRENCE;case W.lQt.TABLE_ITEM:if(e.getOccurrence())return yn.o2.OCCURRENCE}return yn.o2.UI}processSelectionHighlight(e,t,i,s,n,r){if(!t||!this.handlesHighlightForSelection(t,s))return;const a=this.getDisplayedElement();if(!a)return;const o=!s||s===yn.o2.PRE;s=this.getHighlightTypeForSelection(t,s);let h=!1;if(t.isFromBody()&&(t.isBody()||t.isFace())){let e;e=t.isBody()?t.getBodyMetaData():t.getEntityMetaData().getBodyMetaData(),e&&(!e.isModifiableBody()||js()&&t.isBody())&&(h=!0)}const c=this.viewer.getHighlightManager(this.usage),l=c.createHighlightForSelection(s,t.getIdForCollection(),h),u=this.getEntityIdsForSelection(t),d=a.getInContextImportEntityIdsForSelection(t),g=s===yn.o2.PRE?yn.o2.INCONTEXT_REFERENCE_PRE:yn.o2.INCONTEXT_REFERENCE,p=n?[]:a.getOccurrencesForSelection(t);let m=!t.isEntity()||t.isFromConstructionGeometry()||this.addDerivedEntityHighlights;s!==yn.o2.COMMENT||t.isPlane()||(m=!1);let f=[];if(r||!m&&e===yn.aU.ADD||(f=this.viewer.getEdgePointController()&&t.isEdgePoint()?this.viewer.getEdgePointController().getUIElementsForSelection(t):t.getOccurrence()&&this.getDisplayedInContextAssembly()?this.getDisplayedInContextAssembly().getUIElementsForSelection(t):a.getUIElementsForSelection(t)),this.processUiHighlights(e,f,t,i,l),t.isMateConnector()||t.isMate()||t.isMateRelation()||t.isExplodeStep()||t.isNonGeometricItem()||t.isSimulationLoad())this.processSecondaryAssemblyFeatureHighlights(e,p,t,i,s);else if(u&&u.length>0&&this.processEntitiesHighlight(e,t.getOccurrence(),u,l),d&&d.length>0&&o&&this.processEntitiesHighlight(e,t.getOccurrence(),d,c.createHighlightForSelection(this.getHighlightTypeForSelection(t,g),t.getIdForCollection())),p&&p.length>0&&m){const n=t.isBody()&&!!t.getOccurrence();let r=l;(t.isEntity()||n||t.isFeature())&&(e===yn.aU.ADD&&(this.selectionsToClearOnReset[i][t.getIdForCollection()]=t),r=s===yn.o2.FEATURE?c.createSecondaryHighlight(yn.o2.OCCURRENCE,yn.o2.OCCURRENCE,t.getIdForCollection()):c.createSecondaryHighlight(s===yn.o2.PRE?yn.o2.ASSOCIATED_OCCURRENCE_PRE:yn.o2.ASSOCIATED_OCCURRENCE,s,t.getIdForCollection()));for(let t=0;t<p.length;++t)this.processOccurrenceHighlight(e,p[t],r);r.associatedPrimaryHighlightType&&e===yn.aU.REMOVE&&c.freeSecondaryHighlight(r.type,r.associatedPrimaryHighlightType,t.getIdForCollection())}e===yn.aU.REMOVE&&(c.freeHighlightForSelection(s,t.getIdForCollection()),o&&c.freeHighlightForSelection(g,t.getIdForCollection())),this.viewer.requestDraw()}processUiHighlights(e,t,i,s,n){if(!t||t.length<=0)return;let r=!0;for(let i=0;i<t.length;++i)e===yn.aU.ADD?t[i].addHighlight(n):r=r&&t[i].removeHighlight(n);e===yn.aU.ADD?this.selectionsToClearOnReset[s][i.getIdForCollection()]=i:r&&delete this.selectionsToClearOnReset[s][i.getIdForCollection()]}processSecondaryAssemblyFeatureHighlights(e,t,i,s,n){const r=this.getDisplayedElement();if(!r)return;const a=i.getIdForCollection()+Pn.ID_SEPARATOR+n,o=this.viewer.getHighlightManager(this.usage);let h,c;c=i.isMateConnector()||i.isMate()&&i.featureType!==mi._.MATE_GROUP?o.createSecondaryHighlight(yn.o2.RELATED_OCCURRENCE_MATE,n,i.getIdForCollection()):o.createSecondaryHighlight(yn.o2.RELATED_OCCURRENCE,n,i.getIdForCollection());const l=n===yn.o2.UI?yn.o2.UI_RELATED_ENTITY:n;if(e===yn.aU.ADD){const e=this.secondaryOccurrenceHighlights[a];if(e&&e.length>0){for(h=0;h<e.length;++h)this.processOccurrenceHighlight(yn.aU.REMOVE,e[h],c);delete this.secondaryOccurrenceHighlights[a]}this.secondaryOccurrenceHighlights[a]=t}else t=this.secondaryOccurrenceHighlights[a],delete this.secondaryOccurrenceHighlights[a];for(h=0;t&&h<t.length;++h)this.processOccurrenceHighlight(e,t[h],c);if(this.displayingAssembly()){let t;if(this.secondaryEntityHighlights.hasOwnProperty(a))for(t=this.secondaryEntityHighlights[a],delete this.secondaryEntityHighlights[a],h=0;t&&h<t.length;++h)if(!this.updateSecondaryEntityHighlightRepeatCount(t[h],s,n,!1)){const e=!t[h].isAssemblyOrigin(),i=!t[h].isAssemblyOrigin();this.processSelectionHighlight(yn.aU.REMOVE,t[h],s,l,e,i)}if(e===yn.aU.ADD)for(t=r.getEntitiesForNonInstanceSelection(i),this.secondaryEntityHighlights[a]=t,h=0;t&&h<t.length;++h){this.updateSecondaryEntityHighlightRepeatCount(t[h],s,n,!0)||It.log.warn("Adding highlight should always result in an existing entity highlight");const i=!t[h].isAssemblyOrigin(),r=!t[h].isAssemblyOrigin();this.processSelectionHighlight(e,t[h],s,l,i,r)}}e===yn.aU.ADD?this.selectionsToClearOnReset[s][i.getIdForCollection()]=i:o.freeSecondaryHighlight(yn.o2.RELATED_OCCURRENCE,n,i.getIdForCollection())}updateSecondaryEntityHighlightRepeatCount(e,t,i,s){const n=e.id+t+i.toString();let r=this.secondaryEntityHighlightSelectionRepeats[n];return r||(r=0),s?r++:r--,r>0?(this.secondaryEntityHighlightSelectionRepeats[n]=r,!0):(delete this.secondaryEntityHighlightSelectionRepeats[n],!1)}clearHighlight(e,t,i){const s=this.viewer.getReferenceHighlights().highlights[e];this.occurrenceDataManager.clearHighlight(s,this.usage),this.clearIndividualHighlights(s,t,i),this.viewer.getHighlightManager(this.usage).resetHighlightInstanceIds(e),e===yn.o2.PRE?(this.clearHighlight(yn.o2.OCCURRENCE_PRE,t,i),this.clearHighlight(yn.o2.ASSOCIATED_OCCURRENCE_PRE,t,i),this.clearHighlight(yn.o2.INCONTEXT_REFERENCE_PRE,t,!0)):e===yn.o2.SECONDARY_PRE?this.clearHighlight(yn.o2.OCCURRENCE_SECONDARY_PRE,t,i):e===yn.o2.COMMENT&&this.clearHighlight(yn.o2.OCCURRENCE_COMMENT,t,i),this.viewer.requestDraw()}clearSelectionHighlight(e,t){t?this.clearHighlight(t,e,!0):(this.clearHighlight(yn.o2.ENTITY,e,!1),this.clearHighlight(yn.o2.FEATURE,e,!1),this.clearHighlight(yn.o2.PART,e,!1),this.clearHighlight(yn.o2.OCCURRENCE,e,!1),this.clearHighlight(yn.o2.UI,e,!0),this.clearHighlight(yn.o2.INCONTEXT_REFERENCE,e,!0))}clearIndividualHighlights(e,t,i){const s=this.selectionsToClearOnReset[t];if(!s)return;const n=Object.keys(s);for(let i=0;i<n.length;++i)this.processSelectionHighlight(yn.aU.REMOVE,s[n[i]],t,e.type);i&&(this.selectionsToClearOnReset[t]={})}getOccurrencesStartingWithPath(e){const t=this.assemblies[this.displayedElementId];return t?t.getLeafOccurrencesContainedWithinOccurrence(e):[]}getOccurrenceBounds(e){const t=this.assemblies[this.displayedElementId];return t?(this.getSceneGraph().updateBounds(),t.getOccurrenceBounds(e)):null}setPlaneName(e,t,i){const s=this.getDisplayedPartStudio();s&&s.getElementId()===e&&(s.setPlaneName(t,i),Ys()||this.applyToPreview(this.setPlaneName,arguments))}setAddDerivedEntityHighlights(e){this.addDerivedEntityHighlights!==e&&(this.clearHighlights(),this.addDerivedEntityHighlights=e,this.refreshHighlight())}getAddDerivedEntityHighlights(){return this.addDerivedEntityHighlights}isActiveElementEditingInContext(){const e=this.partStudios[this.getDisplayedFullElementId()];return!!e&&e.isDisplayingIncontextAssembly()}isDisplayingIncontextAssembly(){const e=this.getDisplayedPartStudio();return!!e&&e.isDisplayingIncontextAssembly()}isolateAllPartStudioBodies(){const e=this.getDisplayedPartStudio();if(!e)return;const t=e.getPartStudioOccurrenceIds(),i=this.viewer.getIsolatedOccurrenceManager();this.isBase()?i.setIsolatedOccurrenceIds(t):i.addIdsToIsolate(t);const s=e.getAllMateConnectorGraphics(null).map((e=>e.getOccurrenceData().getOccurrenceId()));i.addIdsToIsolate(s),je(1),this.viewer.requestDraw()}clearIsolatedBodies(){this.viewer.getIsolatedOccurrenceManager().clearAllIsolateNoAnimation()}switchIsolateActiveElement(e){this.viewer.getIsolatedOccurrenceManager().switchActiveElement(e)}getModelStatistics(e,t=!1){const i={faces:0,triangles:0,edges:0,lines:0,vertices:0,silhouettes:0,settingCounts:{},uniqueParts:0,uniqueSurfaces:0,uniqueCurves:0,uniqueOpenComposites:0,uniqueClosedComposites:0,partOccurrences:0,surfaceOccurrences:0,curveOccurrences:0,openCompositeOccurrences:0,openCompositeConstituentOccurrences:0,closedCompositeOccurrences:0,closedCompositeConstituentOccurrences:0,bodiesPendingRetrieval:0,errors:[],veryFineParts:new Array,veryFineOccurrences:new Array};let s;for(s in this.partStudios){const n=this.partStudios[s].getStatistics(e,t);i.faces+=n.faces,i.triangles+=n.triangles,i.edges+=n.edges,i.lines+=n.lines,i.vertices+=n.vertices,i.silhouettes+=n.silhouettes,i.uniqueParts+=n.uniqueParts,i.uniqueSurfaces+=n.uniqueSurfaces,i.uniqueCurves+=n.uniqueCurves,i.uniqueOpenComposites+=n.uniqueOpenComposites,i.uniqueClosedComposites+=n.uniqueClosedComposites,i.partOccurrences+=n.partOccurrences,i.surfaceOccurrences+=n.surfaceOccurrences,i.curveOccurrences+=n.curveOccurrences,i.openCompositeOccurrences+=n.openCompositeOccurrences,i.openCompositeConstituentOccurrences+=n.openCompositeConstituentOccurrences,i.closedCompositeOccurrences+=n.closedCompositeOccurrences,i.closedCompositeConstituentOccurrences+=n.closedCompositeConstituentOccurrences,i.bodiesPendingRetrieval+=n.bodiesPendingRetrieval;for(const e in n.settingCounts){const t=i.settingCounts[e]||0;i.settingCounts[+e]=t+n.settingCounts[+e]}t&&(n.veryFineOccurrences.length&&(i.veryFineOccurrences=[...i.veryFineOccurrences,...n.veryFineOccurrences]),n.veryFineParts.size&&i.veryFineParts.push(n.veryFineParts)),n.errorMessage&&i.errors.push(n.errorMessage)}return i}removeSelectionHighlights(){const e=this;(0,ve.vi)().each((function(t){e.processSelectionHighlight(yn.aU.REMOVE,t,"selectionList")}))}reAddSelectionHighlights(){const e=this;(0,ve.vi)().each((function(t){e.processSelectionHighlight(yn.aU.ADD,t,"selectionList")}))}hideAssembly(e){const t=this.assemblies[e];t&&t.hide()}showAssembly(e,t){const i=this.assemblies[e];i&&i.show(t)}getInstantiatedTriangleCount(){let e=0;for(const t in this.partStudios)e+=this.partStudios[t].getInstantiatedTriangleCount();return e}showPartsWithSheetmetalModelIdOnly(e){const t=this.getDisplayedPartStudio();if(t&&(e||this.selectedSheetmetalModelId)&&(t.getBodyComponent(null).showPartsWithSheetmetalModelIdOnly(e),t.getSketchComponent().showPartsWithSheetmetalModelIdOnly(e),t.getImageComponent().showPartsWithSheetmetalModelIdOnly(e),t.getDimensionComponent().showDimensionsWithSheetmetalModelIdOnly(e,t)),this.selectedSheetmetalModelId!==e){this.selectedSheetmetalModelId=e;for(const[e,t]of this.selectionListNameToListAndHighlightType.entries())this.resetSelectionListHighlights(t.selectionList,e,t.highlightType);this.fitToSelectedSheetMetalModel(),this.viewer.getEventDispatcher().trigger(VM.Hq,e),this.viewer.requestDraw()}}fitToSelectedSheetMetalModel(){this.lastFitSheetMetalModelId===this.selectedSheetmetalModelId||this.viewer.isHidden()||!this.viewer.getPrimaryViewController()||(this.viewer.getPrimaryViewController().setStandardView(this.viewer.getDefaultStandardView()),this.viewer.setViewInitialized(!1),this.viewer.requestDraw(),this.lastFitSheetMetalModelId=this.selectedSheetmetalModelId)}hasSelectedSheetmetalModelId(){return!!this.selectedSheetmetalModelId}getSelectedSheetmetalModelId(){return this.selectedSheetmetalModelId}isBodyEntityMeasurable(e,t){const i=this.getDisplayedPartStudio();return!!i&&i.getBodyComponent(null).isEntityMeasurable(e,t)}needsDisplayData(e){let t=!1;for(const i in this.partStudios)e.elementId===this.partStudios[i].id&&(t=t||this.partStudios[i].getBodyComponent(null).needsDisplayData(e));return t}getOccurrenceSketchFeatureId(e){const t=this.getPartStudioDataFromOccurrence(e),i=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString());return t&&i!==DI.Qy?t.getSketchComponent().getFeatureIdForOccurrence(i):null}getDescriptionOfLastProcessedPartStudio(){return this.lastPartStudioProcessed+" : "+this.lastPartStudioMicroversionIdAndConfigurationIntervalProcessed}isOccurrenceIdForInContext(e){const t=this.getDisplayedPartStudio();if(t){const i=this.assemblies[t.getVisibleInContextAssemblyId()];if(i){const t=this.viewer.getOccurrenceIdManager().getNameForId(e);return!!i.getDisplayDataForOccurrencePath(t)}}return!1}hideEntityFromPick(e,t,i){const s=this.getPartStudioDataFromOccurrence(i);if(s){const i=this.viewer.getOccurrenceDataManager().getOccurrenceData(t);if(i){const t=s.getMeshManager().getIncrementDetails(e,s.getMeshOwnerId());t&&i.hideIncrementFromPick(t,this.usage)}}}hideBodyFromPick(e,t,i){const s=this.getPartStudioDataFromOccurrence(i);if(s){const i=this.viewer.getOccurrenceDataManager().getOccurrenceData(t);if(i){const t=s.getEntitiesForBody(e);for(let e=0;t&&e<t.length;++e){const n=s.getMeshManager().getIncrementDetails(t[e],s.getMeshOwnerId());n&&i.hideIncrementFromPick(n,this.usage)}}}}setDebugFaceTriangles(e){Object.values(this.partStudios).forEach((function(t){t.getBodyComponent().setDebugFaceTriangles(e)})),this.simulationManager&&this.simulationManager.setDebugMeshEdges(e)}clearSubFeaturesShownByParameters(){this.subFeaturesShownByParameters={}}getSubFeaturesShownByParameters(){return this.subFeaturesShownByParameters}collectComponentsForHeapDump(e){for(const t in this.partStudios)this.partStudios[t].collectComponentsForHeapDump(e);II()}setExplodeViewActive(e){const t=this.getDisplayedAssembly();t&&t.setExplodeViewActive(e)}onStartEditingAssemblyFeature(e){const t=this.getDisplayedAssembly();t&&t.setEditState(e,!0)}onStopEditingAssemblyFeature(e){const t=this.getDisplayedAssembly();t&&t.setEditState(e,!1)}refreshSmoothEdgesForAllPartStudios(e){for(const t in this.partStudios){const i=this.partStudios[t],s=i.getBodyComponent();if(s&&(s.refreshSmoothEdges(),!e)){this.viewer.getSmoothEdgesRenderStyle()===W.YUG.VISIBLE&&i.setIsMissingTangencyInformationMessageShown(!1);const e=this.getDisplayedPartStudio()===i;if(this.viewer.getSmoothEdgesRenderStyle()!==W.YUG.VISIBLE&&s.hasDisplayedEdgesWithOutdatedSmoothnessInfo()){if(!e)return this.viewer.showTangencyInformationMissingMessage(),i.setIsMissingTangencyInformationMessageShown(!0),!1;this.updateSmoothEdgesForDisplayedPartStudio()}}}return!0}updateSmoothEdgesForDisplayedPartStudio(){this.viewer.getIsForFlattenedDisplay()||(this.isBase()?It.log.debug("Triggered smooth edge update from base viewer"):It.log.debug("Triggered smooth edge update from preview"),this.viewer.getEventDispatcher().trigger(VM.Uj))}processSmoothEdgeUpdate(e){for(let t=0;t<e.tangencyReponses.length;++t){const i=e.tangencyReponses[t],s=this.getPartStudio(i.source);s?s.getBodyComponent().updateEdgeSmoothness(i.edgeDeterministicIDToIsSmoothMap):It.log.warn("Part studio not found when applying smooth edge response")}this.refreshSmoothEdgesForAllPartStudios(!0),this.viewer.requestDraw()}onAppearanceConstantsUpdated(){for(const e of Object.values(this.partStudios))e.onAppearanceConstantsUpdated()}onRenderingModeChanged(){for(const e of Object.values(this.partStudios))e.onRenderingModeChanged()}getDisplayedElementMicroversionIdAndConfiguration(){return this.displayedElementMicroversionIdAndConfiguration}}class Th{constructor(e,t){this.occurrenceDataManager=e,this.viewer=t,this.modelViewManagers={},this.lastPreviewedPartStudioId=null,(0,Ih.Yk)(t),this.viewer.getEventDispatcher().on(VM.so,(()=>{this.clearTheManagers()}))}getManager(){const e=Ls.L.BASE;let t=this.modelViewManagers[e];return t||(t=new Sh(e,this.occurrenceDataManager,this.viewer),this.modelViewManagers[e]=t),t}clearTheManagers(){Object.values(this.modelViewManagers).forEach((function(e){e&&e.onDeletion()})),this.modelViewManagers={}}getManagerForUsage(e){return e===Ls.L.BASE?this.getManager():e===Ls.L.PREVIEW?this.getPreviewManager():null}getPreviewManager(e){const t=this.getManager().bodyLoadTasks,i=e?e.buildFullElementId(!0):null;if(!i||this.modelViewManagers[Ls.L.PREVIEW]&&i.elementId===this.lastPreviewedPartStudioId){const e=this.modelViewManagers[Ls.L.PREVIEW];return e&&t&&t.completeTasks(),e}{t&&t.completeTasks(),this.resetPreviewManager();const e=this.getManager().cloneForPreview(i);return this.modelViewManagers[Ls.L.PREVIEW]=e,this.lastPreviewedPartStudioId=i.elementId,e}}previewManagerExists(){return null!==this.lastPreviewedPartStudioId&&!!this.modelViewManagers[Ls.L.PREVIEW]}resetPreviewManager(){var e;this.viewer.getUiResourceManager().destroyPreviewGraphics(),this.viewer.getSceneGraphs().getPreviewSceneGraph().removeEverything(),this.modelViewManagers[Ls.L.PREVIEW]&&this.modelViewManagers[Ls.L.PREVIEW].onDeletion(),this.modelViewManagers[Ls.L.PREVIEW]=null,this.lastPreviewedPartStudioId=null,this.getManager().onPreviewDestroyed(),this.viewer.getOccurrenceDataManager().onPreviewDestroyed(),null===(e=this.viewer.getCurvatureAnalysisManager())||void 0===e||e.onPreviewDestroyed()}onAppearanceConstantsUpdated(){for(const e of Object.values(this.modelViewManagers))null==e||e.onAppearanceConstantsUpdated()}onRenderingModeChanged(){for(const e of Object.values(this.modelViewManagers))null==e||e.onRenderingModeChanged()}}var Mh=i(92230);class Ch{constructor(){this.viewport=P.fromValues(0,0,4,4),this.tileViewport=null,this.viewportDiagonal=0,this.canvasHeight=0,this.canvasWidth=0,this.sceneBounds=null,this.PROJECT_VEC_4=P.create(),this.TEMP_VEC4_0=P.create(),this.TEMP_VEC4_1=P.create(),this.TEMP_VEC4_2=P.create(),this.TEMP_VEC3_0=v.create(),this.TEMP_VEC3_1=v.create(),this.updateViewportDiagonal(),this.viewMatrix=ge.create(),this.viewMatrixInverse=ge.create(),this.projectionMatrix=ge.create(),this.projectionMatrixInverse=ge.create(),this.viewFrustum=new pr(this.viewMatrix,this.projectionMatrix)}integrityCheck(e){this.checkProperty("viewport",e),this.checkProperty("viewportDiagonal",e),this.checkProperty("canvasHeight",e),this.checkProperty("canvasWidth",e),this.checkProperty("viewMatrix",e),this.checkProperty("viewMatrixInverse",e),this.checkProperty("projectionMatrix",e),this.checkProperty("projectionMatrixInverse",e),this.checkProperty("eye",e),this.checkProperty("up",e),this.checkProperty("direction",e),this.checkProperty("near",e),this.checkProperty("far",e)}checkProperty(e,t){const i=this[e];(0,Li.xV)(i)||It.log.warn(e+" was found to be non-finite in "+t+": "+i)}getViewFrustum(){return this.viewFrustum}toString(){return JSON.stringify(this,null,2)}isPerspective(){return!1}isOrthographic(){return!1}setViewportFromCanvasElement(e){const t=parseInt(e.attr("width")||""),i=parseInt(e.attr("height")||"");this.setViewport([0,0,t,i]),this.setCanvasDimensions(t,i)}setCanvasDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}updateViewportDiagonal(){this.viewportDiagonal=pe.gv.length([this.viewport[2],this.viewport[3]])}setViewport(e){this.viewport=e,this.updateViewportDiagonal(),this.updateMatrices()}getViewport(e){return this.tileViewport&&!e?P.fromValues(0,0,this.tileViewport[2],this.tileViewport[3]):this.viewport}getTileViewport(){return this.tileViewport}getViewportDiagonal(){return this.viewportDiagonal}getEye(){return this.eye}getFrame(){const e=ge.create(),t=this.getRight();for(let i=0;i<3;i++)e[i]=t[i],e[i+4]=this.up[i],e[i+8]=-this.direction[i],e[i+12]=this.eye[i],e[4*i+3]=0;return e}setFrame(e){if(!e||16!==e.length)return void It.log.error("An attempt was made to update the camera with an invalid frame");const t=v.fromValues(e[12],e[13],e[14]),i=v.fromValues(-e[8],-e[9],-e[10]),s=v.fromValues(e[4],e[5],e[6]);this.setViewPositionAndOrientation(t,i,s)}setViewPositionAndOrientation(e,t,i){this.eye=e,this.direction=t,this.up=i,this.updateMatrices(),this.integrityCheck("setViewPositionAndOrientation")}getDirection(){return this.direction}getFieldOfView(){return 0}setFieldOfView(e){}focalPoint(){return this.sceneBounds?this.sceneBounds.center():v.create()}distanceToCenter(){const e=this.focalPoint();return Math.abs(v.dot(this.direction,pe.S4.subtract(e,this.eye,v.create())))}setSceneBounds(e){e.isInitialized()&&!e.isInfinite()&&(this.sceneBounds=e,this.ensureCameraIsOutsideSceneBounds(),this.updateNearFar())}getSceneBounds(){return this.sceneBounds}getViewMatrix(){return ge.clone(this.viewMatrix)}getViewMatrixInverse(){return ge.clone(this.viewMatrixInverse)}setTileViewport(e){this.tileViewport=e}getProjectionMatrix(){return this.tileViewport?pe.w$.multiply((0,Li.vG)(this.tileViewport,this.viewport),this.projectionMatrix,ge.create()):ge.clone(this.projectionMatrix)}getMatrices(e,t){for(let i=0;i<16;++i)e[i]=this.viewMatrix[i],t[i]=this.projectionMatrix[i]}getProjectionMatrixInverse(){return ge.clone(this.projectionMatrixInverse)}updateMatrixInverses(){let e=pe.w$.inverse(this.viewMatrix,this.viewMatrixInverse);e=pe.w$.inverse(this.projectionMatrix,this.projectionMatrixInverse)&&e,e||It.log.warn("Error updating camera matrix inverses")}updateNearFar(e){if(!e&&this.sceneBounds&&(e=this.sceneBounds.getCorners()),!e||!e.length)return;let t,i=-1/0,s=1/0;const n=v.create();for(t=0;t<e.length;t++){const r=v.dot(pe.S4.subtract(e[t],this.eye,n),this.direction);i=Math.max(i,r),s=Math.min(s,r)}if(i>=s){let e=1;this.sceneBounds&&(e=this.sceneBounds.diameter());const t=.01,n=.1;this.near=Math.max(e*t,s-n*e),this.far=Math.max(e,i+n*e)}else It.log.warn("Trying to initialize the camera with a bounds that has no extension in the view direction"),this.near=.001,this.far=2;this.updateMatrices()}setNearFar(e,t){e>=t&&It.log.debug("Near set to a distance greater or equal to far"),this.near=e,this.far=t,this.updateMatrices()}zoom(e){}getNearDepth(){return this.near}getFarDepth(){return this.far}rotateAbout(e,t,i){i||(i=this.eye);const s=ge.create();pe.w$.rotate(s,e,t),pe.w$.multiplyVec3(s,this.direction),pe.w$.multiplyVec3(s,this.up);const n=pe.S4.subtract(this.eye,i,v.create());pe.w$.multiplyVec3(s,n),pe.S4.add(i,n,this.eye),this.updateMatrices(),this.integrityCheck("rotateAbout")}pan(e){pe.S4.subtract(this.eye,e),this.updateMatrices(),this.integrityCheck("pan")}ensureCameraIsOutsideSceneBounds(){}getRight(){return pe.S4.normalize(pe.S4.cross(this.direction,this.up,v.create()))}getUp(){return this.up}getForward(){return this.direction}projectWorldPointToViewport(e){return e=P.fromValues(e[0],e[1],e[2],1),this.projectViewPoint(pe.w$.multiplyVec4(this.viewMatrix,e,P.create()))}projectWorldPointToCanvas(e){return this.viewportToCanvas(this.projectWorldPointToViewport(e))}viewportToCanvas(e){const t=v.create();t[0]=e[0]+this.getViewportLeft();const i=this.canvasHeight-(this.getViewportBottom()+this.getViewportHeight());return t[1]=i+(this.getViewportHeight()-e[1]),t[2]=e[2],t}viewNormalPlaneAtPoint(e){const t=this.getForward(),i=v.dot(t,e);return P.fromValues(t[0],t[1],t[2],-i)}projectViewPoint(e,t){t=t||v.create();const i=this.tileViewport?this.getProjectionMatrix():this.projectionMatrix,s=pe.w$.multiplyVec4(i,e,this.PROJECT_VEC_4);s[3]=1/s[3],s[0]*=s[3],s[1]*=s[3],s[2]*=s[3];const n=this.tileViewport?this.tileViewport:this.viewport,r=n[2],a=n[3];return t[0]=0+r*(s[0]+1)/2,t[1]=0+a*(s[1]+1)/2,t[2]=(s[2]+1)/2,t}viewPointToWorld(e){return e=P.fromValues(e[0],e[1],e[2],1),pe.w$.multiplyVec4(this.viewMatrixInverse,e,P.create())}getUnitSizeAtWorldPoint(e){const t=this.TEMP_VEC4_0;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1;const i=this.projectViewPoint(pe.w$.multiplyVec4(this.viewMatrix,t,this.TEMP_VEC4_1),this.TEMP_VEC3_0);t[0]+=this.up[0],t[1]+=this.up[1],t[2]+=this.up[2];const s=this.projectViewPoint(pe.w$.multiplyVec4(this.viewMatrix,t,this.TEMP_VEC4_2),this.TEMP_VEC3_1);return Math.abs(s[1]-i[1])}projectWorldDirectionToCanvas(e,t){const i=this.projectWorldPointToCanvas(e),s=pe.S4.add(e,t,this.TEMP_VEC3_0),n=this.projectWorldPointToCanvas(s);return pe.gv.subtract(n,i,$.create())}getPixelSizeAtWorldPoint(e){return 1/this.getUnitSizeAtWorldPoint(e)}isCanvasPointInView(e){return e[0]>=0&&e[0]<this.getViewportWidth()&&e[1]>=0&&e[1]<this.getViewportHeight()}getRay(e,t){t=this.canvasHeight-t;const i=pe.S4.unproject([e+.5,t+.5,0],this.viewMatrix,this.projectionMatrix,this.viewport),s=pe.S4.unproject([e+.5,t+.5,1],this.viewMatrix,this.projectionMatrix,this.viewport);return new Li.zH(i,pe.S4.subtract(s,i,v.create()))}canvasToWorld(e){const t=v.fromValues(e[0],this.canvasHeight-e[1],e[2]);return pe.S4.unproject(t,this.viewMatrix,this.projectionMatrix,this.viewport,v.create())}getCanvasWidth(){return this.canvasWidth}getCanvasHeight(){return this.canvasHeight}getViewportWidth(){return this.viewport[2]}getViewportHeight(){return this.viewport[3]}getViewportLeft(){return this.viewport[0]}getViewportBottom(){return this.viewport[1]}getClosestNormalView(e,t){if(!e)return null;const i=v.fromValues(e[0],e[1],e[2]),s=v.fromValues(e[4],e[5],e[6]),n=this.getFrame(),r=v.fromValues(n[0],n[1],n[2]),a=v.fromValues(n[4],n[5],n[6]),o=v.fromValues(n[12],n[13],n[14]);let h,c;const l=v.dot(r,i),u=v.dot(r,s);if(Math.abs(l)>Math.abs(u)-bi.W.ZERO_LENGTH){h=pe.S4.scale(i,l<0?-1:1,v.create());const e=v.dot(a,s);c=pe.S4.scale(s,e<0?-1:1,v.create())}else{h=pe.S4.scale(s,u<0?-1:1,v.create());const e=v.dot(a,i);c=pe.S4.scale(i,e<0?-1:1,v.create())}const d=pe.S4.cross(h,c,v.create()),g=o,p=ge.create();for(let e=0;e<3;++e)p[0+e]=h[e],p[4+e]=c[e],p[8+e]=d[e],p[12+e]=g[e];if(t&&t.flipNormalIfIdentical&&(0,Li.cl)(n,p))for(let e=0;e<3;++e)p[0+e]=-h[e],p[8+e]=-d[e],p[12+e]=-g[e];return p}getCameraRotatedToView(e,t){const i=this.clone();i.setFrame(this.getClosestNormalView(e,{flipNormalIfIdentical:!0}));const s=this.projectWorldPointToCanvas(t),n=i.canvasToWorld(s);return i.pan(pe.S4.subtract(n,t)),i}getCameraRotatedToViewAndTranslated(e,t,i){const s=this.clone();s.setFrame(this.getClosestNormalView(e,{flipNormalIfIdentical:!0}));const n=this.projectWorldPointToCanvas(t),r=[i[0],i[1],n[2]],a=s.canvasToWorld(r);return s.pan(pe.S4.subtract(a,t)),s}canBoundsFitInViewport(e,t){if(!e||!e.isFinite())return!1;const i=new Li.tO,s=e.getCorners();for(let e=0;e<s.length;++e)i.addPoint(this.projectWorldPointToViewport(s[e]));const n=i.getDimensions();return n[0]<t[2]&&n[1]<t[3]}doBoundsFitInViewport(e,t,i){if(!e||!e.isFinite()||0===i)return!1;t=t||this.viewport;const s=i||1,n=new Li.tO,r=e.getCorners();for(let e=0;e<r.length;++e)n.addPoint(this.projectWorldPointToViewport(r[e]));const a=[t[2]*(s-1)/2,t[3]*(s-1)/2];return n.min[0]>-a[0]&&n.min[1]>-a[1]&&n.max[0]<t[2]+a[0]&&n.max[1]<t[3]+a[1]}canvasToModelPoint(e){const t=this.projectWorldPointToCanvas(v.fromValues(0,0,0));return this.canvasToWorld(v.fromValues(e[0],e[1],t[2]))}getUnitSizeAtWorldPointFast(e){return this.getUnitSizeAtWorldPoint(e)}}const Dh=45;class vh extends Ch{constructor(e){super(),this.MIN_SCALE=.05,this.MAX_SCALE=50,this.angle=Dh,this.eye=v.fromValues(0,0,0),this.near=1,this.far=2,this.direction=v.fromValues(0,0,1),this.up=v.fromValues(0,1,0),Object.assign(this,vh.defaults(),e||{}),this.updateMatrices()}static defaults(){return{eye:[0,0,0],direction:[0,0,1],up:[0,1,0],angle:45,near:1,far:2}}integrityCheck(e){super.integrityCheck(e),this.checkProperty("angle",e)}equals(e){return e instanceof vh&&(this.angle===e.angle&&(0,Li.cl)(this.eye,e.eye)&&(0,Li.cl)(this.direction,e.direction)&&(0,Li.cl)(this.up,e.up))}isPerspective(){return!0}getFieldOfView(){return this.angle}setFieldOfView(e){this.angle=e,this.updateMatrices()}updateMatrices(){const e=pe.S4.add(this.direction,this.eye,v.create());pe.w$.lookAt(this.eye,e,this.up,this.viewMatrix),pe.w$.perspective(this.angle,this.viewport[2]/this.viewport[3],this.near,this.far,this.projectionMatrix),this.updateMatrixInverses(),this.viewFrustum.updateClippingPlanes(this.viewMatrix,this.projectionMatrix)}getDirectionToWorldPoint(e){return pe.S4.normalize(pe.S4.subtract(e,this.eye,v.create()))}getFrustum(){const e=Math.tan((0,Li.Yr)(.5*this.angle))*this.near,t=e*this.canvasWidth/this.canvasHeight;return[-t,t,-e,e,this.near,this.far]}copyTo(e){let t;for(t=0;t<3;++t)e.eye[t]=this.eye[t],e.direction[t]=this.direction[t],e.up[t]=this.up[t];for(e.angle=this.angle,e.near=this.near,e.far=this.far,e.sceneBounds=this.sceneBounds,e.setViewport(this.viewport),e.canvasWidth=this.canvasWidth,e.canvasHeight=this.canvasHeight,t=0;t<16;++t)e.viewMatrix[t]=this.viewMatrix[t],e.viewMatrixInverse[t]=this.viewMatrixInverse[t],e.projectionMatrix[t]=this.projectionMatrix[t]}copyFrom(e){e.isPerspective()?e.copyTo(this):e.getPerspectiveCamera().copyTo(this)}clone(){const e=new vh;return this.copyTo(e),e}getPerspectiveCamera(){return this.clone()}getOrthographicCamera(){var e;const t=new Ph;let i;for(i=0;i<3;++i)t.eye[i]=this.eye[i],t.direction[i]=this.direction[i],t.up[i]=this.up[i];t.setViewport(this.viewport),t.sceneBounds=this.sceneBounds,t.canvasWidth=this.canvasWidth,t.canvasHeight=this.canvasHeight,t.updateNearFar(),t.correctAspectRatio(),t.updateMatrices();const s=null===(e=this.getSceneBounds())||void 0===e?void 0:e.center(),n=this.getUnitSizeAtWorldPoint(s),r=t.getUnitSizeAtWorldPoint(s);return t.zoom(r/n),t}getFrame(){const e=ge.create(),t=pe.S4.cross(this.direction,this.up,v.create()),i=this.up,s=this.direction;let n;for(n=0;n<3;n++)e[n]=t[n],e[n+4]=i[n],e[n+8]=-s[n],e[n+12]=this.eye[n],e[4*n+3]=0;return e}getMinDistance(){return this.sceneBounds?this.sceneBounds.diameter()*this.MIN_SCALE:this.MIN_SCALE}getMaxDistance(){return this.sceneBounds?this.sceneBounds.diameter()*this.MAX_SCALE:this.MAX_SCALE}dollyAlong(e,t){if(!this.sceneBounds)return;const i=this.getMinDistance(),s=this.getMaxDistance(),n=this.distanceToCenter(),r=v.dot(this.direction,t);let a=r*e;n<i?a=Math.min(a,0):n-a<i?a=Math.max(i-n,0):n-a>s&&(a=Math.min(n-s,0)),pe.S4.add(this.eye,pe.S4.scale(t,a/r,v.create())),this.updateMatrices(),this.integrityCheck("dollyAlong")}dolly(e){this.dollyAlong(e,this.direction)}zoom(e){const t=this.distanceToCenter();this.dolly(t-t*e)}getZoomToFitEyeAndPlanes(e,t,i){const s=pe.S4.cross(this.direction,this.up,v.create()),n=Mh.fromValues(s[0],s[1],s[2],this.up[0],this.up[1],this.up[2],-this.direction[0],-this.direction[1],-this.direction[2]),r=pe.xB.transpose(n,Mh.create()),a=[0,0,0];let o,h=0;if(e((function(e){pe.S4.add(a,e),h++})),h<=0)return null;pe.S4.scale(a,1/h);const c=[1/0,1/0,1/0],l=[-1/0,-1/0,-1/0],u=v.create(),d=v.create();e((function(e){for(pe.S4.subtract(e,a,u),pe.xB.multiplyVec3(r,u,d),o=0;o<3;o++)c[o]=Math.min(c[o],d[o]),l[o]=Math.max(l[o],d[o])}));const g=pe.S4.scale(pe.S4.add(l,c,v.create()),.5);pe.S4.subtract(l,g);const p=2*l[0]/(2*l[1]),m=t[2]/t[3];if(m<p&&(l[1]*=p/m),i)for(o=0;o<3;o++)l[o]*=i;const f=l[1]/Math.tan((0,Li.Yr)(.5*this.angle)),I=pe.xB.multiplyVec3(n,g,v.create()),E=pe.S4.add(a,I,v.create());return pe.S4.add(E,pe.S4.scale(this.direction,-(f+l[2]),v.create())),{eye:E,near:f,far:f+2*l[2]}}zoomToFit(e,t,i){let s;if(e instanceof Array)s=function(t){for(let i=0;i<e.length;i++)t(e[i])};else{if(!(e instanceof Function))return;s=e}const n=this.getZoomToFitEyeAndPlanes(s,this.viewport,t);if(n){if(this.eye=n.eye,this.near=n.near,this.far=n.far,i){const e=Math.tan((0,Li.Yr)(.5*this.angle))*this.near*2/i[3],t=(.5*this.viewport[2]-(i[0]+.5*i[2]))*e,s=(.5*this.viewport[3]-(i[1]+.5*i[3]))*e,n=pe.S4.cross(this.direction,this.up,v.create());pe.S4.add(this.eye,pe.S4.scale(n,t,v.create())),pe.S4.add(this.eye,pe.S4.scale(this.up,s,v.create()));const r=this.near*(this.viewport[2]/i[2]-1),a=this.near*(this.viewport[3]/i[3]-1),o=Math.max(r,a);pe.S4.subtract(this.eye,pe.S4.scale(this.direction,o,v.create())),this.near+=o,this.far+=o}this.updateMatrices(),this.integrityCheck("zoomToFit")}}}class Ph extends Ch{constructor(e){super(),this.DEFAULT_EXTENT_RATIO=.1,this.cachedWorldToPixelSize=-1,this.left=-1,this.right=1,this.top=1,this.bottom=-1,this.near=-1,this.far=1,this.eye=v.create(),this.direction=v.fromValues(0,0,-1),this.up=v.fromValues(0,1,0),Object.assign(this,Ph.defaults(),e||{}),this.updateMatrices()}static defaults(){return{eye:[0,0,0],direction:[0,0,-1],up:[0,1,0],left:-1,right:1,top:1,bottom:-1,near:-1,far:1}}integrityCheck(e){super.integrityCheck(e),this.checkProperty("left",e),this.checkProperty("right",e),this.checkProperty("top",e),this.checkProperty("bottom",e)}equals(e){return e instanceof Ph&&(Math.abs(this.left-e.left)<bi.W.ZERO_LENGTH&&Math.abs(this.right-e.right)<bi.W.ZERO_LENGTH&&Math.abs(this.top-e.top)<bi.W.ZERO_LENGTH&&Math.abs(this.bottom-e.bottom)<bi.W.ZERO_LENGTH&&(0,Li.cl)(this.eye,e.eye)&&(0,Li.cl)(this.direction,e.direction)&&(0,Li.cl)(this.up,e.up))}isOrthographic(){return!0}getUnitSizeAtWorldPointFast(e){return this.cachedWorldToPixelSize<0&&(this.cachedWorldToPixelSize=super.getUnitSizeAtWorldPoint(e)),this.cachedWorldToPixelSize}updateMatrices(){const e=pe.S4.add(this.direction,this.eye,v.create());pe.w$.lookAt(this.eye,e,this.up,this.viewMatrix),pe.w$.ortho(this.left,this.right,this.bottom,this.top,this.near,this.far,this.projectionMatrix),this.updateMatrixInverses(),this.viewFrustum.updateClippingPlanes(this.viewMatrix,this.projectionMatrix),this.cachedWorldToPixelSize=-1}copyTo(e){let t;for(t=0;t<3;++t)e.eye[t]=this.eye[t],e.direction[t]=this.direction[t],e.up[t]=this.up[t];for(e.left=this.left,e.right=this.right,e.top=this.top,e.bottom=this.bottom,e.near=this.near,e.far=this.far,e.sceneBounds=this.sceneBounds,e.setViewport(this.viewport),e.canvasWidth=this.canvasWidth,e.canvasHeight=this.canvasHeight,t=0;t<16;++t)e.viewMatrix[t]=this.viewMatrix[t],e.viewMatrixInverse[t]=this.viewMatrixInverse[t],e.projectionMatrix[t]=this.projectionMatrix[t]}copyFrom(e){e.isOrthographic()?e.copyTo(this):e.getOrthographicCamera().copyTo(this)}clone(){const e=new Ph;return this.copyTo(e),e}getOrthographicCamera(){return this.clone()}getPerspectiveCamera(){var e;const t=new vh;let i;for(i=0;i<3;++i)t.eye[i]=this.eye[i],t.direction[i]=this.direction[i],t.up[i]=this.up[i];t.setViewport(this.viewport),t.sceneBounds=this.sceneBounds,t.canvasWidth=this.canvasWidth,t.canvasHeight=this.canvasHeight,t.updateNearFar();const s=null===(e=this.getSceneBounds())||void 0===e?void 0:e.center(),n=this.getUnitSizeAtWorldPoint(s),r=t.getUnitSizeAtWorldPoint(s),a=t.distanceToCenter(),o=r/n*a;return t.dolly(a-o),t.updateNearFar(),t}getDirectionToWorldPoint(e){return this.direction}setViewport(e){this.viewport=e.slice(0),this.updateViewportDiagonal(),this.correctAspectRatio(),this.updateMatrices()}correctAspectRatio(){const e=this.right-this.left,t=this.top-this.bottom,i=this.getViewportWidth(),s=this.getViewportHeight();if(0===i||0===s)return;let n,r;i<s?(n=e<t?1:t/e,r=n*e*s/(t*i)):(r=e<t?e/t:1,n=r*t*i/(e*s)),this.left*=n,this.right*=n,this.top*=r,this.bottom*=r}zoom(e){const t=this.right-this.left,i=this.top-this.bottom;this.left=-t*e*.5,this.right=t*e*.5,this.top=i*e*.5,this.bottom=-i*e*.5,this.updateMatrices()}getExtents(){return[this.left,this.bottom,-this.far,this.right,this.top,-this.near]}setExtents(e){this.left=e[0],this.right=e[3],this.bottom=e[1],this.top=e[4],this.updateMatrices()}setExtentsByComponent(e,t,i,s){this.left=e,this.right=t,this.bottom=i,this.top=s,this.updateMatrices()}zoomPoint(e,t,i,s){const n=pe.S4.subtract(e,this.eye,v.create()),r=this.getRight(),a=v.dot(n,r),o=v.dot(n,this.up);pe.S4.add(this.eye,pe.S4.scale(r,-a*(i-1),v.create()),this.eye),pe.S4.add(this.eye,pe.S4.scale(this.up,-o*(i-1),v.create()),this.eye);const h=this.right-this.left,c=this.top-this.bottom;this.left=-h*i*.5,this.right=h*i*.5,this.top=c*i*.5,this.bottom=-c*i*.5,this.updateMatrices(),this.integrityCheck("zoomPoint")}ensureCameraIsOutsideSceneBounds(){if(!this.sceneBounds)return;const e=v.dot(this.direction,this.sceneBounds.center())-v.dot(this.direction,this.eye);pe.S4.add(this.eye,pe.S4.scale(this.direction,-(.6*this.sceneBounds.diameter()-e),v.create()),this.eye),this.integrityCheck("ensureCameraIsOutsideSceneBounds")}zoomToFit(e,t,i){let s;if(e instanceof Array)s=function(t){for(let i=0;i<e.length;i++)t(e[i])};else{if(!(e instanceof Function))return;s=e}t=t||1;const n=this.getRight(),r=this.getUp(),a=[1/0,1/0],o=[-1/0,-1/0],h=[0,0];if(s((function(e){h[0]=v.dot(n,e),h[1]=v.dot(r,e);for(let e=0;e<2;++e)h[e]<a[e]&&(a[e]=h[e]),h[e]>o[e]&&(o[e]=h[e])})),o[0]<a[0]||o[1]<a[1])return;let c=o[0]-a[0],l=o[1]-a[1];if(0===c&&0===l)return;0===c?c=l*this.DEFAULT_EXTENT_RATIO:0===l&&(l=c*this.DEFAULT_EXTENT_RATIO),this.eye=pe.S4.add(pe.S4.scale(n,.5*(a[0]+o[0]),v.create()),pe.S4.scale(r,.5*(a[1]+o[1]),v.create())),this.ensureCameraIsOutsideSceneBounds(),this.right=.5*c*t,this.top=.5*l*t;let u=this.viewport[2]/this.viewport[3];i&&(u=i[2]/i[3]);const d=this.right/this.top/u;if(d>1?this.top*=d:this.right/=d,i){const e=2*this.right/i[2],t=(.5*this.viewport[2]-(i[0]+.5*i[2]))*e,s=(.5*this.viewport[3]-(i[1]+.5*i[3]))*e;pe.S4.add(this.eye,pe.S4.scale(n,t,v.create())),pe.S4.add(this.eye,pe.S4.scale(r,s,v.create())),this.right*=this.viewport[2]/i[2],this.top*=this.viewport[3]/i[3]}this.left=-this.right,this.bottom=-this.top,this.updateMatrices(),this.integrityCheck("zoomToFit")}}function yh(e){const t=Math.min(e[2],e[3]);return[-.5*t,.5*t]}class Ah extends vh{constructor(){super(),this.viewMatrix=ge.create()}setTransforms(e,t,i){ge.multiply(this.viewMatrix,t,e),this.projectionMatrix=i,this.updateMatrixInverses(),v.set(this.TEMP_VEC3_0,0,0,0),pe.w$.multiplyVec3(this.viewMatrixInverse,this.TEMP_VEC3_0,this.eye),P.set(this.TEMP_VEC4_0,0,0,-1,0),pe.w$.multiplyVec4(this.viewMatrixInverse,this.TEMP_VEC4_0,this.TEMP_VEC4_1),v.copy(this.direction,this.TEMP_VEC4_1),P.set(this.TEMP_VEC4_0,0,1,0,0),pe.w$.multiplyVec4(this.viewMatrixInverse,this.TEMP_VEC4_0,this.TEMP_VEC4_1),v.copy(this.up,this.TEMP_VEC4_1)}updateMatrices(){}}class Oh{constructor(e){this.viewer=e,this.occurrenceData={},(0,Ih.Yk)(e),this.getOrCreateOccurrenceData(DI.KF)}destroy(){Object.values(this.occurrenceData).forEach((function(e){e.destroy()})),this.occurrenceData={},dS()}onPreviewDestroyed(){Object.values(this.occurrenceData).forEach((function(e){e.onPreviewDestroyed()}))}forEach(e){for(const t in this.occurrenceData)e(t,this.occurrenceData[t])}getOrCreateOccurrenceData(e){let t=this.occurrenceData[e];return t||(this.occurrenceData[e]=t=new Qr(+e,this.viewer.getIsExcludingItemsForSection())),t}getOccurrenceData(e){const t=this.occurrenceData[e];return t||null}destroyOccurrenceData(e){const t=this.occurrenceData[e];t&&(t.destroy(),delete this.occurrenceData[e])}setOccurrenceTransform(e,t){const i=this.getOrCreateOccurrenceData(e);return i.setTransform(t),this.viewer.requestDraw(),i}getOccurrenceTransform(e){const t=this.getOrCreateOccurrenceData(e);if(t)return t.getTransform();return ge.create()}processHighlightForOccurrences(e,t,i,s){const n=this.viewer.getOccurrenceIdManager();for(let r=0;r<t.length;++r){const a=n.getIdForName(t[r].getPathAsString());a!==DI.Qy&&this.getOrCreateOccurrenceData(a).updateOccurrenceHighlight(e,i,s)}this.viewer.requestDraw()}clearHighlight(e,t){for(const i in this.occurrenceData){this.occurrenceData[i].clearHighlight(e,t)}this.viewer.requestDraw()}clearIsolation(){this.setAllIsolated(!1)}isolateAll(){this.setAllIsolated(!0)}setAllIsolated(e){for(const t in this.occurrenceData){this.occurrenceData[t].setIsolated(e)}this.viewer.requestDraw()}setOccurrenceIsolated(e,t){this.getOrCreateOccurrenceData(e).setIsolated(t),this.viewer.requestDraw()}resetHiddenFromPick(){for(const e in this.occurrenceData)this.occurrenceData[e].resetHiddenFromPick()}makeSceneDebugObject(){const e=[];return Object.values(this.occurrenceData).forEach((function(t){e.push(t.makeSceneDebugObject())})),{text:"Occurrence data",children:e}}}var Rh,wh=i(61794),_h=i(34132);!function(e){e[e.BACK=0]="BACK",e[e.FRONT=1]="FRONT",e[e.NONE=-1]="NONE",e[e.UNSPECIFIED=-2]="UNSPECIFIED"}(Rh||(Rh={}));var Nh=i(83290);const bh="SIMULATION_BONDED";let Lh=!1;const Fh=255;class xh{constructor(e,t,i){this.AnalyticsService=e,this.modelViewManager=t,this.simulationManager=i,this.meshOwnerId=WS(),this.elementIdToResponseData=new Map,this.contactTractionThreshold=.1,this.visualizedOccurrencePaths=[],this.connectionTypes=[],this.useIsolateEffect=!0,this.occurrencesMarkedAsSimulated=[],this.contactBehavior=W.Ixp.FUSE_IN_CONTACT_AND_USE_MATES,this.prepareScenegraph()}setVisible(e){this.isVisible!==e&&(this.isVisible=e,!this.isVisible&&this.useIsolateEffect?(this.useIsolateEffect&&this.viewer.getIsolatedOccurrenceManager().clearAllIsolateNoAnimation(),this.clearGraphics()):this.updateGraphics())}setContactBehavior(e){this.contactBehavior!==e&&(this.contactBehavior=e,this.updateGraphics())}getVisible(){return this.isVisible}getUseIsolateEffect(){return this.useIsolateEffect}updateContactAnalysis(e){const t=new mh.B7("ConnectionVisualizationManager.updateContactAnalysis",{setTraceId:!0});let i=!1;if(e.runStatus===W.zgQ.JUST_STARTED||e.runStatus===W.zgQ.INVALID_ASSEMBLY)return this.clearGraphics(),void(e.runStatus===W.zgQ.JUST_STARTED&&this.elementIdToResponseData.delete(e.sourceElementId));if(e.hasResponse)this.elementIdToResponseData.set(e.sourceElementId,e.response),i=!0;else{const t=this.modelViewManager.getDisplayedAssembly();t&&e.runStatus===W.zgQ.TRANSMITTED&&this.elementIdToResponseData.has(t.elementId)&&(i=!0)}i&&this.updateGraphics(),t.report()}onAssemblyChanged(){this.updateIfVisible()}onSectionSetChanged(){this.updateIfVisible()}updateIfVisible(){this.isVisible&&this.updateGraphics()}updateGraphics(){const e=new mh.B7("ConnectionVisualizationManager.updateGraphics",{setTraceId:!0});if(this.clearGraphics(),!this.isVisible)return;const t=this.modelViewManager.getDisplayedAssembly();if(!t||t.isHidden)return;if(this.viewer.getRenderingMode()!==W.P1.SIMULATION_RESULTS)return;const i=this.elementIdToResponseData.get(t.elementId);if(!i||!i.resultData)return void It.log.debug("No data set to display");this.useIsolateEffect=!!q.default.getManager().getNumber("USE_ISOLATE_EFFECT_FOR_CONNECTION_VISUALIZATION");const s=this.viewer.getOccurrenceIdManager(),n=this.viewer.getOccurrenceDataManager(),r=i.resultData,a=new Set;this.updateConnectionTexture(i,t,a);let o=!1;const h=[];for(const e in r.occurrenceIdToOccurrenceResult){const c=r.occurrenceIdToOccurrenceResult[e],l=W._oC.getOccurrenceFromPathString(e),u=s.getIdForName(e);if(u===DI.Qy){It.log.warn("No occurrence id for "+e);continue}const d=n.getOccurrenceData(u);d||It.log.warn("No occurrence data for "+e);const g=t.getOccurrenceDisplayData(l);if(!g){It.log.warn("No occurrence display data for "+e);continue}const p=this.modelViewManager.getPartStudioDataFromOccurrence(l);if(!p){It.log.debug("No part studio for occurrence "+e);continue}if(!this.simulationManager.getTessellationForOccurrenceResult(c)){It.log.debug("No simulation tessellation for "+e),o=!0;break}const m=this.getMeshIncrementForOccurrence(i,c,g,a);if(!m)continue;const f=e+".CP";let I,E;this.useIsolateEffect||(p.getBodyComponent().setScalarVisualizationOccurrence(u),this.occurrencesMarkedAsSimulated.push(e)),this.useIsolateEffect?(I=s.getOrCreateIdForName(f),E=n.getOrCreateOccurrenceData(I),E.setTransform(d.getTransform()),E.setIsolated(!0),E.setVisibility(d.getVisibility()),E.setIsClippedBySectionPlanes(d.getIsClippedBySectionPlanes())):(I=u,E=d),h.push(I),m.id=e;const S=this.meshManager.addMeshIncrement(m,this.meshOwnerId),T=new BS("Contact "+f);T.onIncrementAdded(S);const M=p.retrieveBodyMetaData(g.partIds[0]),C=new fE;M&&C.setAttribute(Jd.COLOR,M.getColor()),this.rootNode.addOccurrenceGeometryToNode(this.meshNodeProperties,E,C,T),this.rootNode.addOccurrenceGeometryToNode(this.fadeMeshNodeProperties,E,C,T),this.visualizedOccurrencePaths.push(f)}o?this.clearGraphics():(this.viewer.getEventDispatcher().trigger(VM.GO,a),this.viewer.requestDraw(),this.useIsolateEffect&&(this.viewer.getIsolatedOccurrenceManager().clearAllIsolateNoAnimation(),je(1),this.viewer.getIsolatedOccurrenceManager().addIdsToIsolate(h,!0)),e.report())}setContactTractionThreshold(e){this.contactTractionThreshold=e,this.updateMaterialUniforms(),this.viewer.requestDraw()}isNodeForBodyVisualization(e){return this.rootNode===e}updateMaterialUniforms(){this.material.setCustomFloatUniform("uMultipleConnectionsCoordinate",this.multipleConnectionCoordinate),this.fadeMaterial.setCustomFloatUniform("uMultipleConnectionsCoordinate",this.multipleConnectionCoordinate),this.material.setCustomFloatUniform("uTractionContactThreshold",Math.floor(this.contactTractionThreshold*Fh-1)),this.fadeMaterial.setCustomFloatUniform("uTractionContactThreshold",Math.floor(this.contactTractionThreshold*Fh-1))}get viewer(){return this.modelViewManager.getViewer()}prepareScenegraph(){const e="ContactAnalysis",t=this.modelViewManager.getSharedBodyNode();this.rootNode=t.getChildById(e),this.rootNode||(this.rootNode=new ts(e),t.addChild(this.rootNode)),this.material=Xi(),this.material.shaderId="contact",this.fadeMaterial=Xi(),this.fadeMaterial.shaderId="contact",this.material.setCustomFloatUniform("uOcclusionFactor",0),this.material.setCustomFloatUniform("uBlendTransparent",0),this.fadeMaterial.setCustomFloatUniform("uOcclusionFactor",0),this.fadeMaterial.setCustomFloatUniform("uBlendTransparent",1),this.meshNodeProperties=new Qi({material:this.material,zOffset:q.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:_i.MX.TRIANGLES,includedInBlend:!0,addsToSectionMask:!1,clippedBySectionPlanes:!0,isPickable:!1,isTwoSided:!0}),this.fadeMeshNodeProperties=new Qi({material:this.fadeMaterial,zOffset:q.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:_i.MX.TRIANGLES,includedInBlend:!0,addsToSectionMask:!1,clippedBySectionPlanes:!0,isPickable:!1,isTwoSided:!0,primitivesHaveTransparency:!0})}clearGraphics(){const e=this.viewer.getOccurrenceIdManager(),t=this.viewer.getOccurrenceDataManager();for(let i=0;i<this.visualizedOccurrencePaths.length;++i){const s=this.visualizedOccurrencePaths[i],n=e.getIdForName(s);if(n===DI.Qy)continue;t.getOccurrenceData(n)&&(this.rootNode.removeOccurrence(n),t.destroyOccurrenceData(n),e.removeName(s))}this.meshManager&&this.meshManager.destroy(),this.meshManager=new zS(this.viewer,{bufferAllocationPolicy:CI.MAXIMUM}),this.simulationManager.clearScalarVisualizationStatusForOccurrences(this.occurrencesMarkedAsSimulated),this.occurrencesMarkedAsSimulated=[]}updateConnectionTexture(e,t,i){const s=e.contactPairList.length+2,n=new Uint8Array(4*s*1),r={},a=W.hto.slice(0,W.hto.length-1);for(let e=0;e<a.length;++e)r[a[e]]=(0,Js.Db)(q.default.getManager().getColor("CONTACT_COLOR_"+a[e]));const o=this.getNonMatedContactType(),h=W.v79[o],c=this.contactBehavior===W.Ixp.FUSE_IN_CONTACT,l={};let u=0;function d(e){const t=e.firstOccurrence.getPathAsString(),i=e.secondOccurrence.getPathAsString();let s;if(s=t<i?t+"-"+i:i+"-"+t,l.hasOwnProperty(s))return l[s];{const e=u++;return l[s]=e,e}}const g=[];this.connectionTypes=[];for(let i=0;i<e.contactPairList.length;++i){const s=e.contactPairList[i];let a;s.occurrencePairId=d(s);let l=h;if(s.mateId&&!c){const e=t.getMateIndicatorData(s.mateId);let i=o;e?i=e.getSimulationConnectionType():It.log.debug("Failed to find mate for connection visualization: "+s.mateId),l=W.v79[i],a=r[i]?r[i]:r[o]}else a=r[o];this.connectionTypes.push(l),g.push({contactPairIndex:i,contactPair:s,connectionType:l});const u=4*i*1;n.set(a,u)}this.sortContactFields(g);let p=-1;for(let e=0;e<g.length;++e){const t=g[e];let s=!0;(c&&t.contactPair.hasSimulationConnections||p===t.contactPair.occurrencePairId&&t.connectionType===h)&&(s=!1),t.connectionType!==h&&(p=t.contactPair.occurrencePairId),s&&i.add(t.connectionType)}const m=4*(s-1)*1;n.set(r.MULTIPLE,m);const f=4*(s-2)*1;n.set(r[bh],f);const I=new co(this.viewer.getGlContext());I.bytes=n,I.width=1,I.height=s,this.material.ambientTexture&&this.material.ambientTexture.destroy(),this.material.ambientTexture=new uo(this.viewer,I),this.material.ambientTexture.setHasTransparency(!1),this.fadeMaterial.ambientTexture=this.material.ambientTexture,this.textureInfo={textureEntryCount:s,texelHeight:1/s,texelWidth:1},this.updateMaterialUniforms()}getNonMatedContactType(){return this.contactBehavior===W.Ixp.MATES_ONLY?"UNCONSTRAINED":bh}getMeshIncrementForOccurrence(e,t,i,s){const n=this.simulationManager.getTessellationForOccurrenceResult(t);if(!n)return null;const r=this.simulationManager.getSampleMesh(n,t),a=new jE(_i.MX.TRIANGLES,r.points,r.getAnyIndices()),o=this.getContactAttributesForResult(e,t,s);if(!o)return null;a.contactTraction=o.contactTraction,a.contactPairCoordinate=o.contactPairCoordinate;const h=this.modelViewManager.getPartStudio(t.sourcePartReference);if(h){const e=h.getBodyBounds(n.deterministicId,i.occurrenceData.occurrence);e&&(a.boundingBox=e)}return a}sortContactFields(e){const t=W.v79[this.getNonMatedContactType()];e.sort(((e,i)=>e.contactPair.occurrencePairId===i.contactPair.occurrencePairId?e.connectionType===i.connectionType?e.contactPairIndex-i.contactPairIndex:e.connectionType===t?1:i.connectionType===t?-1:e.connectionType-i.connectionType:e.contactPair.occurrencePairId<i.contactPair.occurrencePairId?-1:1))}getContactAttributesForResult(e,t,i){if(0===t.fields.length)return It.log.debug("Found occurrence result with no fields"),null;const s=[];let n=0;for(let i=0;i<t.fields.length;++i){const n=t.fields[i];for(let t=0;t<n.contactPairIndices.length;++t){const i=n.contactPairIndices[t],r=this.connectionTypes[i],a=e.contactPairList[i];s.push({contactPairIndex:i,connectionType:r,contactPair:a,field:n,visible:!1})}}const r=W.v79[this.getNonMatedContactType()];this.sortContactFields(s);const a=this.contactBehavior===W.Ixp.FUSE_IN_CONTACT,o=[];let h=-1;for(let t=0;t<s.length;++t){const i=s[t];let c=!this.simulationManager.getVisualizationState().connectionTypeToHidden[i.connectionType];const l=e.contactPairList[i.contactPairIndex];(a&&l.hasSimulationConnections||h===i.contactPair.occurrencePairId&&i.connectionType===r)&&(c=!1),i.connectionType!==r&&(h=i.contactPair.occurrencePairId),i.visible=c,c&&(++n,o.push(i))}if(0===n)return null;const c=s[0].field.values.length,l=new Uint8Array(16*c),u=new Float32Array(16*c);let d=!1,g=0,p=0;const m=[];for(let e=0;e<o.length;++e)m.push(this.getTextureCoordinate(o[e].contactPairIndex));if(n>16){Lh||(this.AnalyticsService.trackEvent("SIMULATION","high-connection-count"),Lh=!0);const e=this.multipleConnectionCoordinate;a||(d=!0);for(let t=0;t<c;++t){let i=o[0].field.values[t];for(let e=1;e<o.length;++e){const s=o[e].field.values[t];s>i&&(i=s)}l[g++]=Math.min(255,Fh*i),u[p++]=e;for(let e=1;e<16;++e)g++,p++}}else for(let e=0;e<c;++e){let t=0;for(let i=0;i<16;++i)if(i<o.length){const s=o[i].field.values[e];s>=this.contactTractionThreshold&&++t,l[g++]=Math.min(255,Fh*s),u[p++]=m[i]}else g++,p++;d=t>1&&!a||d}return d&&i.add(W.v79.MULTIPLE),{contactTraction:l,contactPairCoordinate:u}}getTextureCoordinate(e){return.5*this.textureInfo.texelHeight+e*this.textureInfo.texelHeight}get multipleConnectionCoordinate(){return this.contactBehavior===W.Ixp.FUSE_IN_CONTACT?this.getTextureCoordinate(this.textureInfo.textureEntryCount-2):this.getTextureCoordinate(this.textureInfo.textureEntryCount-1)}}xh.$inject=["AnalyticsService"];var Bh=i(68380),Uh=i(32472),Vh=i(24715),Gh=i(23215);const Hh=new Qi({primitiveType:_i.MX.LINES,isPickable:!1}),kh=new Qi({primitiveType:_i.MX.LINES,isVisible:!1}),Wh=new Qi({primitiveType:_i.MX.TRIANGLES,isPickable:!1,material:Wi,primitivesHaveTransparency:!1}),zh=new Qi({primitiveType:_i.MX.TRIANGLES,isVisible:!1}),Xh="legend",qh="legendMinTick",Zh="legendMaxTick",Yh="legendColorMap",Kh="legendAboveMax",jh="legendBelowMin",Qh="legendBackground",$h="legendDragRegion",Jh="minHighlight",ec="maxHighlight",tc="dimHighlight",ic=.1,sc=.3,nc=.4,rc=.5,ac=Xn.C.GRAB,oc=Xn.C.CROSSHAIR,hc=Xn.C.GRABBING,cc=Xn.C.POINTER,lc=Xn.C.EW_RESIZE,uc=Xn.C.NS_RESIZE;class dc extends Ri{get SNAPPING_MARGIN_TOP(){return 0}constructor(e){super(e.getViewer(),sh.EG),this.manager=e,this.valueTextElements=[],this.textCache=[],this.isVertical=!0,this.isDamaged=!1,this.colorMapDimensions={width:0,height:0},this.colorMapPadding={left:0,right:0,top:0,bottom:0},this.userHasMovedLegend=!1,this.legendMovedSubject=new Fs.x,this.legendDragPoint=new W.YFv,this.isBeingDragged=!1,this.tickBeingDragged=null,this.removeSubject=new Fs.x,this.colorMapMaterial=Xi(),this.colorMapNodeProperties=new Qi({primitiveType:_i.MX.TRIANGLES,material:this.colorMapMaterial}),this.setActiveColorMapping(Uh.T),this.listenTo(this,Pi.MOUSE_ENTER+Xh,this.onMouseEnterLegend),this.listenTo(this,Pi.MOUSE_ENTER+Yh,this.onMouseEnterColorMap),this.listenTo(this,Pi.DRAG_START+Xh,this.onDragStartLegend),this.listenTo(this,Pi.DRAG+Xh,this.onDragLegend),this.listenTo(this,Pi.DRAG_STOP+Xh,this.onDragStopLegend),this.listenTo(this,Pi.DRAG_START+Yh,this.onDragStartLegend),this.listenTo(this,Pi.DRAG+Yh,this.onDragLegend),this.listenTo(this,Pi.DRAG_STOP+Yh,this.onDragStopLegend),this.listenTo(this,Pi.MOUSE_LEAVE+Yh,(()=>this.onMouseLeavePopCursor(oc))),this.listenTo(this,Pi.MOUSE_LEAVE+Xh,(()=>this.onMouseLeavePopCursor(ac))),this.listenTo(this,Pi.MOUSE_ENTER+Zh,this.onMouseEnterTick),this.listenTo(this,Pi.DRAG_START+Zh,this.onDragStartTickMax),this.listenTo(this,Pi.DRAG+Zh,this.onDragTickMax),this.listenTo(this,Pi.DRAG_STOP+Zh,this.onDragStopTick),this.listenTo(this,Pi.MOUSE_LEAVE+Zh,this.onMouseLeaveTick),this.listenTo(this,Pi.MOUSE_ENTER+qh,this.onMouseEnterTick),this.listenTo(this,Pi.DRAG_START+qh,this.onDragStartTickMin),this.listenTo(this,Pi.DRAG+qh,this.onDragTickMin),this.listenTo(this,Pi.DRAG_STOP+qh,this.onDragStopTick),this.listenTo(this,Pi.MOUSE_LEAVE+qh,this.onMouseLeaveTick),e.getSupportsInContextMode()&&(0,Is.Xt)().getPanelOpenCloseObservable().pipe((0,Gh.R)(this.getRemoveObservable())).subscribe((e=>this.panelWasAdded(e))),this.changeLegendOrientation(),this.updateConstants()}updateConstants(){const e=q.default.getManager(),t=e.getNumber("LEGEND_TICK_TEXT_UNDERLINE_WIDTH_PX");this.backgroundColor=e.getColor("LEGEND_BACKGROUND_COLOR"),this.defaultFontOptions={color:e.getColor("LEGEND_TICK_TEXT_COLOR"),size:e.getNumber("LEGEND_TICK_TEXT_HEIGHT_PX"),font:e.getString("LEGEND_TICK_TEXT_FONT")},this.clickableFontOptions={color:e.getColor("LEGEND_TICK_CLICKABLE_TEXT_COLOR"),size:e.getNumber("LEGEND_TICK_TEXT_HEIGHT_PX"),font:e.getString("LEGEND_TICK_TEXT_FONT"),underlineWidth:t},this.hoverFontOptions={color:e.getColor("LEGEND_TICK_TEXT_COLOR"),size:e.getNumber("LEGEND_TICK_TEXT_HEIGHT_PX"),font:e.getString("LEGEND_TICK_TEXT_FONT"),fontWeight:e.getString("LEGEND_TICK_TEXT_HOVER_WEIGHT"),underlineWidth:t}}panelWasAdded(e){var t,i;if((null==e?void 0:e.panelId)!==this.CANVAS_CONTROLS_PANEL_ID||this.userHasMovedLegend)return;const s=this.colorMapCorners,n=this.calculateInitialLegendPosition();n&&(this.colorMapCorners=n,(null==s?void 0:s.bottomLeft.equals(null===(t=this.colorMapCorners)||void 0===t?void 0:t.bottomLeft))&&(null==s?void 0:s.topRight.equals(null===(i=this.colorMapCorners)||void 0===i?void 0:i.topRight))||this.updateGraphics())}setIsVertical(e){this.isVertical!==e&&this.changeLegendOrientation()}getIsVertical(){return this.isVertical}areCoordinatesOverLegend(e){return!!this.colorMapCorners&&(this.colorMapCorners.bottomLeft.x<e.x&&e.x<this.colorMapCorners.topRight.x&&this.colorMapCorners.bottomLeft.y<e.y&&e.y<this.colorMapCorners.topRight.y)}onMouseLeavePopCursor(e){this.viewer.removeTopOccurrenceOfCursor(e)}onMouseLeaveTick(){const e=this.isVertical?uc:lc;this.onMouseLeavePopCursor(e)}onMouseEnterLegend(){this.viewer.pushCursor(ac)}onMouseEnterColorMap(){this.viewer.pushCursor(oc)}onDragStartLegend(e,t,i){this.viewer.pushCursor(hc),i.requestDrag=!0,this.legendDragPoint.updateFromArray([t.mouseX,t.mouseY]),this.userHasMovedLegend=!0}onMouseEnterTick(){this.isVertical?this.viewer.pushCursor(uc):this.viewer.pushCursor(lc)}get isTickBeingDragged(){return null!==this.tickBeingDragged}onDragStartTick(e,t,i){var s;this.isBeingDragged=!0,i.requestDrag=!0,this.currentScaleRange=null===(s=this.visualizedScalarRange)||void 0===s?void 0:s.clone()}onDragStartTickMax(e,t,i){return this.tickBeingDragged=Vh.s.MAX,this.onDragStartTick(e,t,i)}onDragStartTickMin(e,t,i){return this.tickBeingDragged=Vh.s.MIN,this.onDragStartTick(e,t,i)}onDragStopTick(){var e;this.isBeingDragged=!1,this.tickBeingDragged=null,this.currentScaleRange=null===(e=this.visualizedScalarRange)||void 0===e?void 0:e.clone(),this.isDamaged=!0}onDragLegend(e,t){const i=W.YFv.fromArray([this.legendDragPoint.x-t.mouseX,t.mouseY-this.legendDragPoint.y]);this.moveLegend(i)}onDragStopLegend(){this.viewer.removeTopOccurrenceOfCursor(hc),this.isBeingDragged=!1,this.legendDragPoint=new W.YFv}onDragTickMin(e,t){var i;if(!(null===(i=this.visualizedScalarRange)||void 0===i?void 0:i.hasRange))return;const{topRight:s}=this.getViewportCoordinates();let n=this.getClampedValueFromCoordinatesInRange(W.YFv.fromArray([t.mouseX,s.y-t.mouseY]));this.isInverted?n<this.visualizedScalarRange.max+bi.W.MIN_LEGEND_MIN_MAX_DIFFERENCE&&(n=Math.min(this.visualizedScalarRange.max+bi.W.MIN_LEGEND_MIN_MAX_DIFFERENCE,this.visualizedScalarRange.min)):n>this.visualizedScalarRange.max-bi.W.MIN_LEGEND_MIN_MAX_DIFFERENCE&&(n=Math.max(this.visualizedScalarRange.max-bi.W.MIN_LEGEND_MIN_MAX_DIFFERENCE,this.visualizedScalarRange.min)),n!==this.visualizedScalarRange.min&&this.viewer.getEventDispatcher().trigger(this.LEGEND_RANGE_CHANGED,n,Vh.s.MIN)}onDragTickMax(e,t){var i;if(!(null===(i=this.visualizedScalarRange)||void 0===i?void 0:i.hasRange))return;const{topRight:s}=this.getViewportCoordinates();let n=this.getClampedValueFromCoordinatesInRange(W.YFv.fromArray([t.mouseX,s.y-t.mouseY]));this.isInverted?n>this.visualizedScalarRange.min-bi.W.MIN_LEGEND_MIN_MAX_DIFFERENCE&&(n=Math.max(this.visualizedScalarRange.min-bi.W.MIN_LEGEND_MIN_MAX_DIFFERENCE,this.visualizedScalarRange.max)):n<this.visualizedScalarRange.min+bi.W.MIN_LEGEND_MIN_MAX_DIFFERENCE&&(n=Math.min(this.visualizedScalarRange.min+bi.W.MIN_LEGEND_MIN_MAX_DIFFERENCE,this.visualizedScalarRange.max)),n!==this.visualizedScalarRange.max&&this.viewer.getEventDispatcher().trigger(this.LEGEND_RANGE_CHANGED,n,Vh.s.MAX)}getValueFromCoordinates(e){var t;if(!(null===(t=this.currentScaleRange)||void 0===t?void 0:t.hasRange))return It.log.warn("Tried to getValueFromCoordinates but currentScaleRange was not valid"),0;const i=this.isVertical?e.y:e.x,s=this.calculateLongSideCoordinate(this.currentScaleRange.max),n=this.calculateLongSideCoordinate(this.currentScaleRange.min),r=(i-n)/(s-n)*this.currentScaleRange.magnitude+this.currentScaleRange.min;return isNaN(r)&&It.log.warn(`Tried to getValueFromCoordinates but value was ${r}`),r}getValueFromCoordinatesInVisualizedRange(e){var t;if(!(null===(t=this.visualizedScalarRange)||void 0===t?void 0:t.hasRange))return It.log.warn("Tried to getValueFromCoordinatesInVisualizedRange but visualizedScalarRange was not valid"),0;const i=this.isVertical?e.y:e.x,s=this.calculateLongSideCoordinate(this.visualizedScalarRange.max),n=this.calculateLongSideCoordinate(this.visualizedScalarRange.min),r=(i-n)/(s-n)*this.visualizedScalarRange.magnitude+this.visualizedScalarRange.min;return isNaN(r)&&It.log.warn(`Tried to getValueFromCoordinatesInVisualizedRange but value was ${r}`),r}getClampedValueFromCoordinatesInRange(e){var t;if(!(null===(t=this.currentScaleRange)||void 0===t?void 0:t.hasRange))return It.log.warn("Tried to getClampedValueFromCoordinatesInRange but currentScaleRange was not valid"),0;const i=this.getValueFromCoordinates(e);return i>this.currentScaleRange.highValue?this.currentScaleRange.highValue:i<this.currentScaleRange.lowValue?this.currentScaleRange.lowValue:i}getViewportCoordinates(){var e,t;const i=null===(t=null===(e=this.viewer.getCamera())||void 0===e?void 0:e.getViewport(!0))||void 0===t?void 0:t.slice();return i?(this.lastRenderedViewport||(this.lastRenderedViewport=i.slice()),this.getCornerCoordinatesFromViewportVector(i)):(It.log.debug("Tried to get viewport coordinates but the viewport was falsey"),null)}getCornerCoordinatesFromViewportVector(e){return{bottomLeft:W.YFv.fromXY(e[0],e[1]),topRight:W.YFv.fromXY(e[0]+e[2],e[1]+e[3])}}changeLegendOrientation(e){this.isVertical=!this.isVertical;const t=q.default.getManager();this.isVertical?(this.colorMapDimensions.width=t.getNumber("LEGEND_COLOR_MAP_VERTICAL_WIDTH_PX"),this.colorMapDimensions.height=t.getNumber("LEGEND_COLOR_MAP_VERTICAL_HEIGHT_PX"),this.colorMapPadding.left=t.getNumber("LEGEND_VERTICAL_LEFT_MARGIN_PX"),this.colorMapPadding.bottom=t.getNumber("LEGEND_VERTICAL_BOTTOM_MARGIN_PX"),this.colorMapPadding.right=t.getNumber("LEGEND_VERTICAL_RIGHT_MARGIN_PX"),this.colorMapPadding.top=t.getNumber("LEGEND_VERTICAL_TOP_MARGIN_PX")):(this.colorMapDimensions.width=t.getNumber("LEGEND_COLOR_MAP_HORIZONTAL_WIDTH_PX"),this.colorMapDimensions.height=t.getNumber("LEGEND_COLOR_MAP_HORIZONTAL_HEIGHT_PX"),this.colorMapPadding.left=t.getNumber("LEGEND_HORIZONTAL_LEFT_MARGIN_PX"),this.colorMapPadding.bottom=t.getNumber("LEGEND_HORIZONTAL_BOTTOM_MARGIN_PX"),this.colorMapPadding.right=t.getNumber("LEGEND_HORIZONTAL_RIGHT_MARGIN_PX"),this.colorMapPadding.top=t.getNumber("LEGEND_HORIZONTAL_TOP_MARGIN_PX")),this.colorMapCorners&&(this.colorMapCorners.bottomLeft.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.height/2-this.colorMapDimensions.width/2,this.colorMapCorners.bottomLeft.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.width/2-this.colorMapDimensions.height/2,this.colorMapCorners.topRight.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width,this.colorMapCorners.topRight.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height),e&&(this.colorMapCorners.bottomLeft.x-this.colorMapPadding.left<e.left?(this.colorMapCorners.bottomLeft.x=e.left+this.colorMapPadding.left,this.colorMapCorners.topRight.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width):this.colorMapCorners.topRight.x+this.colorMapPadding.right>e.right&&(this.colorMapCorners.topRight.x=e.right-this.colorMapPadding.right,this.colorMapCorners.bottomLeft.x=this.colorMapCorners.topRight.x-this.colorMapDimensions.width),this.colorMapCorners.bottomLeft.y-this.colorMapPadding.bottom<e.bottom?(this.colorMapCorners.bottomLeft.y=e.bottom+this.colorMapPadding.bottom,this.colorMapCorners.topRight.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height):this.colorMapCorners.topRight.y+this.colorMapPadding.top>e.top&&(this.colorMapCorners.topRight.y=e.top-this.colorMapPadding.top,this.colorMapCorners.bottomLeft.y=this.colorMapCorners.topRight.y-this.colorMapDimensions.height))}onDevicePixelRatioChanged(e){if(this.isHidden)return void this.changeLegendOrientation();const t=(0,Es.x_)();if(!this.lastUsedDevicePixelRatio||t===this.lastUsedDevicePixelRatio)return;const i=this.lastRenderedViewport,s=e.getViewport(!0).slice(),n=t/this.lastUsedDevicePixelRatio;if(this.colorMapPadding.left*=n,this.colorMapPadding.top*=n,this.colorMapPadding.right*=n,this.colorMapPadding.bottom*=n,this.colorMapDimensions.width*=n,this.colorMapDimensions.height*=n,this.isVertical){const e=(.5*i[3]-this.colorMapCorners.bottomLeft.y)*n;this.colorMapCorners.bottomLeft.y=.5*s[3]-e;if(this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width/2>=i[2]/2){const e=(i[2]-this.colorMapCorners.bottomLeft.x)*n;this.colorMapCorners.bottomLeft.x=s[2]-e}else this.colorMapCorners.bottomLeft.x*=n}else{const e=(.5*i[2]-this.colorMapCorners.bottomLeft.x)*n;this.colorMapCorners.bottomLeft.x=.5*s[2]-e;if(this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height/2>=i[3]/2){const e=(i[3]-this.colorMapCorners.bottomLeft.y)*n;this.colorMapCorners.bottomLeft.y=s[3]-e}else this.colorMapCorners.bottomLeft.y*=n}this.colorMapCorners.topRight.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width,this.colorMapCorners.topRight.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height,this.lastRenderedViewport=s,this.lastUsedDevicePixelRatio=t,this.updateGraphics()}onAppearanceConstantsUpdated(){this.updateConstants(),this.updateGraphics()}onResize(e,t){const i=t[2]-e[2],s=t[3]-e[3];if(0===i&&0===s)return;const n=this.getCornerCoordinatesFromViewportVector(e),{shouldSnapTo:r}=this.getShouldSnapTo(n),a=this.getCornerCoordinatesFromViewportVector(t);let o=0,h=0;if(this.isVertical)if(h=s/2,r.left())this.snapToLeft(a);else{this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width/2>=e[2]/2&&(o=i)}else if(o=i/2,r.top())this.snapToTop(a);else{this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height/2>=e[3]/2&&(h=s)}this.moveLegend(W.YFv.fromXY(-o,-h),a,!0)}moveLegend(e,t=this.getViewportCoordinates(),i=!1){const{shouldSnapTo:s,snappableBounds:n}=this.getShouldSnapTo(t,e);let r=!1;s.top()?(!this.isVertical||i||r||this.changeLegendOrientation(n),this.snapToTop(t),r=!0):s.bottom()?(!this.isVertical||i||r||this.changeLegendOrientation(n),this.snapToBottom(t),r=!0):(this.colorMapCorners.bottomLeft.y-=e.y,this.colorMapCorners.topRight.y-=e.y,this.isBeingDragged&&(this.legendDragPoint.y=this.legendDragPoint.y+e.y)),s.left()?(this.isVertical||i||r||this.changeLegendOrientation(n),this.snapToLeft(t),r=!0):s.right()?(this.isVertical||i||r||this.changeLegendOrientation(n),this.snapToRight(t),r=!0):(this.colorMapCorners.topRight.x-=e.x,this.colorMapCorners.bottomLeft.x-=e.x,this.isBeingDragged&&(this.legendDragPoint.x=this.legendDragPoint.x-e.x)),(0,Js.sW)()&&(this.userHasMovedLegend=!0),this.legendMovedSubject.next(),this.isDamaged=!0}getLegendMovedObservable(){return this.legendMovedSubject.asObservable()}getShouldSnapTo(e,t=new W.YFv){const i=q.default.getManager(),s=i.getNumber("LEGEND_SIDE_SNAP_DEADZONE_PX"),n=i.getNumber("LEGEND_SIDE_SNAP_THRESHOLD_PX"),r=i.getNumber("LEGEND_VERTICAL_SNAP_THRESHOLD_PX"),a={right:e.topRight.x-s-n,left:e.bottomLeft.x+s+n,top:e.topRight.y-this.SNAPPING_MARGIN_TOP-r,bottom:e.bottomLeft.y+r};return{shouldSnapTo:{right:()=>this.colorMapCorners.topRight.x-t.x+this.colorMapPadding.right>a.right,left:()=>this.colorMapCorners.bottomLeft.x-t.x-this.colorMapPadding.left<a.left,top:()=>this.colorMapCorners.topRight.y-t.y+this.colorMapPadding.top>a.top,bottom:()=>this.colorMapCorners.bottomLeft.y-t.y-this.colorMapPadding.bottom<a.bottom},snappableBounds:a}}snapToTop(e){this.colorMapCorners.topRight.y=e.topRight.y-this.colorMapPadding.top-this.SNAPPING_MARGIN_TOP,this.colorMapCorners.bottomLeft.y=this.colorMapCorners.topRight.y-this.colorMapDimensions.height}snapToBottom(e){this.colorMapCorners.bottomLeft.y=e.bottomLeft.y+this.colorMapPadding.bottom,this.colorMapCorners.topRight.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height}snapToRight(e){const t=q.default.getManager().getNumber("LEGEND_SIDE_SNAP_DEADZONE_PX");this.colorMapCorners.topRight.x=e.topRight.x-this.colorMapPadding.right-t,this.colorMapCorners.bottomLeft.x=this.colorMapCorners.topRight.x-this.colorMapDimensions.width}snapToLeft(e){const t=q.default.getManager().getNumber("LEGEND_SIDE_SNAP_DEADZONE_PX");this.colorMapCorners.bottomLeft.x=e.bottomLeft.x+this.colorMapPadding.left+t,this.colorMapCorners.topRight.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width}remove(){super.remove(),this.colorMapMaterial.destroy(),this.clearText(),this.removeSubject.next()}getRemoveObservable(){return this.removeSubject.asObservable()}setActiveColorMapping(e){this.colorMapMaterial.ambientTexture=this.viewer.getResources().scalarVisualizationTextures.get(e)}setInputRange(e){this.rangeInData=e.rangeInData,e.defaultDisplayRange?this.defaultDisplayRange=e.defaultDisplayRange:this.defaultDisplayRange=e.rangeInData,this.visualizedScalarRange||this.setVisualizedScalarRange(this.defaultDisplayRange)}setVisualizedScalarRange(e){this.visualizedScalarRange=e,!this.isTickBeingDragged&&e&&(this.currentScaleRange=e.clone()),this.isDamaged=!0}clearRanges(){this.rangeInData=null,this.visualizedScalarRange=null,this.isDamaged=!0}hide(){this.clearText(),this.isDamaged=!0,super.hide()}onViewWillDraw(e){if(this.isHidden)return;const t=e.getViewport(!0);this.lastRenderedViewport?(0,pi.arraysEqual)(this.lastRenderedViewport,t)||(this.onResize(this.lastRenderedViewport,t),this.lastRenderedViewport=t.slice()):(this.lastRenderedViewport=t.slice(),this.isDamaged=!0),this.isDamaged&&this.updateGraphics()}getInputRangeInDisplayUnits(){if(this.rangeInData){const e=(0,Bh.r)(this.rangeInData,this.visualizedFieldType);return this.isInverted&&!e.isInverted?e.cloneInverted():e}return null}getDefaultDisplayRangeInDisplayUnits(){return this.defaultDisplayRange?(0,Bh.r)(this.defaultDisplayRange,this.visualizedFieldType):null}setupCorners(){this.colorMapCorners=this.getViewportCoordinates()}calculateInitialLegendPosition(){if(this.lastUsedDevicePixelRatio!==(0,Es.x_)())return null;const e=this.getViewportCoordinates();if(!e)return null;const t=W.YFv.fromArray([(e.topRight.x-this.colorMapPadding.right-this.colorMapDimensions.width+this.colorMapPadding.left)/2,e.topRight.y-this.SNAPPING_MARGIN_TOP-this.colorMapDimensions.height-this.colorMapPadding.top]);return{bottomLeft:t,topRight:W.YFv.fromArray([t.x+this.colorMapDimensions.width,t.y+this.colorMapDimensions.height])}}createRectangleUsingLegendBounds(e,t){const i=q.default.getManager().getNumber("LEGEND_BACKGROUND_CORNER_RADIUS_PX");return wu([this.colorMapCorners.bottomLeft.x-this.colorMapPadding.left,this.colorMapCorners.bottomLeft.y-this.colorMapPadding.bottom,t],[this.colorMapCorners.topRight.x+this.colorMapPadding.right,this.colorMapCorners.bottomLeft.y-this.colorMapPadding.bottom,t],[this.colorMapCorners.bottomLeft.x-this.colorMapPadding.left,this.colorMapCorners.topRight.y+this.colorMapPadding.top,t],i,5,e)}createHighlightRegion(e,t,i,s,n){const r=Math.max(this.colorMapDimensions.width,this.colorMapDimensions.height),a=Math.min(this.colorMapDimensions.width,this.colorMapDimensions.height),o=this.colorMapCorners.bottomLeft.x,h=this.colorMapCorners.bottomLeft.y;let c=i*r,l=c+(s-i)*r;const u=a/2,d=q.default.getManager().getNumber("LEGEND_OVERFLOW_DISPLAY_OFFSET_PX");let g,p;n===Vh.s.MIN&&this.isInputMinimumChanged()?c-=d:n===Vh.s.MAX&&this.isInputMaximumChanged()&&(l+=d),this.isVertical?(g=[u+o,c+h,nc],p=[u+o,l+h,nc]):(g=[c+o,u+h,nc],p=[l+o,u+h,nc]);return pu(g,p,e,t,a/this.lastUsedDevicePixelRatio)}requiresHighlightGraphics(){return!1}createHighlightGraphics(){var e,t;if(!this.requiresHighlightGraphics())return;if(!(null===(e=this.visualizedScalarRange)||void 0===e?void 0:e.hasRange))return void It.log.warn("Tried to createHighlightGraphics but visualizedScalarRange was not valid");if(!(null===(t=this.currentScaleRange)||void 0===t?void 0:t.hasRange))return void It.log.warn("Tried to createHighlightGraphics but currentScaleRange was not valid");const i=this.currentScaleRange.getNormalizedValue(this.visualizedScalarRange.min),s=this.currentScaleRange.getNormalizedValue(this.visualizedScalarRange.max);if(this.manager.getUseMinValueHighlight()){const e=this.manager.getMinHighlightColor(),t=this.createHighlightRegion(Jh,e,0,i,Vh.s.MIN);this.updateMeshIncrement(Jh,yi,t,Hh)}if(this.manager.getUseMaxValueHighlight()){const e=this.manager.getMaxHighlightColor(),t=this.createHighlightRegion(ec,e,s,1,Vh.s.MAX);this.updateMeshIncrement(ec,yi,t,Hh)}if(this.manager.getUseDimColorScale()){const e=this.manager.getDimHighlightColor(),t=this.createHighlightRegion(tc,e,i,s);this.updateMeshIncrement(tc,yi,t,Hh)}}updateGraphics(){var e,t;if(this.isHidden)return;this.removeMeshIncrements();if(this.clearText(!0),this.lastUsedDevicePixelRatio||(this.lastUsedDevicePixelRatio=(0,Es.x_)()),!this.colorMapCorners){const e=this.calculateInitialLegendPosition();if(!e)return;this.colorMapCorners=e}const i=this.createRectangleUsingLegendBounds(Qh,0);Uu(this.backgroundColor,i),td(i,this.backgroundColor[3]),this.updateMeshIncrement(Qh,yi,i,Wh);const s=this.createRectangleUsingLegendBounds($h,.2);this.updateMeshIncrement($h,Xh,s,zh);if(this.createColorMapQuads().forEach((e=>this.updateMeshIncrement(e.id,Yh,e,this.colorMapNodeProperties))),this.isDamaged=!1,this.createHighlightGraphics(),!(null===(e=this.visualizedScalarRange)||void 0===e?void 0:e.hasRange))return void this.clearTextCache();if(!(null===(t=this.currentScaleRange)||void 0===t?void 0:t.hasRange))return void It.log.warn("Tried to updateGraphics but currentScaleRange was not valid");const n=q.default.getManager(),r=this.isVertical?this.colorMapCorners.bottomLeft.x:this.colorMapCorners.bottomLeft.y,a=n.getNumber("LEGEND_TICK_LENGTH_PX"),o=r-a,h=n.getColor("LEGEND_TICK_SCALE_COLOR"),c=n.getNumber("LEGEND_TICK_TEXT_GAP_PX"),l=n.getNumber("LEGEND_TICK_WIDTH");for(let e=0;e<6;e++){const t=this.currentScaleRange.magnitude/5*e+this.currentScaleRange.min,i=this.calculateLongSideCoordinate(t),s="legendScaleTick"+e,n=this.createTick(i,r,o,ic,s,h,l);this.updateMeshIncrement(s,yi,n,Hh);let a=null,u=this.manager.getValueString(t),d=ic;if(0===e?(d=.5,a=this.LEGEND_MINIMUM_CLICKED,this.isDisplayMinimumChanged()&&(u+="*")):5===e&&(d=.5,a=this.LEGEND_MAXIMUM_CLICKED,this.isDisplayMaximumChanged()&&(u+="*")),this.isVertical){const e=W.d0F.fromArray([o-c,i,d]);this.placeText(u,e,Li.iK.HIGH,Li.iK.MID,s,a)}else{const e=W.d0F.fromArray([i,o-c,d]);this.placeText(u,e,Li.iK.MID,Li.iK.HIGH,s,a)}}this.createMinMaxTick(Vh.s.MIN),this.createMinMaxTick(Vh.s.MAX),this.createMinMaxInputRangeText(a),this.clearTextCache()}createMinMaxInputRangeText(e){if(this.isInputMaximumChanged()){const t=this.getInputRangeValueString(Vh.s.MAX),i=new W.d0F;i.z=ic,this.isVertical?(i.x=this.colorMapCorners.topRight.x-this.colorMapDimensions.width/2,i.y=this.colorMapCorners.topRight.y+e):(i.x=this.colorMapCorners.topRight.x+e,i.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height/2);const s=this.isVertical?Li.iK.MID:Li.iK.LOW,n=this.isVertical?Li.iK.LOW:Li.iK.MID;this.placeText(t,i,s,n)}if(this.isInputMinimumChanged()){const t=this.getInputRangeValueString(Vh.s.MIN),i=new W.d0F;i.z=ic,this.isVertical?(i.x=this.colorMapCorners.topRight.x-this.colorMapDimensions.width/2,i.y=this.colorMapCorners.bottomLeft.y-e):(i.x=this.colorMapCorners.bottomLeft.x-e,i.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height/2);const s=this.isVertical?Li.iK.MID:Li.iK.HIGH,n=this.isVertical?Li.iK.HIGH:Li.iK.MID;this.placeText(t,i,s,n)}}getInputRangeValueString(e){const t=this.getInputRangeInDisplayUnits(),i=e===Vh.s.MAX?null==t?void 0:t.max:null==t?void 0:t.min;return this.manager.getValueString(i)}createColorMapQuad(e,t,i,s){const n=s?s[0]:void 0,r=s?s[1]:void 0;return Ou(this.isVertical?[t.x,t.y,sc]:[t.x,i.y,sc],this.isVertical?[i.x,t.y,sc]:[t.x,t.y,sc],this.isVertical?[t.x,i.y,sc]:[i.x,i.y,sc],e,n,r)}createColorMapQuads(){var e,t,i,s;const n=[],r=[[1,1],[1,1]],a=[[0,1],[1,0]],o=q.default.getManager().getNumber("LEGEND_OVERFLOW_DISPLAY_OFFSET_PX");if(this.isVertical){let i=this.colorMapCorners.topRight.y,s=this.colorMapCorners.bottomLeft.y;if((null===(e=this.visualizedScalarRange)||void 0===e?void 0:e.hasRange)&&this.isInputMaximumChanged()){i=this.calculateLongSideCoordinate(this.visualizedScalarRange.max);const e=W.YFv.fromArray([this.colorMapCorners.bottomLeft.x,i]),t=W.YFv.fromArray([this.colorMapCorners.topRight.x,this.colorMapCorners.topRight.y+o]),s=this.createColorMapQuad(Kh,e,t);n.push(s)}if((null===(t=this.visualizedScalarRange)||void 0===t?void 0:t.hasRange)&&this.isInputMinimumChanged()){s=this.calculateLongSideCoordinate(this.visualizedScalarRange.min);const e=W.YFv.fromArray([this.colorMapCorners.topRight.x,s]),t=W.YFv.fromArray([this.colorMapCorners.bottomLeft.x,this.colorMapCorners.bottomLeft.y-o]),i=this.createColorMapQuad(jh,t,e,r);n.push(i)}const h=W.YFv.fromArray([this.colorMapCorners.bottomLeft.x,s]),c=W.YFv.fromArray([this.colorMapCorners.topRight.x,i]),l=this.createColorMapQuad(Yh,h,c,a);n.push(l)}else{let e=this.colorMapCorners.topRight.x,t=this.colorMapCorners.bottomLeft.x;if((null===(i=this.visualizedScalarRange)||void 0===i?void 0:i.hasRange)&&this.isInputMaximumChanged()){e=this.calculateLongSideCoordinate(this.visualizedScalarRange.max);const t=W.YFv.fromArray([e,this.colorMapCorners.bottomLeft.y]),i=W.YFv.fromArray([this.colorMapCorners.topRight.x+o,this.colorMapCorners.topRight.y]),s=this.createColorMapQuad(Kh,t,i);n.push(s)}if((null===(s=this.visualizedScalarRange)||void 0===s?void 0:s.hasRange)&&this.isInputMinimumChanged()){t=this.calculateLongSideCoordinate(this.visualizedScalarRange.min);const e=W.YFv.fromArray([this.colorMapCorners.bottomLeft.x-o,this.colorMapCorners.bottomLeft.y]),i=W.YFv.fromArray([t,this.colorMapCorners.topRight.y]),s=this.createColorMapQuad(jh,e,i,r);n.push(s)}const h=W.YFv.fromArray([t,this.colorMapCorners.bottomLeft.y]),c=W.YFv.fromArray([e,this.colorMapCorners.topRight.y]),l=this.createColorMapQuad(Yh,h,c,a);n.push(l)}return n}clearText(e=!1){this.clearTextCache();for(let t=0;t<this.valueTextElements.length;++t){const i=this.valueTextElements[t].text;e?(i.viewer.uiSelectionManager.removeSelectionForUiElement(i),this.textCache.push(i)):i.remove(),this.stopListening(i)}this.valueTextElements=[]}getOrCreateText(e,t){for(let i=0;i<this.textCache.length;++i){const s=this.textCache[i];if(s.hasEqualTextAndOptions(e,t))return this.textCache.splice(i,1),s.show(),s}return new La(this.viewer,e,t)}clearTextCache(){for(let e=0;e<this.textCache.length;++e)this.textCache[e].remove();this.textCache=[]}get isInverted(){var e;return null===(e=this.visualizedScalarRange)||void 0===e?void 0:e.isInverted}isInputMinimumChanged(){return W.dGY.isMinChanged(this.getInputRangeInDisplayUnits(),this.visualizedScalarRange,bi.W.ZERO_LENGTH)}isInputMaximumChanged(){return W.dGY.isMaxChanged(this.getInputRangeInDisplayUnits(),this.visualizedScalarRange,bi.W.ZERO_LENGTH)}isDisplayMinimumChanged(){return W.dGY.isMinChanged(this.getDefaultDisplayRangeInDisplayUnits(),this.currentScaleRange,bi.W.ZERO_LENGTH)}isDisplayMaximumChanged(){return W.dGY.isMaxChanged(this.getDefaultDisplayRangeInDisplayUnits(),this.currentScaleRange,bi.W.ZERO_LENGTH)}calculateLongSideCoordinate(e){var t;if(!(null===(t=this.currentScaleRange)||void 0===t?void 0:t.hasRange))return It.log.warn("Tried to calculateLongSideCoordinate but currentScaleRange was not valid"),0;let i;if(i=this.isVertical?this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height*(e-this.currentScaleRange.min)/this.currentScaleRange.magnitude:this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width*(e-this.currentScaleRange.min)/this.currentScaleRange.magnitude,isNaN(i))return It.log.warn(`Tried to calculateLongSideCoordinate but coordinate was ${i}`),0;const s=(0,Es.x_)()/2;return Math.round(i+s)-s}createMinMaxTick(e){var t;if(!(null===(t=this.visualizedScalarRange)||void 0===t?void 0:t.hasRange))return void It.log.warn("Tried to createMinMaxTick but visualizedScalarRange was not valid");const i=e===Vh.s.MAX,s=i?Zh:qh,n=i?this.visualizedScalarRange.max:this.visualizedScalarRange.min,r=this.calculateLongSideCoordinate(n),a=q.default.getManager(),o=a.getNumber("LEGEND_TICK_LENGTH_PX"),h=a.getColor("LEGEND_TICK_MIN_MAX_COLOR"),c=a.getNumber("LEGEND_TICK_WIDTH"),l=c+2*a.getNumber("LEGEND_TICK_MIN_MAX_OUTLINE_WIDTH"),u=a.getColor("LEGEND_TICK_MIN_MAX_OUTLINE_COLOR"),d=a.getNumber("LEGEND_TICK_CLICK_TARGET_WIDTH_PX"),g=a.getNumber("LEGEND_TICK_TEXT_GAP_PX"),p=this.isVertical?this.colorMapCorners.topRight.x:this.colorMapCorners.topRight.y,m=this.isVertical?this.colorMapCorners.bottomLeft.x-o:this.colorMapCorners.bottomLeft.y-o,f=this.createTick(r,p,m,.45,s,u,l);this.updateMeshIncrement(s+"outline",s,f,Hh);const I=this.createTick(r,p,m,rc,s,h,c);this.updateMeshIncrement(s,s,I,Hh);const E=this.createTick(r,p,m,rc,s,h,d);if(this.updateMeshIncrement(s+"target",s,E,kh),i&&this.tickBeingDragged===Vh.s.MAX||!i&&this.tickBeingDragged===Vh.s.MIN){const e=this.manager.getValueString(n),t="",i=!0;if(this.isVertical){const n=W.d0F.fromArray([m-g,r,rc]);this.placeText(e,n,Li.iK.HIGH,Li.iK.MID,t,s,i)}else{const n=W.d0F.fromArray([r,m-g,rc]);this.placeText(e,n,Li.iK.MID,Li.iK.HIGH,t,s,i)}}}createTick(e,t,i,s,n,r,a){let o;return o=this.isVertical?pu([i,e,s],[t,e,s],n,r):pu([e,i,s],[e,t,s],n,r),Hu(a,o),o}placeText(e,t,i,s,n,r,a){const o={...r?this.clickableFontOptions:this.defaultFontOptions};o.size=Math.floor(q.default.getManager().getNumber("LEGEND_TICK_TEXT_HEIGHT_PX"));const h=this.getOrCreateText(e,o);if(h.positionRelativeTo([t.x,t.y,t.z],i,s),r){this.listenTo(h,Pi.MOUSE_ENTER+La.SELECTION_ID,(()=>{this.viewer.pushCursor(cc),h.updateWithOptions(this.hoverFontOptions)})),this.listenTo(h,Pi.MOUSE_LEAVE+La.SELECTION_ID,(()=>{this.onMouseLeavePopCursor(cc),h.updateWithOptions(this.clickableFontOptions)}));const e=this.getInputRangeInDisplayUnits();this.listenTo(h,Pi.CLICK+La.SELECTION_ID,((t,i)=>{this.viewer.getEventDispatcher().trigger(r,i.sourceEvent,e,h.getTextCenterInCanvas())}))}if(a){const e=h.getTransformedBounds().getXyBounds();for(let t=0;t<this.valueTextElements.length;++t){const i=this.valueTextElements[t];e.overlapsWith(i.text.getTransformedBounds().getXyBounds())&&(i.text.hide(),i.associatedTickId&&this.hideIncrement(i.associatedTickId))}}this.valueTextElements.push({text:h,associatedTickId:n})}getColorMapCorners(){return this.colorMapCorners}}var gc=i(40119);class pc{constructor(e){this.modelViewManager=e,this.supportsInContextMode=!1,this.nodes=[],this.visualizationStateSubject=new Fs.x,this.DEFAULT_COLOR_MAPPING=W.ZIP.VIRIDIS,this.scalarVisualizationMaterials=[],this.keepLegendHiddenAndAllowControls=!1,this.webAssemblyUtils=If.module}cloneVisualizationState(e){return e.clone()}static getMapIndex(e){return pc.imageMaps.findIndex((t=>t.type===e))}viewerIsInScalarVisualizationRenderMode(){return this.getViewer().getRenderingMode()===this.graphicsRenderMode}usesGraphicsRenderMode(e){return e===this.graphicsRenderMode}getRangeInData(){return this.displayedScalarRangeSpecification?this.displayedScalarRangeSpecification.rangeInData:null}setRangeInData(e){this.displayedScalarRangeSpecification?(this.displayedScalarRangeSpecification.rangeInData=e,this.getDefaultDisplayRange()||this.setVisualizedRange(e)):It.log.debug("Tried to set rangeInData but displayedScalarRangeSpecification was null")}getDefaultDisplayRange(){return this.displayedScalarRangeSpecification?this.displayedScalarRangeSpecification.defaultDisplayRange:null}updateDefaultDisplayRange(e){this.displayedScalarRangeSpecification?this.displayedScalarRangeSpecification.defaultDisplayRange=e:It.log.debug("Tried to set defaultDisplayRange but displayedScalarRangeSpecification was null")}setDefaultDisplayRange(e){this.updateDefaultDisplayRange(e),this.setVisualizedRange(e)}getSupportsInContextMode(){return this.supportsInContextMode}getColorMappingName(){const{colorMapping:e}=this.visualizationState;return W.hDy[e]}getMinHighlightColor(){const e=q.default.getManager(),t=this.getColorMappingName();return e.getColor(pc.MIN_COLOR_CONSTANT+t)}getMaxHighlightColor(){const e=q.default.getManager(),t=this.getColorMappingName();return e.getColor(pc.MAX_COLOR_CONSTANT+t)}getDimHighlightColor(){const e=q.default.getManager(),t=this.getColorMappingName();return e.getColor(pc.DIM_COLOR_CONSTANT+t)}updateScalarRangeUniforms(){const e=this.getRangeInData();if(!e||!this.visualizedScalarRange)return;const t=e.max,i=e.magnitude;let s=1/i;i<=bi.W.ZERO_LENGTH?(s=0,i<0&&It.log.debug("Invalid scalar input range")):i>16777216&&It.log.info(`Scalar range had a magnitude greater than 1.67e+7: ${i} for ${this.VISUALIZATION_MANAGER_NODE_ID}`);const n=this.getRangeInBaseUnits(this.visualizedScalarRange),r=n.max,a=n.magnitude,o=1/a,h=q.default.getManager(),c=this.getMinHighlightColor(),l=this.getMaxHighlightColor(),u=this.getDimHighlightColor(),d=h.getNumber(pc.BLEND_WIDTH_CONSTANT),g=1/d,p=this.getUseMinValueHighlight()?1:0,m=this.getUseMaxValueHighlight()?1:0,f=this.getUseDimColorScale()?1:0;for(const e of this.scalarVisualizationMaterials)e.setCustomFloatUniform(pc.SCALAR_INPUT_MAXIMUM_UNIFORM,t),e.setCustomFloatUniform(pc.SCALAR_INPUT_MAGNITUDE_INVERSE_UNIFORM,s),e.setCustomFloatUniform(pc.SCALAR_OUTPUT_MAXIMUM_UNIFORM,r),e.setCustomFloatUniform(pc.SCALAR_OUTPUT_MAGNITUDE_UNIFORM,a),e.setCustomFloatUniform(pc.SCALAR_OUTPUT_MAGNITUDE_INVERSE_UNIFORM,o),e.setCustomIntUniform(pc.USE_MIN_VALUE_UNIFORM,p),e.setCustomIntUniform(pc.USE_MAX_VALUE_UNIFORM,m),e.setCustomIntUniform(pc.USE_DIM_COLOR_UNIFORM,f),e.setCustomVectorUniform(pc.MIN_COLOR_UNIFORM,c),e.setCustomVectorUniform(pc.MAX_COLOR_UNIFORM,l),e.setCustomVectorUniform(pc.DIM_COLOR_UNIFORM,u),e.setCustomFloatUniform(pc.HIGHLIGHT_REGION_BLEND_DISTANCE,d),e.setCustomFloatUniform(pc.HIGHLIGHT_REGION_BLEND_INVERSE_DISTANCE,g)}getUseMinValueHighlight(){return!1}getUseMaxValueHighlight(){return!1}getUseDimColorScale(){return!1}getVisualizationState(){return this.visualizationState}getVisualizationStateObservable(){return this.visualizationStateSubject.asObservable()}getRangeInDisplayUnits(e){return e}getRangeInBaseUnits(e){return e}getValueInBaseUnits(e){return e}setVisualizationState(e){const t=this.visualizationState?this.displayedColorMap:null,i=null===t||t!==e.colorMapping,s=!this.visualizationState||!this.visualizationState.visualizedRange||!this.visualizationState.visualizedRange.equals(e.visualizedRange);this.visualizationState=e,this.visualizationStateSubject.next(e),this.updateGraphics(),i&&this.updateColorMapping(t,this.visualizationState.colorMapping),s&&this.updateVisualizedScalarRange(),this.readyToShowLegend()||this.hideLegend()}setVisualizedRange(e){const t=this.cloneVisualizationState(this.getVisualizationState());t.visualizedRange=e,this.setVisualizationState(t)}setVisualizedScaleComponent(e,t){var i;const s=this.getValueInBaseUnits(e),n=null===(i=this.visualizedScalarRange)||void 0===i?void 0:i.clone();switch(t){case Vh.s.MAX:n.max=s;break;case Vh.s.MIN:n.min=s}this.setVisualizedRange(n)}setColorMapping(e){if(e===this.displayedColorMap)return;localStorage.setItem(this.COLOR_MAP_STORAGE_KEY,""+e);const t=this.getVisualizationState().clone();t.colorMapping=e,this.setVisualizationState(t)}onRenderingModeChanged(){this.prepareResources(),this.viewerIsInScalarVisualizationRenderMode()?this.showLegend():(this.clearGraphics(),this.hideLegend())}clearGraphics(){this.resetScenegraphNodes(),this.cursorAppendage&&(this.cursorAppendage.destroy(),this.cursorAppendage=null),this.hideLegend(),this.getViewer().requestDraw()}updateVisualizedScalarRange(){if(this.updateScalarRangeUniforms(),this.legend&&this.visualizedScalarRange){const e=this.getRangeInDisplayUnits(this.visualizedScalarRange);this.legend.setVisualizedScalarRange(e)}this.getViewer().requestDraw()}updateColorMapping(e,t){this.hideMapping(e),this.showMapping(t),this.updateVisualizedScalarRange()}get displayedColorMap(){return this.visualizationState?this.visualizationState.colorMapping:(It.log.warn("No visualization state set"),W.ZIP.UNKNOWN)}hideMapping(e){const t=pc.getMapIndex(e),i=this.nodes[t];i&&i.setVisible(!1)}showMapping(e){const t=pc.getMapIndex(e),i=this.nodes[t];i&&i.setVisible(!0),this.legend&&this.legend.setActiveColorMapping(e),this.showLegend()}showLegend(){this.legend&&this.readyToShowLegend()&&this.legend.isHidden&&(this.keepLegendHiddenAndAllowControls||this.legend.show(),this.getViewer().getEventDispatcher().trigger(this.LEGEND_OPENED,this.displayedColorMap))}hideLegend(){this.legend&&(this.legend.hide(),this.getViewer().getEventDispatcher().trigger(this.LEGEND_CLOSED))}setKeepLegendHiddenAndAllowControls(e){this.keepLegendHiddenAndAllowControls=e,this.keepLegendHiddenAndAllowControls&&this.legend&&this.legend.hide()}get visualizedScalarRange(){return this.visualizationState?this.visualizationState.visualizedRange:(It.log.debug("Visualization state undefined when trying to get visualized range"),null)}resetScenegraphNodes(){if(this.rootNode){for(let e=0;e<this.nodes.length;++e)this.nodes[e].remove();this.nodes=[];for(let e=0;e<pc.imageMaps.length;++e){const t=new ts(this.VISUALIZATION_MANAGER_NODE_ID+"."+e,{isPickable:!1,clippedBySectionPlanes:!0});t.setVisible(!1),this.nodes.push(t),this.rootNode.addChild(t)}}}getViewer(){return this.modelViewManager.getViewer()}readyToShowLegend(){return!1}createMaterialForTexture(e){const t=new ki({ambientTexture:e});return t.shaderId="scalarVisualization",t}prepareResources(){if(0===this.scalarVisualizationMaterials.length&&this.getViewer().getGlContext())for(let e=0;e<pc.imageMaps.length;++e){const t=new co(this.getViewer().getGlContext());t.imageSource=pc.imageMaps[e].source;const i=new uo(this.getViewer(),t);i.setHasTransparency(!1),this.getViewer().getResources().scalarVisualizationTextures.set(pc.imageMaps[e].type,i);const s=this.createMaterialForTexture(i);s.setCustomFloatUniform("uOffsetFactor",0),s.setCustomIntUniform("uMakeUnsigned",0),this.scalarVisualizationMaterials.push(s)}if(!this.rootNode){const e=this.modelViewManager.getSharedBodyNode();this.rootNode=e.getChildById(this.VISUALIZATION_MANAGER_NODE_ID),this.rootNode||(this.rootNode=new ts(this.VISUALIZATION_MANAGER_NODE_ID),e.addChild(this.rootNode))}}getCursorValue(e,t){var i,s,n;const r=W.YFv.fromArray([e,(null===(s=null===(i=this.getViewer())||void 0===i?void 0:i.getCamera())||void 0===s?void 0:s.getViewportHeight())-t]);return(null===(n=this.legend)||void 0===n?void 0:n.isBeingDragged)||!this.getRangeInData()?null:this.legend&&this.legend.areCoordinatesOverLegend(r)&&this.visualizedScalarRange?this.legend.getValueFromCoordinatesInVisualizedRange(r):this.findScalarVisualizationScalar(e,t)}getCursorText(e,t){var i;if((null===(i=this.legend)||void 0===i?void 0:i.isBeingDragged)||!this.getRangeInData())return null;{const i=this.getCursorValue(e,t);if(null===i)return;return this.getValueString(i)}}findScalarVisualizationScalar(e,t){const i=this.getViewer().findScalarVisualizationScalar(this.VISUALIZATION_MANAGER_NODE_ID,this.getRangeInDisplayUnits(this.getRangeInData()),e,t);return 0===i.length?null:i[0].scalar}getValueString(e){const t=(0,Ir.vx)().getLengthUnitsDisplayPrecision(),i=gc.l.ScalarVisualization,s=1/Math.pow(10,bi.W.SCALAR_VISUALIZATION_MAX_DECIMAL_PRECISION);return gc.c.getNumberString(e,t,i,s)}isNodeForBodyVisualization(e){return 0===e.getId().indexOf(this.VISUALIZATION_MANAGER_NODE_ID)}getStoredColorMapping(){const e=localStorage.getItem(this.COLOR_MAP_STORAGE_KEY);return e?+e:this.DEFAULT_COLOR_MAPPING}getSampleMesh(e,t){return t.refinementHistory.history.length>0?this.webAssemblyUtils&&this.webAssemblyUtils.isReady?this.webAssemblyUtils.replaySampleMeshRefinementRoutine(e.sampleMesh,t.refinementHistory):(It.log.debug("Received refinement history for simulation data, but sampling utils module was not available"),e.sampleMesh):e.sampleMesh}}pc.SCALAR_INPUT_MAXIMUM_UNIFORM="uScalarInputMax",pc.SCALAR_INPUT_MAGNITUDE_INVERSE_UNIFORM="uScalarInputMagnitudeInverse",pc.SCALAR_OUTPUT_MAXIMUM_UNIFORM="uScalarOutputMax",pc.SCALAR_OUTPUT_MAGNITUDE_UNIFORM="uScalarOutputMagnitude",pc.SCALAR_OUTPUT_MAGNITUDE_INVERSE_UNIFORM="uScalarOutputMagnitudeInverse",pc.USE_MIN_VALUE_UNIFORM="uUseMinColor",pc.USE_MAX_VALUE_UNIFORM="uUseMaxColor",pc.USE_DIM_COLOR_UNIFORM="uUseDimColor",pc.MIN_COLOR_UNIFORM="uMinColor",pc.MAX_COLOR_UNIFORM="uMaxColor",pc.DIM_COLOR_UNIFORM="uDimColor",pc.HIGHLIGHT_REGION_BLEND_DISTANCE="uHighlightRegionBlendDistance",pc.HIGHLIGHT_REGION_BLEND_INVERSE_DISTANCE="uHighlightRegionBlendDistanceInverse",pc.MIN_COLOR_CONSTANT="SCALAR_MIN_COLOR_",pc.MAX_COLOR_CONSTANT="SCALAR_MAX_COLOR_",pc.DIM_COLOR_CONSTANT="SCALAR_DIM_COLOR_",pc.BLEND_WIDTH_CONSTANT="SCALAR_HIGHLIGHT_BLEND_WIDTH",pc.imageMaps=[{type:W.ZIP.VIRIDIS,source:"/images/scalar-visualization-gradient-viridis.png"},{type:W.ZIP.BLUE_RED,source:"/images/scalar-visualization-gradient.png"},{type:W.ZIP.RAINBOW,source:"/images/scalar-visualization-gradient-rainbow.png"},{type:W.ZIP.PLASMA,source:"/images/scalar-visualization-gradient-plasma.png"}];class mc extends dc{constructor(e){super(e),this.manager=e,this.LEGEND_MAXIMUM_CLICKED=Ms.fdd,this.LEGEND_MINIMUM_CLICKED=Ms.ibh,this.LEGEND_RANGE_CHANGED=Ms.JHq,this.CANVAS_CONTROLS_PANEL_ID=Ms.Wzm}get SNAPPING_MARGIN_TOP(){return q.default.getManager().getNumber("CURVATURE_ANALYSIS_TOP_TOOLBAR_HEIGHT_PX")+(0,Is.NO)(Ms.Wzm)*(0,Es.x_)()}getInputRangeValueString(e){return this.manager.getInputRangeBoundaryString(e)}isInputMaximumChanged(){const e=this.manager.getRangeInData();return!!(e&&e.max>Mc)||super.isInputMaximumChanged()}getInputRangeInDisplayUnits(){return this.manager.getRangeInDisplayUnits(this.manager.getRangeInData())}getDefaultDisplayRangeInDisplayUnits(){return this.manager.getRangeInDisplayUnits(this.manager.getDefaultDisplayRange())}}var fc=i(67628),Ic=i(55077),Ec=i(85497),Sc=i(8996);const Tc="meter",Mc=1e4,Cc="CurvatureAnalysisManager",Dc=W.ls1.getTessellationSettingIndexFromEnum(W.XiJ.CURVATURE_VISUALIZATION);class vc extends pc{constructor(e){super(e.getModelViewManagers().getManager()),this.viewer=e,this.COLOR_MAP_STORAGE_KEY=fc.xV,this.LEGEND_OPENED=Ms.A1q,this.LEGEND_CLOSED=Ms.Nwl,this.VISUALIZATION_MANAGER_NODE_ID=Cc,this.graphicsRenderMode=W.P1.SHADED_CURVATURE_VISUALIZATION,this.DEFAULT_COLOR_MAPPING=Ec.z,this.supportsInContextMode=!0,this.messageBubble=ps.Jq.MessageBubbleService.createMessageBubbleWithAutoDismiss("warning"),this.visualizedRangeCache=new Map,this.curvatureTypeCache=new Map,this.displayedScalarRangeSpecification={rangeInData:null,defaultDisplayRange:null},this.visualizationState=new W.AON,this.mainScenegraphManager=new yc(this.modelViewManager,"CurvatureAnalysis",this.scalarVisualizationMaterials),this.resetMeshes(),this.setColorMapping(this.getStoredColorMapping()),(0,VM.eR)(VM.Cr).subscribe((()=>{this.updateVisualizedScalarRange()}))}getViewer(){return this.viewer}isVisualizing(){var e;return this.mainScenegraphManager.isVisualizing()||!!(null===(e=this.previewScenegraphManager)||void 0===e?void 0:e.isVisualizing())}resetScenegraphNodes(){var e;super.resetScenegraphNodes(),this.mainScenegraphManager.resetScenegraphNodes(),null===(e=this.previewScenegraphManager)||void 0===e||e.resetScenegraphNodes()}hideMapping(e){var t;this.mainScenegraphManager.hideMapping(e),null===(t=this.previewScenegraphManager)||void 0===t||t.hideMapping(e),super.hideMapping(e)}showMapping(e){var t;this.mainScenegraphManager.showMapping(e),null===(t=this.previewScenegraphManager)||void 0===t||t.showMapping(e),super.showMapping(e)}updateGraphics(){if(this.viewerIsInScalarVisualizationRenderMode()){if(this.cursorAppendage||(this.cursorAppendage=new Ts(this.getViewer(),((e,t)=>this.getCursorText(e,t)))),this.followModeCursorAppendage||(this.followModeCursorAppendage=new Cs(this.getViewer(),((e,t)=>this.getCursorText(e,t)))),this.readyToShowLegend()){const e=this.getRangeInData(),t=this.getDefaultDisplayRange();this.legend.setInputRange({rangeInData:e,defaultDisplayRange:t})}this.showMapping(this.displayedColorMap),this.updateVisualizedScalarRange()}}getValueInBaseUnits(e){const t=(0,Ir.vx)().getLengthUnits();if(!t)return null;const i=this.getCurvatureTypeUnitPower(),s={[t]:i},n={[Tc]:i};return(0,Er.NI)(e,s,n)}getRangeInDisplayUnits(e){const t=(0,Ir.vx)().getLengthUnits();return e&&t?(0,Er.u0)(e,t,this.getCurvatureTypeUnitPower()):null}getRangeInBaseUnits(e){return(0,Er.u0)(e,Tc,this.getCurvatureTypeUnitPower())}getRangeInData(){var e,t,i,s;let n;return n=js()?null!==(t=null===(e=this.previewScenegraphManager)||void 0===e?void 0:e.getRangeInData())&&void 0!==t?t:this.mainScenegraphManager.getRangeInData():null!==(i=this.mainScenegraphManager.getRangeInData())&&void 0!==i?i:null===(s=this.previewScenegraphManager)||void 0===s?void 0:s.getRangeInData(),null==n?void 0:n.addUnits(Tc,this.getCurvatureTypeUnitPower())}getClampedRangeInData(){var e,t,i,s;let n;return n=js()?null!==(t=null===(e=this.previewScenegraphManager)||void 0===e?void 0:e.getClampedRangeInData())&&void 0!==t?t:this.mainScenegraphManager.getClampedRangeInData():null!==(i=this.mainScenegraphManager.getClampedRangeInData())&&void 0!==i?i:null===(s=this.previewScenegraphManager)||void 0===s?void 0:s.getClampedRangeInData(),null==n?void 0:n.addUnits(Tc,this.getCurvatureTypeUnitPower())}setRangeInData(e){var t;this.mainScenegraphManager.setRangeInData(e),null===(t=this.previewScenegraphManager)||void 0===t||t.setRangeInData(e)}setClampedRangeInData(e){var t;this.mainScenegraphManager.setClampedRangeInData(e),null===(t=this.previewScenegraphManager)||void 0===t||t.setClampedRangeInData(e)}readyToShowLegend(){return this.viewerIsInScalarVisualizationRenderMode()&&!!this.legend}prepareResources(){var e;super.prepareResources(),this.legend||(this.legend=new mc(this)),this.mainScenegraphManager.prepareResources(),null===(e=this.previewScenegraphManager)||void 0===e||e.prepareResources()}clearAndUpdateCurvatures(){var e,t;this.clearGraphics(),this.requestMissingCurvatureTessellations(),this.mainScenegraphManager.updateNodesWithCurvatureData(),null===(e=this.getOrCreatePreviewScenegraphManager())||void 0===e||e.updateNodesWithCurvatureData(),this.updateScalarRangeFromCurvatureData(),null===this.getRangeInData()&&(null===(t=this.legend)||void 0===t||t.clearRanges()),this.showLegend(),this.updateGraphics()}onRenderingModeChanged(){var e;super.onRenderingModeChanged(),this.viewerIsInScalarVisualizationRenderMode()&&this.modelViewManager.displayingPartStudio()?(this.getViewer().getUserEnabledAggressiveRefinement()&&this.getViewer().setUserEnabledAggressiveRefinement(!1),this.clearAndUpdateCurvatures()):((this.isVisualizing()||this.mainScenegraphManager.getDisplayedPartStudioHasPendingTessellationRequests()||(null===(e=this.previewScenegraphManager)||void 0===e?void 0:e.getDisplayedPartStudioHasPendingTessellationRequests()))&&this.getViewer().getEventDispatcher().trigger(VM.Jp),this.clearScalarVisualizationForVisualizedBodies())}onDocumentDestroyed(){this.mainScenegraphManager.clearPendingTessellationRequests(),this.destroyPreviewScenegraphManager(),this.curvatureTypeCache=new Map}onDocumentReconnect(){var e;this.mainScenegraphManager.clearPendingTessellationRequests(),null===(e=this.previewScenegraphManager)||void 0===e||e.clearPendingTessellationRequests()}onPreviewDestroyed(){this.destroyPreviewScenegraphManager(),this.readyToShowLegend()||this.hideLegend()}onEstimatedMemoryLimitExceeded(e=!1){e&&this.viewer.setRenderingMode(W.P1.SHADED_WITH_EDGES),this.messageBubble.showMessage(i18n("Color map may exceed browser memory limits. Try hiding unnecessary parts or surfaces.")),ps.Jq.AngularEventService.ensureDigest()}destroyPreviewScenegraphManager(){var e;null===(e=this.previewScenegraphManager)||void 0===e||e.resetMeshes(),this.previewScenegraphManager=null}preventChangeToRenderMode(e){var t,i,s;if(this.graphicsRenderMode!==e)return!1;if(Ys())return this.messageBubble.showMessage(i18n("Curvature color map is not currently supported while comparing.")),ps.Jq.AngularEventService.ensureDigest(),!0;if(gi._3.getOpenDocumentController().isInterferenceDetectionActive())return this.messageBubble.showMessage(i18n("Curvature color map is not currently supported during interference detection.")),ps.Jq.AngularEventService.ensureDigest(),!0;const n=null!==(t=this.mainScenegraphManager.getBodiesToVisualize())&&void 0!==t?t:new Set,r=null!==(s=null===(i=this.previewScenegraphManager)||void 0===i?void 0:i.getBodiesToVisualize())&&void 0!==s?s:new Set;return!this.getViewer().getBodyManager().checkBodiesUnderMemoryLimit(Dc,new Set([...n,...r]))&&(this.onEstimatedMemoryLimitExceeded(),!0)}onCheckInterferences(){this.graphicsRenderMode===this.getViewer().getRenderingMode()&&(ps.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Curvature color map is not currently supported during interference detection."),"warning"),ps.Jq.AngularEventService.ensureDigest(),this.getViewer().setRenderingMode(W.P1.SHADED_WITH_EDGES))}userCanEnableColorMap(){const e=gi._3.getOpenDocumentController().isInterferenceDetectionActive(),t=Ys();return!e&&!t}onPartStudioDisplayed(){this.viewerIsInScalarVisualizationRenderMode()&&this.setCurvatureType(this.getCachedCurvatureTypeForElement())}onPartStudioDisplayDataChanged(e,t){if(!e.isNoop&&this.viewerIsInScalarVisualizationRenderMode()){if(e.hasCurvatureTessellation())this.clearAndUpdateCurvatures();else{this.requestMissingCurvatureTessellations()||this.clearAndUpdateCurvatures()}this.updateFollowModeCache()}}getCachedCurvatureTypeForElement(){const e=this.getViewer().getActiveElementId(),t=this.curvatureTypeCache.get(e);return t&&t!==W.Lck.UNKNOWN?t:W.Lck.GAUSSIAN}onChangeActiveElement(){this.clearGraphics()}clearGraphics(){var e,t;this.clearScalarVisualizationForVisualizedBodies(),this.messageBubble.dismissMessage(),null===(e=this.legend)||void 0===e||e.clearRanges(),this.setRangeInData(null),this.setClampedRangeInData(null),this.setDefaultDisplayRange(null),this.resetMeshes(),null===(t=this.followModeCursorAppendage)||void 0===t||t.destroy(),this.followModeCursorAppendage=null,super.clearGraphics()}resetMeshes(){var e,t;null===(e=this.mainScenegraphManager)||void 0===e||e.resetMeshes(),null===(t=this.previewScenegraphManager)||void 0===t||t.resetMeshes()}requestMissingCurvatureTessellations(){var e,t,i,s;const n=null!==(e=this.mainScenegraphManager.getBodiesThatNeedCurvatureTessellations())&&void 0!==e?e:[],r=null!==(i=null===(t=this.getOrCreatePreviewScenegraphManager())||void 0===t?void 0:t.getBodiesThatNeedCurvatureTessellations())&&void 0!==i?i:[],a=new Set(n.concat(r));if(0===a.size)return!1;return this.requestCurvatureData(a)?(this.onEstimatedMemoryLimitExceeded(!0),!1):(this.mainScenegraphManager.didRequestCurvatureDataForBodies(n),null===(s=this.getOrCreatePreviewScenegraphManager())||void 0===s||s.didRequestCurvatureDataForBodies(r),!0)}getOrCreatePreviewScenegraphManager(){if(!this.previewScenegraphManager){const e=this.getViewer().getModelViewManagers().getPreviewManager();if(!(null==e?void 0:e.getDisplayedPartStudio()))return null;this.previewScenegraphManager=new yc(e,"CurvatureAnalysisPreview",this.scalarVisualizationMaterials),this.previewScenegraphManager.prepareResources(),this.previewScenegraphManager.setCurvatureType(this.getCurvatureType())}return this.previewScenegraphManager}clearScalarVisualizationForVisualizedBodies(){var e,t,i;null===(e=this.mainScenegraphManager.getBodyComponent())||void 0===e||e.clearAllScalarVisualizationOccurrences(),null===(i=null===(t=this.previewScenegraphManager)||void 0===t?void 0:t.getBodyComponent())||void 0===i||i.clearAllScalarVisualizationOccurrences()}requestCurvatureData(e){if(!e||0===e.size)return!1;const t=[];if(!this.viewer.getBodyManager().checkBodiesUnderMemoryLimit(Dc,e))return!0;for(const i of e){const e=new W.A$B;e.bodyDeterministicId=i,e.tessellationSetting=Dc,t.push(e)}return this.getViewer().getEventDispatcher().trigger(VM.am,t),!1}setVisualizedScaleComponent(e,t){super.setVisualizedScaleComponent(e,t),this.updateVisualizedRangeCache()}getCurvatureTypeUnitPower(){switch(this.getCurvatureType()){case W.Lck.GAUSSIAN:return-2;case W.Lck.MEAN:return-1;case W.Lck.MAX_RADIUS:case W.Lck.MIN_RADIUS:default:return 1}}getBaseUnitsRange(e,t){return W.dGY.fromMinMax(e,t,Tc,this.getCurvatureTypeUnitPower())}updateScalarRangeFromCurvatureData(){const e=this.getCachedRange(),t=this.getClampedRangeInData();this.updateDefaultDisplayRange(t);const i=this.getRangeInData(),s=this.getValueInBaseUnits(1);if(i&&0===i.magnitude){let e;e=this.isInCurvatureRadiusMode()&&i.mean>Mc?this.getBaseUnitsRange(0,s):this.isInCurvatureRadiusMode()&&i.mean<s?this.getBaseUnitsRange(0,2*i.mean):this.getBaseUnitsRange(i.mean-s,i.mean+s),this.updateDefaultDisplayRange(e)}e?this.setVisualizedRange(e):this.setVisualizedRange(this.getDefaultDisplayRange())}resetScalarRange(e){const t=this.getDefaultDisplayRange(),i=this.visualizedScalarRange.clone();switch(e){case Vh.s.MAX:const e=this.isInCurvatureRadiusMode()?Math.min(t.max,Mc):t.max;i.max=e;break;case Vh.s.MIN:i.min=t.min}this.setVisualizedRange(i),this.updateVisualizedRangeCache()}setCurvatureType(e){if(this.getCurvatureType()===e)return;const t=this.getVisualizationState().clone();t.curvatureType=e,this.setVisualizationState(t)}updateCurvatureType(e){var t;this.mainScenegraphManager.setCurvatureType(e),null===(t=this.previewScenegraphManager)||void 0===t||t.setCurvatureType(e),this.clearAndUpdateCurvatures();const i=this.getViewer().getActiveElementId();this.curvatureTypeCache.set(i,e)}getCurvatureType(){return this.visualizationState.curvatureType}moveLegendTo(e,t){var i;if(!e||e.some((e=>!isFinite(e)))||!this.legend)return;(null===(i=this.legend.colorMapCorners)||void 0===i?void 0:i.bottomLeft)||this.legend.setupCorners();const s=(0,Es.x_)(),n=e.map((e=>e*s));this.legend.setIsVertical(t);const r=this.legend.colorMapCorners.topRight.y-this.getViewer().getCamera().getCanvasHeight()+n[1],a=this.legend.colorMapCorners.bottomLeft.x-n[0],o=W.YFv.fromXY(a,r);o.isZeroVector()||this.legend.moveLegend(o,void 0,!0)}getLegend(){return this.legend}getLegendMovedObservable(){return this.prepareResources(),this.legend.getLegendMovedObservable()}isInCurvatureRadiusMode(){return this.getCurvatureType()===W.Lck.MAX_RADIUS||this.getCurvatureType()===W.Lck.MIN_RADIUS}onReceiveFollowModeMessage(e){if(!e||!e.visualizationState||!this.followViewDataMessageCache)return;this.setCurvatureType(e.visualizationState.curvatureType);const t=e.legendTopLeftCoordinates.slice(),i=Sc.D.convertCanvasCoordinateLeaderToFollower(t,this.followViewDataMessageCache);this.moveLegendTo(i,e.legendIsVertical),this.shouldUpdateVisualizationStateFromMessage(e)?this.updateVisualizationStateFromMessage(e):this.followModeMessageCache=e}onReceiveFollowViewDataMessage(e){this.followViewDataMessageCache=e}shouldUpdateVisualizationStateFromMessage(e){var t;return e&&(null===(t=this.getRangeInData())||void 0===t?void 0:t.equals(e.rangeInData,bi.W.ZERO_LENGTH))}updateVisualizationStateFromMessage(e){var t;const i=e.visualizationState;(null===(t=i.visualizedRange)||void 0===t?void 0:t.noRange)||(this.setVisualizationState(i),this.updateVisualizedRangeCache())}updateFollowModeCache(){this.followModeMessageCache&&((0,Js.sW)()?this.shouldUpdateVisualizationStateFromMessage(this.followModeMessageCache)&&(this.updateVisualizationStateFromMessage(this.followModeMessageCache),this.followModeMessageCache=null):this.followModeMessageCache=null)}setVisualizationState(e){const t=this.getCurvatureType()!==e.curvatureType;super.setVisualizationState(e),t&&this.updateCurvatureType(e.curvatureType)}getCursorText(e,t){var i;if((null===(i=this.legend)||void 0===i?void 0:i.isBeingDragged)||!this.getRangeInData())return null;{const i=this.getCursorValue(e,t);if(!(0,Ic.isNumber)(i))return;if(this.isInCurvatureRadiusMode()&&this.getValueInBaseUnits(i)>Mc)return"♾️";const s=(0,Ir.vx)().getLengthUnitsDisplayPrecision(),n=gc.l.UserWorkspace,r=1/Math.pow(10,s);return gc.c.getNumberString(i,s,n,r)}}getInputRangeBoundaryString(e){const t=this.getRangeInData(),i=t.getValueFromRangeComponent(e);if(this.isInCurvatureRadiusMode()&&i>Mc)return"♾️";const s=this.getRangeInDisplayUnits(t).getValueFromRangeComponent(e);return this.getValueString(s)}updateVisualizedRangeCache(){const e=this.getViewer().getActiveElementId();if(!this.visualizedScalarRange||0===e.length)return;let t,i=this.visualizedRangeCache.get(e);i||(i=new Map),t=this.visualizedScalarRange.equals(this.getDefaultDisplayRange())?null:this.visualizedScalarRange,i.set(this.getCurvatureType(),t),this.visualizedRangeCache.set(e,i)}getCachedRange(){var e;const t=this.getViewer().getActiveElementId(),i=this.visualizedRangeCache.get(t);return i&&null!==(e=i.get(this.getCurvatureType()))&&void 0!==e?e:null}}const Pc=new Float32Array(2);class yc{constructor(e,t,i){this.modelViewManager=e,this.parentNodeId=t,this.scalarVisualizationMaterials=i,this.nodes=[],this.VISUALIZATION_MANAGER_NODE_ID=Cc,this.meshOwnerId=WS(),this.bodyIdsWithPendingTessellationRequest=new Map,this.resetMeshes()}isVisualizing(){var e;return!!(null===(e=this.getBodyComponent())||void 0===e?void 0:e.isVisualizingOccurrences())}getViewer(){return this.modelViewManager.getViewer()}getBodyComponent(){var e;return null===(e=this.getDisplayedPartStudio())||void 0===e?void 0:e.getBodyComponent()}getDisplayedPartStudio(){return this.modelViewManager.getDisplayedPartStudio()}setCurvatureType(e){this.curvatureType=e}getCurvatureType(){return this.curvatureType}setBodyHasPendingTessellationRequest(e,t){var i;if(!t)return;const s=null!==(i=this.bodyIdsWithPendingTessellationRequest.get(t))&&void 0!==i?i:new Set;s.add(e),this.bodyIdsWithPendingTessellationRequest.set(t,s)}unsetBodyHasPendingTessellationRequest(e,t){const i=this.bodyIdsWithPendingTessellationRequest.get(t);i&&(i.delete(e),this.bodyIdsWithPendingTessellationRequest.set(t,i))}getBodyHasPendingTessellationRequest(e,t){const i=this.bodyIdsWithPendingTessellationRequest.get(t);return i&&i.has(e)}getDisplayedPartStudioHasPendingTessellationRequests(){var e;const t=null===(e=this.getDisplayedPartStudio())||void 0===e?void 0:e.getElementId();if(!t)return!1;const i=this.bodyIdsWithPendingTessellationRequest.get(t);return i&&i.size>0}clearPendingTessellationRequests(){this.bodyIdsWithPendingTessellationRequest=new Map}prepareResources(){if(!this.rootNode){const e=this.modelViewManager.getSharedBodyNode();this.rootNode=e.getChildById(this.VISUALIZATION_MANAGER_NODE_ID),this.rootNode||(this.rootNode=new ts(this.VISUALIZATION_MANAGER_NODE_ID),e.addChild(this.rootNode))}if(this.resetScenegraphNodes(),!this.nodePropertiesSolids||0===this.nodePropertiesSolids.length||!this.nodePropertiesSurfaces||0===this.nodePropertiesSurfaces.length){this.nodePropertiesSolids=[],this.nodePropertiesSurfaces=[];for(let e=0;e<vc.imageMaps.length;++e){const t=this.scalarVisualizationMaterials[e];t.ambientTextureFactor=0;const i=new Qi({material:t,zOffset:q.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:_i.MX.TRIANGLES,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1,isTwoSided:!1});this.nodePropertiesSolids.push(i);const s={zOffset:q.default.getManager().getNumber("SURFACE_Z_OFFSET"),isTwoSided:!0},n=i.cloneAndModify(s);this.nodePropertiesSurfaces.push(n)}}}resetScenegraphNodes(){if(this.rootNode){for(let e=0;e<this.nodes.length;++e)this.nodes[e].remove();this.nodes=[];for(let e=0;e<pc.imageMaps.length;++e){const t=new ts(this.VISUALIZATION_MANAGER_NODE_ID+"."+e,{isPickable:!1,clippedBySectionPlanes:!0});t.setVisible(!1),this.nodes.push(t),this.rootNode.addChild(t)}}}hideMapping(e){const t=pc.getMapIndex(e),i=this.nodes[t];i&&i.setVisible(!1)}showMapping(e){const t=pc.getMapIndex(e),i=this.nodes[t];i&&i.setVisible(!0)}resetMeshes(){this.meshManager&&this.meshManager.destroy(),this.meshManager=new zS(this.getViewer(),{bufferAllocationPolicy:CI.MAXIMUM})}updateNodesWithCurvatureData(){const e=this.getBodyComponent();if(!e)return;const t=new mh.B7(`CurvatureAnalysisManager.updateNodesWithCurvatureData - Usage: ${this.modelViewManager.usage}`);this.resetMeshes();const i=this.getDisplayedPartStudio().getElementId();for(const t of this.getBodiesWithCurvatureTessellations()){const s=e.bodyMetaData[t],n=e.getBodyOccurrenceData(t);if(!this.shouldVisualizeBody(s,n))continue;const r=s.isClosedCompositeConstituent?s.closedCompositeParentId:t;this.unsetBodyHasPendingTessellationRequest(r,i);const a=new BS(this.parentNodeId+" "+n.getOccurrenceId()),o=this.getPartStudioFaceEntityIdsForBody(s);for(const e of o){const t=this.getMeshIncrementWithScalars(e),i=this.meshManager.addMeshIncrement(t,this.meshOwnerId);a.onIncrementAdded(i)}const h=new fE;h.setAttribute(Jd.COLOR,s.getColor());const c=s.containsOnlySheetBodies()?this.nodePropertiesSurfaces:this.nodePropertiesSolids;for(let e=0;e<c.length&&e<this.nodes.length;++e)this.nodes[e].addOccurrenceGeometryToNode(c[e],n,h,a);e.setScalarVisualizationOccurrence(n.getOccurrenceId(),s.getId())}t.report()}getBodiesThatNeedCurvatureTessellations(){const e=this.getBodyComponent();if(!e)return;const t=new Set;for(const i of this.getBodiesToVisualize()){const s=e.retrieveBodyMetaData(i),n=e=>e===Dc;if(!s||s.tessellationSettings.findIndex(n)>-1)continue;const r=s.isClosedCompositeConstituent?s.closedCompositeParentId:i,a=this.getDisplayedPartStudio().getElementId();this.getBodyHasPendingTessellationRequest(r,a)||t.add(r)}return[...t]}shouldVisualizeBody(e,t){return((null==e?void 0:e.isSolidBody())||(null==e?void 0:e.isSheetBody())||(null==e?void 0:e.isClosedComposite)&&!(null==e?void 0:e.containsOnlyWireBodies()))&&(null==t?void 0:t.getVisibility())===Js.EE.VISIBLE}getBodiesToVisualize(){const e=this.getBodyComponent();if(!e)return;const t=new Set;for(const i of e.getBodyIds()){const s=e.retrieveBodyMetaData(i),n=e.getBodyOccurrenceData(i);this.shouldVisualizeBody(s,n)&&t.add(i)}return t}getBodiesWithCurvatureTessellations(){var e,t;const i=e=>e===Dc;return null!==(t=null===(e=this.getBodyComponent())||void 0===e?void 0:e.getBodyIds((e=>e.tessellationSettings.findIndex(i)>-1)))&&void 0!==t?t:[]}getPartStudioFaceEntityIdsForBody(e){const t=this.getDisplayedPartStudio();if(!t)return[];const i=e.isClosedComposite?e.constituentBodyIds:[e.getId()],s=[];for(const e of i){const i=t.getEntitiesForBody(e,(e=>e.isFace()));s.push(...i)}return s}getFaceEntityMetadata(e){var t;const i=null===(t=this.getDisplayedPartStudio())||void 0===t?void 0:t.retrieveEntityMetaData(e);return i&&i.isFace()?i:null}getMeshIncrementWithScalars(e){const t=this.getFaceEntityMetadata(e),i=t.getGeometry();if(!i)return It.log.debug(`Tried to get mesh increment with curvature data for entityId="${e}" but entity was not a BTEntityFace`),null;const s=t.getMeshIncrement().clone();if(i.hasValidCurvatureData()&&!i.isPlanarFace()){const e=this.getIncrementCurvatures(i.maxPrincipleCurvatureMagnitudes,i.minPrincipleCurvatureMagnitudes);s.packScalarsIntoTextureCoordinates(e),this.updateRanges(e)}else i.isPlanarFace()&&s.replicateTextureCoordinate(Pc);return s}updateRanges(e){const t=W.dGY.fromMinMax(1/0,-1/0),i=W.dGY.fromMinMax(1/0,-1/0);for(const s of e){s<t.min&&(t.min=s),s>t.max&&(t.max=s);const e=Math.min(s,Mc);e<i.min&&(i.min=e),e>i.max&&(i.max=e)}const s=W.dGY.combine(this.getRangeInData(),t);this.setRangeInData(s);const n=W.dGY.combine(this.getClampedRangeInData(),i);this.setClampedRangeInData(n)}setRangeInData(e){this.rangeInData=e}setClampedRangeInData(e){this.clampedRangeInData=e}getRangeInData(){return this.rangeInData}getClampedRangeInData(){return this.clampedRangeInData}getIncrementCurvatures(e,t){if(!e||!t)return void It.log.warn("The passed arrays of principle curvatures were not defined");const i=e=>(0,Ic.clamp)(1/e,-1/0,Mc+1);switch(this.getCurvatureType()){case W.Lck.MIN_RADIUS:{const s=(e,t)=>Math.max(Math.abs(e),Math.abs(t)),n=(e,t)=>i(s(e,t));return(0,Ic.zipWith)(e,t,n)}case W.Lck.MAX_RADIUS:{const s=(e,t)=>Math.min(Math.abs(e),Math.abs(t)),n=(e,t)=>i(s(e,t));return(0,Ic.zipWith)(e,t,n)}case W.Lck.MEAN:{const i=(e,t)=>(e+t)/2;return(0,Ic.zipWith)(e,t,i)}case W.Lck.GAUSSIAN:default:const s=(e,t)=>e*t;return(0,Ic.zipWith)(e,t,s)}}didRequestCurvatureDataForBodies(e){var t;for(const i of e)this.setBodyHasPendingTessellationRequest(i,null===(t=this.getDisplayedPartStudio())||void 0===t?void 0:t.getElementId())}}const Ac=new Qi({isShowThrough:!0,isDepthTested:!1,isStencilTested:!0,isPickable:!1,priority:Yi.LOWER,primitiveType:_i.MX.LINES}),Oc=new Qi({isPickable:!1,primitiveType:_i.MX.LINES}),Rc=q.default.getManager();class wc extends Ri{constructor(e,t,i){if(super((0,Q.as)(fT,e)),this.handleRoot=null,this.handleHead=null,t){const e=t.geometry,s=e.interpolationPoints.length;i?(this.handleRoot=[e.interpolationPoints[0],e.interpolationPoints[1]],this.handleHead=[e.startHandleX,e.startHandleY]):(this.handleRoot=[e.interpolationPoints[s-2],e.interpolationPoints[s-1]],this.handleHead=[e.endHandleX,e.endHandleY])}this.updateLines()}updateEndpoints(e,t){this.handleRoot=t,this.handleHead=e,this.updateLines()}updateLines(){if(!this.handleRoot||!this.handleHead)return;const e=this.viewer.getSketch();if(!e)return;const t=Iu([e.planeToWorld(this.handleRoot),e.planeToWorld(this.handleHead)]);Hu(Rc.getNumber("SPLINE_HANDLE_LINE_WIDTH"),t),Uu(Rc.getColor("SPLINE_HANDLE_COLOR"),t),this.updateMeshIncrement("lines",yi,t,Ac),this.updateMeshIncrement("dp.lines",yi,t.clone(),Oc)}}const _c=q.default.getManager(),Nc=new Qi({zOffset:_c.getNumber("ORIGIN_Z_OFFSET"),primitiveType:_i.MX.POINTS,isShowThrough:!0,isDepthTested:!1});var bc;!function(e){e.POINT="point"}(bc||(bc={}));class Lc extends Ri{constructor(e,t){super(t),this.definition=e,this.lastScale=-1,this.worldSpacePosition=[0,0,0],this.id="AssemblyOriginElement",this.occurrenceTransform=ge.create(),this.updateHideState()}onAppearanceConstantsUpdated(){this.updateGraphics()}setOccurrenceTransform(e){this.occurrenceTransform=e,this.damageTransform()}updateDefinition(e){this.definition=e,this.updateHideState(),this.damageTransform()}damageTransform(){if(this.lastScale=-1,this.definition){const e=[0,0,0];pe.w$.multiplyVec3(this.occurrenceTransform,e,this.worldSpacePosition)}(0,Js.vm)()}getUserVisibilitySetting(){return this.definition.hidden?Js.EE.HIDDEN:Js.EE.VISIBLE}updateHideState(){this.isHighlighted()||this.getUserVisibilitySetting()!==Js.EE.HIDDEN?(this.hasMeshIncrements()||this.updateGraphics(!0),this.show()):this.hide()}getBounds(){if(this.isVisibleToUser()){const e=new Li.kB;return e.addPoint(this.worldSpacePosition),e}return null}onViewWillDraw(e){this.adjustTransform(e)}adjustTransform(e){if(!this.definition||this.isHidden)return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition);if(Math.abs(this.lastScale-t)<bi.W.ZERO_LENGTH)return;this.lastScale=t;const i=ge.create();i[0]=t,i[5]=t,i[10]=t,this.setTransform(pe.w$.multiply(this.occurrenceTransform,i,ge.create())),this.hasMeshIncrements()||this.updateGraphics()}updateGraphics(e){if(!this.definition||this.isHidden&&!e)return void this.removeMeshIncrements();const t=Su([0,0,0],"point",_c.getColor("ORIGIN_COLOR"),_c.getNumber("ORIGIN_SIZE"));ku(_c.getPointFont("ORIGIN_FONT"),t),this.updateMeshIncrement(bc.POINT,yi,t,Nc)}getOccurrence(){return null}getModelSelection(e){if(!this.definition)return null;const t=new W._oC,i=new ve.Y1(W.lQt.FEATURE,W.AuL.ORIGIN_ID,t,{sourcePick:e.sourcePick});return i.setFeatureType(mi._.ASSEMBLY_ORIGIN),i}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.addHighlightToIncrement(bc.POINT,e)}removeHighlight(e){return this.removeHighlightFromIncrement(bc.POINT,e),!!super.removeHighlight(e)&&(this.updateHideState(),!0)}}var Fc=i(85822);const xc="pbm",Bc="tbm",Uc="nbm";class Vc{constructor(e,t,i,s,n,r){this.bodyOccurrence=e,this.requestSource=t,this.occurrence=i,this.tessellationSettingDesired=s,this.tessellationSettingRequested=n,this.viewportError=r}}var Gc;!function(e){e[e.DISABLED=0]="DISABLED",e[e.CONDITIONAL=1]="CONDITIONAL",e[e.ALWAYS=2]="ALWAYS"}(Gc||(Gc={}));let Hc=Gc.CONDITIONAL;function kc(e){Hc=e}const Wc=-1;var zc;!function(e){e[e.SELECTION=0]="SELECTION",e[e.HOVER=1]="HOVER",e[e.VIEWING=2]="VIEWING"}(zc||(zc={}));const Xc=q.default.getManager().getNumber("UNLOADED_BODY_OPACITY_FACTOR");function qc(){return!!localStorage.getItem("osBodyRetrievalDebuggingEnabled")}function Zc(e){return(e/1024/1024).toFixed(0)+" MB"}const Yc=[0];class Kc{constructor(e,t){this.partStudio=e,this.bodyMetaData=t,this.radius=this.getBodyMetaDataForRetrieval().getBounds().diameter()/2}getBodyMetaDataForRetrieval(){return this.bodyMetaData.isClosedCompositeConstituent?this.bodyMetaData.consumingClosedCompositeData:this.bodyMetaData}getBenefitToUnload(){return this.getBodyMetaDataForRetrieval().getEstimatedMemoryUsage()/(this.radius*this.radius)}isBodyDataPresent(){return this.getBodyMetaDataForRetrieval().hasTessellationSettings()}isInstantiated(){return!1}getLastViewTime(){return 0}getLastViewportOccupancy(){return 0}getUnloadedChordalTolerance(){return this.getBodyMetaDataForRetrieval().getBounds().diameter()}getCenter(){return null}}const jc=v.create(),Qc=P.create(),$c=ge.create();class Jc{constructor(e,t,i){this.occurrenceData=e,this.bodyMetaData=t,this.pickId=i,this.center=[0,0,0],this.radius=0,this.lod=null,this.displayDamaged=!0,this.incrementDetails=null,this.highlightApplied=null,this.retrievalRequestState=Wc,this.update(e,t)}update(e,t){this.occurrenceData=e,this.bodyMetaData=t;const i=Qc;t.getBounds().center(i),i[3]=1,pe.w$.multiplyVec4(e.getTransform(),i),this.center[0]=i[0],this.center[1]=i[1],this.center[2]=i[2],this.radius=t.getBounds().diameter()/2,this.displayDamaged=!0}getBodyMetaData(){return this.bodyMetaData}getBodyMetaDataForRetrieval(){return this.bodyMetaData.isClosedCompositeConstituent?this.bodyMetaData.consumingClosedCompositeData:this.bodyMetaData}getOccurrenceData(){return this.occurrenceData}getOccurrenceId(){return this.occurrenceData.getOccurrenceId()}getCenter(){return this.center}getRadius(){return this.radius}getUnloadedChordalTolerance(){return 2*this.radius}getBenefitToCull(){return this.bodyMetaData.coarseTriangleCount/(this.radius*this.radius)}getBenefitToUnload(){return this.getBodyMetaDataForRetrieval().getEstimatedMemoryUsage()/(this.radius*this.radius)}getBenefitToLoad(){return this.isBodyDataPresent()?0:this.radius*this.radius/this.getBodyMetaDataForRetrieval().getEstimatedMemoryUsage(Yc)}getBenefitToRefine(e,t){return t/this.getBodyMetaDataForRetrieval().getEstimatedMemoryUsage([e])}isInstantiated(){return!0}setCullingState(e){if(this.numberOfBodiesInOccurrence>1){const t=Hp.getPotentialMeshGroupIdsForBody(this.bodyMetaData.meshGroupId);for(let i=0;i<t.length;++i)this.occurrenceData.setCullingState(e,t[i])}else this.occurrenceData.setCullingState(e)}isEntityTessellationLoaded(){return this.getBodyMetaDataForRetrieval().getIsTessellationLoaded()}canBeRefinedFurther(e){const t=this.getBodyMetaDataForRetrieval().getFinestTessellationSettingOnClient();return null===t||t<this.getBodyMetaDataForRetrieval().getBestAvailableTessellationSettingIndex(e)}setLod(e){this.isEntityTessellationLoaded()||(e=eg.LOWEST),this.occurrenceData.setLod(e)}outsideFrustum(e){return e.viewFrustum.getSphereFrustumIntersection(this.center,this.radius)===dr.I.OUTSIDE}intersectsFrustum(e){return!!e&&e.getSphereFrustumIntersection(this.center,this.radius)!==dr.I.OUTSIDE}isVisible(){return this.occurrenceData.getVisibility()===Js.EE.VISIBLE}mustShowLowestLod(e){return!this.isEntityTessellationLoaded()&&(this.isVisible()||this.occurrenceData.hasHighlight()||!!e&&e.getIsPickingHiddenOccurrences())}lodIsUpToDate(){return this.mustShowLowestLod()?!this.displayDamaged&&this.lod===eg.LOWEST:this.lod!==eg.LOWEST}isBodyDataPresent(){return this.getBodyMetaDataForRetrieval().hasTessellationSettings()}resetRetrievalRequestState(){this.retrievalRequestState=Wc}setBodyRetrievalStarted(e){this.retrievalRequestState=e}isRetrievalRequestDataPresent(){if(!this.getBodyRetrievalStarted())return!1;const e=this.getBodyMetaDataForRetrieval();return e.hasTessellationSettings()&&e.getFinestTessellationSettingOnClient()>=this.retrievalRequestState}getBodyRetrievalStarted(){return this.retrievalRequestState>=0}canCullBody(e){return this.occurrenceData.getVisibility()===Js.EE.VISIBLE&&!this.occurrenceData.getIsolated()&&!this.intersectsFrustum(e)}getDisplayId(){return this.occurrenceData.getOccurrenceId()+"."+this.bodyMetaData.id}addBounds(e){e.addBox(this.bodyMetaData.getBounds(),this.occurrenceData.getTransform())}updateViewHistory(e,t){const i=this.getBodyMetaDataForRetrieval();i.getLastViewTime()!==e?(i.setLastViewTime(e),i.setLastViewportOccupancy(t)):i.setLastViewportOccupancy(t+i.getLastViewportOccupancy())}getLastViewTime(){return this.getBodyMetaDataForRetrieval().getLastViewTime()}getLastViewportOccupancy(){return this.getBodyMetaDataForRetrieval().getLastViewportOccupancy()}getDisplayIncrement(){const e=this.bodyMetaData.getBounds(),t=e.diagonalVector(jc),i=pe.w$.scale(ge.identity($c),t),s=e.center(jc);i[12]+=s[0],i[13]+=s[1],i[14]+=s[2],pe.w$.multiply(this.occurrenceData.getTransform(),i,i);const n=tl().createTransformed(i);n.id=this.getDisplayId(),n.pickId=this.pickId,n.lod=eg.LOWEST;let r=this.bodyMetaData.getColor();return!this.occurrenceData.getIsolated()&&(0,Ih.uQ)().getIsolatedOccurrenceManager().isInIsolateOrMakeTransparentMode()?(r=[r[0],r[1],r[2],1],n.groupId=Uc):(this.isBodyDataPresent()||(r=[r[0],r[1],r[2],r[3]*Xc]),n.groupId=r[3]<1?Bc:xc),Uu(r,n),n}}let el=null;function tl(){return el||(el=bu([-.5,-.5,-.5],[.5,.5,.5])),el}class il extends m.T{constructor(e,t){super(),this.viewer=e,this.bodyUnloadTask=t,this.DISPLAY_OCCURRENCE_NAME="BodyManager",this.DISPLAY_NON_ISOLATED_OCCURRENCE_NAME="BodyManagerNonIsolated",this.DISPLAY_BOXES_WHEN_CULLING=q.default.getManager().getNumber("DISPLAY_BOXES_WHEN_CULLING"),this.previewOccurrences=new Map,this.sortedOccurrences=null,this.occurrencesNeedSort=!0,this.unloadedBodyBounds=null,this.MAXIMUM_BODY_CULL_DIAMETER_PROPORTION=q.default.getManager().getNumber("MAXIMUM_BODY_CULL_DIAMETER_PROPORTION"),this.occurrenceRetrievalTimeout=null,this.encounteredUnloadedOccurrenceInLastFrame=!1,this.bodyRetrievalCheckTimeout=null,this.shouldUpdateBodyOccurrenceLodForIsolate=!1,this.paused=!1,this.userEnabledAggressiveRefinement=!1,this.idManager=new vI.E,this.graphicsRefinementModeSubject=new Fc.t(1),this.occurrences=new Map,this.node=new ts("bodyManager"),this.displayOccurrenceId=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.DISPLAY_OCCURRENCE_NAME),this.displayOccurrenceData=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(this.displayOccurrenceId),this.displayOccurrenceData.setLod(eg.LOWEST),this.displayOccurrenceData.setIsolated(!0),this.displayOccurrenceData.setCanIsolateChange(!1),this.displayOccurrenceIdNonIsolated=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.DISPLAY_NON_ISOLATED_OCCURRENCE_NAME),this.displayOccurrenceDataNonIsolated=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(this.displayOccurrenceIdNonIsolated),this.displayOccurrenceDataNonIsolated.setLod(eg.LOWEST),this.displayOccurrenceDataNonIsolated.setIsolated(!1),this.displayOccurrenceDataNonIsolated.setCanIsolateChange(!1),this.meshManager=new zS(this.viewer,{bufferAllocationPolicy:CI.MAXIMUM}),this.meshOwnerId=WS(),this.bodyOccurrenceToRetrievalRequest=new Map,this.occurrenceRetrievalRequests=[],this.pendingRetrievalInformation=new Map;this.viewer.getModelViewManagers().getManager().getSharedBodyNode().addChild(this.node);const i=new fE,s=this.meshManager.getOrCreateGroupRangesForGroupTypeAndLod(xc,this.meshOwnerId,_i.MX.TRIANGLE_STRIP,eg.LOWEST);this.node.addOccurrenceGeometryToNode(Ip,this.displayOccurrenceData,i,s);const n=this.meshManager.getOrCreateGroupRangesForGroupTypeAndLod(Bc,this.meshOwnerId,_i.MX.TRIANGLE_STRIP,eg.LOWEST);this.node.addOccurrenceGeometryToNode(Op,this.displayOccurrenceData,i,n);const r=this.meshManager.getOrCreateGroupRangesForGroupTypeAndLod(Uc,this.meshOwnerId,_i.MX.TRIANGLE_STRIP,eg.LOWEST);this.node.addOccurrenceGeometryToNode(Ip,this.displayOccurrenceDataNonIsolated,i,r),ps.Jq.CapabilitiesService&&ps.Jq.CapabilitiesService.isMoreAggressiveCullingEnabled&&ps.Jq.CapabilitiesService.isMoreAggressiveCullingEnabled().then((e=>{this.MAXIMUM_BODY_CULL_DIAMETER_PROPORTION=!0===e?q.default.getManager().getNumber("MORE_AGGRESSIVE_MAXIMUM_BODY_CULL_DIAMETER_PROPORTION"):q.default.getManager().getNumber("MAXIMUM_BODY_CULL_DIAMETER_PROPORTION")})),this.refinementNodeFilter=e=>{const t=this.viewer.getModelViewManagers().getManager();if(t.isNodeForModel(e)){const i=e.getParent();return!e.isMeshNode()||e.isFaces()&&(t.isNodeForBody(i)||i===this.node)}return!1},this.subscribeToSelectionList()}destroy(){this.node.remove(),this.viewer.getOccurrenceDataManager().destroyOccurrenceData(this.displayOccurrenceId),this.viewer.getOccurrenceIdManager().removeName(this.DISPLAY_OCCURRENCE_NAME),this.viewer.getOccurrenceDataManager().destroyOccurrenceData(this.displayOccurrenceIdNonIsolated),this.viewer.getOccurrenceIdManager().removeName(this.DISPLAY_NON_ISOLATED_OCCURRENCE_NAME),this.meshManager.destroy(),this.resetOccurrenceRetrieval(),this.clearBodyRetrievalCheckTimeout(),this.stopListening()}resetSelectionListHandlers(){this.stopListening(),this.subscribeToSelectionList()}subscribeToSelectionList(){const e=(0,ve.vi)();this.listenTo(e,"add",this.onSelectionChanged),this.listenTo(e,"reset",this.onSelectionChanged),this.listenTo(e,"remove",this.onSelectionChanged)}setVisible(e){this.node.setVisible(e)}resetOccurrenceRetrieval(){qc()&&It.log.info("Reset occurence retriaval"),this.clearBodyRetrievalCheckTimeout(),this.clearRetrievalTimeout(),this.bodyOccurrenceToRetrievalRequest.clear(),this.occurrenceRetrievalRequests=[],this.pendingRetrievalInformation=new Map}clearPreviewOccurrences(){this.previewOccurrences.clear()}getGraphicsRefinementModeObservable(){return this.graphicsRefinementModeSubject.asObservable()}updateGraphicsRefinementMode(){this.userEnabledAggressiveRefinement?this.graphicsRefinementModeSubject.next(Ms.Rng.AGGRESSIVE_USER_CAUSED):this.graphicsRefinementModeSubject.next(Ms.Rng.NORMAL)}get aggressiveRefinementEnabled(){return this.userEnabledAggressiveRefinement}getUserEnabledAggressiveRefinement(){return this.userEnabledAggressiveRefinement}setUserEnabledAggressiveRefinement(e){this.userEnabledAggressiveRefinement!==e&&(this.userEnabledAggressiveRefinement=e,this.onAggressiveRefinementChanged())}onAggressiveRefinementChanged(){this.aggressiveRefinementEnabled?this.performUnloadedBodyAndRefinementCheck():this.viewer.getEventDispatcher().trigger(VM.Jp),this.updateGraphicsRefinementMode()}isBodyManagerOccurrence(e){return!!e&&e.path[0]===this.DISPLAY_OCCURRENCE_NAME}pickedOccurrenceId(e){this.viewer.isHidden()||this.initiateAutomaticRetrieval()}onSelectionChanged(){this.viewer.isHidden()||this.initiateAutomaticRetrieval()}getBtOccurrence(e){const t=this.viewer.getOccurrenceIdManager().getNameForId(e.getOccurrenceId());return!t||t.startsWith(Hp.PART_STUDIO_BODY_OCCURRENCE_PREFIX)?null:W._oC.getOccurrenceFromPathString(t)}checkBodiesUnderMemoryLimit(e,t){const i=this.viewer.getModelViewManagers().getManager().getBodyRefinementMemoryLimit();let s=0;for(const n of this.occurrences.values()){const r=n.getBodyMetaData();if(!t||t.has(r.id)?s+=r.getEstimatedMemoryUsage([e]):s+=r.getEstimatedMemoryUsage(),s>=i)return!1}return!0}clearRetrievalTimeout(){(0,Jr.Z)(this.occurrenceRetrievalTimeout)&&(window.clearTimeout(this.occurrenceRetrievalTimeout),this.occurrenceRetrievalTimeout=null)}startRetrievalTimeout(){this.clearRetrievalTimeout();const e=this.aggressiveRefinementEnabled?q.default.getManager().getNumber("AGGRESSIVE_OCCURRENCE_RETRIEVAL_INTERVAL_MS"):q.default.getManager().getNumber("OCCURRENCE_RETRIEVAL_INTERVAL_MS");this.occurrenceRetrievalTimeout=window.setTimeout((()=>this.onRetrievalTimeout()),e)}onRetrievalTimeout(){if(this.clearRetrievalTimeout(),this.paused)return void It.log.info("Skipped body retrieval timeout due to pause");const e=this.viewer.getModelViewManagers().getManager();if(!this.aggressiveRefinementEnabled&&this.viewer.getFrameTimer().userIsInteracting())return void this.startRetrievalTimeout();const t=[];let i=!1;const s=q.default.getManager(),n=1024*s.getNumber("BODY_REFINEMENT_BATCH_SIZE_MB")*1024,r=1024*s.getNumber("PENDING_BODY_REFINEMENT_SIZE_LIMIT_MB")*1024;let a=0;const o=qc(),h=[],c=this.getEstimatedMemoryUsageOfPendingRetrievals();if(o){const t=e.getEstimatedMemoryUsageOfBodies();It.log.info("Estimated memory use of all bodies: "+Zc(t)+" pending:"+Zc(c))}for(const s of this.occurrenceRetrievalRequests){const l=s.bodyOccurrence.getBodyMetaDataForRetrieval();if(this.pendingRetrievalInformation.has(l)){i=!0;continue}let u=l.getFinestTessellationSettingOnClient();if(null===u&&(u=-1),u>=s.tessellationSettingRequested)continue;i=!0;let d=0,g=-1;if(this.aggressiveRefinementEnabled?(g=s.tessellationSettingRequested,d=l.getEstimatedMemoryUsage([g])):(i=!0,g=u+1,d=l.getEstimatedMemoryUsage([g])),(0===a||a+d<n)&&(0===this.pendingRetrievalInformation.size||c+a+d<r)){a+=d,this.pendingRetrievalInformation.set(l,{estimatedAdditionalMemoryUsage:d,tessellationSetting:g});const i=new W.A$B;if(i.bodyDeterministicId=l.getId(),s.occurrence){i.occurrence=s.occurrence;const t=e.getOccurrenceDisplayData(s.occurrence);t&&(i.elementId=t.elementId,i.microversionIdAndConfiguration=t.fullElementId.microversionIdAndConfiguration)}else i.occurrence=null;i.tessellationSetting=g,s.bodyOccurrence.setBodyRetrievalStarted(i.tessellationSetting),qc()&&(s.occurrence?(0,ve.iH)().add(new ve.Y1(W.lQt.OCCURRENCE,s.occurrence,s.occurrence)):(0,ve.iH)().add(new ve.Y1(W.lQt.BODY,s.bodyOccurrence.getBodyMetaData().getId()))),t.push(i),o&&h.push(l.getId()+"-"+i.tessellationSetting)}}if(o&&h.length>0){h.sort(),It.log.info("Retrieving bodies: "+h);const e=this.viewer.getModelViewManagers().getManager().getEstimatedMemoryUsageOfBodies(),t=this.getEstimatedMemoryUsageOfPendingRetrievals();It.log.info("Estimated use of body memory at time of retrieval "+Zc(e+t)+", pending use: "+Zc(t))}t.length>0&&(this.aggressiveRefinementEnabled?this.viewer.getEventDispatcher().trigger(VM.am,t):this.viewer.getEventDispatcher().trigger(VM.Qe,t)),i&&this.startRetrievalTimeout()}resetRetrievalStateForOccurrence(e){e.resetRetrievalRequestState();const t=e.getBodyMetaDataForRetrieval();if(this.pendingRetrievalInformation.delete(t),qc()){const i=this.getBtOccurrence(e);i?(0,ve.iH)().remove(new ve.Y1(W.lQt.OCCURRENCE,i,i)):(0,ve.iH)().remove(new ve.Y1(W.lQt.BODY,t.getId()))}}updateForFrame(e,t){let i;this.sortedOccurrences||(this.sortedOccurrences=new Array(this.occurrences.size),i=0,this.occurrences.forEach((e=>{this.sortedOccurrences[i++]=e})),this.occurrencesNeedSort=!0),this.occurrencesNeedSort&&(this.sortedOccurrences.sort(sl),this.occurrencesNeedSort=!1),this.performAggressiveCulling(e,!!t)}performAggressiveCulling(e,t){if(this.viewer.getXrController().getIsXrRunning())return;const i=e.getActiveCamera(),s=e.getDetailSettings();let n=Zs()?Math.floor(s.lowLevelBodyProportion*this.sortedOccurrences.length):0;const r=!t||this.DISPLAY_BOXES_WHEN_CULLING;let a=this.shouldUpdateBodyOccurrenceLodForIsolate||0!==n&&r||e.getIsPickingHiddenOccurrences();const o=e.getViewer().getFrustumToPreventCulling();t&&(this.encounteredUnloadedOccurrenceInLastFrame=!1);const h=this.MAXIMUM_BODY_CULL_DIAMETER_PROPORTION*i.getViewportDiagonal();let c=!1;for(let s=0;s<this.sortedOccurrences.length;++s){const r=this.sortedOccurrences[s];if(r.outsideFrustum(i))r.setCullingState(Js.uc.CULLED),--n;else{r.lodIsUpToDate()||a||(a=!0,s=0);const l=i.getUnitSizeAtWorldPointFast(r.center)*r.radius*2;t&&!r.isBodyDataPresent()&&(this.encounteredUnloadedOccurrenceInLastFrame=!0),r.mustShowLowestLod(e)||s<n&&r.canCullBody(o)&&l<h?(c=!0,r.setCullingState(Js.uc.CULLED),a&&this.setBodyOccurrenceLod(r,eg.LOWEST,e)):(r.setCullingState(Js.uc.VISIBLE),a&&this.setBodyOccurrenceLod(r,eg.DEFAULT,e))}this.shouldUpdateBodyOccurrenceLodForIsolate=!1,r.isRetrievalRequestDataPresent()&&this.resetRetrievalStateForOccurrence(r)}c?(this.displayOccurrenceData.setCullingState(Js.uc.VISIBLE),this.displayOccurrenceDataNonIsolated.setCullingState(Js.uc.VISIBLE)):(this.displayOccurrenceData.setCullingState(Js.uc.CULLED),this.displayOccurrenceDataNonIsolated.setCullingState(Js.uc.CULLED))}setBodyOccurrenceLod(e,t,i){if(e.lod===t&&!e.displayDamaged)return void this.updateBodyHighlight(e);const s=e.occurrenceData.getIsolated()||!this.viewer.getIsolatedOccurrenceManager().isInIsolateOrMakeTransparentMode();if(t===eg.DEFAULT)e.incrementDetails&&(this.displayOccurrenceData.hideIncrement(e.incrementDetails,Ls.L.BASE),this.displayOccurrenceDataNonIsolated.hideIncrement(e.incrementDetails,Ls.L.BASE));else{const t=!e.isVisible()&&!i.getIsPickingHiddenOccurrences();if(e.displayDamaged||!e.incrementDetails){e.incrementDetails&&(this.meshManager.removeMeshIncrement(e.getDisplayId(),this.meshOwnerId),e.incrementDetails=null,e.highlightApplied=null);const t=e.getDisplayIncrement();e.incrementDetails=this.meshManager.addMeshIncrement(t,this.meshOwnerId),e.displayDamaged=!1}s&&!t?this.displayOccurrenceData.showIncrement(e.incrementDetails,Ls.L.BASE):this.displayOccurrenceData.hideIncrement(e.incrementDetails,Ls.L.BASE),s||t?this.displayOccurrenceDataNonIsolated.hideIncrement(e.incrementDetails,Ls.L.BASE):this.displayOccurrenceDataNonIsolated.showIncrement(e.incrementDetails,Ls.L.BASE)}e.lod=t,this.updateBodyHighlight(e)}updateBodyHighlight(e){if(e.incrementDetails)if(e.lod===eg.DEFAULT)this.clearBodyHighlight(e);else{const t=e.occurrenceData.getBaseOccurrenceHighlight();t!==e.highlightApplied&&(this.clearBodyHighlight(e),t&&(this.displayOccurrenceData.updateEntityHighlight(yn.aU.ADD,t,e.incrementDetails,Ls.L.BASE),this.displayOccurrenceDataNonIsolated.updateEntityHighlight(yn.aU.ADD,t,e.incrementDetails,Ls.L.BASE),e.highlightApplied=t))}}clearBodyHighlight(e){e.highlightApplied&&e.incrementDetails&&(this.displayOccurrenceData.updateEntityHighlight(yn.aU.REMOVE,e.highlightApplied,e.incrementDetails,Ls.L.BASE),this.displayOccurrenceDataNonIsolated.updateEntityHighlight(yn.aU.REMOVE,e.highlightApplied,e.incrementDetails,Ls.L.BASE),e.highlightApplied=null)}getBodyOccurrenceId(e,t){return e+"."+t}addOrUpdateOccurrence(e,t,i,s){const n=this.getBodyOccurrenceId(e,i.id);let r=this.occurrences.get(n);r?r.update(t,i):(r=new Jc(t,i,this.idManager.getOrCreateIdForName(n)),this.occurrences.set(n,r),this.sortedOccurrences&&this.sortedOccurrences.push(r)),r.numberOfBodiesInOccurrence=s,this.occurrencesNeedSort=!0,this.damageUnloadedBodyBounds()}damageUnloadedBodyBounds(){this.unloadedBodyBounds=null}getUnloadedBodyBounds(){return this.unloadedBodyBounds||(this.unloadedBodyBounds=new Li.kB,this.occurrences.forEach((e=>{!e.isVisible()||e.isBodyDataPresent()&&e.isEntityTessellationLoaded()||e.addBounds(this.unloadedBodyBounds)}))),this.unloadedBodyBounds}getBodyOccurrence(e,t){return this.occurrences.get(this.getBodyOccurrenceId(e,t))}removeOccurrence(e,t){const i=this.getBodyOccurrenceId(e,t),s=this.occurrences.get(i);s&&(s.incrementDetails&&this.meshManager.removeMeshIncrement(s.getDisplayId(),this.meshOwnerId),this.occurrences.delete(i),this.sortedOccurrences=null,this.occurrencesNeedSort=!0,this.damageUnloadedBodyBounds(),this.idManager.removeName(i))}getOccurrenceBounds(e,t){const i=new Li.kB,s=this.occurrences.get(this.getBodyOccurrenceId(e,t));return s&&s.addBounds(i),i}onUserIsAdjustingCamera(){(this.viewer.getModelViewManagers().getManager().displayingAssembly()||this.viewer.getModelViewManagers().getManager().displayingPartStudio())&&this.initiateAutomaticRetrieval()}getEstimatedMemoryUsageOfPendingRetrievals(){let e=0;return this.pendingRetrievalInformation.forEach((function(t){e+=t.estimatedAdditionalMemoryUsage})),e}hasRefinementCeased(){return 0===this.pendingRetrievalInformation.size&&this.hasRefinementCompleted()}getDisplayDataRefinementState(){const e=[];return this.occurrences.forEach((t=>{const i=t.getBodyMetaDataForRetrieval(),s=i.getFinestTessellationSettingOnClient(),n=t.isVisible(),r=i.getBestAvailableTessellationSettingIndex(this.aggressiveRefinementEnabled);e.push(`${i.name}, ${i.getId()}, on client = ${s}, maximum = ${r}, isVisible = ${n}`)})),e.join("\n")}hasRefinementCompleted(){let e=!0;for(const t of this.occurrenceRetrievalRequests){const i=t.bodyOccurrence.getBodyMetaDataForRetrieval().getFinestTessellationSettingOnClient();if(null===i){e=!1;break}if(t.tessellationSettingRequested!==W.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING&&t.tessellationSettingRequested>i){e=!1;break}}return e}getPendingRetrievalSummary(){let e="Body manager retrieval summary:\n";return this.pendingRetrievalInformation.size>0&&(e+="pendingRetrievalInformation size: "+this.pendingRetrievalInformation.size+"\n",this.pendingRetrievalInformation.forEach(((t,i)=>{e+="  Body: "+i.getId()+", retrievalInfo: "+JSON.stringify(t)+"\n"}))),this.bodyOccurrenceToRetrievalRequest.size>0&&(e+="occurrenceRetrievalRequests size: "+this.bodyOccurrenceToRetrievalRequest.size+"\n",this.bodyOccurrenceToRetrievalRequest.forEach(((t,i)=>{e+="retrievalRequest: "+JSON.stringify(t,null,"  ")+"\n"}))),e}clearBodyRetrievalCheckTimeout(){(0,Jr.Z)(this.bodyRetrievalCheckTimeout)&&(window.clearTimeout(this.bodyRetrievalCheckTimeout),this.bodyRetrievalCheckTimeout=null)}initiateAutomaticRetrieval(){this.clearBodyRetrievalCheckTimeout();const e=this.aggressiveRefinementEnabled?q.default.getManager().getNumber("AGGRESSIVE_AUTOMATIC_BODY_RETRIEVAL_TIMEOUT_MS"):q.default.getManager().getNumber("AUTOMATIC_BODY_RETRIEVAL_TIMEOUT_MS");this.bodyRetrievalCheckTimeout=window.setTimeout((()=>this.performUnloadedBodyAndRefinementCheck()),e)}allowRefinementCheck(){if(Hc===Gc.ALWAYS||this.aggressiveRefinementEnabled)return!0;const e=this.viewer.getInteractiveFrameDetails(),t=qc();let i=!1;return e&&e.hasTimings()&&(i=e.getAverageFramerate()<q.default.getManager().getNumber("BODY_REFINEMENT_FRAMERATE_THRESHOLD"),t&&i&&It.log.info("Skipped body refinement check because framerate is slow right now: "+e.getAverageFramerate()+" fps")),!i}getSelectionsForRetrieval(){const e=[];return(0,ve.vi)().forEach((t=>{e.push({selection:t,requestSource:zc.SELECTION})})),(0,ve.Wf)().forEach((t=>{e.push({selection:t,requestSource:zc.HOVER})})),e}getSelectionOccurrencesForRetieval(){const e=[],t=this.viewer.getModelViewManagers().getManager(),i=this.viewer.getOccurrenceIdManager(),s=this.viewer.getCamera(),n=this.aggressiveRefinementEnabled?q.default.getManager().getNumber("SELECTED_AGGRESSIVE_ERROR_REFINEMENT_THRESHOLD"):q.default.getManager().getNumber("FINER_BODY_SCREENSPACE_ERROR_REFINEMENT_THRESHOLD");for(const{selection:r,requestSource:a}of this.getSelectionsForRetrieval()){const o=r.getOccurrence();if(!o)continue;const h=i.getIdForName(o.getPathAsString());if(h===DI.Qy)continue;const c=t.getOccurrenceDisplayData(o);if(c&&c.displayedPartIds)for(const t of c.displayedPartIds){const i=this.getBodyOccurrenceId(h,t),r=this.occurrences.get(i);if(!r)continue;const o=null==s?void 0:s.getUnitSizeAtWorldPoint(r.getCenter()),c=this.getTessellationIndexToGoUnderThreshold(r,n,o,this.aggressiveRefinementEnabled),l=this.getBtOccurrence(r);e.push(new Vc(r,a,l,c,W.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING,Number.MAX_VALUE))}}return e}getVisibleOccurrencesForRetrieval(){const e=[],t=this.viewer.getCamera(),i=this.viewer.getModelViewManagers().getManager();let s;s=this.aggressiveRefinementEnabled?i.displayingAssembly()?q.default.getManager().getNumber("VIEWING_ASSEMBLY_AGGRESSIVE_ERROR_REFINEMENT_THRESHOLD"):q.default.getManager().getNumber("VIEWING_PART_STUDIO_AGGRESSIVE_ERROR_REFINEMENT_THRESHOLD"):q.default.getManager().getNumber("BODY_SCREENSPACE_ERROR_REFINEMENT_THRESHOLD");const n=(0,Js.Wj)();return this.collectBodyOccurrencesInViewport().forEach(((i,r)=>{r.updateViewHistory(n,i.viewportOccupancyRatio);const a=r.getBodyMetaData(),o=r.getUnloadedChordalTolerance(),h=null==t?void 0:t.getUnitSizeAtWorldPoint(r.getCenter()),c=h*o;if(c>=s){let t=null;if(t=this.shouldRetrieveHighestQualityTessellationForOccurrence(r)?a.getBestAvailableTessellationSettingIndex(this.aggressiveRefinementEnabled):this.getTessellationIndexToGoUnderThreshold(r,s,h,this.aggressiveRefinementEnabled),null===t)return;const n=this.getBtOccurrence(r);e.push(new Vc(r,zc.VIEWING,n,t,W.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING,i.viewportOccupancyRatio*c))}})),e}findMaximumRefinementForOccurrences(){const e=[],t=new Map;for(const i of[...this.getSelectionOccurrencesForRetieval(),...this.getVisibleOccurrencesForRetrieval()]){const s=t.get(i.bodyOccurrence);s?(s.viewportError=Math.max(i.viewportError,s.viewportError),s.requestSource=Math.min(i.requestSource,s.requestSource)):(e.push(i),t.set(i.bodyOccurrence,i))}const i=this.viewer.getCamera();e.sort(((e,t)=>{const s=e.bodyOccurrence.outsideFrustum(i);if(s!==t.bodyOccurrence.outsideFrustum(i))return s?1:-1;if(e.requestSource<t.requestSource)return-1;if(e.requestSource>t.requestSource)return 1;const n=!!this.getBtOccurrence(e.bodyOccurrence);if(n!==!!this.getBtOccurrence(t.bodyOccurrence))return n?-1:1;const r=e.bodyOccurrence.getBenefitToRefine(e.tessellationSettingDesired,e.viewportError),a=t.bodyOccurrence.getBenefitToRefine(t.tessellationSettingDesired,t.viewportError);return r>a?-1:r<a?1:0}));let s=0;const n=this.viewer.getModelViewManagers().getManager().getBodyRefinementMemoryLimit();let r=!0;for(;r;){r=!1;const t=new Map;for(const i of e){const e=i.bodyOccurrence.getBodyMetaDataForRetrieval(),a=t.get(e);if(a)i.tessellationSettingRequested=a.tessellationSettingRequested;else{if(i.tessellationSettingRequested<i.tessellationSettingDesired){const t=e.getEstimatedMemoryUsage([i.tessellationSettingRequested+1])-e.getEstimatedMemoryUsage([i.tessellationSettingRequested]);s+t<=n&&(i.tessellationSettingRequested+=1,s+=t,r=!0)}t.set(e,i)}}}if(qc()){const i=this.getLoadedDisplayDataVolume(),r=this.getDesiredDisplayDataVolume(e),a=[];a.push(`Total display data in memory: ${Zc(i)}`),a.push(`Total desired memory usage: ${Zc(r)}`),a.push(`Maximum allowed memory usage: ${Zc(n)}`),a.push(`Total requested display memory after optimization: ${Zc(s)}`),e.forEach((({bodyOccurrence:e})=>{const i=e.getBodyMetaDataForRetrieval(),s=i.getFinestTessellationSettingOnClient(),n=t.get(e),r=i.getBestAvailableTessellationSettingIndex(this.aggressiveRefinementEnabled);a.push(`${i.name}, ${i.getId()}, on client = ${s}, maximum = ${r}, desired = ${null==n?void 0:n.tessellationSettingDesired}, requested = ${null==n?void 0:n.tessellationSettingRequested}`)})),a.push(`Number of visible occurrences in frustum=${e.length}`),It.log.info(a.join("\n"))}return{occurrenceRetrievalRequests:e,bodyOccurrenceToRetrievalRequest:t}}getDesiredDisplayDataVolume(e){let t=0;const i=new Set;for(const s of e){const e=s.bodyOccurrence.getBodyMetaDataForRetrieval();i.has(e)||(i.add(e),s.tessellationSettingDesired>=0&&(t+=e.getEstimatedMemoryUsage([s.tessellationSettingDesired])))}return t}getLoadedDisplayDataVolume(){let e=0;const t=new Set;return this.occurrences.forEach((function(i){const s=i.getBodyMetaDataForRetrieval();t.has(s)||(t.add(s),e+=s.getEstimatedMemoryUsage())}),this),e}performUnloadedBodyAndRefinementCheck(){if(this.paused)return void It.log.info("Skipped body refinement check due to pause");if(Hc===Gc.DISABLED)return;if(!this.encounteredUnloadedOccurrenceInLastFrame&&!this.allowRefinementCheck())return;const e=qc(),t=new mh.B7("BodyManager.performUnloadedBodyAndRefinementCheck",{logResult:e}),{occurrenceRetrievalRequests:i,bodyOccurrenceToRetrievalRequest:s}=this.findMaximumRefinementForOccurrences();this.occurrenceRetrievalRequests=i,this.bodyOccurrenceToRetrievalRequest=s,this.startRetrievalTimeout(),t.report()}collectBodyOccurrencesInViewport(){const e=new mh.B7("BodyManager.collectBodyOccurrencesInViewport"),t=[];let i=[];const s=this.viewer.getCamera();if(s){const e=s.viewportToCanvas([0,s.getViewportHeight(),0]),n=this.aggressiveRefinementEnabled&&js();i=this.viewer.pickInRect(e[0],e[1],s.getViewportWidth(),s.getViewportHeight(),{bodyPicks:t,nodeFilterOverride:this.refinementNodeFilter,sampleLimit:q.default.getManager().getNumber("OFFSCREEN_BODY_ERROR_SAMPLE_SIZE"),doNotAffectFrustumCulling:!0,forcePreviewPick:n})}const n=new Map;for(let e=0;e<t.length;++e){const i=t[e],s=i.primitiveId;if(s.length<1)continue;s.length>1&&It.log.warn("Picked body manager occurrence id with multiple entries");const r=this.idManager.getNameForId(s),a=this.occurrences.get(r);a&&this.collectBodyOccurrenceForOccurrencePick(n,a,i)}for(let e=0;e<i.length;++e)this.collectBodyOccurrenceForEntityPick(n,i[e]);return e.report(),n}updatePickData(e){let t=!1;const i=e.primitiveId;if(i.length<1)return t;i.length>1&&It.log.warn("Picked body manager occurrence id with multiple entries");const s=this.idManager.getNameForId(i),n=this.occurrences.get(s);if(n)if(e.bodyMetaData=n.getBodyMetaDataForRetrieval(),e.occurrence=this.getBtOccurrence(n),e.occurrence)e.occurrenceId=this.viewer.getOccurrenceIdManager().getIdForName(e.occurrence.toString()),t=!0;else{const i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();i&&(e.occurrenceId=i.getBodyComponent().getCorrectedBodyOccurrenceId(e.bodyMetaData.id),t=!0)}return t}hideBodyFromPick(e){const t=this.occurrences.get(this.getBodyOccurrenceId(e.occurrenceId,e.bodyMetaData.id));(null==t?void 0:t.incrementDetails)&&(this.displayOccurrenceData.hideIncrementFromPick(t.incrementDetails,Ls.L.BASE),this.displayOccurrenceDataNonIsolated.hideIncrement(t.incrementDetails,Ls.L.BASE))}shouldRetrieveHighestQualityTessellationForOccurrence(e){if(e.getBodyMetaData().getTessellationSettingOverride()!==W.XiJ.AUTO)return!0;let t=this.getBtOccurrence(e);for(;t;){const e=this.viewer.getModelViewManagers().getManager().getOccurrenceDisplayData(t);if(e&&e.occurrenceData.forceHighestQualityTessellation)return!0;t.path.length>0?t.path.splice(t.path.length-1,1):t=null}return!1}collectBodyOccurrenceForEntityPick(e,t){if(t.isUIPick())return;const i=t.getOccurrence();let s,n,r=t.getBodyId();if(!r)return;const a=this.viewer.getModelViewManagers().getManagerForUsage(t.usage);if(i)s=this.viewer.getOccurrenceIdManager().getIdForName(i.toString()),n=a.retrieveBodyMetaData(i,r),n&&n.canBeGroupedWithOtherConstituents&&(r=n.consumingClosedCompositeData.getId());else{const e=a.getDisplayedPartStudio();if(!e)return;n=e.retrieveBodyMetaData(r),n&&n.canBeGroupedWithOtherConstituents&&(r=n.consumingClosedCompositeData.getId()),s=e.getBodyComponent().getCorrectedBodyOccurrenceId(r)}let o=this.occurrences.get(this.getBodyOccurrenceId(s,r));if(!o&&t.usage===Ls.L.PREVIEW&&(o=this.previewOccurrences.get(r),!o)){const e=this.viewer.getOccurrenceDataManager().getOccurrenceData(s);e&&n&&(o=new Jc(e,n),this.previewOccurrences.set(r,o))}o&&this.collectBodyOccurrenceForOccurrencePick(e,o,t)}collectBodyOccurrenceForOccurrencePick(e,t,i){const s=e.get(t);s?s.viewportOccupancyRatio+=i.coverage:e.set(t,{viewportOccupancyRatio:i.coverage})}getBodiesInFrustum(){const e=new Set,t=this.viewer.getCamera();return this.occurrences.forEach((function(i){i.outsideFrustum(t)||e.add(i.getBodyMetaData())}),this),e}getBodiesInvolvedInSelection(){const e=new Set,t=(0,ve._g)();for(let i=0;i<t.length;++i){t[i].forEach((t=>{let i=t.getBodyMetaData();!i&&t.getEntityMetaData()&&(i=t.getEntityMetaData().getBodyMetaData()),i&&e.add(i)}))}return e}refreshReducedDetailBoxes(){this.sortedOccurrences&&(this.sortedOccurrences.forEach((e=>{e.displayDamaged=!0})),this.shouldUpdateBodyOccurrenceLodForIsolate=!0)}onOccurrencesHighlighted(e,t){if(e===yn.aU.ADD){const e=this.viewer.getModelViewManagers().getManager(),i=this.viewer.getOccurrenceIdManager();for(let s=0;s<t.length;++s){const n=e.getOccurrenceDisplayData(t[s]);if(!(null==n?void 0:n.displayedPartIds))continue;const r=i.getIdForName(t[s].toString());for(const e of n.displayedPartIds){const t=this.occurrences.get(this.getBodyOccurrenceId(r,e));(null==t?void 0:t.mustShowLowestLod())&&(t.displayDamaged=!0)}}}}getPartStudio(e){const t=this.viewer.getModelViewManagers().getManager(),i=this.getBtOccurrence(e);return i?t.getPartStudioDataFromOccurrence(i):t.getDisplayedPartStudio()}getTessellationIndexToGoUnderThreshold(e,t,i,s){let n=0;const r=e.getBodyMetaData();if(r.isWireBody()&&!r.hasTessellationSettings())return null;if(r.isClosedComposite&&r.containsOnlyWireBodies()){const t=this.getPartStudio(e);if(t)for(let e=0;e<r.constituentBodyIds.length;++e){const i=t.retrieveBodyMetaData(r.constituentBodyIds[e]);if(i&&!i.hasTessellationSettings())return null}}if(this.viewer.getRenderingMode()===W.P1.SHADED_CURVATURE_VISUALIZATION)return W.ls1.getTessellationSettingIndexFromEnum(W.XiJ.CURVATURE_VISUALIZATION);const a=r.getBestAvailableTessellationSettingIndex(!!s);if(null===a)return null;for(;n<a;){if(!(i*r.getChordalToleranceForSetting(n)>=t))break;n++}return n}cleanupPendingRefinementRequests(){if(0===this.pendingRetrievalInformation.size)return;const e=new Set;for(const[t,i]of this.pendingRetrievalInformation){t.getFinestTessellationSettingOnClient()>=i.tessellationSetting&&(e.add(t),this.pendingRetrievalInformation.delete(t))}const t=new Set;this.occurrences.forEach((i=>{const s=i.getBodyMetaDataForRetrieval();t.add(s),e.has(s)&&this.resetRetrievalStateForOccurrence(i)}));for(const[e,i]of this.pendingRetrievalInformation)t.has(e)||this.pendingRetrievalInformation.delete(e);qc()&&It.log.info(`Number of refined pending requests: ${e.size} remaining: ${this.pendingRetrievalInformation.size}`)}unloadBodies(e,t){if(qc()&&It.log.info(`Unload bodies ${Zc(e)}`),this.paused)return It.log.info("Skipped body unloading due to pause"),null;const i=Array.from(this.occurrences.values()),s=this.getBodiesInFrustum(),n=this.getBodiesInvolvedInSelection(),r=new Map;for(const e of this.occurrenceRetrievalRequests){const t=e.bodyOccurrence.getBodyMetaDataForRetrieval();r.has(t)||r.set(t,e)}const a=t.getDisplayedPartStudio(),o=t.getPartStudios();for(let e=0;e<o.length;++e){const t=o[e];if(t===a)continue;const s=t.getBodyComponent().getNonInstantiatedBodies();for(let e=0;e<s.length;++e){const n=s[e];n.hasTessellationSettings()&&i.push(new Kc(t,n))}}i.sort((function(e,t){if(e.isInstantiated()!==t.isInstantiated())return e.isInstantiated()?1:-1;const i=e.isBodyDataPresent(),r=t.isBodyDataPresent();if(!i&&!r)return 0;if(!i)return 1;if(!r)return-1;const a=e.getBodyMetaDataForRetrieval(),o=t.getBodyMetaDataForRetrieval(),h=n.has(a);if(h!==n.has(o))return h?1:-1;const c=s.has(a);if(c!==s.has(o))return c?1:-1;const l=e.getLastViewTime(),u=t.getLastViewTime();if(l!==u)return l>u?1:-1;const d=e.getLastViewportOccupancy(),g=t.getLastViewportOccupancy();if(d!==g)return d>g?1:-1;const p=e.getBenefitToUnload(),m=t.getBenefitToUnload();return p>m?-1:m>p?1:0}));const h=new Set;let c=0;for(let t=0;t<i.length&&c<e;++t){const e=i[t],s=e.getBodyMetaDataForRetrieval();if(s.isWireBody())continue;if(!e.isBodyDataPresent()||h.has(s)||n.has(s))continue;if(r.has(s)){const e=r.get(s);if((null==e?void 0:e.tessellationSettingRequested)!==W.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING&&(null==e?void 0:e.tessellationSettingRequested)===s.getFinestTessellationSettingOnClient())continue}let a;a=e instanceof Jc?this.getPartStudio(e):e.partStudio,a&&(c+=s.getEstimatedMemoryUsage(),this.bodyUnloadTask.addBodyToProcess(a.getBodyComponent(),s.getId()),h.add(s))}if(qc()){const t=[];h.forEach((function(e){t.push(e.getId()+"-"+e.getFinestTessellationSettingOnClient())})),t.sort(),It.log.info("Unloading "+Zc(c)+" of bodies to satisfy request of "+Zc(e)+". Body ids:\n"+t)}return this.occurrences.forEach((e=>{h.has(e.getBodyMetaDataForRetrieval())&&this.resetRetrievalStateForOccurrence(e)})),this.bodyUnloadTask.getTaskFinishedPromise()}unloadSelectionBody(e){var t;const i=e.getBodyMetaData()||(null===(t=e.getEntityMetaData())||void 0===t?void 0:t.getBodyMetaData());if(!i)return;const s=this.viewer.getModelViewManagers().getManager().getPartStudioDataFromOccurrence(e.getOccurrence());s&&this.bodyUnloadTask.addBodyToProcess(s.getBodyComponent(),i.id),this.viewer.requestDraw()}}function sl(e,t){const i=e.getBenefitToCull(),s=t.getBenefitToCull();return i===s?e.getOccurrenceId()===t.getOccurrenceId()?0:e.getOccurrenceId()<t.getOccurrenceId()?-1:1:i>s?-1:1}const nl=q.default.getManager();var rl;function al(e,t){return e+Pn.ID_SEPARATOR+t.getCollectionId()}!function(e){e[e.UNLOAD=0]="UNLOAD",e[e.LOAD=1]="LOAD"}(rl||(rl={}));class ol{constructor(e,t){this.bodyComponent=e,this.bodyId=t}getCollectionId(){return al(this.bodyId,this.bodyComponent)}}class hl{constructor(e,t){this.viewer=e,this.action=t,this.bodiesToProcess=[],this.bodiesNeedSort=!1,this.taskFinishedDeferred=null,this.iterationsSinceStart=0,this.bodiesProcessedSinceStart=0,(0,Ih.Yk)(e),this.bodiesToProcessMap=new Map,this.initialLoadBudget=new uM(nl.getNumber("GRAPHICS_TASK_INITIAL_TIME_BUDGET"),nl.getNumber("GRAPHICS_TASK_INITIAL_VERTEX_BUDGET"))}addBodyToProcess(e,t){const i=new ol(e,t),s=i.getCollectionId();this.bodiesToProcessMap.get(s)||(this.bodiesToProcess.push(i),this.bodiesToProcessMap.set(s,i),this.setBodiesNeedSort())}performInitialLoad(){const e=new mh.B7("BodyLoader.prototype.performInitialLoad");this.initialLoadBudget.reset(),this.process(this.initialLoadBudget),e.report()}indexOfBody(e,t){for(let i=0;i<this.bodiesToProcess.length;++i){const s=this.bodiesToProcess[i];if(s.bodyComponent===e&&s.bodyId===t)return i}return-1}stopBodyFromProcessing(e,t){if(this.bodiesToProcessMap.has(al(t,e))){const i=this.indexOfBody(e,t);i>=0&&(this.bodiesToProcessMap.delete(this.bodiesToProcess[i].getCollectionId()),this.bodiesToProcess.splice(i,1))}}clearBodiesForComponent(e,t){const i=[];for(let s=0;s<this.bodiesToProcess.length;++s){const n=this.bodiesToProcess[s];n.bodyComponent===e&&t.contains(n.bodyId)&&(KI([s,s+1],i),this.bodiesToProcessMap.delete(n.getCollectionId()))}JI(this.bodiesToProcess,i)}clearAllBodiesForComponent(e){const t=[];for(let i=0;i<this.bodiesToProcess.length;++i)this.bodiesToProcess[i].bodyComponent===e&&(KI([i,i+1],t),this.bodiesToProcessMap.delete(this.bodiesToProcess[i].getCollectionId()));JI(this.bodiesToProcess,t)}setBodiesNeedSort(){this.bodiesNeedSort=!0}clearAllBodies(){this.bodiesToProcess=[],this.bodiesToProcessMap.clear(),this.bodiesNeedSort=!1}hasPendingWork(){return this.bodiesToProcess.length>0}sortBodies(){this.bodiesNeedSort&&(this.bodiesToProcess.sort((function(e,t){const i=e.bodyComponent.isBodyInstantiated(e.bodyId);if(i!==t.bodyComponent.isBodyInstantiated(t.bodyId))return i?-1:1;const s=e.bodyComponent.getBodyDiameter(e.bodyId),n=t.bodyComponent.getBodyDiameter(t.bodyId);return s>n?-1:s<n?1:0})),this.bodiesNeedSort=!1)}process(e){this.sortBodies();const t=[];let i=0;for(let s=0;s<this.bodiesToProcess.length;++s){const n=this.bodiesToProcess[s];let r=!1;if(this.action===rl.UNLOAD?(n.bodyComponent.unloadBody(n.bodyId),++i,r=!0):n.bodyComponent.processBodyAddition(n.bodyId,e)&&(++i,r=!0),r&&(KI([s,s+1],t),this.bodiesToProcessMap.delete(n.getCollectionId())),e&&e.budgetExceeded())break}JI(this.bodiesToProcess,t),i>0&&this.action===rl.LOAD&&this.viewer.getEventDispatcher().trigger(VM.LA),i>0&&(this.bodiesProcessedSinceStart+=i,++this.iterationsSinceStart),this.hasPendingWork()||(this.taskFinishedDeferred&&(this.taskFinishedDeferred.resolve({bodiesProcessedSinceStart:this.bodiesProcessedSinceStart,iterationsSinceStart:this.iterationsSinceStart}),this.taskFinishedDeferred=null),this.iterationsSinceStart=0,this.bodiesProcessedSinceStart=0)}getTaskFinishedPromise(){return this.taskFinishedDeferred?this.taskFinishedDeferred.promise:this.hasPendingWork()?(this.taskFinishedDeferred=$r.defer(),this.taskFinishedDeferred.promise):null}}class cl{constructor(e){this.loadTask=new hl(e,rl.LOAD),this.unloadTask=new hl(e,rl.UNLOAD)}getLoadTask(){return this.loadTask}getUnloadTask(){return this.unloadTask}postBodyToLoad(e,t){this.loadTask.addBodyToProcess(e,t),this.unloadTask.stopBodyFromProcessing(e,t)}postBodyToUnload(e,t){this.unloadTask.addBodyToProcess(e,t),this.loadTask.stopBodyFromProcessing(e,t)}completeTasks(){this.loadTask.process(null),this.unloadTask.process(null)}stopBodyFromProcessing(e,t){this.loadTask.stopBodyFromProcessing(e,t),this.unloadTask.stopBodyFromProcessing(e,t)}clearBodiesForComponent(e,t){this.loadTask.clearBodiesForComponent(e,t),this.unloadTask.clearBodiesForComponent(e,t)}clearAllBodiesForComponent(e){this.loadTask.clearAllBodiesForComponent(e),this.unloadTask.clearAllBodiesForComponent(e)}clearAllBodies(){this.loadTask.clearAllBodies(),this.unloadTask.clearAllBodies()}hasPendingUnloads(){return this.unloadTask.hasPendingWork()}}const ll=q.default.getManager(),ul=new Qi({primitiveType:_i.MX.LINES,isShowThrough:!0,isDepthTested:!1,isPickable:!1}),dl=ul.cloneAndModify({includedInBlend:!0}),gl=ul.cloneAndModify({priority:Yi.HIGHER}),pl=ul.cloneAndModify({priority:Yi.HIGHEST}),ml=new Qi({primitiveType:_i.MX.TRIANGLE_STRIP,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,isPickable:!1,zOffset:ll.getNumber("MATE_CONNECTOR_TRIANGLE_Z_OFFSET"),primitivesHaveTransparency:!0,material:Wi}),fl=ml.cloneAndModify({priority:Yi.HIGHER}),Il=ml.cloneAndModify({includedInBlend:!0}),El=ml.cloneAndModify({priority:Yi.HIGHEST}),Sl=new Qi({primitiveType:_i.MX.TRIANGLES,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,isVisible:!1});var Tl;!function(e){e.LINES="lines",e.LINES_FADED="lines_faded",e.TRIANGLES="triangles",e.COMPARE_BASE_TRIANGLES="compare_base_triangles",e.COMPARE_TARGET_TRIANGLES="compare_target_triangles",e.TRIANGLES_PRESELECTED="triangles_preselected",e.TRIANGLES_SELECTED="triangles_selected",e.TRIANGLES_FADED="triangles_faded",e.PICK_DISC="pick_disc",e.INFERENCE_POINT_TRIANGLES="inference_point_triangles",e.INFERENCE_POINT_LINES="inference_point_lines",e.INFERENCE_CENTER_TRIANGLES="inference_center_triangles",e.INFERENCE_CENTER_LINES="inference_center_lines",e.INFERENCE_CENTROID_TRIANGLES="inference_centroid_triangles",e.INFERENCE_CENTROID_LINES="inference_centroid_lines",e.INFERENCE_MID_POINT_TRIANGLES="inference_mid_point_triangles",e.INFERENCE_MID_POINT_LINES="inference_mid_point_lines",e.INFERENCE_ORIGIN_AXIS_LINES="inference_origin_axis_lines",e.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED="inference_origin_axis_lines_preselected"}(Tl||(Tl={}));let Ml=null,Cl=!0;class Dl extends Ri{constructor(e,t,i,s){super(i,t),this.definition=e,this.isBeingEdited=!1,this.lastScale=-1,this.worldSpacePosition=[0,0,0],this.activeMateConnectorScaled=!1,this.isForInContextAssembly=!1,this.isFromChildFeature=!1,this.isParentOccurrenceDataMissing=!1,this.partStudioFeatureId=s||"",this.isPartStudioMateConnector=!!this.partStudioFeatureId,this.occurrenceTransform=ge.create(),this.parentOccurrenceVisibility=Js.EE.VISIBLE,this.usage=t===sh.Vv?Ls.L.PREVIEW:Ls.L.BASE,this.damageTransform(),this.updateHideState(),this.occurrenceData.setCanIsolateChange(!0),this.occurrenceData.setIsolated(!1),this.isForInContextAssembly=e&&e.occurrence&&this.viewer.getModelViewManagers().getManager().isDisplayingIncontextAssembly()}cloneForPreview(){return new Dl(this.definition,sh.Vv,this.viewer,this.partStudioFeatureId)}getUsage(){return this.usage}getWorldSpacePosition(){return this.worldSpacePosition}onDevicePixelRatioChanged(e){Ml=null,this.updateGraphics()}getIsPartStudioMateConnector(){return this.isPartStudioMateConnector}getId(){return(0,vn.vm)(this.definition.ownerOccurrence,this.definition.nodeId)}setOccurrenceTransform(e){this.occurrenceTransform=e,this.damageTransform()}setEditState(e){this.isBeingEdited=e,this.updateHideState(),this.updateGraphics()}getDefinition(){return this.definition?this.definition:null}getLineProperties(){return this.isForInContextAssembly?ul:dl}getTriangleProperties(){return this.isForInContextAssembly?ul:Il}updateDefinition(e){this.definition=e,this.updateHideState(),this.damageTransform()}damageTransform(){this.lastScale=-1,this.definition&&pe.w$.multiplyVec3(this.occurrenceTransform,this.definition.location.origin.getVec3(),this.worldSpacePosition),this.viewer.requestDraw()}getWorldSpaceDefinition(){if(!this.definition)return null;const e=new W.em5,t=this.definition.location.xAxis.getVec3(),i=this.definition.location.yAxis.getVec3(),s=this.definition.location.zAxis.getVec3(),n=this.definition.location.origin.getVec3(),r=pe.w$.toRotationMat(this.occurrenceTransform,ge.create());return pe.w$.multiplyVec3(this.occurrenceTransform,n),pe.w$.multiplyVec3(r,t),pe.w$.multiplyVec3(r,i),pe.w$.multiplyVec3(r,s),e.xAxis.updateFromArray(t),e.yAxis.updateFromArray(i),e.zAxis.updateFromArray(s),e.origin.updateFromArray(n),e}canPickThrough(){return!0}getPickPriority(){return Ef.z.MATE_CONNECTOR}getModelSelection(e){return this.definition?new ve.Y1(W.lQt.MATE_CONNECTOR,this.definition.nodeId,this.definition.ownerOccurrence,{sourcePick:e.sourcePick,isPartStudioMateConnector:this.isPartStudioMateConnector,isDerivedFeature:this.definition.isDerivedFeature,isChildFeature:this.isFromChildFeature,featureId:this.partStudioFeatureId}):null}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.updateGraphics()}removeHighlight(e){return!!super.removeHighlight(e)&&(this.updateHideState(),this.updateGraphics(),!0)}getUserVisibilitySetting(){return this.definition.hidden?Js.EE.HIDDEN:Js.EE.VISIBLE}updateOccurrenceVisibility(e){e!==this.parentOccurrenceVisibility&&(this.parentOccurrenceVisibility=e,this.updateHideState(),this.updateGraphics())}updateHideState(){!this.isParentOccurrenceDataMissing&&(this.isBeingEdited||this.isHighlighted()||this.getUserVisibilitySetting()!==Js.EE.HIDDEN&&this.parentOccurrenceVisibility!==Js.EE.HIDDEN)?(this.hasMeshIncrements()||this.updateGraphics(!0),this.show()):this.hide()}setOpacity(e){const t=vl(),i=ll.getColor("MATE_CONNECTOR_COLOR");i[3]=e,Uu(i,t[Tl.TRIANGLES_FADED]),this.updateMeshIncrement(Tl.TRIANGLES,yi,t[Tl.TRIANGLES_FADED].clone(),this.getTriangleProperties()),this.setLineOpacity(e)}onIsolateChanged(){this.updateGraphics()}updateIsolation(){if(this.viewer.getIsolatedOccurrenceManager().hasIsolatedInstances()&&!this.occurrenceData.getIsolated()){let e=0;e=this.isForInContextAssembly?ll.getNumber("ISOLATE_CONTEXT_UI_MATE_CONNECTOR_TRANSPARENCY"):ll.getNumber("ISOLATE_CONTEXT_UI_TRANSPARENCY")*Qe()+(1-Qe()),this.setOpacity(e)}else{const e=vl();this.updateBaseIncrements(e)}}updateBaseIncrements(e){let t=Tl.TRIANGLES;const i=Ys(),s=!!i&&(ps.Jq.PartStudioCompareService.isPartStudioComparisonReady()&&ps.Jq.PartStudioCompareService.doesFeatureHaveADifference(this.partStudioFeatureId));i&&s&&(t=this.sceneGraphId===sh.lL?Tl.COMPARE_BASE_TRIANGLES:Tl.COMPARE_TARGET_TRIANGLES),this.updateMeshIncrement(Tl.TRIANGLES,yi,e[t].clone(),this.getTriangleProperties()),this.setLineOpacity(1),this.updateMeshIncrement(Tl.LINES,yi,e[Tl.LINES].clone(),this.getLineProperties())}setLineOpacity(e){const t=td(vl()[Tl.LINES_FADED],e);this.updateMeshIncrement(Tl.LINES,yi,t.clone(),this.getLineProperties())}adjustTransform(e){if(!this.definition||this.isHidden)return;let t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition);const i=this.getIsActiveMateConnector();if(this.activeMateConnectorScaled&&!i&&(this.activeMateConnectorScaled=!1,this.lastScale=-1),Math.abs(this.lastScale-t)<bi.W.ZERO_LENGTH)return;this.lastScale=t,i&&(t*=ll.getNumber("ACTIVE_MATE_CONNECTOR_SIZE_SCALE_PERCENT"),this.activeMateConnectorScaled=!0);const s=ge.create();s[0]=t,s[5]=t,s[10]=t,this.setTransform(pe.w$.multiply(pe.w$.multiply(this.occurrenceTransform,this.definition.location.getGlMatrix(),ge.create()),s)),this.hasMeshIncrements()||this.updateGraphics()}getIsActiveMateConnector(){const e=this.viewer.getMateConnectorManager();return!!e&&e.isMateConnectorActive(this.getId(),this)}onViewWillDraw(e){this.isHidden||this.hasBeenRemoved||(this.viewer.getIsolatedOccurrenceManager().hasIsolatedInstances()&&this.updateGraphics(),this.adjustTransform(e))}onHighlightColorUpdated(){this.isHighlighted()&&this.updateGraphics()}updateGraphics(e){if(!this.definition||this.isHidden&&!e)return void this.removeMeshIncrements();const t=vl();this.updateMeshIncrement(Tl.PICK_DISC,"mateconnector",t[Tl.PICK_DISC].clone(),Sl);const i=this.getHighlight();i&&i.type===yn.o2.PRE?(this.updateMeshIncrement(Tl.TRIANGLES,yi,t[Tl.TRIANGLES_PRESELECTED].clone(),El),this.updateMeshIncrement(Tl.LINES,yi,t[Tl.LINES].clone(),pl)):i?(this.updateMeshIncrement(Tl.TRIANGLES,yi,t[Tl.TRIANGLES_SELECTED].clone(),El),this.updateMeshIncrement(Tl.LINES,yi,t[Tl.LINES].clone(),pl),this.muteIfActive()):(this.updateBaseIncrements(t),this.updateIsolation(),this.muteIfActive())}muteIfActive(){if(this.hasBeenRemoved)return;const e=this.getIsActiveMateConnector();if(e&&this.setOpacity(ll.getNumber("ACTIVE_MATE_CONNECTOR_OPACITY")),this.activeMateConnectorScaled!==e){if(!e){const e=1;this.setOpacity(e)}this.damageTransform()}}static setInteractionEnabled(e){Cl=e}isInteractionEnabled(){return Cl&&!(this.viewer.getIsolatedOccurrenceManager().hasIsolatedInstances()&&!this.occurrenceData.getIsolated())}getOccurrence(){return this.definition?this.definition.occurrence:null}setIsParentOccurrenceDataMissing(e){this.isParentOccurrenceDataMissing=e,this.updateHideState()}}function vl(){if(Ml)return Ml;Ml={};const e=v.create(),t=v.fromValues(0,0,1),i=v.fromValues(1,0,0),s=Math.PI/2,n=.75*ll.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS"),r=.25*ll.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS");let a=ll.getNumber("MATE_CONNECTOR_DIAMETER_PX")/2;const o=a-ll.getNumber("MATE_CONNECTOR_RING_WIDTH_PX"),h=ll.getColor("MATE_CONNECTOR_STROKE_COLOR");let c=ll.getNumber("MATE_CONNECTOR_STROKE_WIDTH"),l=Cu(e,a,t,ll.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS"));Uu(h,l),Hu(c,l);const u=Du(e,o,t,i,s,2*Math.PI,n);Uu(h,u),Hu(c,u);let d=pu(e,[o,0,0],void 0,h,c),g=pu(e,[0,o,0],void 0,h,c);const p=ll.getNumber("MATE_CONNECTOR_AXIS_LINE_GAP_PX"),m=ll.getNumber("MATE_CONNECTOR_AXIS_LINE_LENGTH_PX"),f=ll.getNumber("MATE_CONNECTOR_AXIS_LINE_WIDTH"),I=ll.getNumber("MATE_CONNECTOR_Z_AXIS_LINE_LENGTH_PX"),E=ll.getNumber("MATE_CONNECTOR_Z_AXIS_LINE_WIDTH"),S=pu([a+p,0,0],[a+p+m,0,0],void 0,ll.getColor("X_AXIS_COLOR"),f),T=pu([0,a+p,0],[0,a+p+m,0],void 0,ll.getColor("Y_AXIS_COLOR"),f),M=pu([0,0,p],[0,0,p+I],void 0,ll.getColor("Z_AXIS_COLOR"),E);let C=l.concatenate(u).concatenate(d).concatenate(g).concatenate(S).concatenate(T).concatenate(M);C&&(Ml[Tl.LINES]=C,Ml[Tl.LINES_FADED]=C.clone());const D=yu(e,o,a,t,i,s,2*Math.PI,n),P=yu(e,0,a,t,i,0,s,r),y=D.concatenate(P);y&&(Ml[Tl.TRIANGLES]=y,Uu(ll.getColor("MATE_CONNECTOR_COLOR"),Ml[Tl.TRIANGLES]),Ml[Tl.COMPARE_BASE_TRIANGLES]=y.clone(),Uu(ll.getColor("MATE_CONNECTOR_COMPARE_BASE_COLOR"),Ml[Tl.COMPARE_BASE_TRIANGLES]),Ml[Tl.COMPARE_TARGET_TRIANGLES]=y.clone(),Uu(ll.getColor("MATE_CONNECTOR_COMPARE_TARGET_COLOR"),Ml[Tl.COMPARE_TARGET_TRIANGLES]),Ml[Tl.TRIANGLES_PRESELECTED]=y.clone(),Uu(ll.getColor("MATE_CONNECTOR_PRE_SELECTED_COLOR"),Ml[Tl.TRIANGLES_PRESELECTED]),Ml[Tl.TRIANGLES_SELECTED]=y.clone(),Uu(ll.getColor("MATE_CONNECTOR_SELECTED_COLOR"),Ml[Tl.TRIANGLES_SELECTED]),Ml[Tl.TRIANGLES_FADED]=y.clone()),Ml[Tl.PICK_DISC]=Mu(e,a,t,ll.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS")),a=ll.getNumber("MATE_CONNECTOR_MINI_DIAMETER_PX")/2,c=ll.getNumber("MATE_CONNECTOR_MINI_STROKE_WIDTH"),l=Cu(e,a,t,ll.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS")),Uu(ll.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),l),Ml[Tl.INFERENCE_POINT_LINES]=l,Ml[Tl.INFERENCE_POINT_TRIANGLES]=yu(e,0,a,t,i,0,2*Math.PI,4*r),Uu(ll.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"),Ml[Tl.INFERENCE_POINT_TRIANGLES]),l=Cu(e,a,t,ll.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS")),Uu(ll.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),l),Hu(c,l),d=pu([-a,0,0],[a,0,0],void 0,ll.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),g=pu([0,-a,0],[0,a,0],void 0,ll.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),C=l.concatenate(d),C=C.concatenate(g),C&&(Ml[Tl.INFERENCE_CENTER_LINES]=C),Ml[Tl.INFERENCE_CENTER_TRIANGLES]=yu(e,0,a,t,i,0,2*Math.PI,4*r),Uu(ll.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"),Ml[Tl.INFERENCE_CENTER_TRIANGLES]),l=Cu(e,a,t,ll.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS")),Uu(ll.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),l),Hu(c,l),d=pu([-a,0,0],[a,0,0],void 0,ll.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),g=pu([0,-a,0],[0,a,0],void 0,ll.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),C=l.concatenate(d).concatenate(g),C&&(Ml[Tl.INFERENCE_CENTROID_LINES]=C);const A=yu(e,0,a,t,i,0,.5*Math.PI,r);Uu(ll.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"),A);const O=yu(e,0,a,t,i,.5*Math.PI,Math.PI,r);Uu(ll.getColor("MATE_CONNECTOR_INFERENCE_DARK_FILL_COLOR"),O);const R=yu(e,0,a,t,i,Math.PI,1.5*Math.PI,r);Uu(ll.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"),R);const w=yu(e,0,a,t,i,1.5*Math.PI,2*Math.PI,r);Uu(ll.getColor("MATE_CONNECTOR_INFERENCE_DARK_FILL_COLOR"),w);const _=A.concatenate(O).concatenate(R).concatenate(w);Ml[Tl.INFERENCE_CENTROID_TRIANGLES]=_;const N=.7071*a,b=pu([-N,-N,0],[N,-N,0],void 0,ll.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),L=pu([-N,N,0],[N,N,0],void 0,ll.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),F=pu([-N,-N,0],[-N,N,0],void 0,ll.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),x=pu([N,-N,0],[N,N,0],void 0,ll.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c);C=b.concatenate(L).concatenate(F).concatenate(x),C&&(Ml[Tl.INFERENCE_MID_POINT_LINES]=C),Ml[Tl.INFERENCE_MID_POINT_TRIANGLES]=zu([-N,-N,0,N,-N,0,N,N,0,-N,N,0],[1,2,0,3],void 0,ll.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"));const B=5*ll.getNumber("MATE_CONNECTOR_AXIS_LINE_LENGTH_PX"),U=2*ll.getNumber("MATE_CONNECTOR_Z_AXIS_LINE_WIDTH"),V=pu([0,0,0],[0,0,B],void 0,ll.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),U),G=pu([0,0,p],[0,0,B],void 0,ll.getColor("MATE_CONNECTOR_SELECTED_COLOR"),U);return Ml[Tl.INFERENCE_ORIGIN_AXIS_LINES]=V,Ml[Tl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED]=G,Object.values(Ml).forEach((function(e){wi(e)})),Ml}function Pl(e){const t=ll.getColor("MATE_CONNECTOR_SELECTED_COLOR");if(e)for(let i=0;i<3;i++)t[i]=e[i];const i=vl();i&&Uu(t,i[Tl.TRIANGLES_SELECTED])}const yl="elementPreviewManager";class Al{constructor(e){this.viewer=e,this.DISPLAY_OCCURRENCE_NAME="ElementPreviewManager",this.GROUP_RANGE_GROUP_ID="elementPreviewGroup",this.nodeOccurrenceNames=[],this.nodeOccurenceIds=[],this.node=new ts(yl),this.meshManager=new zS(this.viewer,{bufferAllocationPolicy:CI.MAXIMUM}),this.displayOccurrenceId=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.DISPLAY_OCCURRENCE_NAME),this.displayOccurrenceData=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(this.displayOccurrenceId),this.displayOccurrenceData.setLod(eg.DEFAULT),this.meshOwnerId=WS(),this.finalSceneBounds=new Li.kB,this.viewer.getModelViewManagers().getManager().getElementPreviewRootNode();this.viewer.getModelViewManagers().getManager().getElementPreviewBodyNode().addChild(this.node)}destroy(){this.node.remove();const e=this.viewer.getOccurrenceDataManager();e.destroyOccurrenceData(this.displayOccurrenceId);for(let t=0;t<this.nodeOccurenceIds.length;++t)e.destroyOccurrenceData(this.nodeOccurenceIds[t]);const t=this.viewer.getOccurrenceIdManager();t.removeName(this.DISPLAY_OCCURRENCE_NAME);for(let e=0;e<this.nodeOccurrenceNames.length;++e)t.removeName(this.nodeOccurrenceNames[e]);this.meshManager.destroy(),this.finalSceneBounds.reset()}readFloat32Array(e){return e?new Float32Array(e.buffer):new Float32Array(0)}readUint32Array(e){return e?new Uint32Array(e.buffer):new Uint32Array(0)}readUint16Array(e){return e?new Uint16Array(e.buffer):new Uint16Array(0)}processGLDisplayData(e){if(!e)return;let t=1,i=1;const s=e.buffers,n=e.nodes;for(let r=0;r<n.length;++r){const a=new fE,o=Ip.cloneAndModify({isPickable:!1,isHighlightable:!1}),h=n[r],c=h.drawables;if(!c||0===c.length)continue;const l=c[0],u=l.attributes,d=u.point>-1?s[e.bufferAccessors[u.point].bufferIndex].data:null;let g=new Array(0);u.point>-1&&(g=e.bufferAccessors[u.point].glDataType===W.hs8.UNSIGNED_SHORT?Array.from(this.readUint16Array(d)):this.readFloat32Array(d));const p=u.normal>-1?s[e.bufferAccessors[u.normal].bufferIndex].data:null,m=new Int8Array(p),f=new Float32Array(m.length);for(let e=0;e<f.length;++e)f[e]=m[e]/127;const I=l.indices>-1?s[e.bufferAccessors[l.indices].bufferIndex].data:null,E=this.readUint32Array(I),S=l.appearance.color,T=zu(g,E,f,[S[0]/255,S[1]/255,S[2]/255,l.appearance.opacity/255]),M=this.GROUP_RANGE_GROUP_ID+t,C=this.meshManager.getOrCreateGroupRangesForGroupTypeAndLod(M,this.meshOwnerId,_i.MX.TRIANGLE_STRIP,eg.DEFAULT);T.id="elementPreviewGraphics_"+t,T.groupId=M,T.lod=eg.DEFAULT,this.meshManager.addMeshIncrement(T,this.meshOwnerId),t+=1;for(let e=0;e<h.transform.length;++e){const t=this.DISPLAY_OCCURRENCE_NAME+i;this.nodeOccurrenceNames.push(t);const s=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.DISPLAY_OCCURRENCE_NAME+i);this.nodeOccurenceIds.push(s);const n=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(s);n.setLod(eg.DEFAULT),n.setTransform(h.transform[e].getGlMatrix()),this.node.addOccurrenceGeometryToNode(o,n,a,C),i+=1}}this.viewer.getModelViewManagers().getManager().getElementPreviewBodyNode().damageBounds()}processGLDisplayDataResponse(e){if(e&&e.hasGLDisplayData){const t=new W.gFF(e.glDisplayDataBytes).readMessage();t.finalSceneBounds&&(this.finalSceneBounds.addPoint(t.finalSceneBounds.minCorner.getVec3()),this.finalSceneBounds.addPoint(t.finalSceneBounds.maxCorner.getVec3())),this.processGLDisplayData(t)}}getModelBounds(){if(this.finalSceneBounds&&this.finalSceneBounds.isInitialized()&&this.finalSceneBounds.isExtensive())return this.finalSceneBounds;{const e=new Li.kB,t=this.viewer.getModelViewManagers().getManager().getElementPreviewBodyNode();return t&&e.addBox(t.getBoundingBox()),e}}}var Ol=i(39687);class Rl{constructor(e,t){this.viewer=t,(0,Ih.Yk)(t),this.imageData=new Ol.TemplatedNestedMap,this.imageDisplays=new Ol.TemplatedNestedMap,this.imageDisplaysByOccurrence=new Ol.TemplatedCountedMap,this.activeSketchIds=new St.StringSet,this.hiddenSketchIds=new St.StringSet,this.usage=e||Ls.L.BASE}processDisplayData(e){this.imageDisplays.eachNested(((t,i,s)=>{const n=this.imageDisplays.getNested(i,s);if(n){if(e.sketchImages.hasOwnProperty(i)&&e.sketchImages[i].hasOwnProperty(s)){const t=e.sketchImages[i][s];if((0,jn.e)(t.sourceId)===n.url&&t.isOnFlat===n.isOnFlat)return}return n.remove(),this.imageDisplays.removeNested(i,s),!1}})),this.imageData.clear(),Object.entries(e.sketchImages).forEach((([e,t])=>{Object.entries(t).forEach((([t,i])=>{this.viewer.getIsForFlattenedDisplay()===i.isOnFlat&&this.imageData.insertNested(e,t,i)}))}))}reset(){this.remove(),this.imageData.clear()}remove(){this.imageDisplays.eachNested((function(e){return e.remove(),!1}),this),this.imageDisplays.clear(),this.imageDisplaysByOccurrence.each((e=>{e.eachNested((e=>{e.remove()}))})),this.imageDisplaysByOccurrence.clear()}removeOccurrence(e){const t=this.imageDisplaysByOccurrence.get(e);t&&(t.eachNested((e=>(e.remove(),!1))),t.clear()),this.imageDisplaysByOccurrence.remove(e)}showPartsWithSheetmetalModelIdOnly(e){const t=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();this.imageData.eachNested(((i,s,n)=>{const r=this.imageDisplays.getNested(s,n);if(r){if(t&&i.isOnFlat){const s=t.getSketchComponent().getSMModelIdForSketch(i.featureId);e!==s||this.hiddenSketchIds.contains(i.featureId)?r.hide():(r.updateImage(i.sourceId,i.bottomLeftCorner.getVec3(),i.bottomRightCorner.getVec3(),i.topLeftCorner.getVec3()),r.show())}return!1}}))}getDisplaysForOccurrence(e){const t=[],i=this.imageDisplaysByOccurrence.get(e);return i?(i.eachNested((e=>{t.push(e)})),t):t}updateDisplaysByOccurrence(e,t,i){var s,n,r;if(0===i.size)return;let a=this.imageDisplaysByOccurrence.get(e);a||(a=new Ol.TemplatedNestedMap,this.imageDisplaysByOccurrence.insert(e,a));const o=new Ol.TemplatedNestedMap;i.forEach((e=>{const t=this.imageData.get(e);t&&o.insert(e,t)}));const h=null===(r=null===(n=null===(s=this.viewer)||void 0===s?void 0:s.getOccurrenceDataManager())||void 0===n?void 0:n.getOccurrenceData(e))||void 0===r?void 0:r.getTransform();o.eachNested(((e,i,s)=>{var n,r,o,c,l;const u=a.getNested(i,s);let d="";if(e.isOnFlat&&(d=null===(l=null===(c=null===(o=null===(r=null===(n=this.viewer)||void 0===n?void 0:n.getModelViewManagers())||void 0===r?void 0:r.getManager())||void 0===o?void 0:o.getDisplayedPartStudio())||void 0===c?void 0:c.getSketchComponent())||void 0===l?void 0:l.getOwnerFlattenedBodyIdForSketch(e.featureId)),u)t.isHidden?u.hide():(u.show(),u.isOnFlat=e.isOnFlat,u.flattenedBodyId=d,u.transform=h,u.updateImage(e.sourceId,e.bottomLeftCorner.getVec3(),e.bottomRightCorner.getVec3(),e.topLeftCorner.getVec3()));else{const n=new Jn(s,e.sourceId,e.bottomLeftCorner.getVec3(),e.bottomRightCorner.getVec3(),e.topLeftCorner.getVec3(),null,this.usage,this.viewer,e.isOnFlat,d,h);n.setIsolated(!1),t.isHidden?n.hide():n.show(),a.insertNested(i,s,n)}return!1}))}updateDisplays(){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();this.imageData.eachNested(((t,i,s)=>{const n=this.imageDisplays.getNested(i,s);let r=ge.create(),a="";if(e&&t.isOnFlat&&(a=e.getSketchComponent().getOwnerFlattenedBodyIdForSketch(t.featureId),a)){const t=e.retrieveBodyMetaData(a);t&&(r=e.getBodyComponent().getTransformFromSheetMetalBodyMetaData(t))}if(n)n.isHidden||(n.isOnFlat=t.isOnFlat,n.flattenedBodyId=a,n.transform=r,n.updateImage(t.sourceId,t.bottomLeftCorner.getVec3(),t.bottomRightCorner.getVec3(),t.topLeftCorner.getVec3()));else{const e=new Jn(s,t.sourceId,t.bottomLeftCorner.getVec3(),t.bottomRightCorner.getVec3(),t.topLeftCorner.getVec3(),null,this.usage,this.viewer,t.isOnFlat,a,r);this.activeSketchIds.contains(i)?e.activate():this.hiddenSketchIds.contains(i)&&e.hide(),this.imageDisplays.insertNested(i,s,e)}return!1}),this)}onSketchHidden(e){this.hiddenSketchIds.add(e),this.imageDisplays.eachNested(((t,i)=>{const s=null==i?void 0:i.split(".");return e===s[0]&&t.hide(),!1}))}onSketchShown(e){this.hiddenSketchIds.remove(e),this.imageDisplays.eachNested(((t,i,s)=>{const n=i.split(".");if(e===n[0]){let e=!0;if(t.isOnFlat){e=!1;const i=this.viewer.getModelViewManagers().getManager(),s=i.getSelectedSheetmetalModelId();if(s){const n=i.getDisplayedPartStudio();if(n){const i=n.retrieveBodyMetaData(t.flattenedBodyId);i&&(e=s===i.sheetMetalModelId)}}}if(e){const e=this.imageData.getNested(i,s);e&&(t.updateImage(e.sourceId,e.bottomLeftCorner.getVec3(),e.bottomRightCorner.getVec3(),e.topLeftCorner.getVec3()),t.show())}}return!1}))}onSketchActivated(e){this.activeSketchIds.contains(e)||(this.imageDisplays.has(e)&&this.imageDisplays.get(e).each(((e,t)=>(e.activate(),!1))),this.activeSketchIds.add(e))}onSketchDeactivated(e){this.activeSketchIds.contains(e)&&(this.imageDisplays.has(e)&&this.imageDisplays.get(e).each(((e,t)=>(e.deactivate(),!1))),this.activeSketchIds.remove(e))}cloneForUsage(e){const t=new Rl(e,this.viewer);return this.imageData.eachNested(((e,i,s)=>(t.imageData.insertNested(i,s,e),!1))),e===Ls.L.PREVIEW&&this.imageDisplays.eachNested(((e,i,s)=>(t.imageDisplays.insertNested(i,s,e.cloneForPreview()),!1))),t}}var wl=i(53544),_l=i(60694);class Nl{constructor(){this.id="",this.imageName="",this.svgToStyle="",this.backgroundColor="rgba(0,0,0,0)",this.index=-1}}class bl{constructor(e,t){this.viewer=e,this.options=t,this.sources=null,this.imageSize=0,this.gridSize=0,this.textureSize=0,this.texture=null,this.canvas=null,(0,Ih.Yk)(e)}destroy(){this.texture&&(this.texture.destroy(),this.texture=null)}getCanvasPosition(e){const t=e%this.gridSize,i=(e-t)/this.gridSize;return[t*this.imageSize,i*this.imageSize]}onReceivedImages(e){this.canvas=document.createElement("canvas"),this.canvas.width=this.textureSize,this.canvas.height=this.textureSize,this.options.debugCanvas&&(this.canvas.style.position="absolute",this.canvas.style.left="0",this.canvas.style.bottom="0",this.canvas.style.zIndex="1000",document.body.append(this.canvas));const t=this.canvas.getContext("2d");t.fillStyle="rgba(0, 0, 0, 0)",t.fillRect(0,0,this.textureSize,this.textureSize),e.forEach(((e,i)=>{const s=this.sources[i],n=this.getCanvasPosition(i);t.fillStyle=s.backgroundColor,t.fillRect(n[0],n[1],this.imageSize,this.imageSize),e&&t.drawImage(e,n[0],n[1],this.imageSize,this.imageSize)})),this.texture=new uo(this.viewer,(e=>{const i=new co(e);if(i.width=this.canvas.width,i.height=this.canvas.height,this.options.clearColorOverride){const e=t.getImageData(0,0,this.canvas.width,this.canvas.height).data;for(let t=0;t<e.length;t+=4)0===e[t+3]&&(e[t]=this.options.clearColorOverride[0],e[t+1]=this.options.clearColorOverride[1],e[t+2]=this.options.clearColorOverride[2],e[t+3]=this.options.clearColorOverride[3]);i.bytes=e}else i.canvas=this.canvas;return i.magnificationFilter=e.LINEAR,i.minificationFilter=e.LINEAR_MIPMAP_LINEAR,i.maxAnisotropy=4,i.useMipmaps=!0,i})),this.texture.setHasTransparency(this.options.sourcesHaveTransparency)}onImageGetFailed(e){}getTextureCoords(e){const t=this.sources.find((t=>t.id===e));if(!t)return null;const i=this.getCanvasPosition(t.index);return{lowS:i[0]/this.textureSize,highS:(i[0]+this.imageSize)/this.textureSize,lowT:i[1]/this.textureSize,highT:(i[1]+this.imageSize)/this.textureSize}}getTextureCoordsOffset(e,t){const i=this.sources.find((t=>t.id===e));if(!i)return null;const s=this.getCanvasPosition(i.index);return{lowS:(s[0]+t)/this.textureSize,highS:(s[0]+this.imageSize-t)/this.textureSize,lowT:(s[1]+t)/this.textureSize,highT:(s[1]+this.imageSize-t)/this.textureSize}}}const Ll="--static",Fl=["--os-icon-accent-cancel","--os-icon-accent-error","--os-icon-fill-tertiary","--os-icon-outline-primary","--os-icon-outline-primary--static"];function xl(e){return fetch(e).then((e=>e.text())).then((e=>function(e){for(let t of Fl){const i=new RegExp(`var\\(${t},[^)]*\\)`);t.endsWith(Ll)&&(t=t.substring(0,t.length-Ll.length));const s=_l.G.getTokenValue(t);e=e.replace(i,s)}return"data:image/svg+xml,"+encodeURIComponent(e)}(e)))}function Bl(e,t,i,s){const n=Math.ceil(Math.sqrt(i.length)),r=(0,Li.cP)(n*t);if(r>e.getMaximumTextureSize()||0===n)return It.log.warn("Attempting to create atlas with bad size. textureSize: "+r+"  gridSize: "+n+" Maximum size: "+e.getMaximumTextureSize()),$r.fcall((()=>null));const a=new bl(e,s);a.sources=[...i],a.gridSize=n,a.imageSize=t,a.textureSize=r;const o=[];return a.sources.forEach(((e,t)=>{e.index=t;const i=$r.defer(),s=new Image;s.onload=function(){i.resolve(s)},s.onerror=function(t){It.log.warn("Error loading texture atlas image data: "+(e.imageName||e.svgToStyle)),i.reject(t)},e.svgToStyle?xl("/images/"+e.svgToStyle).then((e=>{s.src=e})).catch((t=>{It.log.warn("Error loading texture atlas svg: "+e.svgToStyle+"\nError: "+t),i.reject(t)})):s.src="/images/"+e.imageName,o.push(i.promise)})),$r.all(o).then((e=>(a.onReceivedImages(e),a)),(e=>(a.onImageGetFailed(e),null)))}var Ul;!function(e){e.NORMAL="NORMAL",e.ERROR="ERROR",e.SUPPRESSED="SUPPRESSED"}(Ul||(Ul={}));const Vl={NORMAL:"",ERROR:"_Error",SUPPRESSED:"_Suppressed"};var Gl;!function(e){e.NO_HIGHLIGHT="NO_HIGHLIGHT",e.PRE_HIGHLIGHT="PRE_HIGHLIGHT",e.HIGHLIGHT="HIGHLIGHT"}(Gl||(Gl={}));const Hl={NO_HIGHLIGHT_NORMAL:8,NO_HIGHLIGHT_SUPPRESSED:7,NO_HIGHLIGHT_ERROR:6,HIGHLIGHT_NORMAL:5,HIGHLIGHT_SUPPRESSED:4,HIGHLIGHT_ERROR:3,PRE_HIGHLIGHT_NORMAL:2,PRE_HIGHLIGHT_SUPPRESSED:1,PRE_HIGHLIGHT_ERROR:0};class kl{constructor(e,t,i,s,n,r,a){this.atlasId=e,this.viewer=t,this.textures=i,this.pixelSize_=s,this.textureResolutionScales=n,this.textureAtlasOptions=r,this.isDarkModeThemed=a,this.material=Xi(),this.nodeProperties={},this.initializeTextureAtlas(),this.initializeNodeProperties()}onDevicePixelRatioChanged(){this.textureResolutionScales&&this.getTextureResolutionScale(this.lastUsedDevicePixelRatio)!==this.getTextureResolutionScale((0,Es.x_)())&&this.reinitialize()}reinitialize(){this.viewer.getTextureAtlasFactory().clearAtlas(this.atlasId),this.textureAtlas&&(this.textureAtlas.destroy(),this.textureAtlas=null),this.material.ambientTexture=null,this.initializeTextureAtlas(),this.initializeNodeProperties()}destroy(){this.material&&(this.material.destroy(),this.material=null)}get pixelSize(){return this.pixelSize_}get atlasReady(){return!!this.textureAtlas}getNodeProperties(e,t,i){return this.nodeProperties[this.getNodePropertyKey(e,t,i)]}getTextureCoordsOffset(e,t,i,s){return this.textureAtlas.getTextureCoordsOffset(this.getAtlasKey(e,t,i),s)}initializeNodeProperties(){for(const e in Gl)for(const t in Ul)for(let i=Yi.LOWER;i<=Yi.DEFAULT;++i){const s=this.getNodePropertyKey(e,t,i),n=this.getZOffsetKey(e,t);this.nodeProperties[s]=new Qi({primitiveType:_i.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!0,isTwoSided:!0,priority:i,primitivesHaveTransparency:!0,material:this.material,zOffset:Hl[n]})}}initializeTextureAtlas(){this.viewer.getTextureAtlasFactory().getAtlas(this.atlasId,(()=>{const e=[];for(const t in this.textures)for(const i in Ul)for(const s in Gl)e.push(this.createAtlasItem(t,i,s));const t=this.textureAtlasOptions?this.textureAtlasOptions:{};t.sourcesHaveTransparency=!0;let i=this.pixelSize;const s=this.getTextureResolutionScale((0,Es.x_)());return s&&(i*=s),Bl(this.viewer,i,e,t)})).then((e=>{e?(this.textureAtlas=e,this.material.ambientTexture=e.texture,this.viewer.requestDraw()):It.log.warn("Could not load texture atlas")})).catch((e=>{It.log.error(e)}))}getNodePropertyKey(e,t,i){return e+"_"+t+"_"+i}getZOffsetKey(e,t){return e+"_"+t}getAtlasKey(e,t,i){return e+Pn.ID_SEPARATOR+t+Pn.ID_SEPARATOR+i}getAtlasBackgroundColor(e,t){return q.default.getManager().getColorString("GLYPH_"+e+"_"+t+"_BACKGROUND")}getAtlasTextureName(e,t,i){return this.textures[e]+Vl[t]+this.getSystemStateSuffix()+".png"}getTextureResolutionScale(e){let t=null;if(!this.textureResolutionScales)return t;for(let i=0;i<this.textureResolutionScales.length&&(t=this.textureResolutionScales[i],!(t>=e));++i);return t}getSystemStateSuffix(){let e="";if(this.isDarkModeThemed&&(e+="_"+_l.G.getCurrentTheme()),this.textureResolutionScales){const t=(0,Es.x_)(),i=this.getTextureResolutionScale(t);this.lastUsedDevicePixelRatio=t,e+="_"+i+"x"}return e}createAtlasItem(e,t,i){const s=new Nl;return s.id=this.getAtlasKey(e,t,i),s.imageName=this.getAtlasTextureName(e,t,i),s.backgroundColor=this.getAtlasBackgroundColor(t,i),s}}const Wl="GLYPH";class zl extends Ri{constructor(e,t,i,s,n,r,a,o){super(e),this.glyphResources=t,this.textureId=i,this.glyphStateId=s,this.pixelSize=n,this.renderPriority=r,this.worldOrigin=a,this.parent=o}getModelSelection(e){return this.parent?this.parent.getModelSelection(e):null}addHighlight(e){super.addHighlight(e),this.resetGraphics()}removeHighlight(e){return!!super.removeHighlight(e)&&(this.resetGraphics(),!0)}onViewWillDraw(e){this.isHidden||this.hasBeenRemoved||(this.updateGraphics(),this.adjustTransform(e))}setWorldOrigin(e){pe.S4.distanceSquared(this.worldOrigin,e)>bi.W.ZERO_LENGTH_SQUARED&&(this.worldOrigin=e,this.resetGraphics())}onDevicePixelRatioChanged(e){this.isHidden||this.resetGraphics()}get highlightStateId(){const e=this.getHighlight();return e&&e.type===yn.o2.PRE?Gl.PRE_HIGHLIGHT:e?Gl.HIGHLIGHT:Gl.NO_HIGHLIGHT}resetGraphics(){this.removeMeshIncrements(),this.updateGraphics()}updateGraphics(){!this.hasMeshIncrements()&&this.glyphResources.atlasReady&&this.instantiateMeshIncrements()}}class Xl extends zl{constructor(e,t,i,s,n,r,a,o,h,c){super(e,t,i,s,n,r,a,c),this.worldXAxis=o,this.worldYAxis=h}instantiateMeshIncrements(){const e=this.glyphResources.getTextureCoordsOffset(this.textureId,this.glyphStateId,this.highlightStateId,0);if(!e)return;const t="glyphQuad",i=Ou([-.5,0,-.5],[.5,0,-.5],[-.5,0,.5],t,[e.lowS,e.highT],[null==e?void 0:e.highS,null==e?void 0:e.lowT]),s=this.glyphResources.getNodeProperties(this.highlightStateId,this.glyphStateId,this.renderPriority);this.updateMeshIncrement(t,Wl,i,s)}adjustTransform(e){const t=e.getPixelSizeAtWorldPoint(this.worldOrigin)*this.pixelSize*(0,Es.x_)(),i=pe.S4.scale(this.worldYAxis,t,v.create()),s=pe.S4.scale(this.worldXAxis,t,v.create()),n=pe.S4.scale(pe.S4.normalize(pe.S4.cross(i,s,v.create())),t),r=ge.fromValues(s[0],s[1],s[2],0,n[0],n[1],n[2],0,i[0],i[1],i[2],0,this.worldOrigin[0],this.worldOrigin[1],this.worldOrigin[2],1);this.setTransform(r)}}class ql extends zl{constructor(e,t,i,s,n,r,a,o,h){super(e,t,i,s,n,r,a,h),this.originInGlyph=o}instantiateMeshIncrements(){const e=this.glyphResources.getTextureCoordsOffset(this.textureId,this.glyphStateId,this.highlightStateId,0);if(!e)return;const t="quad",i=Ou([-this.originInGlyph[0],0,-this.originInGlyph[1]],[1-this.originInGlyph[0],0,-this.originInGlyph[1]],[-this.originInGlyph[0],0,1-this.originInGlyph[1]],t,[e.lowS,e.highT],[e.highS,e.lowT]);this.updateMeshIncrement(t,Wl,i,this.glyphResources.getNodeProperties(this.highlightStateId,this.glyphStateId,this.renderPriority))}adjustTransformToAlignUp(e,t){const i=e.getPixelSizeAtWorldPoint(this.worldOrigin)*this.pixelSize*(0,Es.x_)(),s=pe.S4.scale(t,i,v.create()),n=pe.S4.scale(pe.S4.normalize(pe.S4.cross(e.getForward(),s,v.create())),i),r=pe.S4.scale(pe.S4.normalize(pe.S4.cross(s,n,v.create())),i),a=ge.fromValues(n[0],n[1],n[2],0,r[0],r[1],r[2],0,s[0],s[1],s[2],0,this.worldOrigin[0],this.worldOrigin[1],this.worldOrigin[2],1);this.setTransform(a)}adjustTransform(e){this.adjustTransformToAlignUp(e,e.getUp())}}class Zl extends ql{constructor(e,t,i,s,n,r,a,o,h,c){super(e,t,i,s,n,r,a,h,c),this.worldDirection=o}adjustTransform(e){this.adjustTransformToAlignUp(e,this.worldDirection)}}const Yl={FASTENED:"mateindicators/MateIndicatorAssets_Fastened",REVOLUTE:"mateindicators/MateIndicatorAssets_Revolute",SLIDER_BASE:"mateindicators/MateIndicatorAssets_Ball",PLANAR_BASE:"mateindicators/MateIndicatorAssets_PlanarCenter",CYLINDRICAL_BASE:"mateindicators/MateIndicatorAssets_Revolute",PIN_SLOT_BASE:"mateindicators/MateIndicatorAssets_PinSlot",PARALLEL_BASE:"mateindicators/MateIndicatorAssets_Parallel",BALL:"mateindicators/MateIndicatorAssets_Ball",ARROW:"mateindicators/MateIndicatorAssets_DirectionArrow",GROUP:"mateindicators/MateIndicatorAssets_Group",TANGENT:"mateindicators/MateIndicatorAssets_Tangent",FIXED:"mateindicators/MateIndicatorAssets_Fixed"},Kl=q.default.getManager(),jl=Kl.getNumber("UNSCALED_MATE_SCREEN_SIZE"),Ql="MateIndicatorComponent";function $l(e){e.getResources().mateIndicatorGlyphResources||(e.getResources().mateIndicatorGlyphResources=new kl(wC,e,Yl,jl*(0,Es.x_)()))}class Jl extends Ri{constructor(e,t,i,s,n){super(s),this.mateConnectorDisplayData=e,this.type=t,this.definition=i,this.occurrenceTransforms=[],this.connectorCoordinateSystems=[],this.worldSpacePositions=[],this.worldSpacePosition=[0,0,0],this.lastScale=-1,this.positionComputed=!1,this.inHiddenMode=!1,$l(this.viewer),this.id=t,this.featureType=mi._.MATE,this.mateType=n,this.listenTo(this,Pi.LONG_PRESS_START+Ql,this.onLongPressStart),this.listenTo(this,Pi.LONG_PRESS_END+Ql,this.onLongPressEnd),this.damageTransform(),this.occurrenceData.setCanIsolateChange(!0),this.occurrenceData.setIsolated(!1)}updateHiddenMode(e){return this.inHiddenMode!==e&&(this.inHiddenMode=e,!0)}updateHideState(){this.isHighlighted()||!this.definition.hidden&&!this.inHiddenMode?(this.hasMeshIncrements()||this.updateGraphics(!0),this.positionComputed||this.computePosition(),this.show()):this.hide()}onLongPressStart(){this.trigger(Pi.LONG_PRESS_START)}onLongPressEnd(){this.trigger(Pi.LONG_PRESS_END)}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.updateGraphics()}removeHighlight(e){return!!super.removeHighlight(e)&&(this.updateHideState(),this.updateGraphics(),!0)}onViewWillDraw(e){this.isHidden||this.hasBeenRemoved||(this.viewer.getIsolatedOccurrenceManager().hasIsolatedInstances()&&this.updateGraphics(),this.adjustTransform(e))}updateIsolation(){let e=1;this.viewer.getIsolatedOccurrenceManager().hasIsolatedInstances()&&!this.occurrenceData.getIsolated()&&(e=Kl.getNumber("ISOLATE_CONTEXT_UI_TRANSPARENCY")*Qe()+(1-Qe()));let t=this.getIncrement();t&&(t=td(t,e),this.updateMeshIncrement(this.type,Ql,t,this.getNodeProperties()))}updateGraphics(e){if(!this.isValid())return;if(!this.definition||this.isHidden&&!e)return void this.removeMeshIncrements();if(!this.glyphResources.atlasReady)return;const t=this.getIncrement();t&&(this.updateMeshIncrement(this.type,Ql,t,this.getNodeProperties()),this.updateIsolation())}getIncrement(){return null}get glyphResources(){return this.viewer.getResources().mateIndicatorGlyphResources}getNodeProperties(){return this.glyphResources.getNodeProperties(this.getHighlightStateId(),this.getMateStateId(),this.getRenderOrderPriority())}getRenderOrderPriority(){return Yi.LOWER}getMateStateId(){return this.definition.status===W.EFx.ERROR?"ERROR":this.definition.status===W.EFx.SUPPRESSED?"SUPPRESSED":"NORMAL"}getHighlightStateId(){const e=this.getHighlight();return e&&e.type===yn.o2.PRE?"PRE_HIGHLIGHT":e?"HIGHLIGHT":"NO_HIGHLIGHT"}getTextureId(){return this.type}isValid(){return!!this.worldSpacePosition}computePosition(){for(let e=0;e<this.mateConnectorDisplayData.length;e++)this.occurrenceTransforms[e]=this.viewer.getModelViewManagers().getManager().getOccurrenceTransform(this.mateConnectorDisplayData[e].occurrence),this.connectorCoordinateSystems[e]=this.mateConnectorDisplayData[e].location,this.worldSpacePositions[e]=pe.w$.multiplyVec3(this.occurrenceTransforms[e],this.connectorCoordinateSystems[e].origin.getVec3(),v.create());this.worldSpacePositions.length>0?this.worldSpacePosition=this.worldSpacePositions[0]:(this.worldSpacePosition=null,this.removeMeshIncrements()),this.positionComputed=!0}causePositionRecompute(){this.lastScale=-1,this.positionComputed=!1,this.isHidden||this.computePosition()}updateMateConnectorDisplayData(e){this.mateConnectorDisplayData=e,this.causePositionRecompute()}getDefinitionOccurrenceIds(){const e=[];for(let t=0;t<this.mateConnectorDisplayData.length;t++)e.push(this.mateConnectorDisplayData[t].occurrence.getPathAsString());return e}getRelatedOccurrences(){const e=[];for(let t=0;t<this.mateConnectorDisplayData.length;t++)e.push(this.mateConnectorDisplayData[t].occurrence);return e}getModelSelection(){if(this.viewer.getIsolatedOccurrenceManager().hasIsolatedInstances()&&!this.occurrenceData.getIsolated())return null;const e=this.getRelatedOccurrences(),t=[];for(let i=0;i<e.length;i++){const s=e[i],n=new ve.Y1(W.lQt.OCCURRENCE,s,s);t.push(n)}for(let e=0;e<this.mateConnectorDisplayData.length;e++){const i=this.mateConnectorDisplayData[e],s=new ve.Y1(W.lQt.MATE_CONNECTOR,i.nodeId,i.ownerOccurrence,{isDerivedFeature:i.isDerivedFeature});t.push(s)}return new ve.Y1(W.lQt.MATE,this.definition.nodeId,this.definition.ownerOccurrence,{featureType:this.featureType,mateType:this.mateType,childSelections:t,isDerivedFeature:this.definition.isDerivedFeature})}adjustTransform(e){if(this.positionComputed||this.computePosition(),!this.isValid())return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition)*(0,Es.x_)();if(Math.abs(this.lastScale-t)<bi.W.ZERO_LENGTH&&this.hasMeshIncrements())return;this.lastScale=t;const i=ge.create();i[0]=t,i[5]=t,i[10]=t,this.setTransform(pe.w$.rotateX(pe.w$.multiply(pe.w$.multiply(this.occurrenceTransforms[0],this.connectorCoordinateSystems[0].getGlMatrix(),ge.create()),i),-Math.PI/2)),this.hasMeshIncrements()||this.updateGraphics()}damageTransform(){this.lastScale=-1,this.connectorCoordinateSystems[0]&&pe.w$.multiplyVec3(this.occurrenceTransforms[0],this.connectorCoordinateSystems[0].origin.getVec3(),this.worldSpacePosition),(0,Js.vm)()}}class eu extends Jl{constructor(e,t,i,s,n){super(e,t,i,s,n)}getIncrement(){const e=this.glyphResources.getTextureCoordsOffset(this.getTextureId(),this.getMateStateId(),this.getHighlightStateId(),.5);return Ou([-jl/2,0,-jl/2],[jl/2,0,-jl/2],[-jl/2,0,jl/2],void 0,[e.lowS,e.highT],[e.highS,e.lowT])}}class tu extends Jl{constructor(e,t,i,s,n,r){super(e,"ARROW",t,n,r),this.rotationAngle=i,this.rotationAxis=s}getIncrement(){const e=this.glyphResources.getTextureCoordsOffset(this.getTextureId(),this.getMateStateId(),this.getHighlightStateId(),1);return Ou([0,0,-jl/4],[jl,0,-jl/4],[0,0,jl/4],void 0,[e.lowS,e.highT],[e.highS,e.lowT])}adjustTransform(e){if(this.positionComputed||this.computePosition(),!this.isValid())return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition)*(0,Es.x_)();if(Math.abs(this.lastScale-t)<bi.W.ZERO_LENGTH&&this.hasMeshIncrements())return;this.lastScale=t;const i=ge.create();i[0]=t,i[5]=t,i[10]=t;const s=pe.w$.multiply(pe.w$.multiply(this.occurrenceTransforms[0],this.connectorCoordinateSystems[0].getGlMatrix(),ge.create()),i),n=pe.w$.rotate(s,this.rotationAngle,this.rotationAxis);this.setTransform(n),this.hasMeshIncrements()||this.updateGraphics()}getHighlightStateId(){return"NO_HIGHLIGHT"}getRenderOrderPriority(){return Yi.DEFAULT}}class iu extends eu{constructor(e,t,i){super([],"GROUP",t,i),this.occurrenceDisplayData=e,this.featureType=mi._.MATE_GROUP}getDefinitionOccurrenceIds(){return this.definition.getOccurrenceIds()}getRelatedOccurrences(){const e=[];for(let t=0;t<this.occurrenceDisplayData.length;t++)e.push(this.occurrenceDisplayData[t].occurrenceData.occurrence);return e}computePosition(){if(!this.occurrenceDisplayData)return;let e=null;const t=this.viewer.getModelViewManagers().getManager();for(let i=0;i<this.occurrenceDisplayData.length;i++){const s=this.occurrenceDisplayData[i].occurrenceData.occurrence;this.occurrenceTransforms[i]=t.getOccurrenceTransform(s),this.connectorCoordinateSystems[i]=W.em5.createValidDefault(),this.worldSpacePositions[i]=pe.w$.multiplyVec3(this.occurrenceTransforms[i],this.connectorCoordinateSystems[i].origin.getVec3(),v.create());const n=t.getOccurrenceBounds(s);n&&n.isFinite()&&(e||(e=new Li.kB),e.addBox(n))}if(this.worldSpacePositions.length>0&&e){const t=e.center();this.connectorCoordinateSystems[0].origin.updateFromArray(pe.S4.subtract(t,this.worldSpacePositions[0])),this.worldSpacePosition=t}else this.worldSpacePosition=null,this.removeMeshIncrements();this.positionComputed=!0}updateOccurenceDisplayData(e){this.occurrenceDisplayData=e,this.causePositionRecompute()}}class su extends eu{constructor(e,t,i){super([],t,e,i),this.featureType=mi._.GEOMETRY_MATE}computePosition(){const e=this.definition;e&&e.location?this.worldSpacePosition=e.location.origin.getVec3():(this.worldSpacePosition=null,this.removeMeshIncrements()),this.positionComputed=!0}updateDefinition(e){this.definition=e,this.causePositionRecompute()}getDefinitionOccurrenceIds(){const e=this.getRelatedOccurrences(),t=[];return e.forEach((function(e){t.push(e.getPathAsString())})),t}getRelatedOccurrences(){const e=[],t=this.definition;return t&&(t.firstOccurrence&&e.push(t.firstOccurrence),t.secondOccurrence&&e.push(t.secondOccurrence)),e}adjustTransform(e){if(this.positionComputed||this.computePosition(),!this.isValid())return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition)*(0,Es.x_)();if(Math.abs(this.lastScale-t)<bi.W.ZERO_LENGTH&&this.hasMeshIncrements())return;this.lastScale=t;const i=ge.create();i[0]=t,i[5]=t,i[10]=t;const s=this.definition;this.setTransform(pe.w$.rotateX(pe.w$.multiply(s.location.getGlMatrix(),i),-Math.PI/2)),this.hasMeshIncrements()||this.updateGraphics()}}class nu extends eu{constructor(e,t,i){super([],"FIXED",new W.iYR(!0),i),this.occurrenceDisplayData=[],this.connectorCoordinateSystems[0]=W.em5.createValidDefault();const s=this.viewer.retrieveCanvasLocationWorldPosition(t);if(s)this.worldSpacePosition=s,this.connectorCoordinateSystems[0].origin.updateFromArray(s);else{const t=this.viewer.getModelViewManagers().getManager().getOccurrenceBounds(e);if(t&&t.isFinite()){const e=new Li.kB;e.addBox(t);const i=e.center();this.worldSpacePosition=i,this.connectorCoordinateSystems[0].origin.updateFromArray(i)}}this.occurrenceTransforms[0]=ge.create()}computePosition(){this.positionComputed=!0}}const ru=new Qi({primitiveType:_i.MX.POINTS,isPickable:!1,isShowThrough:!0,isDepthTested:!1});class au extends Ri{constructor(e,t,i,s,n,r){super(n,t),this.position=e,this.increment=Su([0,0,0],"point",i,s),this.updatePosition(e),this.nodeProperties=ru,r&&(this.nodeProperties=r),this.updateGraphics()}updatePosition(e){if(e){this.position=e;const t=ge.create();t[12]=this.position[0],t[13]=this.position[1],t[14]=this.position[2],this.setTransform(t)}}setStyle(e){ku(e,this.increment),this.updateGraphics()}updateGraphics(){this.updateMeshIncrement(au.INCREMENT_ID,"pointElementSelection",this.increment,this.nodeProperties)}addHighlight(e){super.addHighlight(e),this.addHighlightToIncrement("pointElement",e),this.highlight=e}removeHighlight(e){return!!e&&(this.removeHighlightFromIncrement("pointElement",e),!!super.removeHighlight(e))}}au.INCREMENT_ID="pointElement";class ou{constructor(e,t,i){this.usage=e,this.elementId=t,this.viewer=i}processDisplayData(e){for(const e in this.annotationIdToUIElementMap)if(e&&e.length>0){this.annotationIdToUIElementMap[e].remove()}this.annotationIdToUIElementMap={};const t=e.annotationsForElement;if(!t)return;const i=t.annotationIdToDisplayObject;if(i){for(const e in i)if(e&&e.length>0){let t;const s=i[e];if(s.getAnnotationType()===W.pLb.DATUM)t=new ud(this.viewer),this.annotationIdToUIElementMap[e]=t;t.processDisplayData(e,s)}this.viewer.requestDraw()}}}class hu extends Ri{constructor(e){super(e),this.viewer=e}processDisplayData(e,t){}}function cu(e,t){const i=[];for(let t=0;t<e.indices.length-2;t++)e.indices[t+2]!==e.indices[t+1]&&e.indices[t+1]!==e.indices[t]&&(i.push(e.indices[t]),i.push(e.indices[t+1]),i.push(e.indices[t]),i.push(e.indices[t+2]),i.push(e.indices[t+1]),i.push(e.indices[t+2]));return new jE(_i.MX.LINES,e.points,i,t)}function lu(e,t){if(e.primitiveType!==_i.MX.TRIANGLES)throw new Error("createEdgesFromTriangles can only be called with triangle primitives");const i=[];for(let t=0;t<e.indices.length;t+=3)i.push(e.indices[t]),i.push(e.indices[t+1]),i.push(e.indices[t]),i.push(e.indices[t+2]),i.push(e.indices[t+1]),i.push(e.indices[t+2]);return new jE(_i.MX.LINES,e.points,i,t)}function uu(e,t){t||(t=12),e||(e=12);const i=[],s=[],n=[],r=function(e,t,n){i.push(e),i.push(t),i.push(n),s.push(e),s.push(t),s.push(n)};let a,o;for(r(0,0,1),a=0;a<t;a++){const i=a*Math.PI*2/t,s=Math.cos(i),n=Math.sin(i);for(o=1;o<=e;o++){const t=o*Math.PI/(e+1),i=Math.sin(t);r(i*s,i*n,Math.cos(t))}}r(0,0,-1);const h=function(i,s){return e*(s%t)+i+1},c=function(){n.push(n[n.length-1])};for(a=0;a<t;a++){for(n.length>1&&c(),n.push(0),o=0;o<e;o++)n.push(h(o,a)),n.push(h(o,a+1));n.push(e*t+1),c(),n.length%2==0&&c()}return zu(i,n,s)}function du(e){(!e||e<3)&&(e=12);const t=[],i=[],s=[],n=function(e){const s=Math.cos(e),n=Math.sin(e);t.push(s),t.push(n),t.push(1),i.push(s),i.push(n),i.push(0),t.push(s),t.push(n),t.push(0),i.push(s),i.push(n),i.push(0)};let r,a;for(r=0;r<e;r++)a=2*Math.PI*r/e,n(a);for(r=0;r<e;r++)s.push(2*r),s.push(2*r+1);return s.push(0),s.push(1),zu(t,s,i)}function gu(e){(!e||e<3)&&(e=12);const t=[],i=[],s=[],n=function(e){const s=Math.cos(e),n=Math.sin(e),r=[s,n,1];pe.S4.normalize(r),t.push(0),t.push(0),t.push(1),i.push(r[0]),i.push(r[1]),i.push(r[2]),t.push(s),t.push(n),t.push(0),i.push(r[0]),i.push(r[1]),i.push(r[2])};let r,a;for(r=0;r<e;r++)a=2*Math.PI*r/e,n(a);for(r=0;r<e;r++)s.push(2*r),s.push(2*r+1);return s.push(0),s.push(1),zu(t,s,i)}function pu(e,t,i,s,n,r){const a=[e[0],e[1],e[2],t[0],t[1],t[2]],o=new jE(_i.MX.LINES,a,[0,1],i);return s&&Uu(s,o),void 0!==n&&Hu(n,o),r&&ku(r,o),o}function mu(e,t,i,s,n,r){e.addIncrement(pu(t,i,s,n,r))}function fu(e,t,i,s){const n=new Float32Array(3*e.length),r=new Int32Array(2*e.length);for(let t=0;t<e.length;++t){for(let i=0;i<3;++i)n[3*t+i]=e[t][i];r[2*t]=t,r[2*t+1]=(t+1)%e.length}const a=new jE(_i.MX.LINES,n,r,t);return i&&Uu(i,a),void 0!==s&&Hu(s,a),a}function Iu(e,t,i,s,n){const r=new Float32Array(3*e.length),a=new Int32Array(e.length);for(let t=0;t<e.length;++t){a[t]=t;for(let i=0;i<3;++i)r[3*t+i]=e[t][i]}const o=new jE(_i.MX.LINES,r,a,t);return i&&Uu(i,o),void 0!==s&&Hu(s,o),n&&ku(n,o),o}function Eu(e,t,i,s,n){e.addIncrement(Iu(t,i,s,n))}function Su(e,t,i,s,n){const r=new jE(_i.MX.POINTS,e,[0],t);return i&&Uu(i,r),void 0!==s&&Hu(s,r),n&&ku(n,r),r}function Tu(e,t,i,s,n,r,a){let o=n;o||(o=v.fromValues(1,0,0),(0,Sr.areUnitVectorsParallel)(i,o)&&(o=[0,1,0]));const h=pe.S4.normalize(pe.S4.cross(i,o,v.create()));o=pe.S4.normalize(pe.S4.cross(h,i,v.create())),void 0===r&&(r=0),void 0===a&&(a=2*Math.PI);const c=new Float32Array(3*(s+1));let l=r;const u=(a-r)/s,d=v.create(),g=v.create(),p=v.create();for(let i=0;i<s+1;++i){const s=t*Math.cos(l),n=t*Math.sin(l);pe.S4.add(e,pe.S4.add(pe.S4.scale(h,n,g),pe.S4.scale(o,s,p),d),d);for(let e=0;e<3;++e)c[3*i+e]=d[e];l+=u}return c}function Mu(e,t,i,s){const n=Tu(e,t,i,s=Math.floor(Math.max(3,s)));let r;const a=n.length/3,o=new Float32Array(3*a);for(r=0;r<a;++r)for(let e=0;e<3;++e)o[3*r+e]=i[e];const h=s-2,c=new Int32Array(3*h);for(r=0;r<h;++r)c[3*r]=0,c[3*r+1]=r+1,c[3*r+2]=r+2;const l=new jE(_i.MX.TRIANGLES,n,c);return l.normals=o,l}function Cu(e,t,i,s){const n=Tu(e,t,i,s=Math.floor(Math.max(3,s)));let r;const a=new Int32Array(2*s);for(r=0;r<s;++r)a[2*r]=r,a[2*r+1]=r+1;return a[a.length-1]=0,new jE(_i.MX.LINES,n,a)}function Du(e,t,i,s,n,r,a){const o=Tu(e,t,i,a=Math.floor(Math.max(3,a)),s,n,r),h=new Int32Array(2*a);for(let e=0;e<a;++e)h[2*e]=e,h[2*e+1]=e+1;return new jE(_i.MX.LINES,o,h)}function vu(e,t,i,s,n,r){const a=e,o=pe.S4.add(pe.S4.scale(t,s,v.create()),a),h=pe.S4.add(pe.S4.scale(t,n,v.create()),o),c=pe.S4.add(pe.S4.scale(i,-r,v.create()),o),l=pe.S4.add(pe.S4.scale(i,r,v.create()),o);return Iu([a,o,c,l,c,h,l,h])}function Pu(e,t,i,s,n,r){const a=e,o=pe.S4.scale(t,.5*n,v.create()),h=pe.S4.add(pe.S4.scale(t,s,v.create()),a),c=pe.S4.add(o,h,v.create()),l=pe.S4.add(pe.S4.scale(i,-r,v.create()),h),u=pe.S4.add(pe.S4.scale(i,r,v.create()),h),d=pe.S4.add(pe.S4.scale(t,n,v.create()),h),g=pe.S4.add(l,o,v.create()),p=pe.S4.add(u,o,v.create());return Iu([a,h,l,u,l,c,u,c,g,p,g,d,p,d])}function yu(e,t,i,s,n,r,a,o){o=Math.floor(Math.max(3,o));const h=(0,Js.Mz)(Tu(e,t,s,o,n,r,a),Tu(e,i,s,o,n,r,a)),c=o+1,l=new Int32Array(2*c);for(let e=0;e<c;++e)l[2*e]=e,l[2*e+1]=c+e;const u=new jE(_i.MX.TRIANGLE_STRIP,h,l);return xu(s,u),u}function Au(e,t,i,s,n,r,a){const o=pe.S4.subtract(t,e,v.create()),h=pe.S4.subtract(i,e,v.create()),c=pe.S4.normalize(pe.S4.cross(o,h,v.create())),l=new Float32Array(9),u=new Float32Array(9),d=function(e,t){for(let i=0;i<3;++i)l[3*e+i]=t[i],u[3*e+i]=c[i]};let g;if(d(0,e),d(1,t),d(2,i),n&&r&&a){g=new Float32Array(6);const e=function(e,t,i){g[2*e]=t,g[2*e+1]=i};e(0,n[0],n[1]),e(1,r[0],r[1]),e(2,a[0],a[1])}const p=new jE(_i.MX.TRIANGLES,l,[0,1,2],s);return p.normals=u,p.textureCoordinates=g||null,p}function Ou(e,t,i,s,n,r){const a=pe.S4.subtract(t,e,v.create()),o=pe.S4.subtract(i,e,v.create()),h=pe.S4.normalize(pe.S4.cross(a,o,v.create())),c=new Float32Array(12),l=new Float32Array(12),u=function(e,t){for(let i=0;i<3;++i)c[3*e+i]=t[i],l[3*e+i]=h[i]};let d;if(u(0,e),u(1,t),u(2,pe.S4.add(t,o,v.create())),u(3,i),n&&r){d=new Float32Array(8);const e=function(e,t,i){d[2*e]=t,d[2*e+1]=i};e(0,n[0],n[1]),e(1,r[0],n[1]),e(2,r[0],r[1]),e(3,n[0],r[1])}const g=new jE(_i.MX.TRIANGLES,c,[0,1,2,0,2,3],s);return g.normals=l,g.textureCoordinates=d||null,g}function Ru(e,t,i,s,n){const r=pe.S4.add(e,pe.S4.scale(t,-1,v.create()),v.create());pe.S4.add(r,i);const a=pe.S4.add(r,pe.S4.scale(t,2,v.create()),v.create()),o=pe.S4.add(r,pe.S4.scale(i,-2,v.create()),v.create()),h=pe.S4.add(a,pe.S4.scale(i,-2,v.create()),v.create());return Iu([r,o,o,h,h,a,a,r],"outlineLines",s,n)}function wu(e,t,i,s,n,r){const a=pe.S4.subtract(t,e,v.create()),o=pe.S4.subtract(i,e,v.create()),h=pe.S4.length(a),c=pe.S4.length(o);pe.S4.normalize(a),pe.S4.normalize(o);const l=pe.S4.normalize(pe.S4.cross(a,o,v.create())),u=pe.S4.add(pe.S4.scale(a,h,v.create()),pe.S4.scale(o,c,v.create())),d=pe.S4.add(e,u,v.create()),g=(pe.S4.add(pe.S4.scale(u,.5,v.create()),e),pe.S4.add(pe.S4.add(pe.S4.scale(a,s,v.create()),pe.S4.scale(o,s,v.create())),e)),p=pe.S4.add(pe.S4.add(pe.S4.scale(a,-s,v.create()),pe.S4.scale(o,s,v.create())),t),m=pe.S4.add(pe.S4.add(pe.S4.scale(a,s,v.create()),pe.S4.scale(o,-s,v.create())),i),f=pe.S4.add(pe.S4.add(pe.S4.scale(a,-s,v.create()),pe.S4.scale(o,-s,v.create())),d),I=4*(n+1),E=new Float32Array(3*I),S=new Float32Array(3*I);let T=0;const M=function(e,t){for(let i=0;i<3;++i)E[3*e+i]=t[i],S[3*e+i]=l[i]},C=function(e,t,i){const r=Tu(e,s,l,n,a,t,i);for(let e=0;e<r.length/3;++e)M(T++,[r[3*e],r[3*e+1],r[3*e+2]])};C(p,-Math.PI/2,0),C(f,0,Math.PI/2),C(m,Math.PI/2,Math.PI),C(g,-Math.PI,-Math.PI/2);const D=[];for(let e=1;e<I-1;++e)D.push(0),D.push(e),D.push(e+1);const P=new jE(_i.MX.TRIANGLES,E,D,r);return P.normals=S,P}const _u=[0,1,2,3,3,4,4,5,6,7,7,8,8,9,10,11,11,12,12,13,14,15,15,16,16,17,18,19,19,20,20,21,22,23],Nu=[-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1];function bu(e,t){const i=new Float32Array(72);let s=0;const n=new Float32Array(3),r=function(r,a){n[r]=a?t[r]:e[r];const o=0===r?2:1===r?0:1,h=0===r?1:1===r?2:0;for(let r=0;r<2;++r)for(let c=0;c<2;++c)n[o]=a!==(0===c)?e[o]:t[o],n[h]=0===r?e[h]:t[h],i.set(n,4*s*3+3*(2*r+c));++s};r(0,!1),r(0,!0),r(1,!1),r(1,!0),r(2,!1),r(2,!0);const a=new jE(_i.MX.TRIANGLE_STRIP,i,_u);return a.normals=Nu,a}function Lu(e,t){const i=[],s=[e,t];for(let e=0;e<2;e++)for(let t=0;t<2;t++)for(let n=0;n<2;n++)i.push(v.fromValues(s[e][0],s[t][1],s[n][2]));const n=[];for(let e=0;e<i.length;e++)for(let t=e+1;t<i.length;t++){const s=i[e],r=i[t],a=s[0]===r[0],o=s[1]===r[1],h=s[2]===r[2];(a&&o||a&&h||o&&h)&&(n.push(s),n.push(r))}return Iu(n)}function Fu(e,t,i,s,n,r,a){e.addIncrement(Ou(t,i,s,n,r,a))}function xu(e,t){const i=t.vertexCount(),s=new Float32Array(3*i);for(let t=0;t<i;++t)for(let i=0;i<3;++i)s[3*t+i]=e[i];t.normals=s}function Bu(e,t){const i=t.vertexCount(),s=new Float32Array(2*i);for(let t=0;t<i;++t)for(let i=0;i<2;++i)s[2*t+i]=e[i];t.textureCoordinates=s}function Uu(e,t){const i=[255,255,255,255];for(let t=0;t<4&&t<e.length;++t)i[t]=255*e[t];Vu(i,t)}function Vu(e,t){const i=t.vertexCount(),s=new Uint8Array(4*i);let n;if(4===e.length){for(n=0;n<i;++n)for(let t=0;t<4;++t)s[4*n+t]=e[t];t.colors=s}else It.log.warn("Tried to add a color with the wrong number of channels to a mesh increment")}function Gu(e,t){Vu((0,Js.fA)(e),t)}function Hu(e,t){const i=t.vertexCount(),s=new Float32Array(i);for(let t=0;t<i;++t)s[t]=e;t.primitiveSizes=s}function ku(e,t){const i=t.vertexCount(),s=new Uint8Array(Jd.PRIMITIVE_STYLE.dimension*i);let n;const r=[];for(n=0;n<Jd.PRIMITIVE_STYLE.dimension;++n)n<e.length?r.push((0,Li.uZ)(Math.round(e[n]),0,255)):r.push(0);for(n=0;n<i;++n)for(let e=0;e<Jd.PRIMITIVE_STYLE.dimension;++e)s[n*Jd.PRIMITIVE_STYLE.dimension+e]=r[e];t.primitiveStyles=s}function Wu(e,t,i,s){const n=new jE(_i.MX.TRIANGLES,e,t,i);return s&&Uu(s,n),n}function zu(e,t,i,s){const n=new jE(_i.MX.TRIANGLE_STRIP,e,t);return i&&(n.normals=i),s&&Uu(s,n),n}function Xu(e){return e.toFixed(10).slice(0,12)}function qu(e){return Zu(e[0],e[1],e[2])}function Zu(e,t,i){return Xu(e)+"_"+Xu(t)+"_"+Xu(i)}let Yu={},Ku=1;function ju(e,t){let i=v.dot(e,t);i<0&&(i=-i,t=v.fromValues(-t[0],-t[1],-t[2]));const s=qu(t)+"_"+Xu(i);return Yu[s]||(Yu[s]=Ku,Ku=Math.max((Ku+1)%24,1)),Yu[s]}function Qu(e,t){return $u(ju(e,t))}function $u(e){const t=(0,Js.fA)(1<<e);return t[1]<<8|t[2]<<16|t[3]<<24}function Ju(e){const t=$u(e),i=(0,Js.fA)(t);return(0,Js.zF)(i)}function ed(){Yu={},Ku=1}function td(e,t){const i=e.vertexCount(),s=new Uint8Array(4*i);let n,r;for(n=0;n<i;++n)for(let i=0;i<4;++i)r=4*n+i,e.colors?s[r]=e.colors[r]:s[r]=255,(r+1)%4==0&&(s[r]=255*t);return e.colors=s,e}function id(e){if(e.primitiveType!==_i.MX.TRIANGLES)return;const t=new Float32Array(3*e.indices.length),i=new Int32Array(e.indices.length),s=new Float32Array(3*e.indices.length),n=v.create(),r=v.create();for(let a=0;a<i.length;a+=3){i[a]=a;const o=e.getPoint(e.indices[a],t.subarray(3*a));i[a+1]=a+1;const h=e.getPoint(e.indices[a+1],t.subarray(3*(a+1)));i[a+2]=a+2;const c=e.getPoint(e.indices[a+2],t.subarray(3*(a+2))),l=v.cross(s.subarray(3*a),v.normalize(n,v.subtract(n,h,o)),v.normalize(r,v.subtract(r,c,o)));v.copy(s.subarray(3*(a+1)),l),v.copy(s.subarray(3*(a+2)),l)}e.points=t,e.indices=i,e.normals=s}var sd=i(8008);const nd=q.default.getManager(),rd=new Qi({isPickable:!1,primitiveType:_i.MX.LINES}),ad="annotationPlane";class od extends Ri{constructor(e){super(e),this.viewer=e,this.coordinateSystem_=null,this.coordinateSystem_=sd.e.createValidDefault()}setCoordinateSystem(e){this.coordinateSystem_=e}getCoordintateSystem(){return this.coordinateSystem_}createPlaneCoordinateSystem(e,t,i){const s=1e-6;let n=v.dot(t,i);Math.abs(Math.abs(n)-1)<s&&(i[0]=0,i[1]=1,i[2]=0),n=v.dot(t,i),Math.abs(Math.abs(n)-1)<s&&(i[0]=1,i[1]=0,i[2]=0),n=v.dot(t,i),Math.abs(Math.abs(n)-1)<s&&(i[0]=0,i[1]=0,i[2]=1);const r=v.cross(v.create(),t,i),a=ge.create();ge.identity(a),a[0]=r[0],a[1]=r[1],a[2]=r[2],a[4]=t[0],a[5]=t[1],a[6]=t[2],a[8]=i[0],a[9]=i[1],a[10]=i[2],a[12]=e[0],a[13]=e[1],a[14]=e[2];const o=sd.e.fromGlMatrix(a);this.coordinateSystem_=o}showCoordinatesOnScreen(e){const t=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),n=new Float32Array(3);t[0]=e.origin.x,t[1]=e.origin.y,t[2]=e.origin.z,i[0]=t[0]+.05*e.xAxis.x,i[1]=t[1]+.05*e.xAxis.y,i[2]=t[2]+.05*e.xAxis.z,s[0]=t[0]+.05*e.yAxis.x,s[1]=t[1]+.05*e.yAxis.y,s[2]=t[2]+.05*e.yAxis.z,n[0]=t[0]+.05*e.zAxis.x,n[1]=t[1]+.05*e.zAxis.y,n[2]=t[2]+.05*e.zAxis.z;const r=nd.getStipple("DEFAULT_LINE_STIPPLE"),a=[];a.push(t),a.push(i);let o="PlaneSystem_X";const h=Iu(a,o,[128,0,0],1,r);this.updateMeshIncrement(o,ad,h,rd);const c=[];c.push(t),c.push(s),o="PlaneSystem_Y";const l=Iu(c,o,[0,128,0],1,r);this.updateMeshIncrement(o,ad,l,rd);const u=[];u.push(t),u.push(n),o="PlaneSystem_Z";const d=Iu(u,o,[0,0,128],1,r);this.updateMeshIncrement(o,ad,d,rd)}}const hd=q.default.getManager(),cd=new Qi({isPickable:!1,primitiveType:_i.MX.LINES});class ld{constructor(e,t){this.annotationElement=e,this.annotationDisplayData=t}processDisplayData(e,t){const i=hd.getColor("ANNOTATION_DEFAULT_COLOR"),s=hd.getNumber("ANNOTATION_LINE_WIDTH"),n=hd.getStipple("DEFAULT_LINE_STIPPLE"),{points:r,outPoint:a}=this.createTrianglePoints(e),o="_baseTriangle",h=Iu(r,o,i,s,n);return this.annotationElement.updateMeshIncrement(o,"baseDisplayTriangle",h,cd),a}createTrianglePoints(e){const t=[],i=e.xAxis,s=e.yAxis,n=e.origin,r=v.create(),a=v.create(),o=v.create();r[0]=-.002*i.x,r[1]=-.002*i.y,r[2]=-.002*i.z,a[0]=.004*s.x,a[1]=.004*s.y,a[2]=.004*s.z,o[0]=.002*i.x,o[1]=.002*i.y,o[2]=.002*i.z,r[0]=r[0]+n.x,r[1]=r[1]+n.y,r[2]=r[2]+n.z,a[0]=a[0]+n.x,a[1]=a[1]+n.y,a[2]=a[2]+n.z,o[0]=o[0]+n.x,o[1]=o[1]+n.y,o[2]=o[2]+n.z,t.push(r),t.push(a),t.push(a),t.push(o),t.push(o),t.push(r);let h=v.create();return h=a,{points:t,outPoint:h}}}class ud extends hu{constructor(e){super(e),this.viewer=e}processDisplayData(e,t){const i=new ld(this,t),s=new Id(this,t),n=new pd(this,t);let r=v.copy(v.create(),t.basePoint);const a=v.copy(v.create(),t.baseNormal),o=t.annotationPlane,h=new od(this.viewer);h.createPlaneCoordinateSystem(r,a,o);const c=h.getCoordintateSystem();r=i.processDisplayData(c,r),r=s.processDisplayData(c,r),n.processDisplayData(c,r)}}const dd=q.default.getManager(),gd=new Qi({isPickable:!1,primitiveType:_i.MX.LINES});class pd{constructor(e,t){this.annotationElement=e,this.annotationDisplayData=t}processDisplayData(e,t){const i=dd.getColor("ANNOTATION_DEFAULT_COLOR"),s=dd.getNumber("ANNOTATION_LINE_WIDTH"),n=dd.getStipple("DEFAULT_LINE_STIPPLE"),{points:r,outPoint:a}=this.createBoxPoints(e,t),o="_detailEnd",h=Iu(r,o,i,s,n);return this.annotationElement.updateMeshIncrement(o,"detailDisplayBox",h,gd),a}createBoxPoints(e,t){const i=[],s=e.xAxis,n=e.yAxis,r=(e.origin,v.create()),a=v.create(),o=v.create(),h=v.create();r[0]=t[0]+-.002*s.x,r[1]=t[1]+-.002*s.y,r[2]=t[2]+-.002*s.z,a[0]=r[0]+.004*n.x,a[1]=r[1]+.004*n.y,a[2]=r[2]+.004*n.z,o[0]=a[0]+.004*s.x,o[1]=a[1]+.004*s.y,o[2]=a[2]+.004*s.z,h[0]=o[0]-.004*n.x,h[1]=o[1]-.004*n.y,h[2]=o[2]-.004*n.z,i.push(r),i.push(a),i.push(a),i.push(o),i.push(o),i.push(h),i.push(h),i.push(r);let c=v.create();return c=a,{points:i,outPoint:c}}}const md=q.default.getManager(),fd=new Qi({isPickable:!1,primitiveType:_i.MX.LINES});class Id{constructor(e,t){this.annotationElement=e,this.annotationDisplayData=t}processDisplayData(e,t){const i=md.getColor("ANNOTATION_DEFAULT_COLOR"),s=md.getNumber("ANNOTATION_LINE_WIDTH"),n=md.getStipple("DEFAULT_LINE_STIPPLE"),r=this.annotationDisplayData.baseNormal,a=v.create();a[0]=t[0]+.025*r[0],a[1]=t[1]+.025*r[1],a[2]=t[2]+.025*r[2];const o="_leader",h=pu(t,a,o,i,s,n);return this.annotationElement.updateMeshIncrement(o,yi,h,fd),a}}const Ed=q.default.getManager(),Sd=new Qi({primitiveType:_i.MX.POINTS,isPickable:!0,isShowThrough:!0,isDepthTested:!1});class Td extends au{constructor(e,t,i,s){super(Td.getEdgePointLocation(s,t,i),e,Ed.getColor("POINT_BODY_COLOR"),Ed.getNumber("POINT_BODY_SIZE"),s,Sd),this.parameter=i,this.selectionId=t.selectionId;let n=Td.getEdgePointLocation(s,t,i);const r=t.getEntityMetaData();if(this.entityMetaData=r.clone(),this.entityMetaData.setBodyMetaData(r.getBodyMetaData()),n){const e=new W.DT1;e.point=new Float32Array(3);for(let t=0;t<3;++t)e.point[t]=n[t];this.entityMetaData.geometries=[e]}else if(1===r.geometries.length&&r.geometries[0]instanceof W.DT1){const e=r.geometries[0];n=v.clone(e.point),this.entityMetaData.geometries=r.geometries}this.setStyle(Ed.getPointFont("POINT_BODY_FONT")),n&&this.show()}static getEdgePointLocation(e,t,i){let s=null;const n=t.getEntityMetaData();let r=null;if(e.getIsForPreviousVersionDisplay()?r=e.getModelViewManagers().getManager().extractMeshIncrement(t.getDeterministicId()):n&&(r=n.getMeshIncrement()),!r&&n.isFromSketch()&&(r=e.getModelViewManagers().getManager().extractMeshIncrement(t.getDeterministicId())),r){s=v.create();const a=r.getLinesLength(),o=r.getPositionAtDistanceAlongLines(a*i),h=e.getModelViewManagers().getManager().getDisplayedPartStudio();if(h){let i;i=n.isFromSketch()?h.getSketchComponent().getTransformForSketchEntity(t.getDeterministicId()):h.getBodyTransform(t.getBodyId(),e),pe.w$.multiplyVec3(i,o,s)}}return s}getModelSelection(e){return new ve.Y1(W.lQt.EDGE_POINT,this.selectionId,null,{sourcePick:e.sourcePick,entityMetaData:this.entityMetaData})}getClearModelSelectionsOnPrehilite(){return!1}addHighlight(e){this.addHighlightToIncrement(au.INCREMENT_ID,e),(0,Js.vm)()}removeHighlight(e){return this.removeHighlightFromIncrement(au.INCREMENT_ID,e),(0,Js.vm)(),!0}}class Md extends m.T{constructor(e){super(),this.viewer=e,this.cullableBodies=[],this.microversionIdAndConfiguration=null,(0,Ih.Yk)(e)}getViewer(){return this.viewer}getMicroversionIdAndConfiguration(){return this.microversionIdAndConfiguration}getUIElementsForSelection(e){return[]}getEntityIdsForSelection(e){return[]}getOccurrenceEntityIdsForHighlight(e){return[]}getInContextImportEntityIdsForSelection(e){return[]}getOccurrencesForSelection(e){return[]}callOnChildSelections(e,t){let i=[];if(t.childSelections)for(let s=0;s<t.childSelections.length;s++)i=i.concat(e.call(this,t.childSelections[s]));return i}getBoundsOutsideElementNode(){return null}getBodyBounds(e,t){return null}getBodyComponent(e){return null}populateClientCacheStateDisplayInformation(e){}checkDuplicatedMicroversionIdAndConfiguration(e,t){return!e.find((function(e){return e.equals(t)}))}getElementType(){return W.GNh.UNKNOWN}}var Cd=i(58937),Dd=i(78967);const vd=q.default.getManager();class Pd{constructor(){this.boundingSphere=null,this.lod=null,this.cullingState=null}}class yd extends Md{constructor(e,t,i){super(i),this.elementId=e,this.elementAccessor=t,this.occurrences={},this.occurrencePrefixToLeaves={},this.mateConnectorData={},this.mateConnectorGraphics={},this.mateIndicatorData=new Map,this.mateIndicatorGraphics={},this.occurrenceMateIndicators={},this.originDisplayData=null,this.originGraphics=null,this.isHidden_=!0,this.isForInContext=!1,this.cachedOccurrenceState={},this.fullElementIdToOccurrence=new Ol.TemplatedNestedMap,this.ownerToInstanceMateIndicatorIds=new Map,this.mateIndicatorOwnerInstanceIds=new Map,this.mateConnectorMateIndicatorIds=new Map,this.mateIndicatorMateConnectorIds=new Map,this.occurrenceMateConnectors=new Ol.TemplatedNestedMap,this.ensureRootOccurrenceDisplayData(),$l(i),this.loadDisplayManager=new kg(i)}onDeletion(){this.reset(),this.loadDisplayManager.remove()}getUsedPartStudioIds(e){e.addAll(this.fullElementIdToOccurrence.getKeys())}populateClientCacheStateDisplayInformation(e){if(this.microversionIdAndConfiguration){const t=e.getOrCreateElementDataList(this.elementId,W.D3B.DISPLAY_DATA);this.checkDuplicatedMicroversionIdAndConfiguration(t,this.microversionIdAndConfiguration)?t.push(this.microversionIdAndConfiguration):It.log.warn("Found duplicated assembly microversion id and configuration "+this.microversionIdAndConfiguration)}}getIdOccurrenceNodeId(e,t){return(0,vn.vm)(e,t)}getMateConnectorGraphicsForSelection(e){let t=[];if(e.isMateConnector()){const i=this.getMateConnectorGraphics(e.getOccurrence(),e.getIdString());i&&t.push(i)}else if(e.childSelections)for(let i=0;i<e.childSelections.length;i++){const s=e.childSelections[i];s.isMateConnector()&&(t=t.concat(this.getMateConnectorGraphicsForSelection(s)))}return t}getMateIndicatorGraphics(e,t){let i=this.mateIndicatorGraphics[e];if(!i){const s=this.mateIndicatorData.get(e);s&&(i=this.updateMateIndicatorGraphicsAndOccurrences(s,t))}return i}getMateIndicatorForSelection(e){const t=[];if(e.isMate()){const i=!0,s=this.getIdOccurrenceNodeId(e.getOccurrence(),e.getIdString()),n=this.getMateIndicatorGraphics(s,i);n&&t.push(n)}return t}getEntitiesForNonInstanceSelection(e){let t=[];const i=function(e,i){for(let s=0;s<i.length;++s)if(i[s]===W.AuL.ORIGIN_ID&&e.isRoot()){const i=(0,Dd.Az)(e);t.push(i)}else t.push(new ve.Y1(W.lQt.ENTITY,i[s],e))};if(e.isMateConnector()){const t=this.getIdOccurrenceNodeId(e.getOccurrence(),e.getIdString()),s=this.mateConnectorData[t];s&&i(s.occurrence,s.entityIds)}else if(e.isSimulationLoad()){const t=this.loadDisplayManager.getDisplayDataForSelection(e);t&&i(t.occurrence,t.faceLoadDeterministicIds)}else if(e.isGeometryMate()){const t=this.getIdOccurrenceNodeId(e.getOccurrence(),e.getFeatureId()),s=(0,Q.as)(W.z1E,this.mateIndicatorData.get(t));s&&(s.firstDeterministicId&&i(s.firstOccurrence,[s.firstDeterministicId]),s.secondDeterministicId&&i(s.secondOccurrence,[s.secondDeterministicId]))}else e.isMate()?t=this.callOnChildSelections(this.getEntitiesForNonInstanceSelection,e):e.isEntity()&&t.push(e);return t}getMateConnectorGraphics(e,t,i){const s=this.getIdOccurrenceNodeId(e,t),n=this.mateConnectorData[s];let r=null;if(n){if(r=this.mateConnectorGraphics[s],!r){const e=this.occurrences[n.occurrence.getPathAsString()];e&&(r=this.updateMateConnectorOccurrence(n,e,!i))}}else this.fullElementIdToOccurrence.each(((i,s)=>{const n=this.elementAccessor.getPartStudio(s);if(n&&(r=n.getMateConnectorGraphics(e,t),r))return!0}),this);return r}getMateConnectorData(e,t){const i=this.getIdOccurrenceNodeId(e,t);let s=this.mateConnectorData[i];return s||this.fullElementIdToOccurrence.each(((i,n)=>{const r=this.elementAccessor.getPartStudio(n);if(r&&(s=r.getMateConnectorData(e,t),s))return!0}),this),s}getUIElementsForSelection(e){let t=[];if(e.isMateConnector())t=this.getMateConnectorGraphicsForSelection(e);else if(e.isSimulationLoad())t=this.loadDisplayManager.getUiElementsForSelection(e);else if(e.isMate())t=this.getMateIndicatorForSelection(e),0===t.length&&(t=this.callOnChildSelections(this.getUIElementsForSelection,e));else if(e.isMateRelation())t=this.callOnChildSelections(this.getUIElementsForSelection,e);else if(e.isFeature()&&e.getIdString()===W.AuL.ORIGIN_ID&&this.originGraphics&&t.push(this.originGraphics),e.getOccurrence()&&(e.isFromSketch()||e.isFromBody()||e.isOccurrence()||e.isAssemblyOrigin())){const i=Cd.m.getCommandToolbarModel(),s=!!i&&i.inShowMatesOnSelectionMode;ps.Jq.ExplodedViewsService.inExplodedViewMode()||!s&&1!==vd.getNumber("OCCURRENCE_MATE_HIGHLIGHT")&&!ps.Jq.NamedPositionPaneService.getIsInNamedPositionEditMode()||t.push.apply(t,this.getMateIndicatorsForOccurrence(e.getOccurrence()))}return t}getEntityIdsForSelection(e){let t=[];const i=e.getOccurrence();if(i){const s=this.occurrences[i.getPathAsString()];if(s){const i=this.elementAccessor.getPartStudio(s.fullElementId);i&&(t=i.getEntityIdsForSelection(e))}}return t}getOccurrenceEntityIdsForHighlight(e){let t=[];if(e){const i=this.occurrences[e.getPathAsString()];if(i){const s=this.elementAccessor.getPartStudio(i.fullElementId);s&&(t=t.concat(s.getOccurrenceEntityIdsForHighlight(e)))}}return t}getOccurrencesForSelection(e){let t=[];if(e.isMateConnector()){const i=this.getMateConnectorGraphicsForSelection(e);for(let e=0;e<i.length;++e)t.push(i[e].getOccurrence())}else if(e.isSimulationLoad()){const i=this.loadDisplayManager.getDisplayDataForSelection(e);i&&0===i.faceLoadDeterministicIds.length&&t.push(i.occurrence)}else e.isMate()||e.isMateRelation()||e.isNonGeometricItem()||e.isExplodeStep()||e.isFolder()?t=this.callOnChildSelections(this.getOccurrencesForSelection,e):e.getOccurrence()&&!e.isFeature()&&t.push(e.getOccurrence());return t}getDisplayDataForOccurrencePath(e){return this.occurrences[e]||null}hide(){if(this.isHidden_)return;const e=new mh.B7("bt.graphics.assembly.Assembly.prototype.hide");for(const e in this.mateConnectorGraphics)this.mateConnectorGraphics[e].remove();this.mateConnectorGraphics={},this.removeAllMateIndicators();for(const e in this.occurrences)this.removeOccurrenceFromPartStudio(this.occurrences[e],!1);this.removeOriginGraphics(),this.loadDisplayManager.hide(),this.isHidden_=!0,e.report()}show(e){if(!this.isHidden_)return;const t=new mh.B7("bt.graphics.assembly.Assembly.prototype.show",ET());this.isHidden_=!1;let i=new mh.B7("Updating occurrences");for(const e in this.occurrences)this.addOrUpdateOccurrence(this.occurrences[e]);i.report(),i=new mh.B7("Updating mate indicators"),this.updateOriginMateConnectorVisibility();for(const e of this.mateIndicatorData.values())this.updateMateIndicatorGraphicsAndOccurrences(e);i.report(),this.createOriginGraphics(),this.loadDisplayManager.show(),e||this.viewer.setSuppressNonIsolatedPicks(!0),t.report()}get isHidden(){return this.isHidden_}getMateIndicatorData(e){return this.mateIndicatorData.get(e)}createOriginGraphics(){this.removeOriginGraphics(),this.isHidden_||!this.originDisplayData||this.isForInContext||(this.originGraphics=new Lc(this.originDisplayData,this.viewer))}removeOriginGraphics(){this.originGraphics&&(this.originGraphics.remove(),this.originGraphics=null)}reset(){let e;for(e in this.occurrences)this.removeOccurrenceFromPartStudio(this.occurrences[e],!1);this.occurrences={},this.fullElementIdToOccurrence.clear();for(const e in this.mateConnectorGraphics)this.mateConnectorGraphics[e].remove();for(const e in this.mateIndicatorGraphics)this.mateIndicatorGraphics[e].remove();this.mateConnectorGraphics={},this.mateConnectorData={},this.mateIndicatorData=new Map,this.mateIndicatorGraphics={},this.occurrenceMateIndicators={},this.occurrenceMateConnectors.clear(),this.cullableBodies=[],this.occurrencePrefixToLeaves={},this.removeOriginGraphics(),this.originDisplayData=null,this.ownerToInstanceMateIndicatorIds.clear(),this.mateIndicatorOwnerInstanceIds.clear(),this.mateConnectorMateIndicatorIds.clear(),this.mateIndicatorMateConnectorIds.clear(),this.ensureRootOccurrenceDisplayData(),this.loadDisplayManager.reset()}processSingleOccurrenceDeletion(e,t,i){if(e){let s=e;i&&e.fullElementId.equals(i.buildFullElementId(!0))&&(s=(0,Q.shallowClone)(e),s.fullElementId=i.buildFullElementId(!1)),this.removeOccurrenceFromPartStudio(s,!0),this.removeOccurrenceElementAssociation(e),delete this.occurrences[t]}}processOccurrenceDeletions(e,t){let i;for(i=0;i<e.deletedOccurrences.length;++i)this.removeOccurrence(e.deletedOccurrences[i],t);if(!e.incremental){const e=Object.keys(this.occurrences);for(i=0;i<e.length;i++){const s=e[i],n=this.occurrences[s];this.processSingleOccurrenceDeletion(n,s,t)}}for(i=0;i<e.occurrences.length;++i){const s=e.occurrences[i];if(!s||!s.occurrenceData)continue;const n=s.occurrenceData.occurrence.toString(),r=this.occurrences[n];if(r){const i=e.getPartStudioDisplayDataForMicroversion(s.fullElementId),a=!t||e.partStudioDisplayData.length>0,o=i?i.buildFromFullElementId():s.fullElementId,h=!!i&&i.keepFromMicroversion,c=!r.fullElementId.equals(o)||h,l=r.partIds.some((function(e){return s.partIds.indexOf(e)<0}));(c||l)&&a?this.processSingleOccurrenceDeletion(r,n,t):this.removeOccurrenceElementAssociation(r)}}}updateOriginMateConnectorVisibility(){const e=this.occurrenceMateConnectors.get(""),t=new W._oC;e&&e.each(((e,i)=>{var s;const n=this.getMateConnectorGraphics(t,i,!0);return n&&n.updateOccurrenceVisibility((null===(s=this.originDisplayData)||void 0===s?void 0:s.hidden)?Js.EE.HIDDEN:Js.EE.VISIBLE),!1}),this)}processDisplayData(e){const t=new mh.B7("Assembly.prototype.processDisplayData",ET());if(this.elementId!==e.elementId)return void It.log.warn("Tried to update a graphics assembly with data corresponding to the wrong element id");let i,s;for(e.incremental||this.reset(),this.isForInContext=e.isForInContext,i=0;i<e.occurrences.length;++i)if(e.occurrences[i]){const t=e.occurrences[i],s=!0;this.addOrUpdateOccurrence(t,s)}for(i=0;i<e.mateConnectors.length;++i)if(e.mateConnectors[i]){const t=e.mateConnectors[i];this.updateMateConnector(t)}for(i=0;i<e.occurrences.length;++i)if(e.occurrences[i]){const t=e.occurrences[i];this.updateMateIndicators(t)}for(e.originDisplayData?this.originDisplayData=e.originDisplayData:e.incremental||It.log.warn("Null originDisplayData in non-incremental BTRootAssemblyDisplayData"),this.createOriginGraphics(),this.updateOriginMateConnectorVisibility(),i=0;i<e.mates.length;++i){const t=e.mates[i];t&&this.updateMateIndicator(t)}for(i=0;i<e.deletedMateIds.length;++i)s=e.deletedMateIds[i],this.removeMateWithId(s);for(i=0;i<e.deletedMateConnectorIds.length;++i)s=e.deletedMateConnectorIds[i],this.removeMateConnectorWithId(s);for(i=0;i<e.mateGroups.length;++i){const t=e.mateGroups[i];t&&this.updateMateIndicator(t)}for(i=0;i<e.deletedMateGroupIds.length;++i)s=e.deletedMateGroupIds[i],this.removeMateWithId(s);for(i=0;i<e.geometryMates.length;++i){const t=e.geometryMates[i];t&&this.updateMateIndicator(t)}for(i=0;i<e.deletedGeometryMateIds.length;++i)s=e.deletedGeometryMateIds[i],this.removeMateWithId(s);this.loadDisplayManager.processUpdates(e,!this.isHidden_),t.report()}ensureRootOccurrenceDisplayData(){const e=W.yLM.createRootOccurrenceDisplayData(this.elementId);this.addOrUpdateOccurrence(e)}addOrUpdateOccurrence(e,t){const i=e.getOccurrenceId(),s=this.occurrences[i];if(this.addOccurrenceElementAssociation(e),!this.isHidden){const t=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(i);this.viewer.getOccurrenceDataManager().setOccurrenceTransform(t,e.occurrenceData.transform.getGlMatrix());const n=this.elementAccessor.getPartStudio(e.fullElementId);n&&n.addOrUpdateOccurrence(t,e,!0),this.updateMateConnectorsForOccurrence(e),s&&s.isHidden===e.isHidden||this.trigger("OCCURRENCE_VISIBILITY_CHANGE."+i,e.isHidden?Js.EE.HIDDEN:Js.EE.VISIBLE)}this.addOccurrenceToPrefixMap(e.occurrenceData.occurrence),this.occurrences[i]=e,t||this.updateMateIndicators(e),this.trigger("OCCURRENCE_DATA_CHANGE."+i)}updateMateIndicators(e){const t=e.occurrenceData.occurrence.getPathAsString();this.updateOccurrenceMateIndicator(t)}updateUniqueMateIndicators(e){if(0===e.length)return;const t=[];e.forEach((e=>{const i=e.occurrenceData.occurrence.getPathAsString(),s=this.occurrenceMateIndicators[i];if(s)for(const e in s){if(t.includes(e))continue;t.push(e);const i=s[e].getDefinition();i&&this.updateMateIndicator(i)}}),this)}updateOccurrenceTransform(e,t){const i=[];i.push({pathId:e,transform:t}),this.batchUpdateOccurrenceTransforms(i)}batchUpdateOccurrenceTransforms(e){if(0===e.length)return!0;const t=[];if(!e.every((e=>{if(!this.occurrences)return It.log.warn("No occurrences property for this path transform pair."),!1;const i=this.occurrences[e.pathId],s=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(e.pathId);if(!i||s===DI.Qy)return It.log.warn('bad occurrence display data for pathId "'+e.pathId+'", graphics ID "'+s+'".'),!1;if(!this.isHidden_){const n=i.occurrenceData.transform.getGlMatrix();t.push({displayData:i,transform:n}),i.occurrenceData&&i.occurrenceData.transform&&i.occurrenceData.transform.updateFromGlMatrix(e.transform),e.transform&&this.viewer.getOccurrenceDataManager().setOccurrenceTransform(s,e.transform);const r=this.elementAccessor.getPartStudio(i.fullElementId);if(r){const e=!0;r.addOrUpdateOccurrence(s,i,e)}}return!0}),this))return!1;const i=t.map((function(e){return e.displayData}));return this.updateUniqueMateIndicators(i),i.forEach(yd.prototype.updateMateConnectorsForOccurrence,this),t.forEach((function(e){e.displayData.occurrenceData.transform.updateFromGlMatrix(e.transform)})),!0}getOccurrenceDisplayData(e){return e&&this.occurrences[e.getPathAsString()]||null}addOccurrenceElementAssociation(e){this.fullElementIdToOccurrence.insertNested(e.fullElementId.toString(),e.getOccurrenceId(),!0)}removeOccurrenceElementAssociation(e){this.fullElementIdToOccurrence.removeNested(e.fullElementId.toString(),e.getOccurrenceId())}removeOccurrence(e,t){const i=e.getPathAsString(),s=this.occurrences[i];s&&(this.processSingleOccurrenceDeletion(s,i,t),this.removeMateConnectorsForOccurrence(s),this.removeOccurrenceFromPrefixMap(s.occurrenceData.occurrence),this.updateOccurrenceMateIndicator(i)),this.trigger("OCCURRENCE_DELETED."+i)}removeOccurrenceFromPartStudio(e,t){if(!e||this.isHidden_)return;const i=this.elementAccessor.getPartStudio(e.fullElementId),s=e.getOccurrenceId(),n=this.viewer.getOccurrenceIdManager().getIdForName(s);i&&n!==DI.Qy&&i.removeOccurrence(n,t),this.viewer.getOccurrenceDataManager().destroyOccurrenceData(n),this.viewer.getOccurrenceIdManager().removeName(s)}getOccurrenceData(e){const t=this.occurrences[e];return t||null}getMateConnectorsForOccurrence(e){const t=[],i=this.occurrenceMateConnectors.get(e.getPathAsString());return i&&i.each((function(e,i){return t.push(e),!1}),this),t}getMateConnectorGraphicsForOccurrence(e,t){let i=[];const s=this.getMateConnectorsForOccurrence(e),n=this;for(let e=0;e<s.length;++e){const n=this.getMateConnectorGraphics(s[e].ownerOccurrence,s[e].nodeId,t);n&&(i=i.concat(n))}return this.fullElementIdToOccurrence.each((function(t,s){const r=n.elementAccessor.getPartStudio(s);return r&&function(t){i=i.concat(t.getAllMateConnectorGraphics(e))}(r),!1})),i}getMateConnectorIdsForOccurrence(e,t){const i=[];return Object.entries(this.mateConnectorData).forEach((function([s,n]){!(0,vn.wB)(e,n.ownerOccurrence)||t&&n.implicit||i.push({Id:n.nodeId,isPartStudio:!1})})),i}getHideableSketchOccurrences(){const e=[];for(const t in this.occurrences){const i=this.occurrences[t];!i.isHidden&&i.displayedSketchEntityIds&&e.push(i.occurrenceData.occurrence)}return e}getSketchImagesForOccurrence(e){const t=this.getDisplayDataForOccurrence(e);if(!t)return[];const i=this.elementAccessor.getPartStudio(t.fullElementId);if(!i)return[];const s=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString());return i.getImageComponent().getDisplaysForOccurrence(s)}getInstanceMateIndicatorIdsFromOwner(e,t){const i=this.ownerToInstanceMateIndicatorIds.get(e);return i?i.get(t):void 0}getMateIndicatorsForOccurrence(e,t){const i=[],s=e.getTailNodeId();let n=e.getOccurrenceWithoutTail();!n.isRoot()&&W.s5W.isOutputInstanceNodeId(s)&&(n=n.getOccurrenceWithoutTail());const r=this.getInstanceMateIndicatorIdsFromOwner(n.getPathAsString(),s);for(const e of new Set(r)){const s=this.getMateIndicatorGraphics(e,!t);s&&i.push(s)}return i}hasMateIndicatorForOccurrence(e){let t=e.getOccurrenceWithoutTail();const i=e.getTailNodeId();!t.isRoot()&&W.s5W.isOutputInstanceNodeId(i)&&(t=t.getOccurrenceWithoutTail());const s=this.ownerToInstanceMateIndicatorIds.get(t.getPathAsString());if(s){const e=s.get(i);return!!e&&e.size>0}return!1}updateMateConnector(e){const t=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId),i=this.mateConnectorData[t];i&&((0,vn.wB)(i.occurrence,e.occurrence)||this.removeMateConnectorWithId(t)),this.mateConnectorData[t]=e;const s=e.occurrence.getPathAsString();this.occurrenceMateConnectors.insertNested(s,e.nodeId,e);const n=this.occurrences[s];this.updateMateConnectorOccurrence(e,n),this.updateMateConnectorMateIndicator(t)}updateMateConnectorMateIndicator(e){const t=this.mateConnectorMateIndicatorIds.get(e);if(t)for(const e of new Set(t).values()){const t=this.mateIndicatorData.get(e);t&&this.updateMateIndicator(t)}}updateOccurrenceMateIndicator(e){const t=this.occurrenceMateIndicators[e];if(t)for(const e in t)if(t[e]){const i=t[e].getDefinition();this.updateMateIndicator(i)}}shouldMateIndicatorBeRecreated(e){const t=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId),i=this.mateIndicatorData.get(t);if(i&&e&&i.status===e.status&&i.getClassId()===e.getClassId()&&i.hidden===e.hidden&&(0,an.Z)(i.getMateConnectorIds(),e.getMateConnectorIds())&&(0,an.Z)(i.getOccurrenceIds(),e.getOccurrenceIds())){if(e instanceof W.Zdq&&i instanceof W.Zdq&&i.mateType!==e.mateType)return!0;const s=this.mateIndicatorGraphics[t];return!(!s||0!==s.mateIndicatorComponents.length)}return!0}updateMateIndicator(e){const t=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId);this.shouldMateIndicatorBeRecreated(e)&&this.removeMateWithId(t),this.mateIndicatorData.set(t,e),this.updateMateIndicatorGraphicsAndOccurrences(e)}separateOccurrenceAndFeatureId(e){const t=new W._oC;let i=!1,s="";const n=e.split(W._oC.OCCURRENCE_PATH_SEPARATOR);if(n.length>0)do{s=s?n.pop()+W._oC.OCCURRENCE_PATH_SEPARATOR+s:n.pop(),t.path=n,i=this.occurrences.hasOwnProperty(t.getPathAsString())}while(!i&&n.length>0);return i?{occurrence:t,featureId:s}:null}updateMateIndicatorGraphicsAndOccurrences(e,t){if(this.isHidden_)return null;const i=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId),s=!!!this.mateIndicatorGraphics[i]&&!t&&e.hidden;let n=null,r=null;const a=[];let o=null;if(e instanceof W.Zdq){const t=[],h=e.mateConnectorIds.length;o=e.mateConnectorIds;for(let i=0;i<h;++i){const s=this.separateOccurrenceAndFeatureId(e.mateConnectorIds[i]);if(!s)continue;const n=this.getMateConnectorData(s.occurrence,s.featureId);n&&(t.push(n),a.push(n.occurrence.getPathAsString()))}if(r=this.mateIndicatorGraphics[i],r){const e=r.getDefinitionOccurrenceIds(),s=(0,an.Z)(e,a);if(r.updateMateConnectorDisplayData(t),s)return r;this.removeOccurrenceMateIndicatorMapping(i,e),n=r}else s||(n=sp(t,e,this.viewer))}else if(e instanceof W.IuU){const t=[],o=e.occurrenceIds.length,h=[];for(let i=0;i<o;++i){a.push(e.occurrenceIds[i]);const s=this.occurrences[e.occurrenceIds[i]];s&&(t.push(s),h.push(e.occurrenceIds[i]))}if(r=this.mateIndicatorGraphics[i],r){const e=r.getDefinitionOccurrenceIds(),s=(0,an.Z)(e,a);if(r.updateOccurenceDisplayData(t),s)return r;this.removeOccurrenceMateIndicatorMapping(i,e),n=r}else s||(n=new ep(t,e,this.viewer))}else if(e instanceof W.z1E)if(r=this.mateIndicatorGraphics[i],a.push(e.firstOccurrence.getPathAsString()),a.push(e.secondOccurrence.getPathAsString()),r){const t=r.getDefinitionOccurrenceIds(),s=(0,an.Z)(t,a);if(r.updateMateIndicatorDefinition(e),s)return r;this.removeOccurrenceMateIndicatorMapping(i,t),n=r}else s||(n=new tp(e,this.viewer));if(0===a.length)this.removeMateGraphicsWithId(i);else if(n){this.mateIndicatorGraphics[i]=n;const e=n.getDefinitionOccurrenceIds();for(let t=0;t<e.length;++t)this.addOccurrenceMateIndicator(e[t],i,n)}this.removeMappingsForMateIndicator(i);for(let t=0;t<a.length;++t){let s=e.ownerOccurrence;e.isDerivedFeature&&(s=s.getOccurrenceWithoutTail()),this.addOwnerOccurrenceMateIndicatorMapping(a[t],i,s)}if(o)for(let e=0;e<o.length;++e)this.addMateConnectorMateIndicatorMapping(o[e],i);return n}addOwnerOccurrenceMateIndicatorMapping(e,t,i){const s=e.split(W._oC.OCCURRENCE_PATH_SEPARATOR).slice(i.path.length);let n="";s.length>0&&(n=s.length>1&&W.s5W.isOutputInstanceNodeId(s[1])?s[1]:s[0]);const r=i.getPathAsString();let a=this.ownerToInstanceMateIndicatorIds.get(r);a||(a=new Map,this.ownerToInstanceMateIndicatorIds.set(r,a));let o=a.get(n);o||(o=new Set,a.set(n,o)),o.add(t);let h=this.mateIndicatorOwnerInstanceIds.get(t);h||(h=[],this.mateIndicatorOwnerInstanceIds.set(t,h)),h.push({owner:r,instance:n})}addMateConnectorMateIndicatorMapping(e,t){let i=this.mateConnectorMateIndicatorIds.get(e);i||(i=new Set,this.mateConnectorMateIndicatorIds.set(e,i)),i.add(t);let s=this.mateIndicatorMateConnectorIds.get(t);s||(s=new Set,this.mateIndicatorMateConnectorIds.set(t,s)),s.add(e)}removeMappingsForMateIndicator(e){const t=this.mateIndicatorOwnerInstanceIds.get(e);t&&t.forEach((t=>{const i=this.ownerToInstanceMateIndicatorIds.get(t.owner);if(i){const s=i.get(t.instance);s&&(s.delete(e),0===s.size&&i.delete(t.instance)),0===i.size&&this.ownerToInstanceMateIndicatorIds.delete(t.owner)}})),this.mateIndicatorOwnerInstanceIds.delete(e);const i=this.mateIndicatorMateConnectorIds.get(e);i&&i.forEach((t=>{const i=this.mateConnectorMateIndicatorIds.get(t);i&&(i.delete(e),0===i.size&&this.mateConnectorMateIndicatorIds.delete(t))})),this.mateIndicatorMateConnectorIds.delete(e)}updateMateConnectorsForOccurrence(e){const t=this.getMateConnectorsForOccurrence(e.occurrenceData.occurrence);for(let i=0;i<t.length;++i)this.updateMateConnectorOccurrence(t[i],e)}removeMateConnectorWithId(e){const t=this.mateConnectorData[e];t&&(delete this.mateConnectorData[e],this.occurrenceMateConnectors.removeNested(t.occurrence.getPathAsString(),t.nodeId),this.removeMateConnectorOccurrenceFromIds(t.nodeId,t.ownerOccurrence),this.updateMateConnectorMateIndicator(e),this.loadDisplayManager.processDeletedMateConnector(e))}removeOccurrenceMateIndicatorMapping(e,t){const i=this.mateIndicatorGraphics[e];if(i){t=t||i.getDefinitionOccurrenceIds();for(let i=0;i<t.length;++i)this.removeOccurrenceMateIndicator(t[i],e)}}removeMateGraphicsWithId(e){const t=this.mateIndicatorGraphics[e];t&&(this.removeOccurrenceMateIndicatorMapping(e),t.remove(),delete this.mateIndicatorGraphics[e])}removeMateWithId(e){this.removeMateGraphicsWithId(e),this.removeMappingsForMateIndicator(e),this.mateIndicatorData.delete(e)}removeMateConnectorsForOccurrence(e){const t=this.getMateConnectorsForOccurrence(e.occurrenceData.occurrence);for(let e=0;e<t.length;++e)this.removeMateConnectorOccurrenceFromIds(t[e].nodeId,t[e].ownerOccurrence)}updateMateConnectorOccurrence(e,t,i){if(this.isHidden_)return null;const s=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId);let n=this.mateConnectorGraphics[s];return n||i||!(t&&t.isHidden||e.hidden)?(n?n.updateDefinition(e):this.mateConnectorGraphics[s]=n=new Dl(e,sh.lL,this.viewer),t?(n.setOccurrenceTransform(t.occurrenceData.transform.getGlMatrix()),n.updateOccurrenceVisibility(t.isHidden?Js.EE.HIDDEN:Js.EE.VISIBLE),n.setIsParentOccurrenceDataMissing(!1)):n.setIsParentOccurrenceDataMissing(!0),n):null}removeMateConnectorOccurrenceFromIds(e,t){const i=this.getIdOccurrenceNodeId(t,e),s=this.mateConnectorGraphics[i];s&&(s.remove(),delete this.mateConnectorGraphics[i])}removeAllMateIndicators(){for(const e in this.mateIndicatorGraphics)this.mateIndicatorGraphics[e].remove();this.occurrenceMateIndicators={},this.mateIndicatorGraphics={}}addOccurrenceMateIndicator(e,t,i){e in this.occurrenceMateIndicators||(this.occurrenceMateIndicators[e]={}),this.occurrenceMateIndicators[e][t]=i;const s=this.viewer.getIsolatedOccurrenceManager().getIsolatedOccurrences();if(s&&s.length>0)for(let t=0;t<s.length;t++)s[t].getPathAsString()===e&&i.getOccurrenceData().setIsolated(!0)}removeOccurrenceMateIndicator(e,t){e in this.occurrenceMateIndicators&&this.occurrenceMateIndicators[e][t]&&delete this.occurrenceMateIndicators[e][t]}getDisplayDataForOccurrence(e){return e&&this.occurrences[e.getPathAsString()]||null}getOccurrenceVisibility(e){const t=this.getDisplayDataForOccurrence(e);return!t||t.isHidden?Js.EE.HIDDEN:Js.EE.VISIBLE}addOrRemoveOccurrenceInPrefixMap(e,t){const i=e.getPathAsString();for(let s=0;s<e.path.length;s++){const n=e.path.slice(0,s+1).join(".");this.occurrencePrefixToLeaves[n]||(this.occurrencePrefixToLeaves[n]=new St.StringSet),t?this.occurrencePrefixToLeaves[n].add(i):this.occurrencePrefixToLeaves[n].remove(i)}}addOccurrenceToPrefixMap(e){this.addOrRemoveOccurrenceInPrefixMap(e,!0)}removeOccurrenceFromPrefixMap(e){this.addOrRemoveOccurrenceInPrefixMap(e,!1)}getLeafOccurrencesContainedWithinOccurrence(e){const t=[];if(e)if(e.isAssemblyRoot())(0,gt.Z)(this.occurrences,(e=>t.push(e.occurrenceData.occurrence)));else{const i=this.occurrencePrefixToLeaves[e.getPathAsString()];i&&i.each((e=>{const i=this.occurrences[e];i&&i.occurrenceData&&t.push(i.occurrenceData.occurrence)}))}return t}getOccurrenceBounds(e){const t=this.getLeafOccurrencesContainedWithinOccurrence(e);let i=null;return t.forEach((e=>{const t=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString()),s=this.getOccurrenceDisplayData(e);if(s&&t!==DI.Qy){const e=this.elementAccessor.getPartStudio(s.fullElementId);if(e){const s=e.getOccurrenceBounds(t);s&&s.isFinite()&&(i||(i=new Li.kB),i.addBox(s))}}})),i}getBodyComponent(e){const t=this.getOccurrenceDisplayData(e);if(t){const e=this.elementAccessor.getPartStudio(t.fullElementId);if(e)return e.bodyComponent}return null}getBodyBounds(e,t){const i=this.getOccurrenceDisplayData(t);if(i){const s=this.elementAccessor.getPartStudio(i.fullElementId);if(s){const n=s.getBodyBounds(e,t);if(n)return n.createTransformedCopy(i.occurrenceData.transform.getGlMatrix())}}return null}getCachedOccurrenceState(e){let t=this.cachedOccurrenceState[e];return t||(this.cachedOccurrenceState[e]=t=new Pd),t}clearCachedOccurrenceState(){this.cachedOccurrenceState={}}getBoundsOutsideElementNode(){const e=new Li.kB;if(this.originGraphics&&e.addBox(this.originGraphics.getBounds()),this.mateConnectorGraphics)for(const t in this.mateConnectorGraphics)this.mateConnectorGraphics[t].isHidden||e.addPoint(this.mateConnectorGraphics[t].worldSpacePosition);return this.fullElementIdToOccurrence.each(((t,i)=>{const s=this.elementAccessor.getPartStudio(i);return null!==s&&e.addBox(s.mateConnectorComponent.getVisibleMateConnectorBounds()),!1}),this),e.isInitialized()&&e.isFinite()?e:null}getMateIndicatorConnectivityMap(e){const t=new Ol.TemplatedNestedMap;for(const i of this.mateIndicatorData.values()){if(i.status===W.EFx.SUPPRESSED)continue;const s=i.getOccurrences(this);for(const i of s){const n=i.trimToTopLevel().getPathAsString(),r=i.getPathAsString();if(e.has(r))for(const e of s){const i=e.getPathAsString();n!==i&&t.insertNested(r,i,e)}}}return t}getElementType(){return W.GNh.ASSEMBLY}setExplodeViewActive(e){this.loadDisplayManager.setExplodeViewActive(e)}setEditState(e,t){this.loadDisplayManager.setEditState(e,t)}getOccurrences(){return this.occurrences}setAreOccurrencesClippedBySectionPlaneExcept(e,t){for(const t in this.occurrences){const i=this.viewer.getOccurrenceIdManager().getIdForName(t),s=this.viewer.getOccurrenceDataManager().getOccurrenceData(i);s&&s.setIsClippedBySectionPlanes(e)}for(const i of t)this.setAllLeafOccurrencesClippedForOccurrence(W._oC.getOccurrenceFromPathString(i),!e)}setAllLeafOccurrencesClippedForOccurrence(e,t){const i=this.getLeafOccurrencesContainedWithinOccurrence(e);if(i){for(const e of i){if(!this.occurrences[e.getPathAsString()]){It.log.debug("Did not find occurrence data for leaf occurrence "+e.getPathAsString()+" in assembly "+this.elementId);continue}const i=this.viewer.getIdForOccurrence(e),s=this.viewer.getOccurrenceDataManager().getOccurrenceData(i);s&&s.setIsClippedBySectionPlanes(t)}const e=this.viewer.getModelViewManagers().getManager().getSimulationManager();e&&e.onSectionSetChanged()}}enterMateHideMode(e){const t=new Set;e.forEach((e=>{const i=new W._oC;i.path=e.path;const s=this.getIdOccurrenceNodeId(i,e.featureId);t.add(s)}));for(const e in this.mateIndicatorGraphics){this.mateIndicatorGraphics[e].updateHiddenMode(!t.has(e))}}exitMateHideMode(){for(const e in this.mateIndicatorGraphics){this.mateIndicatorGraphics[e].updateHiddenMode(!1)}}}const Ad="commentindicator",Od=q.default.getManager(),Rd=20,wd=20,_d="n",Nd="h";function bd(e){const t=new Nl;t.id=_d,t.backgroundColor=Od.getString("COMMENT_INDICATOR_BACKGROUND_COLOR"),t.imageName="comment-indicator.png";const i=new Nl;return i.id=Nd,i.backgroundColor=Od.getString("COMMENT_INDICATOR_HOVER_BACKGROUND_COLOR"),i.imageName="comment-indicator.png",Bl(e,Math.max(Rd,wd),[t,i],{sourcesHaveTransparency:!0})}function Ld(e){if(e.getResources().commentIndicatorAtlasCreationInitiated)return;e.getResources().commentIndicatorAtlasCreationInitiated=!0;e.getTextureAtlasFactory().getAtlas("COMMENT_INDICATOR_ATLAS",bd.bind(void 0,e)).then((t=>{t?(e.getResources().commentIndicatorAtlas=t,e.getResources().commentIndicatorMaterial.ambientTexture=t.texture,(0,Js.vm)()):It.log.warn("Could not load texture atlas")}),(e=>It.log.error(e)))}class Fd extends Ri{constructor(e,t,i){super(i,sh.EG),this.occurrence=null,this.associatedComments=[],this.worldSpacePosition=null,this.hovered=!1,this.elementBeingListenedTo=null,this.parentHidden=!1,this.allCommentsHidden=!1,this.parentSheetMetalModelId=null,t&&(this.occurrence=W._oC.getOccurrenceFromPathString(t)),(0,Ic.isString)(e)?this.entityDeterministicId=e:this.commentCoordinates=e,this.updateWorldPosition(),this.listenTo(this.viewer.getEventDispatcher(),VM.CD,this.updateWorldPosition),this.listenTo(this.viewer.getEventDispatcher(),VM.LA,this.updateWorldPosition),this.listenTo(this.viewer.getEventDispatcher(),VM.hj,this.updateMissingWorldPosition),this.listenTo(i.getEventDispatcher(),VM.Hq,this.onActiveSheetMetalModelChanged),this.listenTo(this,Pi.CLICK+Ad,this.onClick),this.listenTo(this,Pi.MOUSE_ENTER+Ad,this.onMouseEnter),this.listenTo(this,Pi.MOUSE_LEAVE+Ad,this.onMouseLeave)}setCommentCoordinates(e){if(this.entityDeterministicId)throw new Error("A comment should have coordinates or entity id, but not both");this.commentCoordinates=e,this.updateWorldPosition()}addComment(e){this.associatedComments.indexOf(e)<0&&this.associatedComments.push(e);!this.entityDeterministicId&&this.updateElementListener()}removeComment(e){const t=this.associatedComments.indexOf(e);t>=0&&this.associatedComments.splice(t,1),this.entityDeterministicId||this.updateElementListener()}hasComments(){return this.associatedComments.length>0}onDevicePixelRatioChanged(e){this.updateGraphics()}updateGraphics(){if(!this.viewer.getResources().commentIndicatorAtlas)return;const e=this.viewer.getResources().commentIndicatorAtlas.getTextureCoords(this.hovered?Nd:_d);if(!e)return;const t=(0,Es.x_)(),i=Ou([0,0,0],[Rd*t,0,0],[0,wd*t,0],void 0,[e.lowS,e.highT],[e.highS,e.lowT]);this.updateMeshIncrement("QUAD",Ad,i,this.viewer.getResources().commentIndicatorNodeProperties)}updateWorldPosition(){this.worldSpacePosition=null;const e=this.viewer.getModelViewManagers().getManager();if(this.entityDeterministicId){let t=null;if(this.occurrence&&!e.isEntityOnOccurrence(this.entityDeterministicId,this.occurrence)||(t=e.extractMeshIncrement(this.entityDeterministicId,this.occurrence)),!t)return void this.removeMeshIncrements();if(this.worldSpacePosition=this.getStickingPosition(t),this.viewer.getIsForFlattenedDisplay()){const t=e.getFlattenedEntityOwnerBodyDetails(this.entityDeterministicId,this.occurrence);if(!t||!t.transform)return this.worldSpacePosition=null,void this.removeMeshIncrements();pe.w$.multiplyVec3(t.transform,this.worldSpacePosition),this.parentSheetMetalModelId=t.bodyMetaData.sheetMetalModelId,this.updateHideState()}}else this.worldSpacePosition=[this.commentCoordinates.x,this.commentCoordinates.y,this.commentCoordinates.z];if(this.occurrence){const t=e.getOccurrenceTransform(this.occurrence);if(!t)return this.worldSpacePosition=null,void this.removeMeshIncrements();pe.w$.multiplyVec3(t,this.worldSpacePosition)}this.updateElementListener()}updateMissingWorldPosition(){this.worldSpacePosition||this.updateWorldPosition()}stopListeningToElement(){this.elementBeingListenedTo&&(this.stopListening(this.elementBeingListenedTo),this.elementBeingListenedTo=null)}updateElementListener(){if(this.stopListeningToElement(),this.hasBeenRemoved)return;const e=this.viewer.getModelViewManagers().getManager();if(this.occurrence){const t=e.getDisplayedAssembly();if(t){const e=this.occurrence.getPathAsString();this.onParentVisibilityChange(t.getOccurrenceVisibility(this.occurrence)),this.listenTo(t,"OCCURRENCE_VISIBILITY_CHANGE."+e,this.onParentVisibilityChange),this.listenTo(t,"OCCURRENCE_DATA_CHANGE."+e,this.updateWorldPosition),this.listenTo(t,"OCCURRENCE_DELETED."+e,this.updateWorldPosition),this.elementBeingListenedTo=t}}else this.entityDeterministicId?this.addEntityListeners(this.entityDeterministicId):this.addCommentListenersForAssociatedComments()}addCommentListenersForAssociatedComments(){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(e)for(const t of this.associatedComments)if(t.deterministicIds)for(const i of t.deterministicIds){if(e.retrieveBodyMetaData(i))this.listenToBodyVisibility(i,e);else{e.retrieveEntityMetaData(i)&&this.addEntityListeners(i)}}}addEntityListeners(e){const t=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio(),i=null==t?void 0:t.retrieveEntityMetaData(e);t&&i&&(i.isFromBody()?this.listenToBodyVisibility(i.getBodyId(),t):this.listenToFeatureVisibility(i.getLastFeatureId(),t))}listenToBodyVisibility(e,t){this.onParentVisibilityChange(t.getBodyVisibility(e)),this.listenTo(t,"BODY_VISIBILITY_CHANGE."+e,this.onParentVisibilityChange),this.elementBeingListenedTo=t}listenToFeatureVisibility(e,t){this.onParentVisibilityChange(t.getFeatureVisibility(e)),this.listenTo(t,"FEATURE_VISIBILITY_CHANGE."+e,this.onParentVisibilityChange),this.elementBeingListenedTo=t}onParentVisibilityChange(e){this.parentHidden=e===Js.EE.HIDDEN,this.updateHideState()}setAllCommentsHidden(e){this.allCommentsHidden=e,this.updateHideState()}updateHideState(){let e=!1;this.parentSheetMetalModelId&&this.parentSheetMetalModelId!==this.viewer.getModelViewManagers().getManager().getSelectedSheetmetalModelId()&&(e=!0),this.allCommentsHidden||this.parentHidden||e?this.hide():this.show()}getStickingPosition(e){return e.getPositionNearCenter()}onViewWillDraw(e){if(Ld(this.viewer),this.isHidden||!this.worldSpacePosition||!this.viewer.getResources().commentIndicatorAtlas)return;this.viewer.getResources().commentIndicatorMaterial.ambientTexture=this.viewer.getResources().commentIndicatorAtlas.texture;const t=e.projectWorldPointToViewport(this.worldSpacePosition),i=ge.create();i[12]=Math.floor(t[0]-Rd/2),i[13]=Math.floor(t[1]-wd/2),this.setTransform(i),this.hasMeshIncrements()||this.updateGraphics()}onClick(e,t){t.skipCommentClearHighlight=!0,ps.Jq.CommentService.highlightComments(this.associatedComments)}onMouseEnter(){this.hovered=!0,this.removeMeshIncrements(),(0,Js.vm)()}onMouseLeave(){this.hovered=!1,this.removeMeshIncrements(),(0,Js.vm)()}onActiveSheetMetalModelChanged(e){this.parentSheetMetalModelId&&this.updateHideState()}}class xd extends Ri{constructor(e,t){super(t,sh.EG),this.elementModel=e,this.centerOfMass=null}updateCenterOfMass(e){this.centerOfMass=e}updateGraphics(){this.ensureMaterialIsCreated();const e=20*(0,Es.x_)(),t=Ou([0,0,0],[e,0,0],[0,e,0],void 0,[0,0],[1,1]);this.updateMeshIncrement("QUAD","",t,this.viewer.getResources().centerOfMassIndicatorNodeProperties)}ensureMaterialIsCreated(){if(null===this.viewer.getResources().centerOfMassIndicatorNodeProperties){const e=(0,Li.cP)(20);if(e>this.viewer.getMaximumTextureSize())throw new Error("Center of mass texture size exceeds limit");const t=new uo(this.viewer,(function(t){const i=new co(t);return i.width=e,i.height=e,i.magnificationFilter=t.LINEAR,i.minificationFilter=t.LINEAR,i.useMipmaps=!1,i.imageSource="/images/center-of-mass.png",i}));t.setHasTransparency(!0),this.viewer.getResources().centerOfMassIndicatorNodeProperties=new Qi({primitiveType:_i.MX.TRIANGLES,material:Xi(t),isPickable:!1})}}onViewWillDraw(e){if(null===this.centerOfMass||this.isHidden)return;const t=e.projectWorldPointToViewport(this.centerOfMass),i=ge.create(),s=20*(0,Es.x_)()/2;i[12]=Math.floor(t[0]-s),i[13]=Math.floor(t[1]-s),this.setTransform(i),this.hasMeshIncrements()||this.updateGraphics()}onDevicePixelRatioChanged(e){this.updateGraphics()}}const Bd="uDecalProjection",Ud="uCylinderRadius",Vd="decals";function Gd(e){var t;return(null===(t=e.getMaterial())||void 0===t?void 0:t.getExtendedShaderId())===Vd}class Hd{constructor(e,t,i){this.decalId=e,this.bodyComponent=t,this.partStudio=i,this.bodyToInstantiationDetails=new Map,this.bodyToOccurrenceId=new Map,this.occurrenceIdToInstantiatedNodeProperties=new Map,this.relatedClosedCompositeDeterminsticIds=new Set,this.mappingResources=[]}destroy(){this.removeGraphics();for(let e=0;e<this.mappingResources.length;++e)this.mappingResources[e].material.destroy()}clone(e,t){const i=new Hd(this.decalId,e,t);return i.btDecal=this.btDecal,i}removeOccurrences(){for(const[e,t]of this.bodyToOccurrenceId)for(const i of t)this.removeOccurrence(i,e)}removeGraphics(){this.removeOccurrences(),this.bodyToInstantiationDetails.clear()}addOrUpdateOccurrence(e,t){t=+t;const i=this.bodyComponent.retrieveBodyMetaData(e);if(!i)return;let s;s=i.isClosedComposite?i.constituentBodyIds:[e];let n=!1;for(let i=0;i<s.length;++i){const r=s[i],a=this.bodyToInstantiationDetails.get(r);if(a)for(const[i,s]of a){const i=new fE,r=this.viewer.getOccurrenceDataManager().getOccurrenceData(t);for(let e=0;e<s.nodeProperties.length;++e){this.node.addOccurrenceGeometryToNode(s.nodeProperties[e],r,i,s.incrementRanges);let a=this.occurrenceIdToInstantiatedNodeProperties.get(t);a||(a=new Set,this.occurrenceIdToInstantiatedNodeProperties.set(t,a),n=!0),a.add(s.nodeProperties[e])}let a=this.bodyToOccurrenceId.get(e);a||(a=new Set,this.bodyToOccurrenceId.set(e,a)),a.add(t)}}n&&(i.isClosedComposite?this.relatedClosedCompositeDeterminsticIds.add(e):i.isClosedCompositeConstituent&&this.relatedClosedCompositeDeterminsticIds.add(i.closedCompositeParentId))}removeOccurrence(e,t){e=+e;const i=this.bodyToOccurrenceId.get(t);if(i&&i.has(e)){const s=this.occurrenceIdToInstantiatedNodeProperties.get(e);if(s){for(const t of s)this.node.removeOccurrenceFromNode(t,e);this.occurrenceIdToInstantiatedNodeProperties.delete(e)}i.delete(e),0===i.size&&this.bodyToOccurrenceId.delete(t)}}update(e){return(!this.btDecal||!this.btDecal.deepEquals(e))&&(this.btDecal=e,this.updateGraphics(),!0)}debugCoordinateSystem(){for(let e=0;e<this.btDecal.mappings.length;++e){const t=this.btDecal.mappings[e];let i=null;t instanceof W.TIP?i=t.planeSystem:t instanceof W.Q7q&&(i=t.cylinderSystem),i&&eC(this.viewer,this.decalId+"."+e,i)}}onPartStudioChange(e){(this.didReferencedFaceChange(e)||this.didBodyStatusChange(e))&&this.updateGraphics()}updateGraphics(){this.btDecal&&(this.removeGraphics(),this.updateMappingResources(),this.updateIncrementRanges(),this.refreshOccurrences())}refreshOccurrences(){this.bodyComponent.getBodyToOccurrenceId().eachNested(((e,t,i)=>{this.addOrUpdateOccurrence(t,i)}))}doesReferenceEntity(e){for(const t of this.btDecal.mappings)if(t.deterministicIds.indexOf(e)>=0)return!0;return!1}didReferencedFaceChange(e){if(!this.btDecal)return!1;for(const t of this.btDecal.mappings)for(const i of t.deterministicIds)if(e.deterministicIdToEntity.hasOwnProperty(i))return!0;return!1}didBodyStatusChange(e){for(const[e,t]of this.bodyToOccurrenceId){const t=this.bodyComponent.retrieveBodyMetaData(e);if(!t||t.canBeGroupedWithOtherConstituents)return!0}let t=!1;for(const i of this.relatedClosedCompositeDeterminsticIds)e.deterministicPartIdToData[i]&&(this.relatedClosedCompositeDeterminsticIds.delete(i),t=!0);return t}updateMappingResources(){for(let e=0;e<this.btDecal.mappings.length;++e){const t=this.btDecal.mappings[e];let i=this.mappingResources[e];if(!i){const e=new ki({diffuseFactor:0,ambientFactor:1,specularColor:[0,0,0]});e.shaderId=Vd,i={material:e,nodeProperties:null,transparentNodeProperties:null},this.mappingResources.push(i)}if(t instanceof W.TIP)i.material.setCustomMatrixUniform(Bd,t.planeSystem.fromWorld()),i.material.setCustomFloatUniform(Ud,0);else{if(!(t instanceof W.Q7q))return void It.log.debug("Unsupported decal mapping: "+t.getMessageName());i.material.setCustomMatrixUniform(Bd,t.cylinderSystem.getGlMatrix()),i.material.setCustomFloatUniform(Ud,t.radius)}i.material.setCustomMatrixUniform("uUvTransform",t.uvTransform.getGlMatrix());const s=(0,jn.e)(this.btDecal.imageSourceId);i.material.setTexture(this.viewer.getResources().getImageTexture(s)),i.nodeProperties=Rp.cloneAndModify({material:i.material,isPickable:!1,zOffset:q.default.getManager().getNumber("DECALS_Z_OFFSET")}),i.transparentNodeProperties=wp.cloneAndModify({material:i.material,isPickable:!1,zOffset:q.default.getManager().getNumber("DECALS_Z_OFFSET")})}}updateIncrementRanges(){for(let e=0;e<this.btDecal.mappings.length;++e){const t=this.btDecal.mappings[e];if(0===t.deterministicIds.length)continue;const i=this.mappingResources[e];if(i)for(const s of t.deterministicIds){const t=this.bodyComponent.getEntityMetaData(s);if(!t)continue;const n=t.getBodyId();if(!this.bodyComponent.isBodyLoaded(n))continue;const r=this.getIncrementMeshDetails(s);if(!r){It.log.debug("Did not find increment details for "+s);continue}let a=this.bodyToInstantiationDetails.get(n);a||(a=new Map,this.bodyToInstantiationDetails.set(n,a));let o=a.get(e);o||(o={incrementRanges:new BS("Decal-"+this.decalId+"-Mapping-"+e+"-Body-"+n),nodeProperties:[i.nodeProperties,i.transparentNodeProperties]},a.set(e,o)),null==o||o.incrementRanges.onIncrementAdded(r)}else It.log.warn("Did not have image mapping resources for decal mapping "+e)}}getIncrementMeshDetails(e){const t=this.partStudio.getMeshManager().getIncrementDetails(e,this.partStudio.getMeshOwnerId());if(t)return t;const i=this.partStudio.getSharedBaseMeshManager();return i?i.getIncrementDetails(e,this.partStudio.getMeshOwnerId()):null}get node(){return this.partStudio.getModelViewManager().getSharedBodyNode()}get viewer(){return this.partStudio.viewer}}class kd{constructor(e,t){this.bodyComponent=e,this.partStudio=t,this.decals=new Map}destroy(){for(const[e,t]of this.decals)t.destroy()}cloneForPreview(e,t){const i=new kd(e,t);return this.copyToClone(i),i}copyToClone(e){for(const[t,i]of this.decals){const s=i.clone(e.bodyComponent,e.partStudio);e.decals.set(t,s),s.updateGraphics()}}removeFromScene(){for(const[e,t]of this.decals)t.removeOccurrences()}update(e){if(this.partStudio.viewer.getIsForFlattenedDisplay())return;const t=new Set;for(const i in e.decalIdToDecal){const s=e.decalIdToDecal[i];let n=this.decals.get(i);s.isDeletion?n&&(n.destroy(),this.decals.delete(i)):(n||(n=new Hd(i,this.bodyComponent,this.partStudio),this.decals.set(i,n)),n.update(s)&&t.add(i))}for(const[i,s]of this.decals)t.has(i)||s.onPartStudioChange(e)}onBodyLoaded(){for(const[e,t]of this.decals)t.updateGraphics()}addOrUpdateOccurrence(e,t){for(const[i,s]of this.decals)s.addOrUpdateOccurrence(e,t)}removeOccurrence(e,t){for(const[i,s]of this.decals)s.removeOccurrence(e,t)}getDecalIdsAffectingEntity(e){const t=[];for(const[i,s]of this.decals)s.doesReferenceEntity(e)&&t.push(i);return t}}var Wd=i(63512);const zd=function(e){return e.isFace()||e.isFromSketch()&&e.isEdge()||e.isFromOrigin()||e.isSketchUserPoint()||e.isFromPointBody()||e.isFromWireBody()},Xd=function(e){return e.isFace()||e.isFromWireBody()&&e.isEdge()||e.isFromPointBody()};class qd extends Md{constructor(e,t,i,s,n,r,a){super(r),this.id=e,this.microversionIdAndConfiguration=t,this.modelViewManager=i,this.usage=n,this.isExternal=!1,this.isForIncontextDisplay=!1,this.bodyIdsThatAreInsertableBuffers=null,this.hideableFeatureIds=[],this.referencedInContextAssemblyIds=[],this.visibleInContextAssembly="",this.displayedContextTransform={},this.editedInContextOccurrences=[],this.partColorCycle=null,this.isCachedPartStudioPendingUse=!1,this.isMissingTangencyInformationMessageShown=!1,this.bodyIdToEntityAppearanceSettings={},this.meshOwnerId=a?a.meshOwnerId:WS(),this.sharedBaseMeshManager=i.getSharedBaseMeshManager(),this.entityIdManager=new vI.E(Di._6.ENTITY),this.bodyComponent=new Hp(this,s,this.usage,this.viewer),this.sketchComponent=new Yp(this,this.usage,this.viewer),this.planeComponent=new cg(this,this.usage,this.viewer),this.pointBodyComponent=new hp(this,this.viewer),this.mateConnectorComponent=new zg(this,this.usage,this.viewer),this.errorComponent=new kp(this,this.viewer),this.dimensionComponent=new Zd(this.usage,this.id,this.viewer),this.imageComponent=new Rl(this.usage,this.viewer),this.annotationComponent=new ou(this.usage,this.id,this.viewer),this.components=[this.bodyComponent,this.sketchComponent,this.planeComponent,this.pointBodyComponent,this.mateConnectorComponent,this.errorComponent]}clone(e){const t=new qd(this.id,this.microversionIdAndConfiguration,this.modelViewManager,this.bodyComponent.getBodyLoadTasks(),this.usage,this.viewer);if(e){for(let e=0;e<t.components.length;++e)t.bodyComponent===t.components[e]?(t.bodyComponent=this.bodyComponent.clone(t),t.components[e]=t.bodyComponent):t.planeComponent===t.components[e]?(t.planeComponent=this.planeComponent.clone(t),t.components[e]=t.planeComponent):t.sketchComponent===t.components[e]?(t.sketchComponent=this.sketchComponent.clone(t),t.components[e]=t.sketchComponent):t.pointBodyComponent===t.components[e]?(t.pointBodyComponent=this.pointBodyComponent.clone(t),t.components[e]=t.pointBodyComponent):t.mateConnectorComponent===t.components[e]&&(t.mateConnectorComponent=this.mateConnectorComponent.clone(t),t.components[e]=t.mateConnectorComponent);t.imageComponent=this.imageComponent.cloneForUsage(this.usage),t.partColorCycle=this.partColorCycle,t.isCachedPartStudioPendingUse=this.isCachedPartStudioPendingUse,t.bodyIdToEntityAppearanceSettings=this.bodyIdToEntityAppearanceSettings}return t}cloneForPreview(e,t){const i=new qd(this.id,null,e,this.bodyComponent.getBodyLoadTasks(),Ls.L.PREVIEW,this.viewer,this);i.entityIdManager=this.entityIdManager.clone();for(let e=0;e<i.components.length;++e)i.bodyComponent===i.components[e]?(i.bodyComponent=this.bodyComponent.cloneForPreview(i),i.components[e]=i.bodyComponent):i.planeComponent===i.components[e]?t||(i.planeComponent=this.planeComponent.cloneForPreview(i),i.components[e]=i.planeComponent):i.sketchComponent===i.components[e]?(i.sketchComponent=this.sketchComponent.cloneForPreview(i),i.components[e]=i.sketchComponent):i.pointBodyComponent===i.components[e]?t||(i.pointBodyComponent=this.pointBodyComponent.cloneForPreview(i),i.components[e]=i.pointBodyComponent):i.mateConnectorComponent===i.components[e]&&(t||(i.mateConnectorComponent=this.mateConnectorComponent.cloneForPreview(i),i.components[e]=i.mateConnectorComponent));return i.imageComponent=this.imageComponent.cloneForUsage(Ls.L.PREVIEW),i.partColorCycle=this.partColorCycle,i.bodyIdToEntityAppearanceSettings=this.bodyIdToEntityAppearanceSettings,i}isBodyContainedInInsertableDisplayBuffers(e){return this.bodyIdsThatAreInsertableBuffers&&this.bodyIdsThatAreInsertableBuffers.has(e)}onPreviewDestroyed(){this.bodyComponent.onPreviewDestroyed()}copyBodyVisibility(e){this.bodyComponent.copyVisibility(e.bodyComponent)}isBase(){return this.usage===Ls.L.BASE}getElementId(){return this.id}getIsMissingTangencyInformationMessageShown(){return this.isMissingTangencyInformationMessageShown}setIsMissingTangencyInformationMessageShown(e){this.isMissingTangencyInformationMessageShown=e}getIsCachedPartStudioPendingUse(){return this.isCachedPartStudioPendingUse}getFullElementId(){return this.microversionIdAndConfiguration?W.lK7.getFullElementIdString(this.id,this.microversionIdAndConfiguration.getKey()):this.id}getBtFullElementId(){const e=new W.lK7;return e.elementId=this.id,this.microversionIdAndConfiguration&&(e.microversionId=this.microversionIdAndConfiguration.microversion,e.microversionIdAndConfiguration=this.microversionIdAndConfiguration),e}getModelViewManager(){return this.modelViewManager}getMeshManager(){return this.modelViewManager.getMeshManager()}getSharedBaseMeshManager(){return this.sharedBaseMeshManager||null}populateClientCacheStateDisplayInformation(e){if(this.microversionIdAndConfiguration){const t=e.getOrCreateElementDataList(this.id,W.D3B.DISPLAY_DATA);this.checkDuplicatedMicroversionIdAndConfiguration(t,this.microversionIdAndConfiguration)?t.push(this.microversionIdAndConfiguration):It.log.warn("Found duplicated part studio microversion id and configuration "+this.microversionIdAndConfiguration),this.populateTessellationSetting(e),this.populateSketchFeatures(e)}}populateSketchFeatures(e){const t=this.getBtFullElementId(),i=this.sketchComponent.featureToIds.getKeys(),s=e.listFullElementIdToReferencedSketchFeatureIds,n=new W.luK;return n.fullElementId=t,n.referencedSketchFeatureIds=i,s.push(n),n}populateTessellationSetting(e){let t,i=e.tessellationWithConfigurationSettings[this.id];i||(e.tessellationWithConfigurationSettings[this.id]=i=[]);for(let e=0;e<i.length;e++)if(t=i[e],t.microversionIdAndConfiguration.equals(this.microversionIdAndConfiguration))return t.tessellationSettings=this.bodyComponent.getTessellationSettings(),t.partTriangleCounts=this.bodyComponent.getPartTriangleCounts(),t;return t=new W.iRj,t.microversionIdAndConfiguration=this.microversionIdAndConfiguration,t.tessellationSettings=this.bodyComponent.getTessellationSettings(),i.push(t),t}getSceneGraph(){return this.usage===Ls.L.PREVIEW?this.viewer.getSceneGraphs().getPreviewSceneGraph():this.viewer.getSceneGraphs().getMainSceneGraph()}getPartColorCycle(){return this.partColorCycle}reset(e){for(let t=0;t<this.components.length;++t)this.components[t].reset(e);this.dimensionComponent.reset(),this.imageComponent.reset(),this.entityIdManager.reset(),this.referencedInContextAssemblyIds=[],this.visibleInContextAssembly="",this.editedInContextOccurrences=[],this.sharedBaseMeshManager=null}retrieveEntityMetaData(e){for(let t=0;t<this.components.length;++t){const i=this.components[t].getEntityMetaData(e);if(i)return i}return null}retrieveBodyMetaData(e){for(let t=0;t<this.components.length;++t){const i=this.components[t].retrieveBodyMetaData(e);if(i)return i}return null}retrieveAssociatedFeatureIds(e){const t=[];for(const i of this.components){const s=i.retrieveAssociatedFeatureIds(e);s&&s.length&&t.push(...s)}return t}retrieveBodyEntityData(e){const t=[],i=this.getBodyComponent().getEntityIds(e);for(const e of i){const i=this.retrieveEntityMetaData(e);i&&t.push(i)}return t}getEntityIdManager(){return this.entityIdManager}extractMeshIncrement(e){for(let t=0;t<this.components.length;++t){const i=this.components[t].extractMeshIncrement(e);if(i)return i}return null}getHideableMateConnectorFeatureIds(){return this.mateConnectorComponent.getHideableFeatureIds()}getHideableSketchFeatureIds(){return this.sketchComponent.getHideableFeatureIds()}getHideablePlaneFeatureIds(){return this.planeComponent.getHideableFeatureIds()}getHideableFeatureIds(){return this.hideableFeatureIds}addManagedIdMappings(e){for(const t of Object.values(e)){const e=t.managedData;if(e)for(const t of e)for(const e of t.bodyIds){const i=t.creationId;switch(t.type){case W.dry.SKETCH:this.sketchComponent.addManagedIdMappings(i,e);break;case W.dry.CONSTRUCTION_PLANE:this.planeComponent.addManagedIdMappings(i,e);break;case W.dry.MATE_CONNECTOR:this.mateConnectorComponent.addManagedIdMappings(i,e);break;default:this.sketchComponent.addManagedIdMappings(i,e),this.planeComponent.addManagedIdMappings(i,e),this.mateConnectorComponent.addManagedIdMappings(i,e)}}}}fixPartAndDisplayDataForMessage(e){this.bodyIdsThatAreInsertableBuffers||(this.bodyIdsThatAreInsertableBuffers=new Set);for(const t of Object.values(e.partIdAndTessellationSettingToBuffers)){const i=Object.values(t);if(i.length>0&&i[0]instanceof W.l48){const t=i[0],s=t.getId();e.deterministicPartIdToData[s]=t.partData,e.partDisplayData.push(t.partDisplayData),this.bodyIdsThatAreInsertableBuffers.add(s)}}for(const t of Object.values(e.sketchFeatureIdAndTessellationSettingToBuffers)){const i=Object.values(t);if(i.length>0&&i[0]instanceof W.VtB){const t=i[0];t.getId();for(const[i,s]of Object.entries(t.bodyIdToPartData))e.deterministicPartIdToData[i]=s,this.bodyIdsThatAreInsertableBuffers.add(i)}}}processDisplayData(e,t,i,s,n){if((this.isBase()?e.buildFullElementId().toString():e.elementId)!==(this.isBase()?this.getFullElementId():this.id))return void It.log.warn("An attempt was made to update part studio graphics with display data that do not belong to it.");if(this.updateExternalState(e.isExternal,i),e.isNoop)return;e.fromDisplayCache&&(this.isCachedPartStudioPendingUse=!0),this.viewer.areOptimizedBuffersEnabled&&this.fixPartAndDisplayDataForMessage(e),this.partColorCycle||(this.partColorCycle=e.partColorCycle),this.hideableFeatureIds=[];let r,a,o,h=0;const c=new mh.B7("processDisplayData");if(e.incremental){const t=new mh.B7("Deleting entities");for(r=0;r<this.components.length;++r)this.components[r].processDeletions(e);t.report()}else this.reset();let l=!this.viewer.getIsForFlattenedDisplay()||!(0,Q.isEmptyObjectOrArray)(e.appearanceIdToAppearanceOverride);if(!l)for(const t in e.deterministicPartIdToData)if(e.deterministicPartIdToData[t].isForFlattenedView()){l=!0;break}l||this.bodyComponent.updateBodyDisplayData(e,s);const u=new mh.B7("Updating entities");for(r=0;r<this.components.length;++r){this.viewer.getIsForFlattenedDisplay()&&!l||this.components[r].processAdditionsAndChanges(e,t,s);const i=this.components[r].getHideableFeatureIds();for(a=0;a<i.length;++a)this.hideableFeatureIds.push(i[a])}if(this.bodyComponent.updateCompositeConstituentCounts(e),this.annotationComponent.processDisplayData(e),u.report(),e.bodyIdToEntityAppearanceSettingsChanged&&(this.bodyIdToEntityAppearanceSettings=e.bodyIdToEntityAppearanceSettings),e.partDisplayData){const t=e.partDisplayData.length;for(o=0;o<t;o++){const t=e.partDisplayData[o].id;if(e.partDisplayData[o].baseAppearanceSettings=this.bodyIdToEntityAppearanceSettings[t],!e.partDisplayData[o].baseAppearanceSettings){const i=this.retrieveBodyMetaData(t);if(i&&i.isClosedComposite){const s=e.partDisplayData[o];let n=!1;const r=i.constituentBodyIds.length;for(h=0;h<r;h++){const e=i.constituentBodyIds[h];if(!this.bodyIdToEntityAppearanceSettings[e])continue;const r=this.bodyIdToEntityAppearanceSettings[e];if(n){if(s.baseAppearanceSettings&&r.colorIdToBaseEntityAppearanceEntry){const e=r.colorIdToBaseEntityAppearanceEntry;for(const t in e)if(t){const i=e[t];i&&(s.baseAppearanceSettings.colorIdToBaseEntityAppearanceEntry[t]?s.baseAppearanceSettings.colorIdToBaseEntityAppearanceEntry[t].affectedDeterministicIds=s.baseAppearanceSettings.colorIdToBaseEntityAppearanceEntry[t].affectedDeterministicIds.concat(i.affectedDeterministicIds):s.baseAppearanceSettings.colorIdToBaseEntityAppearanceEntry[t]=i)}}}else n=!0,s.baseAppearanceSettings=r,this.bodyIdToEntityAppearanceSettings[t]=s.baseAppearanceSettings}}}}}this.isForIncontextDisplay||this.viewer.getIsForFlattenedDisplay()||this.viewer.getEventDispatcher().trigger(VM.W2,e.partDisplayData,e.buildFullElementId(),e.usage,this.bodyComponent.bodyMetaData,n),this.dimensionComponent.processDisplayData(e),this.imageComponent.processDisplayData(e),e.incremental||t||this.bodyComponent.reloadOccurrences(),t&&(this.dimensionComponent.updateDisplays(),this.imageComponent.updateDisplays()),this.processInContextData(e,t),this.viewer.getEventDispatcher().trigger(VM.CD,e,s),c.report()}processReceivedInsertableData(e){const t={},i={};i[e.getTessellationSetting()]=e,t[e.getId()]=i;const s=e.isSketchFeature()?this.getSketchComponent():this.getBodyComponent(),n=e.getId();s.processPrecompiledGraphicsBuffers(t),e.isSketchFeature()||s.refreshBodyOccurrenceForBodyId(n),this.viewer.requestDraw()}processInContextData(e,t){if(this.isBase()){let i,s=!1;if(e.assemblyReferenceDisplayData){const t=e.assemblyReferenceDisplayData.assemblyReferences;for(i=0;i<t.length;i++)t[i].visibility===W.HRI.VISIBLE&&(s=!0)}if(s){if(t)for(this.referencedInContextAssemblyIds=[],this.visibleInContextAssembly="",this.editedInContextOccurrences=[],this.displayedContextTransform={},i=0;i<e.assemblyReferenceDisplayData.assemblyReferences.length;i++){const t=e.assemblyReferenceDisplayData.assemblyReferences[i],s=t.isTransient?"":t.referenceNodeId,n=t.assemblyDisplayData;t.occurrencesToExclude.forEach((e=>{this.editedInContextOccurrences.push({assemblyElementId:n.elementId,occurrence:e,contextId:s})}));const r=(0,Js.dV)(n.elementId);let a=n.elementId;r!==e.assemblyReferenceDisplayData.elementId&&(a=(0,Js.HL)(n.elementId,e.assemblyReferenceDisplayData.elementId,t.referenceNodeId)),this.referencedInContextAssemblyIds.push(a),t.visibility===W.HRI.VISIBLE&&(this.visibleInContextAssembly=a),this.displayedContextTransform[s]=t.transform}}else t&&this.removeInContextAssemblies()}else if(this.viewer.getModelViewManagers().getManager().isDisplayingIncontextAssembly()){const e=!0;(0,VM.xA)().trigger(VM.bh,e)}}updateExternalState(e,t){this.isExternal=e,this.isForIncontextDisplay=!!t}getReferencedInContextAssemblyIds(){return this.referencedInContextAssemblyIds}isDisplayingIncontextAssembly(){return!!this.visibleInContextAssembly}getVisibleInContextAssemblyId(){return this.visibleInContextAssembly}removeInContextAssemblies(){this.viewer.getModelViewManagers().getManager().resetAllIncontextGraphicsForPartstudio(this.getElementId()),this.referencedInContextAssemblyIds=[],this.visibleInContextAssembly="",this.editedInContextOccurrences=[]}getEditedOccurrenceForAssembly(e,t){const i=(0,Wd.Z)(this.editedInContextOccurrences,{assemblyElementId:e,contextId:t});return i?i.occurrence:null}removeInstantiationForEditing(e){this.removeInContextAssemblies();for(let t=0;t<this.components.length;++t)this.components[t].removePartStudioInstantiation(e);this.dimensionComponent.remove(),this.imageComponent.remove()}instantiateForEditingInNode(e){this.isCachedPartStudioPendingUse=!1,this.bodyComponent.instantiateForPartStudio(e),this.sketchComponent.instantiateForPartStudio(e),this.mateConnectorComponent.instantiateForPartStudio(e),this.planeComponent.instantiateForPartStudio(e),this.pointBodyComponent.instantiateForPartStudio(e),this.dimensionComponent.updateDisplays()}getDimensionGraphic(e,t){return this.dimensionComponent.getDimensionGraphic(e,t)}addOrUpdateOccurrence(e,t,i){this.isCachedPartStudioPendingUse=!1,this.sketchComponent.addOrUpdateOccurrence(e,t),this.bodyComponent.addOrUpdateOccurrence(e,t),i&&this.mateConnectorComponent.addOrUpdateOccurrence(e,t)}removeOccurrence(e,t){this.sketchComponent.removeOccurrence(e,t),this.bodyComponent.removeOccurrence(e,t),this.mateConnectorComponent.removeOccurrence(e,t),this.imageComponent.removeOccurrence(e)}getChildNodesWithId(e,t){const i=[],s=t?[t]:this.getSceneGraph().getAllNodesWithId(RI),n=function(t){return t.getId()===e&&i.push(t),!1};for(let e=0;e<s.length;++e)s[e].walk(n);return i}hideSketch(e){this.sketchComponent.hideShowFeature(e,Js.EE.HIDDEN),this.dimensionComponent.sketchHidden(e),this.imageComponent.onSketchHidden(e),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Js.EE.HIDDEN)}showSketch(e){this.sketchComponent.hideShowFeature(e,Js.EE.VISIBLE),this.dimensionComponent.sketchShown(e),this.imageComponent.onSketchShown(e),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Js.EE.VISIBLE)}displaySketchAsActive(e,t){void 0===t&&(t=!0),this.sketchComponent.displaySketchAsActive(e,t),this.dimensionComponent.displaySketchAsActive(e,t),t?this.imageComponent.onSketchActivated(e):this.imageComponent.onSketchDeactivated(e)}displaySketchAsInactive(e){this.displaySketchAsActive(e,!1)}hasActiveSketch(){return this.sketchComponent.hasActiveSketch()}getPartNodes(e){return this.getChildNodesWithId(gp,e)}setPlaneAppearance(e,t){this.planeComponent.updateFeatureAppearance(e,t)}getBoundsOutsideElementNode(){const e=new Li.kB;return e.addBox(this.planeComponent.getVisiblePlaneBounds()),e.addBox(this.dimensionComponent.getVisibleDimensionBounds()),e.addBox(this.mateConnectorComponent.getVisibleMateConnectorBounds()),e}showPointBodies(e){this.pointBodyComponent.hideShowFeature(e,Js.EE.VISIBLE),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Js.EE.VISIBLE)}hidePointBodies(e){this.pointBodyComponent.hideShowFeature(e,Js.EE.HIDDEN),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Js.EE.HIDDEN)}hidePart(e){const t=this.bodyComponent.hideShowBody(e,Js.EE.HIDDEN,DI.KF);return t&&this.trigger("BODY_VISIBILITY_CHANGE."+e,Js.EE.HIDDEN),t}showPart(e){const t=this.bodyComponent.hideShowBody(e,Js.EE.VISIBLE,DI.KF);return t&&this.trigger("BODY_VISIBILITY_CHANGE."+e,Js.EE.VISIBLE),t}changePartColor(e,t,i){this.bodyComponent.setBodyColor(e,t,i)}changePartOpacity(e,t,i){this.bodyComponent.setBodyOpacity(e,t,i)}getPartColor(e){return this.bodyComponent.getBodyColor(e).slice(0)}getPartOpacity(e){return this.bodyComponent.getBodyColor(e)[3]}getEntityColor(e){return this.bodyComponent.getEntityColor(e)}hideConstructionPlane(e){this.planeComponent.hideShowFeature(e,Js.EE.HIDDEN),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Js.EE.HIDDEN)}showConstructionPlane(e){this.planeComponent.hideShowFeature(e,Js.EE.VISIBLE),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Js.EE.VISIBLE)}hideFeatureBodies(e,t){this.bodyComponent.hideShowFeature(e,Js.EE.HIDDEN,t),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Js.EE.HIDDEN)}showFeatureBodies(e,t){this.bodyComponent.hideShowFeature(e,Js.EE.VISIBLE,t),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Js.EE.VISIBLE)}hideMateConnector(e,t){this.mateConnectorComponent.hideShowFeature(e,Js.EE.HIDDEN,null,t),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Js.EE.HIDDEN)}showMateConnector(e,t){this.mateConnectorComponent.hideShowFeature(e,Js.EE.VISIBLE,null,t),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Js.EE.VISIBLE)}getEntitiesForFeature(e,t){let i=[];for(let s=0;s<this.components.length;++s){const n=this.components[s].getEntitiesForFeature(e,t);n&&(i=i.concat(n))}return i}getFilteredEntityIds(e){let t=[];for(let i=0;i<this.components.length;++i){const s=this.components[i].getEntitiesForFilterFunction(e);s&&(t=t.concat(s))}return t}getEntitiesForSketchGroup(e,t,i){return this.sketchComponent.getEntitiesForFeature(t,(function(t){let s=0===t.getSketchGroupId().indexOf(e);return t.isSketchTextEntity()&&(s=s&&["left","right","ascent","baseline"].some((function(e){return t.getSketchEntityId().indexOf(e)>0}))),i&&(s=s&&i(t)),s}))||[]}getEntitiesForBody(e,t){let i=[];for(let s=0;s<this.components.length;++s){const n=this.components[s].getEntitiesForBody(e,t);n&&(i=i.concat(n))}return i}retrieveSketchEntityDeterministicId(e,t){return this.sketchComponent.retrieveSketchEntityDeterministicId(e,t)}onDeletion(e){this.reset(e)}hasFeature(e){for(let t=0;t<this.components.length;++t)if(this.components[t].hasFeature(e))return!0;return!1}getFeatureVisibility(e){for(let t=0;t<this.components.length;++t)if(this.components[t].hasFeature(e))return this.components[t].getFeatureVisibility(e);return Js.EE.HIDDEN}hasBody(e){for(let t=0;t<this.components.length;++t)if(this.components[t].hasBody(e))return!0;return!1}getBodyVisibility(e){return this.bodyComponent.isBodyVisible(DI.KF,e)?Js.EE.VISIBLE:Js.EE.HIDDEN}getUIElementsForSelection(e){let t=[];return(e.isMateConnector()||e.isFeature())&&(t=this.mateConnectorComponent.getUIElementsForSelection(e)),(e.isEntity()||e.isFromConstructionGeometry()||e.isDerivedFeature())&&(t=t.concat(this.planeComponent.getUIElementsForSelection(e))),t}getInContextImportEntityIdsForSelection(e){let t=[];const i=e.getInContextImports();if(i&&i.length>0)for(let e=0;e<i.length;++e){const s=this.getEntitiesForFeature(i[e],zd);t=t.concat(s)}return t||[]}getEntityIdsForSelection(e){let t=[];if(e.isMateConnector())t=this.mateConnectorComponent.getEntityIdsForSelection(e);else if(e.isProperty()){if(e.getChildSelections())for(let i=0;i<e.getChildSelections().length;++i)t=t.concat(this.getEntityIdsForSelection(e.getChildSelections()[i]))}else if(e.isEntity())t.push(e.getIdString());else if(e.isFeature())t=this.getEntitiesForFeature(e.getIdString(),zd);else if(e.isSketchGroup()){const i=e.getSketchGroupFeatureId();i?t=this.getEntitiesForSketchGroup(e.getIdString(),i,zd):It.log.info("Sketch group selection did not have a valid sketch id")}else if(e.isBody()){const i=this.getEntityIdsForBodySelection(e.getIdString(),e.getOccurrence(),e.getBodyMetaData());i&&i.length&&(t=t.concat(i))}else if(e.isTableItem()){const i=e.getOccurrence();for(let s=0;s<e.getDeterministicIdList().length;++s){const n=e.getDeterministicIdList()[s],r=this.getEntityIdsForBodySelection(n,i,this.retrieveBodyMetaData(n));r&&r.length?t=t.concat(r):t.push(n)}}return t||[]}getEntityIdsForBodySelection(e,t,i){let s=[];s=i&&i.isComposite?i.constituentBodyIds:[e];let n=[];for(let e=0;e<s.length;++e){const i=s[e],r=this.retrieveBodyMetaData(i);if(r&&this.bodyComponent.hasBodyOccurrence(r.meshGroupId,t))if(this.bodyComponent.isBodyLoaded(i)){const e=this.getEntitiesForBody(i,Xd);e&&e.length&&(n=n.concat(e))}else n.push(i);else{const e=this.retrieveBodyMetaData(i),t=(null==e?void 0:e.isPointBody())?null:zd,s=this.sketchComponent.getEntitiesForBody(i,t);s&&(n=s)}}return n}getOccurrenceEntityIdsForHighlight(e){if(e){const t=this.viewer.getIdForOccurrence(e);return this.sketchComponent.getEntitiesForOccurrenceSelection(t)||[]}return[]}getOccurrencesForSelection(e){let t=[];if(e.isMateConnector())t=this.mateConnectorComponent.getOccurrencesForSelection(e);else if(e.isBody()){const i=this.bodyComponent.retrieveBodyMetaData(e.getBodyId());if(i&&!i.hasTessellationSettings()){const i=this.bodyComponent.getPartStudioBodyOccurrenceName(e.getBodyId());t.push(W._oC.getOccurrenceFromPathString(i))}}return t}getOccurrenceBounds(e){const t=new Li.kB;for(let i=0;i<this.components.length;i++){const s=this.components[i];t.addBox(s.getOccurrenceBounds(e))}return t}setPlaneName(e,t){this.planeComponent.setPlaneName(e,t)}getMateConnectorGraphics(e,t){return this.mateConnectorComponent.getMateConnectorGraphics(e,t)}getMateConnectorData(e,t){return this.mateConnectorComponent.getMateConnectorData(e,t)}getAllMateConnectorGraphics(e){const t=this;let i=[];return this.mateConnectorComponent.featureToIds.each((function(s,n){if(t.hasMateConnectorDefinition(e,n)){const s=t.getMateConnectorGraphics(e,n);s&&(i=i.concat(s))}return!1})),i}hasMateConnectorDefinition(e,t){return!!this.getMateConnectorGraphics(e,t)}getStatistics(e,t=!1){const i=this.bodyComponent.getStatistics(e,t),s=this.errorComponent.getEntityCount();return s>0&&(i.errorMessage=this.getFullElementId()+" has "+s+" entities with failed tessellation."),i}getBoundsForEntities(e){if(!e||0===e.length)return null;const t=new Li.kB;for(let i=0;i<e.length;++i){const s=this.extractMeshIncrement(e[i]);s&&t.addBox(s.getBounds())}return t}getFeatureBounds(e){const t=this.getBoundsForEntities(this.getEntitiesForFeature(e,(function(e){return!e.isFromSketch()||e.isUserSketchEntity()})));return t&&t.addBox(this.dimensionComponent.getDimensionBoundsForFeature(e)),t}getEntityBounds(e,t){const i=this.retrieveEntityMetaData(e);if(!i)return null;if(i.isFromBody()&&!this.bodyComponent.isBodyActiveInView(this.bodyComponent.getEntityBodyGroupId(i),t))return null;const s=this.extractMeshIncrement(e);return(null==s?void 0:s.getBounds())||null}getBodyBounds(e,t){if(this.bodyComponent.isBodyActiveInView(e,t)){const t=this.retrieveBodyMetaData(e);if(t)return t.getBounds()}return null}getBodyComponent(e){return this.bodyComponent}getDimensionComponent(){return this.dimensionComponent}getPartStudioBodyOccurrenceIds(){return this.bodyComponent.getPartStudioBodyOccurrenceIds()}getPartStudioOccurrenceIds(){const e=this.bodyComponent.getPartStudioBodyOccurrenceIds(),t=[this.sketchComponent.sketchComponentElementId],i=this.planeComponent.getPartStudioPlaneOccurrenceIds();return e.concat(t,i)}getContextCameraData(e){return this.displayedContextTransform[e]?this.viewer.getCameraData(this.displayedContextTransform[e].getGlMatrix()):{camera:null,cameraExtents:null}}getInstantiatedTriangleCount(){return this.bodyComponent.getInstantiatedTriangleCount()}getSketchComponent(){return this.sketchComponent}getImageComponent(){return this.imageComponent}getMateConnectorComponent(){return this.mateConnectorComponent}getPlaneComponent(){return this.planeComponent}getAnnotationComponent(){return this.annotationComponent}getIsInternal(){return!this.isExternal&&!this.isForIncontextDisplay}getEstimatedMemoryUsageOfBodies(){return this.bodyComponent.getEstimatedMemoryUsage()}unloadBody(e){this.bodyComponent.unloadBody(e)}getPartStudioOccurrenceIdForSelection(e){return e.getOccurrence()?DI.Qy:e.isFromBody()?this.bodyComponent.getCorrectedBodyOccurrenceId(e.getBodyId(),DI.KF):e.isFromSketch()?this.sketchComponent.sketchComponentElementId:e.isConstructionPlane()?this.planeComponent.getSelectionOccurrenceId(e):DI.KF}getBodyTransform(e,t){const i=this.bodyComponent;let s=i.partStudioBodyIdToOccurrenceId[e];if(!s){const n=t.getModelViewManagers().getManager().alternateEntityMapping.get(e);n&&(s=i.partStudioBodyIdToOccurrenceId[n])}return s?(0,Q.as)(fT,t).getOccurrenceDataManager().getOccurrenceTransform(s):ge.create()}getMeshOwnerId(){return this.meshOwnerId}updateEntityHighlight(e,t,i,s){for(let n=0;n<this.components.length&&!this.components[n].updateEntityHighlight(e,t,i,s);++n);}getElementType(){return W.GNh.PARTSTUDIO}collectComponentsForHeapDump(e){this.bodyComponent.collectComponentsForHeapDump(e)}updatePSOI(e){this.bodyComponent.updatePSOI(e)}getDecalIdsAffectingEntity(e){return this.bodyComponent.getDecalComponent().getDecalIdsAffectingEntity(e)}onAppearanceConstantsUpdated(){for(const e of this.components)e.onAppearanceConstantsUpdated()}onRenderingModeChanged(){for(const e of this.components)e.onRenderingModeChanged()}}class Zd{constructor(e,t,i){this.usage=e,this.elementId=t,this.viewer=i,this.dimensionData={},this.dimensionDisplays={},this.visibleDimensionBounds=null,(0,Ih.Yk)(i),this.activeSketchIds=new St.StringSet}processDisplayData(e){if(this.usage!==Ls.L.PREVIEW){this.dimensionData={};for(let t=0;t<e.dimensions.length;++t){const i=e.dimensions[t];i&&i.isAssociatedWithFlat===this.viewer.getIsForFlattenedDisplay()&&(this.dimensionData[i.getFullyQualifiedId()]=i)}}}reset(){this.remove(),this.dimensionData={},this.activeSketchIds.clear()}remove(){Object.values(this.dimensionDisplays).forEach((function(e){e.remove()})),this.dimensionDisplays={}}isDimensionForDisplayedSheetMetalModel(e,t){if(!this.viewer.getIsForFlattenedDisplay())return!0;const i=this.viewer.getModelViewManagers().getManager(),s=t||i.getSelectedSheetmetalModelId(),n=this.dimensionData[e];if(n){return s===i.getDisplayedPartStudio().getSketchComponent().getSMModelIdForSketch(n.featureId)}return!0}showDimensionsWithSheetmetalModelIdOnly(e,t){for(const t in this.dimensionDisplays){const i=this.isDimensionForDisplayedSheetMetalModel(t,e),s=this.dimensionDisplays[t],n=this.dimensionData[t];i&&n&&this.activeSketchIds.contains(n.featureId)?s&&(s.show(),this.resetVisibleDimensionBounds()):s.hide()}}updateDisplays(){let e,t;const i=[];for(e in this.dimensionDisplays)this.dimensionData.hasOwnProperty(e)||i.push(e);for(let s=0;s<i.length;++s)e=i[s],t=this.dimensionDisplays[e],t.remove(),delete this.dimensionDisplays[e];Object.entries(this.dimensionData).forEach((([e,i])=>{if(t=this.dimensionDisplays[e],!t){if(t=(0,hE.j$)(i,this.elementId,this.viewer),!t)return;this.dimensionDisplays[e]=t,this.activeSketchIds.contains(i.featureId)&&this.isDimensionForDisplayedSheetMetalModel(e)?(t.show(),this.resetVisibleDimensionBounds()):t.hide()}if(this.viewer.getIsForFlattenedDisplay()){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio(),s=e.getSketchComponent().getOwnerFlattenedBodyIdForSketch(i.featureId);if(s){const i=e.retrieveBodyMetaData(s);if(i){const s=e.getBodyComponent().getTransformFromSheetMetalBodyMetaData(i);t.setAppliedTransform(s)}}}t.updateFromDisplayData(i)}),this),this.updateDimensionsToLatestFromModel()}displaySketchAsActive(e,t){this.activeSketchIds.contains(e)!==t&&(Object.entries(this.dimensionDisplays).forEach((([i,s])=>{s.getFeatureId()===e&&(t&&this.isDimensionForDisplayedSheetMetalModel(i)?s.show():s.hide())}),this),t?this.activeSketchIds.add(e):this.activeSketchIds.remove(e),this.resetVisibleDimensionBounds(),this.updateDimensionsToLatestFromModel())}updateDimensionsToLatestFromModel(){const e=ga.W.getSingleton().getModelTreeState(this.elementId);e&&this.updateDimensionsFromModel(e.getModelTree())}getDimensionId(e,t,i){let s="";return i&&Zd.parameterIdsIncludedInDisplayData.includes(i)&&(s=i),W._w.createFullyQualifiedId(e,t,s)}updateDimensionsFromModel(e){const t=new Map,i=e.children;for(const e of i)if(e instanceof W.OEu&&this.activeSketchIds.contains(e.featureId))for(const i of e.constraints)for(const s of i.parameters){if(s instanceof W.nmJ){const n=this.getDimensionId(e.featureId,i.entityId,s.parameterId),r=s.getParameterForCurrentConfiguration(ps.Jq.ConfigurationsService);t.set(n,{configured:!0,expression:Kd(r)?null==r?void 0:r.expression:void 0});break}if(Kd(s)){const n=this.getDimensionId(e.featureId,i.entityId,s.parameterId);t.set(n,{expression:s.expression})}}Object.entries(this.dimensionDisplays).forEach((([e,i])=>{var s,n;const r=t.get(e);i.setIsConfigured(null!==(s=null==r?void 0:r.configured)&&void 0!==s&&s),i.setExpression(null!==(n=null==r?void 0:r.expression)&&void 0!==n?n:"")}))}sketchHidden(e){this.activeSketchIds.contains(e)&&Object.values(this.dimensionDisplays).forEach((t=>{t.getFeatureId()===e&&(t.hide(),this.resetVisibleDimensionBounds())}),this)}sketchShown(e){this.activeSketchIds.contains(e)&&Object.entries(this.dimensionDisplays).forEach((([t,i])=>{i.getFeatureId()===e&&this.isDimensionForDisplayedSheetMetalModel(t)&&(i.show(),this.resetVisibleDimensionBounds())}),this)}getDimensionGraphic(e,t,i){const s=this.getDimensionId(e,t,i);return this.dimensionDisplays[s]}getDimensionGraphicFromSketch(e){return Object.values(this.dimensionDisplays).filter((t=>{var i;return(null===(i=null==t?void 0:t.getDisplayData())||void 0===i?void 0:i.featureId)===e}))}getDimensionBoundsForFeature(e){if(!this.activeSketchIds.contains(e))return null;const t=new Li.kB;return Object.values(this.dimensionDisplays).forEach((function(i){i.getFeatureId()===e&&t.addBox(i.getFitBounds())}),this),t}resetVisibleDimensionBounds(){this.visibleDimensionBounds=null}getVisibleDimensionBounds(){return this.activeSketchIds.isEmpty()?null:(this.visibleDimensionBounds||(this.visibleDimensionBounds=new Li.kB,Object.values(this.dimensionDisplays).forEach((e=>{var t;e.isVisibleToUser()&&(null===(t=this.visibleDimensionBounds)||void 0===t||t.addBox(e.getFitBounds()))}),this)),this.visibleDimensionBounds)}}Zd.parameterIdsIncludedInDisplayData=[W.s7b.RHO_PARAMETER_NAME,W.s7b.BEZIER_DEGREE_PARAMETER_NAME,W.s7b.PATTERN_INSTANCE_COUNT1_PARAMETER_NAME,W.s7b.PATTERN_INSTANCE_COUNT2_PARAMETER_NAME];const Yd=new Set([W.s7b.LENGTH_PARAMETER_NAME,W.s7b.ANGLE_PARAMETER_NAME,W.s7b.RHO_PARAMETER_NAME,W.s7b.BEZIER_DEGREE_PARAMETER_NAME,W.s7b.PATTERN_INSTANCE_COUNT1_PARAMETER_NAME,W.s7b.PATTERN_INSTANCE_COUNT2_PARAMETER_NAME]);function Kd(e){return e instanceof W.wtM&&Yd.has(e.parameterId)}const jd=Ht;class Qd{constructor(e,t,i,s,n=!1,r=1){this.name=e,this.dimension=t,this.type=i,this.incrementProperty=s,this.normalize=n,this.secondDimension=r,this.elementCount=this.dimension*this.secondDimension,this.secondDimension>1&&this.dimension!==this.secondDimension&&It.log.warn("Only square matrices are supported as glsl attributes. Attribute "+this.name+" will have issues")}typeSize(){return zt(this.type)}sizeInBytes(){return this.elementCount*this.typeSize()}}var $d;!function(e){e.POSITION="aVertexPosition",e.NORMAL="aVertexNormal",e.OFFSET_VECTOR="aOffsetVector",e.COLOR="aVertexColor",e.PICKING="aPickId",e.TEXTURE="aTextureCoordinate",e.HIGHLIGHT_ID="aHighlightId",e.POINT_DATA="aPointData",e.EDGE_DATA="aEdgeData",e.PRIMITIVE_SIZE="aPrimitiveSize",e.PRIMITIVE_STYLE="aPrimitiveStyle",e.PRIMITIVE_RESTART="aPrimitiveRestart",e.OCCURRENCE_ID="aOccurrenceId",e.CONTACT_TRACTION="aContactTraction",e.CONTACT_PAIR_COORDINATE="aContactPairCoordinate"}($d||($d={}));const Jd={POINT:new Qd($d.POSITION,3,jd.FLOAT,"points"),NORMAL:new Qd($d.NORMAL,3,jd.FLOAT,"normals"),OFFSET_VECTOR:new Qd($d.OFFSET_VECTOR,3,jd.FLOAT,"offsetVectors"),COLOR:new Qd($d.COLOR,4,jd.UNSIGNED_BYTE,"colors",!0),TEXTURE:new Qd($d.TEXTURE,2,jd.FLOAT,"textureCoordinates"),POINT_DATA:new Qd($d.POINT_DATA,1,jd.FLOAT,"pointData"),EDGE_DATA:new Qd($d.EDGE_DATA,4,jd.FLOAT,"edgeData"),PRIMITIVE_SIZE:new Qd($d.PRIMITIVE_SIZE,1,jd.FLOAT,"primitiveSizes"),PRIMITIVE_STYLE:new Qd($d.PRIMITIVE_STYLE,4,jd.UNSIGNED_BYTE,"primitiveStyles"),HIGHLIGHT_ID:new Qd($d.HIGHLIGHT_ID,4,jd.UNSIGNED_BYTE,"highlightVisibility",!0),CONTACT_TRACTION:new Qd($d.CONTACT_TRACTION,4,jd.UNSIGNED_BYTE,"contactTraction",!1,4),CONTACT_PAIR_COORDINATE:new Qd($d.CONTACT_PAIR_COORDINATE,4,jd.FLOAT,"contactPairCoordinate",!1,4)};var eg;!function(e){e.LOWEST="LOWEST",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH",e.DEFAULT="MEDIUM"}(eg||(eg={}));const tg=Jd,ig=[tg.POINT,tg.NORMAL,tg.OFFSET_VECTOR,tg.COLOR,tg.TEXTURE,tg.POINT_DATA,tg.EDGE_DATA,tg.PRIMITIVE_SIZE,tg.PRIMITIVE_STYLE,tg.CONTACT_TRACTION,tg.CONTACT_PAIR_COORDINATE];class sg{constructor(e){this.parentMesh=e,this.vertexBuffer=null,this.indexBuffer=null,this.attributeBindings=null}getVertexBuffer(){return this.vertexBuffer}getIndexBuffer(){return this.indexBuffer}getParentMesh(){return this.parentMesh}setParentMesh(e){this.parentMesh=e}logInconsistency(e){sg.loggedInconsistency||(It.log.warn(e),sg.loggedInconsistency=!0)}hasOptimizedBuffers(){return!1}getComponentCount(){return this.vertexBuffer?this.vertexBuffer.getComponentCount():0}isTriangleStrip(){return this.parentMesh.getPrimitiveType()===_i.MX.TRIANGLE_STRIP}reinitialize(){this.vertexBuffer=null,this.indexBuffer=null}areBuffersInitialized(){return(0,Q.objectsDefinedInSameWay)(this.vertexBuffer,this.indexBuffer)||this.logInconsistency("BEL-56218, BEL-55900, BEL-56214 The vertex buffer and index buffer were initialized independently"),!!this.vertexBuffer&&!!this.indexBuffer}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=null)}bindBuffers(e,t,i,s,n){e.setLastBufferBound(this)}buffersNeedBinding(e){return e.getLastBufferBound()!==this}initializeAttributes(e,t,i){for(let t=0;t<ig.length;++t){const i=ig[t],s=this.attributeBindings[i.name];s?e.vertexAttribPointer(i.name,s):e.enableVertexAttribArray(i.name,!1)}}bindAttributeStateWithoutVAOs(e,t,i,s){e&&(this.bindBuffers(i,t,s,!0,!1),this.initializeAttributes(t,i,s))}copyBuffersToGl(){if(!this.vertexBuffer||!this.indexBuffer)return;let e=this.vertexBuffer.copyToGl();return e=this.indexBuffer.copyToGl()||e,e}}sg.loggedInconsistency=!1;class ng extends sg{constructor(e,t,i,s,n,r){super(e),this.vertexCount=0,this.indexCount=0,this.vertexByteData=null,this.indexByteData=null,this.hasNormals=!1,this.meshGroupId="",this.meshRangeGroupIdHash=null,this.visible=!0,this.parents=null,this.bounds=null,this.vertexCount=t;let a=ng.VERTEX_SIZE,o=Jd.POINT.dimension;r&&(this.hasNormals=!0,a*=2,o*=2),this.vertexByteData=new ArrayBuffer(t*a);if(new Float32Array(this.vertexByteData,0,t*o).set(s,0),this.indexCount=i,i>0){this.indexByteData=new ArrayBuffer(i*ci());new(oi())(this.indexByteData,0,i).set(n,0)}}getBounds(e,t){if(!this.bounds){this.bounds=new Li.kB,this.areBuffersInitialized()||this.initializeBuffers();const e=this.vertexBuffer.getFloatView(),t=3*this.vertexCount;for(let i=0;i<t;i+=3)this.bounds.addXYZ(e[i],e[i+1],e[i+2])}return this.bounds}setMeshGroupId(e){this.meshGroupId=e}getMeshGroupId(){return this.meshGroupId}isVisible(){return this.visible}setIsVisible(e){this.visible=e}addParent(e){if(!e.hasBufferSet(this))throw new Error("This function should only be called from Node.addBufferSet()");this.parents||(this.parents=new Set),this.parents.add(e)}removeParent(e){if(e&&e.hasBufferSet(this))throw new Error("This function should only be called from Node.removeBufferSet()");this.parents&&this.parents.delete(e)}removeFromAllParents(){if(this.parents)for(const e of this.parents)e.removeSimpleBufferSet(this);this.parentMesh&&(this.parentMesh.removeBufferSet(this),this.parentMesh=null)}initializeBuffers(){if(this.areBuffersInitialized())return;if(!this.parentMesh)throw new Error("SimpleBufferSet has no parent mesh.");const e=this.parentMesh.viewer,t=e.getGlContext();let i=ng.VERTEX_SIZE;this.hasNormals&&(this.hasNormals=!0,i*=2),this.vertexBuffer=new MS(e,this.vertexCount*i,t.ARRAY_BUFFER,this.vertexCount);if(this.vertexBuffer.getFloatView().set(new Float32Array(this.vertexByteData),0),this.indexCount>0){this.indexBuffer=new MS(e,this.indexCount*ci(),t.ELEMENT_ARRAY_BUFFER,this.indexCount);const i=this.indexBuffer.getIndexView(oi()),s=oi();i.set(new s(this.indexByteData,0,this.indexCount),0)}}bindBuffers(e,t,i,s,n){super.bindBuffers(e,t,i,s,n),s&&this.vertexBuffer.bind(),this.indexBuffer.bind()}draw(e,t){if(!this.isVisible()||!this.parentMesh)return;if(e.activePass.isPickPass())return;this.areBuffersInitialized()||this.initializeBuffers();const i=e.getActiveShader(),s=this.parentMesh.viewer.getGlContext(),n=this.isTriangleStrip(),r=this.parentMesh.getPrimitiveType(),a=r===_i.MX.TRIANGLE_STRIP?s.TRIANGLE_STRIP:r===_i.MX.LINES?s.LINES:s.POINTS,o=this.buffersNeedBinding(e);if(this.parentMesh.copyOptimizedBuffersToGl(e),o){this.attributeBindings={};let t=Jd.POINT,s=0;this.attributeBindings[t.name]=new Of(+t.type,t.dimension,s,0,t.normalize,t.secondDimension),this.hasNormals&&(t=Jd.NORMAL,s=this.vertexCount*Jd.POINT.dimension*4,this.attributeBindings[t.name]=new Of(+t.type,t.dimension,s,0,t.normalize,t.secondDimension)),this.bindAttributeStateWithoutVAOs(o,i,e,n)}s.drawElements(a,this.indexBuffer.getComponentCount(),hi(),0)}getMeshRangesGroupIdHash(){if(this.meshRangeGroupIdHash)return this.meshRangeGroupIdHash;if(this.meshGroupId){this.meshRangeGroupIdHash=0;for(let e=0;e<this.meshGroupId.length;e++)this.meshRangeGroupIdHash+=this.meshGroupId.charCodeAt(e)}return this.meshRangeGroupIdHash}hasOptimizedBuffers(){return!0}makeSceneDebugObject(e){let t="SimpleBufferSet ("+this.meshGroupId+"): ";t+="vertexCount: "+this.vertexCount,t+=", indexCount: "+this.indexCount;const i=[];return i.push({text:"Visible? : "+this.isVisible(),children:[]}),this.bounds&&i.push(this.bounds.makeSceneDebugObject()),{text:t,children:i,state:{opened:e<2}}}}ng.VERTEX_SIZE=12;class rg{constructor(e,t,i){this.parent=e,this.viewer=t,this.idToMetaData={},this.childFeatureIds=new Set,this.removedBaseIncrements=null,this.featureVisibility={},(0,Ih.Yk)(t),this.usage=void 0===i?Ls.L.BASE:i,this.featureToIds=new Ol.TemplatedNestedMap,this.bodyToEntity=new Ol.TemplatedNestedMap}copyToClone(e){e.featureToIds=this.featureToIds.cloneNested(),e.bodyToEntity=this.bodyToEntity.cloneNested();for(const t in this.idToMetaData){const i=this.idToMetaData[t],s=(0,Q.shallowClone)(i);e.idToMetaData[t]=s,s.setBodyId(i.getBodyId());const n=e.retrieveBodyMetaData(s.getBodyId());n&&s.setBodyMetaData(n);const r=i.getMeshIncrement();r&&(s.setMeshIncrement(r.clone(e.getMeshOwnerId())),e.isInstantiated()&&e.updateEntityGraphics(t,s.getMeshIncrement(),s))}}copyToPreview(e){for(const t in this.idToMetaData)e.idToMetaData[t]=this.idToMetaData[t];e.featureToIds=this.featureToIds.cloneNested(),e.bodyToEntity=this.bodyToEntity.cloneNested();for(const t in this.featureVisibility)e.featureVisibility[t]=this.featureVisibility[t]}reset(e){if(this.removedBaseIncrements=null,this.featureToIds.clear(),this.bodyToEntity.clear(),!e)for(const e in this.idToMetaData)this.removeMeshIncrement(e);this.idToMetaData={}}isInstantiated(){return!0}isForBase(){return this.usage===Ls.L.BASE}getEntityIdManager(){return this.parent.getEntityIdManager()}getMeshManager(){return this.parent.getMeshManager()}getSharedBaseMeshManager(){return this.parent.getSharedBaseMeshManager()}getMeshOwnerId(){return this.parent.getMeshOwnerId()}getBodyManager(){return this.viewer.getBodyManager()}processDeletions(e){for(const t in e.deterministicIdToEntity){const i=e.deterministicIdToEntity[t];i&&(!i.isDeletion()&&this.handlesEntity(i)||this.removeEntity(t))}}processAdditionsAndChanges(e,t,i){for(const t in e.deterministicPartIdToData){const i=e.deterministicPartIdToData[t],s=this.parent.isBodyContainedInInsertableDisplayBuffers(t);for(let n=0;n<i.entityDIds.length;++n){const r=i.entityDIds[n],a=e.deterministicIdToEntity[r];if(!a||a.isDeletion()||!this.handlesEntity(a,i))continue;let o=null;(s||(o=BI(a,r,this.getEntityIdManager().getOrCreateIdForName(r)),o||!this.expectsTessellation()))&&(this.removeOldEntityGraphics(r,a),this.addIdMappings(r,a,t,e),s||(a.setMeshIncrement(o),this.isInstantiated()&&this.updateEntityGraphics(r,o,a)),this.viewer.getIsForFlattenedDisplay()===i.isForFlattenedView()&&a.removeGeometry())}}}addOrUpdateBodyOccurrenceBufferSetToNode(e,t,i,s,n,r){const a=t.getBufferSetForGroup(i,this.getMeshOwnerId(),r.primitiveType,eg.DEFAULT);a&&e.addOccurrenceBufferSetToNode(r,s,n,a)}processPrecompiledGraphicsBuffers(e){if(this.viewer.areOptimizedBuffersEnabled)for(const[t,i]of Object.entries(e)){const e=Object.values(i);if(0===e.length)continue;const s=e[e.length-1];if(!(null==s?void 0:s.graphicsBuffers))continue;const n=this.retrieveBodyMetaData(t);if(n&&n.isForFlattenedView()!==this.viewer.getIsForFlattenedDisplay())continue;const r=s.graphicsBuffers,a=r[W.bdZ.POINTS],o=r[W.bdZ.LINES],h=r[W.bdZ.TRIANGLE_STRIP];if(a){const e=a[W.xB1.ARRAY_BUFFER];if(e){e.setPrimitiveType(_i.MX.POINTS);e.mapGraphicsAttributeToComponentCount[W.hOe.POINT],e.bufferData}}if(o){const e=o[W.xB1.ARRAY_BUFFER];if(e){const i=e.mapGraphicsAttributeToComponentCount[W.hOe.POINT],n=e.bufferData,r=new Float32Array(n.buffer,0,i*Jd.POINT.dimension),a=o[W.xB1.ELEMENT_ARRAY_BUFFER];if(a){a.setPrimitiveType(_i.MX.LINES);const e=a.bufferData,n=a.mapGraphicsAttributeToComponentCount[W.hOe.INDEX],o=new(oi())(e.buffer,0,n),h=new ng(null,i,n,r,o);h.setMeshGroupId(t),this.getMeshManager().addBufferSet(h,a,t,this.getMeshOwnerId(),s.getTessellationSetting())}}}if(h){const e=h[W.xB1.ARRAY_BUFFER];if(e){const i=e.mapGraphicsAttributeToComponentCount[W.hOe.POINT],n=e.bufferData,r=e.mapGraphicsAttributeToComponentCount[W.hOe.NORMAL];let a=Jd.POINT.dimension,o=!1;r&&r>0&&(o=!0,a+=Jd.NORMAL.dimension);const c=new Float32Array(n.buffer,0,i*a),l=h[W.xB1.ELEMENT_ARRAY_BUFFER];if(l){l.setPrimitiveType(_i.MX.TRIANGLE_STRIP);const e=l.bufferData,n=l.mapGraphicsAttributeToComponentCount[W.hOe.INDEX],r=new(oi())(e.buffer,0,n),a=new ng(null,i,n,c,r,o);a.setMeshGroupId(t),this.getMeshManager().addBufferSet(a,l,t,this.getMeshOwnerId(),s.getTessellationSetting())}}}}}hasBody(e){return this.bodyToEntity.has(e)}retrieveBodyMetaData(e){const t=this.bodyToEntity.get(e);let i=null;return t&&t.each((function(e,t){const s=this.idToMetaData[t];return s&&(i=s.getBodyMetaData()),!!i}),this),i}retrieveAssociatedFeatureIds(e){return this.deterministicIdToAssociatedFeatureIds&&this.deterministicIdToAssociatedFeatureIds[e]||null}getEntitiesForBody(e,t){const i=this.bodyToEntity.get(e);return i?kI(i,this.idToMetaData,t):null}onAppearanceConstantsUpdated(){}onRenderingModeChanged(){}getHideableFeatureIds(){throw"This method should be overridden by a subclass"}updateEntityGraphics(e,t,i){throw"This method should be overridden by a subclass"}expectsTessellation(){return!0}getEntityCount(){return Object.keys(this.idToMetaData).length}containsEntity(e){return this.idToMetaData.hasOwnProperty(e)}getEntityMetaData(e){const t=this.idToMetaData[e];return t||null}removeEntity(e){this.removeBaseIncrement(e);this.idToMetaData[e]&&(this.removeMeshIncrement(e),this.removeIdMappings(e),this.getEntityIdManager().removeName(e))}extractMeshIncrement(e){const t=this.idToMetaData[e];return t?t.getMeshIncrement():null}addMeshIncrement(e,t){return e.pickId=this.getEntityIdManager().getOrCreateIdForName(e.id),this.getMeshManager().addMeshIncrement(e,this.getMeshOwnerId(),t)}getOccurrenceData(e){return this.viewer.getOccurrenceDataManager().getOccurrenceData(e)}getMeshIncrementDetails(e){return this.getMeshManager().getIncrementDetails(e,this.getMeshOwnerId())}getBaseMeshIncrementDetails(e){const t=this.getSharedBaseMeshManager();return t?t.getIncrementDetails(e,this.getMeshOwnerId()):null}hideMeshIncrement(e,t){const i=this.getOccurrenceData(t),s=this.getMeshIncrementDetails(e);i&&s&&i.hideIncrement(s,this.usage),this.hideBaseIncrement(e,t)}showMeshIncrement(e,t){const i=this.getOccurrenceData(t),s=this.getMeshIncrementDetails(e);i&&s&&i.showIncrement(s,this.usage),this.showBaseIncrement(e,t)}removeMeshIncrement(e){return this.getMeshManager().removeMeshIncrement(e,this.getMeshOwnerId())}setMeshIncrementRemovedFromBase(e,t){this.removedBaseIncrements||(this.removedBaseIncrements=new Ol.TemplatedNestedMap),this.removedBaseIncrements.insertNested(t,e,!0)}wasIncrementRemovedFromBase(e,t){return!!this.removedBaseIncrements&&this.removedBaseIncrements.hasNested(t,e)}removeBaseIncrement(e){this.removeBaseIncrementFromOccurrence(e,DI.KF)}removeBaseIncrementFromOccurrence(e,t){this.hideBaseIncrement(e,t)&&this.setMeshIncrementRemovedFromBase(e,t)}hideBaseIncrement(e,t){const i=this.getSharedBaseMeshManager();if(i){const s=this.getOccurrenceData(t);if(s){const t=i.getIncrementDetails(e,this.getMeshOwnerId());if(t)return s.hideIncrement(t,this.usage),!0}}return!1}showBaseIncrement(e,t){const i=this.getSharedBaseMeshManager();if(i&&!this.wasIncrementRemovedFromBase(e,t)){const s=this.getOccurrenceData(t),n=i.getIncrementDetails(e,this.getMeshOwnerId());s&&n&&s.showIncrement(n,this.usage)}}removeOldEntityGraphics(e,t){this.removeEntity(e)}updateSMMapping(e,t){}addManagedIdMappings(e,t){const i=this.bodyToEntity.get(t);if(i)for(const t of i.getKeys()){const i=this.idToMetaData[t];i?!i.isDeletion()&&this.handlesEntity(i)&&(this.updateSMMapping(t,i),this.featureToIds.insertNested(e,t,!0),i.featureIds.find((t=>e===t))||(this.childFeatureIds.add(e),i.featureIds.push(e))):It.log.warn(`entityData was not present for entityId in part studio for usage - ${this.usage} in ${this.getComponentId()}`)}}addIdMappings(e,t,i,s){this.getEntityIdManager().getOrCreateIdForName(e),this.idToMetaData[e]=t;const n=t.getFeatureIds();for(let t=0;n&&t<n.length;++t)this.featureToIds.insertNested(n[t],e,!0);t.setBodyId(i),i&&this.bodyToEntity.insertNested(i,e,!0)}removeIdMappings(e){const t=this.idToMetaData[e];if(delete this.idToMetaData[e],!t)return;const i=t.getFeatureIds();for(let t=0;t<i.length;++t)this.featureToIds.removeNested(i[t],e),this.childFeatureIds.delete(i[t]);this.bodyToEntity.removeNested(t.getBodyId(),e)}hasFeature(e){return this.featureToIds.has(e)}getEntitiesForFeature(e,t){if(this.featureIdToAssociatedDeterministicIds&&this.featureIdToAssociatedDeterministicIds.hasOwnProperty(e)){const i=new Set;for(const s of this.featureIdToAssociatedDeterministicIds[e])this.bodyToEntity.has(s)?this.bodyToEntity.get(s).each(((e,s)=>{let n=!0;if(t){const e=this.idToMetaData[s];e&&t(e)||(n=!1)}n&&i.add(s)})):i.add(s);return[...i]}{const i=this.featureToIds.get(e);return i?kI(i,this.idToMetaData,t):null}}getEntitiesForFilterFunction(e){const t=[];for(const i in this.idToMetaData)e(this.idToMetaData[i])&&t.push(i);return t}isEntityHidden(e,t){const i=e.getFeatureIds();for(let e=0;e<i.length;++e)if(this.featureVisibility[i[e]]===Js.EE.HIDDEN)return!0;return!1}getVisibleFeatureIds(){const e=[];for(const t in this.featureVisibility)this.featureVisibility[t]!==Js.EE.HIDDEN&&this.featureToIds.has(t)&&e.push(t);return e}hideShowFeatureEntities(e,t,i){const s=this.getEntitiesForFeature(e);if(s){for(let e=0;e<s.length;++e){const i=this.getOccurrenceIdForEntity(s[e]);this.hideShowEntity(s[e],t,i)}(0,Js.vm)()}}hideShowFeature(e,t,i,s){this.featureVisibility[e]=t,this.hideShowFeatureEntities(e,t,s)}getFeatureVisibility(e){return this.featureVisibility.hasOwnProperty(e)?this.featureVisibility[e]:Js.EE.VISIBLE}hideShowEntity(e,t,i){(i=i||DI.KF)!==DI.Qy&&(t===Js.EE.HIDDEN?this.hideMeshIncrement(e,i):this.showMeshIncrement(e,i))}instantiateForPartStudio(e){}instantiateEntities(){for(const e in this.idToMetaData){const t=this.idToMetaData[e],i=t.getMeshIncrement();!i&&this.expectsTessellation()||this.updateEntityGraphics(e,i,t)}}removePartStudioInstantiation(e){}getNode(){return null}getOccurrenceIdForEntity(e){return null}getOccurrenceBounds(e){const t=new Li.kB,i=this.getNode();return i&&i.getOccurrenceBounds(e,t),t}updateEntityHighlight(e,t,i,s){if(!this.idToMetaData.hasOwnProperty(i))return!1;const n=this.getOccurrenceData(s),r=this.getMeshIncrementDetails(i)||this.getBaseMeshIncrementDetails(i);return!(!n||!r)&&(n.updateEntityHighlight(e,t,r,this.usage),!0)}}class ag extends rg{constructor(e,t,i){super(e,t,i),this.occurrences={}}addOrUpdateOccurrence(e,t){this.occurrences[e]=t}removeOccurrence(e,t){delete this.occurrences[e]}isOccurrenceIdForAssembly(e){return!!this.occurrences[e]}getComponentId(){return ag.ComponentId}}ag.ComponentId="ASSEMBLY_ENABLED_PARTSTUDIO_COMPONENT";q.default.getManager();const og="plane_component.";class hg{constructor(e,t,i,s){this.entityId=e,this.label="",this.center=null,this.xAxis=null,this.yAxis=null,this.update(t,i,s)}update(e,t,i){this.center=e,this.xAxis=t,this.yAxis=i}}class cg extends rg{constructor(e,t,i){super(e,i),this.constructionPlanes={},this.planeNames={},this.planeUi=new Map,this.usage=void 0!==t?t:Ls.L.BASE}clone(e){const t=new cg(e,this.usage,this.viewer);return this.copyToClone(t),t}cloneForPreview(e){const t=new cg(e,Ls.L.PREVIEW,this.viewer);this.copyToPreview(t);for(const e in this.constructionPlanes)t.constructionPlanes[e]=(0,X.Z)(this.constructionPlanes[e]);return this.planeUi.forEach(((e,i)=>(t.planeUi.set(i,e.cloneForPreview()),!1))),t}extractMeshIncrement(e){const t=super.extractMeshIncrement(e);if(t)return t;const i=this.planeUi.get(e);return i?i.getIncrement():null}getVisiblePlaneBounds(){const e=new Li.kB;return this.planeUi.forEach((t=>(t.isHidden||e.addBox(t.getBounds()),!1))),e}reset(){this.removeDefaultPlanesInstantiation(),this.constructionPlanes={},super.reset()}getComponentId(){return og}handlesEntity(e,t){return!e.hasTessellationError()&&e.isFromConstructionPlane()&&e.isFace()&&!this.viewer.getIsForFlattenedDisplay()}processAdditionsAndChanges(e,t){super.processAdditionsAndChanges(e,t),t&&this.instantiateDefaultPlanes()}updateEntityGraphics(e,t,i){t.pickId=this.getEntityIdManager().getOrCreateIdForName(e),this.updatePlaneDefinition(t,i)}getHideableFeatureIds(){return this.featureToIds.getKeys()}removeOldEntityGraphics(e,t){const i=this.idToMetaData[e];i&&i.getFirstFeatureId()!==t.getFirstFeatureId()&&this.removeEntity(e)}removeEntity(e){this.idToMetaData[e]&&(this.removePlaneUiForEntity(e),delete this.constructionPlanes[e]),super.removeEntity(e)}removePlaneUiForEntity(e){const t=this.planeUi.get(e);t&&t.remove(),this.planeUi.delete(e)}getUIElementsForSelection(e){const t=[];let i;return e.isEntity()?(i=this.planeUi.get(e.getDeterministicId()),i&&t.push(i)):e.isFeature()&&this.iterateOverEntitiesForFeature(e.getFeatureId(),(e=>{i=this.planeUi.get(e),i&&t.push(i)})),t}updatePlaneDefinition(e,t){if(!t.isFace())return;const i=e.getBounds().center(),s=v.fromValues(e.points[0],e.points[1],e.points[2]),n=v.fromValues(e.points[3],e.points[4],e.points[5]),r=v.fromValues(e.points[6],e.points[7],e.points[8]),a=pe.S4.add(s,r,v.create());pe.S4.scale(a,.5),pe.S4.subtract(a,i);const o=pe.S4.add(s,n,v.create());pe.S4.scale(o,.5),pe.S4.subtract(o,i);const h=this.constructionPlanes[e.id];h?h.update(i,a,o):this.constructionPlanes[e.id]=new hg(e.id,i,a,o)}iterateOverEntitiesForFeature(e,t){const i=this.getEntitiesForFeature(e);if(i)for(let e=0;e<i.length;++e)t.call(this,i[e])}getFeatureIdForEntity(e){const t=this.idToMetaData[e];return t?t.getFirstFeatureId():""}hideShowFeature(e,t,i){super.hideShowFeature(e,t,i),this.iterateOverEntitiesForFeature(e,(e=>{const i=this.planeUi.get(e);i&&(t===Js.EE.HIDDEN?i.hide():i.show())}))}updateFeatureAppearance(e,t){this.iterateOverEntitiesForFeature(e,(e=>{const i=this.planeUi.get(e);i&&i.updateAppearance(t)}))}overrideinstantiateForPartStudio(e){super.instantiateForPartStudio(e),this.instantiateDefaultPlanes()}removePartStudioInstantiation(e){super.removePartStudioInstantiation(e),this.removeDefaultPlanesInstantiation()}instantiateDefaultPlanes(){const e=[];this.planeUi.forEach(((t,i)=>(this.constructionPlanes.hasOwnProperty(i)||e.push(i),!1)));for(let t=0;t<e.length;++t)this.removePlaneUiForEntity(e[t]);const t=Ys()?"CONSTRUCTION_PLANE_COMPARE_TEXT_COLOR":"CONSTRUCTION_PLANE_TEXT_COLOR";for(const e in this.constructionPlanes){let i=this.planeUi.get(e);const s=this.constructionPlanes[e];i||(i=void 0!==this.usage&&this.usage===Ls.L.PREVIEW?new zC(t,s.entityId,sh.Vv,this.getFeatureIdForEntity(e),this.viewer):new zC(t,s.entityId,sh.lL,this.getFeatureIdForEntity(e),this.viewer),this.planeUi.set(e,i)),i.updateDefinition(s.label,s.center,s.xAxis,s.yAxis,!1);const n=this.idToMetaData[e];if(n instanceof W.kdl){const e=n.getLastFeatureId();this.featureVisibility[e]===Js.EE.HIDDEN?i.hide():i.show()}}}getPartStudioPlaneOccurrenceIds(){const e=[];return this.planeUi.forEach((t=>(e.push(t.graphicsOccurrenceId),!1))),e}getSelectionOccurrenceId(e){const t=this.planeUi.get(e.getDeterministicId());return t?t.graphicsOccurrenceId:DI.Qy}removeDefaultPlanesInstantiation(){this.planeUi.forEach((e=>{e.remove()})),this.planeUi.clear()}setPlaneName(e,t){this.planeNames[e]=t,this.iterateOverEntitiesForFeature(e,(e=>{const i=this.constructionPlanes[e];i&&(i.label=t);const s=this.planeUi.get(e);s&&s.setName(t)}))}}var lg=i(10240);const ug=q.default.getManager();class dg extends Ri{constructor(e,t,i){super(t),this.inferenceData=e,this.hovered=!1,this.selected=!1,this.lastScale=-1,this.lastPickScale=-1;const s=this.inferenceData.isInContextEntity?ge.create():this.getOccurrenceTransform(this.inferenceData.occurrence,i);this.worldSpaceTransform=pe.w$.multiply(s,this.inferenceData.coordinateSystem.getGlMatrix()),this.worldSpacePosition=[this.worldSpaceTransform[12],this.worldSpaceTransform[13],this.worldSpaceTransform[14]],this.inferenceId=Di.JE,(0,Js.vm)()}setInferenceId(e){this.inferenceId=e}getInferenceId(){return this.inferenceId}onDevicePixelRatioChanged(e){this.updateGraphics()}setHovered(e){e!==this.hovered&&(this.hovered=e,this.updateGraphics())}getOccurrenceTransform(e,t){return t?t(e.getPathAsString()):this.viewer.getModelViewManagers().getManager().getOccurrenceTransform(e)}onViewWillDraw(e,t){this.updateTransform(e)}updateTransform(e){const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition);if(Math.abs(this.lastScale-t)<bi.W.ZERO_LENGTH)return;this.lastScale=t;const i=ge.create();i[0]=t,i[5]=t,i[10]=t,this.setTransform(pe.w$.multiply(this.worldSpaceTransform,i,ge.create())),this.hasMeshIncrements()||this.updateGraphics()}isAxialInference(e){return e===lg.i.TOP_AXIS_POINT||e===lg.i.MID_AXIS_POINT||e===lg.i.BOTTOM_AXIS_POINT||e===lg.i.LOOP_CENTER||e===lg.i.CENTER}updateGraphicsNoHover(e){this.isAxialInference(this.inferenceData.inferenceType)?(this.updateMeshIncrement(Tl.TRIANGLES,yi,e[Tl.INFERENCE_CENTER_TRIANGLES].clone(),fl),this.updateMeshIncrement(Tl.LINES,yi,e[Tl.INFERENCE_CENTER_LINES].clone(),gl)):this.inferenceData.inferenceType===lg.i.MID_POINT?(this.updateMeshIncrement(Tl.TRIANGLES,yi,e[Tl.INFERENCE_MID_POINT_TRIANGLES].clone(),fl),this.updateMeshIncrement(Tl.LINES,yi,e[Tl.INFERENCE_MID_POINT_LINES].clone(),gl)):this.inferenceData.inferenceType===lg.i.CENTROID?(this.updateMeshIncrement(Tl.TRIANGLES,yi,e[Tl.INFERENCE_CENTROID_TRIANGLES].clone(),fl),this.updateMeshIncrement(Tl.LINES,yi,e[Tl.INFERENCE_CENTROID_LINES].clone(),gl)):this.isOriginAxisInference()?(this.updateMeshIncrement(Tl.TRIANGLES,Tl.INFERENCE_ORIGIN_AXIS_LINES,e[Tl.INFERENCE_POINT_TRIANGLES].clone(),fl),this.updateMeshIncrement(Tl.LINES,Tl.INFERENCE_ORIGIN_AXIS_LINES,e[Tl.INFERENCE_ORIGIN_AXIS_LINES].clone(),gl),this.removeMeshIncrement(Tl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED)):(this.updateMeshIncrement(Tl.TRIANGLES,yi,e[Tl.INFERENCE_POINT_TRIANGLES].clone(),fl),this.updateMeshIncrement(Tl.LINES,yi,e[Tl.INFERENCE_POINT_LINES].clone(),gl))}isOriginAxisInference(){return this.inferenceData&&(this.inferenceData.inferenceType===lg.i.ORIGIN_X||this.inferenceData.inferenceType===lg.i.ORIGIN_Y||this.inferenceData.inferenceType===lg.i.ORIGIN_Z)}updateGraphics(){const e=vl();this.hovered?(this.updateMeshIncrement(Tl.TRIANGLES,yi,e[Tl.TRIANGLES_PRESELECTED].clone(),fl),this.updateMeshIncrement(Tl.LINES,yi,e[Tl.LINES].clone(),gl),this.isOriginAxisInference()&&this.updateMeshIncrement(Tl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED,Tl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED,e[Tl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED].clone(),gl)):this.updateGraphicsNoHover(e)}updateOccurrenceTransform(e){if(this.inferenceData){this.worldSpaceTransform=pe.w$.multiply(e,this.inferenceData.coordinateSystem.getGlMatrix()),this.worldSpacePosition=[this.worldSpaceTransform[12],this.worldSpaceTransform[13],this.worldSpaceTransform[14]];const t=ge.create();t[0]=this.lastScale,t[5]=this.lastScale,t[10]=this.lastScale,this.setTransform(pe.w$.multiply(this.worldSpaceTransform,t,ge.create())),this.hasMeshIncrements()||this.updateGraphics(),(0,Js.vm)()}}getUpdatedPickIncrement(e,t){let i=null;if(this.isOriginAxisInference()){const s=t.getPixelSizeAtWorldPoint(this.worldSpacePosition);if(Math.abs(s-this.lastPickScale)>bi.W.ZERO_LENGTH){const t=ge.create();t[0]=s,t[5]=s,t[10]=s;const n=5*ug.getNumber("MATE_CONNECTOR_AXIS_LINE_LENGTH_PX"),r=3*ug.getNumber("MATE_CONNECTOR_Z_AXIS_LINE_WIDTH"),a=[0,0,n*s];i=pu([0,0,0],pe.w$.multiplyVec3(this.worldSpaceTransform,a,v.create()),null==e?void 0:e.toString(),void 0,r),i.id=null==e?void 0:e.toString(),this.lastPickScale=s}}else 1!==this.lastPickScale&&(i=Su(this.worldSpacePosition,null==e?void 0:e.toString()),this.lastPickScale=1);return i&&(i.pickId=e),i}}class gg extends dg{constructor(e,t){super(e,t)}updateGraphics(){const e=vl();this.updateGraphicsNoHover(e)}}const pg=new Qi({isShowThrough:!0,isDepthTested:!1,isPickable:!1,primitiveType:_i.MX.LINES}),mg=q.default.getManager();class fg extends Ri{constructor(e){super(e)}updateLines(e){Hu(mg.getNumber("INFERENCE_SNAP_LINE_WIDTH"),e),Uu(mg.getColor("INFERENCE_SNAP_LINE_COLOR"),e),this.updateMeshIncrement("lines",yi,e,pg)}}const Ig=v.fromValues(1,0,0),Eg=v.fromValues(0,1,0),Sg=v.fromValues(0,0,1),Tg=v.fromValues(0,1,0);var Mg;!function(e){e.ACCELERATION_ARROW="ACCELERATION_ARROW",e.ACCELERATION_BEHIND="ACCELERATION_BEHIND",e.BEARING_ARROWS="BEARING_ARROWS",e.FORCE_ARROW="FORCE_ARROW",e.MOMENT_BASE="MOMENT_BASE",e.PRESSURE="PRESSURE",e.PRESSURE_FLIPPED="PRESSURE_FLIPPED",e.ROUND_BASE="ROUND_BASE"}(Mg||(Mg={}));const Cg={};Cg[Mg.ACCELERATION_ARROW]="simulation/acceleration-arrow",Cg[Mg.ACCELERATION_BEHIND]="simulation/acceleration-behind",Cg[Mg.BEARING_ARROWS]="simulation/bearing-arrows",Cg[Mg.FORCE_ARROW]="simulation/force-arrow",Cg[Mg.MOMENT_BASE]="simulation/moment-base",Cg[Mg.PRESSURE]="simulation/pressure",Cg[Mg.PRESSURE_FLIPPED]="simulation/pressure-flipped",Cg[Mg.ROUND_BASE]="simulation/base";const Dg=q.default.getManager().getNumber("SIMULATION_LOAD_LEADER_OFFSET_RATIO"),vg=new Qi({primitiveType:_i.MX.LINES,isShowThrough:!1,isDepthTested:!0,isPickable:!1}),Pg=vg.cloneAndModify({isShowThrough:!0,isDepthTested:!1,isStencilTested:!0}),yg="obliqueBaseLine",Ag=Math.cos((0,Li.Yr)(90-q.default.getManager().getNumber("SIMULATION_LOAD_OBLIQUE_BASE_LINE_ANGLE_THRESHOLD_DEGREES"))),Og=q.default.getManager().getColor("SIMULATION_LOAD_BASE_COLOR"),Rg=q.default.getManager().getColor("SIMULATION_PRE_HIGHLIGHT_COLOR"),wg=q.default.getManager().getColor("SIMULATION_HIGHLIGHT_COLOR"),_g=vg.cloneAndModify({primitiveType:_i.MX.LINES,isShowThrough:!0,isDepthTested:!1,isPickable:!0}),Ng="loadComponent",bg="lineAxis",Lg=q.default.getManager().getStipple("SIMULATION_LINE_AXIS_STIPPLE"),Fg=v.create(),xg=v.create(),Bg=(v.create(),v.create(),q.default.getManager().getNumber("SIMULATION_LOAD_GLYPH_SIZE"));class Ug{constructor(e,t,i){this.leftPoint=e,this.rightPoint=t,this.color=i}equals(e){return!!e&&(v.equals(this.leftPoint,e.leftPoint)&&v.equals(this.rightPoint,e.rightPoint)&&(0,pi.arraysEqual)(this.color,e.color))}}class Vg extends Ri{constructor(e,t,i,s){super(t),this.loadDisplayManager=e,this.loadDisplayData=i,this.hideLoad=s,this.worldAnchorPoint=null,this.worldOrigin_=null,this.worldXAxis=null,this.worldYAxis=null,this.worldZAxis=null,this.adjustedWorldOrigin=v.create(),this.leaderRay=null,this.occupiedScreenBounds=new Li.tO,this.glyphComponents=[],this.targetId_="",this.offsetInLeaderDirection_=0,this.hideLeader=!1,this.isBeingEdited=!1}setHideLoads(e){this.hideLoad!==e&&(this.hideLoad=e,this.updateHideState(),this.updateGraphics(this.loadDisplayData))}setEditState(e){this.isBeingEdited=e,this.updateHideState(),this.updateGraphics(this.loadDisplayData)}updateHideState(){!this.hideLoad||this.isHighlighted()||this.isBeingEdited?(this.show(),this.updateGraphics(this.loadDisplayData)):this.hide()}hide(){super.hide(),this.glyphComponents.forEach((e=>{e.hide()}))}show(){super.show(),this.glyphComponents.forEach((e=>{e.show()}))}remove(){this.clearComponents(),super.remove()}update(e){const t=e||this.loadDisplayData;t&&(this.hideLoad=this.shouldBeHidden(t),this.updateHideState(),this.updateGraphics(t))}shouldBeHidden(e){return!ps.Jq.SimulationService.getCanAccessSimulations()||(!!e.hidden||(!(!this.loadDisplayManager||!this.loadDisplayManager.getExplodeViewActive())||!!this.occurrenceIsHidden(e.occurrence)))}removeMeshIncrements(){super.removeMeshIncrements(),this.lastObliqueBaseLineDisplayed=null,this.lastLineAxisDisplayed=null}updateGraphics(e){if(this.viewer.requestDraw(),this.loadDisplayData=e,this.isHidden)return void this.removeMeshIncrements();switch(this.clearComponents(),this.clearPositionalData(),e.loadType){case W.DzI.ACCELERATION:case W.DzI.BEARING_LOAD:case W.DzI.FORCE:case W.DzI.MOMENT:if(v.squaredLength(this.loadDisplayData.componentValues.getVec3())<bi.W.ZERO_LENGTH_SQUARED)return}if(this.computePositionalData(),!this.isValid)return;const t=e.status===W.EFx.SUPPRESSED?Ul.SUPPRESSED:Ul.NORMAL;switch(e.loadType){case W.DzI.ACCELERATION:this.addBaseGlyph(Mg.ROUND_BASE,t),this.addDirectionGlyph(Mg.ACCELERATION_ARROW,t),this.addDirectionGlyph(Mg.ACCELERATION_BEHIND,t,!0);break;case W.DzI.BEARING_LOAD:this.addBaseGlyph(Mg.ROUND_BASE,t),this.addDirectionGlyph(Mg.BEARING_ARROWS,t);break;case W.DzI.FORCE:this.addBaseGlyph(Mg.ROUND_BASE,t),this.addDirectionGlyph(Mg.FORCE_ARROW,t);break;case W.DzI.MOMENT:this.addBaseGlyph(Mg.MOMENT_BASE,t);break;case W.DzI.PRESSURE:this.addPressureGlyph(t,e.isDirectionFlipped)}const i=this.getHighlight();i&&this.addHighlightToComponents(i),this.updateTargetId()}get scaledGlyphSize(){return Bg*(0,Es.x_)()}updateViewDependentGraphics(e){var t;if(!this.isValid||this.isHidden)return void this.removeMeshIncrements();if(!this.viewer.getResources().loadGlyphResources.atlasReady)return;const i=q.default.getManager(),s=e.getPixelSizeAtWorldPoint(this.worldOrigin_),n=this.scaledGlyphSize;for(let e=0;e<this.glyphComponents.length;++e)this.glyphComponents[e].setWorldOrigin(this.adjustedWorldOrigin);const r=this.getDistanceFromOriginToGlyphEdge(!0)+i.getNumber("SIMULATION_LOAD_LEADER_GAP_PX"),a=this.leaderWorldDistance+this.offsetInLeaderDirection_-s*r;if(this.hideLeader||a<0)this.removeMeshIncrement("leader"),this.removeMeshIncrement("leader-st");else{const e=pu(this.worldAnchorPoint,null===(t=this.leaderRay)||void 0===t?void 0:t.evaluate(a));Uu(i.getColor("SIMULATION_LOAD_LEADER_LINE_COLOR"),e),this.updateMeshIncrement("leader",yi,e,vg);const s=e.clone();Uu(i.getColor("SIMULATION_LOAD_LEADER_HIDDEN_LINE_COLOR"),s),this.updateMeshIncrement("leader-st",yi,s,Pg)}const o=Math.abs(v.dot(e.getDirectionToWorldPoint(this.adjustedWorldOrigin),this.worldZAxis));if(o<Ag&&this.usesBaseGlyph){const t=pe.S4.normalize(pe.S4.cross(e.getForward(),this.worldZAxis,Fg)),i=s*n*.5,r=this.getColorWithHighlight(Og).slice();r[3]=1-o/Ag;const a=new Ug(v.subtract(v.create(),this.adjustedWorldOrigin,v.scale(xg,t,-i)),v.subtract(v.create(),this.adjustedWorldOrigin,v.scale(xg,t,i)),r);if(!a.equals(this.lastObliqueBaseLineDisplayed)){const e=pu(a.leftPoint,a.rightPoint);Uu(r,e),this.updateMeshIncrement(yg,Ng,e,_g),this.lastObliqueBaseLineDisplayed=a}}else this.removeMeshIncrement(yg),this.lastObliqueBaseLineDisplayed=null;if(this.showLineAxis){const e=s*n*.25,t=new Ug(v.subtract(v.create(),this.adjustedWorldOrigin,v.scale(xg,this.worldZAxis,-e)),v.subtract(v.create(),this.adjustedWorldOrigin,v.scale(xg,this.worldZAxis,e)),this.getColorWithHighlight(q.default.getManager().getColor("SIMULATION_LINE_AXIS_COLOR")));if(!t.equals(this.lastLineAxisDisplayed)){const e=pu(t.leftPoint,t.rightPoint);Uu(t.color,e),ku(Lg,e),this.updateMeshIncrement(bg,Ng,e,_g),this.lastLineAxisDisplayed=t}}else this.removeMeshIncrement(bg),this.lastLineAxisDisplayed=null}getModelSelection(e){const t=new ve.Y1(W.lQt.OCCURRENCE,this.loadDisplayData.occurrence);return new ve.Y1(W.lQt.SIMULATION_LOAD,this.loadDisplayData.nodeId,this.loadDisplayData.ownerOccurrence,{childSelections:[t]})}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.addHighlightToComponents(e)}addHighlightToComponents(e){for(let t=0;t<this.glyphComponents.length;t++)this.glyphComponents[t].addHighlight(e)}removeHighlight(e){const t=super.removeHighlight(e);for(let t=0;t<this.glyphComponents.length;t++)this.glyphComponents[t].removeHighlight(e);return this.updateHideState(),t}get leaderDirection(){var e;return null===(e=this.leaderRay)||void 0===e?void 0:e.direction}set offsetInLeaderDirection(e){var t;this.offsetInLeaderDirection_=e;const i=this.leaderWorldDistance+this.offsetInLeaderDirection_;null===(t=this.leaderRay)||void 0===t||t.evaluate(i,this.adjustedWorldOrigin)}get offsetInLeaderDirection(){return this.offsetInLeaderDirection_}get worldOrigin(){return this.worldOrigin_}get targetId(){return this.targetId_}updateTargetId(){const e=this.loadDisplayData.faceLoadDeterministicIds.slice();e.sort(),this.targetId_=this.loadDisplayData.occurrence.toString()+"-"+e}getDistanceFromOriginToGlyphEdge(e){var t,i;const s=this.scaledGlyphSize,n=e?-1:1,r=Math.max(0,this.getDirectionGlyphLength()*n*v.dot(this.worldZAxis,null===(t=this.leaderRay)||void 0===t?void 0:t.direction)),a=v.dot(this.worldZAxis,null===(i=this.leaderRay)||void 0===i?void 0:i.direction);return(this.usesBaseGlyph?Math.sqrt(1-a*a)*s*.5:.5*s)+r}getOccupiedScreenBounds(e,t){if(this.isHidden)return this.occupiedScreenBounds.reset(),this.occupiedScreenBounds;const i=this.scaledGlyphSize;if(this.usesBaseGlyph){this.occupiedScreenBounds.reset();for(let s=-.5;s<=.5;s+=1){for(let n=-.5;n<=.5;n+=1){let n=pe.S4.add(this.adjustedWorldOrigin,pe.S4.scale(this.worldXAxis,s*t*i,xg),Fg);n=pe.S4.add(n,pe.S4.scale(this.worldYAxis,s*t*i,xg),Fg),this.occupiedScreenBounds.addPoint(e.projectWorldPointToCanvas(n))}const n=pe.S4.add(this.adjustedWorldOrigin,pe.S4.scale(this.worldZAxis,t*this.getDirectionGlyphLength(),xg),Fg);this.occupiedScreenBounds.addPoint(e.projectWorldPointToCanvas(n))}}else this.occupiedScreenBounds.makeCenteredBoxOnPoint(e.projectWorldPointToCanvas(this.adjustedWorldOrigin),i*t);return this.occupiedScreenBounds}clearComponents(){for(let e=0;e<this.glyphComponents.length;++e)this.glyphComponents[e].remove();this.glyphComponents=[],this.removeMeshIncrements()}get assembly(){return this.viewer.getModelViewManagers().getManager().getDisplayedAssembly()}clearPositionalData(){this.worldAnchorPoint=null,this.worldOrigin_=null,this.worldXAxis=null,this.worldYAxis=null,this.worldZAxis=null,this.leaderRay=null}get isValid(){return!!(this.worldAnchorPoint&&this.worldOrigin_&&this.worldXAxis&&this.worldYAxis&&this.worldZAxis)}updateWorldZAxisWithPartStudioMateConnector(){const e=W._oC.getOccurrenceFromPathString(this.loadDisplayData.directionMateConnectorId),t=e.getOccurrenceWithoutTail().getPathAsString(),i=this.assembly.getOccurrences()[t];if(i){const t=i.fullElementId.toString(),s=this.assembly.elementAccessor.getPartStudio(t);if(s){const t=i.occurrenceData,n=t.transform.getGlMatrix(),r=s.getMateConnectorData(t.occurrence,e.getTailNodeId());if(r){const e=r.location.getGlMatrix();this.updateWorldZAxisInternal(n,e)}else It.log.warn("Unable to find mate connector display data")}else It.log.warn("Unable to find part studio element")}else It.log.warn("Unable to find part studio display data")}updateWorldZAxisInternal(e,t){if(e&&t){const i=pe.w$.multiply(e,t,ge.create());this.worldZAxis=pe.S4.normalize(pe.w$.multiplyVec4(i,(0,Li.Ot)(this.loadDisplayData.componentValues.getVec3(),0)))}else It.log.warn("Unable to identify load direction.")}updateWorldZAxis(){if(this.worldZAxis=v.clone(Eg),this.loadDisplayData){if(this.loadDisplayData.directionMateConnectorId){const e=this.assembly.mateConnectorData[this.loadDisplayData.directionMateConnectorId];if(e){const t=e.location.getGlMatrix(),i=this.assembly.getOccurrences()[e.occurrence.getPathAsString()].occurrenceData.transform.getGlMatrix();this.updateWorldZAxisInternal(i,t)}else this.updateWorldZAxisWithPartStudioMateConnector()}this.loadDisplayData.isDirectionFlipped&&(this.worldZAxis=pe.S4.negate(this.worldZAxis))}}computePositionalData(){const e=v.clone(Ig),t=this.getBounds();if(!t||!t.isFinite())return;const i=t.center(),s=this.viewer.getModelBounds();if(v.dot(e,pe.S4.subtract(i,s.center(),v.create()))<-bi.W.ZERO_LENGTH&&pe.S4.negate(e),this.updateAnchorPoint(pe.S4.add(i,pe.S4.scale(e,t.diameter()/2,v.create()),v.create())),!this.worldAnchorPoint)return;let n=0;const r=s.getCorners();if(!r)return;const a=v.dot(this.worldAnchorPoint,e);for(let t=0;t<r.length;++t){const i=v.dot(r[t],e)-a;i>n&&(n=i)}this.worldOrigin_=pe.S4.add(this.worldAnchorPoint,pe.S4.scale(e,n+Dg*s.diameter(),v.create()),v.create()),this.updateWorldZAxis(),(0,Sr.areUnitVectorsParallel)(Sg,this.worldZAxis)?this.worldXAxis=pe.S4.normalize(pe.S4.cross(Tg,this.worldZAxis,v.create())):this.worldXAxis=pe.S4.normalize(pe.S4.cross(Sg,this.worldZAxis,v.create())),this.worldYAxis=pe.S4.normalize(pe.S4.cross(this.worldZAxis,this.worldXAxis,v.create()));const o=pe.S4.subtract(this.worldOrigin_,this.worldAnchorPoint,v.create());this.leaderWorldDistance=pe.S4.length(o),this.leaderRay=new Li.zH(this.worldAnchorPoint,o)}updateAnchorPoint(e){this.worldAnchorPoint=null;const t=this.viewer.getModelViewManagers().getManager();let i;const s=this.loadDisplayData.occurrence;if(this.loadDisplayData.faceLoadDeterministicIds.length>0)i=this.loadDisplayData.faceLoadDeterministicIds;else{const e=t.getOccurrenceDisplayData(s);if(!e)return void It.log.debug("Failed to find occurrence display data for load");const n=t.getPartStudioDataFromOccurrence(s);if(!n)return void It.log.debug("Failed to find part studio display data for load");i=[];for(const t of e.displayedPartIds)i=i.concat(n.getEntitiesForBody(t))}if(!i||0===i.length)return void It.log.debug("No deterministic ids to use for load anchor point");const n=t.getOccurrenceTransform(s);if(!n)return void It.log.debug("Failed to find occurrence transform for load");const r=pe.w$.multiplyVec3(pe.w$.inverse(n,ge.create()),e,v.create());let a=null;for(let e=0;e<i.length;++e){const n=t.extractMeshIncrement(i[e],s);if(n){const e=n.getPositionNearPoint(r);e.position&&(!a||e.distance<a.distance)&&(a=e)}}a?this.worldAnchorPoint=pe.w$.multiplyVec3(n,a.position):It.log.debug("Failed to find anchor point for load display")}getBounds(){if(this.loadDisplayData.faceLoadDeterministicIds.length>0){const e=new Li.kB;for(let t=0;t<this.loadDisplayData.faceLoadDeterministicIds.length;++t)e.addBox(this.viewer.getModelViewManagers().getManager().getEntityBounds(this.loadDisplayData.faceLoadDeterministicIds[t],this.loadDisplayData.occurrence));return e}return this.assembly.getOccurrenceBounds(this.loadDisplayData.occurrence)}addBaseGlyph(e,t){const i=new Xl(this.viewer,this.viewer.getResources().loadGlyphResources,e,t,Bg,Yi.DEFAULT,this.worldOrigin_,this.worldXAxis,this.worldYAxis,this);this.glyphComponents.push(i)}addDirectionGlyph(e,t,i){const s=i?pe.S4.scale(this.worldZAxis,-1,v.create()):this.worldZAxis,n=new Zl(this.viewer,this.viewer.getResources().loadGlyphResources,e,t,Bg,Yi.DEFAULT,this.worldOrigin_,s,[.5,0],this);this.glyphComponents.push(n)}addPressureGlyph(e,t){const i=t?Mg.PRESSURE_FLIPPED:Mg.PRESSURE,s=new ql(this.viewer,this.viewer.getResources().loadGlyphResources,i,e,Bg,Yi.DEFAULT,this.worldOrigin_,[.5,.5],this);this.glyphComponents.push(s)}get usesBaseGlyph(){return this.loadDisplayData.loadType!==W.DzI.PRESSURE}get showLineAxis(){return this.loadDisplayData.loadType===W.DzI.MOMENT}getColorWithHighlight(e){const t=this.getHighlight();return t?t.type===yn.o2.PRE?Rg:wg:e}getDirectionGlyphLength(){switch(this.loadDisplayData.loadType){case W.DzI.ACCELERATION:case W.DzI.BEARING_LOAD:case W.DzI.FORCE:return this.scaledGlyphSize;case W.DzI.MOMENT:return.25*this.scaledGlyphSize}return 0}occurrenceIsHidden(e){const t=this.assembly.getDisplayDataForOccurrence(e);return!!t&&t.isHidden}}const Gg=v.create();class Hg{constructor(){this.loadDisplays=[],this.occupiedScreenBounds=new Li.tO}addDisplay(e){this.loadDisplays.push(e)}arrangeAndUpdateForView(e,t){if(0===this.loadDisplays.length||!this.loadDisplays[0].isValid)return;const i=this.loadDisplays[0].worldOrigin,s=this.loadDisplays[0].leaderDirection,n=this.loadDisplays[0].scaledGlyphSize,r=e.getPixelSizeAtWorldPoint(i),a=q.default.getManager().getNumber("SIMULATION_INTER_LOAD_GAP_PX");let o=0,h=!1;for(let e=0;e<this.loadDisplays.length;++e){const t=this.loadDisplays[e];t.isHidden||(0!==e&&(o+=r*t.getDistanceFromOriginToGlyphEdge(!0)),t.hideLeader=h,h=!0,t.offsetInLeaderDirection=o,o+=r*Math.max(t.getDistanceFromOriginToGlyphEdge(!1),a))}this.occupiedScreenBounds.reset();for(let t=0;t<this.loadDisplays.length;++t)this.occupiedScreenBounds.addBox(this.loadDisplays[t].getOccupiedScreenBounds(e,r));const c=e.projectWorldDirectionToCanvas(i,pe.S4.scale(s,r*n,Gg));pe.gv.normalize(c);let l=t.getUnoccupiedOffsetAlongDirection(this.occupiedScreenBounds,c);if(l>0){l+=a;const e=l*r;for(let t=0;t<this.loadDisplays.length;++t){const i=this.loadDisplays[t];i.offsetInLeaderDirection=i.offsetInLeaderDirection+e}this.occupiedScreenBounds.translate(pe.gv.scale(c,l))}t.addOccupiedRegion(this.occupiedScreenBounds);for(let t=0;t<this.loadDisplays.length;++t)this.loadDisplays[t].updateViewDependentGraphics(e)}}class kg extends Ri{constructor(e){super(e),this.loadDisplayData=new Map,this.loadDisplays=new Map,this.groupedLoadDisplays=new Map,this.loadDisplayOccupancyMap=new Vi,this.explodeViewActive=!1,this.mateConnectorIdToLoads=new Map,this.loadResources(),ps.Jq.SimulationService.getCanAccessSimulationsObservable().subscribe((e=>{for(const t of this.loadDisplays.values())t.setHideLoads(!e),this.show()}))}setEditState(e,t){const i=this.loadDisplays.get(e);i&&i.setEditState(t)}reset(){this.clearLoadDisplays(),this.loadDisplayData.clear(),this.mateConnectorIdToLoads.clear()}hide(){this.isHidden=!0,this.clearLoadDisplays()}show(){this.isHidden=!1,this.updateLoadDisplays(this.loadDisplayData.values(),!0)}onAppearanceConstantsUpdated(){this.isHidden||(this.clearLoadDisplays(),this.updateLoadDisplays(this.loadDisplayData.values(),!0))}setExplodeViewActive(e){if(this.explodeViewActive!==e)if(this.explodeViewActive=e,e)this.clearLoadDisplays();else{const e=!0;this.updateLoadDisplays(this.loadDisplayData.values(),e)}}getExplodeViewActive(){return this.explodeViewActive}static getMateConnectorPath(e){return e.ownerOccurrence.createOccurrenceWithTailAppended(e.nodeId).getPathAsString()}processUpdates(e,t){if(!this.assembly)return;if(e.isCollapsible)return void this.hide();t&&this.isHidden&&!this.explodeViewActive&&this.show();for(const t of e.deletedLoads){const e=this.loadDisplays.get(t);e&&(e.remove(),this.loadDisplays.delete(t));const i=this.loadDisplayData.get(t);if(i){const e=i.directionMateConnectorId;if(e){const i=this.mateConnectorIdToLoads.get(e);i&&(i.delete(t),0===i.size&&this.mateConnectorIdToLoads.delete(e))}}this.loadDisplayData.delete(t)}const i=new Set(e.mateConnectors.map((e=>kg.getMateConnectorPath(e))));for(const t of e.occurrences){const e=this.assembly.getMateConnectorsForOccurrence(t.occurrenceData.occurrence);for(let t=0;t<e.length;t++)i.add(kg.getMateConnectorPath(e[t]))}this.updateLoadDisplays(e.loads.values(),t,Array.from(i))}processDeletedMateConnector(e){this.mateConnectorIdToLoads.delete(e)}getUiElementsForSelection(e){if(!e.isSimulationLoad())return[];const t=this.loadDisplays.get(e.getIdString());return t?[t]:[]}getDisplayDataForSelection(e){return e.isSimulationLoad()?this.loadDisplayData.get(e.getIdString()):null}onViewWillDraw(e){this.loadDisplayOccupancyMap.clearOccupiedRegions();for(const[t,i]of this.groupedLoadDisplays)i.arrangeAndUpdateForView(e,this.loadDisplayOccupancyMap)}updateDirectionMateConnectorToLoad(e){const t=e.nodeId,i=e.directionMateConnectorId,s=this.loadDisplayData.get(t);if(s){const e=s.directionMateConnectorId;if(e&&e!==i){const i=this.mateConnectorIdToLoads.get(e);i&&i.delete(t)}}if(i){const e=this.mateConnectorIdToLoads.get(i);e?e.add(t):this.mateConnectorIdToLoads.set(i,new Set([t]))}}updateLoadDisplays(e,t,i){for(const i of e){const e=i.nodeId;if(this.updateDirectionMateConnectorToLoad(i),this.loadDisplayData.set(e,i),t){let t=this.loadDisplays.get(e);if(!t){const s=i.hidden||!ps.Jq.SimulationService.getCanAccessSimulations();t=new Vg(this,this.viewer,i,s),this.loadDisplays.set(e,t)}t.update(i)}}if(i)for(let e=0;e<i.length;e++)this.processMateConnectorChange(i[e]);this.setupAssemblyListeners(),this.groupedLoadDisplays.clear();for(const[e,t]of this.loadDisplays){if(!t.isValid)continue;let e=this.groupedLoadDisplays.get(t.targetId);e||(e=new Hg,this.groupedLoadDisplays.set(t.targetId,e)),e.addDisplay(t)}}processMateConnectorChange(e){const t=this.mateConnectorIdToLoads.get(e);t&&t.forEach((e=>{const t=this.loadDisplays.get(e);t&&t.update()}))}setupAssemblyListeners(){this.stopListening(this.assembly);const e=new Set;for(const t of this.loadDisplays.keys()){const i=this.loadDisplayData.get(t).occurrence.getPathAsString();e.add(i)}for(const t of e)this.listenTo(this.assembly,"OCCURRENCE_DATA_CHANGE."+t,this.show)}clearLoadDisplays(){for(const[e,t]of this.loadDisplays)t.remove();this.loadDisplays.clear(),this.groupedLoadDisplays.clear(),this.stopListening()}loadResources(){if(!this.viewer.getResources().loadGlyphResources){const e="LOAD_GLYPHS",t=48,i=[1,2],s=!0;this.viewer.getResources().loadGlyphResources=new Wg(e,this.viewer,Cg,t,i,{clearColorOverride:[255,255,255,0],useMipMappingAndAnisotropicFiltering:!0},s)}}get assembly(){return this.viewer.getModelViewManagers().getManager().getDisplayedAssembly()}}class Wg extends kl{getAtlasBackgroundColor(e,t){return"rgba(0, 0, 0, 0.0)"}getAtlasTextureName(e,t,i){let s="";return i!==Gl.NO_HIGHLIGHT?s="_"+i:t===Ul.SUPPRESSED&&(s+=Vl[t]),this.textures[e]+s+this.getSystemStateSuffix()+".png"}initializeNodeProperties(){for(const e in Gl)for(const t in Ul){const i=this.getNodePropertyKey(e,t,Yi.DEFAULT);this.nodeProperties[i]=new Qi({primitiveType:_i.MX.TRIANGLES,isShowThrough:!1,isDepthTested:!1,isTwoSided:!0,priority:Yi.DEFAULT,primitivesHaveTransparency:!0,material:this.material})}}}class zg extends ag{constructor(e,t,i){super(e,i),this.usage=t,this.mateConnectorGraphics={}}clone(e){const t=new zg(e,this.usage,this.viewer);return this.copyToClone(t),t}cloneForPreview(e){const t=new zg(e,Ls.L.PREVIEW,this.viewer);this.copyToPreview(t);for(const e in this.mateConnectorGraphics){const i=this.mateConnectorGraphics[e],s=t.mateConnectorGraphics[e]={};for(const e in i)s[e]=i[e].cloneForPreview()}return t}getVisibleMateConnectorBounds(){const e=new Li.kB;for(const t in this.mateConnectorGraphics){const i=this.mateConnectorGraphics[t];for(const t in i)i[t].isHidden||e.addPoint(i[t].worldSpacePosition)}return e}getInstantiatedMateConnectorsForOccurrence(e){const t=[];for(const i in this.mateConnectorGraphics){const s=this.mateConnectorGraphics[i];for(const i in s){const n=s[i],r=n.getDefinition();r&&(0,vn.wB)(e,n.getOccurrence())&&t.push({Id:r.nodeId,isPartStudio:n.getIsPartStudioMateConnector()})}}return t}getComponentId(){return"mateconnector_component."}handlesEntity(e,t){return!e.hasTessellationError()&&e.isMateConnector()&&!this.viewer.getIsForFlattenedDisplay()}expectsTessellation(){return!1}reset(){for(const e in this.mateConnectorGraphics){const t=this.mateConnectorGraphics[e];for(const e in t)t[e].remove()}this.mateConnectorGraphics={},rg.prototype.reset.apply(this,arguments)}isInstantiated(){return!0}instantiateForPartStudio(e){this.addOrUpdateOccurrence(DI.KF,null),rg.prototype.instantiateForPartStudio.apply(this,arguments)}removePartStudioInstantiation(e){rg.prototype.removePartStudioInstantiation.apply(this,arguments),this.removeOccurrence(DI.KF,!1)}addOrUpdateOccurrence(e,t){let i=!1;for(const s in this.idToMetaData)i=this.updateEntityMateConnector(s,this.idToMetaData[s],e,t)||i;const s=e===DI.KF;(i||s||this.occurrences.hasOwnProperty(e))&&super.addOrUpdateOccurrence(e,t)}addManagedIdMappings(e,t){var i;super.addManagedIdMappings(e,t);const s=null===(i=this.bodyToEntity.get(t))||void 0===i?void 0:i.getKeys();if(s)for(const t of s){const i=Object.values(this.mateConnectorGraphics[t]);for(const t of i)t.partStudioFeatureId=e,t.isFromChildFeature=!0}}getConnectorHiddenState(e,t){const i=e.getFirstFeatureId();let s=!1;if(t){const e=t.occurrenceData.featureData[i];e?s=e.visibility===W.HRI.HIDDEN:t.isPatternDescendant&&(s=!0)}else s=e.getFeatureIds().reduce(((e,t)=>e||this.featureVisibility[t]===Js.EE.HIDDEN),s);return s}occurrenceContainsBody(e,t){return this.viewer.getModelViewManagers().getManagerForUsage(this.usage).occurrenceContainsBody(e,t)}createMateConnectorDisplayData(e,t){if(t&&!this.occurrenceContainsBody(t,e.getMateConnectorPartId()))return null;const i=new W.Zcz;return i.location=e.getMateConnectorCoordinateSystem(),i.partId=e.getMateConnectorPartId(),i.nodeId=e.getFirstFeatureId(),i.occurrence=t?t.occurrenceData.occurrence:null,i.ownerOccurrence=i.occurrence,i.implicit=!1,i.hidden=this.getConnectorHiddenState(e,t),i}updateEntityMateConnector(e,t,i,s,n){if(s&&!this.occurrenceContainsBody(s,t.getMateConnectorPartId()))return!1;const r=t.getLastFeatureId(),a=this.getConnectorHiddenState(t,s);let o=this.mateConnectorGraphics[e],h=o?o[i]:null;if(!n&&s&&a&&!h){return!0}o||(o={},this.mateConnectorGraphics[e]=o);const c=this.createMateConnectorDisplayData(t,s);return!!c&&(h?h.updateDefinition(c):(h=new Dl(c,ah(this.usage),this.viewer,r),o[i]=h),s&&(h.setOccurrenceTransform(s.occurrenceData.transform.getGlMatrix()),h.updateOccurrenceVisibility(s.isHidden?Js.EE.HIDDEN:Js.EE.VISIBLE)),!0)}removeOccurrence(e,t){super.removeOccurrence(e,t);for(const t in this.mateConnectorGraphics){const i=this.mateConnectorGraphics[t];if(!i)continue;const s=i[e];s&&(s.remove(),delete i[e])}}updateEntityGraphics(e,t,i){let s;for(s in this.occurrences){const t=this.occurrences[s];s=+s,this.updateEntityMateConnector(e,i,s,t)}}static getFirstNonCompoundFeatureId(e){const t=e.getFeatureIds();if(null===t)return It.log.warn("Unable to retrieve feature ids for entity: "+e.getMessageName()),null;for(let e=0;e<t.length;++e)if(!WI(t[e]))return t[e]}getHideableFeatureIds(){const e=[];return this.featureToIds.each(((t,i)=>{if(this.childFeatureIds.has(i))return void e.push(i);if(WI(i))return;const s=t.getKeys();for(let t=0;t<s.length;++t){const n=s[t],r=this.idToMetaData[n];if(r){const t=zg.getFirstNonCompoundFeatureId(r);if(t&&t===i)return void e.push(i)}}})),e}removeEntity(e){const t=this.mateConnectorGraphics[e];for(const e in t)t[e].remove();delete this.mateConnectorGraphics[e],rg.prototype.removeEntity.apply(this,arguments)}hideShowEntity(e,t,i){if((i=i||DI.KF)===DI.Qy)return;const s=this.mateConnectorGraphics[e];for(const e in s)if(+e===i){const e=s[i];e&&(t===Js.EE.HIDDEN?e.definition.hidden=!0:e.definition.hidden=!1,e.updateHideState())}}hideShowFeatureEntities(e,t,i){const s=this.getEntitiesForFeature(e);if(!s)return;let n=i;for(let i=0;i<s.length;++i){const r=this.idToMetaData[s[i]];if(!n){const t=zg.getFirstNonCompoundFeatureId(r);n=!!t&&t===e}if(r&&n){const e=this.getOccurrenceIdForEntity(s[i]);this.hideShowEntity(s[i],t,e)}}this.viewer.requestDraw()}getAllMateConnectorGraphics(e,t){const i=this.featureToIds.get(t),s=[];return i&&i.each((function(t,i){const n=this.getMateConnectorGraphicsFromEntityId(e,i);return n&&s.push(n),!1}),this),s}getMateConnectorGraphics(e,t){const i=this.featureToIds.get(t);let s;return i&&(s=i.firstKey()),s?this.getMateConnectorGraphicsFromEntityId(e,s):null}getMateConnectorData(e,t){const i=this.featureToIds.get(t);let s;if(i&&(s=i.firstKey()),s){const t=this.idToMetaData[s],i=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString()),n=this.occurrences[i];if(t&&n)return this.createMateConnectorDisplayData(t,n)}return null}getMateConnectorGraphicsFromEntityId(e,t){if(t){let i=this.mateConnectorGraphics[t];if(e){const s=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString()),n=i?i[s]:null;if(n)return n;const r=this.idToMetaData[t],a=this.occurrences[s];if(r&&a){const e=!0;return this.updateEntityMateConnector(t,r,s,a,e),i=this.mateConnectorGraphics[t],i?i[s]:null}}else for(const e in i){const t=i[e];if(!t.getOccurrence())return t}}return null}getUIElementsForSelection(e){const t=[];if(e.isMateConnector()||e.isFeature()){this.getAllMateConnectorGraphics(e.getOccurrence(),e.getIdString()).forEach((function(e){t.push(e)}))}return t}getEntityIdsForSelection(e){return[]}getOccurrencesForSelection(e){const t=[];if(e.isMateConnector()||e.isFeature()){const i=this.getMateConnectorGraphics(e.getOccurrence(),e.getIdString());i&&t.push(i.getOccurrence())}return t}}class Xg extends Ri{constructor(e,t,i){super(i),this.definition=e,this.mateConnectorDisplayData=t,this.mateIndicatorComponents=[],this.occurrenceData.setCanIsolateChange(!0),this.occurrenceData.setIsolated(!1)}onDevicePixelRatioChanged(e){this.updateGraphics()}getDefinition(){return this.definition?this.definition:null}remove(){for(let e=0;e<this.mateIndicatorComponents.length;e++)this.mateIndicatorComponents[e].remove();super.remove()}addHighlight(e){super.addHighlight(e);for(let t=0;t<this.mateIndicatorComponents.length;t++)this.mateIndicatorComponents[t].addHighlight(e)}removeHighlight(e){const t=super.removeHighlight(e);for(let t=0;t<this.mateIndicatorComponents.length;t++)this.mateIndicatorComponents[t].removeHighlight(e);return t}onIsolateChanged(){this.updateGraphics()}isInteractionEnabled(){return!(this.viewer.getIsolatedOccurrenceManager().hasIsolatedInstances()&&!this.occurrenceData.getIsolated())}updateGraphics(){for(let e=0;e<this.mateIndicatorComponents.length;e++)this.mateIndicatorComponents[e].updateGraphics()}setIsolated(e){this.occurrenceData.setIsolated(e);for(let t=0;t<this.mateIndicatorComponents.length;t++)this.mateIndicatorComponents[t].getOccurrenceData().setIsolated(e)}getDefinitionMateConnectorIds(){return this.definition.getMateConnectorIds()}getDefinitionOccurrenceIds(){return this.mateIndicatorComponents.length>0?this.mateIndicatorComponents[0].getDefinitionOccurrenceIds():this.definition.getOccurrenceIds()}getModelSelection(e){return null}addMateIndicatorComponent(e){e.isValid()&&(e.updateHideState(),this.mateIndicatorComponents.push(e),this.listenTo(e,Pi.LONG_PRESS_START,this.onLongPressStart),this.listenTo(e,Pi.LONG_PRESS_END,this.onLongPressEnd))}onLongPressStart(){const e=[];this.getDefinitionOccurrenceIds().forEach((function(t){e.push(W._oC.getOccurrenceFromPathString(t))})),this.viewer.getIsolatedOccurrenceManager().isolateOccurrences(e,xM.INITIAL),(0,ve.IQ)()}onLongPressEnd(){(0,fr.m)().trigger(mr.C.EXIT_ISOLATE,this.viewer)}updateMateConnectorDisplayData(e){this.mateConnectorDisplayData=e;for(let e=0;e<this.mateIndicatorComponents.length;++e)this.mateIndicatorComponents[e].updateMateConnectorDisplayData(this.mateConnectorDisplayData)}updateHiddenMode(e){for(let t=0;t<this.mateIndicatorComponents.length;t++)this.mateIndicatorComponents[t].updateHiddenMode(e)&&this.mateIndicatorComponents[t].updateHideState()}}class qg extends Xg{constructor(e,t,i){super(t,e,i);const s=new eu(this.mateConnectorDisplayData,"FASTENED",t,this.viewer,W.qep.FASTENED);this.addMateIndicatorComponent(s)}}class Zg extends Xg{constructor(e,t,i){super(t,e,i);const s=new eu(this.mateConnectorDisplayData,"REVOLUTE",t,this.viewer,W.qep.REVOLUTE);this.addMateIndicatorComponent(s)}}class Yg extends Xg{constructor(e,t,i){super(t,e,i);const s=new eu(this.mateConnectorDisplayData,"PLANAR_BASE",t,this.viewer,W.qep.PLANAR);this.addMateIndicatorComponent(s)}}class Kg extends Xg{constructor(e,t,i){super(t,e,i);const s=new eu(this.mateConnectorDisplayData,"PARALLEL_BASE",t,this.viewer,W.qep.PARALLEL);this.addMateIndicatorComponent(s)}}class jg extends Xg{constructor(e,t,i){super(t,e,i);const s=new eu(this.mateConnectorDisplayData,"SLIDER_BASE",t,this.viewer,W.qep.SLIDER),n=new tu(this.mateConnectorDisplayData,t,-Math.PI/2,[0,1,0],this.viewer,W.qep.SLIDER);this.addMateIndicatorComponent(s),this.addMateIndicatorComponent(n)}}class Qg extends Xg{constructor(e,t,i){super(t,e,i);const s=new eu(this.mateConnectorDisplayData,"CYLINDRICAL_BASE",t,this.viewer,W.qep.CYLINDRICAL),n=new tu(this.mateConnectorDisplayData,t,-Math.PI/2,[0,1,0],this.viewer,W.qep.CYLINDRICAL);this.addMateIndicatorComponent(s),this.addMateIndicatorComponent(n)}}class $g extends Xg{constructor(e,t,i){super(t,e,i);const s=new eu(this.mateConnectorDisplayData,"PIN_SLOT_BASE",t,this.viewer,W.qep.PIN_SLOT);this.addMateIndicatorComponent(s)}}class Jg extends Xg{constructor(e,t,i){super(t,e,i);const s=new eu(this.mateConnectorDisplayData,"BALL",t,this.viewer,W.qep.BALL);this.addMateIndicatorComponent(s)}}class ep extends Xg{constructor(e,t,i){super(t,[],i);const s=new iu(e,t,this.viewer);this.addMateIndicatorComponent(s)}updateOccurenceDisplayData(e){for(let t=0;t<this.mateIndicatorComponents.length;++t)this.mateIndicatorComponents[t].updateOccurenceDisplayData(e)}}class tp extends Xg{constructor(e,t){super(e,null,t);const i=new su(e,"TANGENT",this.viewer);this.addMateIndicatorComponent(i)}updateMateIndicatorDefinition(e){this.definition=e;for(let e=0;e<this.mateIndicatorComponents.length;++e)this.mateIndicatorComponents[e].updateDefinition(this.definition)}}class ip extends Xg{constructor(e,t,i){super(null,null,i);const s=new nu(e,t,this.viewer);this.addMateIndicatorComponent(s)}}function sp(e,t,i){let s=null;switch(t.mateType){case W.qep.FASTENED:s=new qg(e,t,i);break;case W.qep.REVOLUTE:s=new Zg(e,t,i);break;case W.qep.SLIDER:s=new jg(e,t,i);break;case W.qep.PLANAR:s=new Yg(e,t,i);break;case W.qep.PARALLEL:s=new Kg(e,t,i);break;case W.qep.CYLINDRICAL:s=new Qg(e,t,i);break;case W.qep.PIN_SLOT:s=new $g(e,t,i);break;case W.qep.BALL:s=new Jg(e,t,i);break;default:s=null}return s}const np=q.default.getManager(),rp=new Qi({zOffset:np.getNumber("ORIGIN_Z_OFFSET"),primitiveType:_i.MX.POINTS,isPickable:!1}),ap=new Qi({primitiveType:_i.MX.POINTS,isShowThrough:!0,isDepthTested:!1,priority:Yi.LOWER}),op=new Ni;class hp extends rg{constructor(e,t,i){super(e,t,i),this.hasBeenInstantiated=!1,this.incrementRanges={},this.styledRanges={},this.node=new ts(this.getComponentId(),new Qi,i),this.instantiateRanges()}reset(){super.reset(),this.node.removeOccurrence(DI.KF),Object.values(this.styledRanges).forEach((e=>{e.getMeshRanges().destroy()})),this.incrementRanges={},this.styledRanges={},this.instantiateRanges()}getStyleId(e,t){return op.reset(),op.addBoolean(e),op.addBoolean(t),op.getId()}instantiateRanges(){for(let e=0;e<=1;++e)for(let t=0;t<=1;++t){const i=this.getStyleId(!!e,!!t),s="PointBodyComponent."+i;let n=this.incrementRanges[s];n||(n=new BS("PointBodyComponent."+i),this.usage===Ls.L.PREVIEW&&n.setListenForDeletions(!0),this.incrementRanges[s]=n);const r=t?"ORIGIN":"POINT_BODY",a=new fE;a.setAttribute(Jd.PRIMITIVE_SIZE,np.getNumber(r+"_SIZE")),a.setAttribute(Jd.PRIMITIVE_STYLE,np.getPointFont(r+"_FONT")),a.setAttribute(Jd.COLOR,np.getColor(r+"_COLOR"));const o=e?ap:rp,h=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(DI.KF),c=this.node.addOccurrenceGeometryToNode(o,h,a,n);this.styledRanges[i]=c}}getComponentId(){return"point_body_component."}clone(e){const t=new hp(e,this.viewer,this.usage);return this.copyToClone(t),t}cloneForPreview(e){const t=new hp(e,this.viewer,Ls.L.PREVIEW);return this.copyToPreview(t),t.instantiateBaseEntities(),t}instantiateBaseEntities(){const e=this.getSharedBaseMeshManager();for(const t in this.idToMetaData){const i=this.idToMetaData[t],s=e.getIncrementDetails(t,this.getMeshOwnerId());i&&s&&this.updateEntityGraphicsFromIncrementDetails(s,t,i)}this.hasBeenInstantiated=!0}isInstantiated(){return this.hasBeenInstantiated}instantiateForPartStudio(e){this.node.getParent()!==e&&e.addChild(this.node),this.hasBeenInstantiated||(this.instantiateEntities(),this.hasBeenInstantiated=!0)}removePartStudioInstantiation(e){e.removeChild(this.node,!0)}onAppearanceConstantsUpdated(){const e=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(DI.KF);this.node.removeOccurrenceFromNode(rp,e.getOccurrenceId()),this.instantiateRanges()}handlesEntity(e,t){return!e.hasTessellationError()&&e.isPointEntity()&&!this.viewer.getIsForFlattenedDisplay()}getRanges(e,t){const i=this.getStyleId(t,e.isFromOrigin()),s=this.styledRanges[i];return s?s.getMeshRanges():null}updateEntityGraphics(e,t,i){if(!t)return;const s=this.addMeshIncrement(t);this.updateEntityGraphicsFromIncrementDetails(s,e,i)}updateEntityGraphicsFromIncrementDetails(e,t,i){if(!e)return;const s=this.getRanges(i,!1);s&&s.onIncrementAdded(e);const n=this.getRanges(i,!0);n&&n.onIncrementAdded(e),this.isEntityHidden(i,DI.KF)&&this.hideMeshIncrement(t,DI.KF)}removeMeshIncrement(e){const t=this.getMeshManager().removeMeshIncrement(e,this.getMeshOwnerId());if(!t)return null;const i=this.idToMetaData[e];if(!i)return null;const s=this.getRanges(i,!1);s&&s.onIncrementRemoved(t);const n=this.getRanges(i,!0);return n&&n.onIncrementRemoved(t),t}getHideableFeatureIds(){return this.featureToIds.getKeys()}}var cp,lp,up=i(51890);!function(e){e[e.ALL_OPAQUE=0]="ALL_OPAQUE",e[e.OPAQUE_BODY_TRANSPARENT_FACE=1]="OPAQUE_BODY_TRANSPARENT_FACE",e[e.TRANSPARENT_BODY_OPAQUE_FACE=2]="TRANSPARENT_BODY_OPAQUE_FACE",e[e.ALL_TRANSPARENT=3]="ALL_TRANSPARENT"}(cp||(cp={})),function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT"}(lp||(lp={}));const dp=q.default.getManager(),gp="body_component.",pp=new ki({}),mp=new ki({color:dp.getColor("MESH_FACET_EDGE_COLOR"),lineWidth:dp.getNumber("MESH_FACET_EDGE_LINE_WIDTH")}),fp=new ki({shininess:dp.getNumber("MESH_SHININESS"),specularColor:dp.getColor("MESH_SPECULAR"),ambientFactor:dp.getNumber("MESH_AMBIENT_FACTOR"),diffuseFactor:dp.getNumber("MESH_DIFFUSE_FACTOR")}),Ip=new Qi({material:pp,zOffset:dp.getNumber("PART_FACES_Z_OFFSET"),primitiveType:_i.MX.TRIANGLE_STRIP,includedInBlend:!0,clippedBySectionPlanes:!0});let Ep=dp.getStipple("DEFAULT_LINE_STIPPLE"),Sp=dp.getNumber("DEFAULT_LINE_WIDTH");function Tp(e){e===W.YUG.PHANTOM?(Ep=dp.getStipple("SMOOTH_EDGE_STIPPLE"),Sp=dp.getNumber("SMOOTH_EDGE_LINE_WIDTH")):(Ep=dp.getStipple("DEFAULT_LINE_STIPPLE"),Sp=dp.getNumber("DEFAULT_LINE_WIDTH"))}const Mp=new Qi({material:pp,zOffset:dp.getNumber("PART_FACES_Z_OFFSET"),primitiveType:_i.MX.TRIANGLE_STRIP,includedInBlend:!0,clippedBySectionPlanes:!0,isVisible:!1}),Cp=Mp.cloneAndModify({zOffset:q.default.getManager().getNumber("SURFACE_Z_OFFSET"),isTwoSided:!0}),Dp=Ip.cloneAndModify({isTwoSided:!0}),vp=new Qi({material:pp,zOffset:dp.getNumber("NON_MODIFIABLE_Z_OFFSET"),primitiveType:_i.MX.TRIANGLE_STRIP,includedInBlend:!0,clippedBySectionPlanes:!0,addsToSectionMask:!1,primitivesHaveTransparency:!0,isTwoSided:!0}),Pp=new Qi({material:pp,zOffset:dp.getNumber("NON_MODIFIABLE_Z_OFFSET"),primitiveType:_i.MX.TRIANGLE_STRIP,isTwoSided:!0,includedInBlend:!0,clippedBySectionPlanes:!0,primitivesHaveTransparency:!0}),yp=new Qi({material:fp,zOffset:dp.getNumber("PART_FACES_Z_OFFSET"),primitiveType:_i.MX.TRIANGLE_STRIP,includedInBlend:!0,clippedBySectionPlanes:!0}),Ap=(yp.cloneAndModify({primitivesHaveTransparency:!0}),yp.cloneAndModify({isTwoSided:!0}).cloneAndModify({primitivesHaveTransparency:!0}),new Qi({material:mp,zOffset:dp.getNumber("PART_EDGES_Z_OFFSET"),primitiveType:_i.MX.LINES,addsToBounds:!1,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1})),Op=new Qi({material:pp,zOffset:dp.getNumber("PART_FACES_Z_OFFSET"),primitiveType:_i.MX.TRIANGLE_STRIP,primitivesHaveTransparency:!0,includedInBlend:!0,clippedBySectionPlanes:!0,isTwoSided:!0}),Rp=new Qi({material:pp,zOffset:dp.getNumber("SURFACE_Z_OFFSET"),primitiveType:_i.MX.TRIANGLE_STRIP,isTwoSided:!0,includedInBlend:!0,clippedBySectionPlanes:!0}),wp=new Qi({material:pp,zOffset:dp.getNumber("SURFACE_Z_OFFSET"),primitiveType:_i.MX.TRIANGLE_STRIP,isTwoSided:!0,includedInBlend:!0,clippedBySectionPlanes:!0,primitivesHaveTransparency:!0}),_p=new Qi({zOffset:dp.getNumber("PART_POINTS_Z_OFFSET"),primitiveType:_i.MX.POINTS,isVisible:!1,addsToBounds:!1,includedInBlend:!0,clippedBySectionPlanes:!0}),Np=_p.cloneAndModify({zOffset:dp.getNumber("SURFACE_POINTS_Z_OFFSET")}),bp=_p.cloneAndModify({zOffset:dp.getNumber("WIRE_POINTS_Z_OFFSET")});function Lp(e){return e.getZOffset()===Rp.zOffset||e.getZOffset()===Pp.zOffset}const Fp={};function xp(e,t){let i=Fp[e];if(!i){i=new fE;const s=[t.color[0]/255,t.color[1]/255,t.color[2]/255,t.opacity/255];i.setAttribute(Jd.COLOR,s),Fp[e]=i}return i}function Bp(e){if(e){const t=e.getAttribute(Jd.COLOR);if(t)return t[3]<1}return!1}const Up=new Di.si;let Vp=!1,Gp=!1;class Hp extends ag{constructor(e,t,i,s){super(e,s,i),this.bodyLoadTasks=t,this.bodyMetaData={},this.lastSetBodyColor={},this.subBodyStyleOverrides=new Ol.TemplatedNestedMap,this.entityStyles={},this.cachedBodyTransparencyState={},this.partStudioBodyIdToOccurrenceId={},this.cullableBodies=null,this.instantiatedTriangleCount=-1,this.sheetMetalOrderIdToTransform={},this.previewClone=null,this.baseComponent=null,this.bodiesHiddenInBase=new Set,this.tessellationSettings={},this.partTriangleCounts={},this.bodiesWithUpdatedMeshReferences=new Set,this.scalarVisualizationOccurrences=new Set,this.generativePartInstanceOccurrences=new Set,this.lastUsedSmoothEdgeColor=null,this.node=e.getModelViewManager().getSharedBodyNode(),this.collectionId=Up.getId(),this.knownBodyIds=new Set,this.occurrenceAlphaModifiers=new Map,this.bodyVisibility=new Ol.TemplatedNestedMap,this.bodyToOccurrenceId=new Ol.TemplatedNestedMap,this.unavailableBodyOccurrences=new Ol.TemplatedNestedMap,this.silhouetteCallback=(e,t)=>{this.onSilhouetteCreated(e,t)},this.decalComponent=new kd(this,e)}getCollectionId(){return this.collectionId}getNode(){return this.node}getDecalComponent(){return this.decalComponent}getBodyIds(e=(()=>!0)){const t=[];for(const i of Object.keys(this.bodyMetaData))e(this.bodyMetaData[i])&&t.push(i);return t}getEntityIds(e){const t=[];for(const i in this.idToMetaData)e(this.idToMetaData[i])&&t.push(i);return t}getCorrectedBodyOccurrenceId(e,t){return t&&t!==DI.KF||(t=this.partStudioBodyIdToOccurrenceId[e]),t}getBodyToOccurrenceId(){return this.bodyToOccurrenceId}copyBodyDataToClone(e){let t;for(t in e.bodyLoadTasks=this.bodyLoadTasks,this.bodyMetaData)e.bodyMetaData[t]=this.bodyMetaData[t].clone();for(t in e.knownBodyIds=new Set(this.knownBodyIds),this.lastSetBodyColor)e.lastSetBodyColor[t]=this.lastSetBodyColor[t].slice(0);this.subBodyStyleOverrides.eachNested(((t,i,s)=>{e.subBodyStyleOverrides.insertNested(i,s,t.clone())})),e.tessellationSettings=(0,X.Z)(this.tessellationSettings),e.partTriangleCounts=(0,X.Z)(this.partTriangleCounts),e.entityStyles=(0,X.Z)(this.entityStyles)}clone(e){this.bodyLoadTasks.completeTasks();const t=new Hp(e,this.bodyLoadTasks,this.usage,this.viewer);return this.copyBodyDataToClone(t),this.copyToClone(t),this.decalComponent.copyToClone(t.decalComponent),t}cloneForPreview(e){const t=new Hp(e,this.bodyLoadTasks,Ls.L.PREVIEW,this.viewer);this.copyToPreview(t),this.copyBodyDataToClone(t),Object.entries(this.occurrences).forEach((([e,i])=>{!i&&(t.occurrences[e]=i)})),this.bodyToOccurrenceId.eachNested(((e,i,s)=>{t.occurrences.hasOwnProperty(s)&&t.bodyToOccurrenceId.insertNested(i,s,e)})),this.unavailableBodyOccurrences.eachNested(((e,i,s)=>{t.occurrences.hasOwnProperty(s)&&t.unavailableBodyOccurrences.insertNested(i,s,e)}));for(const e in this.bodyMetaData)t.refreshBodyOccurrences(e);return this.previewClone=t,t.baseComponent=this,t.decalComponent=this.decalComponent.cloneForPreview(t,e),t}onPreviewDestroyed(){this.previewClone=null}onAppearanceConstantsUpdated(){this.refreshSmoothEdgesIfColorChanged()}onRenderingModeChanged(){this.refreshSmoothEdgesIfColorChanged()}copyVisibility(e){e.bodyVisibility.eachNested(((e,t,i)=>(this.hideShowBody(i,e,+t),!1)))}getBodyLoadTasks(){return this.bodyLoadTasks}getTessellationSettings(){return this.tessellationSettings}getPartTriangleCounts(){return this.partTriangleCounts}damageInstantiatedTriangleCount(){this.instantiatedTriangleCount=-1}getInstantiatedTriangleCount(){if(this.instantiatedTriangleCount<0){this.instantiatedTriangleCount=0;const e=this.getMeshManager(),t=this.getMeshOwnerId();this.bodyToOccurrenceId.each(((i,s)=>{if(i&&!i.isEmpty()){const n=e.getGroupRangesForGroupTypeAndLod(s,t,_i.MX.TRIANGLE_STRIP,eg.DEFAULT);n&&(this.instantiatedTriangleCount+=i.size()*n.getPrimitiveCount())}return!1}),this)}return this.instantiatedTriangleCount}hasDisplayedEdgesWithOutdatedSmoothnessInfo(){let e=!1;return this.bodyToOccurrenceId.each(((t,i)=>{const s=this.bodyToEntity.get(i);return s&&s.each(((t,i)=>{const s=this.idToMetaData[i];return s&&s.isEdge()&&(s.getEdgeSmoothnessStatus()===W.dA1.UNKNOWN||s.getEdgeSmoothnessStatus()===W.dA1.SMOOTH)&&(e=!0),e})),e})),e}getEstimatedMemoryUsage(){let e=0;for(const t in this.bodyMetaData){this.bodyMetaData[t].isClosedCompositeConstituent||(e+=this.bodyMetaData[t].getEstimatedMemoryUsage())}return e}retrieveBodyMetaData(e){return this.bodyMetaData[e]||null}getBodyDiameter(e){const t=this.bodyMetaData[e];return t?t.getBounds().diameter():0}isBodyIsolated(e,t){const i=this.getOccurrenceDataForBody(e,t);return!!i&&i.getIsolated()}isBodyVisible(e,t){const i=this.getOccurrenceDataForBody(e,t);return!!i&&i.getVisibility()!==Js.EE.HIDDEN}getOccurrenceDataForBody(e,t){let i=this.bodyMetaData[t];if(i&&i.isClosedComposite&&!i.isGroupableCompositeBody){let e=null;for(let t=0;t<i.constituentBodyIds.length&&!e;++t)e=this.bodyMetaData[i.constituentBodyIds[t]];i=e}return this.getBodyOccurrenceData(i.meshGroupId,e)}isBodyInstantiated(e){const t=this.bodyMetaData[e];if(!t)return!1;if(!t.isNonGroupingCompositeBody)return this.bodyToOccurrenceId.has(t.meshGroupId);for(let e=0;e<t.constituentBodyIds.length;++e)if(this.bodyToOccurrenceId.has(t.constituentBodyIds[e]))return!0}getNonInstantiatedBodies(){const e=[];for(const t in this.bodyMetaData){this.bodyMetaData[t].isClosedCompositeConstituent||(this.isBodyInstantiated(t)||e.push(this.bodyMetaData[t]))}return e}getComponentId(){return gp}reset(){this.bodyToOccurrenceId.eachNested(((e,t,i)=>(this.removeBodyOccurrence(i,t),!1)),this),this.unavailableBodyOccurrences.clear(),this.bodyLoadTasks.clearAllBodiesForComponent(this),this.bodyMetaData={},this.tessellationSettings={},this.knownBodyIds.clear(),this.lastSetBodyColor={},this.partStudioBodyIdToOccurrenceId={},this.sheetMetalOrderIdToTransform={},this.entityStyles={},this.subBodyStyleOverrides.clear(),this.decalComponent.destroy(),this.decalComponent=new kd(this,this.parent),this.damageInstantiatedTriangleCount(),super.reset()}updateBodyDisplayData(e,t){var i;const s=new St.StringSet;for(const t in e.deterministicPartIdToData){const s=e.deterministicPartIdToData[t];if(s.isDeletion)null===(i=this.parent.bodyIdsThatAreInsertableBuffers)||void 0===i||i.delete(t),delete this.tessellationSettings[t],delete this.partTriangleCounts[t];else{this.tessellationSettings[t]=s.tessellationSettings;const e=new W.xTE;e.coarsePlanarFaceTriangleCount=s.coarsePlanarFaceTriangleCount,e.coarseTriangleCount=s.coarseTriangleCount,e.totalEntityCount=s.totalEntityCount,this.partTriangleCounts[t]=e}}this.knownBodyIds=new Set;for(let i=0;i<e.partDisplayData.length;++i){const n=e.partDisplayData[i].id;this.knownBodyIds.add(n);const r=e.deterministicPartIdToData[n];if(r){if(this.viewer.getIsForFlattenedDisplay()!==r.isForFlattenedView()){if(this.viewer.getIsForFlattenedDisplay())continue;n in this.partStudioBodyIdToOccurrenceId&&this.removeBodyOccurrence(DI.KF,n)}}else if(!this.bodyMetaData.hasOwnProperty(n))continue;if(s.add(n),!t||e.deterministicPartIdToData.hasOwnProperty(n)){let s=-1;t&&qc()&&this.bodyMetaData[n]&&null!==this.bodyMetaData[n].getFinestTessellationSettingOnClient()&&(s=this.bodyMetaData[n].getFinestTessellationSettingOnClient());const r=e.deterministicPartIdToData[n],a=e.partDisplayData[i];if(a||It.log.warn("Missing expected BTPartDisplayData"),this.updateBodyMetaData(e,n,a,r),t&&qc()){const e=this.bodyMetaData[n],t=(e.getEstimatedMemoryUsage()-e.getEstimatedMemoryUsage([s]))/1024/1024;t>dp.getNumber("SINGLE_BODY_MEMORY_CHANGE_INFO_THRESHOLD_MB")&&It.log.info("Memory change for "+n+" to go to "+e.getFinestTessellationSettingOnClient()+": "+t+"MB")}}const a=this.bodyMetaData[n];if(a.isClosedComposite)for(let e=0;e<a.constituentBodyIds.length;++e)this.knownBodyIds.add(a.constituentBodyIds[e]),s.add(a.constituentBodyIds[e])}let n=null;for(const e in this.bodyMetaData)s.contains(e)||(this.removeBodyOccurrence(DI.KF,e),this.bodyMetaData[e].removeOpenCompositeBodyReferences(this.bodyMetaData),delete this.bodyMetaData[e],delete this.lastSetBodyColor[e],this.subBodyStyleOverrides.remove(e),n||(n=new St.StringSet),n.add(e));n&&this.bodyLoadTasks.clearBodiesForComponent(this,n)}processDeletions(e){let t,i;for(const s in e.deterministicPartIdToData){const n=e.deterministicPartIdToData[s];for(let s=0;s<n.entityDIds.length;++s)i=n.entityDIds[s],t=e.deterministicIdToEntity[i],t&&!this.handlesEntity(t,n)&&this.removeEntity(i)}for(i in e.deterministicIdToEntity)t=e.deterministicIdToEntity[i],t.isDeletion()&&(delete this.entityStyles[i],this.removeEntity(i))}updatePSOI(e){for(const t in e.detIdToPSOIIncrement)this.bodyMetaData[t]&&(this.bodyMetaData[t].partIdentity=e.detIdToPSOIIncrement[t])}unloadBody(e){const t=this.bodyMetaData[e];if(!t)return;t.setIsTessellationLoaded(!1),t.tessellationSettings=[];const i=this.bodyToEntity.get(e);if(i&&i.each(((e,t)=>(this.removeEntity(t),!1)),this),this.tessellationSettings[e]=[W.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING],this.damageInstantiatedTriangleCount(),t.isClosedComposite)for(let e=0;e<t.constituentBodyIds.length;++e)this.unloadBody(t.constituentBodyIds[e])}removeBaseIncrement(e){if(this.baseComponent){const t=this.baseComponent.idToMetaData[e];if(t){const i=this.baseComponent.getEntityBodyGroupId(t),s=this.baseComponent.bodyToOccurrenceId.get(i);s&&s.each(((t,i)=>(this.removeBaseIncrementFromOccurrence(e,i),!1)),this)}}}onBaseSilhouetteAdded(e,t,i){const s=this.bodyToOccurrenceId.get(i);s&&s.each(((i,s)=>(this.wasIncrementRemovedFromBase(e,s)&&this.hideBaseIncrement(t,s),!1)),this)}processAdditionsAndChanges(e,t,i){let s;for(s in this.updateBodyDisplayData(e,i),this.updateEntityAppearanceOverrides(e),this.processPrecompiledGraphicsBuffers(e.partIdAndTessellationSettingToBuffers),e.deterministicPartIdToData){const t=e.deterministicPartIdToData[s],i=this.bodyMetaData[s];if(!i)continue;const n=i.getIsTessellationLoaded(),r=i.canEntitiesBeLoaded();if(this.viewer.areOptimizedBuffersEnabled){if(!e.partIdAndTessellationSettingToBuffers[s])continue;this.refreshBodyOccurrences(s)}else for(let a=0;a<t.entityDIds.length;++a){const o=t.entityDIds[a],h=e.deterministicIdToEntity[o];if(!h||this.handlesEntity(h,t))if(h){const e=BI(h,o,this.getEntityIdManager().getOrCreateIdForName(o));if(!e)continue;e.groupId=i.meshGroupId,h.setBodyMetaData(i),h.setMeshIncrement(e),this.removeOldEntityGraphics(o,h),this.addIdMappings(o,h,s),n&&this.updateEntityGraphics(o,e,h),this.viewer.getIsForFlattenedDisplay()===t.isForFlattenedView()&&h.removeGeometry()}else r&&this.changeEntityOwner(o,s)}n||i.isClosedCompositeConstituent||!i.canEntitiesBeLoaded()||this.bodyLoadTasks.postBodyToLoad(this,s)}this.updateBodiesWithChangedMeshReferences(),this.decalComponent.update(e),this.deterministicIdToAssociatedFeatureIds=e.deterministicIdToAssociatedFeatureIds,this.featureIdToAssociatedDeterministicIds={};for(const[e,t]of Object.entries(this.deterministicIdToAssociatedFeatureIds))for(const i of t){let t=this.featureIdToAssociatedDeterministicIds[i];t||(t=[],this.featureIdToAssociatedDeterministicIds[i]=t),t.push(e)}t&&this.addPartStudioOccurrences()}getBodyType(e){const t=this.bodyMetaData[e];if(t)return t.type;const i=this.parent.getEntitiesForBody(e);for(let e=0;i&&e<i.length;e++){const t=this.parent.retrieveEntityMetaData(i[e]);if(t&&t instanceof W.sWe)return W.wG2.POINT}return null}accumulateSketchIdsFromBodyId(e,t){this.parent.sketchComponent.accumulateSketchIdsFromBodyId(e,t)}updateCompositeConstituentCounts(e){for(let t=0;t<e.partDisplayData.length;t++){const i=e.partDisplayData[t].id,s=this.bodyMetaData[i];s&&s.isComposite&&s.updateConstituentTypeCounts(this)}}handlesEntity(e,t){const i=t&&this.viewer.getIsForFlattenedDisplay()&&!t.isForFlattenedView();return!e.hasTessellationError()&&e.isFromBody()&&!i}updateEntityAppearanceOverrides(e){for(const t in e.appearanceIdToAppearanceOverride){const i=e.appearanceIdToAppearanceOverride[t],s=t===W.QHW.RESET_APPEARANCE_ID?null:xp(t,i.appearance);for(let e=0;e<i.entityDeterministicIds.length;++e){const t=i.entityDeterministicIds[e];if(s?this.entityStyles[t]=s:delete this.entityStyles[t],this.containsEntity(t)){const e=this.getMeshIncrementDetails(t)||this.getBaseMeshIncrementDetails(t);e&&(this.removeEntityAppearanceOverride(e),s&&this.incorporateEntityAppearanceOverride(e))}}}}getNodePropertiesForFace(e,t,i){const s=i===lp.TRANSPARENT;return e.containsOnlySheetBodies()?e.isModifiableBody()?s?wp:Rp:Pp:e.isModifiableBody()?s?Op:t!==cp.ALL_OPAQUE?Dp:Ip:vp}getNodePropertiesForEdge(e){return e.getIsBendCenterLineBody()?this.viewer.getResources().CENTER_LINE_NODE_PRPOPERTIES:e.containsOnlyWireBodies()?e.isModifiableBody()?this.viewer.getResources().WIRE_EDGE_NODE_PROPERTIES:this.viewer.getResources().WIRE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE:e.containsOnlySheetBodies()?e.isModifiableBody()?this.viewer.getResources().SURFACE_EDGE_NODE_PROPERTIES:this.viewer.getResources().SURFACE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE:e.isModifiableBody()?this.viewer.getResources().PART_EDGE_NODE_PROPERTIES:this.viewer.getResources().PART_EDGE_NODE_PROPERTIES_NON_MODIFIABLE}getNodePropertiesForPoint(e){return e.containsOnlyWireBodies()?bp:e.containsOnlySheetBodies()?Np:_p}getGroupBoundsForEntity(e){const t=this.getEntityBodyGroupId(e),i=this.bodyMetaData[t];if(!i){const i=e.getEntityType();return It.log.info(`Could not find bodyMetaData for entityType ${i} and entityBodyGroupId ${t} while fetching group bounds for entity`),null}return i.getBounds()}addMeshIncrementAndSilhouettes(e,t){const i=this.getGroupBoundsForEntity(t),s=super.addMeshIncrement(e,i);this.incorporateEntityAppearanceOverride(s),this.addMeshTriangleEdges(e,t);e.primitiveType===_i.MX.TRIANGLE_STRIP&&!t.isPlanar()&&this.viewer.getSilhouetteTask().postSilhouetteRequest(e,this.usage,this.silhouetteCallback),this.damageInstantiatedTriangleCount()}addMeshTriangleEdges(e,t){if(t.isFace()&&(Vp||t.getSurfaceType()===W.C1H.MESH)){const i=cu(e,Hp.getMeshEdgeId(e.id));if(i){i.groupId=Hp.getMeshEdgeId(this.getEntityBodyGroupId(t));const e=this.getGroupBoundsForEntity(t);this.getMeshManager().addMeshIncrement(i,this.getMeshOwnerId(),e)}}}onSilhouetteCreated(e,t){const i=e.id,s=this.idToMetaData[i];s&&s.getIncrementGloballyUniqueId()===e.getGloballyUniqueId()&&t&&(t.groupId=e.groupId,this.getMeshManager().addMeshIncrement(t,this.getMeshOwnerId()),this.previewClone&&this.previewClone.onBaseSilhouetteAdded(i,t.id,e.groupId),this.viewer.requestDraw())}static getMeshEdgeId(e){return-1!==e.indexOf(Hp.MESH_EDGE_GROUP_SUFFIX,e.length-Hp.MESH_EDGE_GROUP_SUFFIX.length)?e:e+Hp.MESH_EDGE_GROUP_SUFFIX}static getPotentialMeshGroupIdsForBody(e){return[e,e+Hp.MESH_EDGE_GROUP_SUFFIX]}callBaseVisibilityMethodForIncrementAndDerivations(e,t,i){const s=e.call(this,t,i);e.call(this,pI(t),i);const n=Hp.getMeshEdgeId(t);return n!==t&&e.call(this,n,i),s}showMeshIncrement(e,t){this.callBaseVisibilityMethodForIncrementAndDerivations(rg.prototype.showMeshIncrement,e,t)}hideMeshIncrement(e,t){this.callBaseVisibilityMethodForIncrementAndDerivations(rg.prototype.hideMeshIncrement,e,t)}hideBaseIncrement(e,t){return this.callBaseVisibilityMethodForIncrementAndDerivations(rg.prototype.hideBaseIncrement,e,t)}showBaseIncrement(e,t){this.callBaseVisibilityMethodForIncrementAndDerivations(rg.prototype.showBaseIncrement,e,t)}refreshEntityGraphics(e,t){let i=this.idToMetaData[e];i&&(this.removeMeshIncrement(e),this.removeBaseIncrement(e),i=i.cloneForNewBody(t),this.idToMetaData[e]=i,this.updateEntityGraphics(e,i.getMeshIncrement(),i))}removeMeshIncrement(e){const t=rg.prototype.removeMeshIncrement.apply(this,arguments);super.removeMeshIncrement(pI(e)),t&&(this.viewer.getSilhouetteTask().removePendingRequest(t.increment,this.usage),this.removeEntityAppearanceOverride(t));const i=Hp.getMeshEdgeId(e);return i!==e&&rg.prototype.removeMeshIncrement.call(this,i),this.damageInstantiatedTriangleCount(),t}incorporateEntityAppearanceOverride(e){var t,i;let s=!1;const n=null===(t=null==e?void 0:e.increment)||void 0===t?void 0:t.groupId,r=this.entityStyles[null===(i=e.increment)||void 0===i?void 0:i.id];if(r){const t=Bp(r)?lp.TRANSPARENT:lp.OPAQUE;let i=this.subBodyStyleOverrides.getNested(n,t);i||(i=new BS(n+" "+(t===lp.OPAQUE?"opaque":"transparent")+" entity style overrides",n),this.subBodyStyleOverrides.insertNested(n,t,i),s=!0),i.onIncrementAdded(e,r)}s&&this.bodiesWithUpdatedMeshReferences.add(n)}removeEntityAppearanceOverride(e){var t;let i=!1;const s=null===(t=e.increment)||void 0===t?void 0:t.groupId,n=this.subBodyStyleOverrides.get(s);n&&n.each(((t,n)=>{t.onIncrementRemoved(e)&&t.isEmpty()&&(t.destroy(),this.subBodyStyleOverrides.removeNested(s,n),i=!0)})),i&&this.bodiesWithUpdatedMeshReferences.add(s)}damageComputedBodyTransparency(e){delete this.cachedBodyTransparencyState[e]}getComputeBodyTransparency(e){if(this.cachedBodyTransparencyState.hasOwnProperty(e))return this.cachedBodyTransparencyState[e];const t=this.getBodyColor(e)[3]<1,i=this.bodyMetaData[e];let s=[e];i&&i.isClosedComposite&&(s=i.constituentBodyIds);let n=0,r=0;for(let e=0;e<s.length;++e){const t=this.bodyToEntity.get(s[e]);t&&t.each(((e,t)=>{const i=this.entityStyles[t];return i&&(Bp(i)?++n:++r),n>0&&r>0}))}let a=cp.ALL_OPAQUE;return t&&r>0?a=cp.TRANSPARENT_BODY_OPAQUE_FACE:!t&&n>0?a=cp.OPAQUE_BODY_TRANSPARENT_FACE:t&&(a=cp.ALL_TRANSPARENT),this.cachedBodyTransparencyState[e]=a,a}getHideableFeatureIds(){return[]}hideShowFeature(e,t,i){this.featureVisibility[e]=t;const s=this.getEntitiesForFeature(e);if(!s)return;const n=new St.StringSet;for(let e=0;e<s.length;++e){const t=this.idToMetaData[s[e]];let r=t?t.getBodyMetaData():void 0;(null==r?void 0:r.isClosedCompositeConstituent)&&(r=r.consumingClosedCompositeData),r&&!r.isModifiableBody()&&i&&n.add(r.id)}n.each((e=>{this.hideShowBody(e,t,DI.KF)}),this)}updateEdgeSmoothness(e){let t=0;for(const i in this.idToMetaData){const s=this.idToMetaData[i];if(s.isEdge()&&(s.isFromSolidBody()||s.isFromSheetBody())){e.hasOwnProperty(i)||++t;const n=s.getGeometry();e[i]&&!s.isFromWireBody()?n.edgeSmoothnessStatus=W.dA1.SMOOTH_V2:n.edgeSmoothnessStatus=W.dA1.NOT_SMOOTH}}t>0&&It.log.warn("Did not find edge smoothness data for "+t+" edges")}updateEntityGraphics(e,t,i){t.pickId=this.getEntityIdManager().getOrCreateIdForName(e);const s=i.getEdgeSmoothnessStatus();s!==W.dA1.SMOOTH&&s!==W.dA1.SMOOTH_V2||(ku(Ep,t),Uu(this.viewer.getResources().SMOOTH_EDGE_COLOR,t),this.lastUsedSmoothEdgeColor=this.viewer.getResources().SMOOTH_EDGE_COLOR,Hu(Sp,t)),!this.parent.getIsMissingTangencyInformationMessageShown()&&this.viewer.getSmoothEdgesRenderStyle()!==W.YUG.VISIBLE&&i.isEdge()&&i.getEdgeSmoothnessStatus()===W.dA1.UNKNOWN&&(this.parent===this.parent.getModelViewManager().getDisplayedPartStudio()?this.parent.getModelViewManager().updateSmoothEdgesForDisplayedPartStudio():(this.viewer.showTangencyInformationMissingMessage(),this.parent.setIsMissingTangencyInformationMessageShown(!0),setTimeout((()=>{this.viewer.setSmoothEdgesRenderStyle(W.YUG.VISIBLE)}),0))),t.groupId=this.getEntityBodyGroupId(i),this.addMeshIncrementAndSilhouettes(t,i)}instantiateForPartStudio(e){rg.prototype.instantiateForPartStudio.apply(this,arguments),this.addPartStudioOccurrences()}removePartStudioInstantiation(e){this.usage===Ls.L.PREVIEW&&rg.prototype.removePartStudioInstantiation.apply(this,arguments),this.removeOccurrence(DI.KF,!1)}isBodyLoaded(e){const t=this.bodyMetaData[e];return!!t&&t.getIsTessellationLoaded()}processBodyAddition(e,t){const i=this.bodyMetaData[e];if(i&&i.isClosedComposite){for(let e=0;e<i.constituentBodyIds.length;++e)this.isBodyLoaded(i.constituentBodyIds[e])||this.processBodyAddition(i.constituentBodyIds[e],t);return i.setIsTessellationLoaded(!0),this.decalComponent.onBodyLoaded(),!0}if(this.isBodyLoaded(e)&&It.log.warn("The same body occurrence was loaded twice"),!this.viewer.areOptimizedBuffersEnabled){const i=this.bodyToEntity.get(e);if(!i)return!0;i.each(((e,i)=>{const s=this.idToMetaData[i];if(!s||!s.getMeshIncrement())return!1;t&&t.addVertexCost(s.getMeshIncrement().vertexCount()),this.updateEntityGraphics(i,s.getMeshIncrement(),s)}),this)}if(i&&i.setIsTessellationLoaded(!0),this.damageInstantiatedTriangleCount(),this.getBodyManager().damageUnloadedBodyBounds(),this.partStudioBodyIdToOccurrenceId.hasOwnProperty(e)){const t=this.viewer.getOccurrenceDataManager().getOccurrenceData(this.partStudioBodyIdToOccurrenceId[e]);t&&t.clearAllOccurrenceLevelHighlights()}return this.updateBodiesWithChangedMeshReferences(),this.decalComponent.onBodyLoaded(),!0}addBodyOccurrence(e,t,i,s){if(this.bodyToOccurrenceId.hasNested(t,e)&&!i)return;const n=this.bodyMetaData[t];if(!n)return void(s||this.unavailableBodyOccurrences.insertNested(t,e,!0));this.bodyToOccurrenceId.insertNested(t,e,!0);const r=this.getBodyOccurrenceData(t,e);if(!r)return void It.log.warn("Tried to add occurrence without occurrence data");const a=this.getBodyColor(t,e),o=new fE;n.containsOnlyWireBodies()&&o.setAttribute(Jd.COLOR,a),this.addBodyOccurrenceFromMeshManager(this.getMeshManager(),e,r,t,n,a,o),this.getSharedBaseMeshManager()&&!this.bodiesHiddenInBase.has(t)&&this.addBodyOccurrenceFromMeshManager(this.getSharedBaseMeshManager(),e,r,t,n,a,o),this.scalarVisualizationOccurrences.has(r.getOccurrenceId())||this.decalComponent.addOrUpdateOccurrence(t,e),i||this.damageInstantiatedTriangleCount()}addBodyOccurrenceFromMeshManager(e,t,i,s,n,r,a){if(n.hasFaces()){const o=new fE;o.setAttribute(Jd.COLOR,r);const h=n.getChordalTolerance();null!==h?o.setFloatUniform("uChordalTolerance",h):o.setFloatUniform("uChordalTolerance",bi.W.MAX_MODEL_SIZE);const c=this.hasOccurrenceAlphaModifier(t)?cp.ALL_TRANSPARENT:this.getComputeBodyTransparency(s);switch(c){case cp.ALL_OPAQUE:this.addFaceRangesToOccurrenceNode(e,n,i,o,c,lp.OPAQUE);break;case cp.ALL_TRANSPARENT:this.addFaceRangesToOccurrenceNode(e,n,i,o,c,lp.TRANSPARENT);break;default:this.addFaceRangesToOccurrenceNode(e,n,i,o,c,lp.OPAQUE),this.addFaceRangesToOccurrenceNode(e,n,i,o,c,lp.TRANSPARENT)}const l=e.getOrCreateGroupRangesForGroupTypeAndLod(s,this.getMeshOwnerId(),_i.MX.SILHOUETTES,eg.DEFAULT);this.node.addOccurrenceGeometryToNode(this.viewer.getResources().SILHOUETTE_NODE_PROPERTIES,i,a,l)}if((Vp||n.containsMesh())&&!this.scalarVisualizationOccurrences.has(i.getOccurrenceId())){const t=Hp.getMeshEdgeId(n.id),s=e.getOrCreateGroupRangesForGroupTypeAndLod(t,this.getMeshOwnerId(),_i.MX.LINES,eg.DEFAULT);this.node.addOccurrenceGeometryToNode(Ap,i,a,s)}if(n.hasEdges())if(this.viewer.areOptimizedBuffersEnabled)this.addOrUpdateBodyOccurrenceBufferSetToNode(this.node,e,s,i,a,this.getNodePropertiesForEdge(n));else{const t=e.getOrCreateGroupRangesForGroupTypeAndLod(s,this.getMeshOwnerId(),_i.MX.LINES,eg.DEFAULT);this.node.addOccurrenceGeometryToNode(this.getNodePropertiesForEdge(n),i,a,t)}if(n.hasPoints()){const t=e.getOrCreateGroupRangesForGroupTypeAndLod(s,this.getMeshOwnerId(),_i.MX.POINTS,eg.DEFAULT);this.node.addOccurrenceGeometryToNode(this.getNodePropertiesForPoint(n),i,a,t)}}addFaceRangesToOccurrenceNode(e,t,i,s,n,r){const a=t.id;let o;if(o=this.scalarVisualizationOccurrences.has(i.getOccurrenceId())?t.containsOnlySheetBodies()?Cp:Mp:this.getNodePropertiesForFace(t,n,r),this.viewer.areOptimizedBuffersEnabled)this.addOrUpdateBodyOccurrenceBufferSetToNode(this.node,e,a,i,s,o);else{const t=e.getOrCreateGroupRangesForGroupTypeAndLod(a,this.getMeshOwnerId(),_i.MX.TRIANGLE_STRIP,eg.DEFAULT);let h=null,c=null,l=this.getSubBodyStyleOverrides(a,i.getOccurrenceId(),r);n===cp.ALL_OPAQUE||n===cp.ALL_TRANSPARENT?h=t:n===cp.OPAQUE_BODY_TRANSPARENT_FACE?r===lp.OPAQUE?(h=t,c=this.subBodyStyleOverrides.getNested(a,lp.TRANSPARENT)):(h=this.subBodyStyleOverrides.getNested(a,lp.TRANSPARENT),l=null):n===cp.TRANSPARENT_BODY_OPAQUE_FACE&&(r===lp.TRANSPARENT?(h=t,c=this.subBodyStyleOverrides.getNested(a,lp.OPAQUE)):(h=this.subBodyStyleOverrides.getNested(a,lp.OPAQUE),l=null)),h&&this.node.addOccurrenceGeometryToNode(o,i,s,h,l,c)}}getSubBodyStyleOverrides(e,t,i){if(this.hasOccurrenceAlphaModifier(t)){const i=this.subBodyStyleOverrides.getNested(e,lp.OPAQUE),s=this.subBodyStyleOverrides.getNested(e,lp.TRANSPARENT);let n=null;if(i&&s){const e=new pS;e.setOperandA(i),e.setOperand(s),n=e}else i?n=i:s&&(n=s);if(n){const e=this.getOccurrenceAlphaModifier(t),i=new sS(tS(e));return i.setOperand(n),i}return null}return this.subBodyStyleOverrides.getNested(e,i)}getOccurrenceAlphaModifier(e){return this.occurrenceAlphaModifiers.has(e)?this.occurrenceAlphaModifiers.get(e):this.generativePartInstanceOccurrences.has(e)?Ms.M81:void 0}hasOccurrenceAlphaModifier(e){return this.occurrenceAlphaModifiers.has(e)||this.generativePartInstanceOccurrences.has(e)}getPartStudioBodyOccurrenceName(e){return Hp.PART_STUDIO_BODY_OCCURRENCE_PREFIX+"."+this.getMeshOwnerId()+"."+e}removeBodyOccurrence(e,t,i){e=this.getCorrectedBodyOccurrenceId(t,e);const s=Hp.getPotentialMeshGroupIdsForBody(t);for(let t=0;t<s.length;++t)this.node.removeMeshGroupFromOccurrence(s[t],e);if(this.decalComponent.removeOccurrence(e,t),!i){if(e===this.partStudioBodyIdToOccurrenceId[t]){let i=!1;const s=this.baseComponent||this.previewClone;s&&(i=s.partStudioBodyIdToOccurrenceId.hasOwnProperty(t)),i||(this.viewer.getOccurrenceDataManager().destroyOccurrenceData(e),this.viewer.getOccurrenceIdManager().removeName(this.getPartStudioBodyOccurrenceName(t))),delete this.partStudioBodyIdToOccurrenceId[t]}this.bodyToOccurrenceId.removeNested(t,e),this.unavailableBodyOccurrences.removeNested(t,e),this.damageInstantiatedTriangleCount(),this.contributesToBodyManager()&&this.getBodyManager().removeOccurrence(e,t)}}refreshAllBodyOccurrences(){this.bodyToOccurrenceId.eachNested(((e,t,i)=>(this.refreshBodyOccurrence(+i,t),!1)),this)}refreshBodyOccurrence(e,t){this.removeBodyOccurrence(e,t,!0),this.addBodyOccurrence(e,t,!0)}refreshBodyOccurrenceForBodyId(e){this.refreshBodyOccurrence(this.partStudioBodyIdToOccurrenceId[e],e)}refreshBodyOccurrences(e,t){if(t){const t=this.partStudioBodyIdToOccurrenceId[e];t&&this.refreshBodyOccurrence(t,e)}else{const t=this.bodyToOccurrenceId.get(e);t&&t.each(((t,i)=>(this.refreshBodyOccurrence(+i,e),!1)),this)}}refreshOccurrence(e){const t=this.occurrences[e];t&&t.displayedPartIds.forEach((t=>{this.refreshBodyOccurrence(e,t)}))}updateBodiesWithChangedMeshReferences(){for(const e of this.bodiesWithUpdatedMeshReferences)this.damageComputedBodyTransparency(e),this.refreshBodyOccurrences(e);this.bodiesWithUpdatedMeshReferences.clear()}getInstantiableConstituentIds(e){if(e.isGroupableCompositeBody)throw new Error("Cannot instantiate constituents of grouped composites");if(e.isClosedComposite)return e.constituentBodyIds;const t=new Set;for(let i=0;i<e.constituentBodyIds.length;++i){const s=e.constituentBodyIds[i],n=this.bodyMetaData[s];n&&n.isClosedCompositeConstituent&&n.consumingClosedCompositeData.isGroupableCompositeBody?t.add(n.consumingClosedCompositeData.id):t.add(s)}return Array.from(t)}addOrUpdateOccurrence(e,t){if(!t)return;const i=new Set;for(let e=0;e<t.partIds.length;++e){const s=t.partIds[e],n=this.bodyMetaData[s];if(n&&n.isNonGroupingCompositeBody){const e=this.getInstantiableConstituentIds(n);for(let t=0;t<e.length;++t){const s=e[t];this.knownBodyIds.has(s)&&i.add(s)}}else this.knownBodyIds.has(s)&&i.add(s)}t.displayedPartIds=i;const s=this.occurrences[e]?this.occurrences[e].displayedPartIds:new Set,n=(0,Js.R)(i,s),r=(0,Js.R)(s,i);if((n.size>0||this.occurrences[e])&&super.addOrUpdateOccurrence(e,t),this.updateOccurrenceParts(e,t,n,r),i.size>0&&this.contributesToBodyManager()){const t=this.getBodyManager();i.forEach((s=>{const n=this.bodyMetaData[s],r=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(e);n&&t.addOrUpdateOccurrence(e,r,n,i.size)}))}}addPartStudioOccurrences(){for(const e in this.bodyMetaData)this.addPartStudioOccurrenceForBodyId(e);this.updateFlattenedBodyLayout()}addPartStudioOccurrenceForBodyId(e){const t=this.getBodyManager(),i=this.bodyMetaData[e];let s=this.partStudioBodyIdToOccurrenceId[e];if(i.isForFlattenedView()!==this.viewer.getIsForFlattenedDisplay()||i.isNonGroupingCompositeBody||i.canBeGroupedWithOtherConstituents)s&&(this.removeBodyOccurrence(s,e),delete this.partStudioBodyIdToOccurrenceId[e]);else{if(!s){s=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.getPartStudioBodyOccurrenceName(e));const n=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(s);if(this.partStudioBodyIdToOccurrenceId[e]=s,this.addBodyOccurrence(s,e),this.contributesToBodyManager()){const e=1;t.addOrUpdateOccurrence(s,n,i,e)}this.hideShowBody(e,i.partStudioVisibility,DI.KF)}super.addOrUpdateOccurrence(this.partStudioBodyIdToOccurrenceId[e],null)}}updateOccurrenceParts(e,t,i,s,n){s.forEach((t=>{this.removeBodyOccurrence(e,t),this.damageInstantiatedTriangleCount()})),i.forEach((t=>{this.addBodyOccurrence(e,t,!1,n),this.damageInstantiatedTriangleCount()})),t.displayedPartIds.forEach((i=>{this.hideShowBody(i,t.isHidden?Js.EE.HIDDEN:Js.EE.VISIBLE,e)}))}reloadOccurrences(){const e=new Set;let t;for(t in this.occurrences){if(t=+t,DI.KF===t){It.log.warn("The part studio occurrence should not be reloaded");continue}const i=this.occurrences[t];if(i){const s=!0;this.updateOccurrenceParts(t,i,i.displayedPartIds,e,s)}}}removeOccurrence(e,t){const i=this.occurrences[e];if(i||e===DI.KF){if(i)i.displayedPartIds.forEach((t=>this.removeBodyOccurrence(e,t)));else for(const e in this.partStudioBodyIdToOccurrenceId)this.removeBodyOccurrence(this.partStudioBodyIdToOccurrenceId[e],e);super.removeOccurrence(e,t)}}changeEntityOwner(e,t){const i=this.idToMetaData[e];if(!i)return void(Gp||(It.log.error("Metadata for entity "+e+" owner "+t+" that is trying to switch between bodies was not found"),Gp=!0));if(!i.isFromBody())return void It.log.error("Trying to switch entity to a part that did not belong to a part in the first place");if(i.getBodyId()===t)return;this.removeMeshIncrement(e),this.removeIdMappings(e);const s=this.bodyMetaData[t];if(!s)return void It.log.error("Failed to find body metadata for body: "+t);const n=i.cloneForNewBody(s);n.getMeshIncrement()?(this.addIdMappings(e,n,t),this.updateEntityGraphics(e,n.getMeshIncrement(),n)):It.log.error("Failed to find mesh increment for a body entity")}refreshSmoothEdgesIfColorChanged(){(0,pi.arraysEqual)(this.lastUsedSmoothEdgeColor,this.viewer.getResources().SMOOTH_EDGE_COLOR)||this.refreshSmoothEdges()}refreshSmoothEdges(){for(const e in this.idToMetaData){const t=this.idToMetaData[e],i=t.getEdgeSmoothnessStatus();i!==W.dA1.SMOOTH&&i!==W.dA1.SMOOTH_V2||this.refreshEntityGraphics(e,t.getBodyMetaData())}}getBodyIdsWithConstituentsInScenegraph(e){const t=new Set(e);for(const i of e){const e=this.bodyMetaData[i];if(e&&e.isNonGroupingCompositeBody&&e.constituentBodyIds)for(const i of e.constituentBodyIds)t.add(i)}return t}setIsBodyClippedBySectionPlane(e,t,i,s){if(i){const i=this.getBodyOccurrenceData(e,this.partStudioBodyIdToOccurrenceId[e]);return void(i&&i.setIsClippedBySectionPlanes(t))}const n=this.getBodyIdsWithConstituentsInScenegraph(new Set([e])),r=s?this.getBodyIdsWithConstituentsInScenegraph(s):null;for(const e of n)r&&r.has(e)||this.setIsBodyClippedBySectionPlane(e,t,!0)}setAreOccurrencesClippedBySectionPlaneExcept(e,t){for(const t in this.bodyMetaData)this.setIsBodyClippedBySectionPlane(t,e);for(const i of t)this.setIsBodyClippedBySectionPlane(i,!e)}updateBodyMetaData(e,t,i,s,n,r,a){let o,h=this.bodyMetaData[t],c=!1,l=!1,u=null;h?o=h.consumingClosedCompositeData?h.consumingClosedCompositeData.id:"":(h=new Nh.XH(t),this.bodyMetaData[t]=h);let d=!1;if(void 0!==o){d=o!==(r?r.id:"")}const g=h.type,p=h.meshState,m=h.isGroupableCompositeBody;if(h.setColorCycle(this.parent.getPartColorCycle()),i){h.name=i.name,h.meshState=i.meshState;let e=W.wG2.SOLID;i.isSheet?e=W.wG2.SHEET:i.isWire&&(e=W.wG2.WIRE),h.type=e,h.isModifiable!==i.isModifiable&&this.bodyVisibility.removeNested(this.partStudioBodyIdToOccurrenceId[t],t),h.isModifiable=i.isModifiable,h.setAppearanceFromDisplayData(i),h.isActiveSheetMetal=i.isActiveSheetMetal;const s=i.customProperties.properties[W.efh.TESSELLATION_SETTING_PROPERTY_ID];s&&(h.tessellationSettingOverride=+s),h.consumingClosedCompositeData&&(d=!0),h.consumingClosedCompositeData=null,u=new Li.kB(i.lowBoxCorner.getVec3(),i.highBoxCorner.getVec3())}else h.setAppearanceFromDisplayData(n),h.consumingClosedCompositeData=r,s&&(h.type=s.closedConstituentPartData.bodyType,h.isActiveSheetMetal=s.closedConstituentPartData.isActiveSheetMetal,h.meshState=s.closedConstituentPartData.meshState,u=new Li.kB(s.lowBoxCorner.getVec3(),s.highBoxCorner.getVec3()));if(s){const i=h.getFinestTessellationSettingOnClient();h.sheetMetalModelId=s.sheetMetalModelId,h.isFlattenedSheetMetalBody=s.isFlattenedSheetMetalBody,h.isBendCenterLineBody=s.isBendCenterLineBody,h.ownerFlattenedBodyId=s.ownerFlattenedBodyId,h.tessellationSettings=e.getPartTessellationSettings(t),h.sheetMetalOrderId=s.sheetMetalOrderId,s.hasTessellationComplexityInformation&&(h.coarseTriangleCount=s.coarseTriangleCount,h.coarsePlanarFaceTriangleCount=s.coarsePlanarFaceTriangleCount),h.isAssociatedWithFlat=s.isAssociatedWithFlat,h.totalEntityCount=s.totalEntityCount,h.bestAvailableTessellationSetting=s.bestAvailableTessellationSetting,null!==i&&h.getFinestTessellationSettingOnClient()!==i&&(l=!0),h.isComposite=s.isComposite,h.isClosedComposite=s.isClosedComposite,h.updateConstituentBodyIds(s.constituentBodyDeterministicIds,this.bodyMetaData)}if(h&&h.isComposite&&!this.viewer.areOptimizedBuffersEnabled&&h.updateDataDerivedFromConstituents(this.bodyMetaData,e.deterministicPartIdToData),u&&!u.equals(h.bounds)&&(h.bounds=u,h.resetMeshIncrement(),c=!0),h&&h.isClosedComposite){i||It.log.warn("Expected to have display data for parent composite, but none was present");const t=null;for(let s=0;s<h.constituentBodyIds.length;++s){const n=h.constituentBodyIds[s],r=e.deterministicPartIdToData[n];this.updateBodyMetaData(e,n,t,r,i,h,m)}}if(d=d||"boolean"==typeof a&&a!==h.canBeGroupedWithOtherConstituents,d){this.baseComponent&&this.bodiesHiddenInBase.add(h.meshGroupId);const e=this.bodyToEntity.get(t);e&&(e.each(((e,t)=>{this.refreshEntityGraphics(t,h)})),h.setIsTessellationLoaded(h.canEntitiesBeLoaded()))}(g!==h.type||l||p!==h.meshState)&&this.refreshBodyOccurrences(t),this.updateBodyColor(t),c&&this.updateBodyManagerReferencesForBody(t);const f=this.unavailableBodyOccurrences.get(t);f&&(f.each(((e,i)=>(this.addBodyOccurrence(+i,t),!1))),this.unavailableBodyOccurrences.remove(t))}getBodyColor(e,t){const i=this.bodyMetaData[e],s=i?i.getColor():(0,Js.zF)(Za.y[0]);return t&&this.hasOccurrenceAlphaModifier(t)&&(s[3]*=this.getOccurrenceAlphaModifier(t)),s}getFaceColor(e,t){const i=this.idToMetaData[e];if(!i)return null;const s=this.entityStyles[e];if(s){let e=s.getAttribute(Jd.COLOR);return this.hasOccurrenceAlphaModifier(t)&&(e=e.slice(),e[3]*=this.getOccurrenceAlphaModifier(t)),e}return this.getBodyColor(i.getBodyId(),t)}setBodyOpacity(e,t,i){const s=this.bodyMetaData[e];s&&(s.appearance||(s.appearance=new W.QHW),s.appearance.color&&(s.appearance.opacity=t,this.updateBodyColor(e,i)))}setBodyColor(e,t,i){const s=this.bodyMetaData[e];if(s&&(s.appearance||(s.appearance=new W.QHW),s.appearance.color&&(s.appearance.color=t,this.updateBodyColor(e,i)),s.isComposite&&s.constituentBodyIds)){let e;e=ft.T.isElementAtVersionOrLater(W.vgi.V2422_ADJACENCY_CHECK_COPY_FACE)&&s.isOpenCompositeBody?this.replaceConsumedBodyIdsWithConsumingCompositeId(s.constituentBodyIds):s.constituentBodyIds;for(const s of e)this.setBodyColor(s,t,i)}}replaceConsumedBodyIdsWithConsumingCompositeId(e){var t,i,s;const n=new Set;for(const r of e)n.add(null!==(s=null===(i=null===(t=this.bodyMetaData[r])||void 0===t?void 0:t.consumingClosedCompositeData)||void 0===i?void 0:i.id)&&void 0!==s?s:r);return[...n]}updateBodyColor(e,t){const i=this.getBodyColor(e);(0,pi.arraysEqual)(this.lastSetBodyColor[e],i)||(this.lastSetBodyColor[e]=i,this.damageComputedBodyTransparency(e),this.refreshBodyOccurrences(e,t))}getOccurrenceColor(e){const t=this.viewer.getOccurrenceIdManager().getIdForName(e.toString());if(t===DI.Qy)return null;const i=this.occurrences[t];if(!i)return null;for(const e of i.displayedPartIds){const i=this.getBodyColor(e,t);if(i)return i.slice(0)}return null}setOccurrenceAlphaModifier(e,t){if(t<0||t>=1)return void It.log.warn("Only alpha modifiers in the range [0, 1) are accepted");const i=this.viewer.getOccurrenceIdManager().getIdForName(e.toString());i!==DI.Qy&&(this.occurrenceAlphaModifiers.set(i,t),this.refreshOccurrence(i))}clearOccurrenceAlphaModifier(e){const t=this.viewer.getOccurrenceIdManager().getIdForName(e.toString());t!==DI.Qy&&this.occurrenceAlphaModifiers.delete(t)&&this.refreshOccurrence(t)}getEntityColor(e){const t=this.entityStyles[e];if(t){const e=t.getAttribute(Jd.COLOR);if(e)return e.slice()}const i=this.idToMetaData[e];return i?this.getBodyColor(i.getBodyId()):null}getOccurrenceBounds(e){const t=new Li.kB,i=this.occurrences[e];return i&&i.displayedPartIds.forEach((i=>{t.addBox(this.getBodyManager().getOccurrenceBounds(e,i))})),t}getEntityBodyGroupId(e){const t=e.getBodyId(),i=this.bodyMetaData[t];return i?i.meshGroupId:t}setScalarVisualizationOccurrence(e,t){this.scalarVisualizationOccurrences.add(e),t?this.refreshBodyOccurrence(e,t):this.refreshOccurrence(e)}clearScalarVisualizationOccurrence(e,t){this.scalarVisualizationOccurrences.delete(e),t&&e?this.refreshBodyOccurrence(e,t):e&&this.refreshOccurrence(e)}clearAllScalarVisualizationOccurrences(){this.scalarVisualizationOccurrences=new Set,this.refreshAllBodyOccurrences()}isVisualizingOccurrences(){return this.scalarVisualizationOccurrences.size>0}setGenerativeDesignVisualizationOccurrence(e){this.generativePartInstanceOccurrences.add(e),this.refreshOccurrence(e)}clearGenerativeDesignOccurrence(e){this.generativePartInstanceOccurrences.delete(e),this.refreshOccurrence(e)}clearAllGenerativeDesignOccurrences(){const e=this.generativePartInstanceOccurrences;this.generativePartInstanceOccurrences=new Set;for(const t of e)this.refreshOccurrence(t)}updateEntityHighlight(e,t,i,s){const n=this.idToMetaData[i];if(!n)return!1;const r=this.getEntityBodyGroupId(n);if((s=this.getCorrectedBodyOccurrenceId(r,s))===DI.Qy||!s)return!1;const a=this.bodyMetaData[n.getBodyId()];if(a&&a.isForFlattenedView()){if(!(a.sheetMetalModelId===this.viewer.getModelViewManagers().getManager().getSelectedSheetmetalModelId())&&!this.isOccurrenceIdForAssembly(s))return!1}return rg.prototype.updateEntityHighlight.call(this,e,t,i,s)}getBodyOccurrenceData(e,t){return(t=this.getCorrectedBodyOccurrenceId(e,t))!==DI.Qy&&t&&this.bodyToOccurrenceId.hasNested(e,t)?this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(t):null}hideShowBody(e,t,i){var s,n;let r=!1;const a=this.bodyMetaData[e];if(a&&a.isClosedComposite&&!a.isGroupableCompositeBody)for(let e=0;e<a.constituentBodyIds.length;++e)r=this.hideShowBody(a.constituentBodyIds[e],t,i)||r;!i&&a&&(a.partStudioVisibility=t);const o=this.getBodyOccurrenceData(e,i);return o&&o.getVisibility()!==t&&(o.setVisibility(t),this.viewer.requestDraw(),r=!0),r&&(null===(n=null===(s=(0,up.PT)())||void 0===s?void 0:s.getInferenceSetController())||void 0===n||n.updateInferencingOnPartVisibilityChange(e,t)),r}setBodyCullingState(e,t,i,s){const n=this.getBodyOccurrenceData(i,e);if(n&&n.getMeshGroupCullingState(i)!==t){const r=Hp.getPotentialMeshGroupIdsForBody(i);for(let e=0;e<r.length;++e)n.setCullingState(t,r[e]);t!==Js.uc.CULLED&&s?this.decalComponent.addOrUpdateOccurrence(i,e):this.decalComponent.removeOccurrence(e,i),this.viewer.requestDraw()}}isEntityHidden(e,t){const i=this.getBodyOccurrenceData(this.getEntityBodyGroupId(e),t);return!!i&&i.getVisibility()===Js.EE.HIDDEN}getBodyDisplay(e){const t=this.bodyMetaData[e];return t?t.meshIncrement?t.meshIncrement:t.isSolidBody()||t.isSheetBody()?(t.meshIncrement=bu(t.getBounds().getMin(),t.getBounds().getMax()),t.meshIncrement.id=e,t.meshIncrement.groupId=e,t.meshIncrement.lod=eg.LOWEST,t.meshIncrement.pickId=this.getEntityIdManager().getOrCreateIdForName(e),t.meshIncrement):null:null}getOccurrenceIdForEntity(e){let t;if(this.idToMetaData[e]&&this.idToMetaData[e]instanceof W.Wzw){const i=this.idToMetaData[e];i.bodyMetaData&&(t=this.partStudioBodyIdToOccurrenceId[i.bodyMetaData.id])}return t}getStatistics(e,t=!1){const i={faces:0,triangles:0,edges:0,lines:0,vertices:0,silhouettes:0,settingCounts:{},uniqueParts:0,uniqueSurfaces:0,uniqueCurves:0,uniqueOpenComposites:0,uniqueClosedComposites:0,partOccurrences:0,surfaceOccurrences:0,curveOccurrences:0,openCompositeOccurrences:0,openCompositeConstituentOccurrences:0,closedCompositeOccurrences:0,closedCompositeConstituentOccurrences:0,bodiesPendingRetrieval:0,veryFineParts:new Map,veryFineOccurrences:[]},s=this.getMeshManager(),n=this.getMeshOwnerId(),r=new Set,a=new Set,o=new Map,h=[],c=(l,u,d)=>{if(e){const e=this.bodyToEntity.get(l);e&&e.each(((e,t)=>{const s=this.idToMetaData[t];if(s)return s.isFace()?(i.faces+=1,i.triangles+=s.getMeshIncrement().getTriangleCount()):s.isLine()?(i.edges+=1,i.lines+=s.getMeshIncrement().getLineCount()):s.isVertex()&&(i.vertices+=1),!1}));const t=s.getGroupRangesForGroupTypeAndLod(l,n,_i.MX.SILHOUETTES,eg.DEFAULT);t&&(i.silhouettes+=t.getPrimitiveCount())}const g=this.bodyMetaData[l],p=this.occurrences[u],m=W.ls1.getTessellationSettingIndexFromEnum(W.XiJ.VERY_FINE);if(g&&g.tessellationSettings){if(!g.isClosedCompositeConstituent)for(let e=0;e<g.tessellationSettings.length;++e){const s=g.tessellationSettings[e],n=i.settingCounts[s]||0;i.settingCounts[s]=n+1,t&&s===m&&(p?h.push(p.occurrenceData.occurrence):g&&(o.has(l)||o.set(l,g)))}if(g.isClosedComposite&&!a.has(g)&&(i.uniqueClosedComposites++,a.add(g)),d&&(g.isClosedComposite?i.closedCompositeOccurrences++:g.isSolidBody()?i.partOccurrences++:g.isSheetBody()?i.surfaceOccurrences++:g.isWireBody()&&i.curveOccurrences++),g.isClosedComposite&&d)for(let e=0;e<g.constituentBodyIds.length;++e)c(g.constituentBodyIds[e],u,!1);if(g.isClosedCompositeConstituent&&d){i.closedCompositeConstituentOccurrences++;const e=p?u:g.consumingClosedCompositeData.id;r.has(e)||(c(g.consumingClosedCompositeData.id,u,!1),r.add(u))}else if(g.hasReferencingOpenCompositeBody&&p){const e=this.bodyMetaData[p.partIds[0]];e.isOpenCompositeBody&&(i.openCompositeConstituentOccurrences++,r.has(u)||(i.openCompositeOccurrences++,r.add(u)),a.has(e)||(i.uniqueOpenComposites++,a.add(e)))}}};return this.bodyToOccurrenceId.each(((e,t)=>{const s=this.bodyMetaData[t];return s&&(s.isComposite||s.isClosedCompositeConstituent||(s.isSolidBody()?i.uniqueParts++:s.isSheetBody()?i.uniqueSurfaces++:s.isWireBody()&&i.uniqueCurves++,s.canEntitiesBeLoaded()||i.bodiesPendingRetrieval++)),e.each((function(e,i){return c(t,i,!0),!1})),!1}),this),t&&(i.veryFineParts=o,i.veryFineOccurrences=h),i}getPartStudioBodyOccurrenceIds(){const e=[];for(const t in this.partStudioBodyIdToOccurrenceId)e.push(this.partStudioBodyIdToOccurrenceId[t]);return e}showPartsWithSheetmetalModelIdOnly(e){for(const t in this.partStudioBodyIdToOccurrenceId)if(t in this.bodyMetaData){this.bodyMetaData[t].sheetMetalModelId===e?this.hideShowBody(t,Js.EE.VISIBLE,DI.KF):this.hideShowBody(t,Js.EE.HIDDEN,DI.KF)}}needsDisplayData(e){let t=!1;for(let i=0;i<e.partDisplayData.length;i++){const s=e.partDisplayData[i];t=t||s.id in this.bodyMetaData&&this.bodyMetaData[s.id].isForFlattenedView()}return t}isBodyActiveInView(e,t){const i=this.bodyMetaData[e];if(i&&i.isComposite&&!t)return!0;const s=this.getCorrectedBodyOccurrenceId(e,this.viewer.getIdForOccurrence(t)),n=this.occurrences[s];return n?n.containsPart(e)||n.displayedPartIds.has(e):!!this.bodyToOccurrenceId.hasNested(e,s)&&(!this.viewer.getIsForFlattenedDisplay()||this.isBodyVisible(s,e))}getTransformFromSheetMetalBodyMetaData(e){const t=e.sheetMetalOrderId.split(" "),i=e.sheetMetalOrder;if(0===i||i>t.length)return ge.create();const s=t.slice(0,i).join(" ");return this.sheetMetalOrderIdToTransform[s]}isEntityMeasurable(e,t){const i=this.getEntityMetaData(e);return!!i&&this.isBodyActiveInView(this.getEntityBodyGroupId(i),t)}updateFlattenedBodyLayout(){if(!this.viewer.getIsForFlattenedDisplay())return;if((0,Js.hW)(this.partStudioBodyIdToOccurrenceId))return;this.sheetMetalOrderIdToTransform={};const e=10*Math.max.apply(Math,Object.values(this.bodyMetaData||{}).map((function(e){return e.bounds.max[2]-e.bounds.min[2]}))),t={},i=Object.keys(this.bodyMetaData||{}),s=this;i.sort((function(e,t){const i=s.bodyMetaData[e],n=s.bodyMetaData[t];return!i.isSubsidiaryBody()&&n.isSubsidiaryBody()?-1:i.isSubsidiaryBody()&&!n.isSubsidiaryBody()?1:i.sheetMetalOrderId<n.sheetMetalOrderId?-1:i.sheetMetalOrderId>n.sheetMetalOrderId?1:0}));const n={};let r="";for(let s=0;s<i.length;s++){const a=i[s],o=this.bodyMetaData[a];let h=t[o.sheetMetalModelId];h||(h=new Li.kB,t[o.sheetMetalModelId]=h);const c=o.sheetMetalOrderId.split(" ");let l=c[0],u=1;for(;u<c.length&&!(r<l);u++)l+=" "+c[u];o.sheetMetalOrder=u,r=l;const d=o.bounds;let g,p;h.isInitialized()?(g=h.max[0]+e-d.min[0],p=h.max[1]-d.max[1]):(g=0,p=0);const m=-d.max[2],f=this.partStudioBodyIdToOccurrenceId[a];f||It.log.warn("No occurrence for flattened body "+a);let I=ge.create();if(pe.w$.translate(I,[g,p,m]),o.isSubsidiaryBody()){const e=n[o.getOwnerBodyId()];e&&(I=e)}this.viewer.getOccurrenceDataManager().setOccurrenceTransform(f,I),this.updateBodyManagerReferencesForBody(a),h.addBox(d,I),n[a]=I,this.sheetMetalOrderIdToTransform[l]=I}}hasBody(e){return this.bodyMetaData.hasOwnProperty(e)}hasBodyOccurrence(e,t){const i=this.getCorrectedBodyOccurrenceId(e,this.viewer.getIdForOccurrence(t));return this.bodyToOccurrenceId.hasNested(e,i)}contributesToBodyManager(){return this.isForBase()}updateBodyManagerReferencesForBody(e){const t=this.bodyMetaData[e];if(!t||!this.contributesToBodyManager())return;const i=this.getBodyManager(),s=this.bodyToOccurrenceId.get(e);s&&s.each(((s,n)=>{n=+n;let r=1;const a=this.occurrences[n];return a&&(r=a.displayedPartIds.size),i.addOrUpdateOccurrence(n,this.getBodyOccurrenceData(e,n),t,r),!1}),this)}setDebugFaceTriangles(e){if(Vp=e,Vp)for(const e in this.idToMetaData){const t=this.idToMetaData[e],i=t.getMeshIncrement();i&&this.addMeshTriangleEdges(i,t)}this.refreshAllBodyOccurrences()}integrityCheck(){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio()===this.parent;for(const t in this.bodyMetaData){if(null!==this.bodyMetaData[t].getFinestTessellationSettingOnClient()){const e=this.bodyToEntity.get(t);e&&!e.isEmpty()||It.log.info("Body "+t+" is missing entity data in "+this.parent.getFullElementId())}else e&&It.log.info("Body "+t+" has no tessellation available, but it is in the active part studio: "+this.parent.getFullElementId())}}collectComponentsForHeapDump(e){for(const t in this.idToMetaData){const i=this.idToMetaData[t],s=i.getMeshIncrement();e.meshIncrements.push(s),e.entityData.push(i),i.isFace()&&!i.isPlanarFace()&&e.silhouetteIncrements.push(mI(s));const n=this.getMeshIncrementDetails(t);n?e.incrementDetails.push(n):console.warn("Did not find increment details for "+t)}this.reset()}}Hp.PART_STUDIO_BODY_OCCURRENCE_PREFIX="body",Hp.MESH_EDGE_GROUP_SUFFIX="_meshEdges";class kp extends rg{constructor(e,t){super(e,t)}getComponentId(){return"error_component."}handlesEntity(e,t){return e.hasTessellationError()&&!this.viewer.getIsForFlattenedDisplay()}expectsTessellation(){return!1}removeBaseIncrement(e){}updateEntityGraphics(e,t,i){}getHideableFeatureIds(){return[]}}const Wp=q.default.getManager(),zp=new Ni;let Xp=0;Object.values(W.ea7).forEach((e=>{(0,Jr.Z)(e)&&(Xp=Math.max(e,Xp))}));const qp=Math.ceil(Math.log(Xp)/Math.log(2)),Zp="sketch_component.";class Yp extends ag{constructor(e,t,i){super(e,i,t),this.activeSketches={},this.hasBeenInstantiated=!1,this.entityColors=new Map,this.sketchToSMModelIdMapping={},this.idToPartData={},this.sketchToSketchEntityMapping=new Ol.TemplatedNestedMap,this.styledRanges=new Ol.TemplatedNestedMap,this.node=e?e.getModelViewManager().getSharedSketchNode():null,this.sketchComponentElementId=this.viewer.getOccurrenceIdManager().getOrCreateIdForName("PART_STUDIO_SKETCHES")}getNode(){return this.node}isEntityInActiveSketch(e){return this.activeSketches.hasOwnProperty(e.getSketchFeatureId())}isSketchInContext(e){return e!==this.sketchComponentElementId&&this.viewer.getModelViewManagers().getManager().displayingPartStudio()}updateMissingEntityGraphicsForSketch(e,t){const i=this.sketchToSketchEntityMapping.get(e);for(const e in i){if(t.deterministicIdToEntity[e])continue;const s=i[e],n=this.idToMetaData[s];if(!n)continue;const r=n.getMeshIncrement();r&&(this.removeMeshIncrement(r.id),this.updateEntityGraphics(s,r,n))}}processAdditionsAndChanges(e,t){const i={};for(const t in e.deterministicPartIdToData){const s=e.deterministicPartIdToData[t];for(let t=0;t<s.entityDIds.length;++t){const n=s.entityDIds[t],r=e.deterministicIdToEntity[n];r&&!r.isDeletion()&&this.handlesEntity(r,s)&&(r.isAssociatedWithFlat=s.isAssociatedWithFlat,r.isAssociatedWithFlat&&(i[r.getFirstFeatureId()]=s.ownerFlattenedBodyId),this.idToPartData[n]=s)}}for(const t of Object.keys(e.sketchFeatureIdAndTessellationSettingToBuffers))this.featureToIds.insertKeyOnly(t);this.processPrecompiledGraphicsBuffers(e.sketchFeatureIdAndTessellationSettingToBuffers);for(const t in this.sketchToSMModelIdMapping)i[t]||this.updateMissingEntityGraphicsForSketch(t,e);this.updateEntityAppearanceOverrides(e),super.processAdditionsAndChanges(e,t)}getEntityColor(e){const t=this.entityColors.get(e);return t?t.color:null}getEntityOverrideId(e){const t=this.entityColors.get(e);return t?t.overrideId:""}getOverrideColor(e){return[e.color[0]/255,e.color[1]/255,e.color[2]/255,e.opacity/255]}updateEntityAppearanceOverrides(e){const t=new Set;for(const i in e.appearanceIdToAppearanceOverride){const s=e.appearanceIdToAppearanceOverride[i],n=i===W.QHW.RESET_APPEARANCE_ID?null:this.getOverrideColor(s.appearance);for(let r=0;r<s.entityDeterministicIds.length;++r){const a=s.entityDeterministicIds[r],o=e.deterministicIdToEntity[a]||this.idToMetaData[a];if(!o||!this.handlesEntity(o))continue;const h=o.getLastFeatureId();if(!t.has(h)){t.add(h);for(const e in this.occurrences)this.clearSketchGraphics(h,+e)}if(n){const e={overrideId:i,color:n};this.entityColors.set(a,e)}else this.entityColors.delete(a)}}for(const e of t)for(const t in this.occurrences)this.instantiateSketchGraphics(e,+t)}getColorForSketch(e){const t=this.featureToIds.get(e);let i=null;return t&&t.each(((e,t)=>(i=this.getEntityColor(t),!!i))),i}processDeletions(e){for(const t in e.deterministicIdToEntity){const i=e.deterministicIdToEntity[t];i&&this.handlesEntity(i)&&this.removeEntity(t)}super.processDeletions(e);for(const t in e.deterministicIdToEntity){const i=e.deterministicIdToEntity[t];i&&this.handlesEntity(i)||this.entityColors.delete(t)}}reset(){for(const e in this.idToMetaData)this.removeMeshIncrement(e);this.clearGraphics(),this.entityColors.clear(),this.sketchToSketchEntityMapping.clear(),this.sketchToSMModelIdMapping={},this.idToPartData={},super.reset()}clearGraphics(){var e;for(const t in this.occurrences)null===(e=this.node)||void 0===e||e.removeOccurrence(+t);this.styledRanges.eachNested((e=>(e.getMeshRanges().destroy(),!1))),this.styledRanges.clear()}addIdMappings(e,t,i,s){super.addIdMappings(e,t,i,s);const n=t.getSketchFeatureId();this.sketchToSketchEntityMapping.insertNested(n,t.getSketchEntityId(),e);const r=s&&s.incremental,a=this.idToPartData[e],o=!!a&&!a.isAssociatedWithFlat;r&&o&&va(n)}getSMModelIdForSketch(e){return this.sketchToSMModelIdMapping[e]}removeIdMappings(e){const t=this.idToMetaData[e];if(!t)return;const i=t.getSketchFeatureId();this.sketchToSketchEntityMapping.removeNested(i,t.getSketchEntityId()),delete this.idToPartData[e],delete this.sketchToSMModelIdMapping[i],super.removeIdMappings(e)}retrieveBodyMetaData(e){const t=this.bodyToEntity.get(e);if(t&&t.size()>0){const i=new Nh.XH(e);let s=!1,n=!1,r=!1;return t.each(((e,t)=>{const i=this.idToMetaData[t];i&&(i.isVertex()?s=!0:i.isEdge()?n=!0:i.isFace()&&(r=!0))})),r?i.type=W.wG2.SHEET:n?i.type=W.wG2.WIRE:s&&(i.type=W.wG2.POINT),i.isSketchBody=!0,i}return null}getNodeProperties(e,t,i,s){let n=Wp.getNumber("DEFAULT_Z_OFFSET");e.isFace()?n=Wp.getNumber("SKETCH_FACES_Z_OFFSET"):e.isEdge()?n=Wp.getNumber("SKETCH_EDGES_Z_OFFSET"):e.isVertex()?n=Wp.getNumber("SKETCH_POINTS_Z_OFFSET"):e.isDegenerateEdge()&&(n=Wp.getNumber("DEGENERATE_Z_OFFSET"));let r=Yi.DEFAULT;return e.isSketchConstructionEntity()&&e.isEdge()&&(Ys()?t=!1:this.isEntityInActiveSketch(e)||(r=Yi.LOWER)),t&&this.isSketchInContext(i)&&(r=Yi.LOWER),new Qi({primitiveType:s,isTwoSided:e.isFace(),primitivesHaveTransparency:e.isFace(),material:Wi,isPickable:!(t&&e.isFace()),isShowThrough:t,isDepthTested:!t,isStencilTested:t,isHighlightable:!t||e.isSketchConstructionEntity(),zOffset:n,addsToBounds:!e.isVertex()||e.isSketchUserPoint(),priority:r,includedInBlend:!0,isTintedByCompare:!0})}getStyle(e,t,i,s){let n=null,r=null,a=null;if(e.isFace())n=i?Wp.getColor("SKETCH_FACE_SHOW_THROUGH_COLOR"):Wp.getColor("SKETCH_FACE_COLOR");else{if(t){const t=e.getSketchSolveStatus();n=e.isEdge()&&(e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon())?Wp.getColor("SPLINE_HANDLE_COLOR"):e.isPreviewEntity?Wp.getColor("SKETCH_PREVIEW_COLOR"):t&&t!==W.ea7.UNKNOWN?t===W.ea7.UNDER_DEFINED?i?Wp.getColor("UNDERCONSTRAINED_SHOW_THROUGH_LINE_POINT_COLOR"):Wp.getColor("UNDERCONSTRAINED_LINE_POINT_COLOR"):t===W.ea7.FIXED||t===W.ea7.WELL_DEFINED?i?Wp.getColor("CONSTRAINED_SHOW_THROUGH_LINE_POINT_COLOR"):Wp.getColor("CONSTRAINED_LINE_POINT_COLOR"):i?Wp.getColor("OVERCONSTRAINED_SHOW_THROUGH_LINE_POINT_COLOR"):Wp.getColor("OVERCONSTRAINED_LINE_POINT_COLOR"):i?Wp.getColor("SHOW_THROUGH_LINE_POINT_COLOR"):Wp.getColor("LINE_POINT_COLOR")}else n=Wp.getColor("INACTIVE_SKETCH_COLOR");e.isVertex()?(r=t?e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Wp.getNumber("ACTIVE_SKETCH_SPLINE_HANDLE_SIZE"):e.isSketchUserPoint()?Wp.getNumber("ACTIVE_SKETCH_USER_POINT_SIZE"):Wp.getNumber("ACTIVE_SKETCH_POINT_SIZE"):e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Wp.getNumber("INACTIVE_SKETCH_SPLINE_HANDLE_SIZE"):e.isSketchUserPoint()?Wp.getNumber("INACTIVE_SKETCH_USER_POINT_SIZE"):Wp.getNumber("INACTIVE_SKETCH_POINT_SIZE"),a=e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Wp.getPointFont("SKETCH_SPLINE_HANDLE_POINT_FONT"):e.isSketchUserPoint()?Wp.getPointFont("SKETCH_USER_POINT_FONT"):Wp.getPointFont("SKETCH_POINT_FONT")):e.isEdge()?(r=t?i?Wp.getNumber("ACTIVE_SKETCH_SHOW_THROUGH_LINE_WIDTH"):e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Wp.getNumber("SPLINE_HANDLE_LINE_WIDTH"):Wp.getNumber("ACTIVE_SKETCH_LINE_WIDTH"):i?Wp.getNumber("INACTIVE_SKETCH_SHOW_THROUGH_LINE_WIDTH"):e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Wp.getNumber("INACTIVE_SKETCH_SPLINE_HANDLE_SIZE"):Wp.getNumber("INACTIVE_SKETCH_LINE_WIDTH"),a=!e.isSketchConstructionEntity()||e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?t?Wp.getStipple("DEFAULT_LINE_STIPPLE"):i?Wp.getStipple("DEFAULT_SHOW_THROUGH_LINE_STIPPLE"):Wp.getStipple("DEFAULT_LINE_STIPPLE"):Wp.getStipple("CONSTRUCTION_LINE_STIPPLE")):e.isDegenerateEdge()&&(r=t?Wp.getNumber("DEGENERATE_EDGE_ACTIVE_SIZE"):Wp.getNumber("DEGENERATE_EDGE_INACTIVE_SIZE"),a=t?Wp.getPointFont("SKETCH_DEGENERATE_EDGE_FONT"):Wp.getPointFont("SKETCH_POINT_FONT"))}if(e.isFace()&&Ys()&&e instanceof W.lo2&&(n=Ju(this.getEntityPlaneId(e))),!t){const e=this.getEntityColor(s);e&&(n=e)}const o=new fE;return n&&o.setAttribute(Jd.COLOR,n),null!==r&&o.setAttribute(Jd.PRIMITIVE_SIZE,r),a&&o.setAttribute(Jd.PRIMITIVE_STYLE,a),o}getEntityPlaneId(e){if(!e.isFace())return 0;const t=e.getMeshIncrement();if(!t)return 0;const i=t.points,s=t.normals;return ju([i[0],i[1],i[2]],[s[0],s[1],s[2]])}handlesEntity(e,t){return!(t&&this.viewer.getIsForFlattenedDisplay()&&!t.isForFlattenedView())&&e.isFromSketch()&&(this.viewer.areOptimizedBuffersEnabled||!e.hasTessellationError())}getOwnerFlattenedBodyIdForSketch(e){const t=this.sketchToSketchEntityMapping.get(e);if(!t)return null;let i=null;return t.each(((e,t)=>{const s=this.idToPartData&&this.idToPartData[e];if(s)return s.isAssociatedWithFlat&&(i=s.ownerFlattenedBodyId),!0})),i}getOwnerFlattenedBodyId(e){const t=this.idToPartData[e];return t&&t.isAssociatedWithFlat?t.ownerFlattenedBodyId:null}getSheetMetalModelId(e){const t=this.getOwnerFlattenedBodyId(e);if(t){const e=this.parent.retrieveBodyMetaData(t);if(e)return e.sheetMetalModelId}return null}getTransformForSketchEntity(e){const t=this.getOwnerFlattenedBodyId(e),i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(t&&i){const e=i.retrieveBodyMetaData(t);if(e)return i.getBodyComponent().getTransformFromSheetMetalBodyMetaData(e)}return ge.create()}updateSMMapping(e,t){if(this.viewer.getIsForFlattenedDisplay()){const i=this.getOwnerFlattenedBodyId(e);if(this.parent&&i){const e=this.parent.retrieveBodyMetaData(i);e&&(this.sketchToSMModelIdMapping[t.getLastFeatureId()]=e.sheetMetalModelId)}}}updateEntityGraphics(e,t,i){if(!t)return;if(this.viewer.getIsForFlattenedDisplay()){const s=this.getOwnerFlattenedBodyId(e);if(this.parent&&s){const e=this.parent.retrieveBodyMetaData(s);if(e){this.sketchToSMModelIdMapping[i.getSketchFeatureId()]=e.sheetMetalModelId;const s=this.parent.getBodyComponent().getTransformFromSheetMetalBodyMetaData(e);s&&(t=t.createTransformed(s))}}}let s;for(s in this.addMeshIncrement(t),this.occurrences)s=+s,this.isEntityForDisplay(e,s)&&this.updateEntityOccurrenceGraphics(e,s,i)}getOccurrenceIdForEntity(e){return this.sketchComponentElementId}getHideableFeatureIds(){return this.featureToIds.getKeys()}copySketchDataToClone(e){e.sketchToSketchEntityMapping=this.sketchToSketchEntityMapping.cloneNested(),e.idToPartData=(0,Q.shallowClone)(this.idToPartData),e.sketchToSMModelIdMapping=(0,Q.shallowClone)(this.sketchToSMModelIdMapping),e.entityColors=new Map(this.entityColors)}clone(e){const t=new Yp(e,this.usage,this.viewer);return this.copyToClone(t),this.copySketchDataToClone(t),t}cloneForPreview(e){const t=new Yp(e,Ls.L.PREVIEW,this.viewer);this.copyToPreview(t),this.copySketchDataToClone(t);for(const e in this.activeSketches)t.activeSketches[e]=this.activeSketches[e];t.hasBeenInstantiated=!0;for(const e in this.occurrences)t.addOrUpdateOccurrence(+e,this.occurrences[e]);return t}removeMeshIncrement(e){const t=this.getMeshManager().removeMeshIncrement(e,this.getMeshOwnerId());if(!t)return null;let i;for(i in this.occurrences){const s=this.occurrences[i];i=+i,s&&!s.containsPart(e)||this.removeEntityFromOccurrence(e,i,t)}return t}onAppearanceConstantsUpdated(){this.clearGraphics();for(const e of this.featureToIds.getKeys())for(const t of Object.keys(this.occurrences))this.instantiateSketchGraphics(e,+t)}removeEntityFromOccurrence(e,t,i){const s=this.idToMetaData[e];if(!s)return;if(!i&&!(i=this.getMeshManager().getIncrementDetails(e,this.getMeshOwnerId())))return;const n=this.isSketchDisplayedAsActive(s.getSketchFeatureId(),t);this.getRanges(e,s,t,n,!1).onIncrementRemoved(i);this.getRanges(e,s,t,n,!0).onIncrementRemoved(i)}accumulateSketchIdsFromBodyId(e,t){const i=this.bodyToEntity.get(e);if(i)for(const e of i.getKeys()){const i=this.idToMetaData[e];if(i&&i.getFeatureIds())for(const e of i.getFeatureIds())t.add(e)}}displaySketchAsActive(e,t){this.activeSketches.hasOwnProperty(e)!==t&&(this.clearSketchGraphics(e),t?this.activeSketches[e]=!0:delete this.activeSketches[e],this.instantiateSketchGraphics(e),t&&this.hideShowFeature(e,Js.EE.VISIBLE))}isSketchDisplayedAsActive(e,t){return t===this.sketchComponentElementId&&this.activeSketches.hasOwnProperty(e)}hasActiveSketch(){return!(0,Q.isEmptyObjectOrArray)(this.activeSketches)}resetPrimitiveAttributes(e,t){this.clearSketchGraphics(e,t),this.instantiateSketchGraphics(e,t)}clearSketchGraphics(e,t){const i=this.featureToIds.get(e);if(!i)return;if(t=t||this.sketchComponentElementId,!this.occurrences.hasOwnProperty(t))return;const s=i.getKeys();for(let e=0;e<s.length;e++)this.removeEntityFromOccurrence(s[e],t)}isEntityForDisplay(e,t){const i=this.idToPartData[e],s=!i||i.isAssociatedWithFlat,n=this.occurrences[t];return!n&&s===this.viewer.getIsForFlattenedDisplay()||!!n&&n.containsPart(e)}instantiateSketchGraphics(e,t){const i=this.featureToIds.get(e);if(!i)return;if(t=t||this.sketchComponentElementId,!this.occurrences.hasOwnProperty(t))return;const s=i.getKeys();for(let e=0;e<s.length;e++){const i=s[e],n=this.idToMetaData[i];n&&(this.isEntityForDisplay(i,t)&&this.updateEntityOccurrenceGraphics(i,t,n))}}retrieveSketchEntityDeterministicId(e,t){const i=this.sketchToSketchEntityMapping.getNested(e,t);return i||null}isInstantiated(){return this.hasBeenInstantiated}instantiateForPartStudio(e){super.instantiateForPartStudio(e),this.addOrUpdateOccurrence(this.sketchComponentElementId,null)}removePartStudioInstantiation(e){this.usage===Ls.L.PREVIEW&&super.removePartStudioInstantiation(e),this.removeOccurrence(this.sketchComponentElementId,!0)}addOrUpdateOccurrence(e,t){this.hasBeenInstantiated||(this.viewer.areOptimizedBuffersEnabled||this.instantiateEntities(),this.hasBeenInstantiated=!0);const i=this.addOrUpdateOccurrenceFromMeshManager(e,t,this.getMeshManager()),s=this.getSharedBaseMeshManager();s&&this.addOrUpdateOccurrenceFromMeshManager(e,t,s),t&&this.parent.imageComponent.updateDisplaysByOccurrence(e,t,this.getSketchFeatureIdsInstantiatedForOccurrence(t));const n=e===this.sketchComponentElementId;(i||n||this.occurrences.hasOwnProperty(e))&&super.addOrUpdateOccurrence(e,t)}getSketchFeatureIdsInstantiatedForOccurrence(e){const t=new Set;for(let i=0;i<e.partIds.length;++i){const s=this.idToMetaData[e.partIds[i]];if(s&&s.getFeatureIds()){const e=s.getFeatureIds();for(let i=0;i<e.length;++i)t.add(e[i])}}return t}addOrUpdateOccurrenceFromMeshManager(e,t,i){if(t){let s=null;const n=t.sketchFeatureId;if(this.viewer.areOptimizedBuffersEnabled&&n.length>0&&this.featureToIds.get(n))return this.addSketchFeatureToSceneGraph(n,i,e),!0;for(let e=0;e<t.partIds.length;++e){const i=t.partIds[e];if(this.idToMetaData.hasOwnProperty(i))s||(s=new Set),s.add(i);else{const e=this.parent.retrieveBodyMetaData(i);if(e&&e.isComposite&&e.constituentBodyIds)for(let t=0;t<e.constituentBodyIds.length;++t){const i=e.constituentBodyIds[t],n=this.bodyToEntity.get(i);n&&(s||(s=new Set),n.each(((e,t)=>{null==s||s.add(t)})))}}}if(!s||0===s.size)return!1;const r=this.occurrences[e]?this.occurrences[e].displayedSketchEntityIds:new Set,a=(0,Js.R)(s,r);return t.displayedSketchEntityIds=s,this.updateEntitiesOccurrences(e,t,a,s,i),!0}if(!this.occurrences.hasOwnProperty(e)){const s=new Set;Object.entries(this.idToMetaData).forEach((([t,i])=>{this.isEntityForDisplay(t,e)&&s.add(t)})),this.updateEntitiesOccurrences(e,t,s,s,i)}return!0}addSketchFeatureToSceneGraph(e,t,i){const s=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(i),n=[_i.MX.LINES,_i.MX.TRIANGLE_STRIP],r=[!1,!0];for(const a of n){const n={isPreviewEntity:!1,getSketchFeatureId:()=>e,isFace:()=>a===_i.MX.TRIANGLE_STRIP,isEdge:()=>a===_i.MX.LINES,isVertex:()=>a===_i.MX.POINTS,getSketchSolveStatus:()=>W.ea7.UNKNOWN,isFromSketchSplineHandle:()=>!1,isFromSketchSplineControlPolygon:()=>!1,isSketchConstructionEntity:()=>!1,isSketchUserPoint:()=>!1,isDegenerateEdge:()=>!1};for(const o of r){const r=this.getNodeProperties(n,o,i,a),h=this.getStyle(n,!1,o,null);this.addOrUpdateBodyOccurrenceBufferSetToNode(this.node,t,e,s,h,r)}}}updateEntitiesOccurrences(e,t,i,s,n){if(i)for(const t of i){const i=this.idToMetaData[t];i?this.updateEntityOccurrenceGraphics(t,e,i,n):It.log.warn("Could not find meta data for entity")}if(t){const i=t.isHidden?Js.EE.HIDDEN:Js.EE.VISIBLE;for(const t of s)this.hideShowEntity(t,i,e)}}getRanges(e,t,i,s,n){var r;zp.reset(),zp.addBoolean(s),zp.addBoolean(n),zp.addBoolean(t.isPreviewEntity),zp.addBoolean(t.isFace()),zp.addBoolean(t.isEdge()),zp.addBoolean(t.isVertex()),zp.addBoolean(t.isDegenerateEdge()),zp.addBoolean(t.isSketchConstructionEntity()),zp.addBoolean(t.isSketchUserPoint()),zp.addBoolean(t.isFromSketchSplineHandle()),zp.addBoolean(t.isFromSketchSplineControlPolygon()),zp.addNumber(t.getSketchSolveStatus(),qp);let a=zp.getId().toString();if(Ys()&&(a=zp.getIdWithIdAppended(this.getEntityPlaneId(t)).toString()),!s){if(null!==this.getEntityColor(e)){a+=this.getEntityOverrideId(e)}}let o=this.styledRanges.getNested(i,a);if(!o){const h=this.getNodeProperties(t,n,i,HI(t)),c=this.getStyle(t,s,n,e),l=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(i),u=new BS("SketchComponent."+i+"."+a);this.usage===Ls.L.PREVIEW&&u.setListenForDeletions(!0),o=null===(r=this.node)||void 0===r?void 0:r.addOccurrenceGeometryToNode(h,l,c,u),this.styledRanges.insertNested(i,a,o)}return o.getMeshRanges()}updateEntityOccurrenceGraphics(e,t,i,s){const n=this.isSketchDisplayedAsActive(i.getSketchFeatureId(),t),r=(s=s||this.getMeshManager()).getIncrementDetails(e,this.getMeshOwnerId());if(!r)return;this.getRanges(e,i,t,n,!1).onIncrementAdded(r);this.getRanges(e,i,t,n,!0).onIncrementAdded(r),(this.isEntityHidden(i,t)||!n&&i&&(i.isFromSketchSplineHandle()||i.isFromSketchSplineControlPolygon()))&&this.hideMeshIncrement(e,t)}isEntityHidden(e,t){if(t===this.sketchComponentElementId)return super.isEntityHidden(e,t);{const e=this.occurrences[t];return!!e&&e.isHidden}}removeOccurrence(e,t){var i;this.occurrences.hasOwnProperty(e)&&(this.styledRanges.remove(e),null===(i=this.node)||void 0===i||i.removeOccurrence(e),super.removeOccurrence(e,t))}getEntitiesForOccurrenceSelection(e){const t=this.occurrences[e];if(t&&t.displayedSketchEntityIds){const e=[];for(const i of t.displayedSketchEntityIds){const t=this.idToMetaData[i];!t||t.isFromSketchSplineHandle()||t.isFromSketchSplineControlPolygon()||e.push(i)}return e}return null}updateEntityHighlight(e,t,i,s){let n=s;const r=this.idToMetaData[i];if(r&&s===DI.KF&&(n=this.sketchComponentElementId,!this.isSketchDisplayedAsActive(r.getSketchFeatureId(),n)&&(r.isFromSketchSplineHandle()||r.isFromSketchSplineControlPolygon())))return!1;if(this.viewer.getIsForFlattenedDisplay()){if(!r)return!1;const e=this.getSheetMetalModelId(i);if(!e||e!==this.viewer.getModelViewManagers().getManager().getSelectedSheetmetalModelId())return!1}return super.updateEntityHighlight(e,t,i,n)}hideShowFeature(e,t,i){var s,n;const r=this.featureVisibility[e]!==t;this.featureVisibility[e]=t;const a=this.sketchToSMModelIdMapping[e],o=this.viewer.getModelViewManagers().getManager();a&&o.hasSelectedSheetmetalModelId()&&a!==o.selectedSheetmetalModelId||(r&&(null===(n=null===(s=(0,up.PT)())||void 0===s?void 0:s.getInferenceSetController())||void 0===n||n.updateInferencingOnFeatureVisibilityChange(e,t)),this.hideShowFeatureEntities(e,t))}hideShowFeatureEntity(e,t,i){const s=this.idToMetaData[e];let n=i;!t&&s&&(s.isFromSketchSplineHandle()||s.isFromSketchSplineControlPolygon())&&(n=Js.EE.HIDDEN);const r=this.getOccurrenceIdForEntity(e);this.hideShowEntity(e,n,r),this.viewer.requestDraw()}hideShowFeatureEntities(e,t){const i=this.getEntitiesForFeature(e);if(!i)return;const s=this.activeSketches.hasOwnProperty(e);for(let e=0;e<i.length;++e)this.hideShowFeatureEntity(i[e],s,t)}showPartsWithSheetmetalModelIdOnly(e){for(const t of this.featureToIds.getKeys()){const i=this.activeSketches.hasOwnProperty(t),s=this.featureToIds.get(t);for(const n of s.getKeys()){const s=this.getSheetMetalModelId(n);s&&s===e?this.hideShowFeatureEntity(n,i,this.featureVisibility[t]):this.hideShowFeatureEntity(n,i,Js.EE.HIDDEN)}}}getFeatureIdForOccurrence(e){const t=this.occurrences[e];if(!t||!t.displayedSketchEntityIds)return null;for(const e of t.displayedSketchEntityIds){const t=this.idToMetaData[e];if(t)return t.getSketchFeatureId()}return null}getEntityTypesContainedWithinSketch(e){const t=new Set,i=this.featureToIds.get(e);return i?(i.each(((e,i)=>(t.add(this.idToMetaData[i].getEntityType()),t.has(W.ZSW.VERTEX)&&t.has(W.ZSW.EDGE)&&t.has(W.ZSW.FACE))),this),t.size>0&&t.add(W.ZSW.BODY),t):t}getComponentId(){return Zp}}const Kp=new Di.si;class jp extends Yp{constructor(e){super(null,Ls.L.BASE,(0,Q.as)(fT,e)),this.idManager=new Di.si,this.temporarySketchId=Kp.getId(),this.node=new ts(_I+this.temporarySketchId),this.meshManager=new zS((0,Q.as)(fT,e),{bufferAllocationPolicy:CI.MEDIUM}),this.entityIdManager=new vI.E,this.viewer.getSceneGraphs().getMainSceneGraph().getRootNode().addChild(this.node),this.viewer.getModelViewManagers().getManager().addTemporarySketchComponent(this),this.instantiateForPartStudio(this.node)}remove(){this.viewer.getModelViewManagers().getManager().removeTemporarySketchComponent(this),this.node.remove(),Kp.freeId(this.temporarySketchId),this.temporarySketchId=Di.JE,this.reset()}getUniqueId(){return this.temporarySketchId}addTemporaryEntity(e,t){const i=this.idManager.getId().toString(),s=new W.QsM;s.isAssociatedWithFlat=this.viewer.getIsForFlattenedDisplay(),this.idToPartData[i]=s,e.id=i,this.idToMetaData[i]=t,this.featureToIds.insertNested(this.temporarySketchId.toString(),i,!0),this.updateEntityGraphics(i,e,t)}updateTemporaryEntity(e,t,i){this.removeEntity(e);const s=new W.QsM;s.isAssociatedWithFlat=this.viewer.getIsForFlattenedDisplay(),this.idToPartData[e]=s,t.id=e,this.idToMetaData[e]=i,this.featureToIds.insertNested(this.temporarySketchId.toString(),e,!0),this.updateEntityGraphics(e,t,i)}reset(){super.reset(),this.idManager.reset(),this.entityIdManager.reset()}isEntityInActiveSketch(e){return!0}isSketchDisplayedAsActive(e,t){return!0}getNodeProperties(e,t,i){const s=super.getNodeProperties(e,t,i,HI(e));return s.isPickable=!1,s.includedInBlend=!1,s.updateId(),s}getEntityIdManager(){return this.entityIdManager}getMeshManager(){return this.meshManager}getSharedBaseMeshManager(){return null}getMeshOwnerId(){return"t"}updateEntityHighlight(e,t,i,s){return s===DI.KF&&(s=this.sketchComponentElementId),rg.prototype.updateEntityHighlight.call(this,e,t,i,s)}}var Qp=i(85075);const $p=q.default.getManager(),Jp=$p.getNumber("CONTROL_POINT_GRID_LINE_WIDTH"),em="controlPointGrid",tm=new Qi({primitiveType:_i.MX.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!1,isShowThrough:!1,isDepthTested:!0}),im=new Qi({primitiveType:_i.MX.LINES,isPickable:!1,isHighlightable:!1,isShowThrough:!0,isTwoSided:!0,isDepthTested:!1,isStencilTested:!0}),sm=$p.getStipple("CURVATURE_UV_TOOTH_STIPPLE");class nm extends Ri{constructor(e,t,i,s){super(s),this.edgeId=e,this.controlPointData=t,this.checkboxStates=i,this.id=em+"."+e,this.update()}onAppearanceConstantsUpdated(){this.update()}update(){if(this.isHidden)return;const e=[];if(this.checkboxStates[Qp.N.CPT_GRIDS]){const t=this.controlPointData.controlPoints;if(t.length){const i=t.length,s=t[0].length/3;for(let n=0;n<i;n++){const i=t[n];for(let t=1;t<s;t++)for(let s=t-1;s<=t;s++){const t=v.fromValues(i[3*s],i[3*s+1],i[3*s+2]);e.push(t)}}for(let n=0;n<s;n++)for(let s=1;s<i;s++)for(let i=s-1;i<=s;i++){const s=v.fromValues(t[i][3*n],t[i][3*n+1],t[i][3*n+2]);e.push(s)}}}const t=$p.getColor("CONTROL_POINT_GRID_COLOR"),i=Iu(e,void 0,t,Jp);this.updateMeshIncrement(em+".grid",yi,i,tm);const s=Iu(e,void 0,t,Jp,sm);this.updateMeshIncrement(em+".stippled",yi,s,im)}onCheckboxStatesUpdate(e){this.checkboxStates=e,this.update()}pointToVec3(e){return v.fromValues(e.x,e.y,e.z)}}var rm=i(19395),am=i(46823),om=i(89492);const hm=q.default.getManager(),cm="edgeCurvature",lm=new Qi({primitiveType:_i.MX.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!1,isShowThrough:!1,isDepthTested:!0}),um=new Qi({primitiveType:_i.MX.LINES,isPickable:!1,isHighlightable:!1,isShowThrough:!0,isTwoSided:!0,isDepthTested:!1,isStencilTested:!0}),dm=new Qi({primitiveType:_i.MX.POINTS,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!0,priority:Yi.HIGHEST}),gm=new Qi({primitiveType:_i.MX.TRIANGLES,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!0,priority:Yi.HIGHEST}),pm=hm.getStipple("CURVATURE_UV_TOOTH_STIPPLE"),mm=hm.getNumber("CURVATURE_TOOTH_LINE_WIDTH"),fm=hm.getNumber("CURVATURE_UV_TOOTH_LINE_WIDTH"),Im=hm.getNumber("CURVATURE_UV_ROOF_LINE_WIDTH"),Em=hm.getNumber("CURVATURE_ROOF_LINE_WIDTH"),Sm=hm.getStipple("CURVATURE_UV_ROOF_STIPPLE"),Tm=Math.pow(bi.W.MAX_MODEL_SIZE,2),Mm=hm.getNumber("INFLECTION_POINT_SIZE"),Cm=hm.getNumber("INFLECTION_TRIANGLE_HEIGHT_PX"),Dm=hm.getNumber("INFLECTION_TRIANGLE_WIDTH_PX");class vm extends Ri{constructor(e,t,i,s,n,r,a){super(r),this.edgeId=e,this.curvatureData=t,this.curvatureSize=i,this.checkboxStates=s,this.entityCurvatureWrapper=a,this.curvaturePower=n,this.id=cm+"."+e,this.listenTo(r.getEventDispatcher(),VM.Hq,this.onActiveSheetMetalModelChanged),this.update()}onAppearanceConstantsUpdated(){this.update()}update(){if(this.isHidden)return;const e=hm.getColor("CURVATURE_TOOTH_COLOR"),t=hm.getColor("CURVATURE_U_TOOTH_COLOR"),i=hm.getColor("CURVATURE_V_TOOTH_COLOR"),s=hm.getColor("CURVATURE_U_ROOF_COLOR"),n=hm.getColor("CURVATURE_V_ROOF_COLOR"),r=hm.getColor("CURVATURE_ROOF_COLOR"),a=[],o=[];let h;if(this.curvatureData&&this.checkboxStates[Qp.N.CURVATURE_COMBS]){const e=this.curvatureData.curvatures.length;for(let t=0;t<e;t++){const i=this.curvatureData.curvatures[t],s=this.curvatureData.positions[t],n=v.fromValues(s.x,s.y,s.z),r=this.curvatureData.normals[t],c=v.fromValues(r.x,r.y,r.z),l=this.curvatureSize*Math.pow(i,this.curvaturePower),u=pe.S4.add(n,pe.S4.scale(c,l,v.create()),v.create()),d=t%am.y.OVERSAMPLING_SCALE!=0,g=t===e-1&&t>0&&a.length>1&&v.equals(a[0],n)&&v.equals(a[1],u);Math.max(v.squaredLength(n),v.squaredLength(u))<Tm?(d||g||a.push(n,u),h&&o.push(h,u),h=u):h=void 0}}let c=e,l=mm,u=r,d=Em;this.entityCurvatureWrapper.isFaceCurvature()&&(c=this.entityCurvatureWrapper.isFaceUCurve()?t:i,l=fm,u=this.entityCurvatureWrapper.isFaceUCurve()?s:n,d=Im);const g=Iu(a,void 0,c,l);this.updateMeshIncrement(cm+".teeth",yi,g,lm);const p=Iu(a,void 0,c,l,pm);this.updateMeshIncrement(cm+".stippledTeeth",yi,p,um);const m=Iu(o,void 0,u,d);this.updateMeshIncrement(cm+".roof",yi,m,lm);const f=Iu(o,void 0,u,d,Sm);this.updateMeshIncrement(cm+".stippledroof",yi,f,um),this.updateInflectionPointIndicators(),this.updateMinimumRadiusOfCurvatureIndicator()}updateInflectionPointIndicators(){var e,t,i,s,n,r;if(!this.curvatureData||!this.curvatureData.inflectionPointPositions)return;const a=[],o=this.curvatureData.inflectionPointPositions.length,h=new Float32Array(15*o),c=new Float32Array(15*o),l=new Int32Array(6*o);if(this.checkboxStates[Qp.N.INFLECTION_POINTS]){if(this.curvatureData.inflectionPointPositions.length!==this.curvatureData.tangentsAtInflectionPoints.length)return;for(let u=0;u<o;u++){const o=this.curvatureData.inflectionPointPositions[u],d=v.fromValues(o.x,o.y,o.z);a.push(d);const g=this.curvatureData.tangentsAtInflectionPoints[u],p=v.fromValues(g.x,g.y,g.z),m=null===(t=null===(e=this.viewer)||void 0===e?void 0:e.getCamera())||void 0===t?void 0:t.getPixelSizeAtWorldPoint(d),f=null===(s=null===(i=this.viewer)||void 0===i?void 0:i.getCamera())||void 0===s?void 0:s.projectWorldPointToCanvas(d),I=(null===(r=null===(n=this.viewer)||void 0===n?void 0:n.getCamera())||void 0===r?void 0:r.getRay(f[0],f[1])).direction,E=pe.S4.cross(I,p,v.create());pe.S4.length(E)>bi.W.ZERO_LENGTH&&pe.S4.normalize(E);const S=pe.S4.cross(I,E,v.create()),T=pe.S4.scale(E,m*Cm,v.create()),M=pe.S4.scale(E,m*-Cm,v.create()),C=pe.S4.scale(S,m*-Dm/2,v.create()),D=pe.S4.scale(S,m*Dm/2,v.create()),P=[pe.S4.add(d,pe.S4.add(T,D,v.create()),v.create()),pe.S4.add(d,pe.S4.add(T,C,v.create()),v.create()),d,pe.S4.add(d,pe.S4.add(M,D,v.create()),v.create()),pe.S4.add(d,pe.S4.add(M,C,v.create()),v.create())],y=[0,1,2,3,4,2];for(let e=0;e<6;e++)5!==e&&(h.set(P[e],15*u+3*e),c.set(I,15*u+3*e)),l[6*u+e]=5*u+y[e]}}const u=new jE(_i.MX.TRIANGLES,h,l);u.normals=c;const d=hm.getColor("INFLECTION_POINT_COLOR");Uu(d,u),Hu(Mm,u),this.updateMeshIncrement(cm+".inflectionTriangles",yi,u,gm);const g=new Float32Array(3*a.length),p=new Int32Array(a.length);for(let e=0;e<a.length;++e){p[e]=e;for(let t=0;t<3;++t)g[3*e+t]=a[e][t]}const m=new jE(_i.MX.POINTS,g,p,void 0);Uu(d,m),Hu(Mm,m),this.updateMeshIncrement(cm+".inflectionPoint",yi,m,dm)}updateMinimumRadiusOfCurvatureIndicator(){if(this.checkboxStates[Qp.N.MINIMUM_RADIUS]&&this.curvatureData&&this.curvatureData.coordinateSystemOfCurvatureCircle){const e=this.curvatureData.coordinateSystemOfCurvatureCircle.getGlMatrix(),t=v.fromValues(e[12],e[13],e[14]),i=v.fromValues(e[8],e[9],e[10]),s=this.curvatureData.minimumRadiusOfCurvature,n=Cu(t,this.curvatureData.minimumRadiusOfCurvature,i,100);Uu(hm.getColor("RADIUS_OF_CURVATURE_CIRCLE_COLOR"),n),Hu(Em,n),this.updateMeshIncrement(cm+".radius",yi,n,lm);const r=new om.l;r.id="fakeDimensionId",r.featureId="fakeSketchId",r.parameterId="length",r.value=this.curvatureData.minimumRadiusOfCurvature,r.coordinateSystem.m00=1,r.coordinateSystem.m01=0,r.coordinateSystem.m10=0,r.coordinateSystem.m11=1,r.coordinateSystem.m02=0,r.coordinateSystem.m12=0,r.coordinateSystem.m22=1;const a=-Math.PI,o=this.curvatureData.minimumRadiusOfCurvature/2,h=-Math.PI,c=h;r.positionR=o,r.positionT=a,r.witnessEndPoint0r=s,r.witnessEndPoint0t=h,r.witnessEndPoint1r=s,r.witnessEndPoint1t=c,r.planeMatrix=this.curvatureData.coordinateSystemOfCurvatureCircle,r.radiusDisplay=rm.M.RADIAL,r.isDriven=!0,this.diameterGraphics||(this.diameterGraphics=new hE.nl(this.viewer,!0)),this.diameterGraphics.updateFromDisplayData(r)}else this.removeMeshIncrement(cm+".radius"),this.diameterGraphics&&(this.diameterGraphics.remove(),this.diameterGraphics=null)}updateSizeAndPower(e,t){this.curvatureSize===e&&this.curvaturePower===t||(this.curvatureSize=e,this.curvaturePower=t,this.update())}show(){super.show(),this.diameterGraphics&&this.diameterGraphics.show(),this.update()}hide(){super.hide(),this.diameterGraphics&&this.diameterGraphics.hide()}remove(){super.remove(),this.diameterGraphics&&this.diameterGraphics.remove()}getFitBounds(){return this.getInstantiatedMeshIncrement(cm+".teeth").meshIncrement.getBounds()}onViewWillDraw(e,t){this.updateInflectionPointIndicators()}onActiveSheetMetalModelChanged(e){this.curvatureData.ownerBodySheetMetalModelId&&(this.curvatureData.ownerBodySheetMetalModelId!==e?this.hide():this.show())}onCheckboxStatesUpdate(e){this.checkboxStates=e,this.update()}}const Pm=q.default.getManager(),ym="dihedralComb",Am=ym+".low",Om=ym+".mid",Rm=ym+".high",wm=ym+".zeropoint",_m=Pm.getNumber("DIHEDRAL_TOOTH_LINE_WIDTH"),Nm=Pm.getNumber("DIHEDRAL_ZERO_POINT_SIZE"),bm=Pm.getStipple("DIHEDRAL_TOOTH_STIPPLE"),Lm=new Qi({primitiveType:_i.MX.POINTS,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!0,priority:Yi.HIGHEST}),Fm=new Qi({primitiveType:_i.MX.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!1,isShowThrough:!1,isDepthTested:!0}),xm=new Qi({primitiveType:_i.MX.LINES,isPickable:!1,isHighlightable:!1,isShowThrough:!0,isTwoSided:!0,isDepthTested:!1,isStencilTested:!0});class Bm extends Ri{constructor(e,t,i,s,n,r,a,o){super(o),this.edgeId=e,this.dihedralData=t,this.scale=i,this.coefficient=s,this.lowRadians=n,this.highRadians=r,this.useThresholdDisplay=a,this.id=ym+"."+e,this.update()}onAppearanceConstantsUpdated(){this.update()}update(){if(this.isHidden)return;const e=Pm.getColor("DIHEDRAL_HIGH_THRESHOLD_COLOR"),t=Pm.getColor("DIHEDRAL_MID_THRESHOLD_COLOR"),i=Pm.getColor("DIHEDRAL_LOW_THRESHOLD_COLOR"),s=this.createAndSortLineData();this.updateLines(s.lowLines,i,this.id+Am),this.updateLines(s.midLines,t,this.id+Om),this.updateLines(s.highLines,e,this.id+Rm),this.updatePoints(s.points)}updatePoints(e){const t=Pm.getColor("DIHEDRAL_HIGH_THRESHOLD_COLOR"),i=Pm.getColor("DIHEDRAL_MID_THRESHOLD_COLOR"),s=Pm.getColor("DIHEDRAL_LOW_THRESHOLD_COLOR"),n=new Float32Array(3*e.length),r=new Int32Array(e.length);for(let t=0;t<e.length;++t){r[t]=t;const i=e[t];for(let e=0;e<3;e++)n[3*t+e]=i[e]}let a=i;this.useThresholdDisplay&&(0<=this.lowRadians?a=s:0>=this.highRadians&&(a=t));const o=new jE(_i.MX.POINTS,n,r,void 0);Uu(a,o),Hu(Nm,o),this.updateMeshIncrement(this.id+wm,yi,o,Lm)}updateLines(e,t,i){const s=Iu(e,void 0,t,_m);this.updateMeshIncrement(i,yi,s,Fm);const n=Iu(e,void 0,t,_m,bm);this.updateMeshIncrement(i+".stipple",yi,n,xm)}getFitBounds(){const e=this.getInstantiatedMeshIncrement(this.id+Am).meshIncrement.getBounds(),t=this.getInstantiatedMeshIncrement(this.id+Om).meshIncrement.getBounds(),i=this.getInstantiatedMeshIncrement(this.id+Rm).meshIncrement.getBounds();return e.addBox(t),e.addBox(i),e}setScale(e){this.scale=e}setCoefficient(e){this.coefficient=e}setThresholdValues(e,t){this.lowRadians=e,this.highRadians=t}setUseThresholdDisplay(e){this.useThresholdDisplay=e}static getComb(e,t,i){const s=e.position.getVec3(),n=e.direction.getVec3(),r=(0,Ic.round)(e.magnitudeRadians,5),a=t*i*r;return[s,v.scaleAndAdd(v.create(),s,n,a),r]}createAndSortLineData(){const e=[],t=[],i=[],s=[],n=this.dihedralData.dihedrals;for(let r=0;r<n.length;r++){const[a,o,h]=Bm.getComb(n[r],this.scale,this.coefficient);Math.abs(h)<Bm.NEAR_ZERO_RADIAN_THRESHOLD?s.push(a):this.sortCombToArrays(h,a,o,t,e,i)}return{lowLines:t,midLines:e,highLines:i,points:s}}sortCombToArrays(e,t,i,s,n,r){this.useThresholdDisplay?Math.abs(e)<Math.abs(this.lowRadians)?s.push(t,i):Math.abs(e)>Math.abs(this.highRadians)?r.push(t,i):n.push(t,i):n.push(t,i)}}Bm.NEAR_ZERO_RADIAN_THRESHOLD=Math.PI/180*.05;const Um=q.default.getManager();class Vm extends Ri{constructor(e,t,i,s,n,r){super(r),this.id="dihedralExtrema."+e,this.dihedral=t,this.scale=i,this.coefficient=s,this.text=n,this.needsUpdating=!0,this.update()}onAppearanceConstantsUpdated(){this.needsUpdating=!0,this.update()}update(){var e;if(this.isHidden||!this.needsUpdating)return;this.textHeightPx=Um.getNumber("DIMENSION_VALUE_HEIGHT_PIXELS"),this.font=Um.getString("DIMENSION_VALUE_FONT"),this.color=Um.getColor("DIMENSION_VALUE_TEXT_COLOR"),null===(e=this.textDisplay)||void 0===e||e.remove();const[t,i,s]=Bm.getComb(this.dihedral,this.scale,this.coefficient),n=Math.abs(s)<Bm.NEAR_ZERO_RADIAN_THRESHOLD?t:i;this.textDisplay=new ba({origin:n,heightPx:this.textHeightPx,color:this.color,font:this.font,orientToScreen:!0,offsetRight:Li.iK.MID,offsetUp:Li.iK.LOW},this.viewer),this.textDisplay.setText(this.text),this.needsUpdating=!1}remove(){super.remove(),this.textDisplay.remove()}setScaleAndCoefficient(e,t){this.scale=e,this.coefficient=t,this.needsUpdating=!0}setString(e){this.text=e,this.needsUpdating=!0}}const Gm=W.ZIP.VIRIDIS,Hm="simulation-legend-canvas-controls";class km extends dc{constructor(){super(...arguments),this.LEGEND_MAXIMUM_CLICKED=VM.Jm,this.LEGEND_MINIMUM_CLICKED=VM.xy,this.LEGEND_RANGE_CHANGED=VM.pj,this.CANVAS_CONTROLS_PANEL_ID=Hm}updateGraphics(){void 0!==this.visualizedFieldType&&super.updateGraphics()}get SNAPPING_MARGIN_TOP(){return q.default.getManager().getNumber("SIMULATION_TOP_TOOLBAR_HEIGHT_PX")}}var Wm=i(91334);const zm=[0,.125,.25,.375,.5,.625,.75,.875,.92,1,1,1,1,1,.9,.5,.2,0,-.1,-.11,-.05,0,.02,.02,.01,0,-.01,0,0,0,0,0];class Xm extends pc{constructor(e){super(e),this.modelViewManager=e,this.COLOR_MAP_STORAGE_KEY=Wm.S,this.LEGEND_CLOSED=Ms.Ipz,this.LEGEND_OPENED=Ms.PXv,this.VISUALIZATION_MANAGER_NODE_ID="SimulationManager",this.graphicsRenderMode=W.P1.SIMULATION_RESULTS,this.meshOwnerId=WS(),this.tessellationCache=new Map,this.occurrenceToMaterial=new Map,this.isAnimating=!1,this.elementIdToResponseData=new Map,this.scalarVisualizationOccurrences=[],this.simulationMass=0,ps.Jq.SimulationService&&ps.Jq.SimulationService.getIsAnimatingObservable().subscribe((e=>{e?this.startAnimation():this.stopAnimation()})),this.connectionVisualizationManager=new xh(ps.Jq.AnalyticsService,e,this)}prepareResources(){super.prepareResources(),this.legend||(this.legend=new km(this))}clearScalarVisualizationStatusForOccurrences(e){const t=this.getViewer().getOccurrenceIdManager();for(const i of e){const e=W._oC.getOccurrenceFromPathString(i),s=t.getIdForName(i);if(s===DI.Qy){It.log.warn("No occurrence id for "+i);continue}const n=this.modelViewManager.getPartStudioDataFromOccurrence(e);n?n.getBodyComponent().clearScalarVisualizationOccurrence(s):It.log.debug("No part studio for occurrence "+i)}}get displayedSimulatedField(){return this.visualizationState?this.visualizationState.field:null}hasDisplayableFieldSet(){return!!this.displayedSimulatedField&&this.displayedSimulatedField.type!==W.DDL.UNKNOWN}readyToShowLegend(){return this.viewerIsInScalarVisualizationRenderMode()&&this.hasDisplayableFieldSet()&&this.visualizationState&&!this.visualizationState.connectionVisualizationActive}setVisualizationState(e){const t=new mh.B7("SimulationManager.setVisualizationState",{setTraceId:!0}),i=!this.visualizationState||!(0,an.Z)(this.visualizationState.connectionTypeToHidden,e.connectionTypeToHidden),s=!this.visualizationState||this.visualizationState.restInDeformedState!==e.restInDeformedState,n=!this.visualizationState||this.visualizationState.deformationScale!==e.deformationScale;super.setVisualizationState(e),this.connectionVisualizationManager.setVisible(this.visualizationState.connectionVisualizationActive),i&&this.connectionVisualizationManager.updateGraphics(),this.hasDisplayableFieldSet()&&!this.visualizationState.connectionVisualizationActive||this.hideLegend(),!s&&!n||this.isAnimating||this.resetSimulationOffsetFactor(),t.report()}setContactBehavior(e){this.connectionVisualizationManager.setContactBehavior(e)}getSimulationBounds(){var e;if(!this.rootNode)return null;let t=this.rootNode.getBoundingBox();if(this.isAnimating||(null===(e=this.visualizationState)||void 0===e?void 0:e.restInDeformedState)){t=t.clone();const e=this.inputDisplacementRange.max>bi.W.ZERO_LENGTH?.001*this.inputDisplacementRange.max:0,i=1e3;t.dilate(Math.min(e,i))}return t}hasSimulationResultsForElement(e){return this.elementIdToResponseData.has(e)}updateSimulation(e){const t=new mh.B7("SimulationManager.updateSimulation",{setTraceId:!0});this.prepareResources();for(const t of e.simulationTessellations)this.tessellationCache.set(this.getTessellationCacheKey(t.sourceElement,t.deterministicId),t);for(const t in e.occurrenceToMaterial)this.occurrenceToMaterial.set(t,e.occurrenceToMaterial[t]);let i=!1,s=null;if(e.activeSimulationUpdates.length>0){if(s=e.activeSimulationUpdates[0].runStatus,s===W.zgQ.JUST_STARTED||s===W.zgQ.INVALID_ASSEMBLY)return this.clearGraphics(),s===W.zgQ.JUST_STARTED&&this.elementIdToResponseData.delete(e.sourceElementId),void(this.legend&&(this.legend.clearRanges(),this.showLegend()))}const n=e.responses[0];if(n)this.elementIdToResponseData.set(e.sourceElementId,n),i=!0;else{const e=this.modelViewManager.getDisplayedAssembly();e&&s===W.zgQ.TRANSMITTED&&this.elementIdToResponseData.has(e.elementId)&&(i=!0)}i&&(this.prepareField(this.displayedSimulatedField),this.updateGraphics()),t.report()}updateContactAnalysis(e){this.connectionVisualizationManager.updateContactAnalysis(e)}getVisualizationState(){return this.visualizationState}isIsolateEffectActive(){return this.connectionVisualizationManager.getVisible()&&this.connectionVisualizationManager.getUseIsolateEffect()}onRenderingModeChanged(){super.onRenderingModeChanged();this.viewerIsInScalarVisualizationRenderMode()&&this.getViewer().setUserEnabledAggressiveRefinement(!1)}resetMeshes(){this.meshManager&&this.meshManager.destroy(),this.meshManager=new zS(this.getViewer(),{bufferAllocationPolicy:CI.MAXIMUM})}onAssemblyDisplayed(){this.updateGraphics(),this.connectionVisualizationManager.updateGraphics()}onAssemblyChanged(){this.connectionVisualizationManager.onAssemblyChanged()}onSectionSetChanged(){this.connectionVisualizationManager.onSectionSetChanged()}onDocumentChange(){this.tessellationCache.clear(),this.elementIdToResponseData.clear()}updateGraphics(){var e;this.clearGraphics();const t=this.modelViewManager.getDisplayedAssembly();if(!t||t.isHidden||this.visualizationState&&this.visualizationState.connectionVisualizationActive)return;this.showLegend();const i=this.elementIdToResponseData.get(t.elementId);if(!i)return void(this.legend&&this.legend.clearRanges());const s=this.getViewer().getOccurrenceIdManager(),n=this.getViewer().getOccurrenceDataManager(),r=i.firstResultDataSet;if(!r)return void It.log.debug("No data set to display");if(!this.visualizationState||r.isModal!==this.visualizationState.field.isModal||!this.hasDisplayableFieldSet())return;if(!this.viewerIsInScalarVisualizationRenderMode())return;if(!r.canBeUsedToDisplay(this.displayedSimulatedField))return;this.displayedScalarRangeSpecification=r.getRangeSpecification(this.displayedSimulatedField),this.inputDisplacementRange=r.getRangeSpecification(null===(e=this.displayedSimulatedField)||void 0===e?void 0:e.displacementFieldSpecification).rangeInData;const a=[];for(let e=0;e<Xm.imageMaps.length;++e){const t=new Qi({material:this.scalarVisualizationMaterials[e],zOffset:q.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:_i.MX.TRIANGLES,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1});a.push(t)}let o=!1;this.simulationMass=0;for(const e in r.occurrenceIdToOccurrenceResult){const i=r.occurrenceIdToOccurrenceResult[e],h=W._oC.getOccurrenceFromPathString(e),c=s.getIdForName(e);if(c===DI.Qy){It.log.warn("No occurrence id for "+e);continue}const l=n.getOccurrenceData(c);l||It.log.warn("No occurrence data for "+e);const u=t.getOccurrenceDisplayData(h);if(!u){It.log.warn("No occurrence display data for "+e);continue}const d=this.modelViewManager.getPartStudioDataFromOccurrence(h);if(!d){It.log.debug("No part studio for occurrence "+e);continue}const g=i.getFieldForDisplay(this.displayedSimulatedField);if(!g)continue;if(g.isDisabled){d.getBodyComponent().clearScalarVisualizationOccurrence(c);continue}const p=this.getMeshIncrementForOccurrence(i,u);if(!p){It.log.debug("No simulation tessellation for "+e),o=!0;break}this.updateMass(i),d.getBodyComponent().setScalarVisualizationOccurrence(c),p.id=e;const m=this.meshManager.addMeshIncrement(p,this.meshOwnerId),f=new BS("Simulated "+e);f.onIncrementAdded(m);const I=d.retrieveBodyMetaData(u.partIds[0]),E=new fE;I&&E.setAttribute(Jd.COLOR,I.getColor());for(let e=0;e<a.length;++e)this.nodes[e].addOccurrenceGeometryToNode(a[e],l,E,f);if(this.debugMeshEdges){const t=lu(p,p.id+".edges"),i=this.meshManager.addMeshIncrement(t,this.meshOwnerId),s=new BS("Simulated "+e+" edges");s.onIncrementAdded(i);for(let e=0;e<a.length;++e)this.nodes[e].addOccurrenceGeometryToNode(Ap,l,E,s)}this.scalarVisualizationOccurrences.push(e)}if(o)return this.clearGraphics(),void(r.isModal&&this.getViewer().getEventDispatcher().trigger(Ms.R1N,!1,r));this.cursorAppendage=new Ts(this.getViewer(),((e,t)=>this.getCursorText(e,t))),this.legend.setInputRange(this.displayedScalarRangeSpecification),this.visualizedScalarRange&&this.legend.setVisualizedScalarRange(this.visualizedScalarRange),this.updateColorMapping(null,this.displayedColorMap),this.updateMakeUnsignedUniform(),this.getViewer().getEventDispatcher().trigger(Ms.R1N,!0,r),this.getViewer().requestDraw()}updateMass(e){var t;const i=null===(t=this.getTessellationForOccurrenceResult(e))||void 0===t?void 0:t.massProperties;i&&i.hasMass&&(this.simulationMass+=i.mass[0])}clearGraphics(){this.getViewer().getEventDispatcher().trigger(Ms.R1N,!1),this.resetMeshes(),this.clearScalarVisualizationStatusForOccurrences(this.scalarVisualizationOccurrences),this.scalarVisualizationOccurrences=[],super.clearGraphics()}clearSimulationAndConnectionGraphics(){this.clearGraphics(),this.connectionVisualizationManager.clearGraphics()}prepareField(e){const t=this.getDisplayedResults();t&&e&&e.type===W.DDL.SAFETY_FACTOR&&t.prepareSafetyFactor(((e,t)=>{let i=this.occurrenceToMaterial.get(e);if(!i){const e=this.getTessellationForOccurrenceResult(t);e&&(i=e.material)}return i}))}startAnimation(){if(this.isAnimating)return;this.isAnimating=!0;const e=q.default.getManager().getNumber("SIMULATION_DISPLACEMENT_ANIMATION_CYCLE_PERIOD_SEC");let t=-1,i=0;this.getViewer().getAnimationController().startAnimation((s=>{var n;if(!this.isAnimating)return Ms.ZK6.COMPLETE;if(t>0){i+=(s-t)/1e3/e;const r=(null===(n=this.displayedSimulatedField)||void 0===n?void 0:n.isModal)?this.getModalOffsetFactor(i):this.getDisplacementOffsetFactor(i);this.setSimulationOffsetFactor(r)}return t=s,Ms.ZK6.ONGOING}))}updateVisualizedScalarRange(){this.legend&&(this.legend.visualizedFieldType=this.visualizationState.field.type),super.updateVisualizedScalarRange()}stopAnimation(){this.isAnimating&&(this.isAnimating=!1,this.resetSimulationOffsetFactor(),this.getViewer().requestDraw())}resetSimulationOffsetFactor(){var e;(null===(e=this.visualizationState)||void 0===e?void 0:e.restInDeformedState)?this.setSimulationOffsetFactor(1):this.setSimulationOffsetFactor(0),this.getViewer().requestDraw()}setSimulationOffsetFactor(e){for(const t of this.scalarVisualizationMaterials)t.setCustomFloatUniform("uOffsetFactor",e*this.visualizationState.deformationScale*.001)}getRangeInBaseUnits(e){var t;return e?(null===(t=this.displayedSimulatedField)||void 0===t?void 0:t.hasUnits)?this.displayedSimulatedField.isStress?(0,Er.vM)(e,W.L_A.BASE_UNITS):(0,Er.vM)(e,W.jvX.BASE_UNITS):e:null}updateMakeUnsignedUniform(){let e=Mf;if(this.visualizationState.field.type===W.DDL.UNSIGNED_VON_MISES_STRESS){const t=this.getDisplayedResults();if(!t)return;const i=t.getAvailableFields();i.has(W.DDL.SIGNED_VON_MISES_STRESS)&&!i.has(W.DDL.UNSIGNED_VON_MISES_STRESS)&&(e=Tf)}for(const t of this.scalarVisualizationMaterials)t.setCustomIntUniform("uMakeUnsigned",e)}getDisplayedResults(){const e=this.modelViewManager.getDisplayedAssembly();if(!e)return null;const t=this.elementIdToResponseData.get(e.elementId);return t?t.firstResultDataSet:null}setDebugMeshEdges(e){this.debugMeshEdges=e}getTessellationForOccurrenceResult(e){return this.tessellationCache.get(this.getTessellationCacheKey(e.sourcePartReference,e.sourcePartReference.partId))}getMeshIncrementForOccurrence(e,t){var i;const s=this.getTessellationForOccurrenceResult(e);if(!s)return null;let n=e.getFieldForDisplay(this.displayedSimulatedField);if(!n)return null;let r=e.getFieldForDisplay(null===(i=this.displayedSimulatedField)||void 0===i?void 0:i.displacementFieldSpecification);if(!r)return null;if(n instanceof W.aj8){const e=1e3*this.visualizationState.field.directDeformationInMeters,t=n.getScaledCopy(e);n=t,r=t}const a=this.getSampleMesh(s,e),o=new jE(_i.MX.TRIANGLES,a.points,a.getAnyIndices());n.isDisabled||o.packScalarsIntoTextureCoordinates(n.values);const h=this.modelViewManager.getPartStudio(e.sourcePartReference);if(h){const e=h.getBodyBounds(s.deterministicId,t.occurrenceData.occurrence);e&&(o.boundingBox=e)}return r instanceof W.jvX?o.offsetVectors=(0,Li.w5)(r.packedOffsetDirections,r.values):It.log.warn("Unexpected displacement field type"),o}findScalarVisualizationScalar(e,t){var i,s,n;const r=super.findScalarVisualizationScalar(e,t);if(null===r)return null;if(null===(i=this.displayedSimulatedField)||void 0===i?void 0:i.hasUnits){const e=(0,Ir.vx)().getUnitForSimulatedField(null===(s=this.displayedSimulatedField)||void 0===s?void 0:s.type);return(0,Er.WR)(r,null===(n=this.getRangeInData())||void 0===n?void 0:n.units,e)}return r}getTessellationCacheKey(e,t){return e.toString()+"."+t}getModalOffsetFactor(e){const t=e*Math.PI*2;return Math.sin(t)}getDisplacementOffsetFactor(e){return(0,Li.HO)(zm,e)}getValueString(e){return gc.c.getSimulationValueString(e)}getMass(){return this.simulationMass}}var qm=i(37739);class Zm extends dc{constructor(e){super(e),this.manager=e,this.LEGEND_MAXIMUM_CLICKED=VM.vk,this.LEGEND_MINIMUM_CLICKED=VM.YW,this.LEGEND_RANGE_CHANGED=VM.WB,this.CANVAS_CONTROLS_PANEL_ID=Ms.LIN}updateGraphics(){void 0!==this.visualizedFieldType&&super.updateGraphics()}getInputRangeInDisplayUnits(){return this.manager.getRangeInDisplayUnits(this.manager.getRangeInData())}getDefaultDisplayRangeInDisplayUnits(){return this.manager.getRangeInDisplayUnits(this.manager.getDefaultDisplayRange())}get SNAPPING_MARGIN_TOP(){return q.default.getManager().getNumber("THICKNESS_ANALYSIS_TOP_TOOLBAR_HEIGHT_PX")}isInputMinimumChanged(){return!!W.ZX_.isGradientField(this.visualizedFieldType)||super.isInputMinimumChanged()}requiresHighlightGraphics(){return this.manager.getUseMinValueHighlight()||this.manager.getUseMaxValueHighlight()||this.manager.getUseDimColorScale()}}var Ym=i(11990),Km=i(86431);const jm=1e-5,Qm=[W.NSu.PREPROCESSING,W.NSu.QUEUED,W.NSu.WORKING,W.NSu.POSTPROCESSING,W.NSu.COMPLETE],$m=new Map(Qm.map(((e,t)=>[e,t])));function Jm(e){var t;return null!==(t=$m.get(e))&&void 0!==t?t:Number.POSITIVE_INFINITY}var ef;!function(e){e[e.LENGTH=0]="LENGTH",e[e.UNITLESS=1]="UNITLESS"}(ef||(ef={}));const tf=new Map([[W.DDL.ROLLING_BALL_THICKNESS,ef.LENGTH],[W.DDL.RAY_THICKNESS,ef.LENGTH],[W.DDL.ROLLING_BALL_THICKNESS_DERIVATIVE,ef.UNITLESS],[W.DDL.RAY_THICKNESS_DERIVATIVE,ef.UNITLESS]]);class sf extends pc{constructor(e){super(e),this.COLOR_MAP_STORAGE_KEY=qm.d0,this.LEGEND_CLOSED=VM.aI,this.LEGEND_OPENED=VM.Cv,this.VISUALIZATION_MANAGER_NODE_ID="ThicknessAnalysisManager",this.graphicsRenderMode=W.P1.THICKNESS_ANALYSIS_VISUALIZATION,this.isEnabledInternal=!1,this.resultsCache=new Map,this.meshOwnerId=WS(),this.visualizedField=null,this.fieldTypeToVisualizationState=new Map,this.analyzedElementId=null,this.savedSelectedBodies=[],this.isEnabledSubject=new Fs.x,this.bodyFilter=null,this.isLastUsagePreview=!1,this.displayedScalarRangeSpecification={rangeInData:null,defaultDisplayRange:null},(0,Ms.eRd)(Ms.CrY).subscribe((()=>this.updateVisualizedScalarRange()))}getVisualizationStateForField(e){var t;return null!==(t=this.fieldTypeToVisualizationState.get(e))&&void 0!==t?t:null}initializeFieldType(e){const t=new W.ZX_,i=new W.dGY;i.addUnits(this.getBaseUnitsForField(e)),t.visualizedRange=i,t.displayedField=e,t.colorMapping=this.getStoredColorMapping();const s=this.computeDefaultFieldRange(e);this.fieldTypeToVisualizationState.set(e,{visualizationState:t,defaultRange:{rangeInData:s,defaultDisplayRange:s}})}initializeFieldTypes(){for(const e of sf.ENABLED_FIELD_TYPES)this.initializeFieldType(e)}updateVisualizationState(){const e=this.getVisualizationStateForField(this.visualizedField);if(!e)return;const t=this.visualizationState;if(t){const i=t.displayedField;this.fieldTypeToVisualizationState.get(i).visualizationState=t,e.visualizationState.colorMapping=t.colorMapping}this.setVisualizationState(e.visualizationState)}setVisualizationState(e){const t=this.getVisualizationStateForField(e.displayedField),{defaultRange:i}=t;this.displayedScalarRangeSpecification.rangeInData=i.rangeInData,this.displayedScalarRangeSpecification.defaultDisplayRange=i.defaultDisplayRange,this.legend&&(this.legend.visualizedFieldType=e.displayedField,this.legend.setInputRange(this.displayedScalarRangeSpecification)),super.setVisualizationState(e)}resetMeshes(){var e;null===(e=this.meshManager)||void 0===e||e.destroy(),this.meshManager=new zS(this.getViewer(),{bufferAllocationPolicy:CI.MAXIMUM})}prepareResources(){super.prepareResources(),this.initializeFieldTypes(),null===this.visualizedField&&this.setVisualizedField(W.DDL.ROLLING_BALL_THICKNESS),this.legend||(this.legend=new Zm(this))}setVisualizedField(e){e!==this.visualizedField&&(this.visualizedField=e,this.updateVisualizationState())}convertRadiiToDiameters(e){const t=e.clone();for(const e of t.result.fields){e.minValue*=2,e.maxValue*=2;for(let t=0;t<e.values.length;t+=1)e.values[t]*=2}return t}onUpdate(e){for(const t of e.results){const e=this.convertRadiiToDiameters(t);this.resultsCache.set(t.bodyDeterministicId,e)}this.updateFieldRanges(),this.updateVisualizationState()}getOverallStatus(){let e=Number.POSITIVE_INFINITY;for(const t of this.resultsCache.values())e=Math.min(e,Jm(t.status));return function(e){var t;return null!==(t=Qm[e])&&void 0!==t?t:W.NSu.UNKNOWN}(e)}resetState(){this.initializeFieldTypes(),this.resetMeshes(),this.clearScalarVisualizationForVisualizedBodies(),this.resultsCache.clear(),this.updateGraphics()}enable(){if(this.isEnabledInternal)return;this.isEnabledInternal=!0,this.resetState();const e=this.getViewer();e.setRenderingMode(this.graphicsRenderMode),e.setUserEnabledAggressiveRefinement(!1),this.isEnabledSubject.next(this.isEnabledInternal)}disable(){ps.Jq.UserSettingsService.getUserSettings().then((e=>{if(!this.viewerIsInScalarVisualizationRenderMode())return;const t=Number(e.graphicsRenderMode);this.getViewer().setRenderingMode(t)})),this.isEnabledInternal&&(this.isEnabledInternal=!1,this.analyzedElementId=null,this.savedSelectedBodies=[],this.resetState(),this.isEnabledSubject.next(this.isEnabledInternal))}isEnabled(){return this.isEnabledInternal}getNodeProperties(){return sf.imageMaps.map(((e,t)=>new Qi({material:this.scalarVisualizationMaterials[t],zOffset:q.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:_i.MX.TRIANGLES,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1})))}getCurrentVisualizedField(e){return e.getFieldOfType(this.visualizationState.displayedField)}computeDefaultFieldRange(e){const t=this.getBaseUnitsForField(e);let i=null;this.getBaseUnitsForField(e);for(const s of this.resultsCache.values()){const n=s.getFieldOfType(e);if(!n)continue;const r=W.dGY.fromMinMax(n.minValue,n.maxValue);r.addUnits(t),i=W.dGY.combine(i,r)}return(null==i?void 0:i.noRange)&&(i.min-=jm,i.max+=jm),i}updateFieldRanges(){var e;for(const t of sf.ENABLED_FIELD_TYPES){const i=this.computeDefaultFieldRange(t);if(!i||!Number.isFinite(i.min))continue;const s=this.getVisualizationStateForField(t);if(!s)continue;const{defaultRange:n,visualizationState:r}=s;n.rangeInData=i,n.defaultDisplayRange=i,null===this.getBaseUnitsForField(t)&&(n.defaultDisplayRange=W.dGY.fromMinMax(0,5)),(null===(e=r.visualizedRange)||void 0===e?void 0:e.noRange)&&(r.visualizedRange=n.defaultDisplayRange)}const t=this.getRangeInData();this.updateDefaultDisplayRange(t),t&&this.setVisualizedRange(t),this.legend.visualizedFieldType=this.visualizationState.displayedField,this.updateVisualizedScalarRange()}shouldVisualizeBody(e,t){return!!e&&!!e.isSolidBody()}getMeshIncrementForBody(e,t){const i=this.getCurrentVisualizedField(e),{sampleMesh:s}=e,n=new jE(_i.MX.TRIANGLES,s.points,s.getAnyIndices());return n.packScalarsIntoTextureCoordinates(i.values),n.id=t.getId(),n}getBodyComponent(){var e,t;return null===(t=null===(e=this.modelViewManager)||void 0===e?void 0:e.getDisplayedPartStudio())||void 0===t?void 0:t.getBodyComponent()}clearScalarVisualizationForVisualizedBodies(){const e=this.getBodyComponent();e&&e.clearAllScalarVisualizationOccurrences()}updateGraphicsForBody(e,t,i){if(!i.isComplete)return;const s=i.bodyDeterministicId,n=e.getBodyOccurrenceData(s);if(!n)return;const r=n.getOccurrenceId(),a=e.retrieveBodyMetaData(s);if(!this.shouldVisualizeBody(a,n))return;const o=this.getMeshIncrementForBody(i,a),h=this.meshManager.addMeshIncrement(o,this.meshOwnerId),c=new BS(this.VISUALIZATION_MANAGER_NODE_ID+" "+r);c.onIncrementAdded(h);const l=new fE;a&&l.setAttribute(Jd.COLOR,a.getColor());for(let e=0;e<t.length&&e<this.nodes.length;++e)this.nodes[e].addOccurrenceGeometryToNode(t[e],n,l,c);e.setScalarVisualizationOccurrence(r,a.getId())}clearGraphics(){this.clearScalarVisualizationForVisualizedBodies(),this.resetMeshes(),super.clearGraphics()}updateGraphics(){if(this.clearGraphics(),!this.isEnabled())return;if(!this.viewerIsInScalarVisualizationRenderMode())return;if(this.getViewer().getActiveElementId()!==this.analyzedElementId)return;if(this.isLastUsagePreview)return;const e=this.getNodeProperties(),t=this.getBodyComponent();if(t&&0!==this.resultsCache.size){this.cursorAppendage||(this.cursorAppendage=new Ts(this.getViewer(),((e,t)=>this.getCursorText(e,t))));for(const i of this.resultsCache.values())i&&i.isComplete&&(i.result.fields.length<1||this.updateGraphicsForBody(t,e,i));this.updateColorMapping(null,this.displayedColorMap),this.getViewer().requestDraw()}}getCurrentMicroversionIdAndConfiguration(){return this.modelViewManager.getDisplayedElementMicroversionIdAndConfiguration()}onPartStudioDisplayDataChanged(e){if(!e.isNoop&&this.viewerIsInScalarVisualizationRenderMode())return e.usage!==W.rvN.BASE?(this.clearGraphics(),void(this.isLastUsagePreview=!0)):void((this.isLastUsagePreview||e.hasPartGeometryChanges())&&(this.isLastUsagePreview=!1,this.updateSavedSelections(e.elementId),this.reactivate(e.elementId)))}updateSavedSelections(e){if(e!==this.analyzedElementId)return;Ym.L.getPartList(e)&&(this.savedSelectedBodies=this.savedSelectedBodies.filter((e=>{const t=e.selectionId;return"string"==typeof t&&(!!this.getBodyFilter().filter(e)||(this.resultsCache.delete(t),!1))})))}readyToShowLegend(){return!!this.legend&&(!!this.viewerIsInScalarVisualizationRenderMode()&&(this.getViewer().getActiveElementId()===this.analyzedElementId&&(0!==this.resultsCache.size&&this.getOverallStatus()===W.NSu.COMPLETE)))}getBaseUnitsForField(e){switch(tf.get(e)){case ef.LENGTH:return Er.ML.MILLIMETER;case ef.UNITLESS:return null}}getCurrentBaseUnits(){return this.getBaseUnitsForField(this.visualizedField)}getDisplayUnitsForField(e){switch(tf.get(e)){case ef.LENGTH:return(0,Ir.vx)().getLengthUnits();case ef.UNITLESS:return null}}getCurrentDisplayUnits(){return this.getDisplayUnitsForField(this.visualizedField)}convertRangeToUnits(e,t){return t?(0,Er.vM)(e,t):W.dGY.fromMinMax(100*e.min,100*e.max)}getRangeInDisplayUnits(e){const t=this.getCurrentDisplayUnits();if(!e)return null;return this.convertRangeToUnits(e,t)}getValueInBaseUnits(e){const t=this.getCurrentDisplayUnits();if(!t)return e/100;const i=this.getCurrentBaseUnits();return(0,Er.WR)(e,t,i)}resetRangeComponent(e){const t=this.getRangeInData(),i=this.visualizationState.visualizedRange;e===Vh.s.MIN?i.min=t.min:i.max=t.max,this.updateVisualizedScalarRange()}setAnalyzedElementId(e){this.analyzedElementId=e}saveSelectedBodies(e){if(!this.viewerIsInScalarVisualizationRenderMode())return;const t=(0,ve.vi)().filter((({selectionId:t})=>"string"==typeof t&&e.includes(t)));this.savedSelectedBodies=t}getSavedSelectedBodies(){return this.savedSelectedBodies}getUseMinValueHighlight(){return!!this.isDisplayingGradientField()||W.dGY.isMinChanged(this.getDefaultDisplayRange(),this.visualizedScalarRange,bi.W.ZERO_LENGTH)}getUseMaxValueHighlight(){return W.dGY.isMaxChanged(this.getDefaultDisplayRange(),this.visualizedScalarRange,bi.W.ZERO_LENGTH)}getUseDimColorScale(){return this.visualizationState.dimColorScale}setUseDimColorScale(e){this.visualizationState.dimColorScale=e,this.updateScalarRangeUniforms(),this.updateGraphics()}reactivate(e){if(e!==this.analyzedElementId)return;const t=this.savedSelectedBodies.map((e=>e.selectionId)).filter((e=>"string"==typeof e));this.resetState(),ps.Jq.ThicknessAnalysisService.updateVisualization(t)}getIsEnabledObservable(){return this.isEnabledSubject.asObservable()}onRenderingModeChanged(){super.onRenderingModeChanged(),this.viewerIsInScalarVisualizationRenderMode()?this.enable():this.disable()}getBodyFilter(){return this.bodyFilter||(this.bodyFilter=(0,Km.v)([(0,Ds._x)(W.ZSW.BODY),(0,Ds.NC)(W.wG2.SOLID),(0,Ds.II)()])),this.bodyFilter}isDisplayingGradientField(){var e,t;return null!==(t=null===(e=this.visualizationState)||void 0===e?void 0:e.isDisplayingGradientField())&&void 0!==t&&t}getMinHighlightColor(){if(this.isDisplayingGradientField()){const e=q.default.getManager(),t=this.getColorMappingName();return e.getColor(pc.DIM_COLOR_CONSTANT+t)}return super.getMinHighlightColor()}}sf.ENABLED_FIELD_TYPES=[W.DDL.ROLLING_BALL_THICKNESS,W.DDL.RAY_THICKNESS,W.DDL.ROLLING_BALL_THICKNESS_DERIVATIVE,W.DDL.RAY_THICKNESS_DERIVATIVE];var nf,rf=i(15843),af=i(72904),of=i(30035),hf=i(6513),cf=i(80007);const lf=new Qi({material:new ki,zOffset:q.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:_i.MX.TRIANGLES,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1,primitivesHaveTransparency:!0});null===(nf=lf.material)||void 0===nf||nf.setCustomFloatUniform("uOcclusionFactor",0);const uf=lf.cloneAndModify({primitivesHaveTransparency:!1});class df{constructor(e){this.modelViewManager=e,this.meshOwnerId=WS(),this.runningMultiPart=null,this.previewCache=new Map,this.getViewer().getEventDispatcher().on(Ms.t0J,(()=>this.onAssemblyDisplayed())),(0,fr.m)().on(mr.C.GET_GENERATIVE_INPUT_TRS,(()=>this.getGenerativeInputTrs())),(0,fr.m)().on(mr.C.CANCEL_GENERATIVE_RUN,(()=>this.cancelGenerativeRun()))}onChangeActiveElement(){this.clearGraphics()}getCachedResponseForElementId(e){return this.previewCache.get(e)}cacheResponse(e){if(!e.hasResults()){const t=this.getCachedResponseForElementId(e.elementId);(null==t?void 0:t.hasResults())&&(e.generativeFeatureIdToResult=t.generativeFeatureIdToResult)}this.previewCache.set(e.elementId,e)}resetCache(e){const t=new W.ZjL;t.completionPercentage=0,this.previewCache.set(e,t)}restorePreviewForActiveElement(){const e=this.getCachedResponseForElementId(this.getViewer().getActiveElementId());e&&this.displayGenerativeResponse(e)}onAssemblyDisplayed(){this.restorePreviewForActiveElement()}getViewer(){return this.modelViewManager.getViewer()}runGenerative(e){if(0===e.size)return ps.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("No generative features detected."),"warning"),void ps.Jq.AngularEventService.ensureDigest();this.generativeRunStart=new Date;const t=new W.ijO;t.generativeFeatureIds=[...e],t.skipCompute=!1,t.elementId=this.getViewer().getActiveElementId(),this.runningMultiPart=t.generativeFeatureIds.length>1,this.updateGraphics(),this.resetCache(t.elementId),this.updateBeeper(0),rf.Op.getConnection(rf.tl).send(t)}updateGraphics(){this.clearGraphics()}displayGenerativeResponse(e){var t;if(Object.values(e.generativeFeatureIdToResult).length>0&&this.drawPreview(e),e.isRunComplete)return null===(t=this.beeper)||void 0===t||t.stopBeeper(),void(this.beeper=null);this.updateBeeper(e.completionPercentage)}onFgsErrorInfo(e){this.clearGraphics();const t=i18n("Generative returned an error: __errorText__",{errorText:e.errorText});ps.Jq.MessageBubbleService.showMessageWithWarning(t),ps.Jq.AngularEventService.ensureDigest(),It.log.warn(t),this.generativeRunStart&&(It.log.debug(`generative.onFgsErrorInfo: Generative run finished exceptionally. Client-side timing information: ${hf.B.withStartTime(this.generativeRunStart)}`),this.generativeRunStart=null)}onGenerativeResponse(e){this.getViewer().getActiveElementId()===e.elementId&&this.displayGenerativeResponse(e),this.cacheResponse(e),e.isRunComplete&&this.generativeRunStart&&(It.log.debug(`generative.onGenerativeResponse: Generative run completed. Client-side timing information: ${hf.B.withStartTime(this.generativeRunStart)}`),this.generativeRunStart=null)}updateBeeper(e,t){let i;if(t)i=t;else if(e){const t=(0,Sr.roundTo)(e,2);i=this.runningMultiPart?i18n("Generating designs (__roundedPercentage__%)",{roundedPercentage:t}):i18n("Generating design (__roundedPercentage__%)",{roundedPercentage:t})}else i=this.runningMultiPart?i18n("Generating designs"):i18n("Generating design");if(this.beeper)this.beeper.setExplanation(i);else{const e=new of.e("generativeDesign").setImportant(i);this.beeper=(0,af.l)().startTaskBeeper(this.getViewer().getActiveElementId(),e)}}resetMeshes(){var e;null===(e=this.meshManager)||void 0===e||e.destroy(),this.meshManager=new zS(this.getViewer(),{bufferAllocationPolicy:CI.MAXIMUM})}clearGraphics(){var e;this.resetScenegraphNode(),this.resetMeshes(),null===(e=this.beeper)||void 0===e||e.stopBeeper(),this.beeper=null,this.getViewer().requestDraw()}resetScenegraphNode(){var e;null===(e=this.previewNode)||void 0===e||e.remove(),this.previewNode=new ts(df.PREVIEW_NODE_ID,lf),this.previewNode.setVisible(!1),this.modelViewManager.getSharedBodyNode().addChild(this.previewNode)}drawPreview(e){const t=this.getViewer().getOccurrenceIdManager(),i=this.getViewer().getOccurrenceDataManager(),s=this.modelViewManager.getDisplayedAssembly();if(s&&s.elementId===e.elementId){for(const n of Object.values(e.generativeFeatureIdToResult)){const r=n.preview.sampleMesh,a=new jE(_i.MX.TRIANGLES,r.points,r.getAnyIndices());id(a),a.replicateTextureCoordinate([0,0]);for(const r of n.relatedOccurrences){this.modelViewManager.setOccurrenceAlphaModifier(r,Ms.M81);const n=r.getPathAsString(),o=t.getIdForName(n);if(o===DI.Qy){It.log.warn("No occurrence id for "+n);continue}const h=i.getOccurrenceData(o);h||It.log.warn("No occurrence data for "+n);const c=s.getOccurrenceDisplayData(r);if(!c){It.log.warn("No occurrence display data for "+n);continue}const l=this.modelViewManager.getPartStudioDataFromOccurrence(r);if(!l){It.log.debug("No part studio for occurrence "+n);continue}a.id=n;const u=this.meshManager.addMeshIncrement(a,this.meshOwnerId),d=new BS("Generated "+n);d.onIncrementAdded(u);const g=l.retrieveBodyMetaData(c.partIds[0]),p=new fE;g&&p.setAttribute(Jd.COLOR,g.getColor());const m=e.isRunComplete?uf:lf;if(this.previewNode.addOccurrenceGeometryToNode(m,h,p,d),this.debugMeshEdges){const e=lu(a,a.id+".edges"),t=this.meshManager.addMeshIncrement(e,this.meshOwnerId),i=new BS("Generated "+n+" edges");i.onIncrementAdded(t),this.previewNode.addOccurrenceGeometryToNode(Ap,h,null,i)}}}this.previewNode.setVisible(!0),this.getViewer().requestDraw()}else It.log.debug("Tried to display generative response in the wrong element")}getGenerativeInputTrs(){if(!ps.Jq.CapabilitiesService.checkGenerativeDesignCurrentlyEnabled())return;if(this.requestedInputTrsForAssembly){const e=i18n("Still waiting on an input TRS for __assemblyName__.",{assemblyName:this.requestedInputTrsForAssembly});ps.Jq.MessageBubbleService.showMessageWithWarning(e)}const e=gi._3.getOpenDocumentController();if(!e)return;const t=e.getActiveAssemblyModel();if(!t)return;const i=e.getElementConnection();if(!i)return;this.updateBeeper(0,i18n("Generating input TRS..."));const s=new W.ijO;s.generativeFeatureIds=t.getUnsuppressedGenerativeFeatures().map((e=>e.featureId)),s.skipCompute=!0,s.elementId=this.getViewer().getActiveElementId(),i.send(s),this.requestedInputTrsForAssembly=t.getName()}onComputedDataResponse(e){var t;this.requestedInputTrsForAssembly?((0,cf.G)(new Blob([e.computedData]),`${this.requestedInputTrsForAssembly}_generative_input.trs`),this.requestedInputTrsForAssembly=null,null===(t=this.beeper)||void 0===t||t.stopBeeper(),this.beeper=null):It.log.warn("Received unexpected BTFgsComputedDataResponse")}cancelGenerativeRun(){if(!ps.Jq.CapabilitiesService.isDebugEnabled())return;const e=new W.eng;e.elementId=this.getViewer().getActiveElementId(),gi._3.getOpenDocumentController().getElementConnection().send(e)}}df.PREVIEW_NODE_ID="GenerativeDesignPreview";class gf{isFromWireBody(){return!1}isFromPointBody(){return!1}isCompositeBody(){return!1}isFromConstructionGeometry(){return!1}isInternalEdge(){return!1}isPlanar(){return!1}getPlanarNormal(){return null}isFromBody(){return!1}isFromSolidBody(){return!1}isFromSheetBody(){return!1}isFace(){return!1}canContainFace(){return!1}isEdge(){return!1}canContainEdge(){return!1}isVertex(){return!1}canContainVertex(){return!1}isDegenerateEdge(){return!1}isDefinedBySMVertex(){return!1}isDefinedBySMEdge(){return!1}isDefinedBySMFace(){return!1}isMateConnector(){return!1}isMate(){return!1}containsMesh(){return!1}isFlattened(){return!1}isFromActiveSheetMetal(){return!1}isBody(){return!1}isFromSketch(){return!1}isSketchTextEntity(){return!1}isSketchTextStroke(){return!1}isSketchImageEntity(){return!1}isSketchGroup(){return!1}getSketchGroupSelection(){return null}isUserSketchEntity(){return!1}getFeatureIds(){return[]}makeBodySelection(){return null}makeCompositeBodySelections(){return null}makeSketchFeatureSelection(){return null}isFromOccurrence(){return!1}isOccurrence(){return!1}makeOccurrenceSelection(e){return null}isClosedCurve(){return!1}isFromClick(){return!1}isEntity(){return!1}hasMateQueryData(){return!1}isGeometryMate(){return!1}getMateType(){return null}isMateGroup(){return!1}isMateConnectorBasedMate(){return!1}isFeature(){return!1}getFeatureType(){return null}isLine(){return!1}isCircle(){return!1}isEllipse(){return!1}isConic(){return!1}isCylinder(){return!1}isCone(){return!1}isSphere(){return!1}isTorus(){return!1}isRevolved(){return!1}isExtruded(){return!1}isAssemblyPattern(){return!1}isParametricInstance(){return!1}isParametricPartStudioInstance(){return!1}isParametricPartStudioChildInstance(){return!1}isParametricChildInstance(){return!1}isReplicatedInstance(){return!1}isNonSolidPartOccurrence(){return!1}isTemporaryGeometry(){return!1}isModifiable(){return!1}isNonModifiable(){return!1}isEdgePoint(){return!1}isPatternedOccurrence(){return!1}isAssemblyOccurrence(){return!1}isPartOccurrence(){return!1}isSuppressedOccurrence(){return!1}isFlattenedOccurrence(){return!1}isStandardContentOccurrence(){return!1}getOccurrence(){return null}getOwnerAssemblyOccurrence(){return null}makeMateConnectorSelection(){return null}isSpline(){return!1}isAssemblySketch(){return!1}isFromSplineHandle(){return!1}isInternalSplinePoint(){return!1}isFromSplineControlPolygon(){return!1}isSolveStatusUnknown(){return!1}isSolveStatusUnderDefined(){return!1}isSolveStatusWellDefined(){return!1}isSolveStatusFixed(){return!1}isSolveStatusOverDefined(){return!1}isSolveStatusNotConsistent(){return!1}isSectionEntity(){return!1}getBodyId(){return""}getIdString(){return""}getType(){}getUsage(){}isConstructionPlane(){return!1}getDeterministicId(e){return""}getBodyMetaData(){}getSketchGroupFeatureId(){return null}isProperty(){return!1}isTableItem(){return!1}getChildSelections(){return[]}getDeterministicIdList(){return[]}}class pf extends gf{isFromBody(){return!0}isFromSolidBody(){return!0}isVertex(){return!0}canContainVertex(){return!0}isEntity(){return!0}}class mf extends pf{isEdgePoint(){return!0}isInContextSelection(){return!1}}var ff=i(55395);class If extends ff.W{constructor(){super("/js/GraphicsWebAssemblyUtils.js","createGraphicsUtilsModule")}static get module(){return If.singleton||(If.singleton=new If),If.singleton}replaySampleMeshRefinementRoutine(e,t){const i=new mh.B7("GraphicsWebAssemblyUtils.replaySampleMeshRefinementRoutine"),s=this.copyFloat32ArrayToWasmHeap(e.points),n=this.copyInt32ArrayToWasmHeap(e.intIndices),r=this.copyTypedUint8ArrayToWasmHeap(t.history),a=this.module.replaySampleMeshRefinementRoutine(s,e.points.length,n,e.intIndices.length,r,t.recordCount),o=new W.JW9;return o.points=this.copyFloat32ArrayFromWasmHeap(a.getPointsLocation(),a.getPointsSize()),o.intIndices=this.copyInt32ArrayFromWasmHeap(a.getIndicesLocation(),a.getIndicesSize()),this.free(s),this.free(n),this.free(r),a.delete(),i.report(),o}}var Ef=i(16739);const Sf={blitFunctions:i(30193).Z,compareFunctions:i(71378).Z,constants:i(20780).Z,contactVisualizationFunctions:i(804).Z,decalFunctions:i(69978).Z,depthNormalFunctions:i(49850).Z,edgeFragmentUtilityFunctions:i(95376).Z,edgeUtilityFunctions:i(83848).Z,fragmentCurvatureUtilityFunctions:i(36004).Z,fragmentLightingUtilityFunctions:i(51357).Z,"fs-OITAccumulation":i(67956).Z,"fs-OITAccumulation-contact":i(14611).Z,"fs-OITAccumulation-decals":i(86306).Z,"fs-OITComposite":i(31856).Z,"fs-OITRevealage":i(91607).Z,"fs-OITRevealage-contact":i(74500).Z,"fs-OITRevealage-decals":i(39721).Z,"fs-backfacesil-faces":i(7176).Z,"fs-blitBodyCheck":i(92774).Z,"fs-compareBlend":i(24902).Z,"fs-debugPickPass":i(29073).Z,"fs-depth-edges":i(26959).Z,"fs-depth-faces":i(34802).Z,"fs-depth-points":i(79873).Z,"fs-draftAngle-faces":i(82107).Z,"fs-draftShadow-faces":i(65266).Z,"fs-draw-draftAnalysis":i(45526).Z,"fs-draw-edges":i(11219).Z,"fs-draw-endcap":i(76265).Z,"fs-draw-endcap-depth":i(535).Z,"fs-draw-faces":i(35572).Z,"fs-draw-faces-contact":i(30904).Z,"fs-draw-faces-decals":i(9892).Z,"fs-draw-faces-scalarVisualization":i(59782).Z,"fs-draw-points":i(88764).Z,"fs-draw-qualityVisualization":i(88089).Z,"fs-draw-silhouettes":i(69662).Z,"fs-draw-zebraStripes":i(32554).Z,"fs-drawTexture":i(97647).Z,"fs-edgeDetect":i(22246).Z,"fs-endcapMask-faces":i(66088).Z,"fs-endcapMask-faces-simulation":i(36986).Z,"fs-gaussianFilter":i(15011).Z,"fs-highlightBuffer-faces":i(31753).Z,"fs-highlightDraw-edges":i(55098).Z,"fs-highlightDraw-points":i(41076).Z,"fs-highlightDraw":i(78747).Z,"fs-highlightMask-faces":i(35556).Z,"fs-normalDepth-faces":i(83956).Z,"fs-normalDepthFilter":i(40103).Z,"fs-normalDepthWithMask-edges":i(63812).Z,"fs-normalDepthWithMask-faces":i(56076).Z,"fs-normalDepthWithMask-points":i(93131).Z,"fs-occlusion":i(4706).Z,"fs-occlusionFilter":i(86553).Z,"fs-pick-alternates-edges":i(73050).Z,"fs-pick-alternates-faces":i(45680).Z,"fs-pick-edges":i(65183).Z,"fs-pick-endcap":i(11015).Z,"fs-pick-faces":i(1740).Z,"fs-pick-points":i(46604).Z,"fs-planeId-faces":i(85275).Z,"fs-previewBlend":i(47318).Z,"fs-retrieveScalar-faces":i(9954).Z,"fs-tintByDepth-edges":i(85090).Z,"fs-tintByDepth-points":i(95287).Z,"fs-tintByNormalDepth-faces":i(60637).Z,"fs-tintByNormalDepth-faces-decals":i(5336).Z,"fs-tintByPlaneId-faces":i(8055).Z,getNormalSign:i(83963).Z,highlightFunctions:i(58657).Z,normalDepthWithMaskFunctions:i(44879).Z,picking:i(73820).Z,planeIdFunctions:i(25822).Z,pointFragmentUtilityFunctions:i(50459).Z,sectionPlaneClippingFunctions:i(65982).Z,sectionPlaneConstants:i(54028).Z,sectionPlaneEndcapFunctions:i(64636).Z,sectionPlaneEndcapMedianFilter:i(68108).Z,sectionPlaneEndcapPatternFunctions:i(4741).Z,sectionPlaneFragmentUtilityFunctions:i(78889).Z,setContactVaryings:i(54103).Z,undercutWeightFunction:i(81763).Z,utilityFunctions:i(31627).Z,vertexPicking:i(33513).Z,vertexUtilityFunctions:i(50166).Z,"vs-OITAccumulation":i(9836).Z,"vs-OITAccumulation-contact":i(34696).Z,"vs-OITAccumulation-decals":i(98674).Z,"vs-OITComposite":i(72806).Z,"vs-OITRevealage":i(2919).Z,"vs-OITRevealage-contact":i(16166).Z,"vs-OITRevealage-decals":i(34391).Z,"vs-backfacesil-faces":i(64279).Z,"vs-blitBodyCheck":i(92913).Z,"vs-compareBlend":i(2020).Z,"vs-debugPickPass":i(57206).Z,"vs-depth-edges":i(83689).Z,"vs-depth-faces":i(99801).Z,"vs-depth-points":i(77599).Z,"vs-draftAngle-faces":i(66490).Z,"vs-draftShadow-faces":i(44454).Z,"vs-draw-draftAnalysis":i(60515).Z,"vs-draw-edges":i(55486).Z,"vs-draw-endcap":i(15534).Z,"vs-draw-endcap-depth":i(4326).Z,"vs-draw-faces":i(59561).Z,"vs-draw-faces-contact":i(12703).Z,"vs-draw-faces-decals":i(18938).Z,"vs-draw-faces-scalarVisualization":i(65692).Z,"vs-draw-points":i(83920).Z,"vs-draw-qualityVisualization":i(10837).Z,"vs-draw-silhouettes":i(9340).Z,"vs-draw-zebraStripes":i(6543).Z,"vs-drawTexture":i(69049).Z,"vs-edgeDetect":i(42643).Z,"vs-endcapMask-faces":i(24164).Z,"vs-endcapMask-faces-simulation":i(31796).Z,"vs-gaussianFilter":i(61862).Z,"vs-highlightBuffer-faces":i(91297).Z,"vs-highlightDraw-edges":i(44779).Z,"vs-highlightDraw-points":i(58643).Z,"vs-highlightDraw":i(4358).Z,"vs-highlightMask-faces":i(91475).Z,"vs-normalDepth-faces":i(42035).Z,"vs-normalDepthFilter":i(94554).Z,"vs-normalDepthWithMask-edges":i(30241).Z,"vs-normalDepthWithMask-faces":i(18505).Z,"vs-normalDepthWithMask-points":i(43180).Z,"vs-occlusion":i(53749).Z,"vs-occlusionFilter":i(35474).Z,"vs-pick-alternates-edges":i(33472).Z,"vs-pick-alternates-faces":i(1527).Z,"vs-pick-edges":i(65107).Z,"vs-pick-endcap":i(41819).Z,"vs-pick-faces":i(36549).Z,"vs-pick-points":i(17275).Z,"vs-planeId-faces":i(58736).Z,"vs-previewBlend":i(64988).Z,"vs-retrieveScalar-faces":i(3047).Z,"vs-tintByDepth-edges":i(14327).Z,"vs-tintByDepth-points":i(85237).Z,"vs-tintByNormalDepth-faces":i(5016).Z,"vs-tintByNormalDepth-faces-decals":i(95891).Z,"vs-tintByPlaneId-faces":i(65843).Z,weightFunctions:i(61143).Z},Tf=1,Mf=0;var Cf;!function(e){e.SKIP_SECTION_PLANES="SKIP_SECTION_PLANES",e.USE_OCCURRENCE_TEXTURE="USE_OCCURRENCE_TEXTURE",e.USE_SECTION_PLANES="USE_SECTION_PLANES",e.USE_VERTEX_HIGHLIGHT_TEXTURE="USE_VERTEX_HIGHLIGHT_TEXTURE",e.DERIVATIVES_SUPPORTED="DERIVATIVES_SUPPORTED",e.LOOP_BREAK_SUPPORTED="LOOP_BREAK_SUPPORTED"}(Cf||(Cf={}));const Df="-nosection";function vf(e,t){return t?"#define "+e+" 1\n":""}let Pf=null;function yf(e,t){if(Pf&&!t)return;if(!Sf)return;const i=(0,X.Z)(Sf);for(const e in i){let t=i[e];const s=/{{{.*}}}/g;let n=0,r=s.exec(t);for(;r;){const a=r[0].substr(3,r[0].length-6);if(!i.hasOwnProperty(a)){It.log.warn("Missing shader include: "+a);break}const o=r.index+r[0].length;t=t.substr(0,r.index)+i[a]+t.substr(o,t.length-o),++n>100&&It.log.warn("Encountered a large number of includes while substituting shader "+e+". An include cycle may have been introduced."),s.lastIndex=0,r=s.exec(t)}i[e]=t}Pf={};let s=vf(Cf.USE_SECTION_PLANES,e.supportsGraphicalSectionPlanes());s+=vf(Cf.USE_VERTEX_HIGHLIGHT_TEXTURE,e.areHighlightVertexTexturesSupported()),s+=vf(Cf.DERIVATIVES_SUPPORTED,e.areShaderDerivativesSupported()),s+=vf(Cf.LOOP_BREAK_SUPPORTED,!(0,Et.isPlatformMac)()||(0,Et.isBrowserSafari)());const n=s+vf(Cf.SKIP_SECTION_PLANES,!0),r=Object.keys(i);for(let e=0;e<r.length;++e){const t=r[e],a=i[t];if(Pf[t]=s+a,t.startsWith("fs-")&&-1!==a.indexOf("discardIfPositionFails")){Pf[t+Df]=n+a;const e="v"+t.substr(1,t.length);e in i&&(Pf[e+Df]=n+i[e])}}}function Af(e,t){const i=e.indexOf(Df);return i<0?e+"-"+t:e.substr(0,i)+"-"+t+Df}class Of{constructor(e,t,i,s,n=!1,r=1){this.type=e,this.dimension=t,this.offset=i,this.stride=s,this.normalize=n,this.secondDimension=r,this.columnStride=zt(this.type)*this.dimension}clone(){return new Of(this.type,this.dimension,this.offset,this.stride,this.normalize,this.secondDimension)}offsetForColumn(e){return this.offset+e*this.columnStride}get multiDimensionStride(){return this.stride+this.secondDimension*this.columnStride}get elementCount(){return this.dimension*this.secondDimension}}function Rf(e){const t="vs"+e,i="fs"+e;return Pf.hasOwnProperty(t)&&Pf.hasOwnProperty(i)}class wf extends m.T{constructor(e,t){super(),this.viewer=e,this.id=t,this.vertexShader=null,this.fragmentShader=null,this.shaderProgram=null,this.uniformLocations={},this.attribLocations={},this.boundTextures={},this.shaderValidated=!1,this.disableVertexAttribArrayIfVaoUnavailable=null,(0,Ih.Yk)(e),this.listenTo(this.viewer.getEventDispatcher(),VM.cW,this.onGlContextLost),this.listenTo(this.viewer.getEventDispatcher(),VM.pO,this.onGlContextRestored),this.listenTo(this.viewer.getEventDispatcher(),VM.so,this.destroy),this.reinitialize(),this.disableVertexAttribArrayIfVaoUnavailable=this.viewer.areVertexArrayObjectsAvailable?e=>{}:e=>this.enableVertexAttribArray(e,!1),this.numericId=++wf.numericIdIncrementer}getId(){return this.id}getNumericId(){return this.numericId}destroy(){this.stopListening(),this.clearGlReferences()}clearGlReferences(){this.shaderValidated=!1,this.shaderProgram=null,this.vertexShader=null,this.fragmentShader=null,this.uniformLocations={},this.attribLocations={}}onGlContextLost(){this.clearGlReferences()}onGlContextRestored(){this.reinitialize()}reinitialize(){this.initializationFailed||(this.clearGlReferences(),this.viewer.getGlContext()&&(this.shaderProgram=this.initProgram()),this.unbindTextures())}equals(e){return null!==e&&this.id===e.id}deactivate(){if(!this.viewer.areVertexArrayObjectsAvailable)for(const e in this.attribLocations)this.enableVertexAttribArray(e,!1);this.unbindTextures()}unbindTextures(){for(const e in this.boundTextures)po(this.viewer,e);this.boundTextures={}}makeShader(e,t){const i=Pf[e];if(!i||i.length<1)return It.log.warn('Shader "'+e+'" not found'),null;const s=this.viewer.getGlContext();if(!s)return null;const n=s.createShader(t);return s.shaderSource(n,i),s.compileShader(n),n}getVertexShaderId(){return"vs"+this.id}getFragmentShaderId(){return"fs"+this.id}get initializationFailed(){return this.viewer.badShaders.hasOwnProperty(this.id)}set initializationFailed(e){e?this.viewer.badShaders[this.id]=!0:delete this.viewer.badShaders[this.id]}initProgram(){if(this.initializationFailed)return null;const e=this.viewer.getGlContext();if(this.vertexShader=this.makeShader(this.getVertexShaderId(),e.VERTEX_SHADER),this.fragmentShader=this.makeShader(this.getFragmentShaderId(),e.FRAGMENT_SHADER),!this.vertexShader||!this.fragmentShader)return this.initializationFailed=!0,null;const t=e.createProgram();return e.attachShader(t,this.vertexShader),e.attachShader(t,this.fragmentShader),e.bindAttribLocation(t,0,$d.POSITION),e.linkProgram(t),t}validateProgram(){if(this.shaderValidated)return;this.validateShader(this.vertexShader,this.getVertexShaderId()),this.validateShader(this.fragmentShader,this.getFragmentShaderId());const e=this.viewer.getGlContext();try{if(!e.getProgramParameter(this.shaderProgram,e.LINK_STATUS)&&!e.isContextLost()){this.clearGlReferences();const t=e.getProgramInfoLog(this.shaderProgram);It.log.warn(WM+"Could not link shaders for "+this.id+":\n "+t),_f(this.getVertexShaderId()),_f(this.getFragmentShaderId()),this.initializationFailed=!0}}catch(e){this.initializationFailed=!0,It.log.warn(WM+"Could not link shaders for "+this.id+", and log info retrieval failed. (Try in a different browser to see if it gives you more details.)")}this.shaderValidated=!0}validateShader(e,t){const i=this.viewer.getGlContext();try{e&&(i.getShaderParameter(e,i.COMPILE_STATUS)||i.isContextLost())||(It.log.warn(WM+"Error compiling shader "+t+":\n"+i.getShaderInfoLog(e)),_f(t))}catch(e){It.log.debug(WM+"Error getting shader info for: "+t+":\n"+e)}}ensureShaderIsInitialized(){this.shaderProgram||this.reinitialize()}useShader(){this.ensureShaderIsInitialized(),this.validateProgram(),this.viewer.getGlContext().useProgram(this.shaderProgram)}getUniformLocation(e){this.ensureShaderIsInitialized();let t=this.uniformLocations[e];return void 0!==t||(t=this.initializationFailed?null:this.viewer.getGlContext().getUniformLocation(this.shaderProgram,e),this.uniformLocations[e]=t),t}hasUniform(e){return!!this.getUniformLocation(e)}outputUniforms(){const e=this.viewer.getGlContext();let t=e.getProgramParameter(this.shaderProgram,e.ACTIVE_UNIFORMS);if(isNaN(t))return;t=+t.toString(),It.log.debug("Uniforms for shader: "+this.id);const i=function(e){let t="<";for(let i=0;i<e.length;++i)t+=e[i],i<e.length-1&&(t+=", ");return t+=">",t};for(let s=0;s<t;++s){const t=e.getActiveUniform(this.shaderProgram,s);if(t){let s=e.getUniform(this.shaderProgram,this.getUniformLocation(t.name));(s instanceof Float32Array||s instanceof Int32Array||s instanceof Array)&&(s=i(s)),It.log.debug("  Uniform: "+t.name+", size: "+t.size+", type: "+t.type+", value: "+s)}}}outputAttributes(){const e=this.viewer.getGlContext();let t=e.getProgramParameter(this.shaderProgram,e.ACTIVE_ATTRIBUTES);if(isNaN(t))return;const i=["VERTEX_ATTRIB_ARRAY_BUFFER_BINDING","VERTEX_ATTRIB_ARRAY_ENABLED","VERTEX_ATTRIB_ARRAY_SIZE","VERTEX_ATTRIB_ARRAY_STRIDE","VERTEX_ATTRIB_ARRAY_TYPE","VERTEX_ATTRIB_ARRAY_NORMALIZED","CURRENT_VERTEX_ATTRIB"];t=+t.toString(),It.log.debug("Attributes for shader: "+this.id);for(let s=0;s<t;++s){const t=e.getActiveAttrib(this.shaderProgram,s);if(t){const n=this.getAttribLocation(t.name);It.log.debug("  Attribute "+s+": "+t.name+", size: "+t.size+", type: "+t.type),It.log.debug("    Location: "+n),It.log.debug("    Pointer offset: "+e.getVertexAttribOffset(n,e.VERTEX_ATTRIB_ARRAY_POINTER));for(let t=0;t<i.length;++t){const s=i[t],r=e.getVertexAttrib(n,e[s]);"CURRENT_VERTEX_ATTRIB"===s?It.log.debug("    "+s+" : ["+r[0]+", "+r[1]+", "+r[2]+", "+r[3]+"]"):It.log.debug("    "+s+" : "+r)}}}}getAttribLocation(e){this.ensureShaderIsInitialized();let t=this.attribLocations[e];return void 0!==t||(t=this.initializationFailed?-1:this.viewer.getGlContext().getAttribLocation(this.shaderProgram,e),this.attribLocations[e]=t),t}hasAttribute(e){return this.getAttribLocation(e)>=0}vertexAttribPointer(e,t){const i=this.getAttribLocation(e);if(i<0)return;const s=this.viewer.getGlContext();if(1===t.secondDimension)s.vertexAttribPointer(i,t.dimension,t.type,t.normalize,t.stride,t.offset);else for(let e=0;e<t.secondDimension;++e)s.vertexAttribPointer(i+e,t.dimension,t.type,t.normalize,t.multiDimensionStride,t.offsetForColumn(e));this.enableVertexAttribArray(e,!0,t.secondDimension)}enableVertexAttribArray(e,t,i){void 0===t&&(t=!0);const s=this.getAttribLocation(e);if(!(s<0))if(i)for(let e=0;e<i;++e)this.viewer.enableVertexAttributeArray(s+e,t);else this.viewer.enableVertexAttributeArray(s,t)}useTexture(e,t){if(!this.hasUniform(e))return;let i;i=t instanceof uo?t.updateAndBindTexture(e):go(this.viewer,t,e),i<0?this.useBlankTexture(e):(this.boundTextures[e]=i,this.uniform1i(e,i))}setAttribute(e,t){switch(e.dimension){case 1:this.vertexAttrib1f(e.name,t);break;case 2:this.vertexAttrib2fv(e.name,t);break;case 3:this.vertexAttrib3fv(e.name,t);break;case 4:this.vertexAttrib4fv(e.name,t)}}setFloatUniform(e,t){switch(t.length){case 2:this.uniform2fv(e,t);break;case 3:this.uniform3fv(e,t);break;case 4:this.uniform4fv(e,t);break;default:this.uniform1f(e,t)}}setIntUniform(e,t){switch(t.length){case 2:this.uniform2iv(e,t);break;case 3:this.uniform3iv(e,t);break;case 4:this.uniform4iv(e,t);break;default:this.uniform1i(e,t)}}setMatrixUniform(e,t,i=!1){switch(t.length){case 16:this.uniformMatrix4fv(e,i,t);break;case 9:this.uniformMatrix3fv(e,i,t);break;case 4:this.uniformMatrix2fv(e,i,t);break;default:It.log.debug(`Unsupported matrix size in setMatrixUniform. ${e}, length: ${t.length}`)}}setVectorUniform(e,t){switch(t.length){case 4:this.uniform4fv(e,t);break;case 3:this.uniform3fv(e,t);break;case 2:this.uniform2fv(e,t);break;default:It.log.debug(`Unsupported vector size in setVectorUniform. ${e}, length: ${t.length}`)}}useBlankTexture(e){if(!this.hasUniform(e))return;const t=this.viewer.getResources().getBlankTexture().updateAndBindTexture(e);t>=0&&(this.boundTextures[e]=t,this.uniform1i(e,t))}uniform1f(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform1f(i,t)}uniform1fv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform1fv(i,t)}uniform1i(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform1i(i,t)}uniform1iv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform1iv(i,t)}uniform2f(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniform2f(s,t,i)}uniform2fv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform2fv(i,t)}uniform2i(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniform2i(s,t,i)}uniform2iv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform2iv(i,t)}uniform3f(e,t,i,s){const n=this.getUniformLocation(e);null!==n&&this.viewer.getGlContext().uniform3f(n,t,i,s)}uniform3fv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform3fv(i,t)}uniform3i(e,t,i,s){const n=this.getUniformLocation(e);null!==n&&this.viewer.getGlContext().uniform3i(n,t,i,s)}uniform3iv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform3iv(i,t)}uniform4f(e,t,i,s,n){const r=this.getUniformLocation(e);null!==r&&this.viewer.getGlContext().uniform4f(r,t,i,s,n)}uniform4fv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform4fv(i,t)}uniform4i(e,t,i,s,n){const r=this.getUniformLocation(e);null!==r&&this.viewer.getGlContext().uniform4i(r,t,i,s,n)}uniform4iv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform4iv(i,t)}uniformMatrix2fv(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniformMatrix2fv(s,t,i)}uniformMatrix3fv(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniformMatrix3fv(s,t,i)}uniformMatrix4fv(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniformMatrix4fv(s,t,i)}vertexAttrib1f(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib1f(i,t))}vertexAttrib1fv(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib1fv(i,t))}vertexAttrib2f(e,t,i){const s=this.getAttribLocation(e);s<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib2f(s,t,i))}vertexAttrib2fv(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib2fv(i,t))}vertexAttrib3f(e,t,i,s){const n=this.getAttribLocation(e);n<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib3f(n,t,i,s))}vertexAttrib3fv(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib3fv(i,t))}vertexAttrib4f(e,t,i,s,n){const r=this.getAttribLocation(e);r<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib4f(r,t,i,s,n))}vertexAttrib4fv(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib4fv(i,t))}}function _f(e){const t=Pf[e];if(!t||t.length<1)return void It.log.warn('Shader "'+e+'" not found');const i=t.split("\n");for(let e=0;e<i.length;++e)i[e]=e+1+": "+i[e];It.log.warn(WM+e+" source:\n"+i.join("\n"))}wf.numericIdIncrementer=0;class Nf extends Ri{constructor(e,t){super(e),this.POINT_NODE_PROPERTIES=new Qi({primitiveType:_i.MX.POINTS,isPickable:!1}),this.LINE_NODE_PROPERTIES=new Qi({primitiveType:_i.MX.LINES,isPickable:!1,addsToBounds:!1});const i=e.getSceneBounds().diameter(),s=q.default.getManager();if(t.point){const e=Su(t.point,void 0,s.getColor("RAY_COLOR"),s.getNumber("RAY_ORIGIN_WIDTH_PX"));this.updateMeshIncrement("point",yi,e,this.POINT_NODE_PROPERTIES)}const n=pu(t.point,pe.S4.add(pe.S4.scale(t.direction,i,v.create()),t.point),void 0,s.getColor("RAY_COLOR"),s.getNumber("RAY_LINE_WIDTH_PX"));this.updateMeshIncrement("line",yi,n,this.LINE_NODE_PROPERTIES)}}const bf=new Qi({primitiveType:_i.MX.TRIANGLE_STRIP}),Lf=new Qi({primitiveType:_i.MX.LINES});let Ff=null,xf=null;class Bf extends Ri{constructor(e,t,i){super(t),this.primitiveType=e;const s=ge.create();switch(s[12]=32*i.random(),s[13]=18*i.random(),s[14]=18*i.random(),this.setTransform(s),Ff||(Ff=uu(100,100),xf=cu(Ff)),this.primitiveType){case _i.MX.TRIANGLE_STRIP:this.updateMeshIncrement("s","s",Ff,bf);break;case _i.MX.LINES:this.updateMeshIncrement("s","s",xf,Lf)}}getPrimitiveCount(){switch(this.primitiveType){case _i.MX.TRIANGLE_STRIP:return Ff.getTriangleCount();case _i.MX.LINES:return xf.getLineCount()}return 0}}class Uf{constructor(e,t){this.primitiveType=e,this.viewer=t,this.primitiveCount=0,this.spheres=[],this.randomNumberGenerator=new de.H(0)}addPrimitivesToScene(){let e=0;for(;e<75e4;){const t=new Bf(this.primitiveType,this.viewer,this.randomNumberGenerator);this.spheres.push(t),this.primitiveCount+=t.getPrimitiveCount(),e+=t.getPrimitiveCount()}}getPrimitiveCount(){return this.primitiveCount}remove(){for(let e=0;e<this.spheres.length;++e)this.spheres[e].remove();this.spheres=[]}}class Vf{constructor(){this.trianglesPerSecond=0,this.trianglesPerSecondMeasurementHaltedEarly=!1,this.linesPerSecond=0,this.linesPerSecondMeasurementHaltedEarly=!1,this.executionTimeMs=0,this.refreshRate=0,this.testSkippedDueToLowRefreshRate=!0}getScore(){return Math.min(this.getModelSize()/Gf.getModelSize(),1)}getModelSize(){return(5*this.linesPerSecond+this.trianglesPerSecond)/20}}const Gf=new Vf;Gf.trianglesPerSecond=8e7,Gf.linesPerSecond=6e7;const Hf=1500,kf=3e3,Wf=45;class zf{constructor(){this.deferred=null,this.startTime=null,this.lastFrameTime=null,this.fpsSamples=[]}refreshCallback(){const e=performance.now(),t=e-this.startTime;if(t>=kf){let e=0;for(let t=0;t<this.fpsSamples.length;++t)e+=this.fpsSamples[t];const t=this.fpsSamples.length>0?e/this.fpsSamples.length:0;this.deferred.resolve(t)}else t>Hf&&null!==this.lastFrameTime&&this.fpsSamples.push(1e3/(e-this.lastFrameTime)),this.lastFrameTime=e,window.requestAnimationFrame((()=>this.refreshCallback()))}measureRefreshRate(){return this.deferred||(this.deferred=$r.defer(),this.startTime=window.performance.now(),window.requestAnimationFrame((()=>this.refreshCallback()))),this.deferred.promise}}class Xf{constructor(e){this.viewer=e,this.deferred=null,this.frameBuffer=null,this.blitPass=null,this.canvasViewport=P.fromValues(0,0,1,1),this.testViewport=P.fromValues(0,0,1,1),this.startTime=0,this.results=new Vf,this.fastFrameThresholdMS=1e3/45}execute(){if(this.deferred)return this.deferred.promise;this.startTime=(0,Js.Wj)(),this.canvasViewport=this.viewer.getCamera().getViewport(),this.testViewport=P.fromValues(0,0,1280,720),this.viewer.renderContext.pushViewport(this.canvasViewport),this.viewer.getCamera().setViewport(this.testViewport),this.viewer.renderContext.pushViewport(this.testViewport);const e=this.viewer.getGlContext();this.frameBuffer=this.viewer.getOrCreateFrameBuffer(e.UNSIGNED_BYTE,"",{storageType:e.DEPTH_STENCIL,attachmentType:e.DEPTH_STENCIL_ATTACHMENT}),this.frameBuffer.update(this.viewer.renderContext),this.viewer.renderContext.popViewport(),this.blitPass=new T(this.viewer,this.frameBuffer),this.deferred=$r.defer();return(new zf).measureRefreshRate().then((e=>{this.results.refreshRate=e,e<Wf?(this.results.testSkippedDueToLowRefreshRate=!0,this.resolve()):(this.results.testSkippedDueToLowRefreshRate=!1,this.measureTrianglesPerSecond())})),this.deferred.promise}resolve(){this.frameBuffer.destroy(),this.viewer.renderContext.popViewport(),this.results.executionTimeMs=(0,Js.Es)(this.startTime),this.deferred.resolve(this.results)}measureFrameTime(e){const t=(0,Et.isBrowserSafari)()?20:5;let i=!1,s=0,n=0,r=0,a=0;const o={performFrameTiming:!1};this.viewer.getCamera().setViewport(this.testViewport),this.viewer.getPrimaryViewController().setStandardView("XZ"),this.viewer.zoomFit();let h=500;const c=l=>{const u=(0,Js.Wj)(),d=this.viewer.getPrimaryViewController();if(d.rotateAbout(.0698131701,[0,0,1],d.camera.focalPoint()),r){a+=u-r,++s}i?r=u:(n=u,i=!0);const g=u-n;if(g>500&&2500!==h){a/s>=this.fastFrameThresholdMS&&(h=2500)}s>=t&&g>=h?e(a/s):(this.frameBuffer.bindBuffer(),this.viewer.getCamera().setViewport(this.testViewport),this.viewer.renderContext.pushViewport(this.testViewport),this.viewer.draw(l),this.viewer.renderContext.popViewport(),this.viewer.getCamera().setViewport(this.canvasViewport),this.frameBuffer.unbindBuffer(),this.blitPass.draw(this.viewer.renderContext),this.viewer.requestDraw(c,o,!0))};this.viewer.requestDraw(c,o,!0)}measureTrianglesPerSecond(){this.measurePrimitivesPerSecond(_i.MX.TRIANGLE_STRIP,Gf.trianglesPerSecond,((e,t)=>{this.results.trianglesPerSecond=e,this.results.trianglesPerSecondMeasurementHaltedEarly=t,this.measureLinesPerSecond()}))}measureLinesPerSecond(){this.measurePrimitivesPerSecond(_i.MX.LINES,Gf.linesPerSecond,((e,t)=>{this.results.linesPerSecond=e,this.results.linesPerSecondMeasurementHaltedEarly=t,this.resolve()}))}measurePrimitivesPerSecond(e,t,i){const s=new Uf(e,this.viewer);s.addPrimitivesToScene();const n=10*t,r=e=>{const t=s.getPrimitiveCount()/e*1e3;e<this.fastFrameThresholdMS&&t<=n?(s.addPrimitivesToScene(),this.measureFrameTime(r)):(s.remove(),this.viewer.cleanUpOrphanedObjects(),i(t,t>n))};this.measureFrameTime(r)}}function qf(e){return new Xf(e).execute()}class Zf{constructor(){this.TOTAL_PROPERTY="total",this.BYTE_TO_MB=1/1048576,this.memoryUsage={}}reset(){this.memoryUsage={}}incrementMemoryUsage(e,t){if(e===this.TOTAL_PROPERTY)throw'Do not use "'+this.TOTAL_PROPERTY+'" as memory type.';this.memoryUsage.hasOwnProperty(e)?this.memoryUsage[e]+=t:this.memoryUsage[e]=t}decrementMemoryUsage(e,t){if(e===this.TOTAL_PROPERTY)throw'Do not use "'+this.TOTAL_PROPERTY+'" as memory type.';this.memoryUsage.hasOwnProperty(e)&&(this.memoryUsage[e]-=t)}addToStatistics(){const e=(0,Un.qn)();for(const t in this.memoryUsage)e.increment("MB "+t,this.memoryUsage[t]*this.BYTE_TO_MB)}getUsageDetails(){const e=(0,X.Z)(this.memoryUsage);let t=0;for(const e in this.memoryUsage)t+=this.memoryUsage[e];return e[this.TOTAL_PROPERTY]=t,e}}var Yf=i(98681);const Kf=q.default.getManager();let jf=new Int32Array(0),Qf=new Float32Array(0),$f=new Int32Array(0),Jf=0,eI=0;const tI=1024*Kf.getNumber("MAX_EDGE_BASED_SILHOUETTE_MEMORY_USE_MB")*1024;function iI(){return eI>=tI}let sI=0,nI=[];const rI=function(e,t,i,s,n,r,a,o,h,c,l,u,d){const g=e.normals[3*l+0],p=e.normals[3*l+1],m=e.normals[3*l+2],f=e.normals[3*u+0],I=e.normals[3*u+1],E=e.normals[3*u+2],S=e.normals[3*d+0],T=e.normals[3*d+1],M=e.normals[3*d+2],C=(0,Sr.crossProduct)(o-n,h-r,c-a,n-t,r-i,a-s);pe.S4.normalize(C);let D=g*C[0]+p*C[1]+m*C[2];D<0&&(pe.S4.negate(C),D*=-1);const P=f*C[0]+I*C[1]+E*C[2],y=S*C[0]+T*C[1]+M*C[2],A=bi.W.FACE_NORMAL_IS_BAD;return(D<A||P<A||y<A)&&v.set(C,(g+f+S)/3,(p+I+T)/3,(m+E+M)/3),C},aI=function(e,t,i,s,n,r,a){let o;o=t<i?t+"__"+i:i+"__"+t;let h=a[o],c=0;void 0!==h?(c=jf[h],jf[h]=c+1):(h=Jf,a[o]=h,$f[2*h+0]=s,$f[2*h+1]=n,jf[h]=1,Jf++),c<2&&(Qf[6*h+3*c+0]=r[0],Qf[6*h+3*c+1]=r[1],Qf[6*h+3*c+2]=r[2])},oI=function(e,t,i,s,n){let r=pe.S4.subtract(t,e,n);pe.S4.normalize(r),r=pe.S4.cross(r,i,r);const a=Math.atan2(i[1],i[0]),o=pe.gv.length(i),h=Math.atan2(i[2],o),c=v.dot(i,s),l=v.dot(r,s),u=Math.atan2(l,c);v.set(n,a,h,u)},hI=function(e,t){if(e.indices.length<3||e.indices.length>Kf.getNumber("MAX_SINGLE_SILHOUETTE_INCREMENT_SIZE"))return null;!function(e){Jf=0;const t=2*e;jf.length<t&&(jf=new Int32Array(t),Qf=new Float32Array(6*t),$f=new Int32Array(2*t))}(e.indices.length);const i={},s=function(t,s,n){return function(t,i){return v.set(i,e.points[3*t+0],e.points[3*t+1],e.points[3*t+2])}($f[2*i[t]+s],n)},n=function(e,t,s){const n=i[e];v.set(s,Qf[6*n+3*t+0],Qf[6*n+3*t+1],Qf[6*n+3*t+2])};for(let t=2;t<e.indices.length;++t){const s=e.indices[t-2],n=e.indices[t-1],r=e.indices[t];if(!(s===n||n===r||s===r)){const t=e.points[3*s+0],a=e.points[3*s+1],o=e.points[3*s+2],h=Zu(t,a,o),c=e.points[3*n+0],l=e.points[3*n+1],u=e.points[3*n+2],d=Zu(c,l,u),g=e.points[3*r+0],p=e.points[3*r+1],m=e.points[3*r+2],f=Zu(g,p,m),I=rI(e,t,a,o,c,l,u,g,p,m,s,n,r);aI(0,h,d,s,n,I,i),aI(0,d,f,n,r,I,i),aI(0,h,f,s,r,I,i)}}const r=function(e){return 2===jf[i[e]]},a=[];for(const e in i)r(e)&&a.push(e);const o=a.length;if(0===o)return null;const h=new Float32Array(6*o),c=new Int32Array(2*o),l=new Float32Array(6*o),u=v.create(),d=v.create(),g=v.create(),p=v.create(),m=v.create();for(let e=0;e<o;++e){const t=a[e];s(t,0,u),s(t,1,d),n(t,0,g),n(t,1,p),oI(u,d,g,p,m),c[2*e]=2*e,c[2*e+1]=2*e+1;for(let t=0;t<3;++t)h[6*e+t]=u[t],h[6*e+3+t]=d[t],l[6*e+t]=m[t],l[6*e+3+t]=m[t]}const f=new jE(_i.MX.SILHOUETTES,h,c,t,!0);f.normals=l,f.prepareForBuffering();const I=!iI();return eI+=e.getTriangleCount()*Yf.a.SILHOUETTE_BYTES_PER_TRIANGLE,I&&iI()&&It.log.info("Edge-based silhouette memory use exhausted"),f};function cI(e,t){return e.getFullId()+"_"+t}class lI{constructor(e,t,i){this.parentIncrement=e,this.usage=t,this.callback=i,this.key=cI(e,t),this.id=(sI++,sI);const s=this.parentIncrement.getBounds();this.bboxDiameter=s.diameter()}}class uI{constructor(e,t){this.parentIncrementGuid=e,this.silhouetteIncrement=t}}const dI=function(e){for(let t=nI.length-1;t>=0;--t)if(nI[t].parentIncrementGuid===e)return nI[t];return null},gI=function(e){nI.length>=100&&nI.shift(),nI.push(e)};function pI(e){return e+"_siledges"}function mI(e){const t=e.getGloballyUniqueId(),i=dI(t);let s=null;if(i)s=i.silhouetteIncrement;else{const i=pI(e.id);s=hI(e,i),s&&gI(new uI(t,s))}return s}class fI{constructor(e){this.viewer=e,this.silhouetteIncrementToRequest={},this.silhouetteRequestQueue=[],this.silhouetteRequestQueueIsSorted=!1}process(e){if(this.hasPendingWork())for(this.silhouetteRequestQueueIsSorted||(this.silhouetteRequestQueue.sort((function(e,t){return t.bboxDiameter-e.bboxDiameter})),this.silhouetteRequestQueueIsSorted=!0);this.silhouetteRequestQueue.length>0;){const t=this.silhouetteRequestQueue.shift();if(this.silhouetteIncrementToRequest[t.key]!==t.id)continue;if(delete this.silhouetteIncrementToRequest[t.key],iI())continue;const i=mI(t.parentIncrement);if(i&&(e&&e.addVertexCost(i.vertexCount()),t.callback(t.parentIncrement,i)),e&&e.budgetExceeded())break}}hasPendingWork(){return this.silhouetteRequestQueue.length>0}postSilhouetteRequest(e,t,i){if(!this.viewer.areEdgeSilhouettesEnabled())return;if(iI())return;const s=new lI(e,t,i);this.silhouetteRequestQueue.push(s),this.silhouetteRequestQueueIsSorted=!1,this.silhouetteIncrementToRequest[s.key]=s.id}clearPendingRequests(){this.silhouetteRequestQueue=[]}clearPendingRequestsForUsage(e){const t=[];for(let i=0;i<this.silhouetteRequestQueue.length;++i){const s=this.silhouetteRequestQueue[i];s.usage!==e&&t.push(s)}this.silhouetteRequestQueue=t,this.silhouetteRequestQueue=this.silhouetteRequestQueue.filter((function(t){return t.usage!==e}))}removePendingRequest(e,t){delete this.silhouetteIncrementToRequest[cI(e,t)]}}function II(){nI=[]}class EI{constructor(e,t){this.viewer=e,this.sceneGraphs=t,this.nodes={},this.meshManager=new zS(this.viewer,{bufferAllocationPolicy:CI.MEDIUM}),this.onSessionEnded=()=>{this.meshManager.destroy(),this.viewer.getEventDispatcher().off(VM.so,this.onSessionEnded)},this.viewer.getEventDispatcher().on(VM.so,this.onSessionEnded)}getMeshManager(){return this.meshManager}getNode(e){if(!this.nodes[e]){const t=new ts("uinode");this.nodes[e]=t,this.sceneGraphs.getSceneGraph(e).getRootNode().addChild(t)}return this.nodes[e]}destroyPreviewGraphics(){delete this.nodes[sh.Vv]}clean(){this.meshManager.removeEmptyMeshes();for(const e in this.nodes)this.nodes[e].cleanEmptyMeshNodes()}}const SI=new ki({diffuseFactor:.5,ambientFactor:.5});function TI(){return{0:new Qi({isPickable:!1,zOffset:3,isShowThrough:!0,primitiveType:_i.MX.POINTS}),1:new Qi({isPickable:!1,zOffset:4,isShowThrough:!0,primitiveType:_i.MX.LINES,priority:Yi.HIGHEST}),4:new Qi({isPickable:!1,isTwoSided:!0,zOffset:5,primitiveType:_i.MX.TRIANGLE_STRIP,material:SI,primitivesHaveTransparency:!0})}}class MI extends Ri{constructor(e,t){super(t),this.sheetMetalModelId=null,this.incrementIdToHightlight={};q.default.getManager();e.forEach((function(e,t){let i=null;if(e instanceof W.TT0&&(i=e,this.sheetMetalModelId=i.sheetMetalModelId,i.deterministicId&&i.style===W.$76.ERROR)){const e=(0,ve.cF)(i.deterministicId);if(e)return void(0,ve.yb)().add(e)}const s=GI(e);if(s){if(!s.colors){Uu(UI(W.FVx.FEATURE_ERROR,s.primitiveType),s)}s.primitiveType===_i.MX.POINTS?s.primitiveSizes||Hu(7,s):s.primitiveType===_i.MX.LINES&&Hu(2.5,s);const e=TI(),n="id"+t;if(this.updateMeshIncrement(n,yi,s,e[s.primitiveType]),i&&i.style===W.$76.ERROR){const e=this.addNewHighlightToIncrement(n,yn.o2.ERROR);this.incrementIdToHightlight[n]=e,this.hideIncrement(n)}this.viewer.getIsolatedOccurrenceManager().addIdsToIsolate([this.graphicsOccurrenceId])}}),this)}show(){super.show();for(const e in this.incrementIdToHightlight){const t=this.addNewHighlightToIncrement(e,yn.o2.ERROR);this.incrementIdToHightlight[e]=t,this.hideIncrement(e)}}hide(){super.hide();for(const e in this.incrementIdToHightlight)this.removeHighlightFromIncrement(e,this.incrementIdToHightlight[e]);this.freeAllocatedHighlights()}remove(){(0,ve.yb)().reset(),this.viewer.getIsolatedOccurrenceManager().removeFromIsolate([this.graphicsOccurrenceId]),super.remove()}}var CI,DI=i(54673),vI=i(78769),PI=i(26564);class yI extends Ri{constructor(e,t){super(t,sh.lL),this.idToSilhouetteInfo={},this.sketchProperties=new Qi({isPickable:!0,isShowThrough:!0,isDepthTested:!1,primitiveType:_i.MX.LINES,zOffset:1}),this.worldProperties=new Qi({isPickable:!0,isShowThrough:!0,isDepthTested:!0,primitiveType:_i.MX.LINES,zOffset:1});const i=q.default.getManager();let s;for(this.width=i.getNumber("SKETCH_SILHOUETTE_WIDTH"),this.sketchColor=i.getColor("SKETCH_PREVIEW_COLOR"),this.worldColor=i.getColor("SKETCH_SILHOUETTE_WORLD_COLOR"),this.hoverWidth=i.getNumber("HIGHLIGHT_LINE_WIDTH_MIN"),this.hoverColor=i.getColor("PRE_HIGHLIGHT_COLOR_BORDER"),this.worldStipple=i.getStipple("SKETCH_SILHOUETTE_WORLD_STIPPLE"),s=0;s<e.length;++s){const t=e[s].silhouetteId;this.idToSilhouetteInfo[t]=e[s],this.updateSilhouette(t,!1),this.listenTo(this,Pi.MOUSE_ENTER+t,this.onMouseEnter),this.listenTo(this,Pi.MOUSE_LEAVE+t,this.onMouseLeave),this.listenTo(this,Pi.CLICK+t,this.onMouseClick)}}updateAllSilhouettes(){Object.entries(this.idToSilhouetteInfo).forEach((([e,t])=>{this.updateSilhouette(e,!1)}))}updateSilhouette(e,t){const i=this.idToSilhouetteInfo[e];if(!i)return;Uu(t?this.hoverColor:this.worldColor,i.worldMesh),Hu(t?this.hoverWidth:this.width,i.worldMesh),ku(this.worldStipple,i.worldMesh),this.updateMeshIncrement(e,e,i.worldMesh,this.worldProperties);const s=this.getProjectedMeshId(e),n=ro(this.viewer,i.sketchPolyline);Uu(t?this.hoverColor:this.sketchColor,n),Hu(t?this.hoverWidth:this.width,n),this.updateMeshIncrement(s,e,n,this.sketchProperties)}getProjectedMeshId(e){return e+".ske"}getClearModelSelectionsOnPrehilite(){return!1}onMouseEnter(e){this.updateSilhouette(e.selectionId,!0),(0,Js.vm)()}onMouseLeave(e){this.updateSilhouette(e.selectionId,!1),(0,Js.vm)()}onMouseClick(e){const t=this.idToSilhouetteInfo[e.selectionId];t&&this.trigger(PI.AW,this,t.disambiguation,e.selectionId)}removeOtherSilhouettes(e){for(const t in this.idToSilhouetteInfo)t!==e&&(this.removeMeshIncrement(t),this.removeMeshIncrement(this.getProjectedMeshId(t)),delete this.idToSilhouetteInfo[t]);this.stopListening(),this.updateSilhouette(e,!1),(0,Js.vm)()}}!function(e){e[e.MINIMUM=0]="MINIMUM",e[e.MEDIUM=1]="MEDIUM",e[e.MAXIMUM=2]="MAXIMUM"}(CI||(CI={}));const AI=(0,Un.qn)();class OI extends m.T{constructor(e,t){super(),this.viewer=e,this.bufferSets=[],this.buffersNeedCompilation=!1,this.vertexSize=0,(0,Ih.Yk)(e),this.bufferAllocationPolicy=t&&void 0!==t.bufferAllocationPolicy?t.bufferAllocationPolicy:CI.MINIMUM,this.id=t?t.id:void 0,this.primitiveType=_i.MX.PRIMITIVE_UNKNOWN,this.incrementToBufferSetIndex=new Ol.TemplatedCountedMap,this.listenTo(this.viewer.getEventDispatcher(),VM.pO,this.onGlContextRestored),this.listenTo(this.viewer.getEventDispatcher(),VM.so,this.onGlContextDestroyed)}destroy(){let e;for(e=0;e<this.bufferSets.length;++e)this.bufferSets[e].destroy();this.incrementToBufferSetIndex.clear(),this.stopListening()}getId(){return this.id}onGlContextRestored(e){for(let e=0;e<this.bufferSets.length;++e)this.bufferSets[e].reinitialize()}onGlContextDestroyed(){this.destroy()}getPrimitiveType(){return this.primitiveType}setPrimitiveType(e){this.primitiveType=e}getBuffersNeedCompilation(){return this.buffersNeedCompilation}setBuffersNeedCompilation(){this.buffersNeedCompilation=!0}onPermanentlyRemoved(){this.destroy()}incrementStatisticsForCall(e,t){switch(AI.increment(Un.kW.DRAW_CALLS,t),this.primitiveType){case _i.MX.LINES:AI.increment(Un.kW.LINES,Math.floor(e/6));break;case _i.MX.POINTS:AI.increment(Un.kW.POINTS,Math.floor(e/6));break;case _i.MX.TRIANGLES:AI.increment(Un.kW.TRIANGLES,Math.floor(e/3));break;case _i.MX.TRIANGLE_STRIP:AI.increment(Un.kW.TRIANGLES,e-2)}}getPrimitiveMode(){const e=this.viewer.getGlContext();switch(this.primitiveType){case _i.MX.POINTS:case _i.MX.LINES:case _i.MX.INFINITE_LINES:case _i.MX.TRIANGLES:case _i.MX.SILHOUETTES:return e.TRIANGLES;case _i.MX.TRIANGLE_STRIP:return e.TRIANGLE_STRIP;default:It.log.warn("Unknown mesh primitive type: "+this.primitiveType)}return 0}getAlternatePrimitiveMode(){const e=this.viewer.getGlContext();switch(this.primitiveType){case _i.MX.LINES:return e.POINTS;case _i.MX.TRIANGLE_STRIP:return e.LINE_STRIP}return 0}getBufferSetIndexForIncrement(e){return this.incrementToBufferSetIndex.has(e)?this.incrementToBufferSetIndex.get(e):-1}addBufferSet(e){this.bufferSets.push(e),e.setParentMesh(this)}removeBufferSet(e){const t=this.bufferSets.indexOf(e);t>-1&&this.bufferSets.splice(t,1)}removeSimpleBufferSetWithMeshGroupId(e){for(let t=this.bufferSets.length-1;t>=0;t--){const i=this.bufferSets[t];if(i.hasOptimizedBuffers()&&i.getMeshGroupId()===e)return this.bufferSets.splice(t,1),!0}return!1}addIncrement(e){if(!e.getFullId())return It.log.warn("An attempt was made to add a increment without a valid id"),null;if(!this.updateMeshPropertiesFromIncrement(e))return null;const t=this.getBufferSetIndexForIncrement(e.getFullId());if(t>=0&&!this.bufferSets[t].hasOptimizedBuffers()){this.bufferSets[t].deleteIncrement(e.getFullId())}let i=null,s=-1;for(let t=0;t<this.bufferSets.length;++t){if(this.bufferSets[t].hasOptimizedBuffers())continue;if(i=this.bufferSets[t].incorporateIncrement(e),i){s=t;break}}if(s<0){const t=new LS(this);i=t.incorporateIncrement(e),i?(s=this.bufferSets.length,this.bufferSets.push(t)):It.log.warn("A new buffer set failed to incorporate a single mesh increment")}return s>=0&&this.incrementToBufferSetIndex.insert(e.getFullId(),s),this.setBuffersNeedCompilation(),i}updateMeshPropertiesFromIncrement(e){if(this.primitiveType===_i.MX.PRIMITIVE_UNKNOWN)this.primitiveType=e.primitiveType;else if(this.primitiveType!==e.primitiveType)return It.log.warn("Tried to add two different increment types to the same mesh."),!1;const t=e.getVertexSize();if(this.vertexSize){if(this.vertexSize!==t)return It.log.warn("Encountered primitives with different sized vertices in the same mesh"),!1}else this.vertexSize=t;return!0}getIncrementDetails(e){const t=this.getBufferSetIndexForIncrement(e);if(t<0||this.bufferSets[t].hasOptimizedBuffers())return null;return this.bufferSets[t].getIncrementDetails(e)}deleteIncrement(e){const t=this.getBufferSetIndexForIncrement(e);let i=null;if(t<0||this.bufferSets[t].hasOptimizedBuffers())return null;return i=this.bufferSets[t].deleteIncrement(e),this.incrementToBufferSetIndex.remove(e),this.setBuffersNeedCompilation(),i}updateIncrementAttribute(e,t,i){const s=this.getBufferSetIndexForIncrement(t);if(s<0||this.bufferSets[s].hasOptimizedBuffers())return;this.bufferSets[s].updateIncrementAttribute(e,t,i),this.setBuffersNeedCompilation()}extractMeshIncrement(e){const t=this.getBufferSetIndexForIncrement(e);if(t<0||this.bufferSets[t].hasOptimizedBuffers())return null;return this.bufferSets[t].getIncrement(e)}compileBuffers(e){if(!this.buffersNeedCompilation)return;const t=new mh.B7("Mesh.compileBuffers");this.buffersNeedCompilation=!1;let i=!1;for(let e=0;e<this.bufferSets.length;++e){if(this.bufferSets[e].hasOptimizedBuffers())continue;const t=this.bufferSets[e];i=t.updateBuffers()||i,this.buffersNeedCompilation=this.buffersNeedCompilation||t.hasBufferUpdates()}e&&i&&e.setLastBufferBound(null),t.report()}copyOptimizedBuffersToGl(e){let t=!1;for(let e=0;e<this.bufferSets.length;++e)this.bufferSets[e].hasOptimizedBuffers()&&(t=this.bufferSets[e].copyBuffersToGl()||t);e&&t&&e.setLastBufferBound(null)}isEmpty(){return this.incrementToBufferSetIndex.isEmpty()}}const RI="element.",wI="elementpreview.",_I="temporary_sketch_component.",NI="partStudio.",bI="assembly.",LI="occurrence",FI="",xI={bufferAllocationPolicy:CI.MAXIMUM};function BI(e,t,i){const s=e.getMeshIncrement(),n=s?s.clone():GI(e);return n&&(t&&(n.id=t),n.pickId=i),n}function UI(e,t){let i="";switch(e){case W.FVx.RED:i="CPP_RED";break;case W.FVx.GREEN:i="CPP_GREEN";break;case W.FVx.BLUE:i="CPP_BLUE";break;case W.FVx.CYAN:i="CPP_CYAN";break;case W.FVx.YELLOW:i="CPP_YELLOW";break;case W.FVx.MAGENTA:i="CPP_MAGENTA";break;case W.FVx.BLACK:i="CPP_BLACK";break;case W.FVx.TRANSLUCENT_PURPLE:i="CPP_TRANSLUCENT_PURPLE";break;case W.FVx.FEATURE_ERROR:case W.FVx.FEATURE_DEBUG:i="FEATURE_ERROR_GRAPHIC_COLOR";break;case W.FVx.TRANSLUCENT_GREEN:i="CPP_TRANSLUCENT_GREEN";break;case W.FVx.TRANSLUCENT_BLUE:i="CPP_TRANSLUCENT_BLUE";break;case W.FVx.TRANSLUCENT_CYAN:i="CPP_TRANSLUCENT_CYAN";break;case W.FVx.TRANSLUCENT_YELLOW:i="CPP_TRANSLUCENT_YELLOW";break;case W.FVx.TRANSLUCENT_BLACK:i="CPP_TRANSLUCENT_BLACK";break;case W.FVx.TRANSLUCENT_ORANGE:i="CPP_TRANSLUCENT_ORANGE";break;default:i="CPP_RED"}const s=q.default.getManager().getColor(i);return e!==W.FVx.FEATURE_ERROR||t!==_i.MX.POINTS&&t!==_i.MX.LINES?s:[s[0],s[1],s[2],1]}const VI=function(e){let t=null;if(e&&e.length>1){const i=new Float32Array(e.buffer,0,6),s=new Uint16Array(e.buffer,24);t=new Float32Array(s.length);const n=(i[3]-i[0])/65535,r=(i[4]-i[1])/65535,a=(i[5]-i[2])/65535,o=i[0],h=i[1],c=i[2];for(let e=0;e<s.length;e+=3)t[e+0]=o+n*s[e+0],t[e+1]=h+r*s[e+1],t[e+2]=c+a*s[e+2]}return t};function GI(e){let t=null;switch(e.getMessageName()){case"display.GBTEntityFace":const i=e;if(i.decompress(),!i.points||!i.indices||!i.normals)return null;t=new jE(_i.MX.TRIANGLE_STRIP,i.points,i.indices),t.normals=i.normals;break;case"display.GBTEntityEdge":const s=e;if((!s.points||s.points.length<6)&&(!s.compressedPoints||s.compressedPoints.length<6))return null;s.compressedPoints&&s.compressedPoints.length>1&&(s.points=VI(s.compressedPoints),s.compressedPoints=new Uint8Array(0));const n=Math.floor(s.points.length/3)-1,r=new Int32Array(2*n);for(let e=0;e<n;++e)r[2*e]=e,r[2*e+1]=e+1;t=new jE(_i.MX.LINES,s.points,r,void 0,!0);break;case"display.GBTEntityPoint":case"display.GBTEntityDegenerateEdge":const a=e;if(!a.point)return null;t=new jE(_i.MX.POINTS,a.point,[0],void 0,!0);break;case"display.GBTFeatureEntity":case"display.GBTConstructionPlaneEntity":case"display.GBTBodyEntity":case"display.GBTPointEntity":case"display.GBTOriginEntity":case"display.GBTMateConnectorEntity":case"display.GBTSketchEntity":const o=e;t=o.getGeometry()?GI(o.getGeometry()):null;break;case"display.GBTDebugGeometry":const h=e;if(!h.tessellation)return null;if(t=GI(h.tessellation),h.style!==W.$76.ERROR){Uu(UI(h.color,t.primitiveType),t),t.primitiveType===_i.MX.POINTS&&(h.style===W.$76.STAR?(ku(q.default.getManager().getPointFont("STAR_POINT"),t),Hu(q.default.getManager().getNumber("STAR_POINT_SIZE"),t)):Hu(q.default.getManager().getNumber("DEBUG_POINT_SIZE"),t))}}return t}function HI(e){switch(e.getEntityType()){case W.ZSW.VERTEX:return _i.MX.POINTS;case W.ZSW.EDGE:return _i.MX.LINES;case W.ZSW.FACE:return _i.MX.TRIANGLE_STRIP;case W.ZSW.DEGENERATE_EDGE:return _i.MX.POINTS}return _i.MX.PRIMITIVE_UNKNOWN}function kI(e,t,i){if(!e)return[];let s;return i?(s=[],e.each((function(e,n){return i(t[n])&&s.push(n),!1}))):s=e.getKeys(),s}function WI(e){return!!e&&-1!==e.indexOf(".")}const zI={mouseup:"mouseup"};class XI{constructor(e,t){this.element=e,this.firstMiddleMouseButtonUp=!1,this.timeOfFirstMiddleMouseUp=-1,this.elementDoubleClickHandler=t,this.mouseUpHandler=e=>this.MouseUpHandler(e),this.setupEventHandlers()}setupEventHandlers(){this.element&&this.element.on(zI.mouseup,this.mouseUpHandler)}off(){this.element&&this.element.off(zI.mouseup,this.mouseUpHandler)}resetFirstMiddleButtonUpState(){this.firstMiddleMouseButtonUp=!1,this.timeOfFirstMiddleMouseUp=-1}setFirstMiddleButtonUpState(){this.firstMiddleMouseButtonUp=!0,this.timeOfFirstMiddleMouseUp=(0,Js.Wj)()}MouseUpHandler(e){if(e.which!==er.tc.MIDDLE)return void this.resetFirstMiddleButtonUpState();if(!this.firstMiddleMouseButtonUp)return void this.setFirstMiddleButtonUpState();if((0,Js.Es)(this.timeOfFirstMiddleMouseUp)<=q.default.getManager().getNumber("MIDDLE_MOUSE_BUTTON_DOUBLE_CLICK_TIMEOUT"))return this.resetFirstMiddleButtonUpState(),void this.elementDoubleClickHandler(e);this.setFirstMiddleButtonUpState()}}const qI="uielement.";function ZI(e){return!!e&&0===e.indexOf(qI)}function YI(e,t,i,s,n){let r,a=t;for(;t!==i;)if(a=Math.floor(.5*(t+i)),r=e[a][s],n>r)a=t=a+1;else{if(!(n<r))break;i=a}return a}function KI(e,t){if(t.length<1)t.push(e.slice(0));else{const i=YI(t,0,t.length,0,e[0]);let s=!1,n=0,r=e[1];i>0&&t[i-1][1]>=e[0]&&(s=!0,r=Math.max(r,t[i-1][1]));for(let s=i;s<t.length&&t[s][0]<=e[1];++s)++n,r=Math.max(r,t[s][1]);s?(t[i-1][1]=r,t.splice(i,n)):t.splice(i,n,[e[0],r])}}const jI=[0,1];function QI(e,t,i){jI[0]=e,jI[1]=t,KI(jI,i)}function $I(e,t){if(e[0]===e[1])return;const i=YI(t,0,t.length,1,e[0]),s=YI(t,i,t.length,0,e[1]);if(i>=t.length||i===s)return void It.log.warn("Failed to find range to remove");let n=null,r=null;t[i][0]<e[0]&&(n=[t[i][0],e[0]]),t[s-1][1]>e[1]&&(r=[e[1],t[s-1][1]]),n&&r?t.splice(i,s-i,n,r):n?t.splice(i,s-i,n):r?t.splice(i,s-i,r):t.splice(i,s-i)}function JI(e,t){let i=0;for(let s=0;s<t.length;++s){const n=t[s],r=n[0]-i,a=n[1]-n[0];e.splice(r,a),i+=a}}const eE=q.default.getManager(),tE="uViewport",iE="uBlitTextureOffset",sE=-1,nE=[0,0],rE=[1,1];let aE=!1;class oE extends m.T{constructor(e){super(),this.viewer=e,this.MAXIMUM_Z_OFFSET=eE.getNumber("MAXIMUM_Z_OFFSET"),this.activeShader=null,this.shaderStack=[],this.modelViewMatrixStack=[],this.projectionMatrixStack=[],this.viewport=[0,0,1,1],this.viewportStack=[],this.materialPushedShaderStack=[!1],this.activePass=null,this.lastPolygonOffsetFactor=NaN,this.lastPolygonOffsetUnits=NaN,this.overridePolygonOffset=!1,this.lastCullFace=null,this.pickBackFaces=!1,this.pickPrimitiveAlternates=!1,this.baseHighlightsEnabled=!0,this.activeCamera=null,this.isPickingHiddenOccurrences=!1,this.useHiddenOpacityForEdgeHighlights=!1,this.frameId=0,this.lastBufferBound=null,this.lastStyleApplied=new fE,this.hasIsolate=!1,this.nodeOccurrenceFilterFunction=null,this.isWebXrEnabled=!1,(0,Ih.Yk)(e),this.state=new di,this.modelViewMatrix=ge.create(),this.projectionMatrix=ge.create(),this.materialStack=[zi],this.overrideFaceCullingMode=Rh.UNSPECIFIED,this.renderingMode=W.P1.SHADED_WITH_EDGES,this.detailSettings=new ua,this.listenTo(this.viewer.getEventDispatcher(),VM.cW,this.onGlContextLost),this.listenTo(this.viewer.getEventDispatcher(),VM.b3,this.onDevicePixelRatioChanged),ps.Jq.CapabilitiesService.isWebxrEnabled().then((e=>{this.isWebXrEnabled=e}))}onNewContext(e){this.state.setGlContext(e),this.setFacesToCull(Rh.BACK)}onDevicePixelRatioChanged(e){if(this.activeShader){const e=(0,Es.x_)();this.activeShader.uniform1f("uDevicePixelRatio",e)}}destroy(){this.stopListening()}onGlContextLost(){this.activeShader=null}setOccurrencePickId(e){this.activeShader&&this.activeShader.uniform4fv("uOccurrencePickId",e)}getViewer(){return this.viewer}setActiveCamera(e){this.activeCamera=e}getActiveCamera(){return this.activeCamera}getState(){return this.state}pushModelViewMatrix(e){this.modelViewMatrixStack.push(this.modelViewMatrix),this.modelViewMatrix=e}getModelViewMatrix(){return this.modelViewMatrix}popModelViewMatrix(){0!==this.modelViewMatrixStack.length?this.modelViewMatrix=this.modelViewMatrixStack.pop():It.log.warn("Tried to pop modelview matrix from stack with zero length")}updateModelviewUniforms(){const e=this.activeShader;e&&e.uniformMatrix4fv("uMVMatrix",!1,this.modelViewMatrix)}pushProjectionMatrix(e){this.projectionMatrixStack.push(this.projectionMatrix),this.projectionMatrix=e,this.updateProjectionUniforms()}updateProjectionUniforms(){this.activeShader&&(this.activeShader.uniformMatrix4fv("uPMatrix",!1,this.projectionMatrix),this.activeShader.uniformMatrix4fv("uPMatrix_fs",!1,this.projectionMatrix))}getProjectionMatrix(){return this.projectionMatrix}popProjectionMatrix(){0!==this.projectionMatrixStack.length?(this.projectionMatrix=this.projectionMatrixStack.pop(),this.updateProjectionUniforms()):It.log.warn("Tried to pop projection matrix from stack with zero length")}updateViewportUniforms(){const e=this.getActiveShader();if(e&&e.getUniformLocation(tE)&&e.uniform4fv(tE,this.viewport),e&&e.getUniformLocation(iE)){let t=nE,i=rE;this.isWebXrEnabled&&!this.isCustomViewportActive&&(t=$.fromValues(this.viewport[0]/this.viewer.getBaseFrameBufferWidth(),this.viewport[1]/this.viewer.getBaseFrameBufferHeight()),i=$.fromValues(this.viewport[2]/this.viewer.getBaseFrameBufferWidth(),this.viewport[3]/this.viewer.getBaseFrameBufferHeight())),e.uniform2fv(iE,t),e.uniform2fv("uBlitTextureScale",i)}}setViewport(e){this.viewport=e,this.viewer.getGlContext().viewport(e[0],e[1],e[2],e[3]),this.updateViewportUniforms()}pushViewport(e){this.viewportStack.push(this.viewport),this.setViewport(e)}getViewport(){return this.viewport}popViewport(){if(0===this.viewportStack.length)return void It.log.warn("Tried to pop viewport from stack with zero length");const e=this.viewportStack.pop();this.setViewport(e)}get isCustomViewportActive(){return this.viewportStack.length>1}activateShader(e,t){var i;if((null===this.activeShader||!this.activeShader.equals(e))&&(this.activeShader&&this.activeShader.deactivate(),this.lastBufferBound=null,this.defaultStyle=null,this.lastStyleApplied.clear(),this.activeShader=e,t||(this.shaderStack=[this.activeShader]),null!==this.activeShader)){this.lastNormalMatrixComputed=null,this.activeShader.useShader(),this.updateProjectionUniforms(),this.updateModelviewUniforms(),this.updateViewportUniforms();const e=[0,0,0,0],t=[0,0,0,-1],s=[0,0,0,0];this.activeShader.vertexAttrib4fv($d.COLOR,t),this.activeShader.vertexAttrib4fv($d.HIGHLIGHT_ID,e),this.activeShader.vertexAttrib4fv($d.PRIMITIVE_STYLE,s),this.activeShader.vertexAttrib1f($d.OCCURRENCE_ID,0),this.activeShader.uniform2fv("uHighlightPointFont",eE.getPointFont("HIGHLIGHT_POINT_FONT")),this.activeShader.uniform1f("uHighlightPointSizeMin",eE.getNumber("HIGHLIGHT_POINT_SIZE_MIN_PX")),this.activeShader.uniform1f("uHighlightPointSizeScale",eE.getNumber("HIGHLIGHT_POINT_SIZE_SCALE")),this.activeShader.uniform4fv("uHighlightLineStipple",eE.getStipple("HIGHLIGHT_LINE_STIPPLE")),this.activeShader.uniform1f("uHighlightLineWidthMin",eE.getNumber("HIGHLIGHT_LINE_WIDTH_MIN_PX")),this.activeShader.uniform1f("uHighlightLineWidthScale",eE.getNumber("HIGHLIGHT_LINE_WIDTH_SCALE")),this.activeShader.uniform1f("uHighlightCount",this.viewer.getReferenceHighlights().sortedHighlights.length),this.activeShader.uniform4fv("uBackgroundColor",eE.getColor("BACKGROUND_COLOR"));const n=(0,Es.x_)();this.activeShader.uniform1f("uDevicePixelRatio",n),null===(i=this.activePass)||void 0===i||i.onShaderActivated(this,this.activeShader)}}getActiveShader(){return this.activeShader}pushShader(e){this.shaderStack.push(e)}activateTopShader(){this.shaderStack.length>0&&this.activateShader(this.shaderStack[this.shaderStack.length-1],!0)}popShader(){0!==this.shaderStack.length?this.shaderStack.pop():It.log.warn("Tried to pop a shader off of an empty stack")}getExtendedShaderForMaterial(e){const t=e.getExtendedShaderId();if(!t)return null;const i=Af((this.shaderStack.length>0?this.shaderStack[this.shaderStack.length-1]:this.activeShader).getId(),t);return Rf(i)?this.viewer.getShader(i):null}pushMaterial(e){this.materialStack.push(e);const t=this.getExtendedShaderForMaterial(e);t&&this.pushShader(t),this.materialPushedShaderStack.push(!!t)}setMaterial(){this.activeShader&&this.materialStack&&this.materialStack.length>0&&this.materialStack[this.materialStack.length-1].setAttributes(this.activeShader,this)}popMaterial(){if(0===this.materialStack.length)return void It.log.warn("Tried to pop a material off of an empty stack");this.materialStack.pop();this.materialPushedShaderStack.pop()&&this.popShader()}setActivePass(e){this.activePass=e}getActivePass(){return this.activePass}setIsPickingHiddenOccurrences(e){this.isPickingHiddenOccurrences=e}getIsPickingHiddenOccurrences(){return this.isPickingHiddenOccurrences}isPicking(){return!!this.activePass&&this.activePass.isPickPass()}isHighlighting(){return!!this.activePass&&this.activePass.isHighlightPass()}getActiveHighlightType(){return this.activePass?this.activePass.getActiveHighlightType():null}needsAttribute(e){return!!this.activePass&&this.activePass.needsAttribute(e)}getPickPassIteration(){return this.activePass&&this.activePass.isPickPass()?this.activePass.getPickIteration():-1}isShowthrough(){return!!this.activePass&&this.activePass.isShowthroughPass()}setBackFacePicking(e){this.pickBackFaces=e}isPickingBackFaces(){return this.isPicking()&&this.pickBackFaces}setOverrideFaceCullingMode(e){this.overrideFaceCullingMode=e}clearOverrideFaceCullingMode(){this.overrideFaceCullingMode=Rh.UNSPECIFIED}nodeFilter(e){return!0}setZOffset(e){const t=e/this.MAXIMUM_Z_OFFSET;this.setPolygonOffset(t,e)}setOverridePolygonOffset(e,t){this.overridePolygonOffset=!1,this.setPolygonOffset(e,t),this.overridePolygonOffset=!0}clearOverridePolygonOffset(){this.overridePolygonOffset=!1}setPolygonOffset(e,t){if(this.overridePolygonOffset||e===this.lastPolygonOffsetFactor&&t===this.lastPolygonOffsetUnits)return;const i=this.viewer.getGlContext();0===e&&0===t?i.disable(i.POLYGON_OFFSET_FILL):(i.polygonOffset(e,t),i.enable(i.POLYGON_OFFSET_FILL)),this.lastPolygonOffsetFactor=e,this.lastPolygonOffsetUnits=t}setFacesToCull(e){if(this.lastCullFace===e)return;let t=e;this.overrideFaceCullingMode!==Rh.UNSPECIFIED&&(t=this.overrideFaceCullingMode);const i=this.viewer.getGlContext();Rh.BACK===t?(i.enable(i.CULL_FACE),i.cullFace(i.BACK)):Rh.FRONT===t?(i.enable(i.CULL_FACE),i.cullFace(i.FRONT)):Rh.NONE===t?i.disable(i.CULL_FACE):It.log.error("Unknown face culling parameter: "+t)}setPointSize(e){this.setPrimitiveSize(e)}setPointFont(e){this.setPrimitiveStyle([e[0],e[1],0,0])}setLineWidth(e){this.setPrimitiveSize(e)}setLineStipple(e){this.setPrimitiveStyle(e)}setPrimitiveSize(e){const t=this.getActiveShader();t&&t.vertexAttrib1f($d.PRIMITIVE_SIZE,e)}setPrimitiveStyle(e){const t=this.getActiveShader();t&&t.vertexAttrib4fv($d.PRIMITIVE_STYLE,e)}setPickPrimitiveAlternates(e){this.pickPrimitiveAlternates=e}getPickPrimitiveAlternates(){return this.pickPrimitiveAlternates}setBaseHighlightsEnabled(e){this.baseHighlightsEnabled=e}getBaseHighlightsEnabled(){return this.baseHighlightsEnabled}setUseHiddenOpacityForEdgeHighlights(e){this.useHiddenOpacityForEdgeHighlights=e}getUseHiddenOpacityForEdgeHighlights(){return this.useHiddenOpacityForEdgeHighlights}prepareForNextFrame(){this.frameId<Li.s9?this.frameId+=1:this.frameId=0,this.hasIsolate=this.viewer.getIsolatedOccurrenceManager().hasIsolatedInstances(),!aE&&this.materialStack.length>5&&(It.log.warn("Material stack has grown unexpectedly long"),aE=!0)}getFrameId(){return this.frameId}getHasIsolate(){return this.hasIsolate}setRenderingMode(e){this.renderingMode=e}setDetailSettings(e){this.detailSettings=e}getDetailSettings(){return this.detailSettings}setUsage(e){this.usage=e}getUsage(){return this.usage}getLastBufferBound(){return this.lastBufferBound}setLastBufferBound(e){this.lastBufferBound=e}applyStyle(e){e&&!EE(e,this.lastStyleApplied)&&e.applyStyle(this),e?this.lastStyleApplied.copyFrom(e):this.lastStyleApplied.clear()}activePassNeedsIsolationTest(){return!!this.activePass&&this.activePass.testIsolation(this)}activePassIsForIsolate(){return!!this.activePass&&this.activePass.forIsolate()}activePassIsForSectionPlaneEndcapMask(){return!!this.activePass&&this.activePass.forSectionPlaneEndcapMask()}setNodeOccurrenceFilterFunction(e){this.nodeOccurrenceFilterFunction=e}doesNodeOcccurrencePassFilter(e){return!this.nodeOccurrenceFilterFunction||this.nodeOccurrenceFilterFunction(e)}activePassNeedsFaceAppearances(){return!this.activePass||this.activePass.needsFaceAppearances()}}var hE=i(78975);class cE{constructor(){this.mouseKeyFlags={},this.mouseKeyManipulationModeBinding={},this.hasShiftKeyBinding=!1,this.hasControlKeyBinding=!1,this.hasAltKeyBinding=!1,this.mouseKeyFlags[er.tc.MIDDLE]=1,this.mouseKeyFlags[er.tc.RIGHT]=2,this.mouseKeyFlags[Os.R8.SHIFT]=4,this.mouseKeyFlags[Os.R8.CONTROL]=8,this.mouseKeyFlags[Os.R8.ALT]=16}getMouseKeyCombinationID(e,t){let i=0,s=0;for(s=0;s<e.length;++s)i|=this.mouseKeyFlags[e[s]];for(s=0;s<t.length;++s)i|=this.mouseKeyFlags[t[s]];return i}clearMouseKeyManipulationBindings(){this.mouseKeyManipulationModeBinding={},this.hasShiftKeyBinding=!1,this.hasControlKeyBinding=!1,this.hasAltKeyBinding=!1}addMouseKeyManipulationModeBinding(e,t,i){const s=this.getMouseKeyCombinationID(e,t);s>0&&(this.mouseKeyManipulationModeBinding[s]=i,this.hasControlKeyBinding||(this.hasControlKeyBinding=0!=(s&this.mouseKeyFlags[Os.R8.CONTROL])),this.hasShiftKeyBinding||(this.hasShiftKeyBinding=0!=(s&this.mouseKeyFlags[Os.R8.SHIFT])),this.hasAltKeyBinding||(this.hasAltKeyBinding=0!=(s&this.mouseKeyFlags[Os.R8.ALT])))}getManipulationMode(e,t){return this.mouseKeyManipulationModeBinding[this.getMouseKeyCombinationID(e,t)]}isManipulationModeEnabled(e,t,i){const s=this.getMouseKeyCombinationID(t,i);for(const t in this.mouseKeyManipulationModeBinding){const i=parseInt(t,10);if(this.mouseKeyManipulationModeBinding[i]===e){if((s&i)===i)return!0}}return!1}getClosestMode(e,t,i){let s=FD.k.NONE,n=0;for(const r in this.mouseKeyManipulationModeBinding){const a=parseInt(r,10),o=this.mouseKeyManipulationModeBinding[a];o!==i&&(this.isManipulationModeEnabled(o,e,t)&&a>n&&(n=a,s=o))}return s}usesShiftKey(){return this.hasShiftKeyBinding}usesControlKey(){return this.hasControlKeyBinding}usesAltKey(){return this.hasAltKeyBinding}}let lE=null;function uE(){return lE||(lE=new cE,lE.addMouseKeyManipulationModeBinding([er.tc.RIGHT],[],FD.k.ROTATE),lE.addMouseKeyManipulationModeBinding([er.tc.RIGHT],[Os.R8.ALT],FD.k.AXIS_ROTATE),lE.addMouseKeyManipulationModeBinding([er.tc.RIGHT],[Os.R8.CONTROL],FD.k.PAN),lE.addMouseKeyManipulationModeBinding([er.tc.MIDDLE],[],FD.k.PAN)),lE}function dE(e,t){if(t.length<1)t.push(e.slice(0));else{const i=YI(t,0,t.length,0,e[0]);let s,n=!1,r=0,a=e[1];if(i>0){const r=t[i-1];r[1]>=e[0]&&(EE(r[2],e[2])?(n=!0,a=Math.max(a,r[1])):(r[1]>a&&(s=[e[1],r[1],r[2]]),r[1]=e[0]))}for(let s=i;s<t.length;++s){const i=t[s];if(!(i[0]<=e[1]))break;i[1]<=e[1]?++r:EE(i[2],e[2])?(++r,a=Math.max(a,i[1])):i[0]<a&&(i[0]=a)}n?(t[i-1][1]=a,t.splice(i,r)):s?t.splice(i,r,[e[0],a,e[2]],s):t.splice(i,r,[e[0],a,e[2]])}}function gE(e,t){if(e[0]===e[1])return;const i=YI(t,0,t.length,1,e[0]),s=YI(t,i,t.length,0,e[1]);if(i>=t.length||i===s)return;let n=null,r=null;t[i][0]<e[0]&&(n=[t[i][0],e[0],t[i][2]]),t[s-1][1]>e[1]&&(r=[e[1],t[s-1][1],t[s-1][2]]),n&&r?t.splice(i,s-i,n,r):n?t.splice(i,s-i,n):r?t.splice(i,s-i,r):t.splice(i,s-i)}function pE(e){return 0===e.length?"[]":"[["+e.join("],[")+"]]"}function mE(e){const t=new Array(e.length);for(let i=0;i<e.length;++i)t[i]=e[i].slice();return t}class fE{constructor(){this.attributeSettings=new Gi.N,this.floatUniformSettings=new Gi.N}copyFrom(e){this.attributeSettings.setAll(e.attributeSettings),this.floatUniformSettings.setAll(e.floatUniformSettings)}clone(){const e=new fE;return e.copyFrom(this),e}clear(){this.attributeSettings.clear(),this.floatUniformSettings.clear()}equals(e){return!!e&&(this===e||!!IE(this.attributeSettings,e.attributeSettings)&&!!IE(this.floatUniformSettings,e.floatUniformSettings))}setAttribute(e,t){this.attributeSettings.set(e,t)}getAttribute(e){return this.attributeSettings.get(e)}setFloatUniform(e,t){this.floatUniformSettings.set(e,t)}applyStyle(e){const t=e.getActiveShader();if(!t)return;const i=this.attributeSettings.getKeyValues();for(let e=0;e<i.length;e+=2)t.setAttribute(i[e],i[e+1]);const s=this.floatUniformSettings.getKeyValues();for(let e=0;e<s.length;e+=2)t.setFloatUniform(s[e],s[e+1])}toString(){let e="Style: ";const t=this.attributeSettings.getKeyValues(),i=", ";for(let s=0;s<t.length;s+=2){const n=t[s],r=t[s+1];s>0&&(e+=i),e+=n.name+": "+r}t.length>0&&(e+=i);const s=this.floatUniformSettings.getKeyValues();for(let t=0;t<s.length;t+=2)t>0&&(e+=i),e+=s[t]+": "+s[t+1];return e}}function IE(e,t){if(e.size!==t.size)return!1;const i=e.getKeyValues();for(let e=0;e<i.length;e+=2){const s=i[e],n=i[e+1],r=t.get(s);if(n!==r){if(void 0===r)return!1;if(void 0===n.length&&void 0===r.length)return!1;if(n.length!==r.length)return!1;for(let e=0;e<n.length;++e)if(n[e]!==r[e])return!1}}return!0}function EE(e,t){return e&&t?e.equals(t):!(e||t)}function SE(e,t,i){return e?t?(i.clear(),i.copyFrom(e),i.copyFrom(t),i):e:t}class TE{constructor(){this.resultRange1=[0,0,null],this.resultRange2=[0,0,null],this.nextResult=null}hasMoreRanges(){return!!this.nextResult}getNextRange(){const e=this.nextResult;return this.nextResult=this.findNextRange(),e}getStorageForNextResult(){const e=this.nextResult===this.resultRange1?this.resultRange2:this.resultRange1;return e[2]=null,e}}class ME extends TE{constructor(e){super(),this.styleMergeStorage=[],this.currentStyleMergeStoragePointer=0;for(let t=0;t<e;++t)this.styleMergeStorage.push(new fE)}getStyleMergeStorage(){const e=this.styleMergeStorage[this.currentStyleMergeStoragePointer];return this.currentStyleMergeStoragePointer=(this.currentStyleMergeStoragePointer+1)%this.styleMergeStorage.length,e}}class CE extends ME{constructor(){super(2),this.baseIterator=null,this.resetStyle=null}setResetStyle(e){this.resetStyle=e}reset(e){return this.baseIterator=e,this.nextResult=this.findNextRange(),this}findNextRange(){const e=this.baseIterator.getNextRange();if(!e)return null;const t=this.getStorageForNextResult();return t[0]=e[0],t[1]=e[1],t[2]=SE(e[2],this.resetStyle,this.getStyleMergeStorage()),t}}class DE{constructor(){this.operand=null,this.iterator=new CE}setResetStyle(e){this.iterator.setResetStyle(e)}setOperand(e){this.operand=e}getRangeIteratorForBufferSet(e){if(!this.operand)return null;const t=this.operand.getRangeIteratorForBufferSet(e);return t?this.iterator.reset(t):null}makeSceneDebugObject(){const e={text:"StyleResetOperator",children:[]};return(0,Js.n9)(e,this.operand),e}}const vE=new DE;class PE{constructor(e,t,i,s,n){this.parent=e,this.style=t,this.meshRanges=i,this.styleOverrideRanges=s,this.styleOverrideOperator=null,this.meshRangeGroupIdHash=null,this.meshRanges.addBoundable(this),n&&(this.rangeSkipOperator=new XS,this.rangeSkipOperator.setSubtrahend(n))}destroy(){this.meshRanges.removeBoundable(this)}getMeshRanges(){return this.meshRanges}getMeshRangesGroupIdHash(){if(this.meshRangeGroupIdHash)return this.meshRangeGroupIdHash;const e=this.getMeshRangesGroupId();if(e){this.meshRangeGroupIdHash=0;for(let t=0;t<e.length;t++)this.meshRangeGroupIdHash+=e.charCodeAt(t)}return this.meshRangeGroupIdHash}getMeshRangesGroupId(){return this.meshRanges.getMeshGroupId()}draw(e,t){if(!this.meshRanges.shouldDrawForOccurrences(t))return;e.applyStyle(this.style);let i=t.getMeshRangeOperator(e);i!==AE&&(i&&i.setOperand(this.meshRanges),this.rangeSkipOperator&&(this.rangeSkipOperator.setOperand(i||this.meshRanges),i=this.rangeSkipOperator),e.activePassNeedsFaceAppearances()&&this.styleOverrideRanges&&(this.styleOverrideOperator||(this.styleOverrideOperator=new rS,this.styleOverrideOperator.setOverwriteOperand(this.styleOverrideRanges),this.styleOverrideOperator.setDefaultStyle(this.style)),this.styleOverrideOperator.setOperand(i||this.meshRanges),i=this.styleOverrideOperator),e.activePassNeedsFaceAppearances()||(vE.setOperand(i||this.meshRanges),vE.setResetStyle(this.style),i=vE),this.meshRanges.draw(e,i))}isCheaplyBoundable(){return this.meshRanges.isCheaplyBoundable()}damageBounds(){this.parent.damageBounds()}getBounds(e,t){return this.meshRanges.getBounds(e,t)}makeSceneDebugObject(e){let t="Styled mesh range: (style: "+this.style+")";const i=[this.meshRanges.makeSceneDebugObject(e)];return this.styleOverrideRanges&&(i.push(this.styleOverrideRanges.makeSceneDebugObject()),t+=", with style overrides"),{text:t,children:i}}}class yE{getRangeIteratorForBufferSet(e){return null}setOperand(e){}makeSceneDebugObject(){return{text:"NoRangeOperator",children:[]}}}const AE=new yE,OE=Jd,RE={globallyUniqueId:!0,pickId:!0,properties:!0},wE=Mh.create(),_E=ge.create(),NE=v.create(),bE=v.create();Math.pow(2,16);function LE(e,t){return t?t+"."+e:e}let FE=1;const xE=function(e,t,i,s,n,r,a,o,h,c,l,u,d,g){return t[3*e+0]=o[0],t[3*e+1]=o[1],t[3*e+2]=o[2],h&&(i[3*e+0]=h[0],i[3*e+1]=h[1],i[3*e+2]=h[2]),c&&(s[4*e+0]=c[0],s[4*e+1]=c[1],s[4*e+2]=c[2],s[4*e+3]=c[3]),null!==l&&(n[e]=l),u&&(r[4*e+0]=u[0],r[4*e+1]=u[1],r[4*e+2]=u[2],r[4*e+3]=u[3]),a[4*e+0]=d[0],a[4*e+1]=d[1],a[4*e+2]=d[2],a[4*e+3]=g,e+1},BE=v.create(),UE=v.create(),VE=v.create(),GE=v.create(),HE=P.create(),kE=P.create(),WE=v.create(),zE=v.create(),XE=P.create(),qE=P.create(),ZE=v.create(),YE=v.create(),KE=v.create();class jE{constructor(e,t,i,s,n){this.primitiveType=e,this.points=t,this.properties={},this.id=s||"",this.indices=i,n||this.prepareForBuffering()}clone(e){const t=new jE(this.primitiveType,this.points,this.indices,this.id,!0);(0,Q.overwriteMatchingProperties)(t,this,RE);for(const e in this.properties)RE[e]||(t.properties[e]=this.properties[e]);return e&&(t.ownerId=e),t}setProperty(e,t){null==t?delete this.properties[e]:this.properties[e]=t}set indices(e){this.setProperty("indices",e)}get indices(){return this.properties.indices||null}set normals(e){this.setProperty("normals",e)}get normals(){return this.properties.normals||null}set offsetVectors(e){this.setProperty("offsetVectors",e)}get offsetVectors(){return this.properties.offsetVectors||null}set colors(e){this.setProperty("colors",e)}get colors(){return this.properties.colors||null}set textureCoordinates(e){this.setProperty("textureCoordinates",e)}get textureCoordinates(){return this.properties.textureCoordinates||null}set primitiveSizes(e){this.setProperty("primitiveSizes",e)}get primitiveSizes(){return this.properties.primitiveSizes||null}set primitiveStyles(e){this.setProperty("primitiveStyles",e)}get primitiveStyles(){return this.properties.primitiveStyles||null}set contactTraction(e){this.setProperty("contactTraction",e)}get contactTraction(){return this.properties.contactTraction||null}set contactPairCoordinate(e){this.setProperty("contactPairCoordinate",e)}get contactPairCoordinate(){return this.properties.contactPairCoordinate||null}set pointData(e){this.setProperty("pointData",e)}get pointData(){return this.properties.pointData||null}set edgeData(e){this.setProperty("edgeData",e)}get edgeData(){return this.properties.edgeData||null}set pickId(e){this.setProperty("pickId",e)}get pickId(){return this.properties.pickId||void 0}set groupId(e){this.setProperty("groupId",e)}get groupId(){return this.properties.groupId||""}set ownerId(e){this.setProperty("ownerId",e)}get ownerId(){return this.properties.ownerId||""}set boundingBox(e){this.setProperty("boundingBox",e)}get boundingBox(){return this.properties.boundingBox||null}set globallyUniqueId(e){this.setProperty("globallyUniqueId",e)}get globallyUniqueId(){return this.properties.globallyUniqueId||null}set lod(e){this.setProperty("lod",e)}get lod(){return this.properties.lod||eg.DEFAULT}getFullId(){return LE(this.id,this.ownerId)}getFullGroupId(){return LE(this.groupId,this.ownerId)}getPoint(e,t){const i=3*e;return e<0||i>=this.points.length?null:t?(t[0]=this.points[i],t[1]=this.points[i+1],t[2]=this.points[i+2],t):this.points instanceof Float32Array?this.points.subarray(i,i+3):this.points.slice(i,i+3)}getLinesLength(){if(this.primitiveType!==_i.MX.LINES)return-1;this.isPreparedForBuffering()||this.prepareForBuffering();let e=0;for(let t=0;t<this.indices.length;t+=6)e+=pe.S4.dist(this.getPoint(this.indices[t+0]),this.getPoint(this.indices[t+1]));return e}getPositionAtDistanceAlongLines(e){if(this.primitiveType!==_i.MX.LINES)return null;this.isPreparedForBuffering()||this.prepareForBuffering();let t=0;for(let i=0;i<this.indices.length;i+=6){const s=this.getPoint(this.indices[i+0]),n=this.getPoint(this.indices[i+1]),r=pe.S4.dist(s,n);if(t+r>=e){const i=(e-t)/r;return pe.S4.add(s,pe.S4.scale(pe.S4.subtract(n,s,v.create()),i),v.create())}t+=r}return null}getLineDirection(e){if(!this.isLines())return null;if(this.isPreparedForBuffering()||this.prepareForBuffering(),e<0||6*(e+1)>this.indices.length)return null;const t=6*e,i=pe.S4.subtract(this.getPoint(this.indices[t+1]),this.getPoint(this.indices[t+0]),v.create());return pe.S4.normalize(i)}getRepresentativeDirection(){return this.isLines()?this.getLineDirection(0):this.isTriangles()&&this.normals&&this.normals.length>=3?this.normals instanceof Float32Array?this.normals.subarray(0,3):this.normals.slice(0,3):null}equals(e){return!(!e||this.primitiveType!==e.primitiveType)&&(this.id===e.id&&(0,pi.arraysEqual)(this.pickId,e.pickId)&&(0,pi.arraysEqual)(this.points,e.points)&&(0,pi.arraysEqual)(this.indices,e.indices)&&(0,pi.arraysEqual)(this.normals,e.normals)&&(0,pi.arraysEqual)(this.offsetVectors,e.offsetVectors)&&(0,pi.arraysEqual)(this.colors,e.colors)&&(0,pi.arraysEqual)(this.textureCoordinates,e.textureCoordinates)&&(0,pi.arraysEqual)(this.primitiveSizes,e.primitiveSizes)&&(0,pi.arraysEqual)(this.primitiveStyles,e.primitiveStyles)&&(0,pi.arraysEqual)(this.pointData,e.pointData)&&(0,pi.arraysEqual)(this.edgeData,e.edgeData))}getBounds(){if(!this.boundingBox){this.boundingBox=new Li.kB;for(let e=0;e<this.points.length;e+=3)this.boundingBox.addXYZ(this.points[e],this.points[e+1],this.points[e+2])}return this.boundingBox}getGloballyUniqueId(){return this.globallyUniqueId||(this.globallyUniqueId=FE,FE+=1),this.globallyUniqueId}isPreparedForBuffering(){return this.isTriangles()||this.isPoints()&&!!this.pointData||this.isLines()&&!!this.edgeData}hasAttribute(e){return!!(this.isLines()&&"edgeData"===e||this.isPoints()&&"pointData"===e)||!!this[e]}getPrimitiveType(){return this.primitiveType}prepareForBuffering(){this.points&&this.indices&&!this.pointData&&this.isPoints()&&this.createPointData(),this.points&&this.indices&&!this.edgeData&&this.isLines()&&this.createEdgeData()}isPoints(){return this.primitiveType===_i.MX.POINTS}isLines(){return this.primitiveType===_i.MX.LINES||this.primitiveType===_i.MX.INFINITE_LINES||this.primitiveType===_i.MX.SILHOUETTES}isTriangles(){return this.primitiveType===_i.MX.TRIANGLES||this.primitiveType===_i.MX.TRIANGLE_STRIP}getTriangleCount(){return this.primitiveType===_i.MX.TRIANGLES?this.indices.length/3:this.primitiveType===_i.MX.TRIANGLE_STRIP?this.indices.length-2:0}getLineCount(){return this.isLines()?this.isPreparedForBuffering()?this.indices.length/6:this.indices.length/2:0}createPointData(){const e=this.indices.length,t=4*e,i=6*e,s=new Float32Array(OE.POINT.dimension*t),n=new Int32Array(i),r=this.colors?new Uint8Array(OE.COLOR.dimension*t):null,a=this.primitiveSizes?new Float32Array(OE.PRIMITIVE_SIZE.dimension*t):null,o=this.primitiveStyles?new Uint8Array(OE.PRIMITIVE_STYLE.dimension*t):null,h=new Float32Array(OE.POINT_DATA.dimension*t);let c=0;const l=function(e,t,i,n,l){s[3*c+0]=e[0],s[3*c+1]=e[1],s[3*c+2]=e[2],t&&(r[4*c+0]=t[0],r[4*c+1]=t[1],r[4*c+2]=t[2],r[4*c+3]=t[3]),null!==i&&(a[c]=i),n&&(o[4*c+0]=n[0],o[4*c+1]=n[1],o[4*c+2]=n[2],o[4*c+3]=n[3]),h[c]=l,c+=1};let u=0;for(let t=0;t<e;++t){const e=this.indices[t],i=[this.points[3*e+0],this.points[3*e+1],this.points[3*e+2]];let s=null;if(this.colors){s=[this.colors[4*e+0],this.colors[4*e+1],this.colors[4*e+2],this.colors[4*e+3]]}let r=null;this.primitiveSizes&&(r=this.primitiveSizes[4*e]);let a=null;if(this.primitiveStyles){a=[this.primitiveStyles[4*e+0],this.primitiveStyles[4*e+1],this.primitiveStyles[4*e+2],this.primitiveStyles[4*e+3]]}l(i,s,r,a,1),l(i,s,r,a,2),l(i,s,r,a,3),l(i,s,r,a,4),n[6*t+0]=u+0,n[6*t+1]=u+1,n[6*t+2]=u+2,n[6*t+3]=u+0,n[6*t+4]=u+2,n[6*t+5]=u+3,u+=4}this.points=s,this.indices=n,this.colors=r,this.primitiveSizes=a,this.primitiveStyles=o,this.pointData=h,this.normals=null,this.textureCoordinates=null}createEdgeData(){this.indices.length%2!=0&&It.log.warn("Trying to create lines with an odd number of indices");const e=Math.floor(this.indices.length/2),t=4*e,i=6*e,s=new Float32Array(OE.POINT.dimension*t),n=new Int32Array(i),r=this.normals?new Float32Array(OE.NORMAL.dimension*t):null,a=this.colors?new Uint8Array(OE.COLOR.dimension*t):null,o=this.primitiveSizes?new Float32Array(OE.PRIMITIVE_SIZE.dimension*t):null,h=this.primitiveStyles?new Uint8Array(OE.PRIMITIVE_STYLE.dimension*t):null,c=new Float32Array(OE.EDGE_DATA.dimension*t);let l=0,u=0,d=1;for(let t=0;t<e;++t){const e=this.indices[2*t+0],i=v.set(VE,this.points[3*e+0],this.points[3*e+1],this.points[3*e+2]),g=this.normals?v.set(GE,this.normals[3*e+0],this.normals[3*e+1],this.normals[3*e+2]):null,p=this.colors?P.set(HE,this.colors[4*e+0],this.colors[4*e+1],this.colors[4*e+2],this.colors[4*e+3]):null,m=this.primitiveSizes?this.primitiveSizes[e]:null,f=this.primitiveStyles?P.set(kE,this.primitiveStyles[4*e+0],this.primitiveStyles[4*e+1],this.primitiveStyles[4*e+2],this.primitiveStyles[4*e+3]):null,I=this.indices[2*t+1];let E=v.set(WE,this.points[3*I+0],this.points[3*I+1],this.points[3*I+2]);const S=this.normals?v.set(zE,this.normals[3*I+0],this.normals[3*I+1],this.normals[3*I+2]):null,T=this.colors?P.set(XE,this.colors[4*I+0],this.colors[4*I+1],this.colors[4*I+2],this.colors[4*I+3]):null,M=this.primitiveSizes?this.primitiveSizes[I]:null,C=this.primitiveStyles?P.set(qE,this.primitiveStyles[4*I+0],this.primitiveStyles[4*I+1],this.primitiveStyles[4*I+2],this.primitiveStyles[4*I+3]):null,D=pe.S4.subtract(E,i,BE),y=pe.S4.length(D);pe.S4.normalize(D);let A=d;d+=y;let O=d;this.primitiveType===_i.MX.INFINITE_LINES&&(A=-A,O=-O,E=i),l=xE(l,s,r,a,o,h,c,i,g,p,m,f,pe.S4.scale(D,1,UE),A),l=xE(l,s,r,a,o,h,c,E,S,T,M,C,pe.S4.scale(D,2,UE),O),l=xE(l,s,r,a,o,h,c,E,S,T,M,C,pe.S4.scale(D,3,UE),O),l=xE(l,s,r,a,o,h,c,i,g,p,m,f,pe.S4.scale(D,4,UE),A),n[6*t+0]=u+0,n[6*t+1]=u+1,n[6*t+2]=u+2,n[6*t+3]=u+0,n[6*t+4]=u+2,n[6*t+5]=u+3,u+=4}this.points=s,this.indices=n,this.normals=r,this.colors=a,this.primitiveSizes=o,this.primitiveStyles=h,this.edgeData=c,this.textureCoordinates=null}createTransformed(e){let t;const i=[0,0,0],s=pe.w$.toMat3(pe.w$.toRotationMat(e,_E),wE),n=this.clone();for(n.boundingBox=null,n.points=new Float32Array(n.points.length),t=0;t<this.points.length;t+=3)i[0]=this.points[t],i[1]=this.points[t+1],i[2]=this.points[t+2],pe.w$.multiplyVec3(e,i),n.points[t]=i[0],n.points[t+1]=i[1],n.points[t+2]=i[2];function r(e){const n=new Float32Array(e.length);for(t=0;t<e.length;t+=3)i[0]=e[t],i[1]=e[t+1],i[2]=e[t+2],pe.xB.multiplyVec3(s,i),pe.S4.normalize(i),n[t]=i[0],n[t+1]=i[1],n[t+2]=i[2];return n}if(this.normals&&(n.normals=r(this.normals)),this.offsetVectors&&(n.offsetVectors=r(this.offsetVectors)),this.edgeData){const e=this.edgeData,r=new Float32Array(n.edgeData.length);for(t=0;t<this.edgeData.length;t+=4){i[0]=e[t],i[1]=e[t+1],i[2]=e[t+2];const n=pe.S4.length(i);pe.xB.multiplyVec3(s,i),pe.S4.scale(i,n/pe.S4.length(i)),r[t]=i[0],r[t+1]=i[1],r[t+2]=i[2],r[t+3]=this.edgeData[t+3]}n.edgeData=r}return n}concatenate(e){if(!(e&&e.primitiveType===this.primitiveType&&(0,Q.objectsDefinedInSameWay)(this.normals,e.normals)&&(0,Q.objectsDefinedInSameWay)(this.offsetVectors,e.offsetVectors)&&(0,Q.objectsDefinedInSameWay)(this.colors,e.colors)&&(0,Q.objectsDefinedInSameWay)(this.textureCoordinates,e.textureCoordinates)&&(0,Q.objectsDefinedInSameWay)(this.primitiveSizes,e.primitiveSizes)&&(0,Q.objectsDefinedInSameWay)(this.primitiveStyles,e.primitiveStyles)&&(0,Q.objectsDefinedInSameWay)(this.edgeData,e.edgeData)&&(0,Q.objectsDefinedInSameWay)(this.pointData,e.pointData)))return null;const t=(0,Js.Mz)(this.points,e.points),i=new Int32Array(this.indexLengthWithDegenerates()+e.indices.length);i.set(this.indices);const s=this.indexLengthWithDegenerates(),n=this.vertexCount();for(let t=0;t<e.indices.length;++t)i[s+t]=e.indices[t]+n;this.primitiveType===_i.MX.TRIANGLE_STRIP&&(i[s-2]=this.indices[this.indices.length-1],this.indices.length%2&&(i[s-3]=this.indices[this.indices.length-1]),i[s-1]=e.indices[0]+n);const r=new jE(this.primitiveType,t,i,void 0,!0);return this.normals&&e.normals&&(r.normals=(0,Js.Mz)(this.points,e.points)),this.colors&&e.colors&&(r.colors=(0,Js.Lf)(this.colors,e.colors)),this.textureCoordinates&&e.textureCoordinates&&(r.textureCoordinates=(0,Js.Mz)(this.textureCoordinates,e.textureCoordinates)),this.primitiveSizes&&e.primitiveSizes&&(r.primitiveSizes=(0,Js.Mz)(this.primitiveSizes,e.primitiveSizes)),this.primitiveStyles&&e.primitiveStyles&&(r.primitiveStyles=(0,Js.Lf)(this.primitiveStyles,e.primitiveStyles)),this.edgeData&&e.edgeData&&(r.edgeData=(0,Js.Mz)(this.edgeData,e.edgeData)),this.pointData&&e.pointData&&(r.pointData=(0,Js.Mz)(this.pointData,e.pointData)),this.offsetVectors&&e.offsetVectors&&(r.offsetVectors=(0,Js.Mz)(this.offsetVectors,e.offsetVectors)),r}indexLengthWithDegenerates(){return this.primitiveType===_i.MX.TRIANGLE_STRIP?this.indices.length%2==0?this.indices.length+2:this.indices.length+3:this.indices.length}vertexCount(){return this.points.length/OE.POINT.dimension}getPreparedVertexCount(){return this.isPreparedForBuffering()?this.vertexCount():4*this.vertexCount()}getPreparedIndexCount(){if(this.isPreparedForBuffering())return this.indexLengthWithDegenerates();if(this.isLines()){return 6*Math.floor(this.indices.length/2)}return this.isPoints()?6*this.indices.length:(It.log.warn("Found unprepared increment that was not lines or points"),this.indexLengthWithDegenerates())}getVertexSize(){let e=0;for(const t in Jd){const i=Jd[t];(this.hasAttribute(i.incrementProperty)||i.name===$d.OCCURRENCE_ID)&&(e+=i.sizeInBytes())}return e}iteratePrimitives(e){switch(this.primitiveType){case _i.MX.POINTS:this.iteratePoints(e);break;case _i.MX.LINES:this.iterateLines(e);break;case _i.MX.TRIANGLES:this.iterateTriangles(e);break;case _i.MX.TRIANGLE_STRIP:this.iterateTriangleStrip(e);break;default:It.log.warn("Cannot iterate over primitive type "+this.primitiveType)}}iteratePoints(e){this.prepareForBuffering();for(let t=0;t<this.indices.length;t+=6)e(this.getPoint(this.indices[t],ZE))}iterateLines(e){this.prepareForBuffering();for(let t=0;t<this.indices.length;t+=6)e(this.getPoint(this.indices[t],ZE),this.getPoint(this.indices[t+1],YE))}iterateTriangles(e){const t=Math.floor(this.indices.length/3);for(let i=0;i<3*t;i+=3)e(this.getPoint(this.indices[i],ZE),this.getPoint(this.indices[i+1],YE),this.getPoint(this.indices[i+2],KE))}iterateTriangleStrip(e){for(let t=0;t<this.indices.length-2;++t)this.indices[t]!==this.indices[t+1]&&this.indices[t]!==this.indices[t+2]&&this.indices[t+1]!==this.indices[t+2]&&(t%2?e(this.getPoint(this.indices[t],ZE),this.getPoint(this.indices[t+2],YE),this.getPoint(this.indices[t+1],KE)):e(this.getPoint(this.indices[t],ZE),this.getPoint(this.indices[t+1],YE),this.getPoint(this.indices[t+2],KE)))}getPositionNearCenter(){return this.getPositionNearPoint(this.getBounds().center()).position}getPositionNearPoint(e){let t=null,i=1/0;function s(s){const n=pe.S4.distanceSquared(e,s);n<i&&(t=v.clone(s),i=n)}function n(t,i){s((0,Li.vu)(t,i,e))}return this.iteratePrimitives((function(e,t,i){t||i?i?function(e,t,i){n(e,t),n(t,i),n(i,e);const r=NE;pe.S4.add(r,pe.S4.scale(e,1/3,bE)),pe.S4.add(r,pe.S4.scale(t,1/3,bE)),pe.S4.add(r,pe.S4.scale(i,1/3,bE)),s(r)}(e,t,i):n(e,t):s(e)})),{position:t,distance:i}}packScalarsIntoTextureCoordinates(e){const t=new Float32Array(this.vertexCount()*Jd.TEXTURE.dimension);if(e.length!==this.vertexCount())return void It.log.debug(`Scalars of length ${e.length} did not match increment vertex count of ${this.vertexCount()}`);const i=[1,0];for(let s=0;s<this.vertexCount();++s)i[1]=e[s],t.set(i,Jd.TEXTURE.dimension*s);this.textureCoordinates=t}replicateTextureCoordinate(e){const t=new Float32Array(this.vertexCount()*Jd.TEXTURE.dimension);for(let i=0;i<this.vertexCount();++i)t.set(e,Jd.TEXTURE.dimension*i);this.textureCoordinates=t}}class QE{constructor(){this.rangeSet=null,this.index=0}resetForRangeSet(e){this.rangeSet=e,this.index=0}hasMoreRanges(){return!!this.rangeSet&&this.index<this.rangeSet.length}getNextRange(){return this.hasMoreRanges()?this.rangeSet[this.index++]:null}}class $E{constructor(){this.bufferSetRanges=new Gi.N,this.boundables=new Set,this.iterator=new QE,this.listenForDeletions=!1,this.listenerId=NS()}getMeshGroupId(){return null}destroy(){this.setListenForDeletions(!1)}copyDataTo(e){const t=this.bufferSetRanges.getKeyValues();for(let i=0;i<t.length;i+=2)e.bufferSetRanges.set(t[i],mE(t[i+1]));e.boundables=new Set(this.boundables),e.setListenForDeletions(this.listenForDeletions)}getListenerId(){return this.listenerId}onIncrementDeleted(e){this.onIncrementRemoved(e)}setListenForDeletions(e){if(this.listenForDeletions===e)return;this.listenForDeletions=e;const t=this.bufferSetRanges.getKeyValues();for(let e=0;e<t.length;e+=2)this.listenForDeletions?t[e].addIncrementDeletionListener(this):t[e].removeIncrementDeletionListener(this)}isEmpty(){return 0===this.bufferSetRanges.size}onIncrementAdded(e,t){let i=this.bufferSetRanges.get(e.bufferSet);i||(i=[],this.bufferSetRanges.set(e.bufferSet,i));let s=e.indexRange;return t&&(s=[s[0],s[1],t]),dE(s,i),this.damageBounds(),!0}onIncrementRemoved(e){const t=this.bufferSetRanges.get(e.bufferSet);return!!t&&(gE(e.indexRange,t),0===t.length&&this.bufferSetRanges.delete(e.bufferSet),this.damageBounds(),!0)}addBoundable(e){this.boundables.add(e)}removeBoundable(e){this.boundables.delete(e)}damageBounds(){for(const e of this.boundables.values())e.damageBounds()}isCheaplyBoundable(){return!1}getRangeIteratorForBufferSet(e){const t=this.bufferSetRanges.get(e);return t?(this.iterator.resetForRangeSet(t),this.iterator):null}shouldDrawForOccurrences(e){return!0}draw(e,t){const i=this.bufferSetRanges.getKeyValues();for(let s=0;s<i.length;s+=2)i[s].draw(e,t||this)}getChildSceneDebugObjects(){const e=[],t=this.bufferSetRanges.getKeyValues();for(let i=0;i<t.length;i+=2)e.push({text:"Buffer set "+t[i].getDebugId()+" ranges: ("+pE(t[i+1])+")",children:[]});return e}}class JE extends TE{constructor(){super(),this.operandA=null,this.currentARange=null,this.operandB=null,this.currentBRange=null}reset(e,t){this.operandA=e,this.currentARange=null,this.operandB=t,this.currentBRange=null,this.nextResult=this.findNextRange()}findNextRange(){if(this.currentARange||(this.currentARange=this.operandA.getNextRange()),!this.currentARange)return null;for(;this.bIsBehind();)this.currentBRange=this.operandB.getNextRange();if(!this.currentBRange)return null;if(this.currentARange[1]<=this.currentBRange[0])return this.currentARange=null,this.findNextRange();const e=this.getStorageForNextResult();return e[2]=this.currentARange[2],this.currentARange[0]>=this.currentBRange[0]?e[0]=this.currentARange[0]:e[0]=this.currentBRange[0],this.currentARange[1]<=this.currentBRange[1]?(e[1]=this.currentARange[1],this.currentARange[1]===this.currentBRange[1]&&(this.currentBRange=null),this.currentARange=null):(e[1]=this.currentBRange[1],this.currentBRange=null),e}bIsBehind(){return this.currentBRange?this.currentBRange[1]<=this.currentARange[0]:this.operandB.hasMoreRanges()}}class eS{constructor(){this.operandA=null,this.operandB=null,this.iterator=new JE}setOperandA(e){this.operandA=e}setOperand(e){this.operandB=e}getRangeIteratorForBufferSet(e){if(!this.operandA||!this.operandB)return null;const t=this.operandA.getRangeIteratorForBufferSet(e);if(!t)return null;const i=this.operandB.getRangeIteratorForBufferSet(e);return i?(this.iterator.reset(t,i),this.iterator):null}makeSceneDebugObject(){const e={text:"IntersectOperator",children:[]};return(0,Js.n9)(e,this.operandA),(0,Js.n9)(e,this.operandB),e}}function tS(e){return t=>{const i=t.getAttribute(Jd.COLOR);if(i){const s=t.clone(),n=i.slice();return n[3]*=e,s.setAttribute(Jd.COLOR,n),s}return t}}class iS{constructor(e){this.styleModifier=e,this.baseIterator=null}reset(e){return this.baseIterator=e,this}hasMoreRanges(){return this.baseIterator.hasMoreRanges()}getNextRange(){const e=this.baseIterator.getNextRange();if(e){const t=[e[0],e[1],e[2]];return t[2]&&(t[2]=this.styleModifier(t[2])),t}return null}}class sS{constructor(e){this.baseOperand=null,this.iterator=new iS(e)}setOperand(e){this.baseOperand=e}getRangeIteratorForBufferSet(e){if(!this.baseOperand)return null;const t=this.baseOperand.getRangeIteratorForBufferSet(e);return t?this.iterator.reset(t):null}makeSceneDebugObject(){const e={text:"StyleModificationOperator",children:[]};return(0,Js.n9)(e,this.baseOperand),e}}class nS extends ME{constructor(){super(4),this.baseIterator=null,this.currentBaseRange=null,this.currentBaseOffset=-1,this.overwriteIterator=null,this.currentOverwriteRange=null,this.defaultStyle=null}setDefaultStyle(e){this.defaultStyle=e}reset(e,t){return this.baseIterator=e,this.currentBaseRange=null,this.currentBaseOffset=-1,this.overwriteIterator=t,this.currentOverwriteRange=null,this.nextResult=this.findNextRange(),this}findNextRange(){if(this.currentBaseRange||(this.currentBaseRange=this.baseIterator.getNextRange(),this.currentBaseOffset=-1),!this.currentBaseRange)return null;for(;this.overwriteIteratorIsBehind();)this.currentOverwriteRange=this.overwriteIterator.getNextRange();const e=this.getStorageForNextResult();if(!this.currentOverwriteRange||this.currentOverwriteRange[0]>=this.currentBaseRange[1])e[0]=this.currentBaseOffset>=0?this.currentBaseOffset:this.currentBaseRange[0],e[1]=this.currentBaseRange[1],e[2]=SE(this.defaultStyle,this.currentBaseRange[2],this.getStyleMergeStorage()),this.currentBaseRange=null;else{const t=this.currentBaseOffset>=0?this.currentBaseOffset:this.currentBaseRange[0];e[0]=t;const i=SE(this.defaultStyle,this.currentBaseRange[2],this.getStyleMergeStorage());this.currentOverwriteRange[0]<=t?(e[2]=SE(i,this.currentOverwriteRange[2],this.getStyleMergeStorage()),this.currentBaseRange[1]<this.currentOverwriteRange[1]?(e[1]=this.currentBaseRange[1],this.currentBaseRange=null):this.currentBaseRange[1]>this.currentOverwriteRange[1]?(e[1]=this.currentOverwriteRange[1],this.currentBaseOffset=this.currentOverwriteRange[1],this.currentOverwriteRange=null):(e[1]=this.currentBaseRange[1],this.currentBaseRange=null,this.currentOverwriteRange=null)):(e[1]=this.currentOverwriteRange[0],e[2]=i,this.currentBaseOffset=this.currentOverwriteRange[0])}return e}overwriteIteratorIsBehind(){if(this.overwriteIterator){if(this.currentOverwriteRange){const e=this.currentBaseOffset>=0?this.currentBaseOffset:this.currentBaseRange[0];return this.currentOverwriteRange[1]<=e}return this.overwriteIterator.hasMoreRanges()}return!1}}class rS{constructor(){this.baseOperand=null,this.overwriteOperand=null,this.iterator=new nS}setDefaultStyle(e){this.iterator.setDefaultStyle(e)}setOverwriteOperand(e){this.overwriteOperand=e}setOperand(e){this.baseOperand=e}getRangeIteratorForBufferSet(e){if(!this.baseOperand)return null;const t=this.baseOperand.getRangeIteratorForBufferSet(e);if(!t)return null;const i=this.overwriteOperand?this.overwriteOperand.getRangeIteratorForBufferSet(e):null;return this.iterator.reset(t,i)}makeSceneDebugObject(){const e={text:"StyleOverwriteOperator",children:[]};return(0,Js.n9)(e,this.baseOperand),(0,Js.n9)(e,this.overwriteOperand),e}}let aS=new eS,oS=new Kr,hS=new rS,cS={};const lS=new fE;lS.setAttribute(Jd.HIGHLIGHT_ID,[0,0,0,0]);class uS{constructor(){this.entityHighlightRanges=new Map,this.entityHighlights=new Map,this.occurrenceHighlights=new Map}destroy(){for(const e of this.entityHighlightRanges.values())e.destroy();this.occurrenceHighlights.clear()}hasHighlight(){if(this.occurrenceHighlights.size>0)return!0;for(const e of this.entityHighlightRanges.values())if(!e.isEmpty())return!0;return!1}entityHasHighlight(e){if(this.occurrenceHighlights.size>0)return!0;for(const t of this.entityHighlightRanges.values())if(t.containsIncrement(e))return!0;return!1}getEntityHighlights(e){return this.entityHighlights.get(e)}removeEntityHighlights(e){this.entityHighlights.delete(e)}getOrCreateEntityRangesForType(e){let t=this.entityHighlightRanges.get(e);return t||(t=new BS(e),this.entityHighlightRanges.set(e,t),t.setListenForDeletions(!0)),t}updateEntityHighlight(e,t,i){const s=this.getOrCreateEntityRangesForType(t.type),n=(0,Ol.getOrCreateSubMap)(this.entityHighlights,i),r=this.getHighestPriorityHighlightFromMap(n);if(e===yn.aU.ADD){if(n.set(t.getIdString(),t),!r||r.priority<t.priority){if(r){const e=this.entityHighlightRanges.get(r.type);e&&e.onIncrementRemoved(i)}s.onIncrementAdded(i,t.getStyle())}}else{n.delete(t.getIdString()),s.onIncrementRemoved(i);const e=this.getHighestPriorityHighlightFromMap(n);if(e){this.getOrCreateEntityRangesForType(e.type).onIncrementAdded(i,e.getStyle())}s.isEmpty()&&(this.entityHighlightRanges.delete(t.type),s.destroy()),0===n.size&&this.entityHighlights.delete(i)}}updateOccurrenceHighlight(e,t){let i;e===yn.aU.ADD?(i=(0,Ol.getOrCreateSubMap)(this.occurrenceHighlights,t.type),i.set(t.getIdString(),t)):(i=this.occurrenceHighlights.get(t.type),i&&(i.delete(t.getIdString()),0===i.size&&this.occurrenceHighlights.delete(t.type)))}getHighestPriorityOccurrenceHighlight(){if(0===this.occurrenceHighlights.size)return null;let e=null;for(const t of this.occurrenceHighlights.values())for(const i of t.values())(!e||i.priority>e.priority)&&(e=i);return e}clearHighlight(e){this.occurrenceHighlights.delete(e.type);const t=this.entityHighlightRanges.get(e.type);t&&(this.entityHighlightRanges.delete(e.type),t.destroy()),this.entityHighlights.forEach(((t,i)=>{let s=!1;if(t.forEach(((i,n)=>{i.type===e.type&&(s=!0,t.delete(n))})),s)if(t.size>0){const s=this.getHighestPriorityHighlightFromMap(t);if(s&&s.priority<=e.priority){this.getOrCreateEntityRangesForType(s.type).onIncrementAdded(i,s.getStyle())}}else this.entityHighlights.delete(i)}))}clearAllOccurrenceLevelHighlights(){this.occurrenceHighlights.clear()}getUnionOperator(e,t){let i=cS[e];return i||(cS[e]=i=new pS),i.setOperandA(t),i.setOperand(null),i}getHighestPriorityHighlightFromMap(e){if(!e)return null;let t=null;for(const i of e.values())(!t||i.priority>t.priority)&&(t=i);return t}getFirstHighlightFromMap(e){if(e)for(const t of e.values())return t;return null}getFirstOccurrenceHighlightOfType(e){return this.getFirstHighlightFromMap(this.occurrenceHighlights.get(e))}getHighlightOperator(e){const t=e.getActiveHighlightType(),i=this.getFirstOccurrenceHighlightOfType(t);if(i)return e.applyStyle(i.getStyle()),null;const s=this.entityHighlightRanges.get(t);return s?(aS.setOperandA(s),aS):AE}getHighlightStyleOperator(e,t){if(!e.getActiveShader().hasAttribute($d.HIGHLIGHT_ID)||!this.hasHighlight())return t;const i=hS;i.setDefaultStyle(lS);let s=null,n=null;const r=e.getActiveHighlightType(),a=e.getViewer().getReferenceHighlights().getSortedHighlights();for(let e=0;e<a.length;++e){const t=a[e].type;if(r&&t!==r)continue;const o=this.getFirstOccurrenceHighlightOfType(t);if(o){i.setDefaultStyle(o.getStyle()),s=null,n=null;continue}const h=this.entityHighlightRanges.get(t);if(h){const t=this.getUnionOperator(e,h);s||(s=t),n&&n.setOperand(t),n=t}}return i.setOverwriteOperand(s),t?oS.resetWithOperands(t,i):i}makeSceneDebugObject(e){const t=[],i=[];for(const e of this.entityHighlightRanges.values())i.push(e.makeSceneDebugObject());t.push({text:"entityHighlightRanges",children:i}),t.push({text:"entityHighlights",children:this.getEntityHighlightsDebugInfo()});const s=[];return this.occurrenceHighlights.forEach(((e,t)=>{const i=[];for(const t of e.keys())i.push({text:t.toString(),children:[]});s.push({text:t.toString(),children:i})})),t.push({text:"occurrenceHighlights",children:s}),{text:e,children:t}}getEntityHighlightsDebugInfo(){const e=[];return this.entityHighlights.forEach(((t,i)=>{const s=[];for(const e of t.keys()){const i=[],n=t.get(e);n.debugStack&&i.push({text:"Stack: "+n.debugStack}),s.push({text:e.toString(),children:i})}e.push({text:i.increment.id,children:s})})),e}}function dS(){aS=new eS,oS=new Kr,hS=new rS,cS={}}class gS extends TE{constructor(){super(),this.iteratorA=null,this.currentARange=null,this.currentAOffset=-1,this.iteratorB=null,this.currentBRange=null,this.currentBOffset=-1}reset(e,t){return this.iteratorA=e,this.currentARange=null,this.currentAOffset=-1,this.iteratorB=t,this.currentBRange=null,this.currentBOffset=-1,this.nextResult=this.findNextRange(),this}findNextRange(){if(this.currentARange||(this.currentARange=this.iteratorA.getNextRange(),this.currentAOffset=-1),this.currentBRange||(this.currentBRange=this.iteratorB.getNextRange(),this.currentBOffset=-1),!this.currentARange&&!this.currentBRange)return null;const e=this.getStorageForNextResult();if(!this.currentARange){const t=this.currentBOffset>=0?this.currentBOffset:this.currentBRange[0];return e[0]=t,e[1]=this.currentBRange[1],e[2]=this.currentBRange[2],this.currentBRange=null,e}if(!this.currentBRange){const t=this.currentAOffset>=0?this.currentAOffset:this.currentARange[0];return e[0]=t,e[1]=this.currentARange[1],e[2]=this.currentARange[2],this.currentARange=null,e}const t=this.currentAOffset>=0?this.currentAOffset:this.currentARange[0],i=this.currentBOffset>=0?this.currentBOffset:this.currentBRange[0];return t<i?(e[0]=t,e[2]=this.currentARange[2],i<this.currentARange[1]?(e[1]=i,this.currentAOffset=i):(e[1]=this.currentARange[1],this.currentARange=null)):i<t?(e[0]=i,e[2]=this.currentBRange[2],t<this.currentBRange[1]?(e[1]=t,this.currentBOffset=t):(e[1]=this.currentBRange[1],this.currentBRange=null)):(e[0]=i,e[2]=this.currentBRange[2],this.currentARange[1]<this.currentBRange[1]?(e[1]=this.currentARange[1],this.currentBOffset=this.currentARange[1],this.currentARange=null):this.currentBRange[1]<this.currentARange[1]?(e[1]=this.currentBRange[1],this.currentAOffset=this.currentBRange[1],this.currentBRange=null):(e[1]=this.currentARange[1],this.currentARange=null,this.currentBRange=null)),e}}class pS{constructor(){this.operandA=null,this.operandB=null,this.iterator=new gS}setOperandA(e){this.operandA=e}setOperand(e){this.operandB=e}getRangeIteratorForBufferSet(e){const t=this.operandA?this.operandA.getRangeIteratorForBufferSet(e):null,i=this.operandB?this.operandB.getRangeIteratorForBufferSet(e):null;return t||i?t?i?this.iterator.reset(t,i):t:i:null}makeSceneDebugObject(){const e={text:"StyleUnionOperator",children:[]};return(0,Js.n9)(e,this.operandA),(0,Js.n9)(e,this.operandB),e}}let mS=!1;function fS(){return mS}function IS(e){mS=e}const ES=[];function SS(e,t){let i=1/0,s=-1,n=1/0,r=-1;for(let t=0;t<ES.length;++t)ES[t].byteLength>=e&&ES[t].byteLength<n?(n=ES[t].byteLength,r=t):ES[t].byteLength<i&&(i=ES[t].byteLength,s=t);if(r>=0){const i=ES[r];return t&&(0,Js.rS)(i,e),ES.splice(r,1),i}return s>=0&&ES.splice(s,1),new ArrayBuffer(e)}function TS(e){e&&ES.push(e)}class MS{constructor(e,t,i,s){this.viewer=e,this.target=i,this.componentCount=s,this.GAUGE_MEMORY_TYPE="Vertex buffer",this.scratchSpace=null,this.floatView=null,this.indexView=null,this.uint8View=null,this.initialCopyPerfomed=!1,this.rangesToCopy=[],this.gl=this.viewer.getGlContext(),this.size=t,this.webGlBuffer=this.gl.createBuffer(),this.webGlBuffer||It.log.error("Failed to create gl buffer")}ensureScratchSpace(){if(!this.scratchSpace){const e=!this.initialCopyPerfomed;this.scratchSpace=SS(this.size,e)}}releaseScratchSpace(){this.scratchSpace&&!fS()&&(TS(this.scratchSpace),this.scratchSpace=null,this.floatView=null,this.indexView=null,this.uint8View=null)}destroy(){this.gl&&this.webGlBuffer&&this.gl.deleteBuffer(this.webGlBuffer),this.webGlBuffer&&this.viewer.getMemoryGauge().decrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.size),this.webGlBuffer=null}getComponentCount(){return this.componentCount}copyToGl(){if(!this.scratchSpace)return this.rangesToCopy.length>0&&It.log.warn("Encountered buffer with ranges that need copying, but no scratch space to copy from"),!1;let e;return e=this.initialCopyPerfomed?this.copyPartialUpdatesToGl():this.copyWholeBufferToGl(),this.releaseScratchSpace(),e}copyWholeBufferToGl(){if(!this.webGlBuffer)return!1;this.gl.bindBuffer(this.target,this.webGlBuffer);const e=new DataView(this.scratchSpace,0,this.size);return this.gl.bufferData(this.target,e,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.target,null),this.viewer.getMemoryGauge().incrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.size),this.initialCopyPerfomed=!0,this.rangesToCopy=[],!0}addRangeToCopyToGl(e,t){this.initialCopyPerfomed&&QI(e,t,this.rangesToCopy)}copyPartialUpdatesToGl(){if(this.rangesToCopy.length<1)return!1;this.gl.bindBuffer(this.target,this.webGlBuffer);for(let e=0;e<this.rangesToCopy.length;++e){const t=this.rangesToCopy[e],i=new Uint8Array(this.scratchSpace,t[0],t[1]-t[0]);this.gl.bufferSubData(this.target,t[0],i)}return this.gl.bindBuffer(this.target,null),this.rangesToCopy=[],!0}getSize(){return this.size}getFloatView(){return this.ensureScratchSpace(),this.floatView||(this.floatView=new Float32Array(this.scratchSpace,0,this.size/4)),this.floatView}getIndexView(e){if(this.ensureScratchSpace(),!this.indexView){const t=e===Uint32Array?4:2;this.indexView=new e(this.scratchSpace,0,this.size/t)}return this.indexView}getUint8View(){return this.ensureScratchSpace(),this.uint8View||(this.uint8View=new Uint8Array(this.scratchSpace,0,this.size)),this.uint8View}getGlBuffer(){return this.webGlBuffer}bind(){this.webGlBuffer?this.gl.bindBuffer(this.target,this.webGlBuffer):It.log.warn("Attempting to bind a null gl buffer")}makeSceneDebugObject(e){const t=new e(this.scratchSpace),i=[];for(let e=0;e<t.length;++e)i.push(t[e].toString());return"["+i.join(", ")+"]"}}const CS=ge.create();class DS{constructor(e,t){this.parent=e,this.occurrenceData=t,this.styledRanges=[],this.bounds=null,this.styledBufferSets=null,this.occurrenceData.addBoundable(this)}destroy(){for(let e=0;e<this.styledRanges.length;++e)this.styledRanges[e].destroy();if(this.styledBufferSets)for(const e of this.styledBufferSets)this.removeStyledBufferSet(e);this.occurrenceData.removeBoundable(this)}addStyledBufferSet(e){null===this.styledBufferSets&&(this.styledBufferSets=new Set),this.styledBufferSets.add(e),e.getBufferSet().addParent(this)}hasBufferSet(e){if(!this.hasOptimizedBuffers())return!1;for(const t of this.styledBufferSets)if(t.getBufferSet()===e)return!0;return!1}removeSimpleBufferSet(e){if(!this.hasOptimizedBuffers())return!1;let t=!1;for(const i of this.styledBufferSets)i.getBufferSet()===e&&(t||(t=this.removeStyledBufferSet(i)));return t}removeStyledBufferSet(e){const t=this.styledBufferSets.delete(e);return e.getBufferSet().removeParent(this),t}hasOptimizedBuffers(){return null!==this.styledBufferSets&&this.styledBufferSets.size>0}addStyledMeshRanges(e,t,i,s){const n=new PE(this,e,t,i,s);return this.styledRanges.push(n),n}removeAllChildrenForMeshGroup(e){return this.removeStyledMeshRangesForGroup(e)||this.removeBufferSetsForMeshGroup(e)}removeStyledMeshRangesForGroup(e){const t=[];let i=!1;for(let s=0;s<this.styledRanges.length;++s){const n=this.styledRanges[s];n.getMeshRangesGroupId()===e?(i=!0,n.destroy()):t.push(n)}return this.styledRanges=t,i}removeBufferSetsForMeshGroup(e){if(!this.hasOptimizedBuffers())return!1;let t=!1;for(const i of this.styledBufferSets)i.getBufferSet().getMeshGroupId()===e&&(this.styledBufferSets.delete(i),t=!0);return t}get isEmpty(){return 0===this.styledRanges.length}draw(e){const t=e.getActiveShader();if(!t)return;if(!this.occurrenceData.isVisible(e)&&!e.getIsPickingHiddenOccurrences())return;if(!e.doesNodeOcccurrencePassFilter(this))return;if(e.activePassNeedsIsolationTest()&&e.activePassIsForIsolate()!==this.occurrenceData.getIsolated())return;let i=!1;if(this.hasOptimizedBuffers())for(const s of this.styledBufferSets)this.occurrenceData.isMeshGroupCulled(s.getBufferSet().getMeshGroupId(),e)||(t.uniform1f("uUsePrimitiveLines",1),i||(this.pushGraphicsState(e,t),i=!0),this.occurrenceData.getShouldSetOccurrenceUniform()&&t.uniform1f("uMeshGroupIdHash",s.getBufferSet().getMeshRangesGroupIdHash()),s.draw(e));else for(let s=0;s<this.styledRanges.length;++s){const n=this.styledRanges[s];this.occurrenceData.isStyledRangeCulled(n,e)||(t.uniform1f("uUsePrimitiveLines",0),i||(this.pushGraphicsState(e,t),i=!0),this.occurrenceData.getShouldSetOccurrenceUniform()&&t.uniform1f("uMeshGroupIdHash",n.getMeshRangesGroupIdHash()),n.draw(e,this.occurrenceData))}i&&DS.popGraphicsState(e)}pushGraphicsState(e,t){DS.pushGraphicsState(e,t,this.occurrenceData,this.parent)}static pushGraphicsState(e,t,i,s){if(e.pushModelViewMatrix(pe.w$.multiply(e.getModelViewMatrix(),i.getTransform(),CS)),e.updateModelviewUniforms(),e.activePassIsForSectionPlaneEndcapMask()){const s=e.viewer.getIsolatedOccurrenceManager().isInIsolateOrMakeTransparentMode()&&!i.getIsolated();t.uniform1f("uOutsideIsolation",s?1:0)}i.getShouldSetOccurrenceUniform()&&t.uniform1f("uOccurrenceId",i.getOccurrenceId()),t.uniform1i("uClippedBySectionPlanes",s.getClippedBySectionPlanes()&&i.getIsClippedBySectionPlanes()?1:0);let n=e.isPicking()?s.getPickZOffset():s.getZOffset();e.getHasIsolate()&&!i.getIsolated()&&(n+=DS.NON_ISOLATED_Z_OFFSET_ADDITION),e.setZOffset(n)}static popGraphicsState(e){e.popModelViewMatrix()}damageBounds(){this.bounds&&this.bounds.reset(),this.parent.damageBounds()}addBounds(e,t){if(this.bounds||(this.bounds=new Li.kB),(this.occurrenceData.isBoundable()||t&&t.includeHiddenBounds)&&!this.bounds.isInitialized()){let e,t=!1;if(this.hasOptimizedBuffers())for(const e of this.styledBufferSets)this.bounds.addBox(e.getBounds(this.occurrenceData,this.parent.getUsage()),this.occurrenceData.getTransform());else{for(e=0;e<this.styledRanges.length;++e)if(this.styledRanges[e].isCheaplyBoundable()){const i=this.styledRanges[e].getBounds(this.occurrenceData,this.parent.getUsage());i.isInitialized()&&(this.bounds.addBox(i,this.occurrenceData.getTransform()),t=!0)}if(!t)for(e=0;e<this.styledRanges.length;++e)this.bounds.addBox(this.styledRanges[e].getBounds(this.occurrenceData,this.parent.getUsage()),this.occurrenceData.getTransform())}}e.addBox(this.bounds,null,!0)}makeSceneDebugObject(e){const t="NodeOccurrence: (Occurrence id: "+this.occurrenceData.getOccurrenceId()+")",i=[this.occurrenceData.makeSceneDebugObject()];if(this.bounds&&i.push(this.bounds.makeSceneDebugObject()),this.hasOptimizedBuffers())for(const t of this.styledBufferSets)i.push(t.makeSceneDebugObject(e+1));else for(let e=0;e<this.styledRanges.length;++e)i.push(this.styledRanges[e].makeSceneDebugObject(this.occurrenceData));return{text:t,children:i,state:{opened:!0}}}parentHasTransparency(){return this.parent.hasTransparency()}}DS.NON_ISOLATED_Z_OFFSET_ADDITION=q.default.getManager().getNumber("NON_ISOLATED_Z_OFFSET_ADDITION");const vS=0,PS=1,yS=[1/0,1/0,1/0],AS=8388608,OS=new Of(Ht.UNSIGNED_BYTE,4,0,0,!0);let RS=null;class wS{constructor(e,t,i,s){this.increment=e,this.bufferSet=s,this.vertexRange=t,this.indexRange=i,this.pickId=null==e?void 0:e.pickId}}let _S=1;function NS(){return _S++}let bS=0;class LS extends sg{constructor(e){super(e),this.lineStripIndexBuffer=null,this.pickIdBuffers=[],this.indexRangesToDelete=[],this.pendingFreeSpace=[[],[]],this.freeSpace=[[],[]],this.incrementDeletionListeners=null,this.shaderIdToVAOs=new Map,this.initialVertexCount=1,this.initialIndexCount=this.getDefaultIndexCount(),this.incrementsToBuffer=new Ol.TemplatedCountedMap,this.increments=new Ol.TemplatedCountedMap,this.debugId=bS++}clone(e){const t=new LS(e);if(t.increments.insertCountedMap(this.increments),this.attributeBindings){t.attributeBindings={};for(const e in this.attributeBindings)this.attributeBindings[e]&&(t.attributeBindings[e]=this.attributeBindings[e].clone())}t.initialVertexCount=this.initialVertexCount,t.initialIndexCount=this.initialIndexCount;for(let e=0;e<this.freeSpace[vS].length;++e)t.freeSpace[vS].push(this.freeSpace[vS][e].slice(0));for(let e=0;e<this.freeSpace[PS].length;++e)t.freeSpace[PS].push(this.freeSpace[PS][e].slice(0));return t.markAllIncrementsForBuffering(),t.updateBuffers({forClone:!0}),t}markAllIncrementsForBuffering(){this.incrementsToBuffer.insertCountedMap(this.increments)}destroy(){if(super.destroy(),this.lineStripIndexBuffer&&(this.lineStripIndexBuffer.destroy(),this.lineStripIndexBuffer=null),this.pickIdBuffers){for(let e=0;e<this.pickIdBuffers.length;++e)this.pickIdBuffers[e].destroy();this.pickIdBuffers=[]}if(this.parentMesh.viewer.areVertexArrayObjectsAvailable){for(const[e,t]of this.shaderIdToVAOs)this.parentMesh.viewer.getVertexArrayExtension().deleteVertexArrayOES(t);this.shaderIdToVAOs.clear()}}getDebugId(){return this.debugId.toString()}addIncrementDeletionListener(e){this.incrementDeletionListeners||(this.incrementDeletionListeners={}),this.incrementDeletionListeners[e.getListenerId()]=e}removeIncrementDeletionListener(e){this.incrementDeletionListeners&&delete this.incrementDeletionListeners[e.getListenerId()]}triggerDeletedListeners(e){if(e&&this.incrementDeletionListeners)for(const t in this.incrementDeletionListeners)this.incrementDeletionListeners[t].onIncrementDeleted(e)}getDefaultIndexCount(){return this.isTriangleStrip()?1:0}getUsedVertexCount(){let e=0;return this.increments.each((function(t){return e+=t.increment.points.length/3,!1}),this),e}addFreeSpace(e,t,i,s){QI(t,i,s?this.pendingFreeSpace[e]:this.freeSpace[e])}incorporatePendingFreeSpace(){for(let e=0;e<this.pendingFreeSpace.length;++e){const t=this.pendingFreeSpace[e],i=this.freeSpace[e];for(let e=0;e<t.length;++e)KI(t[e],i);t.splice(0,t.length)}}findFreeSpace(e,t){for(let i=0;i<this.freeSpace[e].length;++i){const s=this.freeSpace[e][i];if(s[1]-s[0]>=t)return s[0]}return-1}markFreeSpaceUsed(e,t,i){$I([t,t+i],this.freeSpace[e])}getLastUsedIndex(){const e=this.freeSpace[PS][this.freeSpace[PS].length-1],t=this.indexBuffer.getComponentCount();return e&&e[1]===t?e[0]:t}reinitialize(){super.reinitialize(),this.lineStripIndexBuffer=null,this.pickIdBuffers=[],this.markAllIncrementsForBuffering(),this.updateBuffers({forReinitialize:!0}),this.shaderIdToVAOs=new Map}getIncrement(e){const t=this.increments.get(e);return t?t.increment:null}incorporateIncrement(e){if(!e||!e.getFullId())return null;let t,i;const s=e.getPreparedVertexCount(),n=e.getPreparedIndexCount(),r=this.findFreeSpace(vS,s),a=this.findFreeSpace(PS,n);if(r>=0&&a>=0)t=[r,r+s],i=[a,a+n],this.markFreeSpaceUsed(vS,r,s),this.markFreeSpaceUsed(PS,a,n);else if(!this.areBuffersInitialized()){const e=this.initialVertexCount+s<=li(),r=(this.initialVertexCount+s)*this.parentMesh.vertexSize,a=r<=AS,o=this.initialIndexCount===this.getDefaultIndexCount()&&r<=268435456;e&&(a||o)&&(t=[this.initialVertexCount,this.initialVertexCount+s],i=[this.initialIndexCount,this.initialIndexCount+n],this.initialVertexCount+=s,this.initialIndexCount+=n)}if(t&&i){const s=new wS(e,t,i,this);return this.incrementsToBuffer.insert(e.getFullId(),s),this.increments.insert(e.getFullId(),s),s}return null}getIncrementDetails(e){return this.increments.get(e)||null}deleteIncrement(e){const t=this.increments.get(e);return t&&(this.addFreeSpace(vS,t.vertexRange[0],t.vertexRange[1],!1),this.addFreeSpace(PS,t.indexRange[0],t.indexRange[1],!0),KI(t.indexRange,this.indexRangesToDelete),this.increments.remove(e)),this.incrementsToBuffer.remove(e),this.triggerDeletedListeners(t),t||null}hasBufferUpdates(){return!this.incrementsToBuffer.isEmpty()||this.indexRangesToDelete.length>0}updateBuffers(e){this.areBuffersInitialized()||this.initializeBuffers(e),this.processDeletedRanges(),this.processNewIncrements();const t=this.copyBuffersToGl();return this.incorporatePendingFreeSpace(),t}validateBufferIndices(e){if(!fS())return void It.log.warn("Can only validate index buffers when getTestingBuffers is true");const t=this.vertexBuffer.getUint8View(),i=this.indexBuffer.getIndexView(oi());for(const s in this.attributeBindings){const n=this.attributeBindings[s],r=n.elementCount*zt(n.type);e||(e=[0,i.length]);for(let a=e[0];a<e[1];++a){const e=i[a];if(n.offset+e*(n.stride+r)+r>t.length){It.log.warn("Found inconsistency in buffer set "+this.debugId+" for attribute "+s);break}}}}copyBuffersToGl(){let e=super.copyBuffersToGl();this.lineStripIndexBuffer&&(e=this.lineStripIndexBuffer.copyToGl()||e);for(let t=0;t<this.pickIdBuffers.length;++t)e=this.pickIdBuffers[t].copyToGl()||e;return e}initializeBuffers(e){if(this.areBuffersInitialized())return;const t=this.parentMesh.viewer,i=t.getGlContext();let s,n=this.initialVertexCount,r=this.initialIndexCount;const a=e&&e.forClone,o=e&&e.forReinitialize;if(this.parentMesh.bufferAllocationPolicy===CI.MAXIMUM&&this.parentMesh.vertexSize>0){const e=Math.floor(AS/this.parentMesh.vertexSize);n=Math.max(n,e);const t=Math.ceil(1.5*n);r=Math.max(r,t)}else this.parentMesh.bufferAllocationPolicy===CI.MEDIUM&&(n=Math.max(n,512),r=Math.max(r,2048));this.vertexBuffer=new MS(t,n*this.parentMesh.vertexSize,i.ARRAY_BUFFER,n),this.initialVertexCount<n&&!a&&!o&&this.addFreeSpace(vS,this.initialVertexCount,n,!1);const h=this.vertexBuffer.getFloatView();for(s=0;s<tg.POINT.dimension;++s)h[s]=yS[s];this.indexBuffer=new MS(t,r*ci(),i.ELEMENT_ARRAY_BUFFER,r),this.initialIndexCount<r&&!a&&!o&&this.addFreeSpace(PS,this.initialIndexCount,r,!1);const c=this.indexBuffer.getIndexView(oi());for(s=0;s<this.getDefaultIndexCount();++s)c[s]=0;this.isTriangleStrip()&&(this.lineStripIndexBuffer=new MS(t,r*ci(),i.ELEMENT_ARRAY_BUFFER,r),function(e,t){const i=e.getGlContext();RS||(RS=new Of(i.FLOAT,1,0,0)),(!e.getResources().primitiveRestartBuffer||e.getResources().primitiveRestartBuffer.getComponentCount()<t)&&(e.getResources().primitiveRestartBuffer=new MS(e,4*t,i.ARRAY_BUFFER,t),e.getResources().primitiveRestartBuffer.getFloatView()[0]=16384,e.getResources().primitiveRestartBuffer.copyToGl())}(t,r)),this.pickIdBuffers=[]}processDeletedRanges(){for(let e=0;e<this.indexRangesToDelete.length;++e){const t=this.indexRangesToDelete[e],i=t[1]-t[0],s=t[0],n=this.indexBuffer.getIndexView(oi());for(let e=t[0];e<t[1];++e)n[e]=0;this.isTriangleStrip()&&this.updateLineStripIndices(t),this.indexBuffer.addRangeToCopyToGl(s*ci(),(s+i)*ci())}this.indexRangesToDelete=[]}updateLineStripIndices(e){if(!this.isTriangleStrip())return;if(!this.lineStripIndexBuffer)return void It.log.warn("Did not find line strip index buffer for triangle strip");const t=this.indexBuffer.getIndexView(oi()),i=this.lineStripIndexBuffer.getIndexView(oi());let s=!1,n=0;i[e[0]]=0;for(let r=e[0]+1;r<e[1]-1;++r)s?(t[r]!==t[r-1]?++n:n=0,2===n&&(s=!1,i[r-2]=t[r-2],i[r-1]=t[r-1])):t[r]===t[r-1]&&(s=!0,n=0),i[r]=s?0:t[r];i[e[1]-1]=0,this.lineStripIndexBuffer.addRangeToCopyToGl(e[0]*ci(),e[1]*ci())}processNewIncrements(){this.incrementsToBuffer.each(((e,t)=>(e.increment.isPreparedForBuffering()||e.increment.prepareForBuffering(),this.copyIncrementVertices(e.increment,e.vertexRange),this.copyIncrementPickIds(e,e.vertexRange),this.copyIncrementIndices(e.increment,e.indexRange,e.vertexRange),!1))),this.incrementsToBuffer.clear()}replicateAttributeValue(e,t,i,s){if(e.elementCount!==s.length)return void It.log.warn("An attempt was made to update a vertex attribute with a value with the wrong dimension");const n=t/e.typeSize(),r=n+i[0]*e.elementCount,a=n+i[1]*e.elementCount,o=e.type===Ht.FLOAT?this.vertexBuffer.getFloatView():this.vertexBuffer.getUint8View();for(let t=r;t<a;t+=e.elementCount)o.set(s,t)}copyIncrementVertices(e,t){const i=this.vertexBuffer.getComponentCount(),s=this.vertexBuffer.getFloatView(),n=this.vertexBuffer.getUint8View(),r=e.vertexCount(),a=t[0];let o=0,h=0,c=0,l=!1;this.attributeBindings||(this.attributeBindings={},l=!0);for(let t=0;t<ig.length;++t){const u=ig[t];let d=!1;e[u.incrementProperty]&&(u.type===Ht.FLOAT?s.set(e[u.incrementProperty],o+u.elementCount*a):n.set(e[u.incrementProperty],h+u.elementCount*a),d=!0),l&&d&&(this.attributeBindings[u.name]=new Of(+u.type,u.dimension,c,0,u.normalize,u.secondDimension),c+=u.sizeInBytes()*i),d&&(this.vertexBuffer.addRangeToCopyToGl(h+a*u.sizeInBytes(),h+(a+r)*u.sizeInBytes()),h+=u.sizeInBytes()*i,o+=u.sizeInBytes()/4*i)}}updateIncrementAttribute(e,t,i){this.areBuffersInitialized()||this.updateBuffers();const s=this.increments.get(t);if(!s)return void It.log.warn("Increment was not found in updateIncrementAttribute");const n=this.attributeBindings[e.name];n?(this.replicateAttributeValue(e,n.offset,s.vertexRange,i),this.vertexBuffer.addRangeToCopyToGl(n.offset+s.vertexRange[0]*e.sizeInBytes(),n.offset+s.vertexRange[1]*e.sizeInBytes())):It.log.warn("An attempt was made to update an attribute that did not have a binding")}copyIncrementPickIds(e,t){const i=e.pickId;if((0,Di.rp)(i)){this.parentMesh.viewer.notifyOfPickPassCount(i.length);for(let e=0;e<i.length;++e){let s=this.pickIdBuffers[e];s||(this.pickIdBuffers[e]=s=new MS(this.parentMesh.viewer,4*this.vertexBuffer.getComponentCount(),this.parentMesh.viewer.getGlContext().ARRAY_BUFFER,this.vertexBuffer.getComponentCount()));const n=s.getUint8View(),r=(0,Js.fA)(i[e]);for(let e=t[0];e<t[1];++e)n.set(r,4*e);s.addRangeToCopyToGl(4*t[0],4*t[1])}}}copyIncrementIndices(e,t,i){if(!this.indexBuffer)return;const s=this.indexBuffer.getIndexView(oi());let n=0;this.isTriangleStrip()&&(s[t[0]]=i[0]+e.indices[n],n=1);let r=0;for(r=0;r<e.indices.length;++r)s[t[0]+r+n]=i[0]+e.indices[r];if(this.isTriangleStrip()){const n=i[0]+e.indices[e.indices.length-1];for(;r<e.indexLengthWithDegenerates();++r)s[t[0]+r]=n;this.updateLineStripIndices(t)}this.indexBuffer.addRangeToCopyToGl(t[0]*ci(),t[1]*ci())}bindBuffers(e,t,i,s,n){super.bindBuffers(e,t,i,s,n),s&&this.vertexBuffer.bind();let r=this.indexBuffer;e.getPickPrimitiveAlternates()&&i&&(r=this.lineStripIndexBuffer),r.bind(),n&&e.isPicking()&&e.getPickPassIteration()>=0&&(this.pickIdBuffers[e.getPickPassIteration()]?this.pickIdBuffers[e.getPickPassIteration()].bind():t.vertexAttrib4fv($d.PICKING,Js.o0))}initializeAttributes(e,t,i){super.initializeAttributes(e,t,i),t.isPicking()&&t.getPickPassIteration()>=0?this.pickIdBuffers[t.getPickPassIteration()]?(this.pickIdBuffers[t.getPickPassIteration()].bind(),e.vertexAttribPointer($d.PICKING,OS)):e.vertexAttrib4fv($d.PICKING,Js.o0):e.enableVertexAttribArray($d.PICKING,!1),t.getPickPrimitiveAlternates()&&i?(this.parentMesh.viewer.getResources().primitiveRestartBuffer.bind(),e.vertexAttribPointer($d.PRIMITIVE_RESTART,RS)):e.enableVertexAttribArray($d.PRIMITIVE_RESTART,!1)}bindAttributeStateWithVAOs(e,t,i,s){let n=t.getNumericId();i.getPickPassIteration()>0&&(n=1e3*n+i.getPickPassIteration());let r=this.shaderIdToVAOs.get(n);e?r?(this.parentMesh.viewer.bindVao(r),this.bindBuffers(i,t,s,!1,!0)):(r=this.parentMesh.viewer.getVertexArrayExtension().createVertexArrayOES(),this.shaderIdToVAOs.set(n,r),this.parentMesh.viewer.bindVao(r),this.bindAttributeStateWithoutVAOs(e,t,i,s)):this.parentMesh.viewer.bindVao(r)}draw(e,t){this.drawRanges(e,t)}drawRanges(e,t){if(this.parentMesh.compileBuffers(e),!this.attributeBindings)return;if(!this.areBuffersInitialized())return void this.logInconsistency("BEL-53632 BufferSet.prototype.draw without initialized buffers");const i=t.getRangeIteratorForBufferSet(this);if(!i||!i.hasMoreRanges())return;const s=e.getActiveShader(),n=this.parentMesh.viewer.getGlContext(),r=this.isTriangleStrip(),a=e.getPickPrimitiveAlternates()?this.parentMesh.getAlternatePrimitiveMode():this.parentMesh.getPrimitiveMode(),o=this.buffersNeedBinding(e);this.parentMesh.viewer.areVertexArrayObjectsAvailable?this.bindAttributeStateWithVAOs(o,s,e,r):this.bindAttributeStateWithoutVAOs(o,s,e,r);let h=0,c=0;for(;i.hasMoreRanges();){const t=i.getNextRange();if(!t)continue;let s=t[0],o=t[1]-t[0];1&s&&r&&(o-=1,s+=1),o<3&&r||(e.applyStyle(t[2]),n.drawElements(a,o,hi(),s*ci()),h++,c+=o,e.getPickPrimitiveAlternates()&&r&&n.drawElements(n.POINTS,o,hi(),s*ci()))}this.parentMesh.incrementStatisticsForCall(c,h)}makeSceneDebugObject(){const e={};if(this.increments.isEmpty())return e;this.markAllIncrementsForBuffering(),this.processNewIncrements(),e.vertexBuffer=this.vertexBuffer.makeSceneDebugObject(Uint8Array),e.indexBuffer=this.indexBuffer.makeSceneDebugObject(oi()),this.lineStripIndexBuffer&&(e.lineStripIndexBuffer=this.lineStripIndexBuffer.makeSceneDebugObject(oi())),e.pickIdBuffers=[];for(let t=0;t<this.pickIdBuffers.length;++t)e.pickIdBuffers.push(this.pickIdBuffers[t].makeSceneDebugObject(Uint32Array));return this.copyBuffersToGl(),e}addGroupIncrementsToBounds(e,t,i,s){this.increments.each((function(n){const r=n.increment;return r.groupId===e&&r.ownerId===t&&r.lod===i&&s.addBox(r.getBounds()),!1}),this)}}class FS extends TE{constructor(){super(),this.minuendRangeIterator=null,this.currentMinuendRange=null,this.minuendSubRangeStart=-1,this.subtrahendRangeIterator=null,this.currentSubtrahendRange=null}reset(e,t){this.minuendRangeIterator=e,this.currentMinuendRange=null,this.minuendSubRangeStart=-1,this.subtrahendRangeIterator=t,this.currentSubtrahendRange=null,this.nextResult=this.findNextRange()}findNextRange(){if(this.currentMinuendRange||(this.currentMinuendRange=this.minuendRangeIterator.getNextRange()),!this.currentMinuendRange)return null;for(;this.subtrahendIsBehind();)this.currentSubtrahendRange=this.subtrahendRangeIterator.getNextRange();const e=this.getStorageForNextResult();if(!this.currentSubtrahendRange||this.currentSubtrahendRange[0]>this.currentMinuendRange[1])e[0]=this.minuendSubRangeStart>=0?this.minuendSubRangeStart:this.currentMinuendRange[0],e[1]=this.currentMinuendRange[1],e[2]=this.currentMinuendRange[2],this.currentMinuendRange=null,this.minuendSubRangeStart=-1;else{const t=this.minuendSubRangeStart>=0?this.minuendSubRangeStart:this.currentMinuendRange[0];if(this.currentSubtrahendRange[0]<=t)return this.currentSubtrahendRange[1]>=this.currentMinuendRange[1]?(this.currentMinuendRange=null,this.minuendSubRangeStart=-1):this.minuendSubRangeStart=this.currentSubtrahendRange[1],this.findNextRange();e[0]=t,e[1]=this.currentSubtrahendRange[0],e[2]=this.currentMinuendRange[2],this.currentSubtrahendRange[1]>=this.currentMinuendRange[1]?(this.currentMinuendRange=null,this.minuendSubRangeStart=-1):this.minuendSubRangeStart=this.currentSubtrahendRange[1]}return e}subtrahendIsBehind(){if(this.currentSubtrahendRange){const e=this.minuendSubRangeStart>=0?this.minuendSubRangeStart:this.currentMinuendRange[0];return this.currentSubtrahendRange[1]<=e}return this.subtrahendRangeIterator.hasMoreRanges()}}class xS extends $E{constructor(e,t,i,s){super(),this.groupId=e,this.ownerId=t,this.primitiveType=i,this.lod=s,this.bounds=null}getOwnerId(){return this.ownerId}getMeshGroupId(){return this.groupId}cloneForPreview(){const e=new xS(this.groupId,this.ownerId,this.primitiveType,this.lod);return this.copyDataTo(e),e.setListenForDeletions(!0),e.setBounds(this.bounds),e}onIncrementDeleted(e){e.increment.groupId===this.groupId&&e.increment.ownerId===this.ownerId&&this.onIncrementRemoved(e)}makeSceneDebugObject(e){const t=e?this.shouldDrawForOccurrences(e):void 0,i="Group ranges: (ownerId: "+this.ownerId+", groupId: "+this.groupId+", primitiveType: "+(0,_i.E1)(this.primitiveType)+", lod: "+this.lod+", shouldDrawForOccurrence: "+t+", listenForDeletions: "+this.listenForDeletions+")",s=this.getChildSceneDebugObjects();return this.bounds&&s.push(this.bounds.makeSceneDebugObject()),{text:i,children:s,state:{opened:t}}}isCheaplyBoundable(){return this.lod===eg.LOWEST}damageBounds(){this.bounds=null,$E.prototype.damageBounds.apply(this,arguments)}setBounds(e){this.bounds=e}getBounds(e,t){if(!this.bounds){this.bounds=new Li.kB;const e=this.bufferSetRanges.getKeyValues();for(let t=0;t<e.length;t+=2){e[t].addGroupIncrementsToBounds(this.groupId,this.ownerId,this.lod,this.bounds)}}return this.bounds}shouldDrawForOccurrences(e){return e.getLod()===this.lod}getPrimitiveCount(){let e=0;const t=this.bufferSetRanges.getKeyValues();for(let i=0;i<t.length;i+=2){const s=t[i+1];for(let t=0;t<s.length;++t){const i=s[t];this.primitiveType===_i.MX.TRIANGLE_STRIP?e+=i[1]-i[0]-2:this.primitiveType===_i.MX.TRIANGLES?e+=(i[1]-i[0])/3:this.primitiveType===_i.MX.SILHOUETTES&&(e+=(i[1]-i[0])/6)}}return e}}class BS extends $E{constructor(e,t){super(),this.debugId=e,this.sourceMeshGroupId=t,this.incrementDetails=new Set}clone(){const e=new BS(this.debugId,this.sourceMeshGroupId);return e.incrementDetails=new Set(this.incrementDetails),this.copyDataTo(e),e}getMeshGroupId(){return this.sourceMeshGroupId}makeSceneDebugObject(){let e="",t=!0;this.incrementDetails.forEach((function(i){t||(e+=","),t=!1,e+=i.increment.getFullId()}));return{text:"Increment ranges "+this.debugId+": (incrementIds: ["+e+"], listenForDeletions: "+this.listenForDeletions+")",children:this.getChildSceneDebugObjects()}}isEmpty(){return 0===this.incrementDetails.size}containsIncrement(e){return this.incrementDetails.has(e)}onIncrementAdded(e,t){if(this.incrementDetails.has(e)&&!t)return!1;this.incrementDetails.add(e);const i=$E.prototype.onIncrementAdded.apply(this,arguments);return this.listenForDeletions&&e.bufferSet.addIncrementDeletionListener(this),i}onIncrementRemoved(e){if(!this.incrementDetails.has(e))return!1;this.incrementDetails.delete(e);const t=$E.prototype.onIncrementRemoved.apply(this,arguments);return this.listenForDeletions&&!this.bufferSetRanges.has(e.bufferSet)&&e.bufferSet.removeIncrementDeletionListener(this),t}getListenerId(){return this.listenerId}onIncrementDeleted(e){this.onIncrementRemoved(e)}getBounds(e,t){const i=new Li.kB;return this.incrementDetails.forEach((s=>{e.isIncrementBoundable(s,t)&&i.addBox(s.increment.getBounds())})),i}}class US{constructor(e){this.subtractMeshRanges=e}getRangeIteratorForBufferSet(e){return BS.prototype.getRangeIteratorForBufferSet.call(this.subtractMeshRanges,e)}makeSceneDebugObject(){const e={text:"SubtractMeshRangeIncrementProvider",children:[]};return(0,Js.n9)(e,this.subtractMeshRanges),e}}class VS extends BS{constructor(e){super(e),this.subtractOperator=new XS,this.subtractOperator.setSubtrahend(new US(this)),this.setListenForDeletions(!0)}setOperand(e){this.subtractOperator.setOperand(e)}getRangeIteratorForBufferSet(e){return this.subtractOperator.getRangeIteratorForBufferSet(e)}}const GS=new Ni;function HS(e){GS.reset(),GS.addNumber(e.getPrimitiveType(),_i.ip);for(const t in Jd){const i=Jd[t];GS.addBoolean(e.hasAttribute(i.incrementProperty))}return GS.getId()}let kS=1;function WS(){const e=kS.toString();return++kS,e}class zS{constructor(e,t){this.viewer=e,this.meshCreationOptions=t,this.meshes={},this.incrementIdToMesh={},this.groupRanges={},this.ownsMeshes=!0,this.groupRangesIdToBufferSet=null}destroy(){if(this.ownsMeshes)for(const e in this.meshes)this.meshes[e].destroy();for(const e in this.groupRanges)this.groupRanges[e].destroy()}getBufferSetForGroup(e,t,i,s){const n=this.getGroupRangesId(e,t,i,s);return this.groupRangesIdToBufferSet?this.groupRangesIdToBufferSet.get(n):(It.log.warn("groupRangesIdToBufferSet is null for body/featureId: "+e+", ownerId: "+t+", primitiveType: "+i+", lod: "+s),null)}cloneForPreview(e){const t=new zS(this.viewer,this.meshCreationOptions);t.ownsMeshes=!1,t.meshes=(0,X.Z)(this.meshes),t.incrementIdToMesh=(0,X.Z)(this.incrementIdToMesh);for(const i in this.groupRanges){this.groupRanges[i].getOwnerId()===e&&(t.groupRanges[i]=this.groupRanges[i].cloneForPreview())}return t}addMeshIncrement(e,t,i){this.removeMeshIncrement(e.id,t),e.ownerId=t;const s=HS(e);let n=this.meshes[s];n||(this.meshes[s]=n=new OI(this.viewer,this.meshCreationOptions));const r=n.addIncrement(e);if(r){this.incrementIdToMesh[e.getFullId()]=n;const t=this.getGroupRangesForIncrement(e);t&&(t.onIncrementAdded(r),i&&t.setBounds(i))}return r}addBufferSet(e,t,i,s,n){if(!e||!t)return;const r=HS(t);let a=this.meshes[r];const o=t.getPrimitiveType();a||(this.meshes[r]=a=new OI(this.viewer,this.meshCreationOptions),a.setPrimitiveType(o)),a.removeSimpleBufferSetWithMeshGroupId(e.getMeshGroupId()),a.addBufferSet(e);const h=this.getGroupRangesId(i,s,o,eg.DEFAULT);this.groupRangesIdToBufferSet||(this.groupRangesIdToBufferSet=new Map),this.groupRangesIdToBufferSet.set(h,e)}getIncrementDetails(e,t){const i=LE(e,t),s=this.incrementIdToMesh[i];return s?s.getIncrementDetails(i):null}removeMeshIncrement(e,t){const i=LE(e,t),s=this.incrementIdToMesh[i];let n=null;if(s){if(n=s.deleteIncrement(i),n){const e=this.getGroupRangesForIncrement(n.increment);e&&e.onIncrementRemoved(n)}delete this.incrementIdToMesh[i]}return n}getGroupRangesForIncrement(e){return e.groupId?this.getOrCreateGroupRangesForGroupTypeAndLod(e.groupId,e.ownerId,e.primitiveType,e.lod):null}getGroupRangesId(e,t,i,s){return e+"."+t+"."+i+"."+s}getOrCreateGroupRangesForGroupTypeAndLod(e,t,i,s){const n=this.getGroupRangesId(e,t,i,s);let r=this.groupRanges[n];return r||(this.groupRanges[n]=r=new xS(e,t,i,s)),r}getGroupRangesForGroupTypeAndLod(e,t,i,s){const n=this.getGroupRangesId(e,t,i,s);return this.groupRanges[n]||null}removeEmptyMeshes(){const e=[];let t=null;for(t in this.meshes)this.meshes[t].isEmpty()&&e.push(t);for(let i=0;i<e.length;++i)t=e[i],this.meshes[t].destroy(),delete this.meshes[t]}getMeshForIncrement(e){return this.meshes[HS(e)]||null}compileBuffers(){const e=new mh.B7("MeshManager: Compiling Vertex Buffers");for(const e in this.meshes)this.meshes[e].compileBuffers();e.report()}}class XS{constructor(){this.minuend=null,this.subtrahend=null,this.resultIterator=new FS}setOperand(e){this.minuend=e}setSubtrahend(e){this.subtrahend=e}getRangeIteratorForBufferSet(e){if(!this.minuend||!this.subtrahend)return It.log.info("SubtractOperator.getRangeIteratorForBufferSet should be called with subtrahend and minuend"),null;const t=this.minuend.getRangeIteratorForBufferSet(e);if(!t)return null;const i=this.subtrahend.getRangeIteratorForBufferSet(e);return i?(this.resultIterator.reset(t,i),this.resultIterator):t}makeSceneDebugObject(e){const t={text:"SubtractOperator",children:[]};return(0,Js.n9)(t,this.minuend),(0,Js.n9)(t,this.subtrahend),t}}var qS=i(21727),ZS=i(96523),YS=i(64991),KS=i(25586),jS=i(50098),QS=i(29138),$S=i(40546),JS=i(40935),eT=i(33804),tT=i(32659);const iT=i(30931),sT=1600,nT=1200;$S.ZR(Array);{const e=window;e.vec2=$,e.vec3=v,e.vec4=P,e.mat2=eT,e.mat3=Mh,e.mat4=ge,e.quat4=rn}let rT=0;function aT(e,t){return Math.floor(e*t)}if(window.matchMedia){window.matchMedia("print").addListener((function(e){e.matches?(0,ui.lp)():(0,ui.py)()}))}window.onbeforeprint=ui.lp,window.onafterprint=ui.py;const oT=q.default.getManager();class hT{constructor(e){this.elementId=e,this.camera=null,this.userEnabledAggressiveRefinement=!1,this.activeSectionPlanes=[],this.zebraStripeCount=oT.getNumber("ZEBRA_STRIPE_COUNT"),this.zebraStripeRotation=oT.getNumber("ZEBRA_STRIPE_ROTATION"),this.zebraStripeEdgesOn=!0,this.renderingMode=W.P1.SHADED_WITH_EDGES,this.smoothEdgeStyle=W.YUG.VISIBLE}}var cT;!function(e){e[e.VIEWER_DESTROYED=-1]="VIEWER_DESTROYED",e[e.WAITING_FOR_DISPLAY_DATA=0]="WAITING_FOR_DISPLAY_DATA",e[e.WAITING_FOR_COMPARE_DISPLAY_DATA=1]="WAITING_FOR_COMPARE_DISPLAY_DATA",e[e.LOADING_DISPLAY_DATA=2]="LOADING_DISPLAY_DATA",e[e.LOADED_DISPLAY_DATA=3]="LOADED_DISPLAY_DATA",e[e.LOADED_ALL_DATA=4]="LOADED_ALL_DATA"}(cT||(cT={}));const lT={performFrameTiming:!0},uT={performFrameTiming:!1};let dT={antialias:!0,depth:!0,stencil:!0,preserveDrawingBuffer:!0,powerPreference:"high-performance"};const gT=localStorage.getItem("osWebGlContextOptions");if(gT)try{It.log.info("Using custom set of WebGL context options: "+gT),dT=JSON.parse(gT)}catch(e){It.log.warn("Failed to use custom WebGL context options: "+gT)}const pT={},mT=new Set([W.P1.SIMULATION_RESULTS,W.P1.SHADED_CURVATURE_VISUALIZATION,W.P1.THICKNESS_ANALYSIS_VISUALIZATION]);class fT extends qS.View{constructor(e){super(e),this.viewerPreferences=new JS.g,this.shouldUpdatePairedViewer=!1,this.scalarRetrievalPasses=[],this.hasMouseOver=!1,this.boundVAO=null,this.areOptimizedBuffersEnabled=!1,this.doClearDisplayDataCacheBeforeLoadingElement=!1,this.loggedPickIssue=!1,this.renderModeSubject=new Fs.x,this.isBrowserTabVisible="visible"===document.visibilityState,this.debugCamera=null,this.isSynchingView=!0,this.themeChangeSubscription=null,this.followGraphicsData=new W.xzX,this.followGraphicsDataSubject=new Fs.x,rT=q.default.getManager().getNumber("PICK_WINDOW_PREVENT_CULL_MARGIN_PIXELS"),this.areOptimizedBuffersEnabled=ps.Jq.CapabilitiesService.checkDebugCurrentlyEnabled()&&"true"===localStorage.getItem("osForceEnableGPUBuffers")||ps.Jq.CapabilitiesService.checkUseDisplayDataGPUBuffersCurrentlyEnabled();"true"===localStorage.getItem("osOptimizedBuffersPreviouslyEnabled")!==this.areOptimizedBuffersEnabled&&(this.doClearDisplayDataCacheBeforeLoadingElement=!0),localStorage.setItem("osOptimizedBuffersPreviouslyEnabled",JSON.stringify(this.areOptimizedBuffersEnabled)),this.followGraphicsData.zebraStripeCount=oT.getNumber("ZEBRA_STRIPE_COUNT"),this.followGraphicsData.zebraStripeRotation=oT.getNumber("ZEBRA_STRIPE_ROTATION")}bindVao(e){this.boundVAO!==e&&(this.getVertexArrayExtension().bindVertexArrayOES(e),this.boundVAO=e)}initialize(e){if(this.eventDispatcher=new VM.pB,this.gl=null,this.requestDraw=this.requestDrawUsingTimer,window.requestAnimationFrame&&(this.requestDraw=this.requestDrawUsingAnimationFrame),this.areVertexArrayObjectsAvailable=!!this.getVertexArrayExtension(),this.timeOfContextLoss=null,this.extensions={},this.highlightVertexTexturesSupported=null,this.SSAOFilteringSupported=null,this.highPrecisionSupportedInFragmentShader=null,this.hidden=!1,this.readyState=!1,this.isForFlattenedDisplay=e&&!!e.isForFlattenedDisplay,this.isForPreviousVersionDisplay=e&&!!e.isForPreviousVersionDisplay,this.renderContext=new oE(this),this.handleContextLoss=e=>{!function(e,t){const i=e.getMemoryGauge().getUsageDetails(),s={};Object.entries(i).forEach((([e,t])=>{s[e]=(t/1048576).toFixed(1)+" MB"})),It.log.warn(WM+"The WebGL context was lost. Memory usage at time of loss: "+JSON.stringify(s)),e.gl=null,e.timeOfContextLoss=(0,Js.Wj)(),e.getEventDispatcher().trigger(VM.cW),e.showWebGLContextLostMessage(),t.preventDefault()}(this,e)},this.handleContextRestored=e=>{!function(e,t){e.getGlContext()&&(It.log.info("A context restore was received without a context loss - simulating"),e.gl=null,e.getEventDispatcher().trigger(VM.cW)),e.setupGlContext(),It.log.warn(WM+"The WebGL context was restored after "+(0,Js.Es)(e.timeOfContextLoss).toFixed(0)+" ms"),e.timeOfContextLoss=null,e.getEventDispatcher().trigger(VM.pO,e.getGlContext()),e.onResize(),e.requestDraw(),e.hideWebGLContextLostMessage(),t.preventDefault()}(this,e)},!this.el)return void(this.viewerDestroyed=!0);this.el.addEventListener("webglcontextlost",this.handleContextLoss),this.el.addEventListener("webglcontextrestored",this.handleContextRestored);const t=e&&e.hidden;if(e&&e.glContext)this.gl=e.glContext,this.onNewGlContext();else if(!t&&(this.setupGlContext(),!this.gl))return;t&&this.hide(),this.rendererInfo=Qt(this.gl),(0,ZS.WD)(this.rendererInfo),this.glSyncEveryFrame=!1,this.occurrenceDataManager=new Oh(this),this.modelViewManagers=new Th(this.occurrenceDataManager,this),this.sceneGraphs=new rh,this.uiResourceManager=new EI(this,this.sceneGraphs),this.uiSelectionManager=new wh.z,this.edgePointController=null,this.silhouetteTask=new fI(this),this.occurrenceIdManager=new DI.yx(this);e&&e.dontSetActive||((0,Ih.e$)(this),(0,VM.xA)().trigger(VM.zT)),this.getIsPrimaryViewer()&&(this.curvatureAnalysisManager=new vc(this)),this.disableAutomaticDrawing=e&&!!e.disableAutomaticDrawing,this.disableViewManipulator=e&&!!e.disableViewManipulator,this.instantiatedShaders={},this.badShaders={},this.attribVertexEnabled={},this.boundTextures={},this.listenTo(this.getEventDispatcher(),VM.so,this.onSessionEnded),this.listenTo(this.getEventDispatcher(),VM.cW,this.onGlContextLost),this.listenTo(this.getEventDispatcher(),VM.pO,this.onGlContextRestored),this.listenTo(this.getEventDispatcher(),VM.u9,this.onViewDidDrawSynchronizeLocalView),yf(this),(0,Js.jo)(this.getViewerId(),this),this.animationController=new lM(this),this.viewController=null,this.viewInitialized=!1,this.frameTimer=new zo(this),this.detailManager=new da(ps.Jq.AnalyticsService,this,this.frameTimer),this.loadTimer=null,this.bodyLoadTimer=null,this.elementLoadState=cT.WAITING_FOR_DISPLAY_DATA,this.shouldWaitForCompareDisplayData=!0,this.readyToUpdateElementLoadState=!1,this.receivedFeatureData=!1,this.receivedAssemblyDefinition=!1,this.isReadyForDrawOnLinkOpen=!0,this.initializedForDrawing=!1,this.renderingMode=W.P1.SHADED_WITH_EDGES,this.drawPasses=[],this.mainDrawPass=null,this.combinedPickPass=null,this.depthRetrievalPass=null,this.draftAngleRetrievalPass=null,this.depthSamplingPass=null,this.uiElements={},this.elementToPerElementState={},this.activeElementId="",this.printCanvas=null,this.suppressModelSelection=!1,this.queuedBaseData=null,this.selectionMapperForQueuedBase=null,this.queuedDisplayData=[],this.haveUnitsBeenReceived=!1,this.elementUnitChangedSubscription=(0,Ir.vx)().elementUnitChangedObservable.subscribe((()=>this.requestDraw())),this.memoryGauge=new Zf,this.boxSelectionDeferred=null,this.cursorStack=[],this.selectionCursor=Xn.C.DEFAULT,this.lastMouseLocation=[-1,-1],this.frustumToPreventCulling=null;e&&e.disableSpaceball||Ha(),this.canEdit=!0,this.timestampOfLastDraw=0,this.averagePickDuration=-1,this.pickRadius=oT.getNumber("MOUSE_PICK_RADIUS_PX"),this.bodyLoadTasks=new cl(this),this.bodyLoadTask=this.bodyLoadTasks.getLoadTask(),this.bodyManager=new il(this,this.bodyLoadTasks.getUnloadTask()),this.modelViewManagers.getManager().setBodyLoadTasks(this.bodyLoadTasks),this.isolatedOccurrenceManager=new UM(this),this.taskManager=new pM,this.taskManager.addTask(this.bodyLoadTasks.getUnloadTask(),dM),this.taskManager.addTask(this.bodyLoadTask,gM),this.taskManager.addTask(this.silhouetteTask,dM),this.lastDevicePixelRatio=0,this.recordCapabilitiesTimeout=null,this.hidden||(this.recordCapabilitiesTimeout=window.setTimeout((()=>{pC(this.gl),this.recordCapabilitiesTimeout=null}),5e3)),this.MAX_TEXTURE_UNITS=8,this.textureNameToUnitMap={},this.textureUnitToNameMap={},this.textureAtlasFactory=null,this.sharedFrameBuffers={},this.sharedRenderBuffers={},this.resources=new Wn(this),this.activeElementPreviewManager=null;const i=(e,t)=>{let i=null;const s=this.pick(e,t);for(let e=0;e<s.length&&!i;++e)i=s[e].getModelSelection();let n;this.getModelViewManagers().getManager().displayingPartStudio()&&i&&i.isModifiable()&&(n=(0,ve.fM)(i),n&&n.getIsShowDimensionsEligible()&&n.getIsComputed()&&(0,fr.m)().trigger(mr.C.SHOW_DIMENSIONS_FOR_NODE_WITH_ID,n.getNodeId()))};this.inputHandler=null;e&&e.disableInput||(this.inputHandler=new _s(i,this)),this.sketch=null,this.returnToPerspective=!1,this.viewManipulator=null,e&&e.disableViewManipulator||(this.viewManipulator=new JT(this,e.contextMenuMgr)),this.pickPassCount=0,this.drawTimer=null,this.standardRequestCallbackQueued=!1,this.inRequestDrawCallback=!1,this.referenceHighlights=new bn(this),this.highlightManager=new Ln(this.referenceHighlights),this.compareHighlightManager=new Ln(this.referenceHighlights),this.compareHighlightManager.usage=Ls.L.PREVIEW,this.selectionsToKeepHiddenFromPick=[],this.performBodyCheck=!1,this.bodyCheckPass=new Mt(this),this.hasElementPreviewLoaded=!1,this.storedCameraState=null,this.contextLossTimeout=null,this.zoomToSelectionBounds=null,this.listenTo(this.getEventDispatcher(),VM.ox,this.onMouseEnter),this.listenTo(this.getEventDispatcher(),VM.u5,this.onMouseLeave),this.latestDisplayDataUsageSubscription=ks().latestDisplayDataUsageChangedObservable.subscribe((()=>this.onDisplayDataUsageChange())),this.listenTo((0,VM.xA)(),VM.Cr,this.onDefaultUnitsChanged),this.filteredEntitiesHighlightController=null,this.interferenceCallId="",this.xrController=new tD(this),this.localDisplayDataCacheCleared=!1,this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle=!1,this.smoothEdgeStyle=W.YUG.VISIBLE,this.browserTabVisibilityHandler=()=>this.onBrowserTabVisibilityChanged(),document.addEventListener("visibilitychange",this.browserTabVisibilityHandler),this.themeChangeSubscription=_l.G.getThemeChangedObservable().subscribe((()=>this.onAppearanceConstantsUpdated()))}onViewDidDrawSynchronizeLocalView(){this.pairedViewer&&this.getIsSynchingView()&&this.shouldUpdatePairedViewer&&this.syncPairedView(),this.shouldUpdatePairedViewer=!0}onViewerReactivated(){this.getBodyManager().resetSelectionListHandlers(),this.isolatedOccurrenceManager.setUpListeners(),this.modelViewManagers.getManager().resetSelectionListHandlers(),this.clearElementPreview(),this.elementToPerElementState={},this.localDisplayDataCacheCleared=!1;const e=this.getModelViewManagers().getManager().getSimulationManager();e&&e.onDocumentChange(),this.resetViewState()}showWebGLContextLostMessage(){const e=this.getModelViewManagers().getManager();if(e.displayingPartStudio()||e.displayingAssembly()){const e=tT('<div class="context-loss-message">'+i18n("One moment…")+"</div>").appendTo(this.$el.parent());this.clearContextLossTimeout(),this.contextLossTimeout=window.setTimeout((()=>{e.html(iT())}),q.default.getManager().getNumber("WEBGL_CONTEXT_WARNING_TIMEOUT_MS")),this.viewManipulator&&this.viewManipulator.hide()}}clearContextLossTimeout(){(0,Jr.Z)(this.contextLossTimeout)&&(window.clearTimeout(this.contextLossTimeout),this.contextLossTimeout=null)}hideWebGLContextLostMessage(){const e=this.$el.parent().find(".context-loss-message");e.length>0&&(e.remove(),this.viewManipulator&&!this.hidden&&this.viewManipulator.show())}getEventDispatcher(){return this.eventDispatcher}setEventDispatcher(e){this.eventDispatcher=e}getOccurrenceIdManager(){return this.occurrenceIdManager}getActiveElementId(){return this.activeElementId}getBodyManager(){return this.bodyManager}getIdForOccurrence(e){return e?this.occurrenceIdManager.getIdForName(e.getPathAsString()):DI.KF}getModelViewManagers(){return this.modelViewManagers}isReadyToUpdateElementLoadState(){return this.readyToUpdateElementLoadState}getReceivedFeatureData(){return this.receivedFeatureData}getSceneGraphs(){return this.sceneGraphs}getUiResourceManager(){return this.uiResourceManager}getOccurrenceDataManager(){return this.occurrenceDataManager}getIsolatedOccurrenceManager(){return this.isolatedOccurrenceManager}getUISelectionManager(){return this.uiSelectionManager}getSilhouetteTask(){return this.silhouetteTask}areEdgeSilhouettesEnabled(){return this.detailManager.areFullDetailEdgeSilhouettesEnabled()}isInteractiveFramerateBelowThreshold(){return this.detailManager.isInteractiveFramerateBelowThreshold()}areInteractiveDetailsSignficantlyReduced(){return this.detailManager.getInteractiveSettings().lowLevelBodyProportion>0}isInteractiveSsaoEnabled(){return this.detailManager.isInteractiveSsaoEnabled()}areInteractiveSilhouettesEnabled(){return this.detailManager.areInteractiveSilhouettesEnabled()}getEdgePointController(){return this.edgePointController}createEdgePointController(){this.edgePointController&&this.edgePointController.disable(),this.edgePointController=new Ci(this)}getDefaultStandardView(){return this.getIsForFlattenedDisplay()?"XY":"Trimetric"}onMouseEnter(){(0,Ih.KO)(this),this.hasMouseOver=!0}onMouseLeave(){this.hasMouseOver=!1}getHasMouseOver(){return this.hasMouseOver}getIsForFlattenedDisplay(){return!!this.isForFlattenedDisplay}getIsForPreviousVersionDisplay(){return!!this.isForPreviousVersionDisplay}getIsPrimaryViewer(){return!this.getIsForFlattenedDisplay()&&!this.getIsForPreviousVersionDisplay()}getSupportsPreview(){return!this.getIsForPreviousVersionDisplay()}requestDrawUsingTimer(e,t,i){t=t||lT;const s=this;if(!this.drawTimer||i){if(!e){if(this.disableAutomaticDrawing)return;e=function(){s.drawTimer=null;s.draw(undefined,t)}}this.drawTimer=window.setTimeout(e,10)}}requestDrawUsingAnimationFrame(e,t,i){if(this.isOngoingRenderLoopRunning)return;t=t||lT;const s=this;if(i||e||!this.standardRequestCallbackQueued&&!this.inRequestDrawCallback){if(e){const t=e;e=e=>{this.inRequestDrawCallback=!0,t(e),this.inRequestDrawCallback=!1}}else{if(this.disableAutomaticDrawing)return;e=function(e){s.standardRequestCallbackQueued=!1,s.inRequestDrawCallback=!0,s.draw(e,t),s.inRequestDrawCallback=!1},s.standardRequestCallbackQueued=!0}window.requestAnimationFrame(e)}}setInRequestDrawCallback(e){this.inRequestDrawCallback=e}forceRequestDraw(e){this.requestDraw(void 0,e,!0)}requestDrawForInteractiveProcessing(){this.requestDrawUsingTimer(undefined,uT)}resetPickPassCount(){this.pickPassCount=0}notifyOfPickPassCount(e){e>this.pickPassCount&&(this.pickPassCount=e)}getPickPassCount(){return this.pickPassCount}onGlContextLost(){this.resetCachedState(),this.resetSharedBuffers(),this.memoryGauge.reset(),this.frameTimer.onContextLost()}onGlContextRestored(){this.frameTimer.onContextRestored()}onSessionEnded(){this.resetShaders(),this.resetSharedBuffers(),this.resources.reset()}bindTextureToUnit(e,t){this.gl&&this.boundTextures[t]!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.boundTextures[t]=e)}getSketch(){return this.sketch}setSketch(e){this.sketch&&(e&&this.sketch.id===e.id||this.getModelViewManagers().getManager().displaySketchAsInactive(this.sketch.id),this.sketch=null);const t=this.getPrimaryViewController();e?(e.viewer=this,this.sketch=e,this.getModelViewManagers().getManager().displaySketchAsActive(this.sketch.id),t&&t.isPerspective()&&(this.returnToPerspective=!0,this.setPrimaryViewController(t.getMatchingOrthographicController())),(0,VM.xA)().trigger(VM.Fc,ms.SKETCH)):this.returnToPerspective&&(t&&t.isOrthographic()&&this.setPrimaryViewController(t.getMatchingPerspectiveController()),this.returnToPerspective=!1),this.getInputHandler()&&this.getInputHandler().setSketch(this.sketch),this.sketch||(0,VM.xA)().trigger(VM.Fc,ms.PART_STUDIO)}disableCurrentLaminarHighlightController(){const e=this.getFilteredEntitiesHighlightController();e&&(e.disable(),this.setFilteredEntitiesHighlightController(null))}clearSketch(e){this.sketch===e?this.setSketch(null):It.log.info("sketch to be cleared does not match the current sketch")}setHoveredSelection(e){if(this.clearHoveredSelection(),e instanceof ve.Y1)(0,ve.a3)(e);else if(e instanceof wh.i){const t=this.getUISelectionManager();t&&t.setHoveredSelection(e,{})}}clearHoveredSelection(){const e=this.getUISelectionManager();e&&e.setHoveredSelection(null,{});(0,ve.Zs)(!0,!1)}getInputHandler(){return this.inputHandler}setSuppressMouseMovePick(e){this.inputHandler&&this.inputHandler.setSuppressMouseMovePick(e)}getLastMouseMovedEvent(){return this.inputHandler?this.inputHandler.getLastMouseMovedEvent():null}getLastMouseLocation(){return this.lastMouseLocation}getFrustumToPreventCulling(){return this.frustumToPreventCulling}getResources(){return this.resources}setViewInitialized(e){this.viewInitialized=e}resetCachedState(){this.attribVertexEnabled={},this.boundTextures={}}resetShaders(){this.instantiatedShaders={},this.resetCachedState()}resetSharedBuffers(){this.sharedFrameBuffers={},this.sharedRenderBuffers={}}getOrCreateFrameBuffer(e,t,i){if(!t)return new Xo(this,e,t,i);let s=this.sharedFrameBuffers[t];return s||(this.sharedFrameBuffers[t]=s=new Xo(this,e,t,i)),s}getOrCreateRenderBuffer(e,t,i){const s=null==i?void 0:i.id;let n=null;if(!this.gl)return null;if(!s)return n=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,n),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,i.storageType,e,t),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),n;const r=this.sharedRenderBuffers[s];return r&&r.width===e&&r.height===t?r.buffer:(n=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,n),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,i.storageType,e,t),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.sharedRenderBuffers[s]={buffer:n,width:e,height:t},n)}resetExtensions(){const e=Object.keys(this.extensions);this.extensions={};for(let t=0;t<e.length;++t)this.getExtension(e[t])}getExtension(e){if(!this.gl)return null;let t=this.extensions[e];return void 0!==t||(t=this.gl.getExtension(e),this.extensions[e]=t),t}getMaximumTextureSize(){return this.gl?this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE):1024}isExtensionSupported(e){return!!this.getExtension(e)}areFloatTexturesSupported(){return this.isExtensionSupported("OES_texture_float")}isFloatBufferBlendingSupported(){return this.isExtensionSupported("EXT_float_blend")}are32BitIndicesSupported(){return this.isExtensionSupported("OES_element_index_uint")}areShaderDerivativesSupported(){return!!this.getExtension("OES_standard_derivatives")}isHighPrecisionFragmentShaderSupported(){return(0,Js.J5)(this.gl)}getAnisotropicExtension(){return this.getExtension("EXT_texture_filter_anisotropic")||this.getExtension("WEBKIT_EXT_texture_filter_anisotropic")}getDrawbuffersExtension(){return this.getExtension("WEBGL_draw_buffers")||this.getExtension("EXT_draw_buffers")}getVertexArrayExtension(){return this.getExtension("OES_vertex_array_object")}getHalfFloatType(){const e=this.getExtension("OES_texture_half_float");return e?e.HALF_FLOAT_OES:0}getDefaultFloatTextureType(){var e;return this.getHalfFloatType()||(null===(e=this.gl)||void 0===e?void 0:e.FLOAT)}getHighPrecisionFloatTextureType(){var e;return null===(e=this.gl)||void 0===e?void 0:e.FLOAT}getReferenceHighlights(){return this.referenceHighlights}getHighlightManager(e){return Ls.L.PREVIEW===e?this.compareHighlightManager:this.highlightManager}resetHighlightManagers(){this.highlightManager=new Ln(null),this.compareHighlightManager=new Ln(null)}updateHighlightColors(e){Ms.PoX.forEach((t=>{this.getReferenceHighlights().updateHighlightColor(t,e)})),Pl(e);for(const e in this.uiElements)this.uiElements[e].onHighlightColorUpdated()}areHighlightVertexTexturesSupported(){if(null===this.highlightVertexTexturesSupported)if(this.gl){const e=this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.highlightVertexTexturesSupported=e>1}else It.log.warn("An attempt was made to evaluate whether or not highlight vertex textures are supported before the gl context was initialized");return!!this.highlightVertexTexturesSupported}getRendererInfo(){return this.rendererInfo}isSSAOFilteringSupported(){return null===this.SSAOFilteringSupported&&(this.SSAOFilteringSupported=!/intel/gi.test(this.rendererInfo.glRenderer)),this.SSAOFilteringSupported}isHighPrecisionSupportedInFragmentShader(){if(null!==this.highPrecisionSupportedInFragmentShader)return this.highPrecisionSupportedInFragmentShader;if(!this.gl)return!1;const e=this.gl.getShaderPrecisionFormat(this.gl.FRAGMENT_SHADER,this.gl.HIGH_FLOAT);return this.highPrecisionSupportedInFragmentShader=!!e&&0!==e.precision,this.highPrecisionSupportedInFragmentShader}supportsOrderIndependentTranslucency(){return this.areFloatTexturesSupported()}supportsGraphicalSectionPlanes(){return this.areFloatTexturesSupported()&&this.isFloatBufferBlendingSupported()}getIsExcludingItemsForSection(){return(0,QS.Ky)().getIsExcludingItemsForSection()}supportsDraftAnalysis(){return this.areFloatTexturesSupported()}getTextureAtlasFactory(){return this.textureAtlasFactory||(this.textureAtlasFactory=new NC),this.textureAtlasFactory}debugGetAllocatedTextureUnitsString(){const e=Object.keys(this.textureNameToUnitMap);let t="Texture allocation: ";for(let i=0;i<e.length;++i)t+=e[i]+": "+this.textureNameToUnitMap[e[i]]+", ";return t}getOrAllocateTextureUnit(e){if(this.textureNameToUnitMap.hasOwnProperty(e))return this.textureNameToUnitMap[e];let t=0;for(;t<this.MAX_TEXTURE_UNITS&&this.textureUnitToNameMap[t];)t++;return t>=this.MAX_TEXTURE_UNITS?(It.log.error("Ran out of texture units (max "+this.MAX_TEXTURE_UNITS+") storing "+e+". Allocation: "+this.debugGetAllocatedTextureUnitsString()),-1):(this.textureNameToUnitMap[e]=t,this.textureUnitToNameMap[t]=e,t)}releaseTextureUnit(e){if(!this.textureNameToUnitMap.hasOwnProperty(e))return void It.log.error("Could not find texture unit for "+e);const t=this.textureNameToUnitMap[e];delete this.textureNameToUnitMap[e],delete this.textureUnitToNameMap[t]}getTextureUnit(e){return this.textureNameToUnitMap[e]}getGlContext(){return this.gl}getShader(e){let t=this.instantiatedShaders[e];return t||(t=new wf(this,e),this.instantiatedShaders[e]=t),t}enableVertexAttributeArray(e,t){(this.areVertexArrayObjectsAvailable||this.attribVertexEnabled[e]!==t)&&this.gl&&(t?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e),this.areVertexArrayObjectsAvailable||(this.attribVertexEnabled[e]=t))}disableAllVertexAttributeArrays(){for(const e in this.attribVertexEnabled)this.enableVertexAttributeArray(+e,!1)}setupGlContext(){if(this.gl=null,!(this.el instanceof HTMLCanvasElement))return;let e=null;const t=["webgl","experimental-webgl","webkit-3d","moz-webgl"];for(let i=0;i<t.length;++i){try{e=this.el.getContext(t[i],dT),e instanceof WebGLRenderingContext||e instanceof CaptureContext||(e=null)}catch(e){}if(e)break}e&&(this.gl=e,this.onNewGlContext())}onNewGlContext(){this.gl&&(this.gl.frontFace(this.gl.CCW),this.gl.enable(this.gl.DEPTH_TEST)),this.resetExtensions(),this.rendererInfo=Qt(this.gl),(0,ZS.WD)(this.rendererInfo),this.glSyncEveryFrame=(0,Et.isPlatformMac)()&&(0,Et.isBrowserSafari)()&&/intel/i.test(this.rendererInfo.glVendor),this.renderContext.onNewContext(this.gl),ai(this.are32BitIndicesSupported()),(0,_h.Vp)(this.rendererInfo)}getWebGlSupport(){let e=KS.c.SUPPORTED;return this.el?window.WebGLRenderingContext?this.gl||(e=KS.c.OTHER_PROBLEM):e=KS.c.MISSING:e=KS.c.OTHER_PROBLEM,e}getViewerId(){return this.cid}getFrameTimer(){return this.frameTimer}setDevicePixelRatioOverride(e){var t;const i=aT(Math.max(this.$el.width(),1),e),s=aT(Math.max(this.$el.height(),1),e);(0,Es.Lt)(e),this.el.width=i,this.el.height=s,null===(t=this.getCamera())||void 0===t||t.setViewportFromCanvasElement(this.$el),this.stopBoxSelection(),this.draw()}onResize(e){var t;e=void 0===e||e;const i=this.getGlContext();if(!i)return;if(!this.el)return;let s=(0,Es.XC)(),n=aT(Math.max(this.$el.width(),1),s),r=aT(Math.max(this.$el.height(),1),s);if((0,Et.isBrowserSafari)()){const e=aT(screen.width,s),t=aT(screen.height,s);if(n>e||r>t){const i=Math.min(e/n,t/r);It.log.info("Canvas dimensions exceeded screen size, scaling by a factor of: "+i.toFixed(4)),s*=i,(0,Es.Lt)(s),n=aT(Math.max(this.$el.width(),1),s),r=aT(Math.max(this.$el.height(),1),s)}else(0,Es.eu)()}this.el.width=n,this.el.height=r,i.viewportWidth=this.el.width,i.viewportHeight=this.el.height,i.aspectRatio=this.el.width/this.el.height,this.mainDrawPass&&(this.setUserIsManipulatingWithTimeout(),null===(t=this.getCamera())||void 0===t||t.setViewportFromCanvasElement(this.$el),this.stopBoxSelection(),e&&this.requestDraw())}pushCameraState(e){const t=e||this.getCamera();t?(this.renderContext.setActiveCamera(t),this.renderContext.pushModelViewMatrix(t.getViewMatrix()),this.renderContext.pushProjectionMatrix(t.getProjectionMatrix()),this.renderContext.pushViewport(t.getViewport())):It.log.warn("Camera not found")}popCameraState(){this.renderContext.popModelViewMatrix(),this.renderContext.popProjectionMatrix(),this.renderContext.popViewport()}setBaseFrameBuffer(e){this.baseFrameBuffer=e}setBaseFrameBufferToDefault(){this.baseFrameBuffer=null}getBaseFrameBufferWidth(){return this.baseFrameBuffer?this.baseFrameBuffer.getWidth():this.getCamera().getCanvasWidth()}getBaseFrameBufferHeight(){return this.baseFrameBuffer?this.baseFrameBuffer.getHeight():this.getCamera().getCanvasHeight()}onComputedData(e){if(e.elementId!==this.activeElementId)return;(this.modelViewManagers.getPreviewManager()||this.modelViewManagers.getManager()).processManagedData(e),this.readyAndUpdateElementLoadState(e.elementId)}readyAndUpdateElementLoadState(e){e===this.activeElementId&&(this.readyToUpdateElementLoadState=!0,this.updateElementLoadState())}onFeatureData(e){e===this.activeElementId&&(this.receivedFeatureData=!0,this.updateElementLoadState())}onAssemblyDefinition(e){e===this.activeElementId&&(this.receivedAssemblyDefinition=!0,this.readyToUpdateElementLoadState=!0,this.updateElementLoadState())}setWaitingForLinkOpen(){this.isReadyForDrawOnLinkOpen=!1}onReadyForDrawOnLinkOpen(){this.isReadyForDrawOnLinkOpen=!0,this.updateElementLoadState()}prepareElementDisplayData(){var e;this.elementLoadState===cT.LOADING_DISPLAY_DATA&&(this.modelViewManagers.getManager().getModelBounds(),null===(e=this.loadingDisplayDataTimer)||void 0===e||e.report(),this.loadingDisplayDataTimer=null,this.elementLoadState=cT.LOADED_DISPLAY_DATA,this.updateElementLoadState())}updateElementLoadState(){const e=this.modelViewManagers.getManager();this.elementLoadState!==cT.LOADED_DISPLAY_DATA||!this.readyToUpdateElementLoadState||!this.isReadyForDrawOnLinkOpen||!this.receivedFeatureData&&e.displayingPartStudio()||!this.receivedAssemblyDefinition&&e.displayingAssembly()||(this.getEventDispatcher().trigger(VM.cp,this.activeElementId),this.elementLoadState=cT.LOADED_ALL_DATA,this.clearElementPreview(),this.bodyLoadTask.hasPendingWork()?(this.doesControlBodySpinner()&&(0,af.l)().startBodyLoadBeeper(),this.bodyLoadTimer=new mh.B7("Loading bodies, isForFlattened: "+this.getIsForFlattenedDisplay(),ET())):this.doesControlBodySpinner()&&(0,af.l)().stopBodyLoadBeeper(),this.loadTimer&&(this.loadTimer.report(),this.loadTimer=null),this.setReadyState(!0),this.requestDraw())}hasPendingBodiesToLoad(){return this.bodyLoadTask.hasPendingWork()}getPendingBodiesToLoadPromise(){return this.bodyLoadTask.getTaskFinishedPromise()}hasPendingWork(){return this.bodyLoadTask.hasPendingWork()||this.taskManager.hasPendingWork()}doesControlBodySpinner(){return!this.getIsForFlattenedDisplay()}getRenderContext(){return this.renderContext}getMemoryGauge(){return this.memoryGauge}getRenderingMode(){return this.renderingMode}preventChangeToRenderMode(e){var t;return!!(null===(t=this.getCurvatureAnalysisManager())||void 0===t?void 0:t.preventChangeToRenderMode(e))||(!!this.preventZebraStripesDuringInterferenceDetection(e)||!this.getIsPrimaryViewer()&&e===W.P1.SHADED_CURVATURE_VISUALIZATION)}preventZebraStripesDuringInterferenceDetection(e){const t=i18n("Zebra stripes are not supported during interference detection");if(void 0===e&&this.renderingMode===W.P1.CURVATURE_VISUALIZATION)return ps.Jq.MessageBubbleService.showMessageWithAutoDismiss(t,"warning"),this.setRenderingMode(W.P1.SHADED_WITH_EDGES),!0;if(e===W.P1.CURVATURE_VISUALIZATION){if(gi._3.getOpenDocumentController().isInterferenceDetectionActive())return ps.Jq.MessageBubbleService.showMessageWithAutoDismiss(t,"warning"),!0}return!1}setRenderingMode(e){var t,i,s,n;if(this.preventChangeToRenderMode(e))return;this.renderingMode=e,this.renderContext.setRenderingMode(e),null===(t=this.mainDrawPass)||void 0===t||t.setRenderingMode(e),null===(i=this.combinedPickPass)||void 0===i||i.setRenderingMode(e);const r=this.getModelViewManagers().getManager().getSimulationManager();r&&r.onRenderingModeChanged(),null===(s=this.getCurvatureAnalysisManager())||void 0===s||s.onRenderingModeChanged(),null===(n=this.getThicknessAnalysisManager())||void 0===n||n.onRenderingModeChanged(),this.resources.onRenderingModeChanged(),this.modelViewManagers.onRenderingModeChanged(),this.renderModeSubject.next(e),this.getIsPrimaryViewer()&&(this.followGraphicsData.renderingMode=e,this.followGraphicsDataSubject.next(this.followGraphicsData)),this.requestDraw()}toggleDebugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle(){this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle=!this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle}debugIsShowingSilhouetteEdgesOnNonVisibleTangentEdgeStyle(){return this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle}showTangencyInformationMissingMessage(){this.localDisplayDataCacheCleared||(It.log.trace("Unknown smoothness status edge found, clearing local display data cache"),(0,fr.m)().trigger(mr.C.CLEAR_LOCAL_DISPLAY_DATA_CACHE),this.localDisplayDataCacheCleared=!0),ps.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Render mode could not be applied. Necessary information is missing in older display data."),"warning")}getSmoothEdgesRenderStyle(){return this.smoothEdgeStyle}setSmoothEdgesRenderStyle(e){if(this.smoothEdgeStyle===e)return;this.smoothEdgeStyle=e,this.getIsForFlattenedDisplay()||Tp(e),this.resources.updateSmoothEdgeColor();const t=this.getModelViewManagers();if(t.getManager().refreshSmoothEdgesForAllPartStudios()){if(t.previewManagerExists()&&t.getPreviewManager().refreshSmoothEdgesForAllPartStudios(),!this.getIsForFlattenedDisplay()){const t=pa.t.getController();t&&t.onSmoothEdgeStyleChanged(this);const i=gi._3.getOpenDocumentController();if(i){const t=i.getSheetMetalViewer();t&&this!==t&&this.getActiveElementId()===t.getActiveElementId()&&(t.setSmoothEdgesRenderStyle(e),t.requestDraw())}}this.getIsPrimaryViewer()&&(this.followGraphicsData.smoothEdgeStyle=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}else this.setSmoothEdgesRenderStyle(W.YUG.VISIBLE)}initializeForDrawing(){this.initializedForDrawing||(this.onResize(),this.mainDrawPass=new Rt(this),this.drawPasses.push(this.mainDrawPass),this.combinedPickPass=new Re(this,this.mainDrawPass),this.mainDrawPass.getDebugDrawPickPass().setPickPass(this.combinedPickPass),this.drawPasses.push(this.combinedPickPass),this.depthRetrievalPass=new Xe(this),this.drawPasses.push(this.depthRetrievalPass),this.draftAngleRetrievalPass=new pt(this),this.drawPasses.push(this.draftAngleRetrievalPass),this.depthSamplingPass=new le(this),this.drawPasses.push(this.depthSamplingPass),this.mainDrawPass.prepareShaders(),this.combinedPickPass.prepareShaders(),this.depthRetrievalPass.prepareShaders(),this.depthSamplingPass.prepareShaders(),this.viewController||(this.viewController=new lr(this),this.viewController.getCamera().setViewportFromCanvasElement(this.$el),this.viewController.setStandardView(this.getDefaultStandardView())),this.initializedForDrawing=!0,(0,Et.isPlatformChromebook)()&&(0,Et.getChromeVersion)()>=107&&this.mainDrawPass.setClearColor(1,1,1,1))}initializeView(){if(!this.viewInitialized){const e=this.getCamera(),t=e.getViewportWidth()*e.getViewportHeight()>=oT.getNumber("MIN_MODEL_PIXEL_SIZE"),i=this.getModelBounds();if(t&&i.isInitialized()&&i.isExtensive()){const e=!0;this.zoomFit(e),this.viewInitialized=!0}this.findDepthsInRect(0,0,1,1)}}hasResourcesNeededForDrawing(){const e=!this.isForFlattenedDisplay||this.modelViewManagers.getManager().hasSelectedSheetmetalModelId();return(this.hasElementPreviewLoaded||this.elementLoadState===cT.LOADED_ALL_DATA)&&!ho()&&e}isReadyForDrawing(){return!!this.getGlContext()&&this.initializedForDrawing&&this.hasResourcesNeededForDrawing()}getFilteredEntitiesHighlightController(){return this.filteredEntitiesHighlightController}onLaminarEdgesChanged(e){this.getIsPrimaryViewer()&&(this.followGraphicsData.isBoundaryEdgeHighlightOn=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}setFilteredEntitiesHighlightController(e){return this.filteredEntitiesHighlightController=e,this.filteredEntitiesHighlightController}draw(e,t){if(this.viewerDestroyed)return;const i=this.getGlContext();if(!i)return;t=t||pT;const s=(0,Es.x_)();if(s!==this.lastDevicePixelRatio){t.forPrint||this.el.width===aT(this.$el.width(),s)&&this.el.height===aT(this.$el.height(),s)||this.onResize(!1),this.lastDevicePixelRatio=s;const e=t.camera||this.getCamera();this.getEventDispatcher().trigger(VM.b3,e),this.resources.onDevicePixelRatioChanged();for(const t in this.uiElements)this.uiElements[t].onDevicePixelRatioChanged(e);this.resetPickRadius()}if(e){if(e===this.timestampOfLastDraw)return;this.timestampOfLastDraw=e,za(this,e)}if(this.initializeForDrawing(),!this.mainDrawPass)return;if(this.prepareElementDisplayData(),!this.hasResourcesNeededForDrawing())return void(this.hidden||this.processPendingWork());this.initializeView(),t.performFrameTiming&&this.frameTimer.onDrawStart(),this.renderContext.setDetailSettings(this.detailManager.getDetailSettings()),(0,Un.qn)().resetCounters();const n=t.camera?t.camera:this.getCamera();this.triggerOnViewWillDraw(n),this.processPendingWork(),this.cleanUpOrphanedObjects(),n.setSceneBounds(this.getSceneBounds()),this.pushCameraState(n),t.skipUpdateBodyCulling||this.bodyManager.updateForFrame(this.renderContext,!0),this.renderContext.prepareForNextFrame(),this.mainDrawPass.drawInputs(this.renderContext),this.mainDrawPass.draw(this.renderContext),this.popCameraState(),this.getEventDispatcher().trigger(VM.u9,this),this.memoryGauge.addToStatistics(),(0,Un.qn)().updateModel(),this.performBodyCheckAsNeeded(),this.glSyncEveryFrame&&i.finish(),t.performFrameTiming&&this.frameTimer.onDrawEnd()}triggerOnViewWillDraw(e){const t=(0,Ir.vx)();this.getEventDispatcher().trigger(VM.Hv,e,t);for(const i in this.uiElements)this.uiElements[i].onViewWillDraw(e,t)}processPendingWork(){this.taskManager.hasPendingWork()&&!this.frameTimer.userIsInteracting()&&(this.taskManager.processInteractively(),this.requestDrawForInteractiveProcessing()),this.bodyLoadTask.hasPendingWork()||(this.bodyLoadTimer&&(this.doesControlBodySpinner()&&(0,af.l)().stopBodyLoadBeeper(),this.bodyManager.initiateAutomaticRetrieval(),this.bodyLoadTimer.report(),this.frameTimer.resetTimings(),this.bodyLoadTimer=null),this.hasResourcesNeededForDrawing()||this.modelViewManagers.getManager().getMeshManager().compileBuffers())}performBodyCheckAsNeeded(){this.performBodyCheck&&this.areFloatTexturesSupported()&&!this.bodyLoadTask.hasPendingWork()&&this.modelViewManagers.getManager().displayingPartStudio()&&(this.bodyCheckPass.draw(this.renderContext),this.performBodyCheck=!1)}cleanUpOrphanedObjects(){this.getUiResourceManager().clean(),es(),this.disableAllVertexAttributeArrays()}getSceneBounds(){let e=new Li.kB;const t=this.sceneGraphs.getMainSceneGraph().getRootNode().getBoundingBox({includeHiddenBounds:this.renderContext.getIsPickingHiddenOccurrences()}),i=this.sceneGraphs.getPreviewSceneGraph().getRootNode().getBoundingBox();e.addBox(t),e.addBox(i);const s=this.modelViewManagers.getManager().getSimulationManager();s&&e.addBox(s.getSimulationBounds());return(!e.isInitialized()||!e.isExtensive())&&this.hasElementPreviewLoaded&&this.activeElementPreviewManager&&e.addBox(this.activeElementPreviewManager.getModelBounds()),this.zoomToSelectionBounds&&this.zoomToSelectionBounds.isFinite()&&e.addBox(this.zoomToSelectionBounds),e.isInitialized()&&e.isExtensive()||(e=this.getDefaultBounds()),e}getDefaultBounds(){const e=new Li.kB;return e.set([-1,-1,-1],[1,1,1]),e}getModelBounds(e){const t=new Li.kB,i=this.modelViewManagers.getManager().getModelBounds(e);i&&t.addBox(i,null);const s=this.modelViewManagers.getPreviewManager();return s&&t.addBox(s.getModelBounds(e),null),t.isInitialized()&&t.isExtensive()||!this.hasElementPreviewLoaded||!this.activeElementPreviewManager||t.addBox(this.activeElementPreviewManager.getModelBounds()),t}getUiElementsBounds(){const e=new Li.kB;for(const t in this.uiElements){const i=this.uiElements[t];i.isVisibleToUser()&&e.addBox(i.getFitBounds(),i.getTransform())}return e}getFitBounds(e){var t,i;let s=this.getUiElementsBounds();if(s.addBox(this.getModelBounds()),!s.isInitialized()||!s.isExtensive())return this.getSceneBounds();if((0,QS.ti)()>0&&this.isReadyForDrawing()&&this.depthSamplingPass){e||(e=null===(t=this.getCamera())||void 0===t?void 0:t.getFrame());const n=null===(i=this.getPrimaryViewController())||void 0===i?void 0:i.getZoomFitTargetCamera(e,s,!0);if(!n)return s;this.pushCameraState(n),(0,QS.qf)(),this.bodyManager.updateForFrame(this.renderContext,!1),this.depthSamplingPass.retrieve(this.renderContext,{numSamples:oT.getNumber("HIGH_QUALITY_DEPTH_SAMPLES_PER_VIEWPORT"),performIsolationTest:!1}),this.popCameraState();const r=new Li.kB;for(let e=0;e<this.depthSamplingPass.points.length;++e)r.addPoint(n.canvasToWorld(this.depthSamplingPass.points[e]));if(!r.isInitialized()||!r.isExtensive())return this.getSceneBounds();r.maxDimension()/s.maxDimension()<.9&&r.scale(oT.getNumber("CAMERA_ZOOM_TO_FIT_SECTION_PLANE_EXTRA_SLOP")),s=r}return s}getAnimationController(){return this.animationController}getPrimaryViewController(){return this.viewController}getFollowGraphicsDataObservable(){return this.followGraphicsDataSubject.asObservable()}getCurrentFollowingGraphicsData(){return this.followGraphicsData}getCamera(){return this.debugCamera?this.debugCamera:this.viewController?this.viewController.getCamera():null}setPrimaryViewController(e){this.viewController!==e&&(this.viewController=(0,Q.as)(hr,e),this.requestDraw())}setPickRadius(e){this.pickRadius=e}resetPickRadius(){this.setPickRadius(oT.getNumber("MOUSE_PICK_RADIUS_PX"))}pick(e,t,i){return this.pickIteratively(e,t,this.getDefaultPickTerminationEvaluator(),i)}getDefaultPickTerminationEvaluator(){let e=0;return(t,i)=>++e>100||(!this.combinedPickPass||this.combinedPickPass.updatePickMask(t,this.renderingMode,i))}pickIteratively(e,t,i,s){var n,r;const a=[];let o,h;const c=2*this.pickRadius+1,l=2*this.pickRadius+1,u=e-this.pickRadius,d=t-this.pickRadius;let g=!1,p=0;const m={},f=(0,Q.as)(Sh,this.modelViewManagers.getManagerForUsage(qs())),I=this.getRenderingMode();for(;;){const e=this.pickInRect(u,d,c,l,{pickHiddenOccurrences:!!s&&!!s.pickHiddenOccurrences,cameraOverride:s?s.cameraOverride:null});if(e.length<1)break;for(o=0;o<e.length;++o){h=e[o];const t=h.getModelSelection();if(t){const e=t.getIdForCollection();if(!e||m[e])continue;m[e]=e}h.fromPass=p,h.entityMetaData&&this.getSketch()&&(h.isFromActiveSketch=h.entityMetaData.getSketchFeatureId()===(null===(n=this.getSketch())||void 0===n?void 0:n.getId())),a.push(h)}if(i(e,s))break;for(o=0;o<e.length;++o)e[o].canPickThrough(I,this,s)&&(this.hidePick(e[o],f),g=!0);++p}return null===(r=this.combinedPickPass)||void 0===r||r.clearPickMask(),g&&this.resetIdsHiddenFromPick(),s&&s.altKey?(0,jS.Z)(a,(e=>{const t=e.getModelSelection();if(null===t)return It.log.warn("Cannot determine translucency of pick element for sorting, assuming default opacity."),!1;if(t.entityMetaData&&t.entityMetaData.isTranslucent())return!0;const i=t.getOccurrence(),s=e.getOccurrenceId(),n=f.getPartStudioDataFromOccurrence(i);if(!n)return!1;const r=n.getBodyComponent().getFaceColor(null==e?void 0:e.deterministicId,s);return r&&r[3]<1})):a.sort(jS.G)}pickMany(e,t,i,s){const n=2*i+1,r=2*i+1,a=e-i,o=t-i;return this.pickManyInRect(a,o,n,r,!0,!1,s)}pickInRect(e,t,i,s,n){var r;if(!this.isReadyForDrawing()||!this.combinedPickPass)return[];const a=n&&n.cameraOverride?n.cameraOverride:this.getCamera();this.getEventDispatcher().trigger(VM.b9,a,(0,Ir.vx)());const o=null==n?void 0:n.pickHiddenOccurrences;let h,c;this.renderContext.setIsPickingHiddenOccurrences(!!o),null==a||a.setSceneBounds(this.getSceneBounds()),this.pushCameraState(a),this.combinedPickPass.setPickRect(e,t,i,s,n&&n.sampleLimit),n&&n.doNotAffectFrustumCulling||(this.frustumToPreventCulling=this.combinedPickPass.getPickFrustum(this.renderContext,rT)),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),n&&n.nodeFilterOverride?this.combinedPickPass.setNodeFilterOverride(n.nodeFilterOverride):this.combinedPickPass.setNodeFilterOverride(null),this.combinedPickPass.setPickFromPreview(Xs()||!!n&&!!n.forcePreviewPick),this.combinedPickPass.draw(this.renderContext),this.renderContext.setIsPickingHiddenOccurrences(!1),this.popCameraState();const l=this.combinedPickPass.gatherPicksFromPickPass(),u=[];let d;const g=this.modelViewManagers.getManagerForUsage(this.combinedPickPass.getUsage());for(c in l){c=+c;const e=this.getOccurrenceIdManager().getNameForId(+c);e||c===DI.QC||this.loggedPickIssue||(It.log.warn("Did not find valid occurrence name for occurrence id: "+c),this.loggedPickIssue=!0);let t=null,i=null;const s=ZI(e);if(s){if(i=this.uiElements[e],!i){this.loggedPickIssue||(It.log.warn("Could not find ui element with name: "+e),this.loggedPickIssue=!0);continue}}else e&&"PART_STUDIO_SKETCHES"!==e&&0!==e.indexOf("body.")&&(t=W._oC.getOccurrenceFromPathString(e));for(h in l[c]){if(d=l[c][h],s){if(d.uiSelection=null==i?void 0:i.getSelection(d.occurrenceId,d.primitiveId),!d.uiSelection){this.loggedPickIssue||(It.log.warn("Could not find owner of mouse pick"),this.loggedPickIssue=!0);continue}d.uiSelection.sourcePick=d}else{if(this.bodyManager.isBodyManagerOccurrence(t)){o?this.bodyManager.updatePickData(d)&&u.push(d):n&&n.bodyPicks?n.bodyPicks.push(d):this.bodyManager.pickedOccurrenceId(d.primitiveId);continue}{if(d.deterministicId=g.getDeterministicIdForPickId(t,d.primitiveId),!d.deterministicId){this.loggedPickIssue||(It.log.warn("Did not find picked entity's deterministic id"),this.loggedPickIssue=!0);continue}const e=g.retrieveEntityMetaData(t,d.deterministicId);if(d.featureIdList=g.retrieveAssociatedFeatureIds(t,d.deterministicId),e)d.entityMetaData=e;else if(d.bodyMetaData=g.retrieveBodyMetaData(t,d.deterministicId),!d.bodyMetaData){this.loggedPickIssue||(It.log.warn("Did not find picked deterministic id's metadata"),this.loggedPickIssue=!0);continue}d.occurrence=t}}u.push(d)}}return(null===(r=this.mainDrawPass)||void 0===r?void 0:r.getDebugDrawPickPass().getEnabled())&&this.requestDraw(),u}retrieveVisiblePicks(e,t,i,s){if(!this.combinedPickPass)return It.log.warn("Pick pass is not initialized"),null;this.combinedPickPass.setEnablePickViewportScaling(!1);const n=this.pickInRect(e,t,i,s);return this.combinedPickPass.setEnablePickViewportScaling(!0),n}getUiElements(){return this.uiElements}pickManyInRect(e,t,i,s,n,r,a){var o,h;null===(o=this.combinedPickPass)||void 0===o||o.setPickAlternatesEnabled(!0),this.renderContext.setBackFacePicking(n),r&&this.subtractEntitiesIntersectingBox(e,t,i,s);const c=this.pickManyInRectInternal(e,t,i,s,a);return this.renderContext.setBackFacePicking(!1),null===(h=this.combinedPickPass)||void 0===h||h.setPickAlternatesEnabled(!1),this.resetIdsHiddenFromPick(),c}subtractEntitiesIntersectingBox(e,t,i,s){const n=this.getCamera();if(!n)return;const r=Math.max(e-1,0),a=Math.max(t-1,0),o=Math.min(t+s,n.getViewportHeight()-1),h=Math.min(e+i,n.getViewportWidth()-1);this.pickAllInBox(r,a,h-r,1),this.pickAllInBox(r,o,h-r,1),o-a>2&&(this.pickAllInBox(r,a+1,1,o-a-2),this.pickAllInBox(h,a+1,1,o-a-2))}pickAllInBox(e,t,i,s){this.pickManyInRectInternal(e,t,i,s,void 0,void 0,!0)}performingBoxSelection(){return!!this.boxSelectionDeferred}performBoxSelection(e,t,i,s,n){var r,a;if(this.performingBoxSelection())return null;if(0===i||0===s)return null;(0,af.l)().startBoxSelectionBeeper(),(0,ve.B8)(),null===(r=this.combinedPickPass)||void 0===r||r.setPickAlternatesEnabled(!0),null===(a=this.combinedPickPass)||void 0===a||a.setIsBoxSelecting(!0),this.renderContext.setBackFacePicking(!0),n&&this.subtractEntitiesIntersectingBox(e,t,i,s),this.boxSelectionDeferred=$r.defer();const o=this.boxSelectionDeferred.promise,h=this,c=function(){if(!h.performingBoxSelection())return;h.setUserIsManipulatingWithTimeout();const n=h.pickManyInRectInternal(e,t,i,s,void 0,15,!0);n.length>0?((0,ve.d)(n),(0,VM.xA)().trigger(Ms.f4Y,n),h.draw(),setTimeout(c,45)):((0,ve.mO)(),h.stopBoxSelection())};return setTimeout(c,10),o}setSuppressNonIsolatedPicks(e){var t;null===(t=this.combinedPickPass)||void 0===t||t.setSuppressNonIsolatedPicks(e)}stopBoxSelection(){var e,t,i;this.performingBoxSelection()&&(this.renderContext.setBackFacePicking(!1),null===(e=this.combinedPickPass)||void 0===e||e.setIsBoxSelecting(!1),null===(t=this.combinedPickPass)||void 0===t||t.setPickAlternatesEnabled(!1),this.resetIdsHiddenFromPick(),null===(i=this.boxSelectionDeferred)||void 0===i||i.resolve(),this.boxSelectionDeferred=null,(0,af.l)().stopBoxSelectionBeeper(),(0,ve.B8)(),this.processQueuedDisplayData(),this.doPreHighlightPick(!0),(0,VM.xA)().trigger(Ms.KB0))}canProcessDisplayData(){return this.haveUnitsBeenReceived&&!this.performingBoxSelection()}processQueuedDisplayData(e){if(e&&this.stopBoxSelection(),this.canProcessDisplayData()){for(let e=0;e<this.queuedDisplayData.length;++e){const t=this.queuedDisplayData[e];t.displayData instanceof W.hDL?this.onNewPartStudioDisplayData(t.displayData,t.selectionMapper):t.displayData instanceof W.F_7&&this.onRootAssemblyDisplayData(t.displayData)}this.queuedDisplayData=[]}}setUnitsReceived(e){this.haveUnitsBeenReceived=e,e&&this.processQueuedDisplayData()}isPickFromHiddenOccurrence(e){const t=this.occurrenceDataManager.getOccurrenceData(e.occurrenceId);return!!t&&t.getVisibility()===Js.EE.HIDDEN}resetIdsHiddenFromPick(){this.occurrenceDataManager.resetHiddenFromPick(),(0,QS.X9)();const e=this.getModelViewManagers().getManager();for(let t=0;t<this.selectionsToKeepHiddenFromPick.length;++t){const i=this.selectionsToKeepHiddenFromPick[t],s=e.getEntityIdsForSelection(i),n=e.getOccurrenceIdForSelection(i),r=i.getOccurrence();if((0,DI.$J)(n))for(let t=0;s&&t<s.length;++t)e.hideEntityFromPick(s[t],n,r)}}setSelectionsToKeepHiddenFromPick(e){this.selectionsToKeepHiddenFromPick=e,this.resetIdsHiddenFromPick()}resetSelectionsToKeepHiddenFromPick(){this.setSelectionsToKeepHiddenFromPick([])}getClosestPointAtPixel(e,t,i){const s=2*i+1,n=2*i+1,r=e-i,a=t-i,o=this.findDepthsInRect(r,a,s,n);let h=null,c=1/0;for(let e=0;e<o.length;++e)if(o[e][2]!==Js.BG){const t=o[e],i=t[2];i<c&&(h=t,c=i)}return h?(h[0]=e,h[1]=t,this.getCamera().canvasToWorld(h)):null}pickManyInRectInternal(e,t,i,s,n,r,a){const o=[];let h=new St.StringSet;const c=new St.StringSet,l=(0,Js.Wj)();let u=!1;const d=a?(0,ve.y_)():(0,ve.Nd)();if(a){u=(0,ve.Ac)().allowsBodies}const g=(0,Q.as)(Sh,this.modelViewManagers.getManagerForUsage(qs()));let p=0;do{const r=this.pickInRect(e,t,i,s),a=new St.StringSet;for(let e=0;e<r.length;++e){const t=r[e];t.fromPass=p;let i=!0,s=t.getId();const l=t.getBodyId();if(l&&u){const e=l+Pn.ID_SEPARATOR+t.occurrenceId;c.contains(e)?i=!1:!d||d.doesBodyLevelSelectionPass(t.getModelSelection())?(g.hideBodyFromPick(l,t.occurrenceId,t.occurrence),c.add(e),s=e):this.hidePick(t,g)}else this.hidePick(t,g);if(h.contains(s))return It.log.warn("The same pick was found twice, when it should have been hidden"),[];if(a.add(s),i&&o.push(t),n&&o.length>=n)break}if(0===r.length||n&&o.length>=n)break;h=a,++p}while(void 0===r||(0,Js.Wj)()-l<r);return o}hidePick(e,t){e.isUIPick()?e.uiSelection.hideFromPick():!e.deterministicId&&e.isBodyPick()?this.bodyManager.hideBodyFromPick(e):t.hideEntityFromPick(e.getIncrementId(),e.occurrenceId,e.occurrence),(0,QS.Mi)(e.occurrenceId)}findDepthsInRect(e,t,i,s,n,r){return this.isReadyForDrawing()&&this.depthRetrievalPass?(this.pushCameraState(r),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),n=void 0===n||n,this.depthRetrievalPass.setPickRect(e,t,i,s),this.depthRetrievalPass.retrieve(this.renderContext,n),this.popCameraState(),this.depthRetrievalPass.points):[]}findDraftAngle(e,t,i,s,n){return s=s||1,n=n||1,this.isReadyForDrawing()&&this.draftAngleRetrievalPass&&this.mainDrawPass?(this.pushCameraState(),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),this.draftAngleRetrievalPass.setOccurrenceIds(this.mainDrawPass.draftAnalysisPass.getIdsToParts()),this.draftAngleRetrievalPass.setDirection(e),this.draftAngleRetrievalPass.setPickRect(t,i,s,n),this.draftAngleRetrievalPass.retrieve(this.renderContext),this.popCameraState(),this.draftAngleRetrievalPass.points):[]}findScalarVisualizationScalar(e,t,i,s,n,r){if(!this.isReadyForDrawing())return[];n=n||1,r=r||1;let a=this.scalarRetrievalPasses.find((t=>t.managerNodeId===e));a||(a=new bt(this,e),this.scalarRetrievalPasses.push(a),this.drawPasses.push(a)),this.pushCameraState(),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),a.setPickRect(i,s,n,r);const o=a.retrieve(this.renderContext,t);return this.popCameraState(),o}retrieveSelectionPosition(e){return this.retrieveCanvasLocationWorldPosition(e.getPickLocation())}retrieveCanvasLocationWorldPosition(e){if(!this.isReadyForDrawing()||!this.depthRetrievalPass)return null;const t=e;if(!t)return null;this.depthRetrievalPass.setRetrieveFromPreview(!1);const i=this.findDepthsInRect(t[0],t[1],1,1);return this.depthRetrievalPass.setRetrieveFromPreview(!0),i.length>0&&i[0][2]!==Js.BG?this.getCamera().canvasToWorld(i[0]):null}retrieveDepthSampling(e){return this.isReadyForDrawing()&&this.depthSamplingPass?(this.pushCameraState(),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),this.depthSamplingPass.retrieve(this.renderContext,e),this.popCameraState(),this.depthSamplingPass.points):[]}retrieveHighlightsOnlyDepthSampling(){return this.isReadyForDrawing()&&this.depthSamplingPass?(this.pushCameraState(),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),this.depthSamplingPass.retrieve(this.renderContext,{useHighlightsOnly:!0}),this.popCameraState(),this.depthSamplingPass.points):[]}addUIElement(e){this.uiElements[e.getCollectionId()]=e}removeUIElement(e){delete this.uiElements[e.getCollectionId()],this.uiSelectionManager.removeSelectionForUiElement(e)}destroy(){var e,t;if(this.viewerDestroyed)return;this.selectOtherView&&this.selectOtherView.destroy(),this.areSectionPlanesEnabled()&&(0,QS.UB)(!1),ed(),this.stopBoxSelection();const i=this.uiElements;this.uiElements={};for(const e in i)i[e]&&i[e].remove();this.referenceHighlights.destroy(),this.resetHighlightManagers(),this.getEventDispatcher()&&this.getEventDispatcher().trigger(VM.so),this.sceneGraphs.destroySceneGraphs(),this.cleanUpOrphanedObjects(),this.getOccurrenceIdManager().reset(),ka(),this.el.removeEventListener("webglcontextlost",this.handleContextLoss,!1),this.el.removeEventListener("webglcontextrestored",this.handleContextRestored,!1),this.el.width=0,this.el.height=0,this.renderContext.destroy(),this.bodyManager.destroy(),II(),(0,Js.Dz)(this.getViewerId()),this.resetPickPassCount(),(0,Jr.Z)(this.recordCapabilitiesTimeout)&&(clearTimeout(this.recordCapabilitiesTimeout),this.recordCapabilitiesTimeout=null),(0,Jr.Z)(this.drawTimer)&&(clearTimeout(this.drawTimer),this.drawTimer=null),this.remove(),this.$el.off(),this.elementUnitChangedSubscription.unsubscribe(),this.modelViewManagers.clearTheManagers(),this.sceneGraphs.destroySceneGraphs(),this.occurrenceDataManager.destroy(),this.isolatedOccurrenceManager.destroy(),this.edgePointController&&this.edgePointController.disable(),this.inputHandler&&this.inputHandler.remove(),null===(e=this.themeChangeSubscription)||void 0===e||e.unsubscribe(),null===(t=this.latestDisplayDataUsageSubscription)||void 0===t||t.unsubscribe(),this.printCanvas&&this.onAfterPrint(),this===(0,Ih.uQ)()&&(0,Ih.e$)(null),this===(0,Ih.N9)()&&(0,Ih.KO)(null),document.removeEventListener("visibilitychange",this.browserTabVisibilityHandler),(0,Q.clearObject)(this),this.viewerDestroyed=!0}setBaseHighlightsEnabled(e){this.renderContext.setBaseHighlightsEnabled(e)}visualizeInferenceSceneGraph(e){this.mainDrawPass&&(this.mainDrawPass.visualizeInferenceSceneGraph(e),this.requestDraw())}getCanvasCoordinateFromEvent(e){if(!e)return[0,0];const t=this.el.getBoundingClientRect(),i=(0,Es.x_)();return[(e.pageX-t.left)*i,(e.pageY-t.top)*i]}getPageCoordinateFromCanvasXY(e,t){const i=(0,Es.x_)(),s=this.el.getBoundingClientRect();return[e/i+s.left,t/i+s.top]}zoomFit(e){var t;this.resetZoomToSelectionBounds(),null===(t=this.getPrimaryViewController())||void 0===t||t.zoomFit(this.getFitBounds(),e)}rotateInDirection(e){this.rotateInDirectionWithAngle(e,q.default.getManager().getNumber("ROTATE_ANGLE")*Math.PI/180)}rotateIncrementallyInDirection(e){this.rotateInDirectionWithAngle(e,q.default.getManager().getNumber("INCREMENTAL_ROTATE_ANGLE")*Math.PI/180)}rotateInDirectionWithAngle(e,t){var i;this.resetZoomToSelectionBounds(),null===(i=this.getPrimaryViewController())||void 0===i||i.rotateInDirection(e,t)}animateToStandardView(e){var t;this.resetZoomToSelectionBounds(),null===(t=this.getPrimaryViewController())||void 0===t||t.animateToStandardView(e,this.getFitBounds(rr[e]))}animateToStandardViewIgnoringUIPanels(e,t){var i;this.resetZoomToSelectionBounds(),null===(i=this.getPrimaryViewController())||void 0===i||i.animateToStandardViewIgnoringUIPanels(e,this.getFitBounds(rr[e]),t)}animateZoomFit(e){var t;e?this.zoomToSelectionBounds=e:this.resetZoomToSelectionBounds(),null===(t=this.getPrimaryViewController())||void 0===t||t.animateZoomToFit(e||this.getFitBounds())}resetZoomToSelectionBounds(){this.zoomToSelectionBounds=null}animateZoomToRectangle(e,t,i,s){const n=this.getCamera();if(!n)return;const r=[e,t,0],a=n.canvasToWorld(r),o=[e+i,t+s,0],h=n.canvasToWorld(o),c=new Li.kB;c.addPoint(a),c.addPoint(h),this.animateZoomFit(c)}animateTo(e){this.resetZoomToSelectionBounds(),this.animateToWithBounds(e,this.getFitBounds(e))}animateToWithBounds(e,t){var i;null===(i=this.getPrimaryViewController())||void 0===i||i.animateToFrameWithZoomFit(e,t,oT.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"))}animateRotation(e,t,i){var s;null===(s=this.getPrimaryViewController())||void 0===s||s.animateRotation(e,t,oT.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"),i)}setWaitingForDisplayData(){this.elementLoadState=cT.WAITING_FOR_DISPLAY_DATA,this.waitingForDisplayDataTimer=new mh.B7("Waiting for display data",ET())}setWaitingForCompareDisplayData(){this.elementLoadState=cT.WAITING_FOR_COMPARE_DISPLAY_DATA}stopWaitingForCompareDisplayData(){if(this.elementLoadState===cT.WAITING_FOR_COMPARE_DISPLAY_DATA){const e=!1;this.setGraphicsLoading(e,0)}this.elementLoadState===cT.WAITING_FOR_DISPLAY_DATA&&(this.shouldWaitForCompareDisplayData=!1)}setGraphicsLoading(e,t){var i;null===(i=this.waitingForDisplayDataTimer)||void 0===i||i.report(),this.waitingForDisplayDataTimer=null,this.loadingDisplayDataTimer=new mh.B7("Loading display data on client",ET()),this.elementLoadState=cT.LOADING_DISPLAY_DATA,this.getEventDispatcher().trigger(VM.Wp,this.activeElementId,e,t),this.shouldWaitForCompareDisplayData=!0,this.requestDrawForInteractiveProcessing()}onNewPartStudioDisplayData(e,t){if(this.getIsPrimaryViewer()&&e.isReadyForMetricsReporting()&&(this.eventDispatcher.trigger(Ms.pFt,Ms.$_3,e.deserializeDurationInMillis,e.fromDisplayCache,e._serializedByteLength,e.elementId),e.resetTimes()),!this.canProcessDisplayData())return void this.queuedDisplayData.push({displayData:e,selectionMapper:t});const i=new mh.B7("Viewer.onNewPartStudioDisplayData",{setTraceId:!0}),s=this.activeElementId===e.elementId||this.activeElementId===e.forCachedElement,n=this.elementLoadState===cT.WAITING_FOR_DISPLAY_DATA,r=this.elementLoadState===cT.WAITING_FOR_COMPARE_DISPLAY_DATA;let a=!1;if(!s)return void It.log.info("Received display data for inactive element: "+e.elementId);if(Ys()){const t=e.usage===W.rvN.BASE,i=e.usage===W.rvN.COMPARE_TARGET;if(n&&t)this.shouldWaitForCompareDisplayData?this.setWaitingForCompareDisplayData():a=!0;else if(r&&i)a=!0;else if(n&&i)return}else n&&(a=!0);if(a){const t=e.microversionIdAndConfigurationInterval.hasFromMicroversion()&&e.microversionIdAndConfigurationInterval.isEmptyInterval();this.setGraphicsLoading(e.fromDisplayCache||t,e.fromDisplayCache||t?100:0)}const o=this.isForFlattenedDisplay&&this.viewInitialized&&!this.isHidden();let h=!1;if(o){const e=this.getModelBounds({doNotBoundTemporarySketchEntities:!0});h=!e.isInitialized()||this.getCamera().doBoundsFitInViewport(e)}if(this.queuedBaseData&&this.queuedBaseData.elementId===e.elementId&&(this.queuedBaseData.incremental||this.modelViewManagers.resetPreviewManager(),t=this.selectionMapperForQueuedBase,this.modelViewManagers.getManager().processPartStudioDisplayData(this.queuedBaseData,t),this.queuedBaseData=null,this.selectionMapperForQueuedBase=null),e.usage===W.rvN.PREVIEW_BEFORE)return this.queuedBaseData=e,void(this.selectionMapperForQueuedBase=t);let c=this.modelViewManagers.getManager();switch(e.usage){case W.rvN.PREVIEW_AFTER:case W.rvN.PREVIEW_FINAL:case W.rvN.COMPARE_TARGET:c=this.modelViewManagers.getPreviewManager(e)}const l=gi._3.activeFeatureControllerIsSketch(),u=e.usage===W.rvN.PREVIEW_FINAL&&!l;this.setSuppressModelSelection(u),this.setBaseHighlightsEnabled(!u),this.isForPreviousVersionDisplay&&this.setSuppressModelSelection(!0),this.mainDrawPass&&this.mainDrawPass.updateHideInteriorSelections(),this.getSupportsPreview()&&(ks().latestDisplayDataUsage=e.usage);const d=c.processPartStudioDisplayData(e,t);e.usage!==W.rvN.BASE?(this.bodyLoadTasks.completeTasks(),this.getIsForFlattenedDisplay()||d||this.bodyManager.initiateAutomaticRetrieval()):(this.bodyLoadTask.performInitialLoad(),this.bodyLoadTask.hasPendingWork()||this.getIsForFlattenedDisplay()||d||this.bodyManager.initiateAutomaticRetrieval()),this.setUserIsManipulatingWithTimeout(),e.usage===W.rvN.BASE&&(this.performBodyCheck=!0),this.requestDrawForInteractiveProcessing(),this.detailManager.updateFromLoadedScene(),o&&h&&this.getModelBounds().isInitialized()&&this.animateZoomFit(),i.report()}onNewInsertableDisplayData(e){this.getModelViewManagers().getManager().processReceivedInsertableDisplayData(e)}onRootAssemblyDisplayData(e,t,i){if(!this.getIsForFlattenedDisplay()&&e.isReadyForMetricsReporting()&&(this.eventDispatcher.trigger(Ms.pFt,Ms.uvd,e.deserializeDurationInMillis,e.fromDisplayCache,e._serializedByteLength,e.elementId),e.resetTimes()),!this.canProcessDisplayData())return void this.queuedDisplayData.push({displayData:e,selectionMapper:null});if(!(this.activeElementId===e.elementId||t&&this.activeElementId===t.elementId))return void It.log.info("Received display data for inactive element: "+e.elementId);if(this.elementLoadState===cT.WAITING_FOR_DISPLAY_DATA&&this.activeElementId===e.elementId&&!i){const t=e.fromDisplayCache?100:e.getPartstudioDisplayDataNoopPercent();this.setGraphicsLoading(e.fromDisplayCache,t)}const s=this.bodyLoadTask.hasPendingWork();this.modelViewManagers.getManager().processRootAssemblyDisplayData(e,t),!s&&this.bodyLoadTask.hasPendingWork()&&this.bodyLoadTask.performInitialLoad(),e.isCollapsible&&this.setUserIsManipulatingWithTimeout(),this.detailManager.updateFromLoadedScene()}updateGraphicsData(e){if(e.renderingMode!==this.getRenderingMode()&&this.setRenderingMode(e.renderingMode),e.smoothEdgeStyle!==this.getSmoothEdgesRenderStyle()&&this.setSmoothEdgesRenderStyle(e.smoothEdgeStyle),e.zebraStripeCount!==this.getZebraStripeCount()&&this.setZebraStripeCount(e.zebraStripeCount),e.zebraStripeRotation!==this.getZebraStripeRotation()&&this.setZebraStripeRotation(e.zebraStripeRotation),e.zebraStripeEdgesOn!==this.getZebraStripeEdgesOn()&&this.setZebraStripeEdgesOn(e.zebraStripeEdgesOn),e.isBoundaryEdgeHighlightOn){const e=this.setFilteredEntitiesHighlightController(this.createFilteredEntitiesHighlightController(Ms.i8U));null==e||e.enable()}else{const e=this.getFilteredEntitiesHighlightController();e&&(e.disable(),this.setFilteredEntitiesHighlightController(null))}}destroyPreviewGraphics(){Ym.L.resetPartListToBase(this.activeElementId),this.modelViewManagers.resetPreviewManager(),Ws(),this.mainDrawPass&&this.mainDrawPass.setHideSelectionInterior(!1),this.requestDraw()}setForceHideInteriorSelections(e){var t;null===(t=this.mainDrawPass)||void 0===t||t.setForceHideInteriorSelections(e)}updateLastMouseLocation(e){this.lastMouseLocation=this.getCanvasCoordinateFromEvent(e)}resetLastMouseLocation(){this.lastMouseLocation=[-1,-1]}raycast(e,t,i,s){let n=-1,r=null;const a=v.create(),o=this.getCamera().getRay(e,t);let h=ge.create();s&&(o.point=pe.w$.multiplyVec3(s,o.point,v.create()),o.direction=v.clone(pe.w$.multiplyVec3(s,v.fromValues(o.direction[0],o.direction[1],o.direction[2]),v.create())),h=pe.w$.inverse(s));const c=i.points,l=i.indices,u=function(e){return e*=3,v.fromValues(c[e],c[e+1],c[e+2])},d=bi.W.ZERO_LENGTH,g=this.getCamera(),p=$.fromValues(e,t),m=v.create(),f=v.create(),I=v.create(),E=v.create(),S=v.create();for(let e=0;e<l.length-2;e++){if(l[e+2]===l[e+1]||l[e+1]===l[e]||l[e]===l[e+2])continue;const t=[u(l[e]),u(l[e+1]),u(l[e+2])];pe.S4.subtract(t[1],t[0],f),pe.S4.subtract(t[2],t[0],I),pe.S4.cross(o.direction,I,E);const i=v.dot(E,f);if(Math.abs(i)<d)continue;const s=1/i;pe.S4.subtract(o.point,t[0],m);const c=v.dot(m,E)*s;if(c<0||c>1)continue;pe.S4.cross(m,f,S);const T=v.dot(o.direction,S)*s;if(T<0||c+T>1)continue;const M=v.dot(I,S)*s;if(!(M<d)&&(n<0||n>M)){n=M,r=null;for(let e=0;e<3;e++)if(pe.gv.dist(g.projectWorldPointToCanvas(pe.w$.multiplyVec3(h,t[e],v.create())),p)<12){r=t[e],pe.S4.cross(f,I,a);break}}}return new ve.O5(r,a)}doPick(e,t,i,s,n){const r=Xs()&&!this.modelViewManagers.getPreviewManager();if(this.performingBoxSelection()||r)return!1;(n=n||{}).mouseX=e,n.mouseY=t,n.camera=this.getCamera(),n.click&&(this.getEventDispatcher().trigger(VM.rw),this.getEventDispatcher().trigger(VM.AD));const a=(0,Js.Wj)(),o=this.pick(e,t,n);let h=!1;for(let e=0;e<o.length&&!h;++e){const t=o[e],r=t.getModelSelection();if(r&&!this.suppressModelSelection)h=(0,ve.rQ)(r,i,s,n),h&&this.uiSelectionManager.handleEmptyUiPick(i,n);else if(t.isUIPick()&&(t.uiSelection.isInteractionEnabled()&&n.click&&this.getEventDispatcher().trigger(VM.fu),h=this.uiSelectionManager.processUiPick(t,n),h&&!this.suppressModelSelection)){const e=t.getUISelection();e&&!e.getClearModelSelectionsOnPrehilite()||(0,ve.Zs)(i,!0,n)}}h||(this.suppressModelSelection||(0,ve.Zs)(i,!1,n),this.uiSelectionManager.handleEmptyUiPick(i,n)),h&&i&&this.setUserIsManipulatingWithTimeout();const c=(0,Js.Wj)()-a;return this.averagePickDuration<0?this.averagePickDuration=c:this.averagePickDuration=.8*this.averagePickDuration+.2*c,h}doPreHighlightPick(e){var t;this.doPick(this.lastMouseLocation[0],this.lastMouseLocation[1],!0,!0,{skipPreHighlight:e,shiftKey:null===(t=this.inputHandler)||void 0===t?void 0:t.getAltHeld()})}onDoubleClick(e,t,i){const s={};s.mouseX=e,s.mouseY=t,s.camera=this.getCamera(),s.doubleClick=!0,s.altKey=i.altKey;const n=this.pick(e,t,s);let r=!1;for(let e=0;e<n.length&&!r;++e){const t=n[e];t.isUIPick()&&(r=this.uiSelectionManager.processUiPick(t,s))}return r}getAveragePickDuration(){return Math.max(0,this.averagePickDuration)}setSuppressModelSelection(e){this.suppressModelSelection=e,this.suppressModelSelection&&this.stopBoxSelection()}getSuppressModelSelection(){return this.suppressModelSelection}getCameraPropertiesForElement(e){let t=null;const i={graphicsElementId:e=e||"",isValid:!1,projectionType:"",viewMatrix:ge.create(),projectionMatrix:ge.create(),verticalFieldOfView:0,viewportHeight:0,viewportWidth:0};if(this.elementToPerElementState&&this.elementToPerElementState.hasOwnProperty(e)){const s=this.elementToPerElementState[e];s&&(t=s.camera,t&&(i.isValid=!0,t.isOrthographic()?i.projectionType="orthographic":t.isPerspective()&&(i.projectionType="perspective"),i.viewMatrix=t.getViewMatrix(),i.projectionMatrix=t.getProjectionMatrix(),i.verticalFieldOfView=t.getFieldOfView(),i.viewportHeight=t.getViewportHeight(),i.viewportWidth=t.getViewportWidth()))}return i}closeSelectOtherView(){this.selectOtherView.close()}resetActiveElement(){this.modelViewManagers.getManager().resetDisplayedElement()}setActiveElement(e,t,i,s,n){var r,a,o;if(!this.selectOtherView){const e={viewer:this};this.selectOtherView=new YS.Q(e)}if(this.selectOtherView.setActiveElement(s,n),e===this.activeElementId)return;if(this.loadTimer=new mh.B7("Time from element switch to graphics display",ET()),Ys()||this.destroyPreviewGraphics(),Zs()&&!i&&_a(this,70,40),this.activeElementId&&this.elementToPerElementState&&this.viewInitialized){const e=this.getCamera();if(e){let t=this.elementToPerElementState[this.activeElementId];t||(t=this.elementToPerElementState[this.activeElementId]=new hT(this.activeElementId)),t.camera=e.clone(),t.renderingMode=this.renderingMode,t.smoothEdgeStyle=this.smoothEdgeStyle,t.activeFilteredEntitiesHighlightController=this.filteredEntitiesHighlightController,t.userEnabledAggressiveRefinement=this.bodyManager.getUserEnabledAggressiveRefinement(),t.activeFilteredEntitiesHighlightController&&t.activeFilteredEntitiesHighlightController.disable(),this.getIsPrimaryViewer()&&(t.sectionViewState=(0,QS.o_)(this.activeElementId))}}let h=!1;s&&(h=s.getIsPublicationItem()),this.modelViewManagers.getManager().onChangeActiveElement(e,t,h),this.draw(),this.activeElementId=e||"";const c=t===W.GNh.PARTSTUDIO||t===W.GNh.ASSEMBLY,l=this.elementToPerElementState[this.activeElementId];if(c&&l){const e=l.camera;if(e&&((null===(r=this.viewController)||void 0===r?void 0:r.isPerspective())!==e.isPerspective()&&((null===(a=this.viewController)||void 0===a?void 0:a.isPerspective())?this.viewController=new lr(this):this.viewController=new cr(this)),e.setViewportFromCanvasElement(this.$el),null===(o=this.getCamera())||void 0===o||o.copyFrom(e)),this.setZebraStripeEdgesOn(l.zebraStripeEdgesOn),this.setRenderingMode(l.renderingMode),t!==W.GNh.PARTSTUDIO&&t!==W.GNh.ASSEMBLY||this.setSmoothEdgesRenderStyle(l.smoothEdgeStyle),ps.Jq.CapabilitiesService.checkViewCubeMenuUserPreferenceCurrentlyEnabled()&&t===W.GNh.PARTSTUDIO&&l.activeFilteredEntitiesHighlightController){const e=this.setFilteredEntitiesHighlightController(l.activeFilteredEntitiesHighlightController);null==e||e.enable()}else this.disableCurrentLaminarHighlightController();this.getIsPrimaryViewer()&&(0,QS.Wh)(l.sectionViewState,this.activeElementId),this.bodyManager.setUserEnabledAggressiveRefinement(l.userEnabledAggressiveRefinement),"number"==typeof l.zebraStripeCount&&this.setZebraStripeCount(l.zebraStripeCount),"number"==typeof l.zebraStripeRotation&&this.setZebraStripeRotation(l.zebraStripeRotation),this.viewInitialized=!0}else this.viewController&&this.resetViewState();this.setWaitingForDisplayData(),this.readyToUpdateElementLoadState=!1,this.receivedFeatureData=!1,this.receivedAssemblyDefinition=!1,this.averagePickDuration=-1,this.frameTimer.resetTimings(),this.detailManager.onSettingStateChange(),this.uiSelectionManager.reset(),this.bodyManager.resetOccurrenceRetrieval(),II(),this.resetLastMouseLocation(),this.setReadyState(!1);let u=ms.UNSUPPORTED;t===W.GNh.PARTSTUDIO?u=ms.PART_STUDIO:t===W.GNh.ASSEMBLY?u=ms.ASSEMBLY:this.hideWebGLContextLostMessage(),(0,VM.xA)().trigger(VM.Fc,u)}resetViewState(){var e,t,i,s;this.initializedForDrawing&&(this.viewInitialized=!1,(null===(e=this.viewController)||void 0===e?void 0:e.isPerspective())&&(this.viewController=this.viewController.getMatchingOrthographicController()),null===(t=this.viewController)||void 0===t||t.setStandardView(this.getDefaultStandardView()),ps.Jq.CapabilitiesService.checkAngularViewcubeMenuCurrentlyEnabled()?ps.Jq.UserSettingsService.getUserSettings().then((e=>{if(this.viewerPreferences.renderingMode=Number(e.graphicsRenderMode),this.viewerPreferences.smoothEdge=Number(e.graphicsSmoothEdge),this.viewerPreferences.highlightLaminarEdges="true"===e.highlightLaminarEdges,this.viewerPreferences.perspectiveModeOn="true"===e.perspectiveModeOn,this.viewerPreferences.isolateHideTransparent="true"===e.isolateHideTransparent,this.setSmoothEdgesRenderStyle(Number(e.graphicsSmoothEdge)),this.setRenderingMode(Number(e.graphicsRenderMode)),ps.Jq.CapabilitiesService.checkViewCubeMenuUserPreferenceCurrentlyEnabled()){if("true"===e.highlightLaminarEdges){const e=this.setFilteredEntitiesHighlightController(new $C(this,Ms.i8U));null==e||e.enable()}else this.setFilteredEntitiesHighlightController(null);if("true"===e.perspectiveModeOn){const e=this.getCamera();null==e||e.setSceneBounds(this.getSceneBounds());const t=this.getPrimaryViewController();this.setPrimaryViewController(t.getMatchingPerspectiveController())}}else this.setFilteredEntitiesHighlightController(null)})):(this.setRenderingMode(W.P1.SHADED_WITH_EDGES),this.setSmoothEdgesRenderStyle(W.YUG.VISIBLE)),this.filteredEntitiesHighlightController&&this.filteredEntitiesHighlightController.disable(),this.bodyManager.setUserEnabledAggressiveRefinement(!1),this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle=!1,null===(i=this.mainDrawPass)||void 0===i||i.setZebraStripeCount(oT.getNumber("ZEBRA_STRIPE_COUNT")),null===(s=this.mainDrawPass)||void 0===s||s.setZebraStripeRotation(oT.getNumber("ZEBRA_STRIPE_ROTATION")))}getViewerPreferences(){return this.viewerPreferences}resetViewerPreferences(){var e;this.viewerPreferences.renderingMode=this.getRenderingMode(),this.viewerPreferences.smoothEdge=this.getSmoothEdgesRenderStyle(),this.viewerPreferences.perspectiveModeOn=!!(null===(e=this.viewController)||void 0===e?void 0:e.isPerspective()),this.viewerPreferences.highlightLaminarEdges=!!this.getFilteredEntitiesHighlightController()}updateCanvasVisibility(){this.readyState&&!this.hidden?(this.$el.show(),this.viewManipulator&&this.viewManipulator.show()):(this.$el.hide(),this.viewManipulator&&this.viewManipulator.hide())}setReadyState(e){this.readyState=e,e?this.storedCameraState&&(this.updateCamera(this.storedCameraState),this.storedCameraState=null):this===(0,Ih.N9)()&&(0,Ih.KO)(null),this.updateCanvasVisibility()}isHidden(){return this.hidden}hide(){this.hidden=!0,this.updateCanvasVisibility()}show(){this.hidden=!1,this.gl||this.setupGlContext(),this.updateCanvasVisibility(),this.modelViewManagers.getManager().onViewerShown()}setSelectionCountCursor(e){this.selectionCursor=e,0===this.cursorStack.length&&this.$el.css({cursor:e})}pushCursor(e){this.$el.css({cursor:e}),this.cursorStack.push(e)}peekCursor(){return this.cursorStack&&this.cursorStack.length>0?this.cursorStack[this.cursorStack.length-1]:null}popCursor(){0!==this.cursorStack.length?(this.cursorStack.pop(),this.cursorStack.length>0?this.$el.css({cursor:this.cursorStack[this.cursorStack.length-1]}):this.$el.css({cursor:this.selectionCursor})):It.log.warn("Tried to pop a cursor off an empty stack in the graphics viewer")}removeTopOccurrenceOfCursor(e,t){if(0===this.cursorStack.length&&!t)return void It.log.warn("Tried to remove a cursor from an empty stack in the graphics viewer");const i=(0,pi.findLastIndex)(this.cursorStack,(function(t){return t===e}));i<0?t||It.log.warn("Tried to remove a cursor not present on stack in graphics viewer"):i===this.cursorStack.length-1?this.popCursor():this.cursorStack.splice(i,1)}onBeforePrint(){var e;const t=null===(e=this.getCamera())||void 0===e?void 0:e.getViewport();if(!t)return;this.printCanvas||(this.printToCanvas(t[2],t[3],t[2],t[3]),tT(this.printCanvas).css({width:"100%"}));const i=tT("body");i.addClass("printing"),i.append(this.printCanvas)}onAfterPrint(){tT(this.printCanvas).remove(),this.printCanvas=null,tT("body").removeClass("printing")}printToCanvas(e,t,i,s,n){if(!this.isReadyForDrawing())return;this.viewManipulator&&this.viewManipulator.hide();const r=this.getCamera();if(!r)return;const a=r.clone();let o=null;n&&(o={previousOverride:(0,Es.AO)()},(0,Es.Lt)(n));const h=r.getViewportWidth(),c=r.getViewportHeight(),l=e/i,u=i*l,d=s*l,g=h*l,p=c*l,m=(h-i)/2*l,f=(c-s)/2*l;null==a||a.setViewport([0,0,g,p]);const I=u,E=d,S=1024,T=1024,M=1042,C=1042,D=this.el.width,v=this.el.height;this.el.width=Math.max(M,D),this.el.height=Math.max(C,v),null==a||a.setCanvasDimensions(this.el.width,this.el.height);const P=Math.ceil(I/S),y=Math.ceil(E/T);this.printCanvas=document.createElement("canvas"),this.printCanvas.id="print-canvas",this.printCanvas.width=I,this.printCanvas.height=E;const A=this.printCanvas.getContext("2d"),O=new Uint8Array(4343056),R=A.createImageData(S,T),w=this.getGlContext(),_=[0,0,M,C];this.frameTimer.resetInteractionStatus();for(let e=0;e<y;++e)for(let t=0;t<P;++t){_[0]=m+t*S-9,_[1]=f+e*T-9,null==a||a.setTileViewport(_);const i=null;this.draw(i,{forPrint:!0,camera:a}),w.readPixels(0,0,M,C,w.RGBA,w.UNSIGNED_BYTE,O);for(let e=0;e<T;++e)for(let t=0;t<S;++t){const i=4*((T-e-1)*S+t),s=4*((e+9)*M+t+9),n=1/(O[s+3]/255);R.data[i]=O[s]*n,R.data[i+1]=O[s+1]*n,R.data[i+2]=O[s+2]*n,R.data[i+3]=O[s+3]}null==A||A.putImageData(R,t*S,e*T)}this.el.width=D,this.el.height=v,this.viewManipulator&&this.viewManipulator.show(),o&&(o.previousOverride?(0,Es.Lt)(o.previousOverride):(0,Es.eu)()),this.draw()}createPrintView(e,t,i,s,n,r,a){var o;const h=11800;if(!this.mainDrawPass)return;const c=this.mainDrawPass.getClearColor();this.mainDrawPass.setClearColor(0,0,0,0);let l=null;if(a){l=a*h/oT.getNumber("DEFAULT_LINE_WIDTH")}this.printToCanvas(e*h,t*h,s,n,l),tT(this.printCanvas).css({width:100*e+"cm",height:100*t+"cm"}),r?null===(o=this.printCanvas)||void 0===o||o.toBlob((e=>{(0,cf.G)(e,i+".png"),this.onAfterPrint()})):window.print(),this.mainDrawPass.setClearColor(c[0],c[1],c[2],c[3])}getEntityCanvasLocation(e){var t;const i=this.modelViewManagers.getManager().extractMeshIncrement(e);if(i&&i.points&&i.points.length>=3){const e=[i.points[0],i.points[1],i.points[2]];return null===(t=this.getCamera())||void 0===t?void 0:t.projectWorldPointToCanvas(e)}return null}triggerContextLoss(e){const t=this.getExtension("WEBGL_lose_context");t?(t.loseContext(),setTimeout((function(){t.restoreContext()}),e||500)):alert("This system does not support the context loss extension")}toggleDebugDrawPickPass(){var e;const t=null===(e=this.mainDrawPass)||void 0===e?void 0:e.getDebugDrawPickPass();null==t||t.setEnabled(!(null==t?void 0:t.getEnabled()))}isMouseInsideViewManipulator(){return!!this.viewManipulator&&this.viewManipulator.isMouseInside()}setCanEdit(e){this.canEdit=e}getCanEdit(){return this.canEdit}completeTasks(){this.taskManager.complete(),this.draw()}getSelectionFitBounds(e){if(!e)return null;const t=this.getModelViewManagers().getManagerForUsage(e.getUsage());if(!t)return null;const i=t.getSelectionFitBounds(e);if(this.getIsForFlattenedDisplay()&&i){const s=t.getDisplayedElement();if(s instanceof qd){const t=s.getBodyTransform(e.getBodyId(),this);if(t)return i.createTransformedCopy(t)}}return i}retrieveViewportAsImage(e){var t,i,s;const n=e.width,r=e.height,a=this.getCamera();if(!a)return null;const o=a.clone();a.setViewport([0,0,n,r]),a.setCanvasDimensions(n,r);let h=this.getFitBounds();e.zoomToSelection&&(h=new Li.kB,(0,ve.vi)().each((e=>{h.addBox(this.getSelectionFitBounds(e))})),h.isFinite()&&h.isExtensive()||It.log.warn("zoomToSelection was requested in retrieveZoomedFitViewport but a valid bounds was not found")),(0,QS.jf)(!0),void 0===e.zoomToFit&&(e.zoomToFit=!0),e.zoomToFit&&this.getPrimaryViewController().zoomFitWithoutPanels(h),!e.showViewCube&&this.viewManipulator&&this.viewManipulator.hide(),e.useInteractiveSettings?this.frameTimer.setUserIsAdjustingCamera():this.frameTimer.resetInteractionStatus(),null===(t=this.mainDrawPass)||void 0===t||t.setClearColor(1,1,1,1),this.draw();const c=new Uint8Array(n*r*4),l=this.getGlContext();return l&&l.readPixels(0,0,n,r,l.RGBA,l.UNSIGNED_BYTE,c),(0,Js.Dy)(c,n,r),null===(i=this.getCamera())||void 0===i||i.copyFrom(o),null===(s=this.mainDrawPass)||void 0===s||s.setClearColor(0,0,0,0),!e.showViewCube&&this.viewManipulator&&this.viewManipulator.show(),(0,QS.jf)(!1),{width:n,height:r,data:c}}retrievePrintedCanvasPixels(e){var t;const i=this.createPrintOfCanvas(e.width,e.height,sT,nT,!0),s=null===(t=this.printCanvas)||void 0===t?void 0:t.getContext("2d"),n=null==s?void 0:s.getImageData(0,0,sT,nT);return this.removePrintOfCanvas(i),{width:sT,height:nT,data:n.data}}printToCanvasRenderingContext(e,t,i,s,n){const r=(0,Es.x_)(),a=r*i,o=r*s;this.getEventDispatcher().trigger(VM.m2);const h=this.createPrintOfCanvas(a,o,a,o);this.getEventDispatcher().trigger(VM.nh),n.drawImage(this.printCanvas,e,t,i,s),this.removePrintOfCanvas(h)}createPrintOfCanvas(e,t,i,s,n){var r;const a=this.getCamera();if(!a)return null;const o=a.clone();return a.setViewport([0,0,e,t]),n&&(null===(r=this.getPrimaryViewController())||void 0===r||r.zoomFitWithoutPanels(this.getFitBounds())),this.printToCanvas(i,s,e,t),o}removePrintOfCanvas(e){var t,i;null===(t=tT(this.printCanvas))||void 0===t||t.remove(),null===(i=this.getCamera())||void 0===i||i.copyFrom(e)}getViewData(e,t){const i=new W.Lf5,s=this.getCamera();let n=s.getFrame();if(e){const t=this.modelViewManagers.getManager().getOccurrenceTransform(e);if(t){const e=pe.w$.inverse(t,ge.create());n=pe.w$.multiply(e,n,ge.create())}}i.viewMatrix=n,i.isPerspective=s.isPerspective();const r=s;r.top&&r.bottom&&r.right&&r.left?i.cameraViewport=[r.top,r.bottom,r.right,r.left]:i.cameraViewport=[0,0,0,0];const a=s;a.angle?i.angle=a.angle:i.angle=0;const o=function(e){const t=new W.d0F;return t.x=e[0],t.y=e[1],t.z=e[2],t},h=[];return(0,QS.nL)().forEach((function(e){const t=new W.cB6;t.center=o(e.center),t.tangent=o(e.tangent),t.normal=o(e.normal),h.push(t)})),i.sectionPlaneParameters=h,t||(i.sectionViewData=(0,QS.p$)()),i}getViewDataWithPersistentSectionedItemQueries(e){return(0,QS.bm)().then((e=>{const t=this.getViewData(null,!0);return t.sectionViewData=e,t}))}animateToView(e,t){const i=this.getCameraForViewData(e,t);this.prepareViewControllerForNewCamera(e.isPerspective);const s=q.default.getManager(),n=this.getPrimaryViewController();null==n||n.animateToCustomView(i,s.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"),e.name)}prepareViewControllerForNewCamera(e){const t=this.getPrimaryViewController();e?(null==t?void 0:t.isOrthographic())&&this.setPrimaryViewController(t.getMatchingPerspectiveController()):(null==t?void 0:t.isPerspective())&&this.setPrimaryViewController(t.getMatchingOrthographicController())}getCameraForViewData(e,t){const i=this.getCamera();i.setSceneBounds(this.getSceneBounds());let s=e.viewMatrix;const n=e.cameraViewport,r=e.angle;if(t){const e=W._oC.getOccurrenceFromPathString(t),i=this.modelViewManagers.getManager().getOccurrenceTransform(e);i&&(s=pe.w$.multiply(i,s,ge.create()))}let a;return e.isPerspective?(a=i.getPerspectiveCamera(),a.angle=r):(a=i.getOrthographicCamera(),a.top=n[0],a.bottom=n[1],a.right=n[2],a.left=n[3],a.correctAspectRatio()),a.setFrame(s),a}animateIsolation(e,t){const i=q.default.getManager().getNumber("ISOLATE_CONTEXT_TRANSITION_TIME_MS"),s=(0,Js.Wj)();this.animationController.startAnimation((n=>{const r=(0,Js.Es)(s),a=Math.min((0,Li.CW)(0,1,r/i),1);let o=Ms.ZK6.ONGOING;return a>=1&&(o=Ms.ZK6.COMPLETE,t&&t()),je(e?a:1-a),o}))}onIsolateChanged(){for(const e in this.uiElements)this.uiElements[e].onIsolateChanged()}setUserIsManipulatingWithTimeout(){this.frameTimer.setUserIsManipulatingWithTimeout()}setUserIsAdjustingCamera(){this.bodyManager.onUserIsAdjustingCamera(),this.frameTimer.setUserIsAdjustingCamera()}setSystemIsAnimating(){this.frameTimer.setSystemIsAnimating()}executePerformanceTests(){return this.elementLoadState=cT.LOADED_ALL_DATA,(0,_h.Xd)(_h.oA.OFF),this.initializeForDrawing(),this.onResize(),this.viewInitialized=!0,qf(this)}getInteractiveFrameDetails(){return this.frameTimer.getTimingDetails(Ms.QpP.INTERACTIVE)}getPingStats(){if(!this.isReadyForDrawing()||!this.isBrowserTabVisible||this.taskManager.hasPendingWork())return null;const e=this.getInteractiveFrameDetails(),t=this.getCamera();return e&&e.hasTimings()&&t?{framerate:e.getAverageFramerate(),triangleCount:this.modelViewManagers.getManager().getInstantiatedTriangleCount(),pixelCount:t.getViewportWidth()*t.getViewportHeight()}:null}areSectionPlanesEnabled(){return!this.isForFlattenedDisplay}onDisplayDataUsageChange(){this.detailManager.onSettingStateChange()}onDefaultUnitsChanged(e){for(const t in this.uiElements)this.uiElements[t].onDefaultUnitsChanged(e)}setDraftAnalysisPullDirection(e){var t;null===(t=this.mainDrawPass)||void 0===t||t.setDraftAnalysisPullDirection(e),this.requestDraw()}setDraftAnalysisMinimumAngle(e){var t;null===(t=this.mainDrawPass)||void 0===t||t.setDraftAnalysisMinimumAngle(e),this.requestDraw()}setDraftAnalysisParts(e){var t;null===(t=this.mainDrawPass)||void 0===t||t.setDraftAnalysisParts(e),this.requestDraw()}setDraftAnalysisShowUndercut(e){var t;null===(t=this.mainDrawPass)||void 0===t||t.setDraftAnalysisShowUndercut(e),this.requestDraw()}clearDraftAnalysis(){this.setDraftAnalysisPullDirection(null),this.setDraftAnalysisMinimumAngle(W.zG4.DEFAULT_MINIMUM_ANGLE_RADIANS),this.setDraftAnalysisParts([])}getRenderingModeOfElement(e){const t=this.elementToPerElementState[e];return t?t.renderingMode:null}updateElementPreviewNodeVisibility(e){const t=this.getModelViewManagers().getManager().getElementRootNode().getParent();if(t)for(let i=0;i<t.getChildCount();++i)t.getChildByIndex(i).setVisible(!e);const i=this.getModelViewManagers().getManager().getElementPreviewRootNode();i&&i.setVisible(e)}onElementPreviewDisplayData(e){It.log.trace("Invoking onElementPreviewDisplayData for element "+e.elementId),this.activeElementId===e.elementId&&this.elementLoadState!==cT.LOADED_ALL_DATA?(this.activeElementPreviewManager=new Al(this),this.activeElementPreviewManager.processGLDisplayDataResponse(e),this.hasElementPreviewLoaded=!0,this.setReadyState(!0),this.updateElementPreviewNodeVisibility(!0),this.requestDraw(),this.getEventDispatcher().trigger(VM.Vp,this.activeElementId),It.log.trace("Drawing Preview for element "+e.elementId)):It.log.trace("Skipping processing previewDisplayData because display data has been loaded "+e.elementId)}clearElementPreview(){this.updateElementPreviewNodeVisibility(!1),this.activeElementPreviewManager&&(It.log.trace("Removing elementPreviewManager for elementId "+this.activeElementId),this.activeElementPreviewManager.destroy(),this.activeElementPreviewManager=null,this.requestDraw()),this.hasElementPreviewLoaded=!1}getCameraData(e){var t;const i={camera:null,cameraExtents:null};let s=pe.w$.inverse(e,ge.create());return s||(s=ge.create()),i.camera=this.getCamera().clone(),i.camera.setFrame(pe.w$.multiply(s,i.camera.getFrame())),(null===(t=this.getCamera())||void 0===t?void 0:t.isOrthographic())&&(i.cameraExtents=this.getCamera().getExtents()),i}updateCamera(e){const t=e.camera;t&&e.honorPerspective&&this.prepareViewControllerForNewCamera(t.isPerspective());const i=this.getCamera();i.isOrthographic()&&e.cameraExtents&&i.setExtents(e.cameraExtents),t&&(e.honorPerspective?i.copyFrom(t):i.copyFrom(t.getOrthographicCamera())),i.setViewportFromCanvasElement(this.$el),this.setViewInitialized(!0)}storeCameraState(e){this.storedCameraState=e}setInterferenceCallId(e){this.interferenceCallId=e}getInterferenceCallId(){return this.interferenceCallId}createDistanceDisplay(e,t){return new yC(e,t,this)}createAngleDisplay(e,t,i,s,n,r){return new AC(e,t,i,s,n,r,this)}getDimensionComponent(){const e=this.getModelViewManagers().getManager().getDisplayedPartStudio();return e?e.getDimensionComponent():null}createCombDisplay(e,t,i,s,n){return new OC(e,t,i,s,n,this)}createAngularDimension(e,t){return new hE.$R(this,e,t)}createCurveLengthDimension(e,t){return new hE.U8(this,e,t)}createLinearDimension(e,t){return new hE.mI(this,e,t)}createEllipseDiameterDimension(e,t){return new hE.Xk(this,e,t)}createRadialDimension(e,t){return new hE.nl(this,e,t)}createArcLengthDimension(e,t){return new hE.uU(this,e,t)}createCenterlineDimension(e,t){return new hE.SM(this,e,t)}createCountDimension(e,t){return new hE.JO(this,e,t)}createBezierDegreeDimension(e,t){return new hE.z$(this,e,t)}createAngularWithArrowManipulator(){return new Hr(this)}createLinearManipulator(e){return new br(this,e)}createPlanarManipulator(e){return new Br(this,e)}createTriadManipulator(e,t){return new Yr._(this,e,t)}createFeatureManipulator(e,t){return(0,wl.wA)(e,this,t)}createLinearToolPreview(e,t,i,s,n){return ln(e,t,i,s,this,n)}createAngularToolPreview(e,t,i,s,n){return hn(e,t,i,s,n,this)}createAxes(e){return new gs(this,e)}createEmptyBoundingBox(){return new Li.kB}createOrthographicCamera(){return new Ph}createPerspectiveCamera(){return new vh}createCommentIndicator(e,t){return new Fd(e,t,this)}createCenterOfMassIndicator(e){return new xd(e,this)}createFeatureDisplay(e){return new MI(e,this)}createControlPointGridDisplay(e,t,i){return new nm(e,t,i,this)}createEdgeCurvatureDisplay(e,t,i,s,n,r){return new vm(e,t,i,s,n,this,r)}createDihedralDisplay(e,t,i,s){return new Bm(e,t,i,s,0,0,!1,this)}createDihedralExtremaDisplay(e,t,i,s,n){return new Vm(e,t,i,s,n,this)}createFixedMateIndicator(e,t){return new ip(e,t,this)}createImageDisplay(e,t,i,s,n,r,a,o,h,c){return new Jn(e,t,i,s,n,r,a,this,o,h,c)}createInferenceDisplay(e,t){return new dg(e,this,t)}createInferencePicker(e,t,i){return new rM(this,e,t,i)}createInterferenceDisplay(e,t,i,s,n,r,a){return new hM(e,this,t,i,s,n,r,a)}createFilteredEntitiesHighlightController(e){return new $C(this,e)}createMateConnectorManager(){return this.activeMateConnectorManager=new Dn,this.activeMateConnectorManager}destroyMateConnectorManager(){this.activeMateConnectorManager&&(this.activeMateConnectorManager.destroy(),this.activeMateConnectorManager=null)}getMateConnectorManager(){return this.activeMateConnectorManager}setMateConnectorInteractionEnabled(e){Dl.setInteractionEnabled(e)}createMeshIncrement(e,t,i,s,n){return new jE(e,t,i,s,n)}createSnapIndicator(){return new fg(this)}createPointElement(e,t,i,s,n){return new au(e,t,i,s,this,n)}createSilhouette(e){return new yI(e,this)}canUserEnableAggressiveRefinement(){return!mT.has(this.renderingMode)}getUserEnabledAggressiveRefinement(){return this.bodyManager.getUserEnabledAggressiveRefinement()}setUserEnabledAggressiveRefinement(e){return this.getUserEnabledAggressiveRefinement()||!e||this.canUserEnableAggressiveRefinement()?(this.bodyManager.setUserEnabledAggressiveRefinement(e),!0):(ps.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Viewing in high quality is disabled for this view mode."),"warning"),!1)}getOrCreateActiveElementViewerState(){let e=this.elementToPerElementState[this.activeElementId];return void 0===e&&(e=this.elementToPerElementState[this.activeElementId]=new hT(this.activeElementId)),e}getActiveElementViewerState(){return this.elementToPerElementState[this.activeElementId]}setZebraStripeCount(e){var t;this.getOrCreateActiveElementViewerState().zebraStripeCount=e,null===(t=this.mainDrawPass)||void 0===t||t.setZebraStripeCount(e),this.getIsPrimaryViewer()&&(this.followGraphicsData.zebraStripeCount=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}setZebraStripeRotation(e){var t;this.getOrCreateActiveElementViewerState().zebraStripeRotation=e,null===(t=this.mainDrawPass)||void 0===t||t.setZebraStripeRotation(e),this.getIsPrimaryViewer()&&(this.followGraphicsData.zebraStripeRotation=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}getZebraStripeCount(){var e,t;return null!==(t=null===(e=this.getActiveElementViewerState())||void 0===e?void 0:e.zebraStripeCount)&&void 0!==t?t:oT.getNumber("ZEBRA_STRIPE_COUNT")}getZebraStripeRotation(){var e,t;return null!==(t=null===(e=this.getActiveElementViewerState())||void 0===e?void 0:e.zebraStripeRotation)&&void 0!==t?t:oT.getNumber("ZEBRA_STRIPE_ROTATION")}getZebraStripeEdgesOn(){var e,t;return null===(t=null===(e=this.getActiveElementViewerState())||void 0===e?void 0:e.zebraStripeEdgesOn)||void 0===t||t}setZebraStripeEdgesOn(e){this.getOrCreateActiveElementViewerState().zebraStripeEdgesOn=e,this.renderingMode===W.P1.CURVATURE_VISUALIZATION&&this.setRenderingMode(this.renderingMode),this.requestDraw(),this.getIsPrimaryViewer()&&(this.followGraphicsData.zebraStripeEdgesOn=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}getRenderModeObservable(){return this.renderModeSubject.asObservable()}logDisplayDataRefinementState(){It.log.info("Display data refinement state logged. Details:\n\n"+this.bodyManager.getDisplayDataRefinementState())}unloadSelectedBodies(){(0,ve.vi)().each((e=>{this.bodyManager.unloadSelectionBody(e)}))}isIsolateEffectInUseForVisualization(){const e=this.modelViewManagers.getManager().getSimulationManager();return!!e&&e.isIsolateEffectActive()}getAreOptimizedBuffersEnabled(){return this.areOptimizedBuffersEnabled}onBrowserTabVisibilityChanged(){switch(document.visibilityState){case"hidden":this.isBrowserTabVisible=!1;break;case"visible":this.isBrowserTabVisible=!0,this.frameTimer.resetTimings()}}getCurvatureAnalysisManager(){return this.curvatureAnalysisManager}getThicknessAnalysisManager(){var e,t;return null!==(t=null===(e=this.modelViewManagers.getManager())||void 0===e?void 0:e.getThicknessAnalysisManager())&&void 0!==t?t:null}getXrController(){return this.xrController}get isOngoingRenderLoopRunning(){var e;return null===(e=this.xrController)||void 0===e?void 0:e.getIsXrRunning()}getXrInputCamera(e){const t=new Ph;t.setFrame(ge.multiply(ge.create(),this.xrController.modelTransformInverse,e.worldSpacePose)),t.setViewportFromCanvasElement(this.$el);const i=1e-4,s=t.getViewportWidth()*i*.5,n=t.getViewportHeight()*i*.5;t.setExtentsByComponent(-s,s,-n,n),t.sceneBounds=this.getSceneBounds();const r=nD,a=Math.max(t.near+.001,v.dot(t.getForward(),v.subtract(v.create(),t.sceneBounds.center(),t.getEye()))+t.sceneBounds.diameter()/2);return t.setNearFar(r,a),t}pickWithXrInput(e){if(e.picks)return e.picks;const t=this.getXrInputCamera(e),i=t.getViewportWidth()/2,s=t.getViewportHeight()/2;return e.picks=this.pickIteratively(i,s,this.getDefaultPickTerminationEvaluator(),{cameraOverride:t}),e.picks}getDepthForXrInput(e){const t=this.getXrInputCamera(e),i=t.getViewportWidth()/2,s=t.getViewportHeight()/2,n=this.findDepthsInRect(i-2,s-2,5,5,!1,t);if(0===n.length)return-1;let r=0;const a=e.modelSpaceRay;for(const e of n)r+=a.findPositionOfPoint(t.canvasToWorld(e));return r/n.length}getIsSynchingView(){return this.isSynchingView}setIsSynchingView(e){this.isSynchingView=e,this.pairedViewer&&(this.pairedViewer.isSynchingView=e)}setShouldUpdatePairedViewer(e){this.shouldUpdatePairedViewer=e}syncPairedView(){if(!this.pairedViewer.getCamera())return;const e=this.getCameraData(ge.identity(ge.create()));e.honorPerspective=!0,this.pairedViewer.updateCamera(e),this.pairedViewer.setShouldUpdatePairedViewer(!1),this.pairedViewer.requestDraw()}onAppearanceConstantsUpdated(){var e;this.resources.onAppearanceConstantsUpdated();for(const e of Object.values(this.uiElements))e.onAppearanceConstantsUpdated();const t=this.getReferenceHighlights();Object.values(t.highlights).forEach((e=>{t.updateHighlightColor(e.type)})),this.getModelViewManagers().onAppearanceConstantsUpdated(),null===(e=this.mainDrawPass)||void 0===e||e.onAppearanceConstantsUpdated(),this.requestDraw()}}function IT(e){return new fT({el:e,disableAutomaticDrawing:!0,disableInput:!0,disableViewManipulator:!0})}function ET(){if(localStorage.getItem("osDisplayDataTimersLoggingEnabled"))return{logResult:!0}}var ST=i(81298),TT=i(24589),MT=i(32659);const CT=i(51360),DT=q.default.getManager(),vT="viewManipulatorEvent";let PT=null;function yT(e){PT=e}var AT;function OT(e){return 0===e.indexOf("Trimetric")}!function(e){e.TOP="Top",e.BOTTOM="Bottom",e.FRONT="Front",e.BACK="Back",e.RIGHT="Right",e.LEFT="Left",e.TRIMETRIC_TOP_RIGHT_FRONT="Trimetric",e.TRIMETRIC_TOP_LEFT_FRONT="TrimetricTopLeftFront",e.TRIMETRIC_TOP_RIGHT_BACK="TrimetricTopRightBack",e.TRIMETRIC_TOP_LEFT_BACK="TrimetricTopLeftBack",e.TRIMETRIC_BOTTOM_RIGHT_FRONT="TrimetricBottomRightFront",e.TRIMETRIC_BOTTOM_LEFT_FRONT="TrimetricBottomLeftFront",e.TRIMETRIC_BOTTOM_RIGHT_BACK="TrimetricBottomRightBack",e.TRIMETRIC_BOTTOM_LEFT_BACK="TrimetricBottomLeftBack",e.LEFT_ARROW="LeftArrow",e.RIGHT_ARROW="RightArrow",e.UP_ARROW="UpArrow",e.DOWN_ARROW="DownArrow",e.CW_ARROW="CwArrow",e.CCW_ARROW="CcwArrow",e.VIEW_CONTROL_ICON="ViewCtrlIcon"}(AT||(AT={}));const RT=new Qi({primitiveType:_i.MX.TRIANGLES,material:Wi,zOffset:2}),wT=new Qi({isPickable:!1,primitiveType:_i.MX.LINES,isVisible:!1}),_T=new Qi({isPickable:!1,primitiveType:_i.MX.LINES}),NT=_T,bT=new Qi({isPickable:!1,isShowThrough:!0,isDepthTested:!1,isStencilTested:!0,primitiveType:_i.MX.LINES}),LT=new Qi({isPickable:!1,primitiveType:_i.MX.TRIANGLES,material:null}),FT=new Qi({isPickable:!1,isShowThrough:!0,isDepthTested:!1,primitiveType:_i.MX.TRIANGLES,material:null});let xT;const BT=.5,UT=.5*DT.getNumber("VIEW_CUBE_ARROW_WIDTH"),VT=.5*DT.getNumber("VIEW_CUBE_ARROW_HEIGHT"),GT=BT-VT;function HT(){return(BT-2*UT)/1.6-DT.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX")/xT/1.5}let kT;const WT="viewmanipulator",zT="viewmanipulatorbuttons",XT=".highlight";class qT extends Ri{constructor(e){super(e,sh.EG),this.staticIncrements=null,this.cubeCenter=[0,0,0],this.setId(zT),this.highlightedId=yi;for(const e of Object.values(AT))this.listenTo(this,Pi.CLICK+e,this.onMouseClick),this.listenTo(this,Pi.MOUSE_ENTER+e,this.onMouseEnter),this.listenTo(this,Pi.MOUSE_LEAVE+e,this.onMouseLeave),e===AT.VIEW_CONTROL_ICON&&this.listenTo(this.viewer.getEventDispatcher(),VM.oL,this.unselectViewControlIcon)}onDevicePixelRatioChanged(e){this.staticIncrements=null,this.updateGraphics()}setCubeCenter(e){this.cubeCenter=e}getStaticIncrements(){if(this.staticIncrements)return this.staticIncrements;const e=this;this.staticIncrements={};const t=function(t,i,s,n){pe.S4.scale(i,xT),pe.S4.scale(s,xT),pe.S4.scale(n,xT);const r=t+"Face",a=Au(i,s,n);e.staticIncrements[r]={selection:t,data:a,type:RT,color:DT.getColor("VIEW_CUBE_ARROW_COLOR")}};t(AT.LEFT_ARROW,[-.5,0,-.5],[-GT,-UT,-.5],[-GT,UT,-.5]),t(AT.RIGHT_ARROW,[BT,0,-.5],[GT,UT,-.5],[GT,-UT,-.5]),t(AT.UP_ARROW,[0,BT,-.5],[-UT,GT,-.5],[UT,GT,-.5]),t(AT.DOWN_ARROW,[0,-.5,-.5],[UT,-GT,-.5],[-UT,-GT,-.5]);const i=Math.sin(Math.PI/4),s=Math.cos(Math.PI/4),n=Math.sin(Math.PI/4-VT/BT),r=Math.cos(Math.PI/4-VT/BT);t(AT.CW_ARROW,[s*BT,i*BT,-.5],[s*(BT-2*UT),i*(BT-2*UT),-.5],[r*(BT-UT),n*(BT-UT),-.5]),t(AT.CCW_ARROW,[-s*(BT-2*UT),i*(BT-2*UT),-.5],[-s*BT,i*BT,-.5],[-r*(BT-UT),n*(BT-UT),-.5]);const a=function(t,i,s){const n=Math.ceil(36*Math.abs(s-i)/Math.PI),r=(BT-UT-DT.getNumber("VIEW_CUBE_ARROW_ARC_WIDTH")/2)*xT,a=(BT-UT+DT.getNumber("VIEW_CUBE_ARROW_ARC_WIDTH")/2)*xT,o=Tu([0,0,0],r,[0,0,1],n,[1,0,0],i,s),h=Tu([0,0,0],a,[0,0,1],n,[1,0,0],i,s),c=(h.length+o.length)/3,l=new Float32Array(3*c);for(let e=0;e<c/2;++e)l[6*e+0]=o[3*e+0],l[6*e+1]=o[3*e+1],l[6*e+2]=o[3*e+2],l[6*e+3]=h[3*e+0],l[6*e+4]=h[3*e+1],l[6*e+5]=h[3*e+2];const u=t+"ArcFace",d=new Float32Array(3*c);for(let e=0;e<c;++e)d[3*e+0]=0,d[3*e+1]=0,d[3*e+2]=1;const g=new Int32Array(6*(c/2-1));for(let e=0;e<c/2-1;++e)g[6*e+0]=2*e+0,g[6*e+1]=2*e+1,g[6*e+2]=2*e+2,g[6*e+3]=2*e+1,g[6*e+4]=2*e+3,g[6*e+5]=2*e+2;const p=new jE(_i.MX.TRIANGLES,l,g);p.normals=d,e.staticIncrements[u]={selection:t,data:p,type:RT,color:DT.getColor("VIEW_CUBE_ARROW_COLOR")}};return a(AT.CW_ARROW,.25*Math.PI,.4*Math.PI),a(AT.CCW_ARROW,.6*Math.PI,.75*Math.PI),e.staticIncrements}updateGraphics(){this.updateIncrementsOnEntity(AT.LEFT_ARROW,"Face"),this.updateIncrementsOnEntity(AT.RIGHT_ARROW,"Face"),this.updateIncrementsOnEntity(AT.UP_ARROW,"Face"),this.updateIncrementsOnEntity(AT.DOWN_ARROW,"Face"),this.updateIncrementsOnEntity(AT.CW_ARROW,"Face"),this.updateIncrementsOnEntity(AT.CCW_ARROW,"Face"),this.updateIncrementsOnEntity(AT.CW_ARROW,"ArcFace"),this.updateIncrementsOnEntity(AT.CCW_ARROW,"ArcFace")}updateIncrementsOnEntity(e,t){const i=this,s=this.getStaticIncrements();(s[e+t].type===RT||s[e+t].type===_T&&s[e+t].color)&&Uu(i.highlightedId===s[e+t].selection?DT.getColor("VIEW_CUBE_FACE_HIGHLIGHT"):s[e+t].color,s[e+t].data),this.updateMeshIncrement(e+t,s[e+t].selection,s[e+t].data.clone(),s[e+t].type)}updateTransform(){const e=ge.create();e[12]=this.cubeCenter[0],e[13]=this.cubeCenter[1],e[14]=this.cubeCenter[2],this.setTransform(e),this.hasMeshIncrements()||this.updateGraphics()}onMouseClick(e,t,i){this.trigger(vT,e.selectionId),ps.Jq.AnalyticsService.trackEventForDocumentId("VIEW_CUBE_COMMAND","click_"+e.selectionId,(0,ta.n)());let s="";AT.LEFT_ARROW===e.selectionId?s="left":AT.RIGHT_ARROW===e.selectionId?s="right":AT.UP_ARROW===e.selectionId?s="up":AT.DOWN_ARROW===e.selectionId?s="down":AT.CW_ARROW===e.selectionId?s="clockwise":AT.CCW_ARROW===e.selectionId&&(s="counterclockwise"),s&&(t.shiftKey?this.viewer.rotateIncrementallyInDirection(s):this.viewer.rotateInDirection(s),i.requestSelectedStatus=!1)}unselectViewControlIcon(){this.highlightedId===AT.VIEW_CONTROL_ICON&&(this.highlightedId=yi,this.updateGraphics()),this.viewer.requestDraw()}onMouseEnter(e,t){this.highlightedId=e.selectionId,this.updateGraphics(),this.viewer.requestDraw()}onMouseLeave(e,t){this.highlightedId===e.selectionId&&(this.highlightedId=yi,this.updateGraphics()),this.viewer.requestDraw()}isViewManipulator(){return!0}}const ZT="label",YT="label.showthrough",KT=(0,Li.Yr)(DT.getNumber("VIEW_CUBE_AXIS_LABEL_FADE_START_ANGLE")),jT=(0,Li.Yr)(DT.getNumber("VIEW_CUBE_AXIS_LABEL_FADE_END_ANGLE"));class QT extends Ri{constructor(e,t,i,s){super(s,sh.EG),this.label=e,this.direction=t,this.colorName=i,this.labelTexture=null,this.center=[0,0,0,0],this.cubeCenter=v.create(),this.lastSetOpacity=-1,this.nodeProperties=new Qi(LT),this.nodeProperties.material=Xi(),this.nodeProperties.updateId(),this.showThroughNodeProperties=new Qi(FT),this.showThroughNodeProperties.material=this.nodeProperties.material,this.showThroughNodeProperties.updateId(),this.ensureTexture()}onDevicePixelRatioChanged(e){this.refreshGraphics()}onAppearanceConstantsUpdated(){this.refreshGraphics()}refreshGraphics(){this.labelTexture&&(this.labelTexture.destroy(),this.labelTexture=null),this.viewer.getGlContext()&&(this.ensureTexture(),this.updateIncrements())}remove(){this.labelTexture&&this.labelTexture.destroy(),this.nodeProperties.material&&(this.nodeProperties.material.destroy(),this.nodeProperties.material=null),super.remove()}updateIncrements(){if(!this.labelTexture)return;const e=DT.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX"),t=this.labelTexture.filledWidthPx,i=Ou([-t/2,-e/2,0],[t/2,-e/2,0],[-t/2,e/2,0],void 0,[this.labelTexture.leftCoordinate,this.labelTexture.bottomCoordinate],[this.labelTexture.rightCoordinate,this.labelTexture.topCoordinate]);Uu([1,1,1,.5],i),this.updateMeshIncrement(ZT,yi,i,this.nodeProperties);const s=i.clone();Uu([1,1,1,DT.getNumber("VIEW_CUBE_HIDDEN_AXIS_OPACITY")],s),this.updateMeshIncrement(YT,yi,s,this.showThroughNodeProperties);const n=xT*kT,r=DT.getNumber("VIEW_CUBE_AXIS_GAP"),a=[-n-r,-n-r,-n-r],o=Math.sqrt(t*t+e*e)/2+3,h=pe.S4.add(pe.S4.scale(this.direction,2*n+o,v.create()),a);this.center=[h[0],h[1],h[2],0]}ensureTexture(){this.viewer.getGlContext()&&(this.labelTexture||(this.labelTexture=Go(this.viewer,this.label,{color:DT.getColor(this.colorName),font:DT.getString("VIEW_CUBE_TEXT_FONT"),size:DT.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX")}),this.nodeProperties.material.ambientTexture=this.labelTexture,this.showThroughNodeProperties.material.ambientTexture=this.labelTexture,this.updateIncrements()))}setCubeCenter(e){this.cubeCenter=e}setOpacity(e){if(e===this.lastSetOpacity)return;const t=new Uint8Array([255,255,255,255*e]);this.updateIncrementAttribute(ZT,Jd.COLOR,t),t[3]=255*Math.min(e,DT.getNumber("VIEW_CUBE_HIDDEN_AXIS_OPACITY")),this.updateIncrementAttribute(YT,Jd.COLOR,t),this.lastSetOpacity=e}updateTransform(e){const t=Math.acos(Math.abs(v.dot(e.getForward(),this.direction))),i=(0,Li.CW)(jT,KT,t);this.setOpacity(i);const s=pe.w$.multiplyVec4(e.getViewMatrix(),this.center,P.create()),n=pe.S4.add(s,this.cubeCenter);this.setTransform(pe.w$.translate(ge.create(),n))}}let $T=class extends qS.View{constructor(e,t){super(t),this.contextMenuMgr=e}initialize(e){this.viewer=e.viewer,this.parentManipulator=e.parentManipulator,this.mouseMoveFunction=e=>this.onMouseMove(e),this.mouseUpFunction=e=>this.onMouseUp(e),this.distanceDraggedPx=0,this.rightPostion=-1,this.topPosition=-1,this.$el.hide(),this.$el.html(CT()),this.$el.attr("data-bs-original-title",i18n("Camera and render options")),this.userLanguageChangeSubscription=ps.Jq.LocaleService.getUserLanguageChangeObservable().subscribe((()=>{this.$el.attr("data-bs-original-title",i18n("Camera and render options"))}));const t=DT.getNumber("VIEW_CUBE_SCREEN_SIZE_PX")/(0,Es.x_)();this.$el.find(".os-view-cube-bounds").css({width:t+"px",height:t+"px",right:0,bottom:"5px"})}remove(){return this.userLanguageChangeSubscription.unsubscribe(),super.remove()}appendToCanvasParent(){this.$el.appendTo(this.viewer.$el.parent()),this.delegateEvents()}position(e,t){this.rightPostion===e&&this.topPosition===t||(this.$el.css({right:e,top:t}),this.rightPostion=e,this.topPosition=t)}onClick(){this.distanceDraggedPx<=DT.getNumber("LEFT_MOUSE_DRAG_DISTANCE_TOLERANCE")&&ps.Jq.CapabilitiesService.isAngularViewcubeMenuEnabled().then((e=>{e?null==PT||PT.toggleViewCubeMenuVisibility(this.$el,this.viewer):this.$el.hasClass("os-dropdown-open")?this.contextMenuMgr.closeAllContextMenus():MT("#content-div .viewControlPopup").osContextMenu()})),this.distanceDraggedPx=0}getCanvasPositionFromEvent(e){const t=this.viewer.getCanvasCoordinateFromEvent(e);return{mouseX:t[0],mouseY:t[1]}}onMouseDown(e){this.viewer.isReadyForDrawing()&&(ps.Jq.FlyoutService.collapseAllFlyouts(),1===e.which&&(this.parentManipulator.setDragStart(this.getCanvasPositionFromEvent(e)),MT(document).on("mousemove",this.mouseMoveFunction),MT(document).on("mouseup",this.mouseUpFunction)))}onMouseMove(e){this.viewer.isReadyForDrawing()&&(this.distanceDraggedPx+=this.parentManipulator.updateDragPosition(this.getCanvasPositionFromEvent(e)))}onMouseUp(e){MT(document).off("mousemove",this.mouseMoveFunction),MT(document).off("mouseup",this.mouseUpFunction)}};$T=(0,ST.__decorate)([(0,TT.g)({className:"os-graphics-dropdown",events:{click:"onClick",mousedown:"onMouseDown"}}),(0,ST.__metadata)("design:paramtypes",[Object,Object])],$T);class JT extends Ri{constructor(e,t){super(e,sh.EG),this.contextMenuMgr=t,this.labelTextures={},this.labelProperties={},this.topRightCorner=v.create(),this.center=v.create(),this.staticIncrements=null,this.axisLabels={},this.dropdownButton=null,this.i18next=i18n,"function"!=typeof this.i18next&&(this.i18next=function(e){return e}),xT=DT.getNumber("VIEW_CUBE_SCREEN_SIZE_PX"),kT=HT(),this.setId(WT),this.highlightedId=yi,this.oldDevicePixelRatio=(0,Es.x_)(),this.manipulatorButtons=new qT(this.viewer),this.listenTo(this.viewer.getEventDispatcher(),VM.pO,this.ensureTextures);for(const e of Object.values(AT))this.listenTo(this,Pi.CLICK+e,this.onMouseClick),this.listenTo(this,Pi.MOUSE_ENTER+e,this.onMouseEnter),this.listenTo(this,Pi.MOUSE_LEAVE+e,this.onMouseLeave),this.listenTo(this,Pi.DRAG_START+e,this.onDragStart),this.listenTo(this,Pi.DRAG+e,this.onDrag),this.listenTo(this,Pi.DRAG_STOP+e,this.onDragStop),this.listenTo(this.manipulatorButtons,Pi.DRAG_START+e,this.onDragStart),this.listenTo(this.manipulatorButtons,Pi.DRAG+e,this.onDrag),this.listenTo(this.manipulatorButtons,Pi.DRAG_STOP+e,this.onDragStop);this.axisLabels.X=new QT("X",[1,0,0],"X_AXIS_COLOR",this.viewer),this.axisLabels.Y=new QT("Y",[0,1,0],"Y_AXIS_COLOR",this.viewer),this.axisLabels.Z=new QT("Z",[0,0,1],"Z_AXIS_COLOR",this.viewer),this.viewer.getIsPrimaryViewer()&&(this.dropdownButton=new $T(t,{viewer:this.viewer,parentManipulator:this})),this.ensureTextures(),this.userLanguageChangeSubscription=ps.Jq.LocaleService.getUserLanguageChangeObservable().subscribe((()=>{this.refreshGraphics()}))}onDevicePixelRatioChanged(e){const t=(0,Es.x_)();pe.S4.scale(this.topRightCorner,t/this.oldDevicePixelRatio),this.oldDevicePixelRatio=t,xT=DT.getNumber("VIEW_CUBE_SCREEN_SIZE_PX"),kT=HT(),this.refreshGraphics(),this.updateDropdownPosition()}onAppearanceConstantsUpdated(){this.refreshGraphics()}refreshGraphics(){this.staticIncrements=null,this.destroyTextures(),this.viewer.getGlContext()&&(this.ensureTextures(),this.updateGraphics())}destroyTextures(){Object.values(this.labelTextures).forEach((function(e){e.destroy()})),this.labelTextures={}}remove(){Object.values(this.labelProperties).forEach((function(e){e.material&&(e.material.destroy(),e.material=null)})),this.dropdownButton&&this.dropdownButton.remove(),this.userLanguageChangeSubscription.unsubscribe(),super.remove()}hide(){super.hide(),this.manipulatorButtons.hide(),Object.values(this.axisLabels).forEach((function(e){e.hide()})),this.dropdownButton&&this.dropdownButton.$el.hide()}show(){super.show(),this.manipulatorButtons.show(),Object.values(this.axisLabels).forEach((function(e){e.show()})),this.dropdownButton&&(this.dropdownButton.appendToCanvasParent(),this.dropdownButton.$el.show())}getPickPriority(e){return OT(e.selectionId)?Ef.z.UI+5:Ef.z.UI}onViewWillDraw(e,t){this.updateTransform(e),this.manipulatorButtons.updateTransform();for(const t in this.axisLabels)this.axisLabels[t].updateTransform(e)}ensureTextures(){if(!this.viewer.getGlContext())return;const e=this,t=function(t,i,s,n){e.labelTextures[t]||(e.labelTextures[t]=Go(e.viewer,i,{color:n?DT.getColor("VIEW_CUBE_TEXT_COLOR_HIGHLIGHT"):DT.getColor("VIEW_CUBE_TEXT_COLOR"),font:DT.getString("VIEW_CUBE_TEXT_FONT"),size:s,paddingWithinBorder:DT.getNumber("VIEW_CUBE_TEXT_BACKGROUND_PADDING")}));let r=e.labelProperties[t];r||(r=new Qi(LT),r.material=Xi(),e.labelProperties[t]=r),r.material.ambientTexture=e.labelTextures[t],r.updateId()},i=function(e,i,s){t(e,i,s,!1),t(e+XT,i,s,!0)};i(AT.TOP,this.i18next("Top"),DT.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(AT.BOTTOM,this.i18next("Bottom"),DT.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(AT.FRONT,this.i18next("Front"),DT.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(AT.BACK,this.i18next("Back"),DT.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(AT.RIGHT,this.i18next("Right"),DT.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(AT.LEFT,this.i18next("Left"),DT.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX"));for(const e in this.axisLabels)this.axisLabels[e].ensureTexture()}updateCenter(e){const t=e.getViewport(),i=-yh(t)[0]-.5*xT;this.center=pe.S4.add([t[0]+t[2]-xT/2,t[1]+t[3]-xT/2,i],this.topRightCorner);const s=t[0]+DT.getNumber("VIEW_CUBE_LEFT_MARGIN_PX")+xT/2,n=t[1]+DT.getNumber("VIEW_CUBE_BOTTOM_MARGIN_PX")+xT/2,r=t[0]+t[2]-DT.getNumber("VIEW_CUBE_RIGHT_MARGIN_PX")-xT/2,a=t[1]+t[3]-DT.getNumber("VIEW_CUBE_TOP_MARGIN_PX")-xT/2;this.center[0]=Math.min(Math.max(s,this.center[0]),r),this.center[1]=Math.min(Math.max(n,this.center[1]),a),this.topRightCorner=[this.center[0]+xT/2-t[0]-t[2],this.center[1]+xT/2-t[1]-t[3],0],this.updateDropdownPosition();for(const e in this.axisLabels)this.axisLabels[e].setCubeCenter(this.center);this.manipulatorButtons.setCubeCenter(this.center)}getStaticIncrements(){if(this.staticIncrements)return this.staticIncrements;const e=this;this.staticIncrements={};const t=function(t,i,s,n){pe.S4.scale(i,xT),pe.S4.scale(s,xT),pe.S4.scale(n,xT);const r=pe.S4.subtract(s,i,v.create()),a=pe.S4.subtract(n,i,v.create()),o=pe.S4.add(i,pe.S4.scale(pe.S4.add(r,a,v.create()),.5),v.create()),h=pe.S4.length(r),c=pe.S4.length(a);pe.S4.scale(r,1/h),pe.S4.scale(a,1/c);const l=(h+c)/2*DT.getNumber("VIEW_CUBE_CORNER_SIZE"),u=t+"Front",d=h*DT.getNumber("VIEW_CUBE_FRONT_SIZE"),g=c*DT.getNumber("VIEW_CUBE_FRONT_SIZE");let p=pe.S4.add(pe.S4.scale(r,-.5*d,v.create()),pe.S4.scale(a,-.5*g,v.create()),v.create());p=pe.S4.add(p,o);const m=wu(p,pe.S4.add(pe.S4.scale(r,d,v.create()),p),pe.S4.add(pe.S4.scale(a,g,v.create()),p),l,9);e.staticIncrements[u]={selection:t,data:m,type:RT,color:DT.getColor("VIEW_CUBE_FRONT_COLOR")};const f=t+"Edge",I=m.points;let E=I.length/3;const S=new Int32Array(2*E);for(let e=0;e<E;++e)S[2*e]=e,S[2*e+1]=(e+1)%E;const T=new jE(_i.MX.LINES,I,S);e.staticIncrements[f]={selection:t,data:T,type:wT,color:DT.getColor("VIEW_CUBE_EDGE_HIGHLIGHT")};const M=t+"Back",C=h*DT.getNumber("VIEW_CUBE_BACK_SIZE"),D=c*DT.getNumber("VIEW_CUBE_BACK_SIZE");let P=pe.S4.add(pe.S4.scale(r,-.5*C,v.create()),pe.S4.scale(a,-.5*D,v.create()),v.create());P=pe.S4.add(P,o);const y=pe.S4.add(pe.S4.scale(r,C,v.create()),P),A=wu(P,pe.S4.add(pe.S4.scale(a,D,v.create()),P),y,l,9);e.staticIncrements[M]={selection:t,data:A,type:RT,color:DT.getColor("VIEW_CUBE_BACK_COLOR")};const O=t+"BackEdge",R=A.points;E=I.length/3;const w=new Int32Array(2*E);for(let e=0;e<E;++e)w[2*e]=e,w[2*e+1]=(e+1)%E;const _=new jE(_i.MX.LINES,R,w);e.staticIncrements[O]={selection:t,data:_,type:wT,color:DT.getColor("VIEW_CUBE_EDGE_HIGHLIGHT")};const N=t+"Label",b=e.labelTextures[t],L=b.filledWidthPx,F=b.filledHeightPx,x=(h-L)/2,B=(c-F)/2,U=pe.S4.add(pe.S4.scale(r,x,v.create()),pe.S4.scale(a,B,v.create()),v.create());pe.S4.add(U,i);const V=Ou(U,pe.S4.add(U,pe.S4.scale(r,L,v.create()),v.create()),pe.S4.add(U,pe.S4.scale(a,F,v.create()),v.create()),void 0,[b.leftCoordinate,b.bottomCoordinate],[b.rightCoordinate,b.topCoordinate]);e.staticIncrements[N]={selection:t,data:V,type:e.labelProperties[t],color:null},e.staticIncrements[N+XT]={selection:t,data:V,type:e.labelProperties[t+XT],color:null}},i=kT;t(AT.TOP,[-i,-i,i],[i,-i,i],[-i,i,i]),t(AT.BOTTOM,[-i,i,-i],[i,i,-i],[-i,-i,-i]),t(AT.FRONT,[-i,-i,-i],[i,-i,-i],[-i,-i,i]),t(AT.BACK,[i,i,-i],[-i,i,-i],[i,i,i]),t(AT.RIGHT,[i,-i,-i],[i,i,-i],[i,-i,i]),t(AT.LEFT,[-i,i,-i],[-i,-i,-i],[-i,i,i]);const s=function(t,i,s,n){pe.S4.scale(i,xT);const r=t+"Face",a=Mu(i,n*=xT,s,36);e.staticIncrements[r]={selection:t,data:a,type:RT,color:DT.getColor("VIEW_CUBE_FRONT_COLOR")};const o=t+"Edge",h=a.points,c=h.length/3,l=new Int32Array(2*c);for(let e=0;e<c;++e)l[2*e]=e,l[2*e+1]=(e+1)%c;const u=new jE(_i.MX.LINES,h,l);e.staticIncrements[o]={selection:t,data:u,type:wT,color:DT.getColor("VIEW_CUBE_EDGE_HIGHLIGHT")}},n=.8*i,r=.24*i;return s(AT.TRIMETRIC_TOP_RIGHT_FRONT,[n,-n,n],[1,-1,1],r),s(AT.TRIMETRIC_TOP_LEFT_FRONT,[-n,-n,n],[-1,-1,1],r),s(AT.TRIMETRIC_TOP_RIGHT_BACK,[n,n,n],[1,1,1],r),s(AT.TRIMETRIC_TOP_LEFT_BACK,[-n,n,n],[-1,1,1],r),s(AT.TRIMETRIC_BOTTOM_RIGHT_FRONT,[n,-n,-n],[1,-1,-1],r),s(AT.TRIMETRIC_BOTTOM_LEFT_FRONT,[-n,-n,-n],[-1,-1,-1],r),s(AT.TRIMETRIC_BOTTOM_RIGHT_BACK,[n,n,-n],[1,1,-1],r),s(AT.TRIMETRIC_BOTTOM_LEFT_BACK,[-n,n,-n],[-1,1,-1],r),e.staticIncrements}updateGraphics(){const e=AT,t=[e.TOP,e.BOTTOM,e.FRONT,e.BACK,e.LEFT,e.RIGHT];let i;for(i=0;i<t.length;i++)this.updateIncrementsOnEntity(t[i],"Front"),this.updateIncrementsOnEntity(t[i],"Edge"),this.updateIncrementsOnEntity(t[i],"Back"),this.updateIncrementsOnEntity(t[i],"BackEdge"),this.highlightedId===t[i]?(this.removeMeshIncrement(t[i]+"Label"),this.updateIncrementsOnEntity(t[i],"Label"+XT)):(this.removeMeshIncrement(t[i]+"Label"+XT),this.updateIncrementsOnEntity(t[i],"Label"));const s=[e.TRIMETRIC_TOP_RIGHT_FRONT,e.TRIMETRIC_TOP_LEFT_FRONT,e.TRIMETRIC_TOP_RIGHT_BACK,e.TRIMETRIC_TOP_LEFT_BACK,e.TRIMETRIC_BOTTOM_RIGHT_FRONT,e.TRIMETRIC_BOTTOM_LEFT_FRONT,e.TRIMETRIC_BOTTOM_RIGHT_BACK,e.TRIMETRIC_BOTTOM_LEFT_BACK];for(i=0;i<s.length;i++)this.updateIncrementsOnEntity(s[i],"Face"),this.updateIncrementsOnEntity(s[i],"Edge");this.addAxes()}addAxes(){const e=this,t=function(t,i,s){const n=xT*kT,r=DT.getNumber("VIEW_CUBE_AXIS_GAP"),a=[-n-r,-n-r,-n-r],o=pu(a,pe.S4.add(pe.S4.scale(i,2*n,v.create()),a));Hu(DT.getNumber("VIEW_CUBE_AXIS_WIDTH"),o),Uu(s,o),e.updateMeshIncrement(t,yi,o,NT);const h=o.clone();ku(DT.getStipple("VIEW_CUBE_HIDDEN_AXIS_STIPPLE"),h);const c=s.slice(0);c[3]=DT.getNumber("VIEW_CUBE_HIDDEN_AXIS_OPACITY"),Uu(c,h),e.updateMeshIncrement(t+".st",yi,h,bT)};t("X",[1,0,0],DT.getColor("X_AXIS_COLOR")),t("Y",[0,1,0],DT.getColor("Y_AXIS_COLOR")),t("Z",[0,0,1],DT.getColor("Z_AXIS_COLOR"))}updateIncrementsOnEntity(e,t){const i=this,s=this.getStaticIncrements();s[e+t].type===RT?Uu(i.highlightedId===s[e+t].selection?DT.getColor("VIEW_CUBE_FACE_HIGHLIGHT"):s[e+t].color,s[e+t].data):s[e+t].type===_T&&Uu(s[e+t].color,s[e+t].data),this.updateMeshIncrement(e+t,s[e+t].selection,s[e+t].data.clone(),s[e+t].type)}updateTransform(e){this.updateCenter(e);const t=ge.create();t[12]=this.center[0],t[13]=this.center[1],t[14]=this.center[2];const i=pe.w$.lookAt([0,0,0,1],e.direction,e.up,ge.create()),s=pe.w$.multiply(t,i,ge.create());this.setTransform(s),this.hasMeshIncrements()||this.updateGraphics()}isMouseInside(){return this.highlightedId!==yi||this.manipulatorButtons.highlightedId!==yi}onMouseClick(e,t,i){this.trigger(vT,e.selectionId),ps.Jq.AnalyticsService.trackEventForDocumentId("VIEW_CUBE_COMMAND","click_"+e.selectionId,(0,ta.n)()),AT.TOP===e.selectionId?this.viewer.animateToStandardView("XY"):AT.BOTTOM===e.selectionId?this.viewer.animateToStandardView("XYback"):AT.FRONT===e.selectionId?this.viewer.animateToStandardView("XZ"):AT.BACK===e.selectionId?this.viewer.animateToStandardView("XZback"):AT.RIGHT===e.selectionId?this.viewer.animateToStandardView("YZ"):AT.LEFT===e.selectionId?this.viewer.animateToStandardView("YZback"):OT(e.selectionId)&&this.viewer.animateToStandardView(e.selectionId),i.requestSelectedStatus=!1}onMouseEnter(e,t){this.highlightedId=e.selectionId,this.updateGraphics(),this.viewer.requestDraw()}onMouseLeave(e,t){this.highlightedId===e.selectionId&&(this.highlightedId=yi,this.updateGraphics()),this.viewer.requestDraw()}onDragStart(e,t,i){i.requestDrag=!0,this.setDragStart(t)}onDrag(e,t){this.updateDragPosition(t)}setDragStart(e){this.dragStart=[e.mouseX,e.mouseY]}updateDragPosition(e){this.topRightCorner[0]+=e.mouseX-this.dragStart[0],this.topRightCorner[1]+=-(e.mouseY-this.dragStart[1]);const t=Math.abs(e.mouseX-this.dragStart[0])+Math.abs(e.mouseY-this.dragStart[1]);return this.setDragStart(e),this.manipulatorButtons.updateGraphics(),this.updateDropdownPosition(),this.viewer.requestDraw(),t}updateDropdownPosition(){if(this.dropdownButton){const e=(0,Es.x_)(),t=DT.getNumber("VIEW_CUBE_SCREEN_SIZE_PX");this.dropdownButton.position(-this.topRightCorner[0]/e,(-this.topRightCorner[1]+t)/e-this.dropdownButton.$el.height()+5)}}onDragStop(e,t){delete this.dragStart,this.viewer.requestDraw()}isViewManipulator(){return!0}}const eM=new Qi({isPickable:!1,primitiveType:_i.MX.LINES,isStencilWritten:!1,includedInBlend:!0}),tM="text",iM=q.default.getManager();class sM extends Ri{constructor(e,t,i){super(i),this.name=e,this.featureModel=t,this.minPlanePoint=null,this.maxPlanePoint=null,this.textTexture=null,this.planeMatrix=null,this.planeMatrixInverse=null,this.lineColor=iM.getColor("SKETCH_PLANE_LINE_COLOR"),this.textColor=iM.getColor("SKETCH_PLANE_TEXT_COLOR"),this.textMaterial=Xi(),this.textNodeProperties=new Qi({isPickable:!1,isTwoSided:!0,primitiveType:_i.MX.TRIANGLES,material:this.textMaterial}),this.onPlaneChange(),this.listenTo(t,"change:planeMatrix",this.onPlaneChange),this.listenTo(t,"change:hasRegenError",this.onRegenErrorChange)}remove(){this.destroyText(),this.textMaterial&&(this.textMaterial.destroy(),this.textMaterial=null),super.remove()}destroyText(){this.textTexture&&(this.textTexture.destroy(),this.textTexture=null)}onRegenErrorChange(){this.featureModel.getHasRegenError()===W.AAq.ERROR!==this.isHidden&&this.onPlaneChange()}onPlaneChange(){this.planeMatrix=null,this.planeMatrixInverse=null,this.destroyText(),this.minPlanePoint=null,this.maxPlanePoint=null;const e=this.featureModel.getHasRegenError()===W.AAq.ERROR;this.viewer.getSketch()&&!e?(this.planeMatrix=this.viewer.getSketch().getPlaneMatrix(),this.planeMatrixInverse=pe.w$.inverse(this.planeMatrix,ge.create()),this.show()):this.hide(),(0,Js.vm)()}getEntityBoundsCenter(){const e=this.featureModel.parameters[0].getBtParameterForCurrentConfiguration();if(this.featureModel&&this.featureModel.parameters&&this.featureModel.parameters.length>0&&e.getIsAQueryList()&&!e.getIsEmptyQueryList()){const t=e.getQueryListItems()[0],i=t.getDeterministicIds();if(i&&i.length>0){const e=this.viewer.getModelViewManagers().getManager(),s=e.extractMeshIncrement(i[0]);if(s){let t=null;const n=e.getDisplayedElement();if(n instanceof qd){const e=(0,ve.cF)(i[0]);e&&(t=n.getBodyTransform(e.getBodyId(),this.viewer))}return t?pe.w$.multiplyVec3(t,s.getBounds().center()):s.getBounds().center()}const n=e.getMateConnectorGraphics(null,t.getFeatureId());if(n)return n.worldSpacePosition}}return null}hasBounds(){return!!this.minPlanePoint&&!!this.maxPlanePoint}updateBounds(e){if(!this.planeMatrix||this.hasBounds())return;const t=this.getEntityBoundsCenter();if(!t)return;let i=(0,Li.Oh)(t,this.planeMatrixInverse);const s=e.projectWorldPointToViewport(t);if(s[0]<e.getViewportLeft()||s[0]>=e.getViewportWidth()||s[1]<e.getViewportBottom()||s[1]>=e.getViewportHeight()){const t=e.viewportToCanvas([e.getViewportWidth()/2,e.getViewportHeight()/2,0]),s=e.getRay(t[0],t[1]),n=.258819,r=(0,Li.bZ)(s,this.planeMatrix,n);r&&(i=(0,Li.Oh)(r,this.planeMatrixInverse))}const n=e.getPixelSizeAtWorldPoint((0,Li.KU)(i,this.planeMatrix)),r=iM.getNumber("VIEWPORT_HEIGHT_TO_PLANE_HEIGHT_RATIO")*e.getViewportHeight()*n,a=r*iM.getNumber("PLANE_DEFAULT_WIDTH_HEIGHT_RATIO");this.minPlanePoint=[i[0]-a/2,i[1]-r/2],this.maxPlanePoint=[i[0]+a/2,i[1]+r/2];const o=(0,Li.KU)([this.minPlanePoint[0],this.minPlanePoint[1]],this.planeMatrix),h=(0,Li.KU)([this.maxPlanePoint[0],this.minPlanePoint[1]],this.planeMatrix),c=(0,Li.KU)([this.maxPlanePoint[0],this.maxPlanePoint[1]],this.planeMatrix),l=(0,Li.KU)([this.minPlanePoint[0],this.maxPlanePoint[1]],this.planeMatrix),u=Iu([o,h,h,c,c,l,l,o]);Uu(this.lineColor,u),this.updateMeshIncrement("edges",yi,u,eM)}updateText(e){if(!this.planeMatrix||!this.hasBounds())return;const t=this.getTextTexture(),i=(0,Li.KU)([this.minPlanePoint[0],this.minPlanePoint[1]],this.planeMatrix),s=(0,Li.KU)([this.maxPlanePoint[0],this.minPlanePoint[1]],this.planeMatrix),n=(0,Li.KU)([this.minPlanePoint[0],this.maxPlanePoint[1]],this.planeMatrix),r=pe.S4.subtract(s,i,v.create()),a=pe.S4.length(r);pe.S4.normalize(r);const o=pe.S4.subtract(n,i,v.create()),h=pe.S4.length(o);pe.S4.normalize(o);const c=1/e.getUnitSizeAtWorldPoint(n);let l=c*t.filledWidthPx,u=c*t.filledHeightPx;const d=c*iM.getNumber("PLANE_TEXT_MARGIN");if(l>a-2*d||u>h-2*d){const e=Math.min((a-2*d)/l,(h-2*d)/u);if(e<=0)return void this.removeMeshIncrement(tM);l*=e,u*=e}const g=pe.S4.add(n,pe.S4.scale(o,-d-u,v.create()),v.create());pe.S4.add(g,pe.S4.scale(r,d,v.create()));const p=pe.S4.add(g,pe.S4.scale(r,l,v.create()),v.create()),m=pe.S4.add(g,pe.S4.scale(o,u,v.create()),v.create());this.textMaterial.ambientTexture=t;const f=Ou(g,p,m,void 0,[t.leftCoordinate,t.bottomCoordinate],[t.rightCoordinate,t.topCoordinate]);this.updateMeshIncrement(tM,yi,f,this.textNodeProperties)}getTextTexture(){return this.textTexture||(this.textTexture=Go(this.viewer,this.name,{color:this.textColor,font:iM.getString("PLANE_TEXT_FONT"),size:iM.getNumber("PLANE_TEXT_HEIGHT_PX"),paddingWithinBorder:iM.getNumber("PLANE_TEXT_BACKGROUND_PADDING")})),this.textTexture}onViewWillDraw(e,t){this.updateBounds(e),this.updateText(e)}onAppearanceConstantsUpdated(){this.lineColor=iM.getColor("SKETCH_PLANE_LINE_COLOR"),this.textColor=iM.getColor("SKETCH_PLANE_TEXT_COLOR"),this.onPlaneChange()}}const nM=q.default.getManager();class rM extends Ri{constructor(e,t,i,s){super(e,sh.Jh),this.pickPass=new we(this.viewer),this.pickPass.setSceneGraph(this.getSceneGraph()),this.pointSizeConstantName=void 0!==t?t:"INFERENCE_POINT_SIZE_PX",this.lineWidthConstantName=void 0!==i?i:"INFERENCE_LINE_WIDTH_PX",this.pickRadiusConstantName=void 0!==s?s:"INFERENCE_PICK_RADIUS_PX",this.inferencePointMaterial=new ki({color:nM.getColor("INFERENCE_DEBUG_POINT_COLOR"),pointSize:nM.getNumber(this.pointSizeConstantName)}),this.inferenceLineMaterial=new ki({color:nM.getColor("INFERENCE_DEBUG_LINE_COLOR"),lineWidth:nM.getNumber(this.lineWidthConstantName)}),this.inferenceCurveMaterial=new ki({base:nM.getColor("INFERENCE_DEBUG_CURVE_COLOR"),lineWidth:nM.getNumber(this.lineWidthConstantName)}),this.pointNodeProperties=new Qi({primitiveType:_i.MX.POINTS,isShowThrough:!0,isDepthTested:!1,material:this.inferencePointMaterial,priority:Yi.HIGHER}),this.importantNodeProperties=new Qi({primitiveType:_i.MX.POINTS,isShowThrough:!0,isDepthTested:!1,material:this.inferencePointMaterial,priority:Yi.HIGHEST}),this.linesNodeProperties=new Qi({primitiveType:_i.MX.INFINITE_LINES,isShowThrough:!0,isDepthTested:!1,material:this.inferenceLineMaterial,priority:Yi.LOWER}),this.curvesNodeProperties=new Qi({primitiveType:_i.MX.LINES,isShowThrough:!0,isDepthTested:!1,material:this.inferenceCurveMaterial,priority:Yi.DEFAULT}),this.pickRadius=nM.getNumber(this.pickRadiusConstantName),this.viewer.visualizeInferenceSceneGraph(this.getSceneGraph())}getSceneGraph(){return this.viewer.getSceneGraphs().getSceneGraph(sh.Jh)}onDevicePixelRatioChanged(e){this.pickRadius=nM.getNumber(this.pickRadiusConstantName),this.inferencePointMaterial.pointSize=nM.getNumber(this.pointSizeConstantName),this.inferenceLineMaterial.lineWidth=nM.getNumber(this.lineWidthConstantName),this.inferenceCurveMaterial.lineWidth=nM.getNumber(this.lineWidthConstantName)}remove(){super.remove(),this.viewer&&this.viewer.visualizeInferenceSceneGraph(null),this.inferencePointMaterial.destroy(),this.inferenceLineMaterial.destroy(),this.inferenceCurveMaterial.destroy()}setIncrementPickId(e,t){if(!t.pickId)throw"InferencePicker should be supplied increments that already have a pick id set"}pick(e,t){if(this.viewer){const i=this.pickInRect(e,t,this.pickRadius),s=i.length>0?i[0]:null;return s?s.primitiveId:Di.JE}return Di.JE}pickMultiple(e,t){if(this.viewer){const i=this.pickIteratively(e,t,this.pickRadius,nM.getNumber("MAXIMUM_INFERENCE_PICKS")).map((function(e){return e?e.primitiveId:Di.JE}));return this.getHighestPriorityInferences(i)}return[]}pickInRect(e,t,i){if(!this.viewer.isReadyForDrawing())return[];const s=2*i+1,n=2*i+1,r=e-i,a=t-i;this.viewer.pushCameraState(),this.pickPass.setSceneGraph(this.getSceneGraph()),this.pickPass.setPickRect(r,a,s,n),this.pickPass.draw(this.viewer.getRenderContext()),this.viewer.popCameraState();const o=this.pickPass.gatherPicksFromPickPass(),h=[];for(const e in o){const t=o[e];for(const e in t)h.push(t[e])}return h.sort(jS.G)}pickIteratively(e,t,i,s){const n=[];let r,a,o=!1,h=0;for(;!(h>s);){const s=this.pickInRect(e,t,i);if(s.length<1)break;for(r=0;r<s.length;++r)a=s[r],a.fromPass=h,n.push(a);for(r=0;r<s.length;++r)this.hideIncrementFromPick(s[r].primitiveId.toString()),o=!0;++h}return o&&this.occurrenceData.resetHiddenFromPick(),n}getHighestPriorityInferences(e){if(0===e.length)return[];const t=[e[0]],i=this.getRenderOrderPriority(e[0]);for(let s=1;s<e.length;s++){const n=this.getRenderOrderPriority(e[s]);if(n<0)return t;if(n!==i)break;t.push(e[s])}return t}getMeshIncrementForPrimitiveId(e){const t=this.getInstantiatedMeshIncrement(e.toString());return t?t.meshIncrement:null}getRenderOrderPriority(e){const t=this.getInstantiatedMeshIncrement(e.toString());return t?t.nodeProperties.priority:-1}updateInference(e,t){const i=e.id;if(!i)return;let s=null;e.primitiveType===_i.MX.POINTS?(s=t?this.importantNodeProperties:this.pointNodeProperties,Hu(nM.getNumber(this.pointSizeConstantName),e)):e.primitiveType===_i.MX.INFINITE_LINES?(s=this.linesNodeProperties,Hu(nM.getNumber(this.lineWidthConstantName),e)):e.primitiveType===_i.MX.LINES&&(s=this.curvesNodeProperties,Hu(nM.getNumber(this.lineWidthConstantName),e)),s&&this.updateMeshIncrement(i,i,e,s)}deleteInference(e){this.removeMeshIncrement(e)}resetInferences(){this.removeMeshIncrements()}}var aM=i(29455);const oM="boxId";class hM extends Ri{constructor(e,t,i,s,n,r,a,o){super(t),this.firstClashParentId=i,this.secondClashParentId=s,this.interferenceIndex=n,this.boundingBox=r,this.LINE_WIDTH=2.5,this.lineNodeProps=new Qi({primitiveType:_i.MX.LINES,isPickable:!0,isHighlightable:!0,isTwoSided:!0,isShowThrough:!1}),this.boxLineNodeProps=new Qi({primitiveType:_i.MX.LINES,isPickable:!1,isHighlightable:!0,isVisible:!1}),this.faceNodeProps=new Qi({isPickable:!0,primitiveType:_i.MX.TRIANGLE_STRIP}),this.interferenceIndex=n,this.selectionId=i+s+n,e.tessellation.forEach(((t,i)=>{const s=GI(t),n=e.appearance,r="id"+i;let a;if(s.primitiveType===_i.MX.LINES){a=this.lineNodeProps,Hu(this.LINE_WIDTH,s);Uu(UI(n,_i.MX.LINES),s)}else if(s.primitiveType===_i.MX.TRIANGLE_STRIP){a=this.faceNodeProps;Uu(UI(n,_i.MX.TRIANGLE_STRIP),s)}a&&(this.updateMeshIncrement(r,this.selectionId,s,a),this.viewer.getIsolatedOccurrenceManager().addIdsToIsolate([this.graphicsOccurrenceId],!0))})),this.boxIncrement=Lu(this.boundingBox.minCorner.getVec3(),this.boundingBox.maxCorner.getVec3()).createTransformed(a.getGlMatrix()),o&&this.setTransform(o.getGlMatrix())}getSelectionId(){return this.selectionId}remove(){this.viewer.getIsolatedOccurrenceManager().removeFromIsolate([this.graphicsOccurrenceId]),super.remove()}getModelSelection(){return new aM.Y(W.lQt.TEMPORARY_GEOMETRY,this.selectionId)}processResetSelection(e){e===yn.o2.SECONDARY&&this.boxIncrement&&this.removeMeshIncrement(oM),this.removeHighlightFromOccurrence(e)}processAddSelection(e,t){this.selectionId===e&&(t===yn.o2.SECONDARY&&this.boxIncrement&&this.updateMeshIncrement(oM,this.selectionId,this.boxIncrement,this.boxLineNodeProps),this.addNewHighlightToOccurrence(t))}processRemoveSelection(e,t){this.selectionId===e&&this.removeHighlightFromOccurrence(t)}}class cM extends Ri{constructor(e,t,i,s,n,r){super(n,r);const a=Ou(e,t,i);this.updateMeshIncrement("quad",yi,a,s)}}class lM{constructor(e){this.viewer=e,this.cameraAnimationCallback=null,this.animationLoopInProgress=!1,this.animationSequenceCounter=0,this.animationSequenceStartTime=0,this.animationSequenceFrameCount=0,this.frameCallback=e=>this.onRequestDrawFulfilled(e),this.ongoingAnimations=new Set,this.incrementAnimationSequence()}onRequestDrawFulfilled(e){if(this.viewer.isOngoingRenderLoopRunning)return;const t=this.advanceAnimation(e);this.viewer.draw(t?e:void 0)}advanceAnimation(e){if(!this.animationLoopInProgress)return!1;let t=!1;if(this.cameraAnimationCallback){this.cameraAnimationCallback(e)===ir.Z.COMPLETE?this.cameraAnimationCallback=null:t=!0}for(const i of this.ongoingAnimations.values()){i(e)===ir.Z.COMPLETE?this.ongoingAnimations.delete(i):t=!0}if(t)this.viewer.setSystemIsAnimating(),this.viewer.isOngoingRenderLoopRunning||this.viewer.requestDraw(this.frameCallback),++this.animationSequenceFrameCount;else if(this.animationLoopInProgress=!1,this.incrementAnimationSequence(),this.viewer.setSuppressMouseMovePick(!1),this.viewer.isOngoingRenderLoopRunning||this.viewer.getInputHandler().isMouseInCanvas()&&this.viewer.doPreHighlightPick(),this.animationSequenceFrameCount>0){const e=(this.animationSequenceFrameCount/((0,Js.Es)(this.animationSequenceStartTime)/1e3)).toFixed(1);It.log.trace("Animation completed with average framerate of "+e+" fps")}return t}requestAnimationFrameIfNeeded(){this.animationLoopInProgress&&!this.viewer.isOngoingRenderLoopRunning&&this.viewer.requestDraw(this.frameCallback)}startCameraAnimation(e){this.haltCameraAnimation(),this.cameraAnimationCallback=e,this.startAnimationRenderLoop()}isCameraAnimating(){return!!this.cameraAnimationCallback}haltCameraAnimation(){this.cameraAnimationCallback=null}startAnimation(e){this.ongoingAnimations.add(e),this.startAnimationRenderLoop()}incrementAnimationSequence(){this.viewer.$el.attr("animation-sequence",++this.animationSequenceCounter)}startAnimationRenderLoop(){this.animationLoopInProgress||(this.viewer.setSuppressMouseMovePick(!0),this.viewer.setSystemIsAnimating(),this.viewer.isOngoingRenderLoopRunning||this.viewer.requestDraw(this.frameCallback),this.animationLoopInProgress=!0,this.animationSequenceStartTime=(0,Js.Wj)(),this.animationSequenceFrameCount=0)}}class uM{constructor(e,t){this.timeBudget=e,this.vertexBudget=t,this.startTime=0,this.verticesSpent=0}addVertexCost(e){this.verticesSpent+=e}reset(){this.startTime=(0,Js.Wj)(),this.verticesSpent=0}budgetExceeded(){return this.verticesSpent>this.vertexBudget||(0,Js.Es)(this.startTime)>this.timeBudget}}const dM=new uM(q.default.getManager().getNumber("GRAPHICS_TASK_SMALL_INTERACTIVE_TIME_BUDGET"),q.default.getManager().getNumber("GRAPHICS_TASK_SMALL_INTERACTIVE_VERTEX_BUDGET")),gM=new uM(q.default.getManager().getNumber("GRAPHICS_TASK_MEDIUM_INTERACTIVE_TIME_BUDGET"),q.default.getManager().getNumber("GRAPHICS_TASK_MEDIUM_INTERACTIVE_VERTEX_BUDGET"));class pM{constructor(){this.tasks=[]}addTask(e,t){this.tasks.push({task:e,budget:t})}processWithBudget(e){e&&e.reset();for(let t=0;t<this.tasks.length&&(!e||!e.budgetExceeded());++t)this.tasks[t].task.process(e)}processInteractively(){let e=null;for(let t=0;t<this.tasks.length;++t)if(this.tasks[t].task.hasPendingWork()){e=this.tasks[t].budget;break}e&&this.processWithBudget(e)}complete(){this.processWithBudget(null)}hasPendingWork(){for(let e=0;e<this.tasks.length;++e)if(this.tasks[e].task.hasPendingWork())return!0;return!1}}var mM=i(32659);class fM{constructor(e){this.gl=e;for(const t in this.gl)"gl"!==t&&("function"==typeof e[t]?t in this||(this[t]=function(e,t,i){return function(){return i.apply(e,arguments)}}(this.gl,0,this.gl[t])):function(e,t){e[t]=e.gl[t]}(this,t))}apply(){}printState(){It.log.debug("BLEND \t\t"+this.gl.isEnabled(this.gl.BLEND)),It.log.debug("CULL_FACE \t\t"+this.gl.isEnabled(this.gl.CULL_FACE)),It.log.debug("DEPTH_TEST \t\t"+this.gl.isEnabled(this.gl.DEPTH_TEST)),It.log.debug("DITHER \t\t"+this.gl.isEnabled(this.gl.DITHER)),It.log.debug("POLYGON_OFFSET_FILL \t\t"+this.gl.isEnabled(this.gl.POLYGON_OFFSET_FILL)),It.log.debug("SAMPLE_ALPHA_TO_COVERAGE \t\t"+this.gl.isEnabled(this.gl.SAMPLE_ALPHA_TO_COVERAGE)),It.log.debug("SAMPLE_COVERAGE \t\t"+this.gl.isEnabled(this.gl.SAMPLE_COVERAGE)),It.log.debug("SCISSOR_TEST \t\t"+this.gl.isEnabled(this.gl.SCISSOR_TEST)),It.log.debug("STENCIL_TEST \t\t"+this.gl.isEnabled(this.gl.STENCIL_TEST)),It.log.debug("\n")}}class IM{constructor(e,t){this.callCounts={},t=void 0!==t&&t,this.gl=e;for(const i in this.gl)"gl"!==i&&"callCounts"!==i&&"printCallStats"!==i&&("function"==typeof e[i]?i in this||(this[i]=((e,i,s)=>()=>(t&&(i in this.callCounts?this.callCounts[i]++:this.callCounts[i]=1),It.log.debug(s.toString()),s.apply(e,arguments)))(this.gl,i,this.gl[i])):function(e,t){e[t]=e.gl[t]}(this,i))}printCallStats(){let e=[];for(const t in this.callCounts)e.push([t,this.callCounts[t]]);e=e.sort((function(e,t){return t[1]-e[1]}));for(const t in e)It.log.debug(e[t][0]+" "+e[t][1])}}class EM extends fM{constructor(e){super(e),this.nextId=1,this.uniqueIds=new Map}assignNextId(e){e.tempId=this.nextId,this.uniqueIds.set(e,this.nextId),this.nextId++}createProgram(){const e=this.gl.createProgram();return this.assignNextId(e),e}}class SM extends fM{constructor(e){super(new EM(e)),this.currentProgram=null,this.programFlags=[],this.programNames={},this.programSources=[]}getProgramFlags(){return this.programFlags}setProgramFlags(e){this.programFlags=e}onlyProgram(e){for(let t=0;t<this.programFlags.length;t++)this.programFlags[t]=e===t}allButProgram(e){for(let t=0;t<this.programFlags.length;t++)this.programFlags[t]=e!==t}allPrograms(){for(let e=0;e<this.programFlags.length;e++)this.programFlags[e]=!0}noPrograms(){for(let e=0;e<this.programFlags.length;e++)this.programFlags[e]=!1}createProgram(e){const t=super.createProgram();return this.programNames[t.tempId]=e,t}useProgram(e){this.currentProgram=e,this.gl.useProgram(e),e.tempId in this.programFlags||(this.programFlags[e.tempId]=!0)}drawArrays(e,t,i){this.programFlags[this.currentProgram.tempId]&&this.gl.drawArrays(e,t,i)}drawElements(e,t,i,s){this.programFlags[this.currentProgram.tempId]&&this.gl.drawElements(e,t,i,s)}}class TM extends fM{constructor(e,t,i){super(e),this.numChanges=t,this.numRepeats=i}enable(e){this.gl.enable(e);for(let t=0;t<this.numChanges;t++)this.gl.disable(e),this.gl.enable(e);for(let t=0;t<this.numRepeats;t++)this.gl.enable(e)}disable(e){this.gl.disable(e);for(let t=0;t<this.numChanges;t++)this.gl.enable(e),this.gl.disable(e);for(let t=0;t<this.numRepeats;t++)this.gl.disable(e)}enableVertexAttribArray(e){this.gl.enableVertexAttribArray(e);for(let t=0;t<this.numChanges;t++)this.gl.disableVertexAttribArray(e),this.gl.enableVertexAttribArray(e);for(let t=0;t<this.numRepeats;t++)this.gl.enableVertexAttribArray(e)}disableVertexAttribArray(e){this.gl.disableVertexAttribArray(e);for(let t=0;t<this.numChanges;t++)this.gl.enableVertexAttribArray(e),this.gl.disableVertexAttribArray(e);for(let t=0;t<this.numRepeats;t++)this.gl.disableVertexAttribArray(e)}useProgram(e){this.gl.useProgram(e);for(let t=0;t<this.numChanges;t++)this.gl.useProgram(null),this.gl.useProgram(e);for(let t=0;t<this.numRepeats;t++)this.gl.useProgram(e)}activeTexture(e){this.gl.activeTexture(e);for(let t=0;t<this.numChanges;t++)this.gl.activeTexture(this.gl.TEXTURE25),this.gl.activeTexture(e);for(let t=0;t<this.numRepeats;t++)this.gl.activeTexture(e)}bindTexture(e,t){this.gl.bindTexture(e,t);for(let i=0;i<this.numChanges;i++)this.gl.bindTexture(e,null),this.gl.bindTexture(e,t);for(let i=0;i<this.numRepeats;i++)this.gl.bindTexture(e,t)}}class MM extends fM{constructor(e,t,i){super(e),this.numChanges=t,this.numRepeats=i;const s=e=>()=>{e.apply(this.gl,arguments);for(let t=0;t<this.numRepeats;t++)e.apply(this.gl,arguments)},n=this;for(let e=1;e<=4;e++)mM.each(["f","i","fv","iv"],(function(t,i){let r="uniform"+e+i;n[r]=s(n.gl[r]),e>1&&(r="uniformMatrix"+e+i,n[r]=s(n.gl[r]))}));for(let e=1;e<=4;e++)mM.each(["f","fv"],(function(t,i){const r="vertexAttrib"+e+i;n[r]=s(n.gl[r])}))}}class CM extends fM{constructor(e){super(e),this.programUniforms=[],this.attributes=[],this.state=new Map,this.attribarraystate=new Map,this.currentProgram=e.getParameter(e.CURRENT_PROGRAM),this.currentProgramSent=e.getParameter(e.CURRENT_PROGRAM),this.activeTextureUnit=e.getParameter(e.ACTIVE_TEXTURE),this.activeTextureUnitSent=e.getParameter(e.ACTIVE_TEXTURE),this.textureUnits=new Map}getUniformLocation(e,t){const i=this.gl.getUniformLocation(e,t),s=this.programUniforms[e.tempId].length;return i&&(i.tempId=s,this.programUniforms[e.tempId][i.tempId]=null),i}apply(){this.applyProgram(),this.applyAttributes()}applyProgram(){this.currentProgramSent!==this.currentProgram&&(this.gl.useProgram(this.currentProgram),this.currentProgramSent=this.currentProgram);const e=this.programUniforms[this.currentProgram.tempId];if(e)for(let t=0;t<e.length;t++){const i=e[t];if(i){if(i[2])continue;const e=i[0],t=i[1];e.apply(this.gl,t),i[2]=!0}}}applyAttributes(){for(let e=0;e<this.attributes.length;e++){const t=this.attributes[e];if(t){if(t[2])continue;const e=t[0],i=t[1];e.apply(this.gl,i),t[2]=!0}}}createProgram(){const e=this.gl.createProgram();return this.programUniforms[e.tempId]=[],e}useProgram(e){this.currentProgram=e}deleteProgram(e){return this.gl.deleteProgram(e)}getCurrentProgramUniforms(){let e=this.programUniforms[this.currentProgram.tempId];return e||(e=[],this.programUniforms[this.currentProgram.tempId]=e),e}uniform1f(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform1f,n[2]=n[2]&&n[1][1]===t,n[1][1]=t):i[s]=[this.gl.uniform1f,[e,t],!1]}uniform1i(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform1i,n[2]=n[2]&&n[1][1]===t,n[1][1]=t):i[s]=[this.gl.uniform1i,[e,t],!1]}uniform2f(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniform2f,r[2]=r[2]&&r[1][1]===t&&r[1][2]===i,r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniform2f,[e,t,i],!1]}uniform2i(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniform2i,r[2]=r[2]&&r[1][1]===t&&r[1][2]===i,r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniform2i,[e,t,i],!1]}uniform3f(e,t,i,s){const n=this.getCurrentProgramUniforms(),r=e.tempId,a=n[r];a&&a[1].length===arguments.length?(a[0]=this.gl.uniform3f,a[2]=a[2]&&a[1][1]===t&&a[1][2]===i&&a[1][3]===s,a[1][1]=t,a[1][2]=i,a[1][3]=s):n[r]=[this.gl.uniform3f,[e,t,i,s],!1]}uniform3i(e,t,i,s){const n=this.getCurrentProgramUniforms(),r=e.tempId,a=n[r];a&&a[1].length===arguments.length?(a[0]=this.gl.uniform3i,a[2]=a[2]&&a[1][1]===t&&a[1][2]===i&&a[1][3]===s,a[1][1]=t,a[1][2]=i,a[1][3]=s):n[r]=[this.gl.uniform3i,[e,t,i,s],!1]}uniform4f(e,t,i,s,n){const r=this.getCurrentProgramUniforms(),a=e.tempId,o=r[a];o&&o[1].length===arguments.length?(o[0]=this.gl.uniform4f,o[2]=o[2]&&o[1][1]===t&&o[1][2]===i&&o[1][3]===s&&(o[1][4]=n),o[1][1]=t,o[1][2]=i,o[1][3]=s,o[1][4]=n):r[a]=[this.gl.uniform4f,[e,t,i,s,n],!1]}uniform4i(e,t,i,s,n){const r=this.getCurrentProgramUniforms(),a=e.tempId,o=r[a];o&&o[1].length===arguments.length?(o[0]=this.gl.uniform4i,o[2]=o[2]&&o[1][1]===t&&o[1][2]===i&&o[1][3]===s&&(o[1][4]=n),o[1][1]=t,o[1][2]=i,o[1][3]=s,o[1][4]=n):r[a]=[this.gl.uniform4i,[e,t,i,s,n],!1]}uniform1fv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform1fv,n[2]=n[2]&&(0,an.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform1fv,[e,t],!1]}uniform1iv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform1iv,n[2]=n[2]&&(0,an.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform1iv,[e,t],!1]}uniform2fv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform2fv,n[2]=n[2]&&(0,an.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform2fv,[e,t],!1]}uniform2iv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform2iv,n[2]=n[2]&&(0,an.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform2iv,[e,t],!1]}uniform3fv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform3fv,n[2]=n[2]&&(0,an.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform3fv,[e,t],!1]}uniform3iv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform3iv,n[2]=n[2]&&(0,an.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform3iv,[e,t],!1]}uniform4fv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform4fv,n[2]=n[2]&&(0,an.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform4fv,[e,t],!1]}uniform4iv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform4iv,n[2]=n[2]&&(0,an.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform4iv,[e,t],!1]}uniformMatrix2fv(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniformMatrix2fv,r[2]=r[2]&&r[1][1]===t&&(0,an.Z)(r[1][2],i),r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniformMatrix2fv,[e,t,i],!1]}uniformMatrix3fv(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniformMatrix3fv,r[2]=r[2]&&r[1][1]===t&&(0,an.Z)(r[1][2],i),r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniformMatrix3fv,[e,t,i],!1]}uniformMatrix4fv(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniformMatrix4fv,r[2]=r[2]&&r[1][1]===t&&(0,an.Z)(r[1][2],i),r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniformMatrix4fv,[e,t,i],!1]}vertexAttrib1f(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib1f,i[2]=i[2]&&i[1][1]===t,i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib1f,[e,t],!1]}vertexAttrib2f(e,t,i){const s=this.attributes[e];s&&s[1].length===arguments.length?(s[0]=this.gl.vertexAttrib2f,s[2]=s[2]&&s[1][1]===t&&s[1][2]===i,s[1][1]=t,s[1][2]=i):this.attributes[e]=[this.gl.vertexAttrib2f,[e,t,i],!1]}vertexAttrib3f(e,t,i,s){const n=this.attributes[e];n&&n[1].length===arguments.length?(n[0]=this.gl.vertexAttrib3f,n[2]=n[2]&&n[1][1]===t&&n[1][2]===i&&n[1][3]===s,n[1][1]=t,n[1][2]=i,n[1][3]=s):this.attributes[e]=[this.gl.vertexAttrib3f,[e,t,i,s],!1]}vertexAttrib4f(e,t,i,s,n){const r=this.attributes[e];r&&r[1].length===arguments.length?(r[0]=this.gl.vertexAttrib4f,r[2]=r[2]&&r[1][1]===t&&r[1][2]===i&&r[1][3]===s&&r[1][4]===n,r[1][1]=t,r[1][2]=i,r[1][3]=s,r[1][4]=n):this.attributes[e]=[this.gl.vertexAttrib4f,[e,t,i,s,n],!1]}vertexAttrib1fv(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib1fv,i[2]=i[2]&&(0,an.Z)(i[1][1],t),i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib1fv,[e,t],!1]}vertexAttrib2fv(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib2fv,i[2]=i[2]&&(0,an.Z)(i[1][1],t),i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib2fv,[e,t],!1]}vertexAttrib3fv(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib3fv,i[2]=i[2]&&(0,an.Z)(i[1][1],t),i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib3fv,[e,t],!1]}vertexAttrib4fv(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib4fv,i[2]=i[2]&&(0,an.Z)(i[1][1],t),i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib4fv,[e,t],!1]}drawArrays(e,t,i){this.apply(),this.gl.drawArrays(e,t,i)}drawElements(e,t,i,s){this.apply(),this.gl.drawElements(e,t,i,s)}}class DM extends m.T{constructor(e,t){super(),this.viewer=e,this.isolatedOccurrencesManager=t,this.affectedOccurrenceIds=[],this.centersOfInitialAffectedInstances=null,this.dialog=null,this.setUpListeners()}destroy(){this.dialog&&(this.dialog.destroy(),this.dialog=null),this.stopListening()}setIsIsolateFullyTransparent(e){this.viewer.getViewerPreferences().isolateHideTransparent!==e&&(ps.Jq.CapabilitiesService.checkStickyHideTransparentPartsCurrentlyEnabled()&&ps.Jq.UserSettingsService.updateIsolateHideTransparent(e?"true":"false"),this.viewer.getViewerPreferences().isolateHideTransparent=e,this.triggerIsolateFullyTransparentChangeEvent())}getIsolatedOccurrenceManager(){return this.isolatedOccurrencesManager}triggerIsolateFullyTransparentChangeEvent(){this.isolatedOccurrencesManager.onIsIsolateFullyTransparentChanged(),this.viewer.requestDraw()}setIsIsolateFullyTransparentAsDefault(){this.viewer.getViewerPreferences().isolateHideTransparent=!0}getIsIsolateFullyTransparent(){return this.viewer.getViewerPreferences().isolateHideTransparent&&this.getIsolatedOccurrenceManager().isInIsolateOrMakeTransparentMode()}clearEffectNoAnimation(){this.hasAffectedInstances()&&(this.clearEffect(),this.viewer.onIsolateChanged(),(0,Js.vm)()),this.dialog&&(this.dialog.destroy(),this.dialog=null)}clearEffectExit(e){if(this.viewer!==e)return;let t=!0;this.currentRenderModeSupportsAnimation()?this.hasAffectedInstances()&&(t=!1,this.viewer.animateIsolation(!1,(()=>{this.destroyDialog(),this.clearEffect(),this.viewer.onIsolateChanged(),(0,Js.vm)()}))):this.clearEffectNoAnimation(),t&&this.destroyDialog()}destroyDialog(){this.dialog&&(this.dialog.destroy(),this.dialog=null)}currentRenderModeSupportsAnimation(){return!(this.viewer.getRenderingMode()===W.P1.TRANSLUCENT)}getModelViewManager(){return this.viewer.getModelViewManagers().getManager()}getPreviewViewManager(){return this.viewer.getModelViewManagers().getPreviewManager()}hasAffectedInstances(){return this.affectedOccurrenceIds.length>0}addIdsToAffect(e,t){if(this.hasAffectedInstances()||t){let t=!1;for(let i=0;i<e.length;i++)this.affectedOccurrenceIds.indexOf(e[i])<0&&(this.affectedOccurrenceIds.push(e[i]),t=!0);t&&this.updateOccurrenceManagerAndPreviewBoundingBoxes()}}removeFromEffect(e){if(this.hasAffectedInstances()){let t=!1;for(let i=0;i<e.length;i++){const s=this.affectedOccurrenceIds.indexOf(e[i]);s>-1&&(this.affectedOccurrenceIds.splice(s,1),t=!0)}t&&this.updateOccurrenceManagerAndPreviewBoundingBoxes()}}makeTransparent(e,t){const i=t?function(){const e=(0,Ih.uQ)();e.setSuppressMouseMovePick(!1),e.getInputHandler().isMouseInCanvas()&&e.doPreHighlightPick()}:()=>{};e&&this.currentRenderModeSupportsAnimation()?this.viewer.animateIsolation(!0):(je(1),this.viewer.requestDraw((()=>{this.viewer.getAnimationController().incrementAnimationSequence(),i()})))}getSelectionFromNodeModelOrSelection(e){return UM.getSelectionFromNodeModelOrSelection(e,this.viewer)}setAffectedOccurrenceIds(e){this.affectedOccurrenceIds=e,this.updateOccurrenceManagerAndPreviewBoundingBoxes()}isInEffectMode(){return!!this.dialog||this.isolatedOccurrencesManager.getIsInitializingIsolateDialog()}isWithinDistanceOfAnInitialAffectedOccurrence(e,t){const i=this.getModelViewManager().getOccurrenceBounds(t);return!!i&&this.isBoundsWithinDistanceOfInitialAffectedInstances(i,e)}isBoundsWithinDistanceOfInitialAffectedInstances(e,t){const i=e.center();return this.isPointWithinDistanceOfInitialAffectedInstances(i,t)}isPointWithinDistanceOfInitialAffectedInstances(e,t){for(const i of this.centersOfInitialAffectedInstances){if(pe.S4.distanceSquared(i,e)<t)return!0}return!1}getMinDistanceSquaredFromInitialAffectedInstanceToCenterOfModel(){let e=1/0;const t=this.getModelBoundsForEffect();if(t){const i=t.center();this.updateCentersOfInitialAffectedInstances();const s=this.centersOfInitialAffectedInstances.map((function(e){return pe.S4.distanceSquared(e,i)}));e=Math.min(...s)}return e}getModelBoundsForEffect(){return this.viewer.getModelBounds()}expandEffectByConnectivity(e){}getAffectedOccurrences(){return[]}initialAffectedOccurrencesHaveConnectedOccurrences(){return!1}affectOccurrences(e,t,i){}updateOccurrenceManagerAndPreviewBoundingBoxes(){this.updateOccurrenceDataManager(),this.updatePreviewBoundingBoxes(),this.viewer.onIsolateChanged()}updatePreviewBoundingBoxes(){this.viewer.getBodyManager().refreshReducedDetailBoxes()}clearAffectedOccurrenceIdsNoGraphicsUpdate(){this.affectedOccurrenceIds=[]}}var vM=i(58234),PM=i(35717);const yM=function(e){return e.getPathAsString()};function AM(e,t,i,s){const n={};function r(e){const t=e.trimToTopLevel();return n[t.getPathAsString()]=t,!1}Array.isArray(e)?e.forEach(r):e&&e.each(r);for(const e in n){const r=n[e],a=t.getOccurrencesStartingWithPath(r);for(let e=0;e<a.length;++e){const t=a[e].getPathAsString();i.hasOwnProperty(t)||(i[t]=a[e],s.set(t,a[e]))}}}class OM extends DM{constructor(e,t){super(e,t),this.initialAffectedOccurrences=[],this.affectedOccurrences=[],this.setSeedComponentsNull()}setUpListeners(){this.stopListening(),this.listenTo(this.viewer.getEventDispatcher(),VM.hj,this.onAssemblyDataProcessed)}setSeedComponentsNull(){this.nodeModelOrSelection=null,this.includeSelections=!1,this.initialSelectionList=null}onAssemblyDataProcessed(){this.hasAffectedInstances()&&(0,ft._R)()&&(this.updateNodeModelOrSelection(),this.reAffectComponents(xM.ASSEMBLY_DATA_UPDATE,!1))}setIsolationForRelatedGraphics(e,t){const i=this.getModelViewManager().getDisplayedAssembly();if(i)for(const s of e){const e=i.getMateConnectorGraphicsForOccurrence(s,false);for(let i=0;i<e.length;i++)e[i].getOccurrenceData().setIsolated(t);const n=i.getMateIndicatorsForOccurrence(s,false);for(let e=0;e<n.length;e++)n[e].setIsolated(t);const r=i.getSketchImagesForOccurrence(s);for(let e=0;e<r.length;++e)r[e].setIsolated(t)}}affectComponents(e,t,i,s,n){this.viewer===s&&(this.includeSelections=t,i&&0!==i.length?this.reaffectSelections(i,xM.INITIAL,n):(this.nodeModelOrSelection=e,this.reAffectComponents(xM.INITIAL,n)))}reaffectSelections(e,t,i){let s=[];e.forEach((e=>{s=s.concat(e.getOccurrencesFromSelection())})),s=(0,Q.unionWithoutDuplicateValues)(s,yM);const n=!this.getIsOperationInProgress()&&t!==xM.ASSEMBLY_DATA_UPDATE&&!gi._3.getOpenDocumentController().getActiveElementController().getViewAlignmentController().isSectionViewDialogVisible();n&&(0,ve.MO)(),this.shouldAddPreexistingOccurrences()&&s.length>0&&(s=(0,Q.unionWithoutDuplicateValues)([...s,...this.initialAffectedOccurrences],yM)),this.affectOccurrences(s,t,i),n&&(0,ve.IQ)()}reAffectComponents(e,t){var i;if(this.nodeModelOrSelection||this.includeSelections){const s=this.getSelectionFromNodeModelOrSelection(this.nodeModelOrSelection),n=[];if(s&&n.push(s),this.includeSelections){e!==xM.ASSEMBLY_DATA_UPDATE&&(this.initialSelectionList=(0,X.Z)((0,ve.vi)())),null===(i=this.initialSelectionList)||void 0===i||i.forEach((e=>{n.push(e)}))}this.reaffectSelections(n,e,t)}}affectOccurrences(e,t,i){if(0===e.length)return(0,fr.m)().trigger(mr.C.EXIT_ISOLATE,this.viewer),void(0,fr.m)().trigger(mr.C.EXIT_MAKE_TRANSPARENT,this.viewer);const s=t!==xM.EXPAND;let n=!0;this.hasAffectedInstances()&&(n=!1),this.shouldClearOccurrenceIds()&&this.setAffectedOccurrenceIds([]),this.resetIsolationForRelatedGraphics(e),s?this.setInitialAffectedOccurrences(e):this.setAffectedOccurrences(e),this.makeTransparent(n,i),s&&this.showDialog()}areSelectionsAlreadyAffected(e){const t=this.getSelectionFromNodeModelOrSelection(e),i=[];return(0,ve.vi)().forEach((e=>{i.push(e)})),t&&i.push(t),this.areSelectionsInListAlreadyAffected(i)}areSelectionsInListAlreadyAffected(e){if((0,ft._R)()){let t=[];e.forEach((e=>{t=t.concat(e.getOccurrencesFromSelection())}));const i=(0,Q.unionWithoutDuplicateValues)(t,yM);return(0,Q.hasEquivalentValues)(i,this.initialAffectedOccurrences,(e=>e.toString()))}return!1}setInitialAffectedOccurrences(e){this.initialAffectedOccurrences=e,this.centersOfInitialAffectedInstances=null,this.setAffectedOccurrences(e)}setAffectedOccurrences(e){this.affectedOccurrences=e,this.setAffectedOccurrenceIdsFromOccurrences(e)}setAffectedOccurrenceIdsFromOccurrences(e){const t=0===e.length?[]:e.map((e=>this.viewer.getIdForOccurrence(e)));this.setAffectedOccurrenceIds(t)}expandEffectByProximity(e){const t=this.getAffectedOccurrencesForExpandEffectByProximity(e);t&&this.affectOccurrences(t,xM.EXPAND,!1)}updateCentersOfInitialAffectedInstances(){if(!this.centersOfInitialAffectedInstances){const e=this.getModelViewManager(),t=function(t){const i=e.getOccurrenceBounds(t);return i?i.center():null},i=this.initialAffectedOccurrences.map(t,this);this.centersOfInitialAffectedInstances=i.filter(Q.isDefined,this)}}expandEffectByConnectivity(e){const t=this.getAffectedOccurrencesForExpandEffectByConnectivity(e);this.affectOccurrences(t,xM.EXPAND,!1)}getAffectedOccurrencesForExpandEffectByConnectivity(e){if(-1===e)return this.initialAffectedOccurrences;{const t=this.getModelViewManager(),i={};let s=new Map;if(AM(this.initialAffectedOccurrences,t,i,s),s.size===this.initialAffectedOccurrences.length&&(e+=1),e>=1){const n=t.getDisplayedAssembly();if(n)for(let r=1;r<=e;r++){const e=n.getMateIndicatorConnectivityMap(s),r=s;s=new Map;for(const[n,a]of r){AM(e.get(a.getPathAsString()),t,i,s)}}}return Object.values(i)}}initialAffectedOccurrencesHaveConnectedOccurrences(){return this.getAffectedOccurrencesForExpandEffectByConnectivity(0).length>this.initialAffectedOccurrences.length}getAffectedOccurrencesForExpandEffectByProximity(e){if(0===e)return this.initialAffectedOccurrences;const t=this.getModelViewManager().getDisplayedAssembly();if(t){const i=Object.values(t.occurrences).map((function(e){return e.occurrenceData.occurrence}));this.updateCentersOfInitialAffectedInstances();const s=e*e,n=i.filter((e=>this.isWithinDistanceOfAnInitialAffectedOccurrence(s,e)));return(0,Q.unionWithoutDuplicateValues)([...n,...this.initialAffectedOccurrences],yM)}return null}getIsOperationInProgress(){const e=ft.T.getOpenDocumentActiveElement();return gi._3.hasActiveFeatureController()||e&&e.get("isOperationInProgress")}getAffectedOccurrences(){return this.affectedOccurrences}updateNodeModelOrSelection(){if(this.nodeModelOrSelection&&this.nodeModelOrSelection instanceof vM.I){const e=PM.AssemblyTreeMap.getTreeItem(this.nodeModelOrSelection.getFeatureId());if(!e)return;if(!e.children||!this.nodeModelOrSelection.children)return;e.children.length<this.nodeModelOrSelection.children.length&&(this.initialAffectedOccurrences=[]),this.nodeModelOrSelection=e}}}class RM extends OM{setUpListeners(){super.setUpListeners(),this.listenTo((0,fr.m)(),mr.C.EXIT_ISOLATE,this.clearEffectExit),this.listenTo((0,fr.m)(),mr.C.ISOLATE_COMPONENTS,this.affectComponents)}clearIsolateNoAnimation(){this.clearEffectNoAnimation()}hasIsolatedInstances(){return this.hasAffectedInstances()}areSelectionsAlreadyIsolated(e){return this.areSelectionsAlreadyAffected(e)}areSelectionsInListAlreadyIsolated(e){return this.areSelectionsInListAlreadyAffected(e)}isInIsolateMode(){return this.isInEffectMode()}addIdsToIsolate(e,t){this.addIdsToAffect(e,t)}removeFromIsolate(e){this.removeFromEffect(e)}isolateOccurrences(e,t){this.affectOccurrences(e,t)}getIsolatedOccurrences(){return this.getAffectedOccurrences()}setIsolatedOccurrenceIds(e){this.setAffectedOccurrenceIds(e)}clearEffect(){this.setSeedComponentsNull(),this.setIsolationForRelatedGraphics(this.affectedOccurrences,!1),this.setInitialAffectedOccurrences([])}shouldAddPreexistingOccurrences(){return!1}shouldClearOccurrenceIds(){return this.hasAffectedInstances()}resetIsolationForRelatedGraphics(e){this.setIsolationForRelatedGraphics(this.affectedOccurrences,!1),this.setIsolationForRelatedGraphics(e,!0)}showDialog(){this.dialog?this.dialog.onAssemblyOrPartStudioDataProcessed():this.dialog=FM.createIsolateDialog(this)}updateOccurrenceDataManager(){FM.updateOccurrenceDataManager(this.affectedOccurrenceIds,this.viewer.getOccurrenceDataManager())}}var wM=i(89841);class _M extends OM{constructor(e,t,i,s,n,r){super(e,t),this.affectComponents(i,n,s,r)}getTransparentOccurrences(){return this.getAffectedOccurrences()}areSelectionsAlreadyTransparent(e){return this.areSelectionsAlreadyAffected(e)}areSelectionsInListAlreadyTransparent(e){return this.areSelectionsInListAlreadyAffected(e)}hasTransparentInstances(){return this.hasAffectedInstances()}clearTransparentNoAnimation(){this.clearEffectNoAnimation()}setUpListeners(){super.setUpListeners(),this.listenTo((0,fr.m)(),mr.C.MAKE_TRANSPARENT_COMPONENTS,this.affectComponents),this.listenTo((0,fr.m)(),mr.C.EXIT_MAKE_TRANSPARENT,this.clearEffectExit)}showDialog(){if(this.dialog)this.dialog.onAssemblyOrPartStudioDataProcessed();else{const e={isolateManager:this};this.dialog=new wM.o8(e)}}clearEffect(){this.viewer.getOccurrenceDataManager().clearIsolation(),this.isolatedOccurrencesManager.removeMakeTransparentManager()}updateOccurrenceDataManager(){0===this.affectedOccurrenceIds.length?this.viewer.getOccurrenceDataManager().isolateAll():this.affectedOccurrenceIds.forEach((e=>{e!==DI.Qy&&this.viewer.getOccurrenceDataManager().setOccurrenceIsolated(e,!1)}))}shouldAddPreexistingOccurrences(){return!0}shouldClearOccurrenceIds(){return!0}resetIsolationForRelatedGraphics(e){this.setIsolationForRelatedGraphics(this.affectedOccurrences,!0),this.setIsolationForRelatedGraphics(e,!1)}}class NM extends DM{constructor(){super(...arguments),this.initialAffectedPartIds=[],this.initialAffectedSheetMetalIds=new Set,this.affectedPartIds=[]}setUpListeners(){this.stopListening(),this.listenTo(this.viewer.getEventDispatcher(),VM.CD,this.onPartDataProcessed)}onPartDataProcessed(e){const t=e.elementId,i=gi._3.getOpenDocumentController().getDeterministicIdMapper(t);this.initialAffectedPartIds=this.initialAffectedPartIds.map((t=>i.remapDetId(t,e.featureIdToOperationIndices))),this.isInEffectMode()&&(0,ft._B)()&&this.reAffectParts(this.initialAffectedPartIds,xM.PART_STUDIO_UPDATE,!1)}affectParts(e,t,i,s){this.viewer===t&&(s&&this.setIsIsolateFullyTransparentAsDefault(),this.reAffectParts(e.map((e=>e.id)),xM.INITIAL,i))}clearEffectExit(e){const t=this.viewer.getModelViewManagers().getManager().isDisplayingIncontextAssembly();t?(this.clearEffectNoAnimation(),(0,VM.xA)().trigger(VM.bh,t)):(super.clearEffectExit(e),this.updateLaminarEdges())}clearEffectNoAnimation(){super.clearEffectNoAnimation(),this.updateLaminarEdges()}reAffectParts(e,t,i){this.shouldAddPreexistingParts()&&(e=(0,Q.unionWithoutDuplicateValues)([...e,...this.initialAffectedPartIds],(e=>e))),t===xM.INITIAL&&(this.initialAffectedSheetMetalIds=this.getSheetMetalIds(e,this.getModelViewManager()));let s=this.getAssociatedPartIdsFromSheetMetalIds(this.initialAffectedSheetMetalIds,this.getModelViewManager());this.getPreviewViewManager()&&(s=s.concat(this.getAssociatedPartIdsFromSheetMetalIds(this.initialAffectedSheetMetalIds,this.getPreviewViewManager()))),e=(0,Q.unionWithoutDuplicateValues)([...e,...s],(e=>e));const n=this.getIndividualOccurrenceIdsFromPartIds(e);if(0===n.length)return void this.triggerExit();let r=!0;this.shouldNotDoAnimation()&&(r=!1),this.shouldClearOccurrenceIds()&&this.setAffectedOccurrenceIds([]);!(0,ve.yz)()&&t!==xM.PART_STUDIO_UPDATE&&!gi._3.getOpenDocumentController().getActiveElementController().getViewAlignmentController().isSectionViewDialogVisible()&&((0,ve.MO)(),(0,ve.IQ)()),t!==xM.INITIAL&&t!==xM.PART_STUDIO_UPDATE||(this.initialAffectedPartIds=e,this.centersOfInitialAffectedInstances=null),this.affectedPartIds=e,this.refreshMateIsolation(this.affectedPartIds),this.affectPartOccurrenceIds(n,t,r,i)}getSheetMetalIds(e,t){const i=t.getDisplayedPartStudio(),s=new Set;return e.forEach((e=>{const t=i.retrieveBodyMetaData(e);t&&t.sheetMetalModelId&&s.add(t.sheetMetalModelId)})),s}getAssociatedPartIdsFromSheetMetalIds(e,t){const i=t.getDisplayedPartStudio(),s=[];for(const t in i.bodyComponent.bodyMetaData){const n=i.bodyComponent.bodyMetaData[t];n.sheetMetalModelId&&e.has(n.sheetMetalModelId)&&s.push(t)}return s}setIsolatedPartMates(e,t){const i=this.getModelViewManager().getDisplayedPartStudio();if(i){const s=i.getAllMateConnectorGraphics(null).filter((e=>""!==e.definition.partId));this.isolateMateConnectors(s,this.getModelViewManager(),e,t)}const s=this.getPreviewViewManager();if(s){const i=s.getDisplayedPartStudio();if(i){const n=i.getAllMateConnectorGraphics(null).filter((e=>""!==e.definition.partId));this.isolateMateConnectors(n,s,e,t)}}}isolateMateConnectors(e,t,i,s){if(s){const n=this.getIndividualPartIds(s,t),r=t.getDisplayedPartStudio();e.forEach((e=>{let t=e.definition.partId;const s=r.retrieveBodyMetaData(t);s&&s.consumingClosedCompositeData&&(t=s.consumingClosedCompositeData.id),n.has(t)&&e.getOccurrenceData().setIsolated(i)}))}else e.forEach((e=>{e.getOccurrenceData().setIsolated(i)}))}shouldAddSketchesToEffect(){return!0}updateLaminarEdges(){const e=this.viewer.getFilteredEntitiesHighlightController();e&&e.updateSetOfFilteredEntities()}affectPartOccurrenceIds(e,t,i,s){0!==e.length?(this.shouldAddSketchesToEffect()&&e.push(this.getModelViewManager().getDisplayedPartStudio().getSketchComponent().sketchComponentElementId),this.hasAffectedInstances()&&this.setAffectedOccurrenceIds([]),this.addIdsToAffect(e,!0),this.refreshMateIsolation(this.affectedPartIds),this.makeTransparent(i,s),(t===xM.INITIAL||t===xM.PART_STUDIO_UPDATE&&this.isInEffectMode())&&this.showDialog(),this.updateLaminarEdges()):this.triggerExit()}getIndividualOccurrenceIdsFromPartIds(e){const t=[],i=this.getIndividualPartIds(e,this.getModelViewManager()),s=this;return i.forEach((e=>{const i=s.getOccurrenceIdFromPartId(e);i&&t.push(i)})),t}getIndividualPartIds(e,t){const i=t.getDisplayedPartStudio(),s=new Set;return e.forEach((e=>{const t=i.retrieveBodyMetaData(e);t&&(t.isComposite&&!t.isGroupableCompositeBody?t.constituentBodyIds.forEach((e=>{s.add(e)})):s.add(e))})),s}getOccurrenceIdFromPartId(e){const t=this.getModelViewManager().getDisplayedPartStudio().getBodyComponent().getBodyOccurrenceData(e);if(t){const e=t.getOccurrenceId();if(e&&e!==DI.Qy)return e}return null}areSelectionsAlreadyAffected(e){if((0,ft._B)()){const t=NM.getSelectedParts(e,this.viewer);return this.arePartsAlreadyAffected(t)}return!1}areSelectionsInListAlreadyAffected(e){const t=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio().id;if((0,ft._B)()){const i=(0,ve.mZ)(t,e);return this.arePartsAlreadyAffected(i)}return!1}arePartsAlreadyAffected(e){const t=e.map((e=>e.id));return(0,Q.hasEquivalentValues)(t,this.initialAffectedPartIds,(e=>e))}static getSelectedParts(e,t){const i=UM.getSelectionFromNodeModelOrSelection(e,t),s=t.getModelViewManagers().getManager().getDisplayedPartStudio();if(!s)return[];const n=s.getElementId();let r;return i&&(r=Ym.L.getPartModelFromPartId(i.getPartId(),n)),(0,ve.JA)(n,r)}updateCentersOfInitialAffectedInstances(){if(!this.centersOfInitialAffectedInstances){const e=[];this.initialAffectedPartIds.forEach((t=>{const i=this.getModelViewManager().getBodyBounds(t,null);i&&e.push(i.center())})),this.centersOfInitialAffectedInstances=e.filter(Q.isDefined,this)}}expandEffectByProximity(e){let t=this.getAffectedPartIdsForExpandEffectByProximity(e,this.getModelViewManager(),!1),i=this.getIndividualOccurrenceIdsFromPartIds(t);const s=this.getPreviewViewManager();if(s){const n=this.getAffectedPartIdsForExpandEffectByProximity(e,s,!0),r=s.getDisplayedPartStudio().getBodyComponent(),a=[];n.forEach((e=>{const t=r.getBodyOccurrenceData(e);t&&a.push(t.getOccurrenceId())})),t=(0,Q.unionWithoutDuplicateValues)([...t,...n],(e=>e)),i=(0,Q.unionWithoutDuplicateValues)([...i,...a],(e=>e+"")),i=i.concat(this.getAffectedOwnerlessMatesOccurrenceIdsByProximity(e,s))}this.affectedPartIds=t,this.affectPartOccurrenceIds(i,xM.EXPAND,!1,!1)}getAffectedOwnerlessMatesOccurrenceIdsByProximity(e,t){if(Math.abs(e)<=bi.W.ZERO_LENGTH)return[];const i=[],s=t.getDisplayedPartStudio().getAllMateConnectorGraphics(null).filter((e=>""===e.definition.partId)),n=e*e;for(const e of s)this.isPointWithinDistanceOfInitialAffectedInstances(e.worldSpacePosition,n)&&i.push(e.getOccurrenceData().getOccurrenceId());return i}getAffectedPartIdsForExpandEffectByProximity(e,t,i){const s=this.getAssociatedPartIdsFromSheetMetalIds(this.initialAffectedSheetMetalIds,t);if(!i&&Math.abs(e)<=bi.W.ZERO_LENGTH)return(0,Q.unionWithoutDuplicateValues)([...this.initialAffectedPartIds,...s],(e=>e));this.updateCentersOfInitialAffectedInstances();const n=t.getDisplayedPartStudio().getBodyComponent(),r=[],a=e*e;for(const e in n.partStudioBodyIdToOccurrenceId)this.isWithinDistanceOfAnInitialIsolatedPart(a,e,null,t)&&r.push(e);const o=this.getSheetMetalIds(r,t),h=this.getAssociatedPartIdsFromSheetMetalIds(o,t);return(0,Q.unionWithoutDuplicateValues)([...r,...this.initialAffectedPartIds,...h,...s],(e=>e))}isWithinDistanceOfAnInitialIsolatedPart(e,t,i,s){const n=s.getBodyBounds(t,i);return!!n&&this.isBoundsWithinDistanceOfInitialAffectedInstances(n,e)}}class bM extends NM{setUpListeners(){super.setUpListeners(),this.listenTo((0,fr.m)(),mr.C.EXIT_ISOLATE,this.clearEffectExit),this.listenTo((0,fr.m)(),mr.C.ISOLATE_PARTS,this.affectParts)}clearIsolateNoAnimation(){this.clearEffectNoAnimation()}hasIsolatedInstances(){return this.hasAffectedInstances()}areSelectionsAlreadyIsolated(e){return this.areSelectionsAlreadyAffected(e)}areSelectionsInListAlreadyIsolated(e){return this.areSelectionsInListAlreadyAffected(e)}isInIsolateMode(){return this.isInEffectMode()}addIdsToIsolate(e,t){this.addIdsToAffect(e,t)}removeFromIsolate(e){this.removeFromEffect(e)}isolateOccurrences(e,t){this.affectOccurrences(e,t)}getIsolatedOccurrences(){return this.getAffectedOccurrences()}setIsolatedOccurrenceIds(e){this.setAffectedOccurrenceIds(e)}clearEffect(){this.initialAffectedPartIds=[],this.setAffectedOccurrenceIds([]),this.setIsolatedPartMates(!1),this.initialAffectedSheetMetalIds=new Set}triggerExit(){(0,fr.m)().trigger(mr.C.EXIT_ISOLATE,this.viewer)}shouldNotDoAnimation(){return this.hasAffectedInstances()}shouldClearOccurrenceIds(){return this.hasAffectedInstances()}refreshMateIsolation(e){this.setIsolatedPartMates(!1),this.setIsolatedPartMates(!0,e)}shouldAddPreexistingParts(){return!1}shouldAddSketchesToIsolate(){return!0}showDialog(){this.dialog?this.dialog.onAssemblyOrPartStudioDataProcessed():this.dialog=FM.createIsolateDialog(this)}updateOccurrenceDataManager(){FM.updateOccurrenceDataManager(this.affectedOccurrenceIds,this.viewer.getOccurrenceDataManager())}}class LM extends NM{constructor(e,t,i,s){super(e,t),this.affectParts(i,s)}getTransparentOccurrences(){return this.getAffectedOccurrences()}areSelectionsAlreadyTransparent(e){return this.areSelectionsAlreadyAffected(e)}areSelectionsInListAlreadyTransparent(e){return this.areSelectionsInListAlreadyAffected(e)}hasTransparentInstances(){return this.hasAffectedInstances()}clearTransparentNoAnimation(){this.clearEffectNoAnimation()}setUpListeners(){super.setUpListeners(),this.listenTo((0,fr.m)(),mr.C.MAKE_TRANSPARENT_PARTS,this.affectParts),this.listenTo((0,fr.m)(),mr.C.EXIT_MAKE_TRANSPARENT,this.clearEffectExit)}showDialog(){if(this.dialog)this.dialog.onAssemblyOrPartStudioDataProcessed();else{const e={isolateManager:this};this.dialog=new wM.o8(e)}}clearEffect(){this.viewer.getOccurrenceDataManager().clearIsolation(),this.isolatedOccurrencesManager.removeMakeTransparentManager(),this.updateLaminarEdges()}updateOccurrenceDataManager(){if(0===this.affectedOccurrenceIds.length){let e=this.getModelViewManager().getDisplayedPartStudio().getPartStudioOccurrenceIds();this.getPreviewViewManager()&&(e=e.concat(this.getPreviewViewManager().getDisplayedPartStudio().getPartStudioOccurrenceIds())),e.forEach((e=>{e!==DI.Qy&&this.viewer.getOccurrenceDataManager().setOccurrenceIsolated(e,!0)}))}else this.affectedOccurrenceIds.forEach((e=>{e!==DI.Qy&&this.viewer.getOccurrenceDataManager().setOccurrenceIsolated(e,!1)}))}refreshMateIsolation(e){this.setIsolatedPartMates(!0),this.setIsolatedPartMates(!1,e)}triggerExit(){(0,fr.m)().trigger(mr.C.EXIT_MAKE_TRANSPARENT,this.viewer)}shouldAddPreexistingParts(){return!0}shouldAddSketchesToEffect(){return!1}shouldNotDoAnimation(){return this.viewer.getIsolatedOccurrenceManager().hasIsolatedInstances()}shouldClearOccurrenceIds(){return!0}}class FM{static createIsolateDialog(e){const t={isolateManager:e};return new wM.sl(t)}static updateOccurrenceDataManager(e,t){e&&t&&(0===e.length?t.clearIsolation():e.forEach((e=>{e!==DI.Qy&&t.setOccurrenceIsolated(e,!0)})))}}var xM,BM=i(61699);!function(e){e[e.INITIAL=0]="INITIAL",e[e.ASSEMBLY_DATA_UPDATE=1]="ASSEMBLY_DATA_UPDATE",e[e.EXPAND=2]="EXPAND",e[e.PART_STUDIO_UPDATE=3]="PART_STUDIO_UPDATE"}(xM||(xM={}));class UM extends m.T{constructor(e){super(),this.viewer=e,this.contextTransparencyMultiplier=1,this.isInitializingIsolateDialog=!1,(0,ft._B)()?this.currentIsolateManager=new bM(e,this):this.currentIsolateManager=new RM(e,this),this.setUpListeners()}switchActiveElement(e){this.currentIsolateManager.destroy(),this.currentMakeTransparentManager&&(this.currentMakeTransparentManager.destroy(),this.currentMakeTransparentManager=null),this.currentIsolateManager=e?new bM(this.viewer,this):new RM(this.viewer,this)}clearIsolateManagerNoGraphicsUpdate(){this.currentIsolateManager.clearAffectedOccurrenceIdsNoGraphicsUpdate()}removeMakeTransparentManager(){this.currentMakeTransparentManager&&this.currentMakeTransparentManager.destroy(),this.currentMakeTransparentManager=null}getContextTransparencyMultiplier(){return this.contextTransparencyMultiplier}getIsIsolateFullyTransparent(){return this.currentMakeTransparentManager?this.currentMakeTransparentManager.getIsIsolateFullyTransparent():this.currentIsolateManager.getIsIsolateFullyTransparent()}onIsIsolateFullyTransparentChanged(){this.trigger(UM.IS_ISOLATE_FULLY_TRANSPARENT_CHANGED_EVENT)}setContextTransparencyMultiplier(e){this.contextTransparencyMultiplier=e,this.viewer.requestDraw()}onMakeTransparentParts(e,t){if(0!==e.length&&!this.currentMakeTransparentManager){this.currentMakeTransparentManager=new LM(this.viewer,this,e,t);const i=t.getFilteredEntitiesHighlightController();i&&i.updateSetOfFilteredEntities()}}onMakeTransparentComponents(e,t,i,s){this.currentMakeTransparentManager||(this.currentMakeTransparentManager=new _M(this.viewer,this,e,i,t,s))}static partCanBeIsolated(e){return e.bodyType===W.wG2.SOLID||e.bodyType===W.wG2.SHEET||e.bodyType===W.wG2.WIRE||e.isComposite}setUpListeners(){this.listenTo((0,fr.m)(),mr.C.MAKE_TRANSPARENT_COMPONENTS,this.onMakeTransparentComponents),this.listenTo((0,fr.m)(),mr.C.MAKE_TRANSPARENT_PARTS,this.onMakeTransparentParts),this.currentIsolateManager.setUpListeners()}destroy(){this.currentIsolateManager.destroy(),this.currentMakeTransparentManager&&this.currentMakeTransparentManager.destroy()}isIsolateManagerInUse(){return this.isInIsolateMode()||!!(0,ve.Eo)()||gi._3.getOpenDocumentController().isInterferenceDetectionActive()}clearAllIsolateNoAnimation(){this.currentIsolateManager.clearIsolateNoAnimation(),this.currentMakeTransparentManager&&this.currentMakeTransparentManager.clearTransparentNoAnimation()}hasIsolatedInstances(){return this.currentIsolateManager.hasIsolatedInstances()||this.currentMakeTransparentManager&&this.currentMakeTransparentManager.hasTransparentInstances()}areSelectionsAlreadyIsolated(e){return this.currentIsolateManager.areSelectionsAlreadyIsolated(e)}areSelectionsInListAlreadyIsolated(e){return this.currentIsolateManager.areSelectionsInListAlreadyIsolated(e)}isInIsolateMode(){return this.currentIsolateManager.isInIsolateMode()}addIdsToIsolate(e,t){this.currentIsolateManager.addIdsToIsolate(e,t)}removeFromIsolate(e){this.currentIsolateManager.removeFromIsolate(e)}isolateOccurrences(e,t){this.currentIsolateManager.isolateOccurrences(e,t)}getIsolatedOccurrences(){return this.currentMakeTransparentManager?this.currentMakeTransparentManager.getTransparentOccurrences():this.currentIsolateManager.getIsolatedOccurrences()}setIsolatedOccurrenceIds(e){this.currentIsolateManager.setIsolatedOccurrenceIds(e)}isInMakeTransparentMode(){return!!this.currentMakeTransparentManager||this.getIsInitializingIsolateDialog()}areSelectionsInListAlreadyTransparent(e){if(this.currentMakeTransparentManager)return this.currentMakeTransparentManager.areSelectionsInListAlreadyTransparent(e);{let t=!0;return e.forEach((e=>{this.noOccurrencesOrPartsSelected(e)||(t=!1)})),t}}areSelectionsAlreadyTransparent(e){return this.currentMakeTransparentManager?this.currentMakeTransparentManager.areSelectionsAlreadyTransparent(e):this.noOccurrencesOrPartsSelected(e)}setIsInitializingIsolateDialog(e){this.isInitializingIsolateDialog=e}getIsInitializingIsolateDialog(){return this.isInitializingIsolateDialog}isInIsolateOrMakeTransparentMode(){return this.isInIsolateMode()||this.isInMakeTransparentMode()}noOccurrencesOrPartsSelected(e){if((0,ft._B)())return 0===NM.getSelectedParts(e,this.viewer).length;if((0,ft._R)()){if(e){if(0!==UM.getSelectionFromNodeModelOrSelection(e,this.viewer).getOccurrencesFromSelection().length)return!1}let t=!1;return(0,ve.vi)().forEach((e=>{0!==e.getOccurrencesFromSelection().length&&(t=!0)})),!t}return!0}static getSelectionFromNodeModelOrSelection(e,t){return e?e instanceof ve.Y1?e:e instanceof BM.e?e.getSelection():e.getSelection(t):null}}UM.IS_ISOLATE_FULLY_TRANSPARENT_CHANGED_EVENT="IS_ISOLATE_FULLY_TRANSPARENT_CHANGED_EVENT";var VM=i(61090);class GM{constructor(){this.zoomScrollDirection=!1,this.viewManipulationMouseKeyMapping={},this.allowDefaultAxisRotationLock=!1,this.axisRotationLock=!1,this.mouseStringCodeMap={},this.keyStringCodeMap={},this.defaultReverseScrollWheelZoomDirection=!1,this.mouseStringCodeMap.LMB=er.tc.LEFT,this.mouseStringCodeMap.MMB=er.tc.MIDDLE,this.mouseStringCodeMap.RMB=er.tc.RIGHT,this.keyStringCodeMap.CTRL=Os.R8.CONTROL,this.keyStringCodeMap.SHIFT=Os.R8.SHIFT,this.keyStringCodeMap.ALT=Os.R8.ALT,this.allowDefaultAxisRotationLock=ps.Jq.CapabilitiesService.checkAllowDefaultAxisRotationLockCurrentlyEnabled()}setMouseSettings(e){this.zoomScrollDirection=e.reverseScrollWheelZoomDirection,this.viewManipulationMouseKeyMapping=e.viewManipulationMouseKeyMapping,this.axisRotationLock=e.axisRotationLock,this.applyViewManipulationMouseKeyMapping()}getMouseButtons(e){const t=[];return e.forEach((function(e){this.mouseStringCodeMap.hasOwnProperty(e)&&t.push(this.mouseStringCodeMap[e])}),this),t}getKeyCodes(e){const t=[];return e.forEach((function(e){this.keyStringCodeMap.hasOwnProperty(e)&&t.push(this.keyStringCodeMap[e])}),this),t}applyViewManipulationMouseKeyMapping(){if(!this.viewManipulationMouseKeyMapping)return;const e=uE();e.clearMouseKeyManipulationBindings(),Object.keys(this.viewManipulationMouseKeyMapping).forEach((t=>{let i=FD.k.NONE;switch(t){case"pan3DMapping":i=FD.k.PAN;break;case"zoom3DMapping":i=FD.k.ZOOM;break;case"rotate3DMapping":i=!0===this.axisRotationLock&&this.allowDefaultAxisRotationLock?FD.k.AXIS_ROTATE:FD.k.ROTATE;break;case"axisRotate3DMapping":i=!0===this.axisRotationLock&&this.allowDefaultAxisRotationLock?FD.k.ROTATE:FD.k.AXIS_ROTATE;break;default:i=FD.k.NONE}if(i!==FD.k.NONE){const s=this.viewManipulationMouseKeyMapping[t];for(let t=0;t<s.length;++t){const n=s[t],r=this.getMouseButtons(n.mouseButtons),a=this.getKeyCodes(n.keys);(0,Q.isEmptyObjectOrArray)(r)&&(0,Q.isEmptyObjectOrArray)(a)||e.addMouseKeyManipulationModeBinding(r,a,i)}}}))}isScrollZoomDefault(){return this.zoomScrollDirection===this.defaultReverseScrollWheelZoomDirection}}let HM=null;function kM(){return HM||(HM=new GM),HM}i(32659);const WM="WebGL Error: ",zM=200;function XM(e){const t=e.getCamera(),i=e.retrieveVisiblePicks(0,0,t.getViewportWidth(),t.getViewportHeight());tC(e,i)}const qM=new Qi({primitiveType:_i.MX.POINTS,isShowThrough:!0,isDepthTested:!1,isPickable:!1}),ZM=new Qi({primitiveType:_i.MX.LINES,isShowThrough:!0,isDepthTested:!1,isPickable:!1}),YM=new Map;function KM(e){let t=YM.get(e);return t||(t=new Ri(e),YM.set(e,t)),t}let jM=0;function QM(e,t,i,s,n,r){const a=KM(e),o=q.default.getManager(),h=Su(i,"p"+jM++);Uu(s||o.getColor("DEBUG_POINT_DEFAULT_COLOR"),h),Hu(n||o.getNumber("DEBUG_POINT_DEFAULT_SIZE"),h),ku(r||o.getPointFont("DEBUG_POINT_DEFAULT_POINT_FONT"),h),a.updateMeshIncrement(t,yi,h,qM),e.requestDraw()}function $M(e,t,i,s){const n=KM(e),r=q.default.getManager(),a=Lu(i.getMin(),i.getMax());Uu(s||r.getColor("DEBUG_BOUNDINGBOX_DEFAULT_COLOR"),a),n.updateMeshIncrement(t,yi,a,ZM),e.requestDraw()}function JM(e,t,i,s,n){const r=pu(i,s,t,n);KM(e).updateMeshIncrement(t,yi,r,ZM),e.requestDraw()}function eC(e,t,i){const s=q.default.getManager(),n=i.origin.getVec3(),r=100*e.getCamera().getPixelSizeAtWorldPoint(n);JM(e,t+".xAxis",n,v.scaleAndAdd(v.create(),n,i.xAxis.getVec3(),r),s.getColor("DEBUG_X_AXIS_COLOR")),JM(e,t+".yAxis",n,v.scaleAndAdd(v.create(),n,i.yAxis.getVec3(),r),s.getColor("DEBUG_Y_AXIS_COLOR")),JM(e,t+".zAxis",n,v.scaleAndAdd(v.create(),n,i.zAxis.getVec3(),r),s.getColor("DEBUG_Z_AXIS_COLOR"))}function tC(e,t){const i=q.default.getManager(),s=KM(e),n=e.getCamera();s.removeMeshIncrements();const r=function(t,i,s,r,a){const o=n.canvasToWorld([i[0],i[1],.5]);QM(e,t,o,s,r,a)};for(let e=0;e<t.length;++e){const s=t[e];let n=[1,1,1];const a=s.getEntityMetaData();a&&a.isVertex()?n=i.getColor("DEBUG_PICK_VERTEX_COLOR"):a&&a.isEdge()?n=i.getColor("DEBUG_PICK_EDGE_COLOR"):a&&a.isFace()&&(n=i.getColor("DEBUG_PICK_FACE_COLOR"));const o=pe.S4.add(n,[.2,.2,.2],v.create());for(let t=0;t<s.locationSamples.length;++t)r(e+"."+t,s.locationSamples[t],o,i.getNumber("DEBUG_PICK_SAMPLE_SIZE"));r(e+".average",pe.gv.scale(s.locationSum,1/s.locationCount,$.create()),pe.S4.scale(n,.6,v.create()),i.getNumber("DEBUG_PICK_AVERAGE_SIZE"),i.getPointFont("DEBUG_PICK_POINT_AVERAGE_FONT")),r(e+".location",s.location,n,i.getNumber("DEBUG_PICK_SIZE"),i.getPointFont("DEBUG_PICK_POINT_FONT"))}e.requestDraw()}let iC=null,sC=!1;const nC=null;let rC=null;function aC(e){if(iC&&iC.closed&&(iC=null,sC=!1),!iC){iC=window.open("/debugwindows/scenedebug.html");let e=0;const t=setInterval((function(){(null==iC?void 0:iC.document)&&"complete"===iC.document.readyState&&(sC=!0,rC&&(rC(),rC=null)),(sC||e++>zM)&&clearInterval(t)}),200)}const t=(0,ui.f1)(!!e&&e.useSheetMetalViewer),i=t.getSceneGraphs().getMainSceneGraph().makeSceneDebugObject(),s=t.getSceneGraphs().getPreviewSceneGraph().makeSceneDebugObject(),n=t.getSceneGraphs().getHudSceneGraph().makeSceneDebugObject(),r=t.getOccurrenceDataManager().makeSceneDebugObject(),a=location.protocol+"//"+location.hostname+(location.port?":"+location.port:""),o=function(){null==iC||iC.postMessage([r,i,s,n],a)};sC?o():rC=o}let oC=0;function hC(e){var t;oC=0;let i=0,s=0;const n=(e=e||{}).numFrames?e.numFrames:720;let r=null;const a=(0,ui.f1)(!!(null==e?void 0:e.flat));if(!a)return;a.draw(),a.setSuppressMouseMovePick(!0),a.completeTasks(),(null==e?void 0:e.forceLowDetail)&&a.detailManager.forceLowestDetailSettings();let o=0,h=[],c=[];const l=a.getGlContext();let u=[];if(null==e?void 0:e.timeShadersPrograms){const e=l.getProgramFlags().length;c=[],u=[],h=[];for(let t=0;t<e;t++)if(t in l.programNames){const i=new Array(e);for(let s=0;s<e;s++)i[s]=s===t;c.push(i),u.push(t)}let t,i=new Array(e);for(t=0;t<e;t++)i[t]=!1;for(c.push(i),i=new Array(e),t=0;t<e;t++)i[t]=!0;c.push(i),console.dir(c),o=0,l.setProgramFlags(c[0])}const d={performFrameTiming:!1},g=function(){var t;const p=window.performance.now();if(r&&(i+=(p-r)/1e3,++s),r=p,s<n){const e=a.getPrimaryViewController();null==e||e.rotateAbout(.0698131701,[0,1,0],e.camera.focalPoint()),a.setUserIsAdjustingCamera(),a.forceRequestDraw(d)}else if((null==e?void 0:e.timeShadersPrograms)&&o<c.length)h[o]=i/s*1e3,o++,o<c.length&&l.setProgramFlags(c[o]),i=0,s=0,r=null;else{null===(t=a.getEventDispatcher())||void 0===t||t.off(VM.u9,g);const n=(s/i).toFixed(2);i=i.toFixed(2),oC=1e3*i/s;const r="Rendered "+s+" frames in "+i+" seconds at "+n+" fps "+oC.toFixed(2)+" ms frametime";if(ps.Jq.MessageBubbleService.showMessage(r),It.log.debug(r),a.setSuppressMouseMovePick(!1),null==e?void 0:e.timeShadersPrograms){for(let e=0;e<h.length-2;e++)u[e]in l.programNames&&It.log.debug("program "+e+" "+l.programNames[u[e]]+" "+h[e]+" ms");It.log.debug("no programs  "+h[h.length-2]+" ms"),It.log.debug("all programs "+h[h.length-1]+" ms")}(null==e?void 0:e.browserProfile)&&console.profile&&console.profileEnd()}};null===(t=a.getEventDispatcher())||void 0===t||t.on(VM.u9,g),(null==e?void 0:e.browserProfile)&&console.profile&&console.profile(e.browserProfileName||"timeRendering"),g()}function cC(){const e=(0,Xa.getActiveViewer)();return e?(e.completeTasks(),e.getMemoryGauge().getUsageDetails()):null}function lC(e){const t=e.getError();if(t!==e.NO_ERROR){let i="Unknown: 0x"+t.toString(16);switch(t){case e.INVALID_ENUM:i="GL_INVALID_ENUM";break;case e.INVALID_VALUE:i="GL_INVALID_VALUE";break;case e.INVALID_OPERATION:i="GL_INVALID_OPERATION";break;case e.INVALID_FRAMEBUFFER_OPERATION:i="GL_INVALID_FRAMEBUFFER_OPERATION";break;case e.OUT_OF_MEMORY:i="GL_OUT_OF_MEMORY"}return It.log.warn("GL error: "+i),!0}return!1}class uC{constructor(){this.meshIncrements=[],this.silhouetteIncrements=[],this.entityData=[],this.incrementDetails=[]}removeCrossReferences(){for(const e of this.entityData)e.setMeshIncrement(null),e.setBodyMetaData(null);for(const e of this.incrementDetails)e.increment=null}}function dC(){const e=new uC;(0,Xa.getActiveViewer)().getModelViewManagers().getManager().collectComponentsForHeapDump(e),e.removeCrossReferences(),window.trackedGraphicsComponents=e;let t=0;for(let i=0;i<e.meshIncrements.length;++i)t+=e.meshIncrements[i].getTriangleCount();It.log.info("Graphics triangle count: "+t+"\nGraphics body entity count: "+e.entityData.length)}var gC=i(86956);function pC(e){const t={angleInstancedArrays:"ANGLE_instanced_arrays",extTextureFilterAnisotropic:"EXT_texture_filter_anisotropic",oesElementIndexUint:"OES_element_index_uint",oesStandardDerivatives:"OES_standard_derivatives",oesTextureFloat:"OES_texture_float",oesTextureFloatLinear:"OES_texture_float_linear",oesTextureHalfFloat:"OES_texture_half_float",oesTextureHalfFloatLinear:"OES_texture_half_float_linear",oesVertexArrayObject:"OES_vertex_array_object",compressedTextureS3tc:"WEBGL_compressed_texture_s3tc",depthTexture:"WEBGL_depth_texture",drawBuffers:"WEBGL_draw_buffers"};let i,s={};if(e){const n=Qt(e);for(i in s=n?{vendor:n.glVendor,renderer:n.glRenderer}:{vendor:"unavailable",renderer:"unavailable"},t){const n=t[i];s[i]=!!e.getExtension(n)}}else for(i in It.log.warn("No gl context was available when attempting to get renderer information"),s={vendor:"unsupported",renderer:"unsupported"},t)s[i]=!1;s.has3dMouse=Wa(),s.screenWidth=window.screen.width,s.screenHeight=window.screen.height;const n=document.createElement("canvas");s.supportsWebGL2=!!n.getContext("webgl2"),n.remove(),s.devicePixelRatio=window.devicePixelRatio?window.devicePixelRatio:-1,(async()=>{if(navigator.gpu?s.supportsWebGPU=!!await navigator.gpu.requestAdapter():s.supportsWebGPU=!1,window.localStorage)try{window.localStorage.setItem("webClientCapabilities",JSON.stringify(s))}catch(e){It.log.warn("Error writing client capabilities to local storage: "+e)}})()}const mC=new Qi({isPickable:!1,isShowThrough:!0,isDepthTested:!1,primitiveType:_i.MX.LINES}),fC=new Qi({isPickable:!1,isShowThrough:!0,isDepthTested:!1,primitiveType:_i.MX.POINTS}),IC=new Qi({primitiveType:_i.MX.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!1,isShowThrough:!1,isDepthTested:!0}),EC=new Qi({primitiveType:_i.MX.LINES,isPickable:!1,isHighlightable:!1,isShowThrough:!0,isTwoSided:!0,isDepthTested:!1,isStencilTested:!0}),SC=q.default.CONSTANT_DEFAULTS,TC=q.default.getManager(),MC=TC.getStipple("CURVATURE_UV_TOOTH_STIPPLE"),CC=TC.getNumber("CURVATURE_TOOTH_LINE_WIDTH"),DC=TC.getNumber("CURVATURE_ROOF_LINE_WIDTH"),vC=TC.getStipple("CURVATURE_UV_ROOF_STIPPLE"),PC="distanceedge";class yC extends Ri{constructor(e,t,i){super(i),this.startPoint=e,this.endPoint=t,this.drawDeltaP=!1,this.drawStartPointP=!1,this.drawEndPointP=!1,this.drawDistanceP=!1,this.deltaPoint=pe.S4.subtract(t,e,v.create()),this.distance=pe.S4.length(this.deltaPoint),this.distanceColor=TC.getColor("PROJECT_MEASUREMENT_DISTANCE_COLOR"),this.componentColors=[TC.getColor("X_AXIS_COLOR"),TC.getColor("Y_AXIS_COLOR"),TC.getColor("Z_AXIS_COLOR")],this.measurementStipple=TC.getStipple("PROJECT_MEASUREMENT_STIPPLE"),this.pointSize=SC.PROJECT_MEASUREMENT_POINT_SIZE,this.lineWidth=SC.PROJECT_MEASUREMENT_DISTANCE_LINE_WIDTH}onViewWillDraw(e,t){this.updateGraphics()}onAppearanceConstantsUpdated(){this.distanceColor=TC.getColor("PROJECT_MEASUREMENT_DISTANCE_COLOR"),this.componentColors=[TC.getColor("X_AXIS_COLOR"),TC.getColor("Y_AXIS_COLOR"),TC.getColor("Z_AXIS_COLOR")]}updateGraphics(){if(this.drawDistanceP||this.drawDeltaP){const e=[this.deltaPoint[0],0,0],t=[0,this.deltaPoint[1],0],i=pe.S4.add(this.startPoint,e,v.create()),s=pe.S4.add(i,t,v.create()),n=this.endPoint;if(this.drawDeltaP){const e=pu(this.startPoint,i);Uu(this.componentColors[0],e),Hu(this.lineWidth,e),ku(this.measurementStipple,e),this.updateMeshIncrement("xedge",yi,e,mC);const t=pu(i,s);Uu(this.componentColors[1],t),Hu(this.lineWidth,t),ku(this.measurementStipple,t),this.updateMeshIncrement("yedge",yi,t,mC);const r=pu(s,n);Uu(this.componentColors[2],r),Hu(this.lineWidth,r),ku(this.measurementStipple,r),this.updateMeshIncrement("zedge",yi,r,mC)}if(this.drawDistanceP){const e=pu(this.startPoint,this.endPoint);Uu(this.distanceColor,e),Hu(this.lineWidth,e),ku(this.measurementStipple,e),this.updateMeshIncrement(PC,yi,e,mC)}}else if(this.drawStartPointP&&this.startPoint){const e=Su(this.startPoint,"startPoint",this.distanceColor,this.pointSize);this.updateMeshIncrement("point0",yi,e,fC)}else if(this.drawEndPointP&&this.endPoint){const e=Su(this.endPoint,"endPoint",this.distanceColor,this.pointSize);this.updateMeshIncrement("point1",yi,e,fC)}}setPermanentlyHighlightDistance(e){this.permanentlyHighlightDistance=e}drawNothing(){this.removeMeshIncrements(),this.drawDeltaP=!1,this.drawStartPointP=!1,this.drawEndPointP=!1,this.permanentlyHighlightDistance?this.drawDistanceP=!0:this.drawDistanceP=!1,this.viewer.requestDraw()}drawDelta(){this.removeMeshIncrements(),this.drawDeltaP=!0,this.drawStartPointP=!1,this.drawEndPointP=!1,this.permanentlyHighlightDistance?this.drawDistanceP=!0:this.drawDistanceP=!1,this.viewer.requestDraw()}drawStartPoint(){this.removeMeshIncrements(),this.drawDeltaP=!1,this.drawStartPointP=!0,this.drawEndPointP=!1,this.permanentlyHighlightDistance?this.drawDistanceP=!0:this.drawDistanceP=!1,this.viewer.requestDraw()}drawEndPoint(){this.removeMeshIncrements(),this.drawDeltaP=!1,this.drawStartPointP=!1,this.drawEndPointP=!0,this.permanentlyHighlightDistance?this.drawDistanceP=!0:this.drawDistanceP=!1,this.viewer.requestDraw()}drawDistance(){this.removeMeshIncrements(),this.drawDeltaP=!1,this.drawStartPointP=!1,this.drawEndPointP=!1,this.drawDistanceP=!0,this.viewer.requestDraw()}drawAngle(){}drawComb(){}callMethod(e){switch(e){case"drawAngle":this.drawAngle();break;case"drawComb":this.drawComb();break;case"drawDistance":this.drawDistance();break;case"drawDelta":this.drawDelta();break;case"drawStartPoint":this.drawStartPoint();break;case"drawEndPoint":this.drawEndPoint();break;default:this.drawNothing()}}getValue(){return this.distance}getDeltaPoint(){return this.deltaPoint}getStartPoint(){return this.startPoint}getEndPoint(){return this.endPoint}}class AC extends yC{constructor(e,t,i,s,n,r,a){super(e,t,a),this.startVector=i,this.endVector=s,this.angle=r,this.isInvalid=!1,this.drawAngleP=!1,this.startLength=pe.S4.length(i),this.startDir=pe.S4.normalize(i,v.create()),this.endLength=pe.S4.length(s),this.endDir=pe.S4.normalize(s,v.create()),this.normalDir=n,this.angleColor=TC.getColor("PROJECT_MEASUREMENT_ANGLE_COLOR"),this.angleLineWidth=SC.PROJECT_MEASUREMENT_ANGLE_LINE_WIDTH,this.measurementStipple=TC.getStipple("PROJECT_MEASUREMENT_STIPPLE")}onAppearanceConstantsUpdated(){this.angleColor=TC.getColor("PROJECT_MEASUREMENT_ANGLE_COLOR"),super.onAppearanceConstantsUpdated()}getValue(){return this.angle}updateGraphics(){if(this.drawAngleP){const e=50,t=pu(this.getStartPoint(),this.getEndPoint());Uu(this.distanceColor,t),Hu(this.lineWidth,t),ku(this.measurementStipple,t),this.updateMeshIncrement(PC,yi,t,mC);const i=pe.S4.add(this.getStartPoint(),this.startVector,v.create()),s=pe.S4.add(this.getStartPoint(),this.endVector,v.create()),n=pe.S4.add(this.getEndPoint(),this.startVector,v.create()),r=pe.S4.add(this.getEndPoint(),this.endVector,v.create()),a=pu(this.getStartPoint(),i);Uu(this.angleColor,a),Hu(this.angleLineWidth,a),this.updateMeshIncrement("edge00",yi,a,mC);const o=pu(this.getStartPoint(),s);Uu(this.angleColor,o),Hu(this.angleLineWidth,o),ku(TC.getStipple("PROJECT_MEASUREMENT_STIPPLE"),o),this.updateMeshIncrement("edge01",yi,o,mC);const h=(this.startLength+this.endLength)/4,c=Du(this.getStartPoint(),h,this.normalDir,this.startDir,0,this.angle,e);Uu(this.angleColor,c),Hu(this.angleLineWidth,c),this.updateMeshIncrement("arc0",yi,c,mC);const l=pu(this.getEndPoint(),n);Uu(this.angleColor,l),Hu(this.angleLineWidth,l),ku(TC.getStipple("PROJECT_MEASUREMENT_STIPPLE"),l),this.updateMeshIncrement("edge10",yi,l,mC);const u=pu(this.getEndPoint(),r);Uu(this.angleColor,u),Hu(this.angleLineWidth,u),this.updateMeshIncrement("edge11",yi,u,mC);const d=Du(this.getEndPoint(),h,this.normalDir,this.startDir,0,this.angle,e);Uu(this.angleColor,d),Hu(this.angleLineWidth,d),this.updateMeshIncrement("arc1",yi,d,mC)}}drawNothing(){this.removeMeshIncrements(),this.drawAngleP=!1,(0,Js.vm)()}drawAngle(){this.removeMeshIncrements(),this.drawAngleP=!0,(0,Js.vm)()}drawDistance(){}drawDelta(){}drawStartPoint(){}drawEndPoint(){}}class OC extends yC{constructor(e,t,i,s,n,r){super(e[0],e[0],r),this.isInvalid=!1,this.drawCombP=!1,this.combIndex=0,this.oversampling=1,this.points=e,this.normals=t,this.lengths=i,this.combIndex=s,this.oversampling=n}getValue(){return 0}updateGraphics(){if(this.drawCombP){const e=this.points.length,t=[],i=[],s=[];for(let s=0;s<e;s++){const e=v.create();pe.S4.linComb(this.points[s],1,this.normals[s],this.lengths[s],e),i.push(e),s%this.oversampling||t.push(this.points[s],e)}for(let t=1;t<e;t++)s.push(i[t-1]),s.push(i[t]);const n=Iu(t,"comb",TC.getColor(this.combIndex?"PROJECT_MEASUREMENT_CURVATURE_COLOR_2":"PROJECT_MEASUREMENT_CURVATURE_COLOR_1"),CC);this.updateMeshIncrement("combIncrement",yi,n,IC);const r=Iu(t,"stippledComb",TC.getColor(this.combIndex?"PROJECT_MEASUREMENT_CURVATURE_COLOR_2":"PROJECT_MEASUREMENT_CURVATURE_COLOR_1"),CC,MC);this.updateMeshIncrement("stippledCombIncrement",yi,r,EC);const a=Iu(s,"spine",TC.getColor(this.combIndex?"PROJECT_MEASUREMENT_CURVATURE_COLOR_2":"PROJECT_MEASUREMENT_CURVATURE_COLOR_1"),DC);this.updateMeshIncrement("spineCombIncrement",yi,a,IC);const o=Iu(s,"stippledSpine",TC.getColor(this.combIndex?"PROJECT_MEASUREMENT_CURVATURE_COLOR_2":"PROJECT_MEASUREMENT_CURVATURE_COLOR_1"),DC,vC);this.updateMeshIncrement("stippledSpineIncrement",yi,o,EC)}}drawNothing(){this.removeMeshIncrements(),this.drawCombP=!1,(0,Js.vm)()}drawComb(){this.removeMeshIncrements(),this.drawCombP=!0,(0,Js.vm)()}drawDistance(){}drawDelta(){}drawStartPoint(){}drawEndPoint(){}}const RC="sketch-constraints",wC="mates",_C="DIMENSION_ATLAS";class NC{constructor(){this.creationPromises=new Map}getAtlas(e,t){let i=this.creationPromises.get(e);return i||(i=t(),this.creationPromises.set(e,i)),i}clearAtlas(e){this.creationPromises.delete(e)}}const bC=q.default.getManager(),LC=new Qi({isPickable:!0,isTwoSided:!0,isStencilWritten:!1,primitivesHaveTransparency:!0,primitiveType:_i.MX.LINES,material:Wi,includedInBlend:!0}),FC=new Qi({isPickable:!0,isTwoSided:!0,isTintedByCompare:!0,primitiveType:_i.MX.LINES,includedInBlend:!0}),xC=v.create(),BC=v.create(),UC=v.create();var VC;!function(e){e.TOP_LEFT="TOP_LEFT",e.TOP_RIGHT="TOP_RIGHT",e.BOTTOM_LEFT="BOTTOM_LEFT",e.BOTTOM_RIGHT="BOTTOM_RIGHT"}(VC||(VC={}));const GC=new Qi({isPickable:!0,primitiveType:_i.MX.TRIANGLES,primitivesHaveTransparency:!0,material:Wi,isTwoSided:!0,includedInBlend:!0,isTintedByCompare:!0,zOffset:q.default.getManager().getNumber("CPLANE_Z_OFFSET")});function HC(e){const t=e.getProperties().id;return t===GC.id||t===FC.id||t===LC.id}const kC="quadFace",WC="outline";class zC extends Ri{constructor(e,t,i,s,n){super(n,i),this.textColorName=e,this.entityId=t,this.planeId=s,this.name="",this.center=v.create(),this.centerOffset=v.create(),this.xAxis=v.fromValues(1,0,0),this.yAxis=v.fromValues(0,1,0),this.lastSetAppearance=void 0,this.node=null,this.width=0,this.height=0,this.initialWidth=0,this.initialHeight=0,this.increments={},this.lastTextScale=-1,this.textTexture=null,this.resizeManipulators={},this.usage=i===sh.Vv?Ls.L.PREVIEW:Ls.L.BASE,this.textMaterial=Xi(),this.textNodeProperties=new Qi({isPickable:!1,isTwoSided:!0,primitiveType:_i.MX.TRIANGLES,material:this.textMaterial,includedInBlend:!0}),this.occurrenceData.setCanIsolateChange(!0),this.occurrenceData.setIsolated(!1)}getDebugId(){return"ConstructionPlaneDisplay"}onDevicePixelRatioChanged(e){this.destroyText()}remove(){this.destroyText(),this.textMaterial&&(this.textMaterial.destroy(),this.textMaterial=null),this.removeResizeManipulators(),super.remove()}destroyText(){this.textTexture&&(this.textTexture.destroy(),this.textTexture=null)}setName(e){e=(0,Pn.truncate)(e,32),this.name!==e&&(this.destroyText(),(0,Js.vm)()),this.name=e}updateAppearance(e){if(e&&e instanceof W.yVM){if(this.lastSetAppearance&&this.lastSetAppearance.equals(e))return;this.lastSetAppearance=e.clone(),this.width=e.width,this.height=e.height}else{if(null===this.lastSetAppearance)return;this.lastSetAppearance=null,this.width=this.initialWidth,this.height=this.initialHeight,this.centerOffset=[0,0,0]}this.updateDefinition(this.name,this.center,this.xAxis,this.yAxis,!0,!0),(0,Js.vm)()}updateDefinition(e,t,i,s,n,r){if(this.name===e&&v.equals(t,this.center)&&v.equals(i,this.xAxis)&&v.equals(s,this.yAxis)||(this.destroyText(),(0,Js.vm)()),r&&(0!==this.initialWidth||0!==this.initialHeight||v.equals(i,this.xAxis)||v.equals(s,this.yAxis))||(this.initialWidth=2*pe.S4.length(i),this.initialHeight=2*pe.S4.length(s)),this.width>0&&this.height>0&&(i=pe.S4.scale(pe.S4.normalize(i,v.create()),this.width/2,v.create()),s=pe.S4.scale(pe.S4.normalize(s,v.create()),this.height/2,v.create())),this.setName(e),this.center=t,this.xAxis=i,this.yAxis=s,Zs()?n&&this.updateResizeManipulators(!1):this.removeResizeManipulators(),this.lastSetAppearance&&(!n||r)){const e=pe.S4.normalize(pe.S4.cross(this.xAxis,this.yAxis,v.create()),v.create());this.centerOffset=pe.S4.subtract((0,Li.qm)([this.lastSetAppearance.xOffset,this.lastSetAppearance.yOffset],this.center,e,pe.S4.normalize(this.xAxis,v.create())),this.center,v.create())}this.updatePlaneGraphics(),this.isHidden&&this.hideIncrements()}updateResizeManipulators(e){const t=this,i=function(i,s,n){const r=pe.S4.add(t.center,t.centerOffset,v.create()),a=pe.S4.normalize(pe.S4.cross(t.xAxis,t.yAxis,v.create())),o=pe.S4.scale(t.xAxis,s,v.create()),h=pe.S4.scale(t.yAxis,n,v.create()),c=pe.S4.add(pe.S4.add(r,o,v.create()),h,v.create());t.resizeManipulators[i]?t.resizeManipulators[i].updateDefinition(c,a,o,h):e&&(t.resizeManipulators[i]=new QC(i,c,a,t,o,h,t.viewer))};i(VC.TOP_LEFT,-1,1),i(VC.TOP_RIGHT,1,1),i(VC.BOTTOM_LEFT,-1,-1),i(VC.BOTTOM_RIGHT,1,-1)}removeResizeManipulators(){for(const e in this.resizeManipulators){const t=this.resizeManipulators[e];t&&(t.cleanup(),t.remove()),this.resizeManipulators[e]=null}}updateText(e){const t=this.getTextTexture(),i=pe.S4.add(this.center,this.centerOffset,v.create()),s=pe.S4.add(i,pe.S4.scale(this.xAxis,-1,v.create()),v.create());pe.S4.add(s,this.yAxis);const n=e.getPixelSizeAtWorldPoint(this.transformPoint(s));let r=n*t.filledWidthPx,a=n*t.filledHeightPx,o=Math.min(pe.S4.length(this.xAxis)/r,pe.S4.length(this.yAxis)/a);if(o<0&&(o=0),o<1&&(r*=o,a*=o),Math.abs(this.lastTextScale-o)<=bi.W.ZERO_LENGTH)return;this.lastTextScale=o;const h=pe.S4.normalize(this.xAxis,v.create()),c=pe.S4.normalize(this.yAxis,v.create()),l=pe.S4.add(s,pe.S4.scale(c,-a,v.create()),v.create()),u=pe.S4.add(l,pe.S4.scale(h,r,v.create()),v.create()),d=pe.S4.add(l,pe.S4.scale(c,a,v.create()),v.create());this.updateMeshIncrement("quad",yi,Ou(l,u,d,void 0,[t.leftCoordinate,t.bottomCoordinate],[t.rightCoordinate,t.topCoordinate]),this.textNodeProperties),this.textMaterial.ambientTexture=t}updatePlaneGraphics(){const e=pe.S4.add(this.center,this.centerOffset,v.create()),t=q.default.getManager(),i=t.getColor("CONSTRUCTION_PLANE_OUTLINE_COLOR"),s=t.getNumber("CONSTRUCTION_PLANE_OUTLINE_WIDTH"),n=Ru(e,this.xAxis,this.yAxis,i,s),r=Ys()?FC:LC;this.updateMeshIncrement(WC,WC,n,r),this.increments[WC]=n;const a=pe.S4.add(pe.S4.add(e,pe.S4.scale(this.xAxis,-1,v.create()),v.create()),this.yAxis,v.create()),o=Ou(pe.S4.add(pe.S4.add(e,pe.S4.scale(this.xAxis,-1,v.create()),v.create()),pe.S4.scale(this.yAxis,-1,v.create()),v.create()),pe.S4.add(pe.S4.add(e,this.xAxis,v.create()),pe.S4.scale(this.yAxis,-1,v.create()),v.create()),a);let h;if(Ys()){const e=pe.S4.cross(this.xAxis,this.yAxis,v.create());Gu(Qu(this.center,e),o)}else{h=t.getColor("CONSTRUCTION_PLANE_AMBIENT_COLOR").slice(0),h[3]=t.getNumber("CONSTRUCTION_PLANE_OPACITY"),Uu(h,o)}this.increments[kC]=o,this.updateMeshIncrement(kC,kC,o,GC),this.invalidateTextGraphics()}getIncrement(e){return e&&this.increments[e]?this.increments[e].clone():this.increments[kC]?this.increments[kC].clone():null}getBounds(){const e=new Li.kB,t=pe.S4.add(this.center,this.centerOffset,xC);for(let i=-1;i<=1;i+=2)for(let s=-1;s<=1;s+=2){const n=pe.S4.add(pe.S4.add(pe.S4.scale(this.xAxis,i,BC),pe.S4.scale(this.yAxis,s,UC)),t);e.addPoint(n)}return e}invalidateTextGraphics(){this.lastTextScale=-1}getTextTexture(){return this.textTexture||(this.textTexture=Go(this.viewer,this.name,{color:bC.getColor(this.textColorName),font:bC.getString("PLANE_TEXT_FONT"),size:bC.getNumber("PLANE_TEXT_HEIGHT_PX"),paddingWithinBorder:bC.getNumber("PLANE_TEXT_BACKGROUND_PADDING")}),this.invalidateTextGraphics()),this.textTexture}onViewWillDraw(e,t){this.isHidden||this.name&&this.updateText(e)}canPickThrough(){return!0}getModelSelection(e){const t=e.uiElement.getUsage(),i=(0,ve.cF)(this.entityId,void 0,t);return i&&(i.sourcePick=e.sourcePick,i.secondarySelectionData={isFromPlaneEdge:e.selectionId===WC}),i}getPickPriority(e){return e.selectionId===WC?Ef.z.CONSTRUCTION_PLANE_EDGE:Ef.z.CONSTRUCTION_PLANE}getUsage(){return this.usage}addHighlight(e){this.addHighlightToIncrement(WC,e),this.addHighlightToIncrement(kC,e),e.type!==yn.o2.ENTITY&&e.type!==yn.o2.FEATURE||!Zs()||this.isHidden||this.updateResizeManipulators(!0),(0,Js.vm)()}removeHighlight(e){return this.removeHighlightFromIncrement(WC,e),this.removeHighlightFromIncrement(kC,e),e.type!==yn.o2.ENTITY&&e.type!==yn.o2.FEATURE||this.removeResizeManipulators(),(0,Js.vm)(),!0}cloneForPreview(){const e=Ys()?"CONSTRUCTION_PLANE_COMPARE_TEXT_COLOR":"CONSTRUCTION_PLANE_TEXT_COLOR",t=new zC(e,this.entityId,sh.Vv,this.planeId,this.viewer);return t.width=this.width,t.height=this.height,t.centerOffset=this.centerOffset,t.setName(this.name),t.updatePlaneGraphics(),t}isInteractionEnabled(){return!1}getCenter(){return v.fromValues(this.center[0],this.center[1],this.center[2])}getXAxis(){return v.fromValues(this.xAxis[0],this.xAxis[1],this.xAxis[2])}getYAxis(){return v.fromValues(this.yAxis[0],this.yAxis[1],this.yAxis[2])}getName(){return this.name}onAppearanceConstantsUpdated(){this.destroyText(),this.updatePlaneGraphics()}}const XC=q.default.getManager(),qC=1e-6,ZC=500,YC="move",KC=new Qi({primitiveType:_i.MX.TRIANGLES,material:Wi,zOffset:2,isTwoSided:!0,includedInBlend:!1,primitivesHaveTransparency:!0,isShowThrough:!0,isDepthTested:!1,addsToBounds:!1}),jC=new Qi({primitiveType:_i.MX.TRIANGLE_STRIP,material:Wi,zOffset:2,isTwoSided:!0,includedInBlend:!1,primitivesHaveTransparency:!0,isShowThrough:!0,isDepthTested:!1,addsToBounds:!1});class QC extends Ri{constructor(e,t,i,s,n,r,a){super(a,s.usage===Ls.L.BASE?sh.lL:sh.Vv),this.highlighted=!1,this.dragOffset=[0,0],this.resizeUniformly=!1,this.cursorString="",this.staticIncrements=null,this.center=t,this.normal=i,this.direction0=n,this.direction1=r,this.offset=$.create(),this.parent=s,this.selectionId=e,this.listenTo(this,Pi.MOUSE_ENTER+this.selectionId,this.onMouseEnter),this.listenTo(this,Pi.MOUSE_LEAVE+this.selectionId,this.onMouseLeave),this.listenTo(this,Pi.DRAG_START+this.selectionId,this.onDragStart),this.listenTo(this,Pi.DRAG+this.selectionId,this.onDrag),this.listenTo(this,Pi.DRAG_STOP+this.selectionId,this.onDragStop)}onViewWillDraw(e,t){this.updateTransform(e),this.hasMeshIncrements()||this.updateGraphics()}onAppearanceConstantsUpdated(){this.removeMeshIncrements(),this.staticIncrements=null}updateTransform(e){const t=ge.create(),i=v.fromValues(this.center[0],this.center[1],this.center[2]),s=(pe.S4.length(this.parent.getXAxis())+pe.S4.length(this.parent.getYAxis()))/2,n=Math.min(e.getPixelSizeAtWorldPoint(this.transformPoint(i)),s/16),r=(0,Es.x_)();t[0]=n*r,t[5]=n*r,t[10]=n*r,t[12]=this.center[0],t[13]=this.center[1],t[14]=this.center[2],this.setTransform(t)}getClearModelSelectionsOnPrehilite(){return!1}getStaticIncrements(){if(this.staticIncrements)return this.staticIncrements;this.staticIncrements={};const e=[0,0,0],t=pe.S4.normalize(this.direction0,v.create()),i=XC.getNumber("RESIZE_MANIPULATOR_RADIUS"),s=this.selectionId+"FrontFace",n=Mu(e,i,this.normal,36);this.staticIncrements[s]={selection:this.selectionId,data:n,type:KC,color:XC.getColor("RESIZE_MANIPULATOR_INNER_COLOR")};const r=this.selectionId+"Border",a=yu(e,i,1.3*i,this.normal,t,0,2*Math.PI,36);return this.staticIncrements[r]={selection:this.selectionId,data:a,type:jC,color:XC.getColor("RESIZE_MANIPULATOR_OUTER_COLOR")},this.staticIncrements}updateGraphics(){this.updateIncrementsOnEntity(this.selectionId,"FrontFace"),this.updateIncrementsOnEntity(this.selectionId,"Border")}updateIncrementsOnEntity(e,t){const i=this,s=this.getStaticIncrements();s[e+t].type===KC?Uu(s[e+t].color,s[e+t].data):s[e+t].type===jC&&Uu(i.highlighted?XC.getColor("RESIZE_MANIPULATOR_OUTER_COLOR_HIGHLIGHT"):s[e+t].color,s[e+t].data),this.updateMeshIncrement(e+t,s[e+t].selection,s[e+t].data.clone(),s[e+t].type)}cleanup(){this.cursorString===YC&&(this.cursorString="",this.viewer.popCursor())}updateDefinition(e,t,i,s){this.staticIncrements=null,this.center=e,this.normal=pe.S4.normalize(t,v.create()),this.direction0=pe.S4.normalize(i,v.create()),this.direction1=pe.S4.normalize(s,v.create()),this.updateGraphics()}onMouseEnter(e,t){this.highlighted=!0,0===this.cursorString.length&&(this.cursorString=YC,this.viewer.pushCursor(this.cursorString)),this.updateGraphics(),(0,Js.vm)()}onMouseLeave(e,t){this.highlighted&&(this.highlighted=!1,this.updateGraphics()),this.cursorString===YC&&(this.cursorString="",this.viewer.popCursor()),(0,Js.vm)()}getOffsetFromEvent(e){const t=e.camera.getRay(e.mouseX,e.mouseY),i=v.create(),s=this.normal,n=P.fromValues(s[0],s[1],s[2],-v.dot(s,this.center)),r=(0,Li.fE)(t,n);if(null===r)return null;return[v.dot(pe.S4.subtract(r,this.center,i),this.direction0),v.dot(pe.S4.subtract(r,this.center,i),this.direction1)]}onDragStart(e,t,i){const s=this.getOffsetFromEvent(t);s&&(this.dragOffset=pe.gv.subtract(s,this.offset,$.create()),i.requestDrag=!0,this.resizeUniformly=this.viewer.getLastMouseMovedEvent().shiftKey)}onDrag(e,t){const i=this.getOffsetFromEvent(t);if(!i)return;this.offset=pe.gv.subtract(i,this.dragOffset,$.create());for(let e=0;e<this.offset.length;e++)this.offset[e]=parseFloat(this.offset[e].toFixed(8));let s,n,r=0,a=0;this.resizeUniformly?(s=2*pe.S4.length(this.parent.getXAxis())+2*this.offset[0],n=2*pe.S4.length(this.parent.getYAxis())+2*this.offset[1],s>qC&&s<ZC&&(this.parent.width=s),n>qC&&n<ZC&&(this.parent.height=n)):(s=2*pe.S4.length(this.parent.getXAxis())+1*this.offset[0],n=2*pe.S4.length(this.parent.getYAxis())+1*this.offset[1],s>qC&&s<ZC&&(this.parent.width=s,r=this.offset[0]/2*v.dot(this.direction0,pe.S4.normalize(this.parent.getXAxis(),v.create()))),n>qC&&n<ZC&&(this.parent.height=n,a=this.offset[1]/2*v.dot(this.direction1,pe.S4.normalize(this.parent.getYAxis(),v.create()))),this.parent.centerOffset=pe.S4.subtract(pe.S4.add(this.parent.centerOffset,(0,Li.qm)([r,a],this.parent.getCenter(),this.normal,pe.S4.normalize(this.parent.getXAxis(),v.create())),v.create()),this.parent.getCenter(),v.create())),this.parent.updateDefinition(this.parent.getName(),this.parent.getCenter(),this.parent.getXAxis(),this.parent.getYAxis(),!0),(0,Js.vm)()}onDragStop(e,t){const i=new W.yVM;i.width=this.parent.width,i.height=this.parent.height;const s=(0,Li.LK)(pe.S4.add(this.parent.centerOffset,this.parent.getCenter(),v.create()),this.parent.getCenter(),this.normal,pe.S4.normalize(this.parent.getXAxis(),v.create()));i.xOffset=s[0],i.yOffset=s[1],this.viewer.getEventDispatcher().trigger(VM.P1,i,this.parent.planeId),this.offset=[0,0]}}class $C extends m.T{constructor(e,t){super(),this.isEnabled=!1,this.selectionList=new ve.nZ($C.SELECTION_LIST_NAME),(0,Ih.Yk)(e),this.graphicsViewer=e,this.highlightFilterFunction=t}getIsEnabled(){return this.isEnabled}enable(){this.isEnabled=!0,this.setupHandlers(),this.updateSetOfFilteredEntities(),this.stopListening(),this.listenTo(this.graphicsViewer.getEventDispatcher(),VM.cy,this.updateSetOfFilteredEntities),this.latestDisplayDataUsageSubscription=ks().latestDisplayDataUsageChangedObservable.subscribe((()=>this.updateSetOfFilteredEntities())),this.graphicsViewer.onLaminarEdgesChanged(!0)}disable(){this.isEnabled&&(this.isEnabled=!1,this.removeHandlers(),this.stopListening(),this.latestDisplayDataUsageSubscription.unsubscribe(),this.clearSelections(),this.graphicsViewer.onLaminarEdgesChanged(!1))}setupHandlers(){this.graphicsViewer.getModelViewManagers().getManager().handleSelectionListHighlights($C.SELECTION_LIST_NAME,this.selectionList,yn.o2.FILTERED_ENTITIES);const e=(0,Q.as)(Sh,this.graphicsViewer.getModelViewManagers().getPreviewManager());null==e||e.handleSelectionListHighlights($C.SELECTION_LIST_NAME,this.selectionList,yn.o2.FILTERED_ENTITIES)}removeHandlers(){this.graphicsViewer.getModelViewManagers().getManager().removeSelectionListHandler($C.SELECTION_LIST_NAME);const e=(0,Q.as)(Sh,this.graphicsViewer.getModelViewManagers().getPreviewManager());null==e||e.removeSelectionListHandler($C.SELECTION_LIST_NAME)}clearSelections(){this.selectionList.reset()}getSelectionList(){return this.selectionList}updateSetOfFilteredEntities(){this.clearSelections();const e=this.graphicsViewer.getModelViewManagers().getManager();this.updateHighlightsForPartStudio((0,Q.as)(qd,e.getDisplayedPartStudio()));const t=(0,Q.as)(Sh,this.graphicsViewer.getModelViewManagers().getPreviewManager());t&&this.updateHighlightsForPartStudio(t.getDisplayedPartStudio())}updateHighlightsForPartStudio(e){if(!e)return;const t=e.getFilteredEntityIds(this.highlightFilterFunction),i=!this.graphicsViewer.getIsolatedOccurrenceManager().isInIsolateOrMakeTransparentMode(),s=e.getBodyComponent();for(let n=0;n<t.length;++n){const r=(0,ve.cF)(t[n],null,e.usage);r&&e.getBodyVisibility(r.getBodyId())===Js.EE.VISIBLE&&(i||s.isBodyIsolated(DI.KF,r.getBodyId()))&&this.selectionList.add(r)}}}$C.SELECTION_LIST_NAME="filteredEntitiesList";var JC=i(32659),eD=i(10700);class tD{constructor(e){this.viewer=e,this.supportedSessionTypes=new Set,this.activeSessionType=null,this.startingSession=!1,this.animationFrameCallback=null,this.overrideCamera=new Ah,this.modelViewInitialized=!1,this.modelTransform_=ge.create(),this.modelTransformInverse_=ge.create(),this.orderIndependentTransparencyEnabledOutsideXr=!0,this.xrInputDispatcher=new pD(this.viewer,this),this.xrSelectionHandler=new SD(this.viewer),this.xrInputDispatcher.addSelectHandler(this.xrSelectionHandler),this.xrInputDispatcher.addGamepadButtonHandler(this),this.xrViewController=new OD(e,this.xrInputDispatcher),this.xrMarkupController=new ED(e,this.xrInputDispatcher),this.xrCommentController=new sD(e,this.xrInputDispatcher),this.animationFrameCallback=(e,t)=>this.onAnimationFrame(e,t),ps.Jq.CapabilitiesService.isWebxrEnabled().then((t=>{if(!t)return;const i=yD();i&&(i.isSessionSupported("immersive-vr").then((e=>{e&&this.supportedSessionTypes.add(eD.$.VR)})),i.isSessionSupported("immersive-ar").then((e=>{e&&this.supportedSessionTypes.add(eD.$.AR)}))),this.xrBaseFrameBuffer=new Xo(e)}))}getSupportedSessionTypes(){return this.supportedSessionTypes}getActiveSessionType(){return this.activeSessionType}get xrReferenceSpace(){return this.xrReferenceSpace_}set modelTransform(e){this.modelTransform_=e,ge.invert(this.modelTransformInverse_,e),this.xrInputDisplay&&this.xrInputDisplay.onModelTransformChange(this.modelTransformInverse_)}get modelTransform(){return this.modelTransform_}get modelTransformInverse(){return this.modelTransformInverse_}startXr(e){if(this.startingSession)return void It.log.info("Attempt to start xr while session start was already pending");if(this.xrSession)throw new Error("XR session already in progress");if(!e)throw new Error("Invalid XrSessionType "+e);if(!this.supportedSessionTypes.has(e))throw new Error("Attempt to start unsuppported XrSessionType "+e);const t=this.viewer.getGlContext();(null==t?void 0:t.makeXRCompatible)?(this.modelViewInitialized=!1,this.startingSession=!0,this.xrCommentController.checkMicrophonePermission().finally((()=>{t.makeXRCompatible().then((()=>this.startXrSession(e))).catch((e=>{It.log.warn("Error making context xr compatible: "+e)})).finally((()=>{this.startingSession=!1}))}))):It.log.warn("Could not make XR compatible context")}startXrSession(e){const t=yD();t?t.requestSession(e).then((t=>(this.activeSessionType=e,this.xrSession=t,this.xrInputDispatcher.setXrSession(this.xrSession),(0,Et.isPlatformMetaQuest)()&&this.reduceDetailForSession(),this.xrSession.updateRenderState({baseLayer:new XRWebGLLayer(this.xrSession,this.viewer.getGlContext())})))).then((()=>{this.startXrRendering()})).catch((e=>{It.log.warn("Failed to create xr session: "+e)})):It.log.warn("Could not get xr system")}stopXr(){this.xrSession&&((0,Et.isPlatformMetaQuest)()&&this.restoreNonXrDetail(),this.xrInputDispatcher.resetXrSession(),this.xrSession.end().catch((e=>{It.log.debug("XR session end failed: "+e)})).finally((()=>{this.viewer.viewManipulator.show(),this.viewer.forceRequestDraw()})),this.modelTransform=ge.identity(ge.create()),this.removeInputDisplay(),this.xrMarkupController.clearMarkup(),JC(".exit-xr-button").remove(),this.xrSession=null,this.activeSessionType=null,this.viewer.getAnimationController().requestAnimationFrameIfNeeded())}getIsXrRunning(){return!!this.xrSession}getXrInputDispatcher(){return this.xrInputDispatcher}startXrRendering(){var e;null===(e=this.xrSession)||void 0===e||e.requestReferenceSpace("local").then((e=>{var t;this.xrReferenceSpace_=e,this.lastXrFrameTimeMs=(0,Js.Wj)(),null===(t=this.xrSession)||void 0===t||t.requestAnimationFrame(this.animationFrameCallback);const i=this.activeSessionType===eD.$.AR?i18n("Exit AR"):i18n("Exit VR");JC(`<button class="btn btn-default exit-xr-button" type="button">${i}</button>`).appendTo(".canvas-container").click((()=>{this.stopXr()}))})).catch((e=>{It.log.warn("Failed to get xr reference space: "+e)}))}onAnimationFrame(e,t){var i,s;if(!this.xrSession)return;this.updateInput(t),this.viewer.setInRequestDrawCallback(!0);const n=t.getViewerPose(this.xrReferenceSpace_);if(!n)return It.log.debug("No pose found for device"),void this.xrSession.requestAnimationFrame(this.animationFrameCallback);const r=null===(s=null===(i=this.xrSession)||void 0===i?void 0:i.renderState)||void 0===s?void 0:s.baseLayer;if(!r)return;this.viewer.setSystemIsAnimating(),this.viewer.getAnimationController().advanceAnimation(e);const a=this.viewer.getGlContext();if(!a)return;a.bindFramebuffer(a.FRAMEBUFFER,r.framebuffer),this.xrBaseFrameBuffer.setExternalFrameBuffer(this.getFrameBufferWidth(),this.getFrameBufferHeight(),r.framebuffer),this.viewer.setBaseFrameBuffer(this.xrBaseFrameBuffer),this.activeSessionType===eD.$.VR&&(a.clearColor(1,1,1,1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT));for(let e=0;e<n.views.length;++e){const t=n.views[e];this.overrideCamera.setTransforms(this.modelTransform_,t.transform.inverse.matrix,t.projectionMatrix),this.lastXrViewMatrixInverse=ge.copy(ge.create(),t.transform.inverse.matrix),this.initializeModelView();const i=r.getViewport(t);this.overrideCamera.setViewport([i.x,i.y,i.width,i.height]);const s=null;this.viewer.draw(s,{camera:this.overrideCamera,performFrameTiming:0===e}),this.imageCaptureSuccessCallback&&"right"===t.eye&&this.performImageCapture(i)}const o=(0,Js.Wj)();o-this.lastXrFrameTimeMs>=5e3&&(It.log.debug("XR frame rate: "+this.viewer.getFrameTimer().getAverageFrameRate(Ms.QpP.INTERACTIVE)+" fps"),this.lastXrFrameTimeMs=o),a.bindFramebuffer(a.FRAMEBUFFER,null),this.viewer.setBaseFrameBufferToDefault(),this.viewer.setInRequestDrawCallback(!1),this.xrSession.requestAnimationFrame(this.animationFrameCallback)}getCamera(){return this.overrideCamera}captureViewportImage(){return new Promise(((e,t)=>{this.imageCaptureSuccessCallback=e,this.imageCaptureErrorCallback=t}))}performImageCapture(e){const t=this.viewer.getGlContext();if(!this.imageCaptureSuccessCallback||!t)return;const i=q.default.getManager().getNumber("XR_COMMENT_VIEW_CAPTURE_PROPORTION"),s=Math.floor(e.width*i),n=Math.floor(e.height*i),r=e.x+Math.floor(s/2),a=e.y+Math.floor(n/2),o=new Uint8Array(s*n*4);t.readPixels(r,a,s,n,t.RGBA,t.UNSIGNED_BYTE,o),(0,Js.Dy)(o,s,n),this.imageCaptureSuccessCallback({width:s,height:n,data:o}),this.imageCaptureSuccessCallback=null,this.imageCaptureErrorCallback=null}getFrameBufferWidth(){var e;return(null===(e=this.xrSession)||void 0===e?void 0:e.renderState)&&this.xrSession.renderState.baseLayer?this.xrSession.renderState.baseLayer.framebufferWidth:null}getFrameBufferHeight(){var e;return(null===(e=this.xrSession)||void 0===e?void 0:e.renderState)&&this.xrSession.renderState.baseLayer?this.xrSession.renderState.baseLayer.framebufferHeight:null}initializeModelView(){this.modelViewInitialized||(this.viewer.viewManipulator.hide(),this.xrViewController.initializeModelView(this.overrideCamera),this.modelViewInitialized=!0)}updateInput(e){var t;const i=null===(t=this.xrSession)||void 0===t?void 0:t.inputSources;if(!i)return;this.xrInputDispatcher.onFrameStart(e);let s=null;for(let e=0;e<i.length;++e)if(i[e].handedness===this.xrInputDispatcher.primaryControllerHandedness){s=i[e];break}if(!s||!this.xrSession)return void this.removeInputDisplay();const n=e.getPose(s.targetRaySpace,this.xrReferenceSpace_);n&&n.transform&&(this.xrInputDisplay||(this.xrInputDisplay=new hD(this.viewer,this.modelTransformInverse)),this.xrInputDisplay.update(n.transform.matrix,n.transform.inverse.matrix))}removeInputDisplay(){this.xrInputDisplay&&(this.xrInputDisplay.remove(),this.xrInputDisplay=null)}getDominantXrInputDisplay(){return this.xrInputDisplay}onGamepadButtonDown(e){return this.isStopXrButton(e)}onGamepadButtonDrag(e){}onGamepadButtonUp(e){this.isStopXrButton(e)&&this.stopXr()}isStopXrButton(e){return e.buttonNumber===Ms.qT7.B&&e.handType===Ms.dPT.DOMINANT}reduceDetailForSession(){this.orderIndependentTransparencyEnabledOutsideXr=(0,Js.Z)(),(0,Js.uP)(!1)}restoreNonXrDetail(){(0,Js.uP)(this.orderIndependentTransparencyEnabledOutsideXr)}}const iD=window.SpeechRecognition||window.webkitSpeechRecognition;class sD{constructor(e,t){this.viewer=e,this.commentStarted=!1,this.commentImage=null,this.recognition=null,this.recognitionResult="",this.lastPreviewedText="",this.textPreview=null,t.addGamepadButtonHandler(this),iD?(this.recognition=new iD,this.recognition.continuous=!0,this.recognition.lang="en-US",this.recognition.interimResults=!0,this.recognition.onstart=()=>{It.log.trace("Speech recognition started")},this.recognition.onerror=e=>{It.log.info("Speech recognition error: "+e.error),this.abortComment()},this.recognition.onresult=e=>this.processRecognitionResult(e),this.recognition.onend=()=>{this.finishComment()}):It.log.debug("Speech recognition not available")}checkMicrophonePermission(){return new Promise(((e,t)=>{const i="os-microphone-permission-check-completed";if(localStorage.getItem(i))e();else{const s=new iD;function n(){s.abort(),localStorage.setItem(i,"true"),e()}s.continuous=!0,s.lang="en-US",s.interimResults=!0,s.onstart=n,s.onerror=n,s.start()}}))}onGamepadButtonDown(e){return!(!this.commentStarted||!this.isAbortCommentButton(e))||!!this.recognition&&this.isDoCommentButton(e)}onGamepadButtonDrag(e){}onGamepadButtonUp(e){this.isDoCommentButton(e)?this.commentStarted?this.stopRecognition():this.startComment():this.isAbortCommentButton(e)&&this.abortComment()}isDoCommentButton(e){return e.buttonNumber===Ms.qT7.A&&e.handType===Ms.dPT.NON_DOMINANT}isAbortCommentButton(e){return e.buttonNumber===Ms.qT7.B&&e.handType===Ms.dPT.NON_DOMINANT}startComment(){this.commentStarted||(this.commentStarted=!0,this.recognitionResult="",this.lastPreviewedText="",this.viewer.getXrController().getIsXrRunning()?(this.viewer.getXrController().captureViewportImage().then((e=>{this.commentImage=e})).finally((()=>{this.startRecognition()})),this.updateTextPositionFromCamera(this.viewer.getXrController().getCamera())):(this.commentImage=this.viewer.retrieveViewportAsImage({width:this.viewer.getCamera().getCanvasWidth(),height:this.viewer.getCamera().getCanvasHeight(),useFlattenedView:!1,usePrint:!1,zoomToFit:!1,zoomToSelection:!1,showViewCube:!0}),this.updateTextPositionFromCamera(this.viewer.getCamera()),this.startRecognition()))}startRecognition(){var e;this.updateTextDisplay("Listening for comment…"),null===(e=this.recognition)||void 0===e||e.start()}processRecognitionResult(e){if(void 0===e.results)return It.log.debug("Speech recognition gave no result"),void this.abortComment();let t="";for(let i=e.resultIndex;i<e.results.length;++i)e.results[i].isFinal?this.recognitionResult+=e.results[i][0].transcript:t+=e.results[i][0].transcript;this.updateTextDisplay(this.recognitionResult+t)}stopRecognition(){var e;null===(e=this.recognition)||void 0===e||e.stop()}finishComment(){if(!this.commentStarted)return;if(this.commentStarted=!1,!this.commentImage)return void It.log.warn("No image for xr comment");const e=this.recognitionResult;e?(0,Js.Z$)(this.commentImage).then((t=>{const i={isNew:!0,elementId:this.viewer.getActiveElementId(),attachment:new File([t],"XR view.jpg")};(0,fr.m)().trigger(mr.C.PUBLISH_NEW_COMMENT,e,i)})):It.log.trace("Cannot post comment without message"),this.clearTextDisplay(),this.recognitionResult="",this.commentImage=null}abortComment(){var e;this.clearTextDisplay(),this.commentStarted=!1,this.commentImage=null,null===(e=this.recognition)||void 0===e||e.abort()}updateTextPositionFromCamera(e){this.textPreviewRight=v.copy(v.create(),e.getRight()),this.textPreviewUp=v.copy(v.create(),e.getUp());this.textPreviewOrigin=v.add(v.create(),e.getEye(),v.scale(v.create(),e.getForward(),1.5))}clearTextDisplay(){this.textPreview&&(this.textPreview.remove(),this.textPreview=null)}updateTextDisplay(e){if(this.lastPreviewedText===e)return;this.clearTextDisplay(),this.lastPreviewedText=e;let t="New comment:\n\n";const i=e.split(" ");let s=0;for(let e=0;e<i.length;++e)s>0&&(t+=" ",s+=1),t+=i[e],s+=i[e].length,s>=50&&(t+="\n",s=0);t+="\n\nLeft A: confirm     Left B: cancel",this.textPreview=new ba({origin:this.textPreviewOrigin,right:this.textPreviewRight,up:this.textPreviewUp,heightPx:20},this.viewer),this.textPreview.setText(t),this.textPreview.updateOnEachFrame=!1}}const nD=.102,rD=[[-.032,0,0],[.032,0,0],[-.032,0,0],[0,-.038,0],[.032,0,0],[0,-.038,0],[0,0,-nD],[-.032,0,0],[0,0,-nD],[.032,0,0],[0,0,-nD],[0,-.038,0]],aD=new Qi({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,priority:Yi.DEFAULT,primitiveType:_i.MX.LINES}),oD=aD.cloneAndModify({addsToBounds:!1});class hD extends Ri{constructor(e,t){super(e),this.modelTransformInverse=t,this.color=[1,0,0,1],this.pose=ge.create(),this.combinedTransform=ge.create(),this.hidePointerRay_=!1;const i=Iu(rD,null,this.color);this.updateMeshIncrement("LINES",yi,i,aD)}update(e,t){if(!this.hidePointerRay_){const e=Iu([[0,0,-nD],[0,0,-10]],null,this.color);this.updateMeshIncrement("RAY",yi,e,oD)}ge.copy(this.pose,e),this.updateTransform()}onModelTransformChange(e){this.modelTransformInverse=e,this.updateTransform()}hidePointerRay(){this.removeMeshIncrement("RAY"),this.hidePointerRay_=!0}showPointerRay(){this.hidePointerRay_=!1}updateTransform(){ge.multiply(this.combinedTransform,this.modelTransformInverse,this.pose),this.setTransform(this.combinedTransform)}}var cD;!function(e){e.select="select",e.selectstart="selectstart",e.selectend="selectend",e.squeeze="squeeze",e.squeezestart="squeezestart",e.squeezeend="squeezeend"}(cD||(cD={}));class lD{constructor(e,t,i,s){this.worldSpacePose=e,this.worldSpaceRay=t,this.modelSpacePose=i,this.modelSpaceRay=s}}class uD{constructor(e,t,i){this.handType=e,this.buttonNumber=t,this.xrInputEvent=i}}class dD{constructor(e,t,i){this.handType=e,this.gamepad=t,this.xrInputEvent=i}}class gD{}class pD{constructor(e,t){this.viewer=e,this.xrController=t,this.eventToCallback=new Map,this.selectHandlers=[],this.activeSelectHandler=null,this.activeSelectSource=null,this.squeezeHandlers=[],this.activeSqueezeHandler=null,this.activeSqueezeSource=null,this.gamepadButtonStates=[],this.gamepadButtonHandlers=[],this.activeGamepadButtonHandlers=new Map,this.gamepadAxesHandlers=[],this.activeGamepadAxesHandler=[null,null],this.primaryControllerHandedness_=null,this.resetGamepadState()}resetGamepadState(){this.gamepadButtonStates=[],this.activeGamepadButtonHandlers=new Map;for(let e=Ms.dPT.DOMINANT;e<=Ms.dPT.NON_DOMINANT;++e){const t=[],i=new Map;for(let e=0;e<10;++e)t.push(new gD),i.set(e,null);this.gamepadButtonStates.push(t),this.activeGamepadButtonHandlers.set(e,i)}}destroy(){this.removeXrSessionListeners()}get primaryControllerHandedness(){return this.primaryControllerHandedness_}setXrSession(e){this.xrSession!==e?(this.xrSession&&this.resetXrSession(),this.xrSession=e,this.bindListener(cD.select,this.onSelect),this.bindListener(cD.selectstart,this.onSelectStart),this.bindListener(cD.selectend,this.onSelectEnd),this.bindListener(cD.squeeze,this.onSqueeze),this.bindListener(cD.squeezestart,this.onSqueezeStart),this.bindListener(cD.squeezeend,this.onSqueezeEnd)):It.log.debug("Called setXrSession twice for same session")}resetXrSession(){this.removeXrSessionListeners(),this.xrSession=null}removeXrSessionListeners(){var e;for(const[t,i]of this.eventToCallback)null===(e=this.xrSession)||void 0===e||e.removeEventListener(t,i);this.eventToCallback.clear()}addHandler(e,t){t.indexOf(e)<0&&t.unshift(e)}removeHandler(e,t){const i=t.indexOf(e);i>=0&&t.splice(i,1)}addSelectHandler(e){this.addHandler(e,this.selectHandlers)}removeSelectHandler(e){this.removeHandler(e,this.selectHandlers),this.activeSelectHandler===e&&(this.activeSelectHandler=null)}addSqueezeHandler(e){this.addHandler(e,this.squeezeHandlers)}removeSqueezeHandler(e){this.removeHandler(e,this.squeezeHandlers),this.activeSqueezeHandler===e&&(this.activeSqueezeHandler=null)}addGamepadButtonHandler(e){this.addHandler(e,this.gamepadButtonHandlers)}removeGamepadButtonHandler(e){this.removeHandler(e,this.gamepadButtonHandlers);for(const[t,i]of this.activeGamepadButtonHandlers)for(const[t,s]of i)s===e&&i.set(t,null)}addGamepadAxesHandler(e){this.addHandler(e,this.gamepadAxesHandlers)}removeGamepadAxesHandler(e){this.removeHandler(e,this.gamepadAxesHandlers);for(let t=0;t<this.activeGamepadAxesHandler.length;++t)this.activeGamepadAxesHandler[t]===e&&(this.activeGamepadAxesHandler[t]=null)}onFrameStart(e){const t=new Map;if(this.activeSelectSource&&this.activeSelectHandler){const i=this.getOsEventFromFrameAndSource(e,this.activeSelectSource,t);i&&this.activeSelectHandler.onXrSelectDrag(i)}if(this.activeSqueezeSource&&this.activeSqueezeHandler){const i=this.getOsEventFromFrameAndSource(e,this.activeSqueezeSource,t);i&&this.activeSqueezeHandler.onXrSqueezeDrag(i)}if(this.primaryControllerHandedness_||this.initializeHandedness(),!this.xrSession)return;let i=null,s=null;for(let e=0;e<this.xrSession.inputSources.length;++e)this.xrSession.inputSources[e].gamepad&&(this.xrSession.inputSources[e].handedness===this.primaryControllerHandedness?i||(i=this.xrSession.inputSources[e]):s||(s=this.xrSession.inputSources[e]));i&&this.updateGamepadState(Ms.dPT.DOMINANT,i,e,t),s&&this.updateGamepadState(Ms.dPT.NON_DOMINANT,s,e,t)}updateGamepadState(e,t,i,s){const n=t.gamepad;if(t.gamepad){for(let r=0;r<n.buttons.length;++r){if(r>=10){It.log.debug("Trying to track a button beyond what we support: "+r);continue}const a=n.buttons[r],o=this.gamepadButtonStates[e][r],h=this.activeGamepadButtonHandlers.get(e).get(r);if(a.pressed&&!o.timePressed){o.timePressed=(0,Js.Wj)();const n=new uD(e,r,this.getOsEventFromFrameAndSource(i,t,s));for(const t of this.gamepadButtonHandlers)if(t.onGamepadButtonDown(n)){this.activeGamepadButtonHandlers.get(e).set(r,t);break}}else if(!a.pressed&&o.timePressed){if(o.timePressed=null,h){const n=new uD(e,r,this.getOsEventFromFrameAndSource(i,t,s));h.onGamepadButtonUp(n),this.activeGamepadButtonHandlers.get(e).set(r,null)}}else if(a.pressed&&h){const n=new uD(e,r,this.getOsEventFromFrameAndSource(i,t,s));h.onGamepadButtonDrag(n)}}if(this.activeGamepadAxesHandler[e]){const r=new dD(e,n,this.getOsEventFromFrameAndSource(i,t,s));this.activeGamepadAxesHandler[e].onGamepadAxesUpdate(r)||(this.activeGamepadAxesHandler[e]=null)}else if(this.gamepadButtonHandlers.length>0){const r=new dD(e,n,this.getOsEventFromFrameAndSource(i,t,s));for(const t of this.gamepadAxesHandlers)t.onGamepadAxesUpdate(r)&&(this.activeGamepadAxesHandler[e]=t)}}else It.log.warn("Should only update with gamepad input sources")}initializeHandedness(){if(!this.xrSession)return;let e,t;for(let i=0;i<this.xrSession.inputSources.length;++i)this.xrSession.inputSources[i].gamepad&&("right"===this.xrSession.inputSources[i].handedness?e=!0:"left"===this.xrSession.inputSources[i].handedness&&(t=!0));e?this.primaryControllerHandedness_="right":t&&(this.primaryControllerHandedness_="left")}bindListener(e,t){const i=e=>{t.bind(this)(this.getOsEventFromSourceEvent(e),e)};this.xrSession.addEventListener(e,i),this.eventToCallback.set(e,i)}getOsEventFromSourceEvent(e){return this.getOsEventFromFrameAndSource(e.frame,e.inputSource)}getOsEventFromFrameAndSource(e,t,i){const s=null==i?void 0:i.get(t);if(s)return s;const n=e.getPose(t.targetRaySpace,this.xrController.xrReferenceSpace);if(!(null==n?void 0:n.transform))return null;const r=this.xrController.modelTransformInverse,a=pe.w$.multiplyVec3(n.transform.matrix,[0,0,0]),o=pe.w$.multiplyVec3(r,a,v.create()),h=pe.w$.multiplyVec4(n.transform.matrix,[0,0,-1,0]),c=pe.w$.multiplyVec4(r,h,P.create()),l=new Li.zH(a,h),u=new Li.zH(o,c),d=ge.multiply(ge.create(),r,n.transform.matrix),g=new lD(n.transform.matrix,l,d,u);return i&&i.set(t,g),g}onSelectStart(e,t){for(let t=0;t<this.selectHandlers.length;++t)if(this.selectHandlers[t].onXrSelectStart(e)){this.activeSelectHandler=this.selectHandlers[t];break}this.activeSelectSource=t.inputSource}onSelect(e,t){if(t.inputSource.handedness!==this.primaryControllerHandedness_){this.primaryControllerHandedness_=t.inputSource.handedness;const e=this.gamepadButtonStates[Ms.dPT.DOMINANT];return this.gamepadButtonStates[Ms.dPT.DOMINANT]=this.gamepadButtonStates[Ms.dPT.NON_DOMINANT],void(this.gamepadButtonStates[Ms.dPT.NON_DOMINANT]=e)}this.activeSelectHandler&&this.activeSelectHandler.onXrSelect(e)}onSelectEnd(e,t){this.activeSelectHandler&&(this.activeSelectHandler.onXrSelectEnd(e),this.activeSelectHandler=null),this.activeSelectSource=null}onSqueezeStart(e,t){for(let t=0;t<this.squeezeHandlers.length;++t)if(this.squeezeHandlers[t].onXrSqueezeStart(e)){this.activeSqueezeHandler=this.squeezeHandlers[t];break}this.activeSqueezeSource=t.inputSource}onSqueeze(e,t){this.activeSqueezeHandler&&this.activeSqueezeHandler.onXrSqueeze(e)}onSqueezeEnd(e,t){this.activeSqueezeHandler&&(this.activeSqueezeHandler.onXrSqueezeEnd(e),this.activeSqueezeHandler=null),this.activeSqueezeSource=null}}const mD=new Qi({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,priority:Yi.DEFAULT,primitiveType:_i.MX.LINES});class fD extends Ri{constructor(e,t,i){super(e);const s=Iu(t,null,i,2);this.updateMeshIncrement("LINES",yi,s,mD)}}const ID=[1,0,0,1];class ED{constructor(e,t){this.viewer=e,this.lineMarkup=[],this.inProgressLine=[],this.inProgressMarkup=null,t.addGamepadButtonHandler(this)}clearMarkup(){for(const e of this.lineMarkup)e.remove();this.lineMarkup=[]}onGamepadButtonDown(e){return this.isDrawMarkupButton(e)?(this.inProgressLine=[],this.updateLineMarkupWithCurrentPosition(e),this.viewer.getXrController().getDominantXrInputDisplay().hidePointerRay(),!0):this.isClearMarkupButton(e)}onGamepadButtonDrag(e){this.isDrawMarkupButton(e)&&this.updateLineMarkupWithCurrentPosition(e)}onGamepadButtonUp(e){this.isDrawMarkupButton(e)?(this.inProgressMarkup&&(this.lineMarkup.push(this.inProgressMarkup),this.inProgressMarkup=null,this.inProgressLine=[]),this.viewer.getXrController().getDominantXrInputDisplay().showPointerRay()):this.isClearMarkupButton(e)&&this.clearMarkup()}updateLineMarkupWithCurrentPosition(e){const t=e.xrInputEvent.modelSpaceRay.evaluate(nD);if(0===this.inProgressLine.length)return void this.inProgressLine.push(t);const i=this.inProgressLine[this.inProgressLine.length-1];v.dist(i,t)<1e-4||(1===this.inProgressLine.length||this.inProgressLine.push(i),this.inProgressLine.push(t),this.inProgressMarkup&&this.inProgressMarkup.remove(),this.inProgressMarkup=new fD(this.viewer,this.inProgressLine,ID))}isDrawMarkupButton(e){return e.buttonNumber===Ms.qT7.A&&e.handType===Ms.dPT.DOMINANT}isClearMarkupButton(e){return e.buttonNumber===Ms.qT7.B&&e.handType===Ms.dPT.NON_DOMINANT}}class SD{constructor(e){this.viewer=e,this.draggedUiElement=null}onXrSelectStart(e){this.draggedUiElement=null;const t=this.handleEvent(e,!0);return!(!t.handledUiSelection||!t.handledUiSelection.uiElement.triggerXrDragStart(t.handledUiSelection,e))&&(this.draggedUiElement=t.handledUiSelection,!0)}onXrSelectDrag(e){this.draggedUiElement&&this.draggedUiElement.uiElement.triggerXrDrag(this.draggedUiElement,e)}onXrSelect(e){this.draggedUiElement&&It.log.debug("Had dragged ui element during xr select event")}onXrSelectEnd(e){this.draggedUiElement&&(this.draggedUiElement.uiElement.triggerXrDragStop(this.draggedUiElement,e),this.draggedUiElement=null)}handleEvent(e,t){const i=this.viewer.pickWithXrInput(e),s={};s.click=!t;let n=!1;const r=this.viewer.getUISelectionManager(),a={handledUiSelection:null};for(let e=0;e<i.length&&!n;++e){const o=i[e],h=o.getModelSelection();if(h&&!this.viewer.getSuppressModelSelection())n=(0,Fa.rQ)(h,t,true,s),n&&r.handleEmptyUiPick(t,s);else if(o.isUIPick()&&(n=r.processUiPick(o,{}),n&&!this.viewer.getSuppressModelSelection())){const e=o.getUISelection();e&&!e.getClearModelSelectionsOnPrehilite()||(0,Fa.Zs)(t,!0),a.handledUiSelection=o.uiSelection}}return n||this.viewer.getSuppressModelSelection()||(0,Fa.Zs)(t,!1),a}}const TD=new Qi({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,priority:Yi.DEFAULT,primitiveType:_i.MX.LINES}),MD=[0,1,0,1],CD=[0,0,1];class DD extends Ri{constructor(e){super(e);const t=Cu([0,0,0],.5,CD,128);Uu(MD,t),Hu(2,t),this.updateMeshIncrement("preview_circle",yi,t,TD)}updateLocation(e){const t=ge.create();ge.translate(t,t,e),this.setTransform(t)}}const vD=ge.rotateX(ge.create(),ge.identity(ge.create()),-Math.PI/2),PD=ge.invert(ge.create(),vD);function yD(){return navigator.xr}var AD;!function(e){e[e.NONE=0]="NONE",e[e.FORWARD=1]="FORWARD",e[e.ROTATE_LEFT=2]="ROTATE_LEFT",e[e.ROTATE_RIGHT=3]="ROTATE_RIGHT"}(AD||(AD={}));class OD{constructor(e,t){this.viewer=e,this.initialModelTransform=null,this.initialWorldTransformInverse=null,this.activeTeleportMode=AD.NONE,this.teleportPreview=null,this.modelCamera=new Ph,t.addSqueezeHandler(this),t.addGamepadAxesHandler(this)}initializeModelView(e){const t=this.viewer.getCamera();if(!t)return;const i=this.viewer.getModelViewManagers().getManager().getModelBounds();if(!i.isInitialized()||!i.isFinite())return void It.log.warn("Could not initialize xr view with bounds: "+i);const s=[e.getDirection()[0],0,e.getDirection()[2]];v.normalize(s,s);let n=null;const r=this.viewer.retrieveCanvasLocationWorldPosition([t.getCanvasWidth()/2,t.getCanvasHeight()/2]);if(r){const e=t.getPixelSizeAtWorldPoint(r),s=t.getCanvasHeight()*e,n=2;if(i.diameter()>s*n){const e=s/2/Math.tan((0,Li.Yr)(Dh/2)),i=v.scaleAndAdd(v.create(),r,t.getForward(),-e);return void this.setModelTransform(this.getTransform(i,t.getForward()))}}if(!n){const t=.4+i.diameter()/5,r=v.add(v.create(),e.getEye(),v.scale(v.create(),s,t));r[1]-=i.diameter()/2,n=ge.translate(ge.create(),ge.identity(ge.create()),r)}this.setModelTransform(ge.multiply(ge.create(),n,vD))}onXrSqueezeStart(e){return this.initialWorldTransformInverse=ge.invert(ge.create(),e.worldSpacePose),this.initialModelTransform=ge.copy(ge.create(),this.viewer.getXrController().modelTransform),!0}onXrSqueezeDrag(e){const t=ge.multiply(ge.create(),e.worldSpacePose,this.initialWorldTransformInverse);this.setModelTransform(ge.multiply(ge.create(),t,this.initialModelTransform))}onXrSqueeze(e){}onXrSqueezeEnd(e){this.initialWorldTransformInverse=null,this.initialModelTransform=null}onGamepadAxesUpdate(e){if(e.handType===Ms.dPT.NON_DOMINANT)return!1;const t=Math.abs(e.gamepad.axes[2])>=.5&&(this.activeTeleportMode===AD.NONE||this.activeTeleportMode===AD.ROTATE_LEFT||this.activeTeleportMode===AD.ROTATE_RIGHT),i=e.gamepad.axes[3]<-.5&&(this.activeTeleportMode===AD.NONE||this.activeTeleportMode===AD.FORWARD);if(t)e.gamepad.axes[2]<0?(this.updateRotationTeleport(45),this.activeTeleportMode=AD.ROTATE_LEFT):(this.updateRotationTeleport(-45),this.activeTeleportMode=AD.ROTATE_RIGHT);else if(i)this.updateTeleportLocationAndPreview(e),this.activeTeleportMode=AD.FORWARD;else{if(this.activeTeleportMode!==AD.NONE){this.teleportPreview&&(this.teleportPreview.remove(),this.teleportPreview=null);const e=v.fromValues(this.xrTeleportLocation[0],this.xrTeleportLocation[1],this.xrTeleportLocation[2]);this.setModelTransform(this.getTransform(e,this.xrTeleportDirection))}this.activeTeleportMode=AD.NONE}return this.activeTeleportMode!==AD.NONE}updateRotationTeleport(e){const t=this.viewer.getXrController().getCamera().getViewMatrixInverse(),i=ge.rotateY(ge.create(),ge.create(),(0,Li.Yr)(e));ge.multiply(i,this.viewer.getXrController().lastXrViewMatrixInverse,i);const s=P.transformMat4(P.create(),[0,0,-1,0],i);this.xrTeleportDirection=P.transformMat4(P.create(),s,t),this.xrTeleportLocation=v.transformMat4(v.create(),[0,0,0],t)}updateTeleportLocationAndPreview(e){this.teleportPreview||(this.teleportPreview=new DD(this.viewer));const t=this.viewer.getDepthForXrInput(e.xrInputEvent);t<0&&It.log.debug("Teleport depth distance was negative: "+t.toFixed(3)),this.teleportPreview.show();const i=e.xrInputEvent.modelSpaceRay.evaluate(t);this.xrTeleportLocation=v.copy(v.create(),i);this.xrTeleportLocation[2]+=1.7;const s=P.transformMat4(P.create(),[0,0,-1,0],this.viewer.getXrController().lastXrViewMatrixInverse);this.xrTeleportDirection=P.transformMat4(P.create(),s,this.viewer.getXrController().getCamera().getViewMatrixInverse()),this.teleportPreview.updateLocation(i)}setModelTransform(e){this.viewer.getXrController().modelTransform=e}getTransform(e,t){const i=v.fromValues(t[0],t[1],0);v.normalize(i,i);const s=v.fromValues(0,0,1);return this.modelCamera.setViewPositionAndOrientation(e,i,s),this.modelCamera.getViewMatrix()}}const RD=new Qi({isShowThrough:!1,isPickable:!1,primitiveType:_i.MX.LINES});class wD extends Ri{constructor(e,t){super(e),this.graphicsId=wD.GRAPHICS_ID_PREFIX+t,this.setId(this.graphicsId)}getExplodeLineNodeProperties(){return RD}onAppearanceConstantsUpdated(){this.updateGraphics()}}wD.GRAPHICS_ID_PREFIX="EXPLODE_LINE_GRAPHICS_";const _D=q.default.getManager();class ND extends wD{constructor(e,t){super(e,t)}updateDefinition(e){e.startPosition&&e.center&&e.axis&&e.hasOwnProperty("angle")&&(this.startPosition=e.startPosition,this.arcCenter=e.center,this.arcAxis=e.axis,this.arcAngle=e.angle),this.updateGraphics()}updateGraphics(){const e=pe.S4.subtract(this.startPosition,this.arcCenter,v.create()),t=pe.S4.normalize(e,v.create()),i=pe.S4.length(e),s=this.arcAngle,n=_D.getNumber("EXPLODE_LINE_CIRCLE_SEGMENT_COUNT")*Math.abs(s-0)/(2*Math.PI),r=Du(this.arcCenter,i,this.arcAxis,t,0,s,n);Hu(1,r),Uu(_D.getColor("EXPLODE_LINE_COLOR"),r),ku(_D.getStipple("EXPLODE_LINE_STIPPLE"),r);const a=this.graphicsId+"_MESH_INCREMENT";this.updateMeshIncrement(a,yi,r,this.getExplodeLineNodeProperties())}}const bD=q.default.getManager();class LD extends wD{constructor(e,t){super(e,t),this.startPosition=null,this.endPosition=null}updateDefinition(e){this.startPosition=e.startPosition,this.endPosition=e.endPosition,this.updateGraphics()}updateGraphics(){const e=pu(this.startPosition,this.endPosition);Hu(1,e),Uu(bD.getColor("EXPLODE_LINE_COLOR"),e),ku(bD.getStipple("EXPLODE_LINE_STIPPLE"),e);const t=this.graphicsId+"_MESH_INCREMENT";this.updateMeshIncrement(t,yi,e,this.getExplodeLineNodeProperties())}}var FD=i(11365),xD=i(47851),BD=i(56849)},55029:function(e,t,i){i.d(t,{$o:function(){return L},AF:function(){return z},Ad:function(){return d},Ao:function(){return S},B$:function(){return ue},CD:function(){return Y},CW:function(){return j},Cu:function(){return _e},FE:function(){return f},HO:function(){return K},KU:function(){return b},Kb:function(){return Ae},Kf:function(){return Oe},LK:function(){return X},Lr:function(){return k},Oh:function(){return N},Ot:function(){return ge},S_:function(){return I},TE:function(){return ae},Tc:function(){return E},Tu:function(){return ye},Ux:function(){return ee},WW:function(){return R},Wm:function(){return Ee},Yr:function(){return J},_O:function(){return ve},_k:function(){return Pe},bZ:function(){return F},cP:function(){return Re},cl:function(){return ie},df:function(){return Ie},dm:function(){return ce},eB:function(){return de},fB:function(){return u},fE:function(){return x},g7:function(){return O},g9:function(){return Ce},iD:function(){return De},iK:function(){return T},iM:function(){return me},jP:function(){return pe},kB:function(){return D},nP:function(){return te},n_:function(){return se},o5:function(){return le},qm:function(){return q},r7:function(){return re},rQ:function(){return y},s9:function(){return m},sc:function(){return _},ss:function(){return W},tO:function(){return M},tV:function(){return ne},tl:function(){return p},tm:function(){return g},u3:function(){return he},uZ:function(){return Z},vG:function(){return Me},vu:function(){return w},w5:function(){return xe},wd:function(){return oe},xV:function(){return we},zD:function(){return Se},zH:function(){return A},zL:function(){return Te}});var s=i(96265),n=i(63903),r=i(80675),a=i(94128),o=i(79275),h=i(37754),c=i(54861);const l=[0,0,0];function u(e){return s.squaredLength(e)<Math.pow(h.W.MAX_MODEL_SIZE,2)}"undefined"!=typeof window&&(window.glMatrixArrayType=Array);const d=n.create();function g(e,t){return r.squaredLength(c.gv.subtract(e,t,r.create()))<h.W.ZERO_LENGTH_SQUARED}const p=53,m=Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:9007199254740991;function f(e,t,i){const n=s.dot(e,t),r=s.dot(c.S4.cross(e,t,s.create()),c.S4.normalize(i,s.create()));return Math.atan2(r,n)}function I(e){return e<0?Math.floor(e):Math.ceil(e)}function E(e){return e<0?Math.ceil(e):Math.floor(e)}function S(e,t,i,s){return!(e>t||i>s)&&(e<i?i<t-h.W.ZERO_LENGTH:e<s-h.W.ZERO_LENGTH)}var T;!function(e){e[e.LOW=0]="LOW",e[e.MID=.5]="MID",e[e.HIGH=1]="HIGH"}(T||(T={}));class M{constructor(){this.reset()}isInitialized(){for(let e=0;e<2;++e)if(this.min[e]>this.max[e])return!1;return!0}reset(){this.min=[1/0,1/0],this.max=[-1/0,-1/0]}set(e,t){r.copy(this.min,e),r.copy(this.max,t)}copyFrom(e){this.set(e.min,e.max)}add(e){const t=e.length;for(let i=0;i<t;++i)for(let t=0;t<2;++t)e[i][t]<this.min[t]&&(this.min[t]=e[i][t]),e[i][t]>this.max[t]&&(this.max[t]=e[i][t])}addPoint(e){for(let t=0;t<2;++t)e[t]<this.min[t]&&(this.min[t]=e[t]),e[t]>this.max[t]&&(this.max[t]=e[t])}addPointXY(e,t){e<this.min[0]&&(this.min[0]=e),e>this.max[0]&&(this.max[0]=e),t<this.min[1]&&(this.min[1]=t),t>this.max[1]&&(this.max[1]=t)}addBox(e){if(e.isInitialized())for(let t=0;t<2;++t)this.min[t]=Math.min(this.min[t],e.min[t]),this.max[t]=Math.max(this.max[t],e.max[t])}getDimensions(){return c.gv.subtract(this.max,this.min,r.create())}overlapsWith(e){return S(this.min[0],this.max[0],e.min[0],e.max[0])&&S(this.min[1],this.max[1],e.min[1],e.max[1])}contains(e){return e[0]>=this.min[0]&&e[1]>=this.min[1]&&e[0]<=this.max[0]&&e[1]<=this.max[1]}makeCenteredBoxOnPoint(e,t){const i=.5*t;this.min[0]=e[0]-i,this.min[1]=e[1]-i,this.max[0]=e[0]+i,this.max[1]=e[1]+i}center(e){return e=e||r.create(),c.gv.scale(c.gv.add(this.min,this.max,e),.5)}getCorners(e){if(!e){e=[];for(let t=0;t<4;++t)e.push(r.create())}for(let t=0;t<2;++t)for(let i=0;i<2;++i){const s=e[2*i+t];s[0]=0===t?this.min[0]:this.max[0],s[1]=0===i?this.min[1]:this.max[1]}return e}translate(e){c.gv.add(this.min,e,this.min),c.gv.add(this.max,e,this.max)}}const C=[0,0,0];class D{constructor(e,t){this.min=s.create(),this.max=s.create(),void 0!==e&&void 0!==t?this.set(e,t):this.reset()}clone(){return new D(this.min,this.max)}toString(){return"min: "+this.min+", max: "+this.max}makeSceneDebugObject(){let e="BoundingBox: ";if(this.isInitialized()){const t=[],i=[];for(let e=0;e<3;++e)t.push(this.min[e].toFixed(5)),i.push(this.max[e].toFixed(5));e+="(min: "+t+", max: "+i+")"}else e+="(Uninitialized)";return{text:e,children:[]}}getMin(){return s.clone(this.min)}getMax(){return s.clone(this.max)}set(e,t){s.copy(this.min,e),s.copy(this.max,t)}copyFrom(e){this.set(e.min,e.max)}reset(){this.set([1/0,1/0,1/0],[-1/0,-1/0,-1/0])}equals(e){for(let t=0;t<3;++t)if(this.min[t]!==e.min[t]||this.max[t]!==e.max[t])return!1;return!0}setInfinite(){this.set([-1/0,-1/0,-1/0],[1/0,1/0,1/0])}isInitialized(){for(let e=0;e<3;++e)if(this.min[e]>this.max[e])return!1;return!0}isInfinite(){for(let e=0;e<3;++e)if(this.min[e]===-1/0||this.max[e]===1/0)return!0;return!1}isFinite(){return this.isInitialized()&&!this.isInfinite()}areBoundDimensionsSmallerThan(e){for(let t=0;t<3;++t)if(this.max[t]-this.min[t]>=e)return!1;return!0}addPoint(e){for(let t=0;t<3;++t)e[t]<this.min[t]&&(this.min[t]=e[t]),e[t]>this.max[t]&&(this.max[t]=e[t])}addXYZ(e,t,i){e<this.min[0]&&(this.min[0]=e),e>this.max[0]&&(this.max[0]=e),t<this.min[1]&&(this.min[1]=t),t>this.max[1]&&(this.max[1]=t),i<this.min[2]&&(this.min[2]=i),i>this.max[2]&&(this.max[2]=i)}addPointArray(e){for(let t=0;t<e.length;++t)for(let i=0;i<3;++i)e[t][i]<this.min[i]&&(this.min[i]=e[t][i]),e[t][i]>this.max[i]&&(this.max[i]=e[t][i])}createTransformedCopy(e){const t=new D;return t.addBox(this,e),t}addBox(e,t,i){if(e&&e.isInitialized())if(e.isInfinite())this.setInfinite();else{if(i&&v.copyFrom(this),!t||se(t))this.addXYZ(e.min[0],e.min[1],e.min[2]),this.addXYZ(e.max[0],e.max[1],e.max[2]);else{const i=[e.min,e.max];for(let e=0;e<2;e++)for(let s=0;s<2;s++)for(let n=0;n<2;n++){const r=[i[e][0],i[s][1],i[n][2]];c.w$.multiplyVec3(t,r),this.addPoint(r)}}i&&!y(this)&&this.copyFrom(v)}}getCorners(){const e=[this.min,this.max],t=[];if(!this.isInitialized())return null;for(let i=0;i<2;i++)for(let n=0;n<2;n++)for(let r=0;r<2;r++)t.push(s.fromValues(e[i][0],e[n][1],e[r][2]));return t}getLocationInBox(e,t,i){return[Y(this.min[0],this.max[0],e),Y(this.min[1],this.max[1],t),Y(this.min[2],this.max[2],i)]}isExtensive(){for(let e=0;e<3;e++)if(Math.abs(this.max[e]-this.min[e])>h.W.ZERO_LENGTH)return!0;return!1}center(e){e||(e=s.create());const t=c.S4.add(this.min,this.max,e);return c.S4.scale(t,.5),t}diagonalVector(e){return e||(e=s.create()),c.S4.subtract(this.max,this.min,e)}diameter(){return c.S4.length(c.S4.subtract(this.max,this.min,C))}maxDimension(){const e=c.S4.subtract(this.max,this.min,s.create());return Math.max(Math.abs(e[0]),Math.max(Math.abs(e[1]),Math.abs(e[2])))}scale(e){const t=this.center();c.S4.subtract(this.max,t),c.S4.scale(this.max,e),c.S4.add(this.max,t),c.S4.subtract(this.min,t),c.S4.scale(this.min,e),c.S4.add(this.min,t)}dilate(e){const t=s.fromValues(e,e,e);c.S4.add(this.max,t),c.S4.subtract(this.min,t)}getXyBounds(){const e=new M;return e.set([this.min[0],this.min[1]],[this.max[0],this.max[1]]),e}}const v=new D;let P=!1;function y(e){return!!e&&(!!e.isInitialized()&&(!!e.areBoundDimensionsSmallerThan(h.W.MAX_BOUNDS_DIMENSION)||(P||(o.log.info("Found scenegraph node with very large bounds. It will be omitted from bounds computation"),P=!0),!1)))}class A{constructor(e,t){this.point=s.clone(e),this.direction=c.S4.normalize(t,s.create())}setPoint(e){this.point=s.clone(e)}setDirection(e){this.direction=c.S4.normalize(e,s.create())}evaluate(e,t){return c.S4.add(c.S4.scale(this.direction,e,t||s.create()),this.point)}findClosestPositionToOtherRay(e){const t=s.dot(this.direction,this.direction),i=s.dot(this.direction,e.direction),n=s.dot(e.direction,e.direction),r=t*n-i*i;if(Math.abs(r)<h.W.ZERO_ANGLE)return null;const a=c.S4.subtract(this.point,e.point,s.create()),o=s.dot(this.direction,a);return(i*s.dot(e.direction,a)-n*o)/r}findPositionOfPoint(e){return s.dot(this.direction,c.S4.subtract(e,this.point,s.create()))}}function O(e,t){const i=e[0]*t[0]+e[1]*t[1],s=Math.sqrt(e[0]*e[0]+e[1]*e[1]),n=Math.sqrt(t[0]*t[0]+t[1]*t[1]);if(s<=h.W.ZERO_LENGTH||n<=h.W.ZERO_LENGTH)return null;return i/(s*n)}function R(e,t,i){const s=i[0],n=i[1],r=(s*t[0]-s*e[0]+n*t[1]-n*e[1])/(s*s+n*n);t[0]=s*r+e[0],t[1]=n*r+e[1]}function w(e,t,i){const n=c.S4.subtract(t,e,s.create()),r=(s.dot(i,n)-s.dot(e,n))/s.squaredLength(n);return r<=0?(n[0]=e[0],n[1]=e[1],n[2]=e[2]):r>=1?(n[0]=t[0],n[1]=t[1],n[2]=t[2]):c.S4.add(c.S4.scale(n,r),e),n}function _(e){const t=s.create();t[0]=e[8],t[1]=e[9],t[2]=e[10];const i=s.create();i[0]=e[12],i[1]=e[13],i[2]=e[14];const n=s.dot(t,i),r=a.create();return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=-n,r}function N(e,t){let i=a.create();const s=a.create();return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1,i=c.w$.multiplyVec4(t,s,i),[i[0],i[1],i[2]]}function b(e,t){let i=a.create();const s=a.create();return s[0]=e[0],s[1]=e[1],s[2]=0,s[3]=1,i=c.w$.multiplyVec4(t,s,i),[i[0],i[1],i[2]]}function L(e,t){let i=a.create();const s=a.create();return s[0]=e[0],s[1]=e[1],s[2]=0,s[3]=0,i=c.w$.multiplyVec4(t,s,i),[i[0],i[1],i[2]]}function F(e,t,i){return x(e,_(t),i)}function x(e,t,i){const n=s.dot(e.point,t),r=s.dot(e.direction,t);if(i=i||h.W.ZERO_ANGLE,Math.abs(r)<i)return null;{const i=-(n+t[3])/r;return c.S4.linComb(e.point,1,e.direction,i,s.create())}}const B=s.create(),U=s.create(),V=s.create(),G=s.create(),H=s.create();function k(e,t,i){let n,r=!0;const a=B,o=U,h=V;for(n=0;n<3;++n)e.point[n]<t.min[n]?(a[n]=1,h[n]=t.min[n],r=!1):e.point[n]>t.max[n]?(a[n]=0,h[n]=t.max[n],r=!1):a[n]=2;if(r)return i=i||s.create(),s.copy(i,e.point),i;for(n=0;n<3;++n)2!==a[n]&&0!==e.direction[n]?o[n]=(h[n]-e.point[n])/e.direction[n]:o[n]=-1;let c=0;for(n=1;n<3;++n)o[c]<o[n]&&(c=n);if(o[c]<0)return null;for(i=i||s.create(),n=0;n<3;++n)if(c!==n){if(i[n]=e.point[n]+o[c]*e.direction[n],i[n]<t.min[n]||i[n]>t.max[n])return null}else i[n]=h[n];return i}function W(e,t,i,n){const r=s.dot(e.direction,e.direction),a=2*e.direction[0]*(e.point[0]-t[0])+2*e.direction[1]*(e.point[1]-t[1])+2*e.direction[2]*(e.point[2]-t[2]);let o=a*a-4*r*(s.dot(t,t)+s.dot(e.point,e.point)-2*s.dot(t,e.point)-i*i);if(o<-h.W.ZERO_LENGTH_SQUARED)return null;if(Math.abs(o)<h.W.ZERO_LENGTH_SQUARED){const t=-a/2*r;return e.evaluate(t,n)}{o=Math.sqrt(o);const t=(-a-o)/(2*r);return t<0&&(-a+o)/(2*r)<0?null:t<0?s.copy(n||s.create(),e.point):e.evaluate(t,n)}}function z(e,t,i,n){const r=1e-6,a=B,o=U,h=V,l=G,u=H;c.S4.subtract(i,t,a),c.S4.subtract(n,t,o),c.S4.cross(e.direction,o,h);const d=s.dot(a,h);if(d>-r&&d<r)return;const g=1/d;c.S4.subtract(e.point,t,u);const p=s.dot(u,h)*g;if(p<0||p>1)return;c.S4.cross(u,a,l);const m=s.dot(e.direction,l)*g;if(m<0||p+m>1)return;const f=s.dot(o,l);return f>r?f:void 0}function X(e,t,i,n){const r=c.S4.subtract(e,t,s.create());return[s.dot(r,n),s.dot(r,c.S4.cross(i,n,s.create()))]}function q(e,t,i,n){const r=c.S4.normalize(n,s.create()),a=c.S4.scale(r,e[0],s.create()),o=c.S4.scale(c.S4.cross(i,r,s.create()),e[1],s.create());return c.S4.add(t,c.S4.add(a,o,s.create()),s.create())}function Z(e,t,i){return Math.min(i,Math.max(e,t))}function Y(e,t,i){return(1-i)*e+i*t}function K(e,t){if(!e||0===e.length)return;const i=(t-Math.floor(t))*e.length,s=Math.floor(i),n=(s+1)%e.length,r=i-s;return Y(e[s],e[n],r)}function j(e,t,i){return(i=Z((i-e)/(t-e),0,1))*i*(3-2*i)}const Q=Math.PI/180,$=180/Math.PI;function J(e){return e*Q}function ee(e){return e*$}function te(e,t){if(e===t)return!0;const i=!!e;if(i!==!!t)return!1;if(!i)return!0;if(e.length!==t.length)return!1;for(let i=0;i<e.length;++i)if(Math.abs(e[i]-t[i])>=h.W.ZERO_LENGTH)return!1;return!0}const ie=te;function se(e){return!!e&&ie(e,d)}function ne(e,t){return e[0]*t[1]-e[1]*t[0]}function re(e,t){return[e[0]-t[0],e[1]-t[1]]}function ae(e,t,i,s,n){const r=[];return!!ce(e,t,i,s,r)&&(n[0]=e[0]+r[0]*t[0],n[1]=e[1]+r[0]*t[1],!0)}function oe(e,t,i,s,n){const r=[];return!!ce(e,t,i,[s[0]-i[0],s[1]-i[1]],r)&&(r[0]>=0&&r[1]>=0&&r[1]<=1&&(n[0]=i[0]+r[0]*t[0],n[1]=i[1]+r[0]*t[1],!0))}function he(e,t,i,s,n){const r=[t[0]-e[0],t[1]-e[1]],a=[];return!!ce(e,r,i,[s[0]-i[0],s[1]-i[1]],a)&&(a[0]>=0&&a[0]<=1&&a[1]>=0&&a[1]<=1&&(n[0]=e[0]+a[0]*r[0],n[1]=e[1]+a[0]*r[1],!0))}function ce(e,t,i,s,n){const r=ne(t,s);if(Math.abs(r)<h.W.ZERO_LENGTH)return!1;const a=re(i,e);return n[0]=ne(a,s)/r,n[1]=ne(a,t)/r,!0}function le(e,t,i){const s=[i[0],i[1]];return R(e,s,[t[0]-e[0],t[1]-e[1]]),s[0]<=Math.max(e[0],t[0])&&s[0]>=Math.min(e[0],t[0])&&s[1]<=Math.max(e[1],t[1])&&s[1]>=Math.min(e[1],t[1])?ue(i,s):Math.min(ue(i,e),ue(i,t))}function ue(e,t){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)}function de(e,t,i,s){i[0]=(e[0]+t[0])/2,i[1]=(e[1]+t[1])/2;const n=[t[0]-e[0],t[1]-e[1]],r=[n[1],-n[0]],a=Math.sqrt(r[0]*r[0]+r[1]*r[1]);return!(a<h.W.ZERO_LENGTH)&&(s[0]=r[0]/a,s[1]=r[1]/a,!0)}function ge(e,t){return[e[0],e[1],e[2],t]}function pe(e){return Math.abs(1-s.squaredLength(e))<=h.W.ZERO_LENGTH_SQUARED}function me(e,t){return t||(t=n.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=0,t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}const fe=[0,0,0];function Ie(e,t){if(Ce(e,fe),Math.abs(1-Math.abs(e[2]/fe[0]))>h.W.ZERO_ANGLE){t[1]=-Math.asin(e[2]/fe[0]);const i=Math.cos(t[1]);t[0]=Math.atan2(e[6]/(i*fe[1]),e[10]/(i*fe[2])),t[2]=Math.atan2(e[1]/(i*fe[0]),e[0]/(i*fe[0]))}else t[2]=0,e[2]<0?(t[1]=Math.PI/2,t[0]=t[2]+Math.atan2(e[4]/fe[1],e[8]/fe[2])):(t[1]=-Math.PI/2,t[0]=-t[2]+Math.atan2(-e[4]/fe[1],-e[8]/fe[2]))}function Ee(e){const t=Math.cos(e[0]),i=Math.sin(e[0]),s=Math.cos(e[1]),r=Math.sin(e[1]),a=Math.cos(e[2]),o=Math.sin(e[2]),h=n.create();return h[0]=s*a,h[1]=s*o,h[2]=-r,h[4]=i*r*a-t*o,h[5]=i*r*o+t*a,h[6]=i*s,h[8]=t*r*a+i*o,h[9]=t*r*o-i*a,h[10]=t*s,h}function Se(e,t,i,s){const r=n.create(),a=t[2]/e[2],o=t[3]/e[3];c.w$.scale(r,[a,o,1]);const h=e[0]-i+e[2]/2,l=e[1]-s+e[3]/2,u=1-2*h/t[2],d=2*l/t[3]-1;return c.w$.translate(r,[u,d,0]),r}function Te(e,t,i){const s=i-(t[1]+t[3]);return Se(e,t,t[0],s)}function Me(e,t){return Se(e,t,0,0)}function Ce(e,t){for(let i=0;i<3;++i){for(let t=0;t<3;++t)l[t]=e[4*i+t];t[i]=c.S4.length(l)}}function De(e,t,i){const s=Math.cos(i),n=Math.sin(i);return[e[0]+s*t,e[1]+n*t]}function ve(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])}function Pe(e,t){return e-2*Math.round((e-t)/(2*Math.PI))*Math.PI}function ye(e,t){return e-2*Math.floor((e-t)/(2*Math.PI))*Math.PI}function Ae(e,t){return e+2*Math.floor((t-e)/(2*Math.PI))*Math.PI}function Oe(e,t,i,s){let n;return s-i<2*Math.PI?(n=ye(e,i),n>s&&(n=ye(n,s)-s>ye(i,n)-n?i:s)):(n=Pe(e,t),n>s?n=ye(n,i):n<i&&(n=Ae(n,s))),n}function Re(e){let t=1;for(;t<e;)t*=2;return t}function we(e){return e.length?_e(e):Number.isFinite(e)}function _e(e){for(let t=0;t<e.length;++t)if(!Number.isFinite(e[t]))return!1;return!0}const Ne=1023,be=511,Le=1/be;function Fe(e){return e>be?e-1024:e}function xe(e,t){const i=new Float32Array(3*e.length);let s=0;for(let n=0;n<e.length;++n){const r=t?t[n]*Le:Le,a=0|e[n];i[s++]=Fe(a&Ne)*r,i[s++]=Fe(a>>10&Ne)*r,i[s++]=Fe(a>>20&Ne)*r}return i}},16739:function(e,t,i){i.d(t,{D:function(){return l},z:function(){return s}});var s,n=i(40620),r=i(50568),a=i(79275),o=i(41810),h=i(80675),c=i(54861);!function(e){e[e.UNKNOWN=-10]="UNKNOWN",e[e.REDUCED_DIMENSION_PRIORITY=-1]="REDUCED_DIMENSION_PRIORITY",e[e.CONSTRUCTION_PLANE=0]="CONSTRUCTION_PLANE",e[e.CONSTRUCTION_PLANE_EDGE=1]="CONSTRUCTION_PLANE_EDGE",e[e.PART_FACE=5]="PART_FACE",e[e.NON_MODIFIABLE_FACE=7]="NON_MODIFIABLE_FACE",e[e.NON_MODIFIABLE_EDGE=8]="NON_MODIFIABLE_EDGE",e[e.NON_MODIFIABLE_VERTEX=9]="NON_MODIFIABLE_VERTEX",e[e.SKETCH_FACE=10]="SKETCH_FACE",e[e.ORIGIN=15]="ORIGIN",e[e.SECTION_PLANE=16]="SECTION_PLANE",e[e.PART_EDGE=20]="PART_EDGE",e[e.POINT_BODY=25]="POINT_BODY",e[e.PART_VERTEX=30]="PART_VERTEX",e[e.DIMENSION=45]="DIMENSION",e[e.MATE_CONNECTOR=46]="MATE_CONNECTOR",e[e.DEGENERATE_SKETCH_EDGE=47]="DEGENERATE_SKETCH_EDGE",e[e.SKETCH_EDGE=50]="SKETCH_EDGE",e[e.INACTIVE_SKETCH_VERTEX=59]="INACTIVE_SKETCH_VERTEX",e[e.ACTIVE_SKETCH_VERTEX_CONSTRAINED=60]="ACTIVE_SKETCH_VERTEX_CONSTRAINED",e[e.ACTIVE_SKETCH_VERTEX_UNCONSTRAINED=61]="ACTIVE_SKETCH_VERTEX_UNCONSTRAINED",e[e.UI=70]="UI"}(s||(s={}));class l{constructor(e,t,i,s){this.occurrenceId=t,this.location=i,this.usage=s,this.deterministicId=null,this.partId=null,this.locationCount=1,this.locationsSinceSample=0,this.distance=1,this.coverage=0,this.fromPass=0,this.isFromActiveSketch=!1,this.entityMetaData=null,this.bodyMetaData=null,this.uiSelection=null,this.occurrence=null,this.featureIdList=null,this.isPickThrough=null,this.primitiveId=e.slice(0),this.locationSum=h.clone(i),this.locationSamples=[this.location],this.pickedOccurrenceId=t}incorporateLocation(e){c.gv.add(this.locationSum,e,this.locationSum),++this.locationCount;const t=this.locationSamples.length<10?5:this.locationSamples.length<20?50:500;this.locationsSinceSample>=t?(this.locationSamples.push(e),this.locationsSinceSample=0):++this.locationsSinceSample}determineBestLocation(){const e=c.gv.scale(this.locationSum,1/this.locationCount,h.create());let t=1/0;for(let i=0;i<this.locationSamples.length;++i){const s=c.gv.distanceSquared(e,this.locationSamples[i]);s<t&&(this.location=this.locationSamples[i],t=s)}}isUIPick(){return!!this.uiSelection}getUISelection(){return this.uiSelection?this.uiSelection.uiElement:null}isEntityPick(){return!!this.entityMetaData}isBodyPick(){return!!this.bodyMetaData}isModelPick(){return this.isBodyPick()||this.isEntityPick()}getBodyId(){return this.bodyMetaData?this.bodyMetaData.id:this.entityMetaData?this.entityMetaData.getBodyId():null}getOccurrence(){return this.occurrence}getId(){return this.primitiveId+n.ID_SEPARATOR+this.occurrenceId}getModelSelection(){if(this.isEntityPick())return new r.Y1(o.lQt.ENTITY,this.deterministicId,this.occurrence,{entityMetaData:this.entityMetaData,source:r.Hw.PICK,sourcePick:this,usage:this.usage,featureIdList:this.featureIdList,name:this.entityMetaData.getName()});if(this.isBodyPick())return new r.Y1(o.lQt.BODY,this.deterministicId,this.occurrence,{bodyMetaData:this.bodyMetaData,source:r.Hw.PICK,sourcePick:this,usage:this.usage,name:this.bodyMetaData.getName()});const e=this.isUIPick()?this.uiSelection.getModelSelection():null;return e&&(e.sourcePick||(e.sourcePick=this),e.source=r.Hw.PICK,e.usage=this.usage),e}getPickPriority(){if(this.isUIPick()){const e=this.uiSelection.getPickPriority();return null!==e?e:s.UI}if(this.entityMetaData){if(this.entityMetaData.isFromOrigin())return s.ORIGIN;if(this.entityMetaData.isPointEntity())return s.POINT_BODY;if(this.entityMetaData.isFromSketch()){if(this.entityMetaData.isFace())return s.SKETCH_FACE;if(this.entityMetaData.isEdge())return s.SKETCH_EDGE;if(this.entityMetaData.isDegenerateEdge())return s.DEGENERATE_SKETCH_EDGE;{if(!this.isFromActiveSketch)return s.INACTIVE_SKETCH_VERTEX;const e=this.entityMetaData.getSketchSolveStatus();return e===o.ea7.FIXED||e===o.ea7.OVER_DEFINED||e===o.ea7.WELL_DEFINED?s.ACTIVE_SKETCH_VERTEX_CONSTRAINED:s.ACTIVE_SKETCH_VERTEX_UNCONSTRAINED}}if(this.entityMetaData.isFromBody())return this.entityMetaData.getBodyMetaData()&&!this.entityMetaData.getBodyMetaData().isModifiableBody()?this.entityMetaData.isFace()?s.NON_MODIFIABLE_FACE:this.entityMetaData.isEdge()?s.NON_MODIFIABLE_EDGE:s.NON_MODIFIABLE_VERTEX:this.entityMetaData.isFace()?s.PART_FACE:this.entityMetaData.isEdge()?s.PART_EDGE:s.PART_VERTEX}return s.UNKNOWN}getIncrementId(){if(this.isModelPick()){if(this.deterministicId)return this.deterministicId;a.log.warn("Found a model pick without a valid entity id")}else{if(this.uiSelection)return this.uiSelection.meshIncrementId;if(this.primitiveId)return this.primitiveId.toString();a.log.warn("Found a pick without an owner from which to retrieve an increment id")}return""}getEntityMetaData(){if(this.entityMetaData)return this.entityMetaData;const e=this.getModelSelection();return e?e.getEntityMetaData():null}getDeterministicId(){if(this.deterministicId)return this.deterministicId;const e=this.getModelSelection();return e?e.getDeterministicId():""}setIsPickThrough(e){this.isPickThrough=e}canPickThrough(e,t,i){if(i&&i.pickHiddenOccurrences&&t.isPickFromHiddenOccurrence(this))return!0;if(null===this.isPickThrough)if(this.uiSelection)this.isPickThrough=this.uiSelection.canPickThrough();else{const s=this.getEntityMetaData();if(s){let n=s.isTranslucent();if(!!i&&i.altKey&&s.isFromBody()&&s.isFace()){const e=t.getModelViewManagers().getManagerForUsage(this.usage).getPartStudioDataFromOccurrence(this.occurrence).getBodyComponent().getFaceColor(this.deterministicId,this.occurrenceId);n=!!e&&e[3]<1}this.isPickThrough=n&&e!==o.P1.HIDDEN_LINE_REMOVED||s.isFromSketch()}else this.isPickThrough=!1}return this.isPickThrough}getOccurrenceId(){return this.occurrenceId}}},50098:function(e,t,i){i.d(t,{G:function(){return r},Z:function(){return a}});var s=i(50568),n=i(16739);function r(e,t){if(!e&&!t)return 0;if(e&&!t)return-1;if(!e&&t)return 1;const i=e.getPickPriority(),r=t.getPickPriority();if(i>r)return-1;if(i<r)return 1;if(i!==n.z.INACTIVE_SKETCH_VERTEX&&i!==n.z.ACTIVE_SKETCH_VERTEX_CONSTRAINED&&i!==n.z.ACTIVE_SKETCH_VERTEX_UNCONSTRAINED){if(e.fromPass<t.fromPass)return-1;if(e.fromPass>t.fromPass)return 1}const a=(1+e.distance)*(1-e.coverage),o=(1+t.distance)*(1-t.coverage);if(a<o)return-1;if(a>o)return 1;if((i===n.z.INACTIVE_SKETCH_VERTEX||i===n.z.ACTIVE_SKETCH_VERTEX_CONSTRAINED||i===n.z.ACTIVE_SKETCH_VERTEX_UNCONSTRAINED)&&e.deterministicId&&t.deterministicId){const i=s.X8.unpackDetId(e.deterministicId),n=s.X8.unpackDetId(t.deterministicId);if(i.operationIdx<n.operationIdx)return-1;if(i.operationIdx>n.operationIdx)return 1;if(i.entityIdx<n.entityIdx)return-1;if(i.entityIdx>n.entityIdx)return 1}return 0}function a(e,t){return e.sort(((e,i)=>{const s=e.getModelSelection(),n=i.getModelSelection();if(!s||!n)return r(e,i);if(s.isPlane()||n.isPlane())return r(e,i);if(s.isFace()!==n.isFace())return r(e,i);const a=t(e);return a===t(i)?r(e,i):a?1:-1}))}},49635:function(e,t,i){i.d(t,{C:function(){return S},O:function(){return E}});var s=i(56849),n=i(34444),r=i(78591),a=i(29138),o=i(47851),h=i(91275),c=i(40219),l=i(13762),u=i(96265),d=i(94128),g=i(63903),p=i(54861),m=i(65583),f=i(48820),I=i(50568);class E extends r.UIElement{constructor(e,t,i,s,n,a=1){super(n),this.normal=e,this.tangent=t,this.center=i,this.elementConnection=s,this.faceSize=a,this.isPreSelected=!1,this.isSelected=!1,this.isHiddenFromPick=!1,this.manipulator=null,this.inversePreManipulationMatrix=null,this.preManipulationCenter=null,this.preManipulationNormal=null,this.preManipulationTangent=null,this.inferredCenter=null,this.label=-1,this.isManipulatorRemovedOnDeselection=!0,this.editSubject=new m.x,this.listenTo(this,r.UiEvents.CLICK+o.s_,this.onClick),this.listenTo(this,r.UiEvents.MOUSE_ENTER+o.s_,this.onMouseEnter),this.listenTo(this,r.UiEvents.MOUSE_LEAVE+o.s_,this.onMouseLeave),this.listenTo(this,r.UiEvents.SELECT+o.s_,this.onSelect),this.listenTo(this,r.UiEvents.DESELECT+o.s_,this.onDeselect),this.listenTo(this,r.UiEvents.DOUBLE_CLICK+o.s_,this.onDoubleClick),this.center=u.clone(i),e.length<4?this.normal=d.fromValues(e[0],e[1],e[2],0):this.normal=d.clone(e),t.length<4?this.tangent=d.fromValues(t[0],t[1],t[2],0):this.tangent=d.clone(t)}getSelection(e,t){return new r.UISelection(this,o.s_,"")}getPickPriority(e){return r.PickPriority.SECTION_PLANE}shouldBeClearedWithSelections(){return!1}allowSelection(){const e=this.viewer.getModelViewManagers().getManager().hasActiveSketch(),t=!(0,r.isUsageBase)();return!o.X5&&!e&&!t}onClick(e,t,i){(0,a.Ky)().sectionPlaneToFocus=this,(0,a.Ky)().pickOnSectionPlaneToFocus=e.sourcePick,i.requestSelectedStatus=this.allowSelection()}onTriadDoubleClick(e,t){var i;(null===(i=(0,a.Ky)())||void 0===i?void 0:i.hasFaceEntities())||this.onDoubleClick(t)}onDoubleClick(e){(0,a.Ky)().sectionPlaneToFocus=this,(0,a.Ky)().pickOnSectionPlaneToFocus=e.sourcePick,(0,c.m)().trigger(l.C.EDIT_SECTION_VIEW)}onMouseEnter(){this.isPreSelected=this.allowSelection(),(0,r.requestDraw)()}onMouseLeave(){this.isPreSelected=!1,(0,r.requestDraw)()}isInteractionEnabled(){return this.allowSelection()}setupManipulator(e){e||(e=this.getSelection()),this.manipulator?this.checkAndCreateInferenceControllerIfNeeded():this.createManipulator(e)}onSelect(e){this.isSelected=!0,this.setupManipulator(e),(0,r.requestDraw)()}listenToManipulator(e){this.listenTo(e,s.w0.DOUBLE_CLICKED,this.onTriadDoubleClick),this.listenTo(e,s.w0.REPOSITION_START,this.onRepositionStart),this.listenTo(e,s.w0.REPOSITION_END,this.onRepositionEnd),this.listenTo(e,s.w0.ENTER_INFERENCE,this.onEnterInference),this.listenTo(e,s.w0.LEAVE_INFERENCE,this.onLeaveInference),this.listenTo(e,h.Wb.CLICKED,this.onManipulatorClicked),this.listenTo(e,s.w0.ROTATION_START,this.onRotationStart),this.listenTo(e,s.w0.ROTATION_CHANGE,this.onRotationChange),this.listenTo(e,s.w0.ROTATION_EDIT,this.onRotationEdit),this.listenTo(e,s.w0.ROTATION_END,this.onRotationEnd),this.listenTo(e,s.w0.TRANSLATION_START,this.onTranslationStart),this.listenTo(e,s.w0.TRANSLATION_CHANGE,this.onTranslationChange),this.listenTo(e,s.w0.TRANSLATION_EDIT,this.onTranslationEdit),this.listenTo(e,s.w0.TRANSLATION_END,this.onTranslationEnd),this.listenTo((0,I.vi)(),"reset",this.onDeselect)}createManipulator(e){let t=this.center;const i=e.sourcePick?e.sourcePick.location:null;if(i){const e=this.viewer.getCamera().getRay(i[0],i[1]),s=(0,r.intersectRayPlane)(e,this.getWorldSpacePlaneEquation());s&&(t=s)}this.manipulator=new r.Triad(this.viewer,h.Ak.PLANE,{displayEditView:!0}),this.manipulator.updateDefinition(this.getWorldSpaceMatrix(t)),this.viewer.getEventDispatcher().trigger(r.CREATE_SECTION_PLANE_INFERENCE_CONTROLLER,this.manipulator,this.elementConnection),this.listenToManipulator(this.manipulator),this.previewStateChangeSubscription=(0,r.getEditState)().stateChangedObservable.pipe((0,f.h)((e=>e===r.Events.PREVIEW_STATE_CHANGE))).subscribe((()=>this.onPreviewStateChange()))}onRepositionStart(){const e=this.checkAndCreateInferenceControllerIfNeeded();null!==e&&e.startInferencing(),this.preManipulationCenter=this.center,this.editSubject.next(!1)}checkAndCreateInferenceControllerIfNeeded(){const e=n._3.getOpenDocumentController();if(!e)return null;const t=e.getSectionPlaneInferenceControllerManager();return t&&t.activeManipulator!==this.manipulator?(this.viewer.getEventDispatcher().trigger(r.CREATE_SECTION_PLANE_INFERENCE_CONTROLLER,this.manipulator,this.elementConnection),t.activeController):null}onRepositionEnd(){this.inferredCenter?(this.center=this.inferredCenter,(0,a.P_)(!0)):this.manipulator.updateOrigin(this.preManipulationCenter),this.inferredCenter=null,this.editSubject.next(!0)}onEnterInference(e){this.inferredCenter=e}onLeaveInference(){this.inferredCenter=null}onPreviewStateChange(){(0,r.isUsageBase)()||this.onDeselect()}onDeselect(){this.manipulator&&(this.getIsManipulatorRemovedOnDeselection()?this.destroyManipulator():this.manipulator.removeEditViewAndHighlights()),this.isSelected=!1,(0,r.requestDraw)()}destroyManipulator(){this.manipulator&&(this.stopListening(this.manipulator),this.previewStateChangeSubscription.unsubscribe(),this.manipulator.remove(),this.manipulator=null,this.viewer.getEventDispatcher().trigger(r.DESTROY_SECTION_PLANE_INFERENCE_CONTROLLER))}getIsManipulatorRemovedOnDeselection(){return this.isManipulatorRemovedOnDeselection}setIsManipulatorRemovedOnDeselection(e){this.isManipulatorRemovedOnDeselection=e}rotationStart(e){this.preManipulationCenter=u.fromValues(this.center[0],this.center[1],this.center[2]),this.preManipulationNormal=d.fromValues(this.normal[0],this.normal[1],this.normal[2],0),this.preManipulationTangent=d.fromValues(this.tangent[0],this.tangent[1],this.tangent[2],0),this.inversePreManipulationMatrix=p.w$.inverse(e,g.create())}onManipulatorClicked(e){if(e instanceof r.Linear){const e=this.manipulator,t=g.clone(e.transform),i=0;e.processUpdateFromAngularManipulator(i,t,Math.PI),this.onRotationEdit(t);const s=e.linearManipulators[0];if(s){const e=s.initialRay;if(e){const t=p.S4.scale(e.direction,-1,u.create());s.initialRay=new r.Ray(e.point,t)}}}}onRotationStart(){this.rotationStart(this.manipulator.transform),this.editSubject.next(!1)}onRotationChange(){const e=p.w$.multiply(this.manipulator.transform,this.inversePreManipulationMatrix,g.create());this.center=p.w$.multiplyVec3(e,this.preManipulationCenter,u.create()),this.normal=p.w$.multiplyVec4(e,this.preManipulationNormal,d.create()),this.tangent=p.w$.multiplyVec4(e,this.preManipulationTangent,d.create()),(0,a.P_)(!0)}onRotationEdit(e){this.rotationStart(e),this.onRotationChange(),this.editSubject.next(!0)}onRotationEnd(){this.editSubject.next(!0)}equals(e){return(0,r.areVectorsEqual)(this.normal,e.normal)&&(0,r.areVectorsEqual)(this.tangent,e.tangent)&&(0,r.areVectorsEqual)(this.center,e.center)}onTranslationStart(){this.preManipulationCenter=u.fromValues(this.center[0],this.center[1],this.center[2]),this.editSubject.next(!1)}onTranslationChange(e){p.S4.add(this.preManipulationCenter,e,this.center),(0,a.P_)(!0)}onTranslationEdit(e){this.onTranslationStart(),this.onTranslationChange(e),this.editSubject.next(!0)}onTranslationEnd(){this.editSubject.next(!0)}onRemove(){this.onDeselect()}getWorldSpacePlaneEquation(){const e=u.dot(this.normal,this.center);return d.fromValues(this.normal[0],this.normal[1],this.normal[2],-e)}getWorldSpaceMatrix(e){const t=p.S4.cross(this.tangent,this.normal,u.create());return g.fromValues(this.tangent[0],this.tangent[1],this.tangent[2],0,t[0],t[1],t[2],0,-this.normal[0],-this.normal[1],-this.normal[2],0,e[0],e[1],e[2],1)}getCameraSpacePlaneEquation(e,t){const i=p.w$.multiplyVec4(e,this.normal,d.create()),s=u.dot(i,t);return d.fromValues(i[0],i[1],i[2],-s)}getCameraSpaceTangent(e){return p.w$.multiplyVec4(e,this.tangent,d.create())}getCameraSpaceCenter(e){return p.w$.multiplyVec3(e,this.center,u.create())}getPlaneMatrix(e){e||(e=g.create()),e[0]=this.tangent[0],e[1]=this.tangent[1],e[2]=this.tangent[2],e[3]=0;const t=u.create(),i=u.create();return p.S4.cross(this.normal,this.tangent,i),p.S4.normalize(i,t),e[4]=t[0],e[5]=t[1],e[6]=t[2],e[7]=0,e[8]=this.normal[0],e[9]=this.normal[1],e[10]=this.normal[2],e[11]=0,e[12]=this.center[0],e[13]=this.center[1],e[14]=this.center[2],e[15]=1,e}getViewManipulatorOrigin(e){return e||(e=u.create()),e[0]=this.manipulator?this.manipulator.transform[12]:this.center[0],e[1]=this.manipulator?this.manipulator.transform[13]:this.center[1],e[2]=this.manipulator?this.manipulator.transform[14]:this.center[2],e}getEditObservable(){return this.editSubject.asObservable()}isMeshIncrementCoplanar({points:e},t){const i=u.create();for(let s=0;s<e.length;s+=3)if(i[0]=e[s]-this.center[0],i[1]=e[s+1]-this.center[1],i[2]=e[s+2]-this.center[2],Math.abs(u.dot(i,this.normal))>t)return!1;return!0}}function S(e){const t=e.getUISelectionManager().getSelection();if(t&&t.selectionId===o.s_&&t.uiElement instanceof E&&(t.uiElement.isSelected||t.uiElement.isPreSelected))return t.uiElement}},29138:function(e,t,i){i.d(t,{aA:function(){return k},oj:function(){return V},cP:function(){return J},ny:function(){return Ie},HX:function(){return ie},Lz:function(){return te},tz:function(){return ee},Ky:function(){return z},nL:function(){return j},j1:function(){return U},tb:function(){return fe},qT:function(){return $},ti:function(){return De},WC:function(){return se},rv:function(){return ve},OR:function(){return _e},p$:function(){return Le},bm:function(){return Fe},Mi:function(){return ye},eQ:function(){return Pe},Wh:function(){return Re},F6:function(){return Ce},qf:function(){return ne},v5:function(){return Me},UB:function(){return Te},X9:function(){return Ae},o_:function(){return Oe},jf:function(){return ce},Rb:function(){return Be},rH:function(){return Ue},CF:function(){return H},hJ:function(){return Ee},N3:function(){return Se},P_:function(){return B},qS:function(){return le},cV:function(){return ge},fI:function(){return de},le:function(){return ue}});var s=i(32435),n=i(93249),r=i(66246),a=i(79275),o=i(50568),h=i(11315),c=i(41810),l=i(61090),u=i(47851),d=i(49635),g=i(61794),p=i(5651),m=i(77484),f=i(43310),I=i(78967),E=i(63903),S=i(96265),T=i(94128),M=i(54861),C=i(40219),D=i(13762),v=i(65583),P=i(30035),y=i(78591);const A=new y.NodeProperties({primitiveType:y.PrimitiveType.LINES,isPickable:!0,isHighlightable:!0,isTwoSided:!0,isShowThrough:!1,isVisible:!0,zOffset:n.default.getManager().getNumber("SECTION_EDGES_Z_OFFSET")}),O=new y.NodeProperties({primitiveType:y.PrimitiveType.POINTS,isPickable:!0,isHighlightable:!0,isTwoSided:!0,isShowThrough:!1,isVisible:!1,isSectionEntity:!0,zOffset:n.default.getManager().getNumber("SECTION_POINTS_Z_OFFSET")}),R=new y.NodeProperties({primitiveType:y.PrimitiveType.TRIANGLE_STRIP,isPickable:!0,isHighlightable:!0,isVisible:!0,zOffset:n.default.getManager().getNumber("PART_FACES_Z_OFFSET"),pickZOffset:n.default.getManager().getNumber("SECTION_FACES_Z_OFFSET")});let w=null;function _(){return null===w&&(w=new Map([[y.PrimitiveType.LINES,{nodeProperties:A,entityType:c.ZSW.EDGE,pickPriority:y.PickPriority.PART_EDGE}],[y.PrimitiveType.POINTS,{nodeProperties:O,entityType:c.ZSW.VERTEX,pickPriority:y.PickPriority.PART_VERTEX}],[y.PrimitiveType.TRIANGLE_STRIP,{nodeProperties:R,entityType:c.ZSW.FACE,pickPriority:y.PickPriority.PART_FACE}]])),w}class N extends y.UIElement{constructor(e,t,i){super(i),this.elementId=e,this.state=t,this.incrementData=new Map,this.hasFace=!1,this.isCleaningUp=!1,this.selectedEntities=new Set,this.preselectedEntities=new Set,this.secondarySelectedEntities=new Set,this.sectionPlaneSelections=[],this.selectionLists={selection:(0,o.vi)(),preselection:(0,o.Wf)(),secondary:(0,o.wT)()},this.initializePlaneSelectionCounts(),this.listenToSelectionLists(),this.listenTo(this.viewer.getIsolatedOccurrenceManager(),y.IsolatedOccurrencesManager.IS_ISOLATE_FULLY_TRANSPARENT_CHANGED_EVENT,this.updateEntityVisibility)}initializePlaneSelectionCounts(){for(const e of this.state.getSectionPlanes())this.sectionPlaneSelections.push(0)}incrementPlaneSelectionCount(e,t){const i=this.sectionPlaneSelections[e];if(0===i){const i=this.state.getSectionPlanes()[e];null==i||i.onDeselect(),null==i||i.setupManipulator(t)}this.sectionPlaneSelections[e]=i+1}decrementPlaneSelectionCount(e){const t=this.sectionPlaneSelections[e],i=Math.max(0,t-1);if(this.sectionPlaneSelections[e]=i,0===i){const t=this.state.getSectionPlanes()[e];null==t||t.onDeselect()}}getHighlightType(e){return e===this.selectionLists.preselection?y.HighlightType.PRE:e===this.selectionLists.secondary?y.HighlightType.SECONDARY:y.HighlightType.ENTITY}getSelectedSetFromSelectionList(e){return e===this.selectionLists.preselection?this.preselectedEntities:e===this.selectionLists.secondary?this.secondarySelectedEntities:this.selectedEntities}findAssociatedPlaneIndex(e){const t=this.state.getSectionPlanes();let i=-1;return t.forEach(((t,s)=>{t.isMeshIncrementCoplanar(e,1e-5)&&(i=s)})),i}getSelectedFaceEntityForAlignment(){for(const e of this.preselectedEntities)return e;for(const e of this.selectedEntities)return e;return null}onSelectFace(e,t,i){this.getSelectedSetFromSelectionList(i).add(e),this.isCleaningUp||i===this.selectionLists.selection&&this.incrementPlaneSelectionCount(e.associatedPlaneIndex,t)}onDeselectFace(e,t){this.getSelectedSetFromSelectionList(t).delete(e),this.isCleaningUp||t===this.selectionLists.selection&&this.decrementPlaneSelectionCount(e.associatedPlaneIndex)}handleChangeSelectionList({list:e,selection:t,doAdd:i,doDraw:s=!0}){if(!t.isSectionEntity())return;const n=t.getIdString(),r=this.getHighlightType(e),a=this.addHighlightToSection(r,n);i?(null==a?void 0:a.entityType)===c.ZSW.FACE&&this.onSelectFace(a,t,e):((null==a?void 0:a.entityType)===c.ZSW.FACE&&this.onDeselectFace(a,e),this.removeHighlightFromSection(r,n)),s&&this.viewer.requestDraw()}clearHighlightsOfType(e){for(const t of this.incrementData.values()){const i=t.highlights.get(e);void 0!==i&&(this.removeHighlightFromIncrement(t.incrementId,i),t.highlights.delete(e))}}handleResetSelectionList(e){const t=this.getHighlightType(e);this.clearHighlightsOfType(t);if(this.getSelectedSetFromSelectionList(e).clear(),e===this.selectionLists.selection)for(let e=0;e<this.sectionPlaneSelections.length;e+=1)this.sectionPlaneSelections[e]=0;e.forEach((t=>{this.handleChangeSelectionList({list:e,selection:t,doAdd:!0,doDraw:!1})})),this.viewer.requestDraw()}listenForChangesToSelectionList(e){this.listenTo(e,"add",(t=>{this.handleChangeSelectionList({list:e,selection:t,doAdd:!0})})),this.listenTo(e,"remove",(t=>{this.handleChangeSelectionList({list:e,selection:t,doAdd:!1})})),this.listenTo(e,"reset",(()=>{this.handleResetSelectionList(e)}))}listenToSelectionLists(){this.listenForChangesToSelectionList(this.selectionLists.preselection),this.listenForChangesToSelectionList(this.selectionLists.selection),this.listenForChangesToSelectionList(this.selectionLists.secondary)}getBodyId(e,t){var i,s;return null!==(s=null===(i=e.occurrenceList[t])||void 0===i?void 0:i.getPathAsString())&&void 0!==s?s:e.partIds[t]}getFullId(e,t){const i=this.getBodyId(e,t);return`${c.FBt.SECTION_IDENTIFIER}-${i}`}getEntityTypeFromPrimitiveType(e){var t,i;return null!==(i=null===(t=_().get(e))||void 0===t?void 0:t.entityType)&&void 0!==i?i:c.ZSW.UNKNOWN}getColor(e){const t=this.viewer.getModelViewManagers().getManager();return e.occurrence?t.getOccurrenceColor(e.occurrence):e.partId?t.getPartColor(e.partId):null}populate(e){e.entities.forEach(((t,i)=>{const s=this.getFullId(e,i);t.forEach(((t,n)=>{t.tessellation.forEach(((t,r)=>{var a;const o=(0,y.createMeshIncrementForEntityData)(t),h=`${c.FBt.ID}${i}-${n}-${r}`,l=`${c.FBt.ID}${n}-${r}`,u=`${s}-${l}`,d=null===(a=_().get(o.primitiveType))||void 0===a?void 0:a.nodeProperties;if(d){const s={incrementId:h,selectionId:u,primitiveType:d.primitiveType,entityType:this.getEntityTypeFromPrimitiveType(d.primitiveType),highlights:new Map,occurrence:e.occurrenceList[i],partId:e.partIds[i],metadata:this.createEntityMetadata(h,t),meshIncrement:o};if(s.entityType===c.ZSW.FACE){const e=this.findAssociatedPlaneIndex(o);-1!==e&&(s.associatedPlaneIndex=e);const t=this.getColor(s);this.hasFace=!0,t&&(0,y.addColorToIncrement)(t,o)}this.incrementData.set(u,s),this.updateMeshIncrement(h,u,o,d)}}))}))})),this.updateEntityVisibility()}hasFaceEntities(){return this.hasFace}createEntityMetadata(e,t){const i=new c.kdl;return i.setBodyId(e),i.setGeometry(t),i}getMeshIncrementForUISelection(e){var t;const i=this.getInstantiatedMeshIncrement(e.meshIncrementId);return null!==(t=null==i?void 0:i.meshIncrement)&&void 0!==t?t:null}getPickPriority(e){var t;const i=this.getMeshIncrementForUISelection(e);let s=null;return i&&(s=null===(t=_().get(i.primitiveType))||void 0===t?void 0:t.pickPriority),null!=s?s:y.PickPriority.UNKNOWN}getModelSelection(e){const t=new o.Y1(c.lQt.ENTITY,e.selectionId,(0,r._R)()?new c._oC:null,{sourcePick:e.sourcePick}),i=this.findIncrementData(e.selectionId);return i&&(t.setNameFromSectionDetails({entityType:i.entityType,partId:i.partId,occurrence:i.occurrence,elementId:this.elementId}),t.entityMetaData=i.metadata),t}getEntityMetaData(e){var t,i;return null!==(i=null===(t=this.findIncrementData(e))||void 0===t?void 0:t.metadata)&&void 0!==i?i:null}findIncrementData(e){var t;return null!==(t=this.incrementData.get(e))&&void 0!==t?t:null}addHighlightToSection(e,t){const i=this.viewer.getHighlightManager(y.BTGraphicsUsage.BASE).createHighlightForSelection(e,t),s=this.findIncrementData(t);return s?(s.highlights.has(e)&&(this.removeHighlightFromIncrement(s.incrementId,s.highlights.get(e)),s.highlights.delete(e)),this.addHighlightToIncrement(s.incrementId,i),s.highlights.set(e,i),s):null}removeHighlightFromSection(e,t){const i=this.findIncrementData(t);i&&this.removeHighlightFromIncrementData(e,i)}removeHighlightFromIncrementData(e,t){const i=t.highlights.get(e);i&&(this.removeHighlightFromIncrement(t.incrementId,i),t.highlights.delete(e))}clearSelections(e){const t=e.filter((e=>null==e?void 0:e.isSectionEntity()));e.remove(t)}remove(){this.isCleaningUp=!0,this.clearSelections((0,o.Wf)()),this.clearSelections((0,o.vi)()),super.remove()}onIsolateChanged(){this.updateEntityVisibility()}updateEntityVisibility(){const e=this.viewer.getModelViewManagers().getManager(),t=this.viewer.getIsolatedOccurrenceManager().isInIsolateOrMakeTransparentMode(),i=this.viewer.getIsolatedOccurrenceManager().getIsIsolateFullyTransparent();for(const s of this.incrementData.values()){let n;if(s.occurrence){const e=this.viewer.getOccurrenceIdManager().getIdForName(s.occurrence.toString());n=this.viewer.getOccurrenceDataManager().getOccurrenceData(e)}else{const t=e.getDisplayedPartStudio();t&&(n=t.getBodyComponent().getBodyOccurrenceData(s.partId))}t&&n&&i&&!n.getIsolated()?this.hideIncrement(s.incrementId):this.showIncrement(s.incrementId)}}extractMeshIncrement(e){var t;const i=this.findIncrementData(e);return null!==(t=null==i?void 0:i.meshIncrement)&&void 0!==t?t:null}}var b=i(34444);const L=n.default.getManager();let F=!1,x=0;function B(e){F=e}function U(){return 3}var V;!function(e){e[e.Excluded=0]="Excluded",e[e.Included=1]="Included"}(V||(V={}));let G=!1;function H(e){var t;G=e,null===(t=z())||void 0===t||t.setEntitiesEnabled(G)}class k extends s.T{constructor(e=!0){super(),this.sectionPlanes=[],this.sectionedItems=[null,null],this.currentSectionedItemType=V.Excluded,this.isListening=!1,this.elementId="",this.eligibleCompositeParts=[new Set,new Set],this.areEntitiesEnabled=!1,this.entitiesElement=null,this.isRequestingEntities=!1,this.editSubject=new v.x,this.planeEditSubscriptions=new Map,this.hasVisibilityUpdate=!1,e&&this.setEntitiesEnabled(G)}isNotEmpty(){var e,t;return this.sectionPlanes.length>0||(null===(e=this.sectionedItems[V.Excluded])||void 0===e?void 0:e.selections.length)>0||(null===(t=this.sectionedItems[V.Included])||void 0===t?void 0:t.selections.length)>0}setupListeners(){this.isListening=!0,this.listenTo((0,l.xA)(),l.CD,this.onPartStudioDisplayDataChanged),this.listenTo((0,l.xA)(),l.sJ,this.onPartVisibilityChanged),this.listenTo((0,l.xA)(),l.hj,this.onAssemblyDataProcessed),this.listenTo((0,C.m)(),D.C.EXIT_EDIT_INCONTEXT,this.removeAssemblyParts)}stopListening(e,t,i){this.isListening&&(super.stopListening(e,t,i),this.isListening=!1)}updateEntitiesIfEnabled(){this.areEntitiesEnabled&&this.updateEntities((0,m.uQ)(),this.getElementConnection())}updateEntitiesIfMicroversionChanged(e){var t;e.to.deepEquals(e.from)?null===(t=this.entitiesElement)||void 0===t||t.hide():this.updateEntitiesIfEnabled()}onPartStudioDisplayDataChanged(e){this.setAllOccurrencesClippedExceptSelectedOnes(this.getIsExcludingItemsForSection()),(e.hasPartGeometryChanges()||this.hasVisibilityUpdate)&&(this.updateEntitiesIfMicroversionChanged(e.microversionIdAndConfigurationInterval),this.hasVisibilityUpdate=!1)}onPartVisibilityChanged(){this.hasVisibilityUpdate=!0,this.clearEntities()}onAssemblyDataProcessed(e){this.removeDeletedOccurrencesFromSectionedItems(e),this.setAllOccurrencesClippedExceptSelectedOnes(this.getIsExcludingItemsForSection());const t=e.occurrences.length,i=e.deletedOccurrences.length;(t>0||i>0)&&this.updateEntitiesIfMicroversionChanged(e.microversionIdAndConfigurationInterval)}removeDeletedOccurrencesFromSectionedItems(e){if(0===e.deletedOccurrences.length)return;const t=this.getSectionedItems();if(t&&t.length>0){const i=new Set(e.deletedOccurrences.map((e=>e.getPathAsString())));t.reset(t.filter((e=>{var t;return!i.has(null===(t=e.getOccurrence())||void 0===t?void 0:t.getPathAsString())})))}}setAllOccurrencesClippedExceptSelectedOnes(e){const t=(0,m.uQ)(),i=t.getModelViewManagers().getManager(),s=(0,r._R)()?i.getDisplayedAssembly():i.getDisplayedInContextAssembly();if(s){const t=this.getSectionedItemsAsSetOfOccurrencePaths();s.setAreOccurrencesClippedBySectionPlaneExcept(e,t)}if((0,r._B)()){const s=!0,n=this.getSectionedItemsAsSetOfBodyIds(s),r=i.getDisplayedPartStudio();if(r&&r.getBodyComponent().setAreOccurrencesClippedBySectionPlaneExcept(e,n),t.getModelViewManagers().previewManagerExists()){const i=t.getModelViewManagers().getPreviewManager().getDisplayedPartStudio();i&&i.getBodyComponent().setAreOccurrencesClippedBySectionPlaneExcept(e,n)}}}getIsExcludingItemsForSection(){return this.currentSectionedItemType===V.Excluded}getCurrentSectionedItemType(){return this.currentSectionedItemType}getElementConnection(){return b._3.getOpenDocumentController().elementConnection}onSectionPlaneEdit(e,t){if(this.editSubject.next({plane:e,isValidForEntities:t}),this.areEntitiesEnabled)if(t){const e=(0,m.uQ)(),t=this.getElementConnection();this.updateEntities(e,t)}else this.clearEntities()}setIsExcludingItemsForSection(e){this.currentSectionedItemType=e?V.Excluded:V.Included,F=!0,this.setAllOccurrencesClippedExceptSelectedOnes(e);(0,m.uQ)().requestDraw()}getSectionPlanes(){return this.sectionPlanes}clearSectionPlanes(){this.sectionPlanes=[],this.clearEntities()}addSectionPlane(e){this.sectionPlanes.push(e);const t=e.getEditObservable().subscribe((t=>{this.onSectionPlaneEdit(e,t)}));this.planeEditSubscriptions.set(e,t),this.onSectionPlaneEdit(e,!0)}removeSectionPlane(e){this.onSectionPlaneEdit(e,!0),this.sectionPlanes=this.sectionPlanes.filter((t=>t!==e));const t=this.planeEditSubscriptions.get(e);t&&(t.unsubscribe(),this.planeEditSubscriptions.delete(e))}getEditObservable(){return this.editSubject.asObservable()}destroySectionedItems(){this.currentSectionedItemType=V.Excluded,this.sectionedItems.forEach((e=>{e&&e.destroy()})),this.stopListening(),this.sectionedItems=[null,null],this.eligibleCompositeParts.forEach((e=>e.clear())),this.elementId=""}setElementId(e,t){this.elementId!==e&&(""!==this.elementId&&this.destroySectionedItems(),this.elementId=e,this.sectionedItems[V.Excluded]=new h.w(e),this.sectionedItems[V.Included]=new h.w(e),t&&this.setupListeners())}getElementId(){return this.elementId}setIsItemClipped(e,t){if(!e)return;const i=(0,m.uQ)(),s=i.getModelViewManagers().getManager(),n=(0,r._R)()?s.getDisplayedAssembly():s.getDisplayedInContextAssembly();let a=!1;if(n){const i=e.getOccurrence();i&&(n.setAllLeafOccurrencesClippedForOccurrence(i,t),a=!0)}(0,r._B)()&&!a&&s.getDisplayedPartStudio().getBodyComponent().setIsBodyClippedBySectionPlane(e.getBodyId(),t,!1,this.getHasEligibleCompositeParts()?this.getSectionedItemsAsSetOfBodyIds():null),i.requestDraw()}getHasEligibleCompositeParts(e){return e=null!=e?e:this.currentSectionedItemType,this.eligibleCompositeParts[e].size>0}addSectionedItem(e,t){var i,s;""!==this.getElementId()?(null==t&&(t=this.currentSectionedItemType),null===(i=this.getSectionedItems(t))||void 0===i||i.add(e),t===this.currentSectionedItemType&&this.setIsItemClipped(e,!this.getIsExcludingItemsForSection()),(null===(s=e.getBodyMetaData())||void 0===s?void 0:s.isNonGroupingCompositeBody)&&this.eligibleCompositeParts[t].add(e.getBodyId()),F=!0):a.log.warn("SectionViewState.addSectionedItem used without initializing via setElementId")}removeSectionedItem(e,t){var i,s;if(""===this.getElementId())return void a.log.warn("SectionViewState.removeSectionedItem used without initializing via setElementId");null==t&&(t=this.currentSectionedItemType);(null===(i=this.getSectionedItems(t))||void 0===i?void 0:i.remove(e))&&(t===this.currentSectionedItemType&&this.setIsItemClipped(e,this.getIsExcludingItemsForSection()),(null===(s=e.getBodyMetaData())||void 0===s?void 0:s.isNonGroupingCompositeBody)&&this.eligibleCompositeParts[t].delete(e.getBodyId()),F=!0)}getSectionedItems(e){return""===this.getElementId()?(a.log.error("SectionViewState.getSectionedItems used without initializing via setElementId"),null):(null==e&&(e=this.currentSectionedItemType),this.sectionedItems[e]?this.sectionedItems[e].selections:null)}getSectionedItemsAsSetOfBodyIds(e){const t=new Set,i=this.getSectionedItems();return i&&i.forEach((i=>{!i||e&&i.getOccurrence()||t.add(i.getBodyId())})),t}getSectionedItemsAsSetOfOccurrencePaths(){const e=new Set,t=this.getSectionedItems();return t&&t.forEach((t=>{const i=t.getOccurrence();i&&e.add(i.getPathAsString())})),e}resetSectionedItems(e,t){if(""===this.getElementId())return void a.log.warn("SectionViewState.resetSectionedItems used without initializing via setElementId");const i=new o.nZ("newSelectionList",e),s=this.getSectionedItems(t);for(let e=s.length-1;e>=0;--e){const n=s.at(e);i.has(n)||this.removeSectionedItem(n,t)}i.forEach((e=>{s.has(e)||this.addSectionedItem(e,t)}))}destroy(){this.clearEntities(),Te(!1),this.destroySectionedItems()}static copy(e,t,i){var s,n;if(e&&t){t.sectionPlanes=[];for(const i of e.sectionPlanes)t.addSectionPlane(i);t.currentSectionedItemType=e.currentSectionedItemType,""!==e.getElementId()&&(t.elementId="",t.setElementId(e.getElementId(),i),null===(s=t.getSectionedItems(V.Excluded))||void 0===s||s.reset(e.getSectionedItems(V.Excluded).toArray()),null===(n=t.getSectionedItems(V.Included))||void 0===n||n.reset(e.getSectionedItems(V.Included).toArray()),t.eligibleCompositeParts[V.Excluded]=new Set(e.eligibleCompositeParts[V.Excluded]),t.eligibleCompositeParts[V.Included]=new Set(e.eligibleCompositeParts[V.Included]))}}clone(e){const t=new k;return k.copy(this,t,e),t}setFrom(e,t){if(!e)return!1;k.copy(e,this,t);const i=this.sectionPlanes.length>0;return i&&(F=!0,this.sectionPlanes.forEach((function(e){e.viewer.getEventDispatcher().trigger(l.Sr,e)}))),i}getSectionedItemsSize(e){var t,i;return""===this.getElementId()?(a.log.warn("SectionViewState.getSectionedItemsSize used without initializing via setElementId"),0):null!==(i=null===(t=this.getSectionedItems(e))||void 0===t?void 0:t.length)&&void 0!==i?i:0}removeAssemblyParts(){const e=[],t=t=>{t.occurrence&&e.push(t)};this.sectionedItems[V.Excluded].selections.forEach(t),this.sectionedItems[V.Included].selections.forEach(t),e.forEach((e=>this.removeSectionedItem(e)))}getSerializedSectionPlanes(){return this.getSectionPlanes().map((e=>{const t=new c.hPA;return t.center.updateFromArray(e.center),t.normal.updateFromArray(e.normal),t.tangent.updateFromArray(e.tangent),t}))}clearEntities(){this.setEntitiesElement(null),this.isRequestingEntities=!1}disableEntities(){this.clearEntities(),this.areEntitiesEnabled=!1}updateEntities(e,t){this.areEntitiesEnabled&&this.clearEntities(),this.generateEntities(e,t)}enableEntities(e=!1){const t=(0,m.uQ)(),i=this.getElementConnection();this.areEntitiesEnabled?e&&this.updateEntities(t,i):(this.areEntitiesEnabled=!0,this.generateEntities(t,i))}setEntitiesEnabled(e,t=!1){e?this.enableEntities(t):this.disableEntities()}setEntitiesElement(e){var t;null===(t=this.entitiesElement)||void 0===t||t.remove(),this.entitiesElement=e}generateEntities(e,t){var i;if(this.entitiesElement)return;const s=new c.Nsz;if(s.elementId=this.elementId,s.sectionPlanes=this.getSerializedSectionPlanes(),s.currentSectionedItemType=this.getCurrentSectionedItemType(),0===s.sectionPlanes.length)return;const n=[],r=[];null===(i=this.getSectionedItems())||void 0===i||i.forEach((e=>{let t=e.getOccurrence();if((null==t?void 0:t.isAssemblyRoot())&&(t=new c._oC),t)return void n.push(t);const i=e.getPartId();i&&r.push(i)})),s.selectedItems=n,s.partIds=r;const o=performance.now(),h=new P.e("sectionplane_helpers.SectionViewState.generateEntities");h.setImportant(i18n("Generating entities")),t.callAndPromiseWithFeedback(s,h).then((t=>{if(!(t instanceof c.FBt))return;if(!this.areEntitiesEnabled||!this.isRequestingEntities)return;const i=performance.now()-o,s=t.occurrenceList.length+t.partIds.length;a.log.debug(`Toggle section entities time taken ${i}ms. Number of bodies=${s}`),this.setEntitiesElement(new N(this.elementId,this,e)),this.entitiesElement.populate(t)})).catch((e=>{a.log.error(e),this.clearEntities()})),this.isRequestingEntities=!0}hasEntities(){return!!this.entitiesElement}hasFaceEntities(){var e,t;return null!==(t=null===(e=this.entitiesElement)||void 0===e?void 0:e.hasFaceEntities())&&void 0!==t&&t}getSelectedFaceEntityForAlignment(){var e,t;return null!==(t=null===(e=this.entitiesElement)||void 0===e?void 0:e.getSelectedFaceEntityForAlignment())&&void 0!==t?t:null}extractMeshIncrement(e){var t,i;return null!==(i=null===(t=this.entitiesElement)||void 0===t?void 0:t.extractMeshIncrement(e))&&void 0!==i?i:null}getEntityMetaData(e){var t,i;return null!==(i=null===(t=this.entitiesElement)||void 0===t?void 0:t.getEntityMetaData(e))&&void 0!==i?i:null}}const W=new k(!1);function z(){return W}const X=E.create(),q=E.create(),Z=E.create();let Y=[];const K=function(){Y=j()};function j(){const e=[];return W.getSectionPlanes().forEach((function(t){const i={};i.center=S.clone(t.center),i.tangent=T.clone(t.tangent),i.normal=T.clone(t.normal),e.push(i)})),e}const Q=function(e,t){if(!t&&x===e.getFrameId())return;let i,s;const n=W.getSectionPlanes();for(i=0;i<n.length;++i){const t=n[i].getCameraSpaceCenter(e.modelViewMatrix),r=n[i].getCameraSpacePlaneEquation(e.modelViewMatrix,t),a=n[i].getCameraSpaceTangent(e.modelViewMatrix);for(s=0;s<4;++s)X[4*s+i]=r[s],Z[4*s+i]=a[s];for(s=0;s<3;++s)q[4*s+i]=t[s]}t||(x=e.getFrameId())};function $(e){let t=-1,i=-1;return W.getSectionPlanes().forEach((function(s,n){!1!==e&&s.isPreSelected?t=-1===t?n:-2:s.isSelected&&(i=-1===i?n:-2)})),t>-1?t:i>-1?i:-1}function J(){const e=W.getSectionPlanes();for(let t=0;t<e.length;t++){const i=e[t];if(i.isSelected||i.isPreSelected)return!0}return!1}function ee(e){const t=W.getSectionPlanes();return(e<0||e>=t.length)&&a.log.warn("attempting to retrieve a section plane with an invalid index"),t[e]}function te(e,t){W.getSectionPlanes().forEach(e,t)}function ie(e,t){return W.getSectionPlanes().filter(e,t)}function se(){const e=[];return W.getSectionPlanes().forEach((function(t){e.push(t.graphicsOccurrenceId)})),e}function ne(){x=-1}const re=L.getNumber("SECTION_PLANE_ENDCAP_ORTHOGRAPHIC_Z_FIGHTING_FACTOR"),ae=L.getNumber("SECTION_PLANE_ENDCAP_PERSPECTIVE_Z_FIGHTING_FACTOR"),oe=L.getNumber("SECTION_PLANE_INTER_ENDCAP_Z_FIGHTING_FACTOR");let he=!1;function ce(e){he=e}function le(e,t,i){const s=e.getRenderContext(),n=s.getActiveShader(),r=W.getSectionPlanes();if(!t||!e.areSectionPlanesEnabled()||0===r.length)return void n.uniform1f("uSectionPlaneCount",0);Q(s,i),n.uniformMatrix4fv("uSectionPlaneEquations",!1,X),n.uniform1f("uSectionPlaneCount",r.length);const a=s.getActiveCamera(),o=a.getFarDepth()-a.getNearDepth(),h=o*(a.isOrthographic()?re:ae),c=o*oe;n.uniform1f("uEndcapZFightingThreshold",h),n.uniform1f("uInterEndcapZFightingThreshold",c),n.uniform1f("uUseOccurrenceIdForHatchOffset",he?0:1)}function ue(e,t){const i=W.getSectionPlanes();if(t<0||i.length<=t)return;const s=e.getActiveShader();s.uniformMatrix4fv("uSectionPlaneCenters",!1,q),s.uniformMatrix4fv("uSectionPlaneTangents",!1,Z)}function de(e,t){const i=W.getSectionPlanes();if(t<0||i.length<=t)return;const s=i[t],n=e.getActiveShader();n.uniform1f("uOccurrenceId",s.graphicsOccurrenceId);const r=[0,0,0,0];for(let e=0;e<i.length;++e)r[e]=i[e].isHiddenFromPick?1:0;n.uniform4fv("uSectionPlaneIsHiddenFromPick",r)}function ge(e,t){const i=W.getSectionPlanes();if(t<0||i.length<=t)return;const s=i[t],n=e.getActiveShader();n.uniform1f("uSectionPlaneIsPreSelected",s.isPreSelected?1:0),n.uniform1f("uSectionPlaneIsSelected",s.isSelected?1:0),n.uniform4fv("uSectionPlanePreSelectColor",L.getColor("SECTION_PLANE_PRE_HIGHLIGHT_COLOR")),n.uniform4fv("uSectionPlaneSelectColor",L.getColor("ENTITY_HIGHLIGHT_COLOR1")),n.uniform4fv("uSectionPlaneIntersectingColor",L.getColor("SECTION_PLANE_INTERSECTING_COLOR"));const r=L.getColor("SECTION_PLANE_SELECTOR_COLOR_0"),a=L.getColor("SECTION_PLANE_SELECTOR_COLOR_1"),o=L.getColor("SECTION_PLANE_SELECTOR_COLOR_2"),h=L.getColor("SECTION_PLANE_SELECTOR_COLOR_3");n.uniformMatrix4fv("uSectionPlaneSelectorColor",!1,E.fromValues(r[0],a[0],o[0],h[0],r[1],a[1],o[1],h[1],r[2],a[2],o[2],h[2],r[3],a[3],o[3],h[3]));const l=e.getActiveCamera();if(l.isPerspective()){const e=l.getSceneBounds().diameter(),t=(l.distanceToCenter()+.5*e)/l.getViewportHeight();n.uniform1f("uSectionPlanePatternScale",t*L.getNumber("SECTION_PLANE_PERSPECTIVE_PATTERN_SCALE"))}else{const e=1/(l.projectionMatrix[5]*l.getViewportHeight());n.uniform1f("uSectionPlanePatternScale",e*L.getNumber("SECTION_PLANE_ORTHOGRAPHIC_PATTERN_SCALE"))}n.uniform1f("uSectionPlanePatternFade",L.getNumber("SECTION_PLANE_PATTERN_FADE")),n.uniform1f("uSectionPlanePatternThickness",L.getNumber("SECTION_PLANE_PATTERN_THICKNESS")),n.uniform1f("uSectionPlanePatternPacingVariation",L.getNumber("SECTION_PLANE_PATTERN_PACING_VARIATION"));let u=0,d=1;switch(e.renderingMode){case c.P1.HIDDEN_LINE_REMOVED:case c.P1.HIDDEN_LINE_VISIBLE:case c.P1.WIREFRAME:case c.P1.CURVATURE_VISUALIZATION:u=1;break;case c.P1.TRANSLUCENT:d=L.getNumber("TRANSLUCENT_PASS_ALPHA")}n.uniform1f("uSectionPlanePatternIsBlackAndWhite",u),n.uniform1f("uSectionPlaneEndcapAlpha",d),n.uniform1f("uSectionPlaneIsolateContextOpacity",L.getNumber("ISOLATE_CONTEXT_FACE_TRANSPARENCY")),n.uniform1f("uSectionPlaneIntersectingAdditionalAlpha",L.getNumber("SECTION_PLANE_INTERSECTING_ADDITIONAL_ALPHA"))}const pe=function(e){W.getSectionPlanes().length<3?(W.addSectionPlane(e),F=!0,e.viewer.getEventDispatcher().trigger(l.Sr,e)):e.viewer.getEventDispatcher().trigger(l.F5)},me=function(e,t){if(W.getSectionPlanes().length<3){pe(e);const i=new g.i(e,u.s_,"");i.sourcePick=t;e.viewer.getUISelectionManager().setSelection(i)}else e.viewer.getEventDispatcher().trigger(l.F5)};function fe(){return Y}function Ie(){Y=[]}function Ee(e,t,i,s){const n=s.getModelViewManagers().getManager().getMateConnectorGraphics(e,t);if(!n)return;const r=S.clone(n.worldSpacePosition),a=M.w$.multiplyVec4(n.transform,T.fromValues(0,0,1,0),T.create());M.jA.negate(a),M.Jb.normalize(a);const o=M.w$.multiplyVec4(n.transform,T.fromValues(1,0,0,0),T.create());M.Jb.normalize(o),me(new d.O(a,o,r,i,s))}function Se(e,t,i,s,n){if(!t||s||!i)return;const r=T.fromValues(t[8],t[9],t[10],0),a=T.fromValues(t[0],t[1],t[2],0),o=S.fromValues(t[12],t[13],t[14]),h=S.dot(r,o)-S.dot(i.center(),r),c=M.S4.add(i.center(),M.S4.scale(r,h,S.create()),S.create()),l=(0,p.HB)().getCamera();S.dot(l.direction,r)<0&&(M.S4.negate(r),M.S4.negate(a)),me(new d.O(r,a,c,n,e,i.diameter()))}function Te(e){e?K():Y=[],W.getSectionPlanes().forEach((function(e){Me(e)})),W.clearSectionPlanes(),F=!0}function Me(e){W.removeSectionPlane(e),e.onRemove(),F=!0,e.viewer.getEventDispatcher().trigger(l.zK,e)}function Ce(e,t,i,s){Te(!1),e.forEach((function(e){const n=new d.O(e.normal,e.tangent,e.center,t,i);z().sectionPlaneToFocus&&z().sectionPlaneToFocus.equals(n)?(z().sectionPlaneToFocus=n,me(n,z().pickOnSectionPlaneToFocus)):(pe(n),s&&n.setupManipulator())}))}function De(){return W.getSectionPlanes().length}function ve(){return W.getSectionedItemsSize()}function Pe(){return!(0,f.isEmptyObjectOrArray)(W.getSectionPlanes())}function ye(e){W.getSectionPlanes().forEach((function(t){t.graphicsOccurrenceId===e&&(t.isHiddenFromPick=!0)}))}function Ae(){W.getSectionPlanes().forEach((function(e){e.isHiddenFromPick=!1}))}function Oe(e){if(e!==W.getElementId())return new k(!1);const t=W.clone(!1);return W.destroy(),t}function Re(e,t){if(t!==e.getElementId())return!1;W.destroy();return W.setFrom(e,!0)}let we=new c.tS4;function _e(){const e=[];return Ne(e),e}function Ne(e){W.getSerializedSectionPlanes().forEach((t=>{e.push(t)}))}function be(){we=we.clone(),we.sectionPlanes=[],Ne(we.sectionPlanes),we.isExcluding=W.getIsExcludingItemsForSection();const e=W.getElementId();return we.elementId=e,e.length>0}function Le(){return F&&(be()&&xe(we,!1),F=!1),we}function Fe(){let e=null;return F&&be()&&(e=xe(we,!0))?e.then((()=>(F=!1,we))):(F=!1,Promise.resolve(we))}function xe(e,t){return t?new Promise((t=>{const i=(0,I.ZU)(W.getSectionedItems(V.Excluded).toArray()),s=(0,I.ZU)(W.getSectionedItems(V.Included).toArray());Promise.all([i,s]).then((i=>{e.selectionsToExclude=i[0],e.selectionsToInclude=i[1],t()}))})):(e.selectionsToExclude=(0,I.xX)(W.getSectionedItems(V.Excluded).toArray()),e.selectionsToInclude=(0,I.xX)(W.getSectionedItems(V.Included).toArray()),null)}function Be(e,t,i){let s;const n=W.getSectionPlanes();if(e.length===n.length&&e.length>0)for(F=!0,s=0;s<e.length;s++)n[s].center=S.fromValues(e[s].center.x,e[s].center.y,e[s].center.z),n[s].normal=T.fromValues(e[s].normal.x,e[s].normal.y,e[s].normal.z,0),n[s].tangent=T.fromValues(e[s].tangent.x,e[s].tangent.y,e[s].tangent.z,0);else for(n.length>0&&Te(!1),s=0;s<e.length;s++){const n=S.fromValues(e[s].center.x,e[s].center.y,e[s].center.z),r=T.fromValues(e[s].normal.x,e[s].normal.y,e[s].normal.z,0),a=T.fromValues(e[s].tangent.x,e[s].tangent.y,e[s].tangent.z,0);pe(new d.O(r,a,n,t,i))}}function Ue(e,t,i){Be(e.sectionPlanes,t,i),function(e,t){const i=W.getElementId();!e||""===e.elementId||""!==i&&e.elementId!==i||(W.setElementId(e.elementId,!0),W.setIsExcludingItemsForSection(e.isExcluding),(0,I.rP)(e.selectionsToExclude,t).then((e=>{W.resetSectionedItems(e,V.Excluded)})),(0,I.rP)(e.selectionsToInclude,t).then((e=>{W.resetSectionedItems(e,V.Included)})))}(e,i)}},6805:function(e,t,i){i.d(t,{G7:function(){return k},KL:function(){return R},Te:function(){return N},WD:function(){return D},Wt:function(){return z},b2:function(){return b},bt:function(){return G},eL:function(){return v},wg:function(){return W},wm:function(){return L}});var s=i(93249),n=i(79275),r=i(51890),a=i(28817),o=i(50568),h=i(41810),c=i(26957),l=i(55532),u=i(28784),d=i(78591),g=i(77484),p=i(96265),m=i(80675),f=i(63903),I=i(54861),E=i(57692),S=i(24999),T=i(48820),M=i(40870),C=i(10867);const D="ellipsis",v=5,P=u.UKE,y={};y[h.U5n.BAD]="BAD",y[h.U5n.DRIVEN]="OK",y[h.U5n.SOLVED]="OK";const A={};A[P.SELECTED]="SELECTED_COLOR",A[P.PREHILITE]="PREHILITE_COLOR",A[P.MUTED]="MUTED_COLOR",A[P.NOT_SELECTED]="COLOR";const O=function(e,t,i,s){switch(t){case h.U5n.BAD:e+=":od";break;case h.U5n.DRIVEN:e+=":dr"}return i===u.UKE.SELECTED?e+=":s":i===u.UKE.PREHILITE?e+=":h":i===u.UKE.MUTED&&(e+=":m"),s&&(e+=":ex"),e};var R;!function(e){e[e.LINE=0]="LINE",e[e.TANGENT_ARC=1]="TANGENT_ARC"}(R||(R={}));const w=new Map([[R.LINE,"Sketch_Constraints_Grayscale_2_line.svg "],[R.TANGENT_ARC,"Sketch_Constraints_Grayscale_2_tangent-arc.svg "]]),_=new Map([[R.LINE,"line"],[R.TANGENT_ARC,"tangent_arc"]]);var N;!function(e){e[e.NOT_REQUIRED=0]="NOT_REQUIRED",e[e.REQUIRED=1]="REQUIRED"}(N||(N={}));class b{constructor(){this.id="",this.selectionId="",this.selected=u.UKE.NOT_SELECTED,this.constraintType=h.dI1.UNKNOWN,this.solveStatus=h.U5n.SOLVED,this._borderState=N.NOT_REQUIRED}static getIcon(e){const t=new b,i=O(_.get(e),h.U5n.UNKNOWN,u.UKE.MUTED,!1);return t.id=i,t}get borderState(){return this._borderState}set borderState(e){this._borderState=e}}const L=1,F=function(e,t,i,s){let r;switch(e){case h.dI1.QUADRANT:r="qad";break;case h.dI1.COINCIDENT:r="coi";break;case h.dI1.PARALLEL:r="par";break;case h.dI1.VERTICAL:r="ver";break;case h.dI1.HORIZONTAL:r="hoz";break;case h.dI1.PERPENDICULAR:r="prp";break;case h.dI1.CONCENTRIC:r="con";break;case h.dI1.MIDPOINT:r="mid";break;case h.dI1.TANGENT:r="tan";break;case h.dI1.PIERCE:r="prc";break;case h.dI1.EQUAL:r="equ";break;case h.dI1.NORMAL:r="nor";break;case h.dI1.FIX:r="fix";break;case h.dI1.PROJECTED:case h.dI1.SILHOUETTED:r="prj";break;case h.dI1.OFFSET:r="off";break;case h.dI1.MIRROR:r="mir";break;case h.dI1.CIRCULAR_PATTERN:r="cpt";break;case h.dI1.LINEAR_PATTERN:r="lin";break;case h.dI1.INTERSECTED:r="int";break;case h.dI1.EQUAL_CURVATURE:r="cur";break;default:r="???",n.log.error("Found a constraint with no atlas key.")}return O(r,t,i,s)},x=function(e,t,i,n,r){const a=s.default.getManager(),o=new d.ImageData;o.id=e;let c="CONSTRAINT_"+(y[t]||"OK")+"_"+(A[i]||"COLOR");return n&&(c+="_EXTERNAL"),o.backgroundColor=a.getColorString(c),t!==h.U5n.SOLVED||n||i?o.imageName=r:o.svgToStyle=r,o},B=function(e,t,i,s,n){s.forEach((function(s){for(let r=0;r<2;r++){const a=1===r;n.push(x(F(e,t,s,a),t,s,a,i))}}))},U=function(e){const t=[],i=[u.UKE.NOT_SELECTED,u.UKE.PREHILITE,u.UKE.SELECTED,u.UKE.MUTED],n={"Sketch_Constraints_Grayscale_2_Coincident.svg":h.dI1.COINCIDENT,"Sketch_Constraints_Grayscale_2_Parallel.svg":h.dI1.PARALLEL,"Sketch_Constraints_Grayscale_2_Vertical.svg":h.dI1.VERTICAL,"Sketch_Constraints_Grayscale_2_Horizontal.svg":h.dI1.HORIZONTAL,"Sketch_Constraints_Grayscale_2_Perpendicular.svg":h.dI1.PERPENDICULAR,"Sketch_Constraints_Grayscale_2_Concentric.svg":h.dI1.CONCENTRIC,"Sketch_Constraints_Grayscale_2_Midpoint.svg":h.dI1.MIDPOINT,"Sketch_Constraints_Grayscale_2_Tangent.svg":h.dI1.TANGENT,"Sketch_Constraints_Grayscale_2_Equal.svg":h.dI1.EQUAL,"Sketch_Constraints_Grayscale_2_Normal.svg":h.dI1.NORMAL,"Sketch_Constraints_Grayscale_2_Fix.svg":h.dI1.FIX,"Sketch_Constraints_Grayscale_2_Use.svg":h.dI1.PROJECTED,"Sketch_Constraints_Grayscale_2_Offset.svg":h.dI1.OFFSET,"Sketch_Constraints_Grayscale_2_Mirror.svg":h.dI1.MIRROR,"Sketch_Constraints_Grayscale_2_CircularPattern.svg":h.dI1.CIRCULAR_PATTERN,"Sketch_Constraints_Grayscale_2_LinearPattern.svg":h.dI1.LINEAR_PATTERN,"Sketch_Constraints_Grayscale_2_Pierce.svg":h.dI1.PIERCE,"Sketch_Constraints_Grayscale_2_Quadrant.svg":h.dI1.QUADRANT,"Sketch_Constraints_Grayscale_2_Intersection.svg":h.dI1.INTERSECTED,"Sketch_Constraints_Grayscale_2_equal-curvature.svg":h.dI1.EQUAL_CURVATURE};Object.entries(n).forEach((function([e,s]){B(s,h.U5n.SOLVED,e,i,t)}));const r={"Sketch_Constraints_OverDefined_Coincident.svg":h.dI1.COINCIDENT,"Sketch_Constraints_OverDefined_Parallel.svg":h.dI1.PARALLEL,"Sketch_Constraints_OverDefined_Vertical.svg":h.dI1.VERTICAL,"Sketch_Constraints_OverDefined_Horizontal.svg":h.dI1.HORIZONTAL,"Sketch_Constraints_OverDefined_Perpendicular.svg":h.dI1.PERPENDICULAR,"Sketch_Constraints_OverDefined_Concentric.svg":h.dI1.CONCENTRIC,"Sketch_Constraints_OverDefined_Midpoint.svg":h.dI1.MIDPOINT,"Sketch_Constraints_OverDefined_Tangent.svg":h.dI1.TANGENT,"Sketch_Constraints_OverDefined_Equal.svg":h.dI1.EQUAL,"Sketch_Constraints_OverDefined_Normal.svg":h.dI1.NORMAL,"Sketch_Constraints_OverDefined_Fix.svg":h.dI1.FIX,"Sketch_Constraints_OverDefined_Use.svg":h.dI1.PROJECTED,"Sketch_Constraints_OverDefined_Offset.svg":h.dI1.OFFSET,"Sketch_Constraints_OverDefined_Mirror.svg":h.dI1.MIRROR,"Sketch_Constraints_OverDefined_CircularPattern.svg":h.dI1.CIRCULAR_PATTERN,"Sketch_Constraints_OverDefined_LinearPattern.svg":h.dI1.LINEAR_PATTERN,"Sketch_Constraints_OverDefined_Pierce.svg":h.dI1.PIERCE,"Sketch_Constraints_OverDefined_Quadrant.svg":h.dI1.QUADRANT,"Sketch_Constraints_OverDefined_Intersection.svg":h.dI1.INTERSECTED,"Sketch_Constraints_OverDefined_equal-curvature.svg":h.dI1.EQUAL_CURVATURE};Object.entries(r).forEach((function([e,s]){B(s,h.U5n.BAD,e,i,t)})),i.forEach((function(e){t.push(x(O("...",h.U5n.SOLVED,e,!1),h.U5n.SOLVED,e,!1,"Sketch_Constraints_Ellipsis.svg"))}));const a=Object.values(R).filter((e=>"string"==typeof e));for(const e in a){const i=parseInt(e);t.push(x(O(_.get(i),h.U5n.UNKNOWN,u.UKE.MUTED,!1),h.U5n.UNKNOWN,u.UKE.MUTED,!1,w.get(i)))}const o=s.default.getManager().getNumber("CONSTRAINT_MAX_INDICATOR_SIZE")*(0,C.x_)();return(0,d.createAtlasFromResources)(e,o,t,{sourcesHaveTransparency:!1})};let V=0;function G(e){if(e.getResources().constraintAtlasCreationInitiated)return;e.getResources().constraintAtlasCreationInitiated=!0;const t=V++;e.getResources().constraintAtlasCreationId=t;e.getTextureAtlasFactory().getAtlas(d.SKETCH_CONSTRAINT_TEXTURE_ATLAS,U.bind(void 0,e)).then((function(i){t===e.getResources().constraintAtlasCreationId&&(i?(e.getResources().constraintAtlas=i,e.getResources().constraintMaterial.ambientTexture=i.texture,(0,d.requestDraw)()):n.log.warn("Could not load texture atlas"))}),(function(e){n.log.error(e)}))}const H=function(e){return e.selected===u.UKE.SELECTED};class k extends d.UIElement{constructor(e,t,i,n,r,a){super(a,d.HUD_SCENEGRAPH_ID),this.permanent=r,this.activated=!1,this.isExpanded=!1,this.lastCameraXform=null,this.lastProjectionXform=null,this.hasLeader=!1,this.lastMouseDelta=null,this.isForInference=!1,this.material=a.getResources().constraintMaterial,this.nodeProperties=this.viewer.getResources().typeToNodeProperties[d.sketchinformation.nodePropertiesTypes.OK],this.leaderProperties=new d.NodeProperties({isPickable:!1,primitiveType:d.PrimitiveType.LINES,zOffset:5}),this.borderProperties=this.leaderProperties.clone(),this.model=e,this.reference=this.model.getReference(t),this.referenceIdsChangedSubscription=this.reference.getReferenceIdsChangedObservable().subscribe((([e,t])=>this.onReferenceConstraintIdsChanged(e,t))),this.anchorChangedSubscription=this.reference.getAnchorChangedObservable().subscribe((e=>this.resetLocation(e)));const o=this.reference.constraintIds,h=(0,S.T)(...o.map((e=>this.model.getConstraint(e))).filter((e=>!!e)).map((e=>e.getConstraintChangedObservable())));this.changeSolveStatusSubscription=h.pipe((0,T.h)((e=>"change:solveStatus"===e.name)),(0,M.U)((e=>e.constraint))).subscribe((e=>this.onConstraintStatusChanged(e))),this.changeTypeSubscription=h.pipe((0,T.h)((e=>"change:type"===e.name)),(0,M.U)((e=>e.constraint))).subscribe((e=>this.onConstraintTypeChanged(e))),this.changeBorderSubscription=h.pipe((0,T.h)((e=>"change:border"===e.name)),(0,M.U)((e=>e.constraint))).subscribe((e=>this.onConstraintBorderChanged(e))),this.iconData=[],this.worldLocation=i,this.leaderOffset=p.fromValues(0,0,0),this.ellipsisIcon=new b,this.ellipsisIcon.id=D,this.ellipsisIcon.selectionId=D;const c=s.default.getManager();this.iconSizeConstantName=r?"CONSTRAINT_PERMANENT_INDICATOR_PIXEL_SIZE":"CONSTRAINT_INDICATOR_PIXEL_SIZE",this.iconSize=c.getNumber(this.iconSizeConstantName),this.leaderColor=c.getColor("CONSTRAINT_INDICATOR_LEADER_COLOR"),this.borderColor=c.getColor("CONSTRAINT_INDICATOR_BORDER_COLOR");const l=E.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled();this.highlightedBorderSize=l?1/this.iconSize:0,this.userOffset=m.fromValues(0,0),this.worldGeometryDirection=n,this.model.constraints.forEach((e=>this.onConstraintAdded(e))),this.listenTo(this.viewer.getEventDispatcher(),d.VIEW_WILL_PICK,this.onViewWillDraw),this.showOnlyOverDefinedSubscription=this.model.showOnlyOverDefinedObservable().subscribe((()=>this.onShowOnlyOverdefinedChanged())),this.showAllConstraintsSubscription=this.model.showAllConstraintsObservable().subscribe((()=>this.onShowAllConstraintsChanged())),G(this.viewer)}showLeader(){this.hasLeader=!0}setUserOffset(e){this.userOffset=m.fromValues(e[0],-e[1]),this.invalidateDisplay()}getUserOffset(){return m.fromValues(this.userOffset[0],-this.userOffset[1])}setLocation(e){this.worldLocation=e,this.invalidateDisplay()}setMouseDelta(e){this.lastMouseDelta=e}onConstraintAdded(e){this.reference.constraintIds.indexOf(e.id)>=0&&this.addConstraintIcon(e)}invalidateDisplay(){this.lastCameraXform=null,this.lastProjectionXform=null,this.removeMeshIncrements(),(0,d.requestDraw)()}onConstraintStatusChanged(e){if(this.reference.constraintIds.indexOf(e.id)<0)return;const t=this.iconData.find((t=>t.id===e.id));t&&(t.solveStatus=e.displayStatus,t.constraintType=e.type,this.invalidateDisplay())}onReferenceConstraintIdsChanged(e,t){const i=(0,a.difference)(e,t),s=(0,a.difference)(t,e);i.length>0&&this.invalidateDisplay(),i.forEach((e=>{const t=this.iconData.findIndex((t=>t.id===e));t>-1&&this.iconData.splice(t,1)})),s.forEach((e=>{const t=this.model.getConstraint(e);this.addConstraintIcon(t)}))}onConstraintTypeChanged(e){const t=this.iconData.find((t=>t.id===e.id));t&&(t.constraintType=e.type,this.invalidateDisplay())}onConstraintBorderChanged(e){const t=this.iconData.find((t=>t.id===e.id));t&&(t.borderState=e.border,this.invalidateDisplay())}addIcon(e,t,i,s,n){const r=new b;r.id=e,t&&(r.constraintType=t),i&&(r.solveStatus=i),r.isExternal=!!s,n&&(r.borderState=n),this.iconData.push(r),this.invalidateDisplay()}getOffset(e,t){let i;if(this.isForInference)i=m.fromValues(1,-1);else if(this.lastMouseDelta)i=this.lastMouseDelta[0]>0?m.fromValues(-this.lastMouseDelta[1],this.lastMouseDelta[0]):m.fromValues(this.lastMouseDelta[1],-this.lastMouseDelta[0]);else{const t=e.projectWorldPointToViewport(this.worldLocation),s=I.S4.add(this.worldLocation,this.worldGeometryDirection,p.create()),n=e.projectWorldPointToViewport(s),r=I.S4.subtract(n,t,p.create());r[2]=0,i=I.S4.length(r)<L?m.fromValues(-1,1):m.fromValues(r[1],-r[0])}I.gv.normalize(i);const n=.5*t,r=function(e,t){return m.dot(m.fromValues(e,t),i)},a=-Math.abs(r(n,.5)),o=-Math.abs(r(n,-.5)),h=s.default.getManager(),c=(this.permanent?h.getNumber("PERMANENT_INFERENCE_OFFSET"):h.getNumber("TEMPORARY_INFERENCE_OFFSET"))-Math.min(a,o),l=-.99*(0,d.getHudLayerDepthRange)(e.getViewport())[1];return[i[0]*c,i[1]*c,l]}onDevicePixelRatioChanged(e){const t=s.default.getManager();this.iconSize=t.getNumber(this.iconSizeConstantName),G(this.viewer),this.invalidateDisplay()}onAppearanceConstantsUpdated(){G(this.viewer),this.leaderColor=s.default.getManager().getColor("CONSTRAINT_INDICATOR_LEADER_COLOR"),this.invalidateDisplay()}onViewWillDraw(e,t){if(!this.viewer.getResources().constraintAtlas)return;const i=e.getViewMatrixInverse(),s=e.getProjectionMatrix();if(this.lastCameraXform&&this.lastProjectionXform&&f.equals(i,this.lastCameraXform)&&f.equals(s,this.lastProjectionXform))return;this.lastCameraXform=i,this.lastProjectionXform=s;let n=e.projectWorldPointToViewport(this.worldLocation);n[2]=0;const r=p.fromValues(this.userOffset[0],this.userOffset[1],0);n=I.S4.add(n,r);const a=I.w$.translate(f.create(),n),o=this.iconSize;I.w$.scale(a,[o,o,1]);const h=this.getVisibleIcons(),c=this.getOffset(e,this.getDisplayedIconCount(h));I.w$.translate(a,c),a[12]=Math.floor(a[12]),a[13]=Math.floor(a[13]),this.leaderOffset=I.S4.subtract(I.S4.scale(r,-1/o,p.create()),c),this.leaderOffset[2]=0,this.setTransform(a),this.hasMeshIncrements()||this.updateIconGraphics(h),this.updateLeaderGraphics(h)}getNodePropertyType(e){let t=NaN;switch(e.solveStatus){case h.U5n.SOLVED:t=e.isExternal?d.sketchinformation.nodePropertiesTypes.EXTERNAL_AND_OK:d.sketchinformation.nodePropertiesTypes.OK;break;case h.U5n.BAD:t=d.sketchinformation.nodePropertiesTypes.OVERDEFINED;break;case h.U5n.DRIVEN:t=d.sketchinformation.nodePropertiesTypes.DRIVEN}return t}updateNodeProperties(e){if(this.isForInference)return void(this.nodeProperties=this.viewer.getResources().inferenceNodeProperties);this.nodeProperties=this.viewer.getResources().typeToNodeProperties[d.sketchinformation.nodePropertiesTypes.OK];let t=d.sketchinformation.nodePropertiesTypes.DRIVEN;const i=this;e.forEach((function(e){const s=i.getNodePropertyType(e);s<t&&(t=s)})),this.nodeProperties=this.viewer.getResources().typeToNodeProperties[t]}onShowOnlyOverdefinedChanged(){this.invalidateDisplay()}onShowAllConstraintsChanged(){this.model.constraintVisibilityOverride=[],this.invalidateDisplay()}showIconIfPermanent(e,t,i,s){return!!e&&(!!t&&(s||i&&e.solveStatus===h.U5n.BAD))}getVisibleIcons(){let e=[];if(this.isForInference)e=this.iconData;else{const t=this.reference.constraintVisibilities,i=this.reference.constraintIds;for(let s=0;s<i.length;s++){const n=this.iconData.find((e=>e.id===i[s]));if(!n)continue;if(0!==this.model.constraintVisibilityOverride.length&&!1===this.model.showAllConstraints){-1!==this.model.constraintVisibilityOverride.findIndex((e=>e===i[s]))&&e.push(n)}else this.permanent===this.showIconIfPermanent(n,t[s],this.model.showOnlyOverdefined,this.model.showAllConstraints)&&e.push(n)}}return(0,l.Z)(e,(function(e){return-2*e.solveStatus-(e.isExternal?1:0)}))}getDisplayedIconCount(e){return this.isExpanded?e.length:Math.min(e.length,v+1)}updateIconGraphics(e){if(!this.viewer.getResources().constraintAtlas)return;this.updateNodeProperties(e),this.viewer.getResources().constraintMaterial.ambientTexture=this.viewer.getResources().constraintAtlas.texture;const t=e.length>v+1&&!this.isExpanded,i=.5*-this.getDisplayedIconCount(e);e.forEach((function(e,s){if(e.selectionId=""+s,t){if(s>v)return void this.removeMeshIncrement(e.id);s===v&&(this.removeMeshIncrement(e.id),e=this.ellipsisIcon)}let n,r=e.selected;if(this.activated||(r=u.UKE.MUTED),e.id===D)n=O("...",h.U5n.SOLVED,r,!1);else{const t=e.constraintType,i=e.solveStatus,s=e.isExternal;n=F(t,i,r,s)}const a=this.viewer.getResources().constraintAtlas.getTextureCoords(n);if(!a)return;s+=s*this.highlightedBorderSize;const o=(0,d.createQuad)([i+s,-.5,0],[i+s+1,-.5,0],[i+s,.5,0],e.id,[a.lowS,a.highT],[a.highS,a.lowT]);this.updateMeshIncrement(e.id,e.selectionId,o,this.nodeProperties);const c=e.id+".border";if(!(e.borderState===N.REQUIRED))return void this.removeMeshIncrement(c);const l=[[i+s,-.5,0],[i+s+1,-.5,0],[i+s+1,.5,0],[i+s,.5,0]],g=(0,d.createLineLoop)(l,c,this.borderColor,1);this.updateMeshIncrement(c,d.NO_SELECTION_ID,g,this.borderProperties)}),this)}updateLeaderGraphics(e){if(this.hasLeader&&0!==e.length){const e=[0,0,0],t=this.leaderOffset,i=(0,d.createLine)(e,t,"leader",this.leaderColor,1);this.updateMeshIncrement("leader",d.NO_SELECTION_ID,i,this.leaderProperties)}}addConstraintIcon(e){e&&this.addIcon(e.id,e.type,e.displayStatus,e.isExternal,e.border)}onDelete(){const e=this.iconData.filter(H);return 0!==e.length&&this.deleteConstraints(e)}deleteConstraints(e){const t=(0,d.getDrawer)(),i=t.getUISelectionManager().getSelection(),s=t.getUISelectionManager().getHoveredSelection();let n=!1;this.model.constraints;if(e.forEach((e=>{const r=this.model.constraints.find((t=>t.id===e.id));r&&(i&&i.uiElement instanceof k&&i.uiElement.iconData.some((function(t){return t===e}))&&t.getUISelectionManager().setSelection(null),s&&s.uiElement instanceof k&&s.uiElement.iconData.some((function(t){return t===e}))&&t.getUISelectionManager().setHoveredSelection(null,{}),this.model.removeConstraint(r),n=!0)})),n&&(this.deselectEntities(),!t.getUISelectionManager().getSelection())){const e=(0,g.uQ)().getLastMouseMovedEvent();t.doPick(e.offsetX,e.offsetY,!0,!0,null)}return n}expand(){this.isExpanded=!0,this.removeMeshIncrement(D),this.ellipsisIcon.selectionId="",this.invalidateDisplay()}activate(){this.activated||(this.activated=!0,this.invalidateDisplay())}isSelected(){return!!this.iconData.find((e=>e.selected===u.UKE.SELECTED))}select(e){if(e.selectionId===this.ellipsisIcon.selectionId)return void this.expand();const t=this.iconData.find((t=>t.selectionId===e.selectionId));if(t&&t.selected!==u.UKE.SELECTED){t.selected=u.UKE.SELECTED;E.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled()&&(0,u.xA2)().trigger(u.Mpj,e.sourcePick),this.invalidateDisplay()}}deselect(e){const t=this.iconData.find((t=>t.selectionId===e.selectionId));t&&t.selected===u.UKE.SELECTED&&(t.selected=u.UKE.NOT_SELECTED,this.invalidateDisplay())}hover(e){(0,o.Wf)().reset(),this.highlightConstraintIcon(e.selectionId)}highlightConstraintIcon(e){let t=null;if(e===this.ellipsisIcon.selectionId)t=this.ellipsisIcon;else{const i=Number(e);!isNaN(i)&&i>v&&!this.isExpanded&&this.expand(),t=this.iconData.find((t=>t.selectionId===e))}t&&t.selected===u.UKE.NOT_SELECTED&&(t.selected=u.UKE.PREHILITE,this.invalidateDisplay())}dehover(e){let t=null;t=e.selectionId===this.ellipsisIcon.selectionId?this.ellipsisIcon:this.iconData.find((t=>t.selectionId===e.selectionId)),t&&t.selected===u.UKE.PREHILITE&&(t.selected=u.UKE.NOT_SELECTED,this.invalidateDisplay())}getConstraint(e){const t=this.iconData.find((t=>t.selectionId===e));return t?this.model.getConstraint(t.id):null}deselectEntities(){z()}selectEntities(e){this.deselectEntities();const t=this.model.id;let i;const s=this.getConstraint(e);if(s){i=s.referenceIds;for(const e of i){const i=this.model.getReference(e);i&&(0,r.XZ)(t,i,this.viewer)}}}getClearModelSelectionsOnPrehilite(){return!1}remove(){super.remove(),this.showOnlyOverDefinedSubscription.unsubscribe(),this.showAllConstraintsSubscription.unsubscribe(),this.changeSolveStatusSubscription.unsubscribe(),this.changeTypeSubscription.unsubscribe(),this.changeBorderSubscription.unsubscribe(),this.referenceIdsChangedSubscription.unsubscribe(),this.anchorChangedSubscription.unsubscribe()}resetLocation(e){e&&this.setLocation(e)}}function W(e,t,i){if(0===t.length)return null;const s=new k((0,c.bo)("inference",t),"inference",e,[0,0,0],!1,i);return s.isForInference=!0,s}function z(){(0,o.Dk)().reset(),(0,o.wT)().reset()}},13214:function(e,t,i){i.d(t,{L:function(){return d},_:function(){return b}});var s=i(93249),n=i(91275),r=i(56849),a=i(78591),o=i(63903),h=i(96265),c=i(94128),l=i(54861);const u=s.default.getManager(),d=new Map([[r.vn.X_ROTATION.toString(),r.tF.X],[r.vn.Y_ROTATION.toString(),r.tF.Y],[r.vn.Z_ROTATION.toString(),r.tF.Z]]),g=[{zeroAngle:[0,1,0],axis:[1,0,0]},{zeroAngle:[0,0,1],axis:[0,1,0]},{zeroAngle:[1,0,0],axis:[0,0,1]}],p=[r.vn.X_ROTATION,r.vn.Y_ROTATION,r.vn.Z_ROTATION],m=[[1,0,0],[0,1,0],[0,0,1]],f=[r.vn.X_DIRECTION,r.vn.Y_DIRECTION,r.vn.Z_DIRECTION],I=[[[1,0,0],[0,1,0]],[[1,0,0],[0,0,1]],[[0,1,0],[0,0,1]]],E=[r.vn.XY_PLANE,r.vn.XZ_PLANE,r.vn.YZ_PLANE],S=[{zeroAngle:[0,0,1],axis:[1,0,0]},{zeroAngle:[0,0,1],axis:[0,1,0]}],T=[r.vn.X_ROTATION,r.vn.Y_ROTATION],M=[[0,0,1]],C=[r.vn.Z_DIRECTION],D=[],v=[],P=[{zeroAngle:[1,0,0],axis:[0,0,1]}],y=[r.vn.X_ROTATION],A=[[1,0,0],[0,1,0]],O=[r.vn.X_DIRECTION,r.vn.Y_DIRECTION],R=[[[1,0,0],[0,1,0]]],w=[r.vn.XY_PLANE],_=[{scaleDirection:[1,1,0],normal:[0,0,1]}],N=[r.vn.SCALING];class b extends a.Manipulator{constructor(e,t,i){super(e,i),this.angularDirections=[],this.angularNames=[],this.linearDirections=[],this.linearNames=[],this.planarDirections=[],this.planarNames=[],this.scalingDirections=[],this.scalingNames=[],this.initialTransform=null,this.originalTransform=null,this.childComponents=[],this.scalingPreTransform=null,this.freeDragManipulator=null,this.linearManipulators=[],this.planarManipulators=[],this.angularManipulators=[],this.scalingManipulators=[],this.activeManipulator=null,this.preManipulationAngle=0,this.disableInactiveComponents=!0,this.disabledComponents=new Set,t||(t=n.Ak.FULL),i||(i={displayEditView:!1});let s,h=!0;switch(t){case n.Ak.FULL:this.angularDirections=g,this.angularNames=p,this.linearDirections=m,this.linearNames=f,this.planarDirections=I,this.planarNames=E;break;case n.Ak.PLANE:this.angularDirections=S,this.angularNames=T,this.linearDirections=M,this.linearNames=C,this.planarDirections=D,this.planarNames=v;break;case n.Ak.DRAG:this.angularDirections=[],this.angularNames=[],this.linearDirections=m,this.linearNames=f,this.planarDirections=I,this.planarNames=E,h=!1;break;case n.Ak.SKETCH:this.angularDirections=P,this.angularNames=y,this.linearDirections=A,this.linearNames=O,this.planarDirections=R,this.planarNames=w,this.scalingDirections=_,this.scalingNames=N;break;case n.Ak.EXPLODE_CONVENIENCE_MANIPULATOR:this.angularDirections=g,this.angularNames=p,this.linearDirections=m,this.linearNames=f,this.planarDirections=[],this.planarNames=[],h=!0}this.transform=o.create(),h&&(this.freeDragManipulator=new a.FreeDrag(this.viewer,i),this.freeDragManipulator.setId(r.vn.FREE_DRAG),this.freeDragManipulator.setTriadOwnerType(t),this.listenTo(this.freeDragManipulator,n.Wb.VALUE_CHANGED,this.onFreeDragChanged),this.listenTo(this.freeDragManipulator,n.Wb.MANIPULATION_STARTED,this.onFreeDragStarted),this.listenTo(this.freeDragManipulator,n.Wb.MANIPULATION_ENDED,this.onFreeDragEnded),this.childComponents.push(this.freeDragManipulator));const c=this,l=function(e){c.listenTo(c.linearManipulators[e],n.Wb.VALUE_CHANGED,(function(t,i){c.updateFromLinearManipulator(e,i)})),c.listenTo(c.linearManipulators[e],n.Wb.VALUE_EDITED,(function(){c.updateOnEditFromLinearManipulator(e)}))};for(s=0;s<this.linearDirections.length;++s){const e=new a.Linear(this.viewer,i);e.setVisualGap(this.freeDragManipulator?u.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX"):0),e.setShaftLength(u.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX")),e.setFadeParameters(u.getNumber("MANIPULATOR_TRIAD_LINEAR_FADE_ANGLE_START"),u.getNumber("MANIPULATOR_TRIAD_LINEAR_FADE_ANGLE_END")),e.setId(this.linearNames[s]),e.setTriadOwnerType(t),this.linearManipulators.push(e),this.childComponents.push(e),l(s)}const d=function(e){c.listenTo(c.planarManipulators[e],n.Wb.VALUE_CHANGED,(function(t,i){c.updateFromPlanarManipulator(e,i)}))};for(s=0;s<this.planarDirections.length;++s){const e=new a.Planar(this.viewer,i);e.setVisualGap(u.getNumber("MANIPULATOR_TRIAD_PLANAR_OFFSET_PX")),e.setSideLength(u.getNumber("MANIPULATOR_TRIAD_PLANAR_SIDE_LENGTH_PX")),e.setId(this.planarNames[s]),e.setTriadOwnerType(t),this.planarManipulators.push(e),this.childComponents.push(e),d(s)}const b=function(e){c.listenTo(c.angularManipulators[e],n.Wb.VALUE_CHANGED,(function(){c.updateFromAngularManipulator(e)})),c.listenTo(c.angularManipulators[e],n.Wb.CACHE_TRANSFORM,(function(){c.initialTransform=o.clone(c.transform)})),c.listenTo(c.angularManipulators[e],n.Wb.VALUE_EDITED,(function(){c.updateOnEditFromAngularManipulator(e)}))},L=u.getNumber("MANIPULATOR_TRIAD_ANGULAR_GAP_PX")+u.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX")+u.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX")+u.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX");for(s=0;s<this.angularDirections.length;++s){const e=new a.Angular(this.viewer,i);e.setRadialOffset(L),e.setFadeParameters(u.getNumber("MANIPULATOR_TRIAD_ANGULAR_FADE_ANGLE_START"),u.getNumber("MANIPULATOR_TRIAD_ANGULAR_FADE_ANGLE_END")),e.setId(this.angularNames[s]),e.setTriadOwnerType(t),this.angularManipulators.push(e),this.childComponents.push(e),b(s)}const F=function(e){c.listenTo(c.scalingManipulators[e],n.Wb.VALUE_CHANGED,(function(t,i){c.updateFromScalingManipulator(e,i)})),c.listenTo(c.scalingManipulators[e],n.Wb.VALUE_EDITED,(function(){c.updateOnEditFromScalingManipulator(e)}))};for(s=0;s<this.scalingDirections.length;++s){const e=new a.ScalingManipulator(this.viewer,i);e.setGapLength(u.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX")*Math.sqrt(2)),e.setHeadLength(u.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX")),e.setId(this.scalingNames[s]),e.setTriadOwnerType(t),this.scalingManipulators.push(e),this.childComponents.push(e),F(s)}for(s=0;s<this.childComponents.length;++s)this.listenTo(this.childComponents[s],n.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.childComponents[s],n.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.childComponents[s],a.UiEvents.COMMAND,this.onCommand),this.listenTo(this.childComponents[s],n.Wb.CLICKED,this.onManipulatorClicked),this.listenTo(this.childComponents[s],n.Wb.DOUBLE_CLICKED,this.onManipulatorDoubleClicked);this.preManipulationTransform=o.clone(this.transform),this.updateComponentManipulators()}onDevicePixelRatioChanged(e){for(let e=0;e<this.planarManipulators.length;++e)this.planarManipulators[e].setVisualGap(u.getNumber("MANIPULATOR_TRIAD_PLANAR_OFFSET_PX")),this.planarManipulators[e].setSideLength(u.getNumber("MANIPULATOR_TRIAD_PLANAR_SIDE_LENGTH_PX"));for(let e=0;e<this.linearManipulators.length;++e)this.linearManipulators[e].setVisualGap(this.freeDragManipulator?u.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX"):0),this.linearManipulators[e].setShaftLength(u.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX"));const t=u.getNumber("MANIPULATOR_TRIAD_ANGULAR_GAP_PX")+u.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX")+u.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX")+u.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX");for(let e=0;e<this.angularManipulators.length;++e)this.angularManipulators[e].setRadialOffset(t);for(let e=0;e<this.scalingManipulators.length;++e)this.scalingManipulators[e].setGapLength(u.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX")),this.scalingManipulators[e].setHeadLength(u.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX"))}remove(){super.remove();for(let e=0;e<this.childComponents.length;++e)this.childComponents[e].remove()}setIsEnabled(e){for(let t=0;t<this.childComponents.length;++t)this.childComponents[t].setIsEnabled(e)}setDisableInactiveComponents(e){this.disableInactiveComponents=e}setIsLocked(e){this.freeDragManipulator&&this.freeDragManipulator.setIsLocked(e)}onManipulationStarted(e){if(this.preManipulationTransform=o.clone(this.transform),this.initialTransform||(this.initialTransform=o.clone(this.transform)),this.originalTransform||(this.originalTransform=o.clone(this.transform)),this.activeManipulator=e,e!==this.freeDragManipulator&&this.disableInactiveComponents)for(let t=0;t<this.childComponents.length;++t)this.childComponents[t].setIsEnabled(e===this.childComponents[t]);for(let t=0;t<this.scalingManipulators.length;++t)this.scalingManipulators[t]!==e?(this.scalingManipulators[t].resetScale(),this.scalingPreTransform=void 0):this.scalingPreTransform||(this.scalingPreTransform=o.clone(this.transform));if(e instanceof a.Linear||e instanceof a.Planar)this.trigger(r.w0.TRANSLATION_START);else if(e instanceof a.Angular){const t=e.getAxis().direction;this.preManipulationAngle=e.getAngle();const i=[this.transform[12],this.transform[13],this.transform[14]];this.trigger(r.w0.ROTATION_START,i,t)}else e instanceof a.ScalingManipulator&&this.trigger(r.w0.SCALING_START);this.trigger(n.Wb.MANIPULATION_STARTED)}onManipulationEnded(){this.activeManipulator instanceof a.Angular?this.trigger(r.w0.ROTATION_END,this.transform):this.activeManipulator instanceof a.Linear||this.activeManipulator instanceof a.Planar?this.trigger(r.w0.TRANSLATION_END,this.transform):this.activeManipulator instanceof a.ScalingManipulator&&this.trigger(r.w0.SCALING_END),this.activeManipulator=null,this.preManipulationAngle=0;for(let e=0;e<this.childComponents.length;++e)this.disabledComponents.has(this.childComponents[e].getId())||this.childComponents[e].setIsEnabled(!0);this.updateComponentManipulators(),this.trigger(n.Wb.MANIPULATION_ENDED)}onCommand(e,t){if(t&&e){const i=[];i[r.tF.Origin]=[this.transform[12],this.transform[13],this.transform[14]],i[r.tF.X]=[this.transform[0],this.transform[1],this.transform[2]],i[r.tF.Y]=[this.transform[4],this.transform[5],this.transform[6]],i[r.tF.Z]=[this.transform[8],this.transform[9],this.transform[10]],this.trigger(r.w0.COMMAND,e,t.getId(),i)}}onManipulatorClicked(e){this.trigger(n.Wb.CLICKED,e)}onManipulatorDoubleClicked(e,t){this.trigger(r.w0.DOUBLE_CLICKED,e,t)}updateDefinition(e){this.transform=e,this.updateComponentManipulators()}getTranslationSinceManipulationBegan(){return l.jA.subtract(l.w$.multiplyVec4(this.transform,[0,0,0,1]),l.w$.multiplyVec4(this.preManipulationTransform,[0,0,0,1]))}getMouseRayForFreeDrag(){return this.activeManipulator instanceof a.FreeDrag?this.activeManipulator.getLastMouseRay():null}getActiveRotationAxis(){return this.activeManipulator instanceof a.Angular?this.activeManipulator.getAxis():null}getActiveRotationZeroAngleDirection(){return this.activeManipulator instanceof a.Angular?this.activeManipulator.getZeroAngleDirection():null}getActiveRotationAngle(){return this.activeManipulator instanceof a.Angular?this.activeManipulator.getAngle():0}setActiveRotationAngle(e){if(this.activeManipulator instanceof a.Angular){this.activeManipulator.setAngle(e);const t=l.w$.rotate(o.create(),e,this.activeManipulator.getAxis().direction),i=l.w$.toMat3(this.preManipulationTransform);l.xB.multiply(l.w$.toMat3(t),i,i);for(let e=0;e<3;++e){const t=l.S4.normalize([i[3*e+0],i[3*e+1],i[3*e+2]]);this.transform[4*e+0]=t[0],this.transform[4*e+1]=t[1],this.transform[4*e+2]=t[2]}this.updateComponentManipulators()}}updateFromLinearManipulator(e,t){this.updateOrigin(this.linearManipulators[e].getOffsetPosition()),this.trigger(r.w0.TRANSLATION_CHANGE,this.getTranslationSinceManipulationBegan(),this.linearManipulators[e],t)}updateOnEditFromLinearManipulator(e){const t=this.linearManipulators[e],i=l.S4.subtract(t.getEditOffsetPosition(),t.ray.point,h.create()),s=c.fromValues(i[0],i[1],i[2],0);this.updateOrigin(t.getEditOffsetPosition()),this.trigger(r.w0.TRANSLATION_EDIT,s)}updateFromPlanarManipulator(e,t){this.updateOrigin(this.planarManipulators[e].getOffsetPosition()),this.trigger(r.w0.TRANSLATION_CHANGE,this.getTranslationSinceManipulationBegan(),this.planarManipulators[e],t)}processUpdateFromAngularManipulator(e,t,i){const s=l.w$.rotate(o.create(),i,this.angularManipulators[e].getAxis().direction),n=l.w$.toMat3(t);l.xB.multiply(l.w$.toMat3(s),n,n);for(let e=0;e<3;++e)this.transform[4*e+0]=n[3*e],this.transform[4*e+1]=n[3*e+1],this.transform[4*e+2]=n[3*e+2];this.updateComponentManipulators()}updateFromAngularManipulator(e){this.processUpdateFromAngularManipulator(e,this.preManipulationTransform,this.angularManipulators[e].getAngle()),this.trigger(r.w0.ROTATION_CHANGE,this.getActiveRotationAngle(),this.getActiveRotationAxis(),this.getActiveRotationZeroAngleDirection())}updateOnEditFromAngularManipulator(e){const t=this.angularManipulators[e],i=t.getAxis().direction,s=[this.transform[12],this.transform[13],this.transform[14]],n=o.clone(this.transform),a=t.getEditAngleDisplacement();this.processUpdateFromAngularManipulator(e,this.initialTransform,t.getEditAngle()),this.trigger(r.w0.ROTATION_EDIT,n,a,i,s)}processScalingTransform(e,t){const i=o.fromValues(e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1);this.transform=l.w$.multiply(t,i,o.create())}updateFromScalingManipulator(e,t){this.processScalingTransform(this.scalingManipulators[e].getScale(),this.scalingPreTransform),this.trigger(r.w0.SCALING_CHANGE)}updateOnEditFromScalingManipulator(e){this.processScalingTransform(this.scalingManipulators[e].getScale(),this.scalingPreTransform),this.trigger(r.w0.SCALING_EDIT)}updateOrigin(e){for(let t=0;t<3;++t)this.transform[12+t]=e[t];this.updateComponentManipulators()}getOrigin(){return[this.transform[12],this.transform[13],this.transform[14]]}getOriginalOrigin(){return h.fromValues(this.originalTransform[12],this.originalTransform[13],this.originalTransform[14])}onFreeDragStarted(){this.trigger(r.w0.REPOSITION_START,this.transform)}onFreeDragChanged(e,t,i,s){this.updateOrigin(e),this.trigger(r.w0.REPOSITION,t,i,this.transform,s)}onFreeDragEnded(){this.trigger(r.w0.REPOSITION_END,this.transform)}updateComponentManipulators(){const e=h.fromValues(this.transform[12],this.transform[13],this.transform[14]);let t;this.freeDragManipulator&&(this.freeDragManipulator!==this.activeManipulator||this.freeDragManipulator.getIsLocked())&&this.freeDragManipulator.updateDefinition(e);const i=l.w$.toMat3(this.transform);for(t=0;t<this.linearManipulators.length;++t)if(this.linearManipulators[t]!==this.activeManipulator||this.linearManipulators[t].getIsLocked()){const s=l.S4.normalize(l.xB.multiplyVec3(i,this.linearDirections[t],h.create()));this.linearManipulators[t].updateDefinition(e,s)}for(t=0;t<this.planarManipulators.length;++t)if(this.planarManipulators[t]!==this.activeManipulator||this.planarManipulators[t].getIsLocked()){const s=l.S4.normalize(l.xB.multiplyVec3(i,this.planarDirections[t][0],h.create())),n=l.S4.normalize(l.xB.multiplyVec3(i,this.planarDirections[t][1],h.create()));this.planarManipulators[t].updateDefinition(e,s,n,[0,0])}for(t=0;t<this.angularManipulators.length;++t)(this.angularManipulators[t]!==this.activeManipulator||this.angularManipulators[t].getIsLocked())&&this.angularManipulators[t].updateDefinition(e,l.S4.normalize(l.xB.multiplyVec3(i,this.angularDirections[t].axis,h.create())),l.S4.normalize(l.xB.multiplyVec3(i,this.angularDirections[t].zeroAngle,h.create())),0);for(t=0;t<this.scalingManipulators.length;++t)if(this.scalingManipulators[t]!==this.activeManipulator||this.scalingManipulators[t].getIsLocked()){const s=l.S4.normalize(l.xB.multiplyVec3(i,this.scalingDirections[t].scaleDirection,h.create())),n=l.S4.normalize(l.xB.multiplyVec3(i,this.scalingDirections[t].normal,h.create()));this.scalingManipulators[t].updateDefinition(e,n,s)}}updateAngleRange(e,t){for(let i=0;i<this.angularManipulators.length;++i)this.angularManipulators[i].updateLimits(e,t)}updateEditAngleRange(e,t){for(let i=0;i<this.angularManipulators.length;++i)this.angularManipulators[i].updateEditLimits(e,t)}reset(e){this.originalTransform&&this.updateDefinition(o.clone(this.originalTransform));for(let e=0;e<this.linearManipulators.length;++e){const t=this.linearManipulators[e].initialRay;t&&(t.point=this.getOriginalOrigin())}e.removeEditViewAndHighlights()}disableComponent(e){this.disabledComponents.add(e)}disableXYManipulators(){this.linearManipulators.forEach((e=>{e.getId()!==r.vn.X_DIRECTION&&e.getId()!==r.vn.Y_DIRECTION||e.setIsEnabled(!1)})),this.angularManipulators.forEach((e=>{e.getId()!==r.vn.X_ROTATION&&e.getId()!==r.vn.Y_ROTATION||e.setIsEnabled(!1)})),this.scalingManipulators.forEach((e=>{e.setIsEnabled(!1)})),this.disableComponent(r.vn.X_DIRECTION),this.disableComponent(r.vn.Y_DIRECTION),this.disableComponent(r.vn.X_ROTATION),this.disableComponent(r.vn.Y_ROTATION)}enableXYManipulators(){this.disabledComponents.clear()}}},61794:function(e,t,i){i.d(t,{i:function(){return n},z:function(){return r}});var s=i(50568);class n{constructor(e,t,i){this.selectionId=t,this.meshIncrementId=i,this.sourcePick=null,this.uiElement=e}equals(e){return!!e&&(this.uiElement===e.uiElement&&this.selectionId===e.selectionId)}hideFromPick(){this.uiElement.hideIncrementFromPick(this.meshIncrementId)}canPickThrough(){return this.uiElement.canPickThrough()}getModelSelection(){return this.uiElement.getModelSelection(this)}getPickPriority(){return this.uiElement.getPickPriority(this)}isInteractionEnabled(){return this.uiElement.isInteractionEnabled()}preventsSketching(){return this.uiElement.preventsSketching()}}class r{constructor(){this.hoveredSelection=null,this.selection=null}removeSelectionForUiElement(e){this.hoveredSelection&&this.hoveredSelection.uiElement===e&&(this.hoveredSelection.uiElement.triggerMouseLeave(this.hoveredSelection,{}),this.hoveredSelection=null),this.selection&&this.selection.uiElement===e&&(this.selection=null)}reset(){this.hoveredSelection=null,this.selection=null}getHoveredSelection(){return this.hoveredSelection}isHoveringOverViewManipulator(){return!!this.hoveredSelection&&!!this.hoveredSelection.uiElement&&this.hoveredSelection.uiElement.isViewManipulator()}getSelection(){return this.selection}uiSelectionShouldBeClearedWithSelections(){return!!this.selection&&!!this.selection.uiElement&&!!this.selection.uiElement.shouldBeClearedWithSelections()}overrideHoveredSelection(e){this.hoveredSelection&&e&&this.hoveredSelection.equals(e)||!this.hoveredSelection&&!e||(this.hoveredSelection=e)}setHoveredSelection(e,t){this.hoveredSelection&&e&&this.hoveredSelection.equals(e)||!this.hoveredSelection&&!e?this.hoveredSelection&&this.hoveredSelection.uiElement.triggerMouseMove(this.hoveredSelection,t):(this.hoveredSelection&&(t.nextSelection=e,this.hoveredSelection.uiElement.triggerMouseLeave(this.hoveredSelection,t)),this.hoveredSelection=e,this.hoveredSelection&&this.hoveredSelection.uiElement.triggerMouseEnter(this.hoveredSelection,t))}setSelection(e){(this.selection||e)&&(this.selection&&this.selection.uiElement.triggerDeselect(this.selection),e&&e.equals(this.selection)?this.selection=null:(this.selection=e,this.selection&&((0,s.vi)().reset(),this.selection.uiElement.triggerSelect(this.selection))))}processUiPick(e,t){let i=null,s=null,n=!1;e.isUIPick()&&e.uiSelection.isInteractionEnabled()&&(s=e.uiSelection),this.setHoveredSelection(s,t),s&&t.click?n=s.uiElement.triggerClick(s,t):s&&t.doubleClick&&(n=s.uiElement.triggerDoubleClick(s,t)),n&&(i=s);return(t.click||t.doubleClick)&&!(s&&!n)&&this.setSelection(i),!!s}handleEmptyUiPick(e,t){e?this.setHoveredSelection(null,t):t.click&&this.setSelection(null)}}},5651:function(e,t,i){i.d(t,{B2:function(){return pe},BG:function(){return W},C2:function(){return j},CF:function(){return f},Db:function(){return K},Dy:function(){return me},Dz:function(){return P},EE:function(){return u},EI:function(){return H},Ec:function(){return U},Es:function(){return ee},HB:function(){return D},HK:function(){return A},HL:function(){return de},Ir:function(){return Me},J5:function(){return I},Jb:function(){return v},Lf:function(){return ie},Mz:function(){return te},NC:function(){return b},NP:function(){return X},Pm:function(){return Z},R:function(){return ne},Rg:function(){return q},SU:function(){return B},Sd:function(){return y},Wj:function(){return J},XD:function(){return z},XM:function(){return oe},Z:function(){return m},Z$:function(){return fe},_I:function(){return g},bN:function(){return Ce},dV:function(){return ge},et:function(){return _},fA:function(){return V},hW:function(){return Y},iq:function(){return se},jo:function(){return M},km:function(){return x},n9:function(){return c},o0:function(){return k},o3:function(){return le},ow:function(){return G},p7:function(){return ue},pc:function(){return E},q7:function(){return S},rS:function(){return Se},sW:function(){return L},tj:function(){return w},u4:function(){return C},uP:function(){return p},uc:function(){return d},vm:function(){return R},x4:function(){return he},z4:function(){return Te},zF:function(){return Q}});var s=i(79275),n=i(57692),r=i(28817),a=i(17738),o=i(78591),h=i(93249);function c(e,t){t&&e.children.push(t.makeSceneDebugObject())}let l=!0;var u,d;function g(e){switch(e){case u.HIDDEN:return"hidden";case u.VISIBLE:return"visible"}return"unknown"}function p(e){l=e}function m(){return l}function f(){return(0,a.isPlatformWindows)()||(0,a.isPlatformMac)()}function I(e){if(!e)return!1;const t=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT);return!!t&&t.precision>0}function E(e){if((0,a.isPlatformMac)()){const t=(0,o.getRendererInfo)(e);if(new RegExp(".*intel.*[3|4]000.*","i").test(t.glRenderer))return!1}return I(e)}function S(e){return Math.ceil(e.length/5)}!function(e){e[e.HIDDEN=0]="HIDDEN",e[e.VISIBLE=1]="VISIBLE"}(u||(u={})),function(e){e[e.CULLED=0]="CULLED",e[e.VISIBLE=1]="VISIBLE"}(d||(d={}));const T={};function M(e,t){T[e]=t}function C(){return T}function D(){return(0,o.getActiveViewer)()}function v(e){return T[e]}function P(e){delete T[e]}function y(e){for(const t in T)T[t].requestDrawUsingTimer(null,null,e)}function A(e){for(const t in T)T[t].requestDrawUsingAnimationFrame(null,null,e)}let O=y;function R(e){return O(e)}function w(){R(!0)}function _(){y()}window.requestAnimationFrame&&(O=A);let N=!1;function b(e,t){N=t}function L(){return N}let F=!1;function x(e){F=e}function B(){return F}function U(){return L()||B()}function V(e){const t=new Uint8Array(4);return t[0]=e>>>24&255,t[1]=e>>>16&255,t[2]=e>>>8&255,t[3]=255&e,t}function G(e){const t=1/255;return[(e>>>24&255)*t,(e>>>16&255)*t,(e>>>8&255)*t,(255&e)*t]}function H(e,t,i,s){return(e<<24)+(t<<16)+(i<<8)+s}const k=[0,0,0,0],W=-1,z=[1,1,1,0];function X(e,t){let i;return t?(i=(e[2]<<16)+(e[1]<<8)+e[0],i/16777215):(i=(e[1]<<8)+e[0],i/16383)}function q(e,t){return 255*z[3]===e[3]?W:X(e,t)}function Z(e,t){return 0===e[3]?null:X(e,t)*Math.PI}function Y(e){let t;for(t in e)return!1;return!0}function K(e){return[(0,o.clamp)(Math.floor(255*e[0]),0,255),(0,o.clamp)(Math.floor(255*e[1]),0,255),(0,o.clamp)(Math.floor(255*e[2]),0,255),(0,o.clamp)(Math.floor(255*e[3]),0,255)]}function j(e){return[(0,o.clamp)(Math.floor(255*e[0]),0,255),(0,o.clamp)(Math.floor(255*e[1]),0,255),(0,o.clamp)(Math.floor(255*e[2]),0,255),255]}function Q(e){return[e[0]/255,e[1]/255,e[2]/255,e[3]/255]}window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)};let $=null;function J(){return $()}function ee(e){return J()-e}function te(e,t){const i=new Float32Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}function ie(e,t){const i=new Uint8Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}function se(e,t){return 0===e.length?[]:0===t.length?e:1===e.length&&1===t.length?e[0]===t[0]?[]:e:(0,r.difference)(e,t)}function ne(e,t){const i=new Set;return e.forEach((e=>{t.has(e)||i.add(e)})),i}$=window.performance&&window.performance.now?function(){return window.performance.now()}:function(){return(new Date).getTime()};let re=!1,ae=!1;function oe(){return re}function he(){return ae}const ce=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];function le(e,t){if(e.length<3)return s.log.warn("Attempting to create a color string with a color of insufficient length"),"#000000";let i="#";for(let s=0;s<3;++s){const n=t?e[s]:0|Math.round(255*e[s]);i+=ce[n>>4&15],i+=ce[15&n]}return i}function ue(e){const t=[];for(let i=0;i<e.length;++i){const s=!0;t.push(le(e[i],s))}return t}function de(e,t,i){return e+"."+t+"."+i}function ge(e){const t=e.split(".");return t.length>1?t[1]:""}function pe(){n.Jq.CapabilitiesService.isFeatureQLVFacePatternEnabled().then((function(e){re=!0===e})),n.Jq.CapabilitiesService.isLongPressHandlerEnabled().then((function(e){ae=!0===e})),n.Jq.CapabilitiesService.checkLockBranchFunctionalityCurrentlyEnabled(),n.Jq.CapabilitiesService.checkNotifyThirdPartiesToSaveCurrentlyEnabled()}function me(e,t,i){const s=4*t,n=new Uint8Array(s),r=Math.floor(i/2);for(let t=0;t<r;++t){const r=e.subarray(t*s,(t+1)*s),a=i-1-t,o=e.subarray(a*s,(a+1)*s);n.set(o),o.set(r),r.set(n)}}function fe(e){const t=document.createElement("canvas"),i=t.getContext("2d");t.width=e.width,t.height=e.height;const s=i.createImageData(e.width,e.height);return s.data.set(e.data),i.putImageData(s,0,0),new Promise(((e,i)=>{t.toBlob((t=>{t?e(t):i("Canvas did not return blob")}),"image/jpeg",h.default.getManager().getNumber("MARKUP_JPG_IMAGE_QUALITY_VALUE"))}))}const Ie=new ArrayBuffer(1e4),Ee=new Uint8Array(Ie);function Se(e,t){const i=new Uint8Array(e);for(let e=0;e<t;e+=Ee.length){let t=Ee;t.length>i.length-e&&(t=new Uint8Array(Ie,0,i.length-e)),i.set(t,e)}}function Te(e,t){return{text:e+": ("+t+")",children:[]}}function Me(e,t,i){for(const s in t)!t.hasOwnProperty(s)||i&&i.hasOwnProperty(s)||e.push(Te(s,t[s]));return e}function Ce(e,t){return{text:t,children:Me([],e)}}},79493:function(e,t,i){i.d(t,{GB:function(){return o},KX:function(){return l},P6:function(){return g},Xs:function(){return m},aN:function(){return h},f1:function(){return p},iM:function(){return r},lp:function(){return u},py:function(){return d},uQ:function(){return a},x:function(){return c}});var s=i(77484),n=i(78591);function r(e){const t=a();t&&t.setForceHideInteriorSelections(e)}function a(){return(0,s.uQ)()}function o(e){const t=a();t&&t.setBaseHighlightsEnabled(e)}function h(){const e=a();return!!e&&!!e.getSketch()}function c(){return a().getOccurrenceDataManager()}function l(){return a().getSceneGraphs()}const u=function(){a()&&a().onBeforePrint()},d=function(){a()&&a().onAfterPrint()};function g(e){const t=a();return t?t.getCanvasCoordinateFromEvent(e):[e.pageX,e.pageY]}function p(e){const t=(0,n.getCurrentActiveViewerSet)();return t?e?t.sheetMetalViewer:a():null}function m(e){if(!(0,n.getCurrentActiveViewerSet)())return null;const t=p(e.useFlattenedView);return t?e.usePrint?t.retrievePrintedCanvasPixels(e):t.retrieveViewportAsImage(e):null}},86956:function(e,t,i){i.d(t,{G$:function(){return p},TC:function(){return d},cv:function(){return f},fT:function(){return m},jB:function(){return E},w5:function(){return g}});var s=i(50900),n=i(41810),r=i(78591),a=i(25586),o=i(32659);let h=null,c=null;const l="#canvas",u="previous-version-canvas",d=`#${u}`;function g(){return h}function p(e){var t;if(e=e||{},h)c=null,o(l).replaceWith(h.mainViewer.$el),(null===(t=h.previousVersionViewer)||void 0===t?void 0:t.$el)&&o(d).replaceWith(h.previousVersionViewer.$el),h.mainViewer.onViewerReactivated(),h.previousVersionViewer&&h.previousVersionViewer.onViewerReactivated(),h.sheetMetalViewer&&h.sheetMetalViewer.onViewerReactivated();else{const t={mainViewer:new r.Viewer({el:l,contextMenuMgr:e.contextMenuMgr})};if(t.mainViewer.getWebGlSupport()!==a.c.SUPPORTED)return t;if(e.createSheetMetalViewer){t.partStudioToAlternateMapping=new s.e;const i=o("<canvas/>",{id:"sheetmetalcanvas","data-view-shown":"unknown"});t.sheetMetalViewer=new r.Viewer({el:i,dontSetActive:!0,isForFlattenedDisplay:!0,hidden:!0,contextMenuMgr:e.contextMenuMgr})}h=t}return h}function m(e,t){if(e.previousVersionViewer)return;const i=o("<canvas/>",{id:u,"data-view-shown":"unknown"});e.previousVersionViewer=new r.Viewer({el:i,dontSetActive:!0,isForFlattenedDisplay:!1,isForPreviousVersionDisplay:!0,hidden:!1,contextMenuMgr:t}),e.mainViewer.pairedViewer=e.previousVersionViewer,e.previousVersionViewer.pairedViewer=e.mainViewer,e.previousVersionViewer.setSuppressModelSelection(!0)}function f(e){c=e}function I(e){e&&(e.setActiveElement(null,n.GNh.UNKNOWN,!0,null,null),e.setUnitsReceived(!1),e.$el.detach())}function E(){h&&(I(h.mainViewer),I(h.sheetMetalViewer),I(h.previousVersionViewer))}}}]);